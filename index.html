<html ng-app="pclDemo">

<head>
  <meta charset="utf-8" />
  <title>Mesoscope@TSRI</title>
  <style>
  code {
    padding: 2px 4px;
    font-size: 90%;
    color: #c7254e;
    background-color: #f9f2f4;
    border-radius: 4px;
  }
  </style>
  <style>
  #gui-container {
    position: absolute;
    top: 0px;
    right: 0px;
    z-index: 10;
  }
  </style>
  <link type="text/css" rel="stylesheet" href="style_dev.css">
  <link rel="stylesheet" href="menu_style.css">

  <link rel="stylesheet" href="extras/SlickGrid/plugins/slick.rowdetailview.css" type="text/css" />
  <link rel="stylesheet" href="extras/SlickGrid/slick.grid.css" type="text/css" />
  <link rel="stylesheet" href="extras/SlickGrid/controls/slick.pager.css" type="text/css" />
  <link rel="stylesheet" href="extras/SlickGrid/css/smoothness/jquery-ui-1.11.3.custom.css" type="text/css" />
  <link rel="stylesheet" href="extras/SlickGrid/examples/examples.css" type="text/css" />
  <link rel="stylesheet" href="extras/SlickGrid/controls/slick.columnpicker.css" type="text/css" />
  <!--/*PFV*/-->

  <!-- jquery svg -->
  <link rel="stylesheet" type="text/css" href="extras/pfv/js/vendor/svg/jquery.svg.css" />
  <link rel="stylesheet" href="extras/pfv/js/vendor/bootstrap-3.3.5/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="extras/pfv/css/bootstrap-slider.css">

  <!--link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"-->

  <!-- font awesome icons -->
  <link rel="stylesheet" href="extras/pfv/css/font-awesome.min.css">

  <!-- NGL -->
  <!-- <script src="js/vendor/ngl.embedded.min.js"></script> -->

  <!-- and finally our own code ... !-->
  <link href="extras/pfv/css/pfv.css" rel="stylesheet">
  <!--script data-main='demo' src='extras/pfv/js/vendor/require.js'></script-->

  <!--[if IE]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
  <style type="text/css">
    .gridster li header {
      background: #999;
      display: block;
      font-size: 20px;
      line-height: normal;
      padding: 4px 0 6px;
      margin-bottom: 20px;
      cursor: move;
    }

    .detail {
      padding: 5px
    }

    .preload {
      font-size: 18px;
    }

    .dynamic-cell-detail> :first-child {
      vertical-align: middle;
      line-height: 13px;
      padding: 10px;
      margin-left: 20px;
    }
  </style>


  <style>
    #wrapper {
      height: 100%;
      position: relative;
      width: 100%;
      overflow: hidden;
    }

    #menuContainer {
      width: 20%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: #222;
    }

    #menuContainer li {
      border-bottom: 1px solid #000;
      border-top: 1px solid #333;
      cursor: pointer;
      padding: 10px 5px;
      color: #BBB;
      background: #1a1a1a;
      font: 12px Arial, sans-serif;
    }

    #menuContainer li:hover {
      background: #111;
      color: #CCC;
    }

    #layoutContainer {
      width: 100%;
      height: 95%;
      padding: 5px 5px; //box-shadow: -3px 0px 9px 0px rgba( 0, 0, 0, 0.4 );
    }
  </style>
  <link type="text/css" rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-base.css" />
  <link type="text/css" rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-light-theme.css" />
  <!--link type="text/css" rel="stylesheet" href="//golden-layout.com/assets/css/goldenlayout-dark-theme.css" /-->
  <!-- GPU STUFF -->
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/build/three.min.js"></script>
  <!--script src="extras/gpuphysics/lib/three.min.js"></script-->
  <script src="extras/gpuphysics/lib/stats.min.js"></script>
  <script src="extras/gpuphysics/lib/dat.gui.min.js"></script>
  <script src="extras/gpuphysics/lib/three.orbitcontrols.js"></script>
  <script src="extras/gpuphysics/lib/three.transformcontrols.js"></script>
  <script src="extras/shaderToon.js"></script>

  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/postprocessing/ShaderPass.js"></script>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/postprocessing/SAOPass.js"></script>

  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/shaders/SAOShader.js"></script>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/shaders/DepthLimitedBlurShader.js"></script>
  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/shaders/UnpackDepthRGBAShader.js"></script>

  <script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/effects/OutlineEffect.js"></script>

  <!--PDB component library-->
  <!-- Complied & minified library css -->
  <link rel="stylesheet" href="//www.ebi.ac.uk/pdbe/pdb-component-library/v1.0/css/pdb.component.library.min-1.0.0.css" />
  <!-- Dependencey scripts (these can be skipped if already included in page) -->
  <script src="//www.ebi.ac.uk/pdbe/pdb-component-library/libs/d3.min.js"></script>
  <script src="//www.ebi.ac.uk/pdbe/pdb-component-library/libs/angular.1.4.7.min.js"></script>
  <!-- Complied & minified library JS -->
  <script src="//www.ebi.ac.uk/pdbe/pdb-component-library/v1.0/js/pdb.component.library.min-1.0.0.js"></script>


  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script type="text/javascript" src="extras/goldenlayout.min.js"></script>
  <!--script type="text/javascript" src="js/layout_mg.js"></script-->

  <script src="extras/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-zoom.v1.min.js"></script>
  <!--script src="https://d3js.org/d3-contour.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>

 <!--d3 to html easy -->
 <!--script src="http://cdn.rawgit.com/jamesleesaunders/d3-ez/master/build/d3-ez.js"></script-->
 <link rel="stylesheet" type="text/css" href="extras/d3-ez.css" />

  <!-- GZIP and 7Z support -->
  <script src="https://cdn.rawgit.com/imaya/zlib.js/develop/bin/zlib_and_gzip.dev.min.js"></script>

  <!-- NGL  -->
  <script src="https://cdn.rawgit.com/arose/ngl/v2.0.0-dev.24/dist/ngl.js"></script>
  <!--three.js marching Cube-->
  <script src="extras/MarchingCubes.js"></script>

  <script src="extras/SlickGrid/lib/firebugx.js"></script>
  <!--script src="extras/SlickGrid/lib/jquery-1.11.2.min.js"></script-->
  <script src="extras/SlickGrid/lib/jquery-ui-1.11.3.js"></script>
  <script src="extras/SlickGrid/lib/jquery.event.drag-2.3.0.js"></script>
  <script src="extras/SlickGrid/lib/jquery.tmpl.min.js"></script>
  <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script-->
  <!--script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script-->
  <script src="https://cdn.rawgit.com/scottjehl/jQuery-Tree-Control/master/js/jQuery.tree.js" type="text/javascript"></script>

  <!--XLSX-->
  <script src="https://oss.sheetjs.com/js-xlsx/xlsx.core.min.js"></script>
  <script src="https://oss.sheetjs.com/js-xlsx/xlsx.full.min.js"></script>
  <!--script src="https://unpkg.com/canvas-datagrid/dist/canvas-datagrid.js"></script-->

  <!--GRid ??-->
  <!--script src="https://cdnjs.cloudflare.com/ajax/libs/free-jqgrid/4.15.3/jquery.jqgrid.min.js"></script-->
  <!--slickGrid-->
  <script src="extras/SlickGrid/slick.core.js"></script>
  <script src="extras/SlickGrid/plugins/slick.cellrangedecorator.js"></script>
  <script src="extras/SlickGrid/plugins/slick.cellrangeselector.js"></script>
  <script src="extras/SlickGrid/plugins/slick.cellselectionmodel.js"></script>
  <script src="extras/SlickGrid/plugins/slick.rowselectionmodel.js"></script>
  <script src="extras/SlickGrid/slick.formatters.js"></script>
  <script src="extras/SlickGrid/slick.editors.js"></script>
  <script src="extras/SlickGrid/slick.grid.js"></script>
  <script src="extras/SlickGrid/slick.groupitemmetadataprovider.js"></script>
  <script src="extras/SlickGrid/slick.dataview.js"></script>
  <script src="extras/SlickGrid/controls/slick.pager.js"></script>
  <script src="extras/SlickGrid/controls/slick.columnpicker.js"></script>
  <script src="extras/SlickGrid/examples/slick.compositeeditor.js"></script>
  <script src="extras/SlickGrid/plugins/slick.checkboxselectcolumn.js"></script>
  <script src="extras/SlickGrid/plugins/slick.rowdetailview.js"></script>
  <script src="extras/SlickGrid/plugins/slick.autotooltips.js"></script>

  <script type="text/javascript" src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.js"></script>

  <script src="https://ebi-uniprot.github.io/CDN/protvista/protvista.js"></script>
  <link href="https://ebi-uniprot.github.io/CDN/protvista/css/main.css" rel="stylesheet"/>
  <!--COLLADA-->

<script src="extras/collada/gl-matrix-min.js"></script>
<script src="extras/collada/tinyxml.js"></script>
<script src="extras/collada/collada.js"></script>

  <style>
    .dropdown {
      a {
        text-decoration: none;
      }
      float: left;

      [data-toggle="dropdown"] {
        position: relative;
        display: block;
        color: white;
        background: $blue;
        @include double-shadow($blue);
        @include hover-style($blue);
        @include text-shadow(0 -1px 0 rgba(0, 0, 0, 0.3));
        padding: 10px;

      }
      .icon-arrow {
        position: absolute;
        display: block;
        font-size: 0.7em;
        color: #fff;
        top: 14px;
        right: 10px;

        &.open {
          @include transform(rotate(-180deg));
          @include transition(transform .6s);
        }
        &.close {
          @include transform(rotate(0deg));
          @include transition(transform .6s);
        }

        &:before {
          content: '\25BC';
        }
      }

      .dropdown-menu {
        max-height: 0;
        overflow: hidden;
        @include ul-nostyle;

        li {
          padding: 0;

          a {
            display: block;
            color: darken($gray, 50%);
            background: $gray;
            @include double-shadow($gray);
            @include hover-style($gray);
            @include text-shadow(0 -1px 0 rgba(255, 255, 255, 0.3));
            padding: 10px 10px;
          }
        }
      }

      .show,
      .hide {
        @include transform-origin(50%, 0%);
      }

      .show {
        display: block;
        max-height: 9999px;
        @include transform(scaleY(1));
        @include animation(showAnimation .5s ease-in-out);
        @include transition(max-height 1s ease-in-out);
      }

      .hide {
        display: none;
        max-height: 0;
        @include transform(scaleY(0));
        @include animation(hideAnimation .4s ease-out);
        @include transition(max-height .6s ease-out);
      }
    }

    @include keyframes(showAnimation) {
      0% {
        @include transform(scaleY(0.1));
      }
      40% {
        @include transform(scaleY(1.04));
      }
      60% {
        @include transform(scaleY(0.98));
      }
      80% {
        @include transform(scaleY(1.04));
      }
      100% {
        @include transform(scaleY(0.98));
      }
      80% {
        @include transform(scaleY(1.02));
      }
      100% {
        @include transform(scaleY(1));
      }
    }

    @include keyframes(hideAnimation) {
      0% {
        @include transform(scaleY(1));
      }
      60% {
        @include transform(scaleY(0.98));
      }
      80% {
        @include transform(scaleY(1.02));
      }
      100% {
        @include transform(scaleY(0));
      }
    }

    .chooseColor {
      width: 10px;
      height: 10px;
      background: #fff;
      float: left;
      margin: 5px 5px 0 0;
      cursor: pointer;
    }

    .chooseColor .selectedColor {
      width: 10px;
      height: 10px;
    }

    .chooseColor ul {
      display: none;
      box-shadow: 2px 2px 3px rgba( 0, 0, 0, 0.7);
    }

    .chooseColor:hover ul {
      display: block;
    }

    .chooseColor ul,
    .chooseColor ul li {
      margin: 0;
      padding: 0;
      list-style-type: none;
    }

    .chooseColor ul li {
      width: 10px;
      height: 10px;
      cursor: pointer;
    }

    .chooseColor ul li:hover {
      border: 1px solid orange;

      select {
        width: 10px;
        height: 10px;
        background: #fff;
        float: center;
        cursor: pointer;
      }

  </style>



  <script>
  // Code goes here
    var app = angular.module('pclDemo',['pdb.component.library']);

    app.config(function($locationProvider) {
      $locationProvider.html5Mode({
      enabled: true,
      requireBase: false
      });
    });
    app.directive('pdbeComp',function($compile){
      return {
        restrict: 'C',
        link: function(scope, element, attrs){

          var compMainDiv = document.getElementById(attrs.displayIn);
          var template = element.text();
          var compContent =  $compile(template)(scope);

          angular.element(compMainDiv).prepend(compContent);

          element.bind('DOMSubtreeModified', function() {
            console.log("DOMSubtreeModified");
            template = element.text();
            compContent =  $compile(template)(scope);
            angular.element(compMainDiv).html('');
            angular.element(compMainDiv).prepend(compContent);
            scope.flag = 1;
          });
        }
      }
    });
  </script>


</head>

<body>
  <ul id="grid_contextMenu" style="display:none;position:absolute">
    <b>Search PDB using:</b>
    <li data="name">name</li>
    <li data="label">label</li>
    <li data="uniprot">uniprot</li>
  </ul>

  <div hidden>
    <pre style="clear:both"><code id="pdbeComp_topov" class="pdbeComp" display-in="topov" contenteditable="true">&lt;pdb-topology-viewer entry-id="1aqd" entity-id="1" height="370"&gt;&lt;/pdb-topology-viewer&gt;</code></pre>
  </div>
  <div hidden>
    <pre style="clear:both"><code id="pdbeComp_seqv" class="pdbeComp" display-in="seqv" contenteditable="true">&lt;pdb-seq-viewer entry-id="1aqd" entity-id="1" height="370"&gt;&lt;/pdb-seq-viewer&gt;</code></pre>
  </div>
  <div hidden>
    <pre style="clear:both"><code id="pdbeComp_puv" class="pdbeComp" display-in="puv" contenteditable="true">&lt;pdb-uniprot-viewer entry-id="P07550" entity-id="1" height="370"&gt;&lt;/pdb-uniprot-viewer&gt;</code></pre>
  </div>
  <!--div class="TopBar">  </div-->
    <!--div class="SearchBar"></div-->
    <!--div class="Logo"></div-->
  <!--div class"aheader">
    <div class="logo_head"">
     <img id="logo_image" src="images/Logo@2xc.png" height="90%">
     <img id="logo_image" src="images/customLogo2.png"  height="90%"alt="logo"  />
     <h1 id="logo_image" > Mesoscope @ TSRI&nbsp&nbsp</h1>
   </div-->

   <div id='cssmenu'>

   <ul>
      <li class='has-sub'><a href='#'><span>Start Recipe</span></a>
        <ul>
          <li class='has-sub'><a href="#">New</span></a>
            <ul>
              <li>
              <li><a href='#'  onclick="CreateNew();"><span>Empty Recipe</span></a></li>
              <li><a href="#" onclick="selectDB()">From Current database</a></li>
              <li class='has-sub'><a href="#">From Examples</a>
              <ul>
                  <li><a href="#" onclick="LoadExampleBloodHIV()">HIV and Blood Plasma</a></li>
                  <li><a href="#" onclick="LoadExampleBlood()">Blood Plasma</a></li>
                  <!--li><a href="#" onclick="LoadExampleHIV()">HIV</a-->
                  <li><a href="#" onclick="LoadExampleMpn()">Mycoplasma Pneumonia</a></li>
                  <li><a href="#" onclick="LoadExampleExosome()">Exosome</a></li>
              </ul>
              </li>
              <li><a href="#" for="jsfile_input" onclick="$('#jsfile_input').trigger('click');">From File (.json, _serialized.json,.xlsx,.csv)</a></li>
          </ul>
          </li>
          <li class='has-sub'><a href="#">Append From</span></a>
            <ul>
              <li class='has-sub'><a href="#">Examples</a>
              <ul>
                  <li><a href="#" onclick="MergeExampleBloodHIV()">HIV and Blood Plasma</a></li>
                  <li><a href="#" onclick="MergeExampleBlood()">Blood Plasma</a></li>
                  <!--li><a href="#" onclick="LoadExampleHIV()">HIV</a-->
                  <li><a href="#" onclick="MergeExampleMpn()">Mycoplasma Pneumonia</a></li>
                  <li><a href="#" onclick="LoadExampleExosome()">Exosome</a></li>
              </ul>
              </li>
              <li><a href="#" for="jsfile_input_merge" onclick="$('#jsfile_input_merge').trigger('click');">File (.json, _serialized.json,.xlsx,.csv)</a></li>
            </ul>
          </li>
          <li class='last'><a href="#" for="file_input" onclick="$('#file_input').trigger('click');">Setup Data Directory (PDB,geoms)</a></li>
        </ul>
        </li>
      <li class='has-sub'><a href='#'><span>Export Recipe</span></a>
        <ul>
          <li><a href="#" onclick="SaveRecipeCellPACK()">cellPACK recipe</a></li>
          <li><a href="#" onclick="SaveRecipeCellPACK_serialized()">cellPACK-gpu recipe</a></li>
          <li><a href="#" onclick="saveCurrentCSV()">Spreadsheet CSV</a></li>
          <li><a href="#" onclick="cp_SerializedColorSchem()">color palette</a></li>
          <!--li><a href="#" >Spreadsheet XL</a></li-->
        </ul>
      </li>
      <li class='last has-sub'><a href='#'><span>Help</span></a>
        <ul>
        <li><a href="#" onclick="on('Settings')">Settings</a></li>
        <li><a href="#" onclick="on('Help')">Help</a></li>
        <li><a href="#" onclick="on('About')">About Us</a></li>
        <li><a href="#" onclick="on('FAQ')">FAQ</a></li>
        <li><a href="#" onclick="on('Contact')">Contact</a></li>
        </ul>
      </li>
   </ul>
   <font color="white"><h5>Mesoscope @ TSRI&nbsp&nbsp</h5></font>
   <div width="5%" height="5%"><img id="logo_image" src="images/Logo@2xc.png" height="90%"></div>
   </div>



  <!--/div<input class="togglePFV" id="togglePFV" type="checkbox">-->
  <input class="hidden" type="file" id="jsfile_input" accept=".csv,.json,.xlsx" type="file" onclick="forceSelect(this)" onchange="selectFile(event)" />
  <input class="hidden" type="file" id="jsfile_input_merge" accept=".csv,.json,.xlsx" type="file" onclick="forceSelect(this)" onchange="selectMergeFile(event)" />
  <input class="hidden" type="file" id="file_input" onchange="Util_selectFolder(event)" webkitdirectory mozdirectory msdirectory odirectory directory multiple />
  <input class="hidden" type="file" id="img_file_input" onclick="forceSelect(this)" onchange="grid_selectImgFile(event)"/>


  <div id="overlay" onclick="off()">
    <div id="overlay_text">Overlay Text</div>
  </div>

  <div id="layoutContainer"></div>

  <div class='slickform modal' id="slickdetail">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" id="closeslickdetail">&times;</span>
        <h2>Column Mapping</h2>
      </div>
      <div class="modal-body" id="slickitems">
        <div class="modal-form" id="modalform"></div>
        <canvas class="modal-canvas" id="modalcanvas"  width="400" height="400"></canvas>
        <div id="listholder"  class="modal-list"></div>
      </div>
      <hr/>
      <div class="modal-footer">
        <div>
          <button id="saveDetail" style="color:black;">Save</button>
          <button id="cancelDetail" style="color:black;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class='slickform modal' id="mergemodal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" id="closemergemodal">&times;</span>
        <h2>Column Merging</h2>
      </div>
      <div class="modal-body" id="mergemodalitems">
        <div class="modal-form" id="mergemodalform"></div>
        <div id="mergemodallistholder"  class="modal-list"></div>
      </div>
      <hr/>
      <div class="modal-footer">
        <div>
          <button id="mergemodal_save" style="color:black;">Merge</button>
          <button id="mergemodal_cancel" style="color:black;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dialog" class="modal" title="Leave Page"></div>
  <div id="svgexport"></div>

  <ul class='custom-menu-node'>
    <li "><input type="color" id="node_color" onchange="ChangeColorNodeOver()" name="color" value="#e66465" /></li>
    <li onclick="RenameNodeOver()">rename</li>
    <li onclick="DeleteNodeOver()">delete</li>
    <li onclick="ResizeNodeOver()">resize</li>
  </ul>

  <div hidden>
  <div id="topov" class="topov"  height="100%" width="100%"></div>
  <div id="seqv" class="seqv"  height="100%" width="100%"></div>
  <div id="puv" class="puv"  height="100%" width="100%"></div>
  </div>

  <script id="itemDetailsTemplate" type="text/x-jquery-tmpl">
    <div class='item-details-form'>
      {{each columns}}
      <div class='item-details-label'>
        ${name}
      </div>
      <div class='item-details-editor-container' data-editorid='${id}'></div>
      {{/each}}
      <hr/>
      <div class='item-details-form-buttons'>
        <button data-action='save'>Save</button>
        <button data-action='cancel'>Cancel</button>
      </div>
    </div>
  </script>

  <script type="x-shader/x-vertex" id="tri_vertexShader">
  	varying vec3 vNormal;
    varying vec4 vPosition;
    varying vec4 vOPosition;
  	varying vec3 vONormal;
    varying vec3 vU;
    varying vec3 vEye;
    void main() {
          vOPosition = modelViewMatrix * vec4( position, 1.0 );
          gl_Position = projectionMatrix * vOPosition;
          vU = normalize( vec3( modelViewMatrix * vec4( position, 1.0 ) ) );
          vPosition = vec4( position, 1.0 );
          vNormal = normalMatrix * normal;
          vONormal = normal;
      }
  </script>
  <script type="x-shader/x-vertex" id="tri_fragmentShader">
  		uniform sampler2D textureMap;
      uniform sampler2D normalMap;
      uniform vec3 color;
      uniform float normalScale;
      uniform float texScale;
      uniform float useSSS;
      uniform float useScreen;
      uniform float opacity;
      varying vec3 vNormal;
      varying vec4 vPosition;
      varying vec4 vOPosition;
  	  varying vec3 vONormal;
  	  varying vec3 vU;
      varying vec3 vEye;
      uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
	    float random(vec3 scale,float seed){return fract(sin(dot(gl_FragCoord.xyz+seed,scale))*43758.5453+seed);}
      void main() {
          vec3 vViewPosition = -vOPosition.xyz;
          #include <clipping_planes_fragment>
          vec3 n = normalize( vONormal.xyz );
          vec3 blend_weights = abs( n );
          blend_weights = ( blend_weights - 0.2 ) * 7.;
          blend_weights = max( blend_weights, 0. );
          blend_weights /= ( blend_weights.x + blend_weights.y + blend_weights.z );

          vec2 coord1 = vPosition.yz * texScale;
          vec2 coord2 = vPosition.zx * texScale;
          vec2 coord3 = vPosition.xy * texScale;

          vec3 bump1 = texture2D( normalMap, coord1 ).rgb;
          vec3 bump2 = texture2D( normalMap, coord2 ).rgb;
          vec3 bump3 = texture2D( normalMap, coord3 ).rgb;

          vec3 blended_bump = bump1 * blend_weights.xxx +
                              bump2 * blend_weights.yyy +
                              bump3 * blend_weights.zzz;

          vec3 tanX = vec3( vNormal.x, -vNormal.z, vNormal.y);
          vec3 tanY = vec3( vNormal.z, vNormal.y, -vNormal.x);
          vec3 tanZ = vec3(-vNormal.y, vNormal.x, vNormal.z);
          vec3 blended_tangent = tanX * blend_weights.xxx +
                                 tanY * blend_weights.yyy +
                                 tanZ * blend_weights.zzz;

          vec3 normalTex = blended_bump * 2.0 - 1.0;
          normalTex.xy *= normalScale;
          normalTex.y *= -1.;
          normalTex = normalize( normalTex );
          mat3 tsb = mat3( normalize( blended_tangent ), normalize( cross( vNormal, blended_tangent ) ), normalize( vNormal ) );
          vec3 finalNormal = tsb * normalTex;

          vec3 r = reflect( normalize( vU ), normalize( finalNormal ) );
          float m = 2.0 * sqrt( r.x * r.x + r.y * r.y + ( r.z + 1.0 ) * ( r.z + 1.0 ) );
          vec2 calculatedNormal = vec2( r.x / m + 0.5,  r.y / m + 0.5 );

          vec3 base = texture2D( textureMap, calculatedNormal ).rgb;

  		float rim = 1.75 * max( 0., abs( dot( normalize( vNormal ), normalize( -vOPosition.xyz ) ) ) );
  		base += useSSS * color * ( 1. - .75 * rim );
  		base += ( 1. - useSSS ) * 10. * base * color * clamp( 1. - rim, 0., .15 );

  		if( useScreen == 1. ) {
  			base = vec3( 1. ) - ( vec3( 1. ) - base ) * ( vec3( 1. ) - base );
  		}

  		float nn = .05 * random( vec3( 1. ), length( gl_FragCoord ) );
          base += vec3( nn );

          gl_FragColor = vec4( base.rgb, opacity );
      }
  </script>

<script type="x-shader/x-vertex" id="gvs">
  uniform mat4 viewMatrix;
  uniform mat4 modelViewMatrix;
  uniform mat4 projectionMatrix;
	attribute float uindex;
	varying vec3 vColor;
  uniform float size;
	void main() {
    //index to ijk
    float sliceNum = size*size;
    float k = index / (sliceNum);
    float temp = index % (sliceNum);
    float j = temp / size;
    float i = temp % size;
    vec3 ijk = vec3(round(i),floor(j),floor(k));
    float x = ijk[0]/size;//r[0];//-boxSize.x +-boxSize.x +
    float y = ijk[1]/size;//;//-boxSize.y +-boxSize.y +-boxSize.y +
    float z = ijk[2]/size;//;//-boxSize.z +-boxSize.z +
    vec3 p = vec3(x,y,z);
    //ijk to xyz
		vec4 mvPosition = modelViewMatrix * vec4( p, 1.0 );
		gl_PointSize = 2.0;//(1.0 / 64.0) / 2.0 ;
		gl_Position = projectionMatrix * mvPosition;
	}
</script>

<script type="x-shader/x-fragment" id="gfs">
	varying vec3 vColor;
	void main() {
		gl_FragColor = vec4( 1.0,0.0,0.0, 1.0 );
		//gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );
	}
</script>

<script id="sharedShaderCode" type="x-shader/x-fragment">
// Convert an index to an UV-coordinate
vec2 indexToUV(float index, vec2 res){
    vec2 uv = vec2(mod(index/res.x,1.0), floor( index/res.y ) / res.x);
    return uv;
}

// Rotate a vector by a quaternion
vec3 vec3_applyQuat(vec3 v, vec4 q){
    float ix =  q.w * v.x + q.y * v.z - q.z * v.y;
    float iy =  q.w * v.y + q.z * v.x - q.x * v.z;
    float iz =  q.w * v.z + q.x * v.y - q.y * v.x;
    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;

    return vec3(
        ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y,
        iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z,
        iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x
    );
}
</script>

<!--
    Render body instances vertex shader
    Copy of THREE.ShaderLib.phong + modifications to render instances
    //debug the bodyType there !
-->
<script id="renderBodiesVertex" type="x-shader/x-vertex">
uniform sampler2D bodyInfosTex;
uniform sampler2D bodyPosTex;
uniform sampler2D bodyQuatTex;
attribute float bodyIndex;
attribute vec3 bodyColor;
uniform sampler2D gridIdTex;
uniform sampler2D gridValueTex;
uniform vec3 cellSize;
uniform vec3 gridPos;
#define PHONG
varying vec3 vViewPosition;
//varying vec3 vColor;
varying vec3 vNormal;
//varying vec3 vRefract;
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
    #include <uv_vertex>
    #include <uv2_vertex>
    #include <color_vertex>
    vec2 bodyUV = indexToUV(bodyIndex,bodyTextureResolution);
#ifdef USE_COLOR
    //vColor = vec3((floor(bodyUV*3.0)+1.0)/3.0,0);
    vColor = vec3(bodyColor);
#endif
    //vColor = vec3(1,0,0);
    #include <beginnormal_vertex>
    #include <morphnormal_vertex>
    #include <skinbase_vertex>
    #include <skinnormal_vertex>
    vec4 posTexData = texture2D(bodyPosTex, bodyUV);
    float bodyTypeIndex = posTexData.w;
    vec2 bodyType_uv = indexToUV( bodyTypeIndex, bodyInfosTextureResolution );
    vec4 bodyType_infos1 = texture2D(bodyInfosTex, bodyType_uv);
    //bodyType_uv = indexToUV( bodyTypeIndex*2.0+1.0, bodyInfosTextureResolution );
    //vec4 bodyType_infos2 = texture2D(bodyInfosTex, bodyType_uv);
    //if (bodyType_infos1.w == 1.0) {
    //    vColor = vec3(1,0,0);
    //}
    //else {
    //    vColor = vec3(0,0,1);
    //}
    vec3 bodyPos = posTexData.xyz;
    vec4 bodyQuat = texture2D(bodyQuatTex,bodyUV).xyzw;
    objectNormal.xyz = vec3_applyQuat(objectNormal.xyz, bodyQuat);
    #include <defaultnormal_vertex>
#ifndef FLAT_SHADED
    vNormal = normalize( transformedNormal );
#endif
    #include <begin_vertex>
    transformed.xyz = vec3_applyQuat(transformed.xyz, bodyQuat);
    transformed.xyz += bodyPos;
    #include <displacementmap_vertex>
    #include <morphtarget_vertex>
    #include <skinning_vertex>
    #include <project_vertex>
    #include <logdepthbuf_vertex>
    #include <clipping_planes_vertex>
    vViewPosition = - mvPosition.xyz;
    //vRefract = - mvPosition.xyz;
    #include <worldpos_vertex>
    #include <envmap_vertex>
    #include <shadowmap_vertex>
    #include <fog_vertex>
}
</script>

<!--
    Render body instances vertex shader
    Copy of THREE.ShaderLib.phong + modifications to render body instances with correct transform
-->
<script id="renderParticlesVertex" type="x-shader/x-vertex">
uniform sampler2D particleWorldPosTex;
uniform sampler2D quatTex;
attribute float particleIndex;
#define PHONG
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
    varying vec3 vNormal;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
    #include <uv_vertex>
    #include <uv2_vertex>
    #include <color_vertex>
    vec2 particleUV = indexToUV(particleIndex,resolution);
#ifdef USE_COLOR
    vColor = vec3((floor(particleUV*3.0)+1.0)/3.0,0);
#endif
    #include <beginnormal_vertex>
    #include <morphnormal_vertex>
    #include <skinbase_vertex>
    #include <skinnormal_vertex>
    vec4 particlePosAndBodyId = texture2D(particleWorldPosTex,particleUV);
    vec2 bodyUV = indexToUV(particlePosAndBodyId.w,bodyTextureResolution);
    vec4 bodyQuat = texture2D(quatTex,bodyUV).xyzw;
    objectNormal.xyz = vec3_applyQuat(objectNormal.xyz, bodyQuat);
#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
    vNormal = normalize( transformedNormal );
#endif
    #include <begin_vertex>
    vec3 particlePos = particlePosAndBodyId.xyz;
    transformed.xyz = vec3_applyQuat(transformed.xyz, bodyQuat);
    transformed.xyz += particlePos;
    #include <displacementmap_vertex>
    #include <morphtarget_vertex>
    #include <skinning_vertex>
    #include <project_vertex>
    #include <logdepthbuf_vertex>
    #include <clipping_planes_vertex>
    vViewPosition = - mvPosition.xyz;
    #include <worldpos_vertex>
    #include <envmap_vertex>
    #include <shadowmap_vertex>
    #include <fog_vertex>
}
</script>

<!--
    Render depth. This is for rendering shadows.
-->
<script id="renderBodiesDepth" type="x-shader/x-vertex">
uniform sampler2D bodyPosTex;
uniform sampler2D bodyQuatTex;
attribute float bodyIndex;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#include <begin_vertex>

    vec2 bodyUV = indexToUV(bodyIndex,bodyTextureResolution);
    vec3 bodyPos = texture2D(bodyPosTex,bodyUV).xyz;
    vec4 bodyQuat = texture2D(bodyQuatTex,bodyUV).xyzw;
    transformed.xyz = vec3_applyQuat(transformed.xyz, bodyQuat);
    transformed.xyz += bodyPos;

	#include <displacementmap_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
}
</script>

<script id="xvertexShader" type="x-shader/x-vertex">
precision highp float;
uniform float scale;

uniform sampler2D bodyPosTex;
uniform sampler2D bodyQuatTex;
uniform sampler2D atomPositionsTex;//xyz,1

//uniform mat4 viewMatrix;
//uniform mat4 modelViewMatrix;
//uniform mat4 projectionMatrix;

//attribute vec3 position;
//attribute vec3 offset;
//attribute vec2 uv;
attribute vec2 instanceInfos;//for every bead?
attribute float bodyIndex;
attribute float partIndex;

//attribute vec4 color;
//attribute vec4 orientationStart;
//attribute vec4 orientationEnd;
varying float vRadius;
varying vec3 vPosition;
varying vec4 vColor;
varying vec2 vUv;
varying mat4 modelView;
void main(){
  float particleId = instanceInfos.y;
  float instanceId = instanceInfos.x;
  vec2 bodyUV = indexToUV(instanceId,bodyTextureResolution);
  vec4 bodyQuat = texture2D(bodyQuatTex,bodyUV).xyzw;
  vec4 sphere = texture2D(bodyPosTex,bodyUV).xyzw;//body position
  vec2 atomUV = indexToUV(particleId,atomTextureResolution);
  //centered!!
  vec4 spherePosition = texture2D(atomPositionsTex,atomUV).xyzw;//(lodLevel == 0) ? _ProteinAtomPositions[sphereBatchInfo.w + vertexId / 3] : _ProteinClusterPositions[sphereBatchInfo.w + vertexId / 3];
  vec3 billboardWorldPos = sphere.xyz + vec3_applyQuat(spherePosition.xyz, bodyQuat);// _InstancePositions[instanceId].xyz;

  vRadius = spherePosition.w;//could use w as the type and then access the texture with all the color?
  vec3 vertexPos = position * spherePosition.w;

  modelView = modelViewMatrix;
  mat4 VP = projectionMatrix * modelViewMatrix;
  vec3 CameraRight = vec3(modelViewMatrix[0][0], modelViewMatrix[1][0], modelViewMatrix[2][0]);
  vec3 CameraUp = vec3(modelViewMatrix[0][1], modelViewMatrix[1][1], modelViewMatrix  [2][1]);
  //vec3 billboardVertexWorldPos = vec4(billboardWorldPos, 0)
  //          + CameraRight * vertexPos.x + CameraUp * vertexPos.y;
  vec3 billboardVertexWorldPos = billboardWorldPos.xyz
           + CameraRight * vertexPos.x + CameraUp * vertexPos.y;
	vColor = vec4(bodyUV,0,1);
  vUv = uv;
	gl_Position = VP  * vec4( billboardVertexWorldPos.xyz , 1.0 );
  //vPosition = VP  * vec4( billboardVertexWorldPos.xyz , 1.0 );
  vPosition = billboardVertexWorldPos;//clamp((projectionMatrix * modelViewMatrix * vec4(billboardVertexWorldPos.xyz, 1.0)).z, 0.0, 1.0);//Use depth pos to set depth

}
	</script>

	<script id="xfragmentShader" type="x-shader/x-fragment">
precision highp float;
//uniform float time;
#include <logdepthbuf_pars_fragment>
#include <packing>
uniform mat4 projectionMatrix;
uniform float cameraNear;
uniform float cameraFar;
varying float vRadius;
varying vec3 vPosition;
varying vec4 vColor;
varying vec2 vUv;
varying mat4 modelView;

vec4 getZparams(){
  // OpenGL would be this:
  float zc0 = (1.0 - cameraFar / cameraNear) / 2.0;
  float zc1 = (1.0 + cameraFar / cameraNear) / 2.0;
  // D3D is this:
  //zc0 = 1.0 - m_FarClip / m_NearClip;
  //zc1 = m_FarClip / m_NearClip;
  // now set _ZBufferParams with (zc0, zc1, zc0/m_FarClip, zc1/m_FarClip);
  return vec4(zc0, zc1, zc0/cameraFar, zc1/cameraNear);
}

float LinearEyeDepth(vec4 _ZBufferParams,float z){
  return 1.0 / (_ZBufferParams.x * z + _ZBufferParams.y);
}

float calcDepth( float z ){
    vec2 clipZW = z * projectionMatrix[2].zw + projectionMatrix[3].zw;
    return 0.5 + 0.5 * clipZW.x / clipZW.y;
}

void main() {
  float lensqr = dot(vUv, vUv);
  if (lensqr > 1.0) discard;
  vec3 normal = normalize(vec3(vUv, sqrt(1.0 - lensqr)));
  vec3 cameraPos = (normal * vRadius) + vPosition;
  vec4 clipPos = projectionMatrix * modelView * vec4(cameraPos, 1.0);
  float ndcDepth = clipPos.z / clipPos.w;
  float gdepth = ( ( (cameraFar-cameraNear) * ndcDepth) +
      cameraNear + cameraFar) / 2.0;
  float gldepth = ((gl_DepthRange.diff * ndcDepth) +
        gl_DepthRange.near + gl_DepthRange.far) / 2.0;
	//vec4 color = vec4( vColor );
	//color.r += sin( vPosition.x * 10.0 + time ) * 0.5;
  // Find depth
	//float eyeDepth = LinearEyeDepth(input.vertex.z) + input.radius * (1 - normal.z);
	//depth = 1 / (eyeDepth * _ZBufferParams.z) - _ZBufferParams.w / _ZBufferParams.z;
  #include <logdepthbuf_fragment>
  vec4 _ZBufferParams = getZparams();
  float yd = vPosition.z;//1.0 / (_ZBufferParams.x * vPosition.z + _ZBufferParams.y);
  float eyeDepth = yd + vRadius * (1.0 - normal.z);
  float depth = 1.0 / (ndcDepth * _ZBufferParams.z) - _ZBufferParams.w / _ZBufferParams.z;
  float d = viewZToPerspectiveDepth(ndcDepth,cameraNear,cameraFar);
  gl_FragDepthEXT = gldepth;
  //viewZToPerspectiveDepth
  //perspectiveDepthToViewZ
	gl_FragColor = vec4(0.78,0.78,0.78,1.0);//packDepthToRGBA(gdepth);//vec4(d,0.0,0.0,1.0);
}
</script>
    <!--script src="extras/jscolor.js"></script-->
    <script src="extras/FileSaver.min.js"></script>
    <script src="extras/LiteMol-core.js"></script>
    <script src="extras/clustering.min.js"></script>
    <script src="js/util.js"></script>
    <script src="js/pycallback.js"></script>
    <script src="js/query_helper.js"></script>
    <script src="js/gridtable.js"></script>
    <script src="js/ngl.js"></script>
    <script src="js/ngl_grid.js"></script>
    <script src="js/distance.js"></script>
    <script src="js/cp_serialized.js"></script>
    <script src="js/modal_canvas_comp.js"></script>
    <script src="extras/gpuphysics/build/gp.js"></script>
    <script src="extras/gpuphysics/main_physics.js"></script>
    <script src="js/main.js"></script>
    <script src="js/layout_mg.js"></script>
    <script src="js/modal_merge.js"></script>
    <!-- Protein Feature View from rcsb-->
    <!--script src="extras/jquery.svg.js"></script>
    <script src="extras/bootstrap-slider.min.js"></script>
    <script src="extras/helper.js"></script>

    <script src="extras/proteinfeatureview.ver.js"></script>
    <script src="js/pfv_util.js"></script-->


</body>

</html>
