if (typeof jQuery != 'undefined') {
    console.info("Software Version: jQuery " + jQuery.fn.jquery);
    console.info("Software Version: Bootstrap " + $.fn.modal.Constructor.VERSION);
    $(document).ready(function() {
        if (jQuery) {
            if (jQuery.ui) {
                console.warn("WARNING: jQuery UI is being deprecated!\nSoftware Version: jQuery UI " + jQuery.ui.version);
            }
        }
    });
} else {
    console.error("No jQuery loaded!");
    document.getElementById("UnsupportedBrowser").className = "hidden-print";
};
/**
 * Cookie plugin
 *
 * Copyright (c) 2006 Klaus Hartl (stilbuero.de)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 */
jQuery.cookie = function(name, value, options) {
    if (typeof value != 'undefined') {
        options = options || {};
        if (value === null) {
            value = '';
            options = $.extend({}, options);
            options.expires = -1;
        }
        var expires = '';
        if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
            var date;
            if (typeof options.expires == 'number') {
                date = new Date();
                date.setTime(date.getTime() + (options.expires * 24 * 60 * 60 * 1000));
            } else {
                date = options.expires;
            }
            expires = '; expires=' + date.toUTCString();
        }
        var path = options.path ? '; path=' + (options.path) : '';
        var domain = options.domain ? '; domain=' + (options.domain) : '';
        var secure = options.secure ? '; secure' : '';
        document.cookie = [name, '=', encodeURIComponent(value), expires, path, domain, secure].join('');
    } else {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};
/*
 * jQuery Cycle Plugin (with Transition Definitions)
 * Examples and documentation at: http://jquery.malsup.com/cycle/
 * Copyright (c) 2007-2009 M. Alsup
 * Version: 2.74 (03-FEB-2010)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * Requires: jQuery v1.2.6 or later
 */
(function($) {
    var ver = "2.74";
    if ($.support == undefined) {
        $.support = {
            opacity: !($.browser.msie)
        };
    }

    function debug(s) {
        if ($.fn.cycle.debug) {
            log(s);
        }
    }

    function log() {
        if (window.console && window.console.log) {
            window.console.log("[cycle] " + Array.prototype.join.call(arguments, " "));
        }
    }
    $.fn.cycle = function(options, arg2) {
        var o = {
            s: this.selector,
            c: this.context
        };
        if (this.length === 0 && options != "stop") {
            if (!$.isReady && o.s) {
                log("DOM not ready, queuing slideshow");
                $(function() {
                    $(o.s, o.c).cycle(options, arg2);
                });
                return this;
            }
            log("terminating; zero elements found by selector" + ($.isReady ? "" : " (DOM not ready)"));
            return this;
        }
        return this.each(function() {
            var opts = handleArguments(this, options, arg2);
            if (opts === false) {
                return;
            }
            if (this.cycleTimeout) {
                clearTimeout(this.cycleTimeout);
            }
            this.cycleTimeout = this.cyclePause = 0;
            var $cont = $(this);
            var $slides = opts.slideExpr ? $(opts.slideExpr, this) : $cont.children();
            var els = $slides.get();
            if (els.length < 2) {
                log("terminating; too few slides: " + els.length);
                return;
            }
            var opts2 = buildOptions($cont, $slides, els, opts, o);
            if (opts2 === false) {
                return;
            }
            var startTime = opts2.continuous ? 10 : getTimeout(opts2.currSlide, opts2.nextSlide, opts2, !opts2.rev);
            if (startTime) {
                startTime += (opts2.delay || 0);
                if (startTime < 10) {
                    startTime = 10;
                }
                debug("first timeout: " + startTime);
                this.cycleTimeout = setTimeout(function() {
                    go(els, opts2, 0, !opts2.rev);
                }, startTime);
            }
        });
    };

    function handleArguments(cont, options, arg2) {
        if (cont.cycleStop == undefined) {
            cont.cycleStop = 0;
        }
        if (options === undefined || options === null) {
            options = {};
        }
        if (options.constructor == String) {
            switch (options) {
                case "stop":
                    cont.cycleStop++;
                    if (cont.cycleTimeout) {
                        clearTimeout(cont.cycleTimeout);
                    }
                    cont.cycleTimeout = 0;
                    $(cont).removeData("cycle.opts");
                    return false;
                case "toggle":
                    cont.cyclePause = (cont.cyclePause === 1) ? 0 : 1;
                    return false;
                case "pause":
                    cont.cyclePause = 1;
                    return false;
                case "resume":
                    cont.cyclePause = 0;
                    if (arg2 === true) {
                        options = $(cont).data("cycle.opts");
                        if (!options) {
                            log("options not found, can not resume");
                            return false;
                        }
                        if (cont.cycleTimeout) {
                            clearTimeout(cont.cycleTimeout);
                            cont.cycleTimeout = 0;
                        }
                        go(options.elements, options, 1, 1);
                    }
                    return false;
                case "prev":
                case "next":
                    var opts = $(cont).data("cycle.opts");
                    if (!opts) {
                        log('options not found, "prev/next" ignored');
                        return false;
                    }
                    $.fn.cycle[options](opts);
                    return false;
                default:
                    options = {
                        fx: options
                    };
            }
            return options;
        } else {
            if (options.constructor == Number) {
                var num = options;
                options = $(cont).data("cycle.opts");
                if (!options) {
                    log("options not found, can not advance slide");
                    return false;
                }
                if (num < 0 || num >= options.elements.length) {
                    log("invalid slide index: " + num);
                    return false;
                }
                options.nextSlide = num;
                if (cont.cycleTimeout) {
                    clearTimeout(cont.cycleTimeout);
                    cont.cycleTimeout = 0;
                }
                if (typeof arg2 == "string") {
                    options.oneTimeFx = arg2;
                }
                go(options.elements, options, 1, num >= options.currSlide);
                return false;
            }
        }
        return options;
    }

    function removeFilter(el, opts) {
        if (!$.support.opacity && opts.cleartype && el.style.filter) {
            try {
                el.style.removeAttribute("filter");
            } catch (smother) {}
        }
    }

    function buildOptions($cont, $slides, els, options, o) {
        var opts = $.extend({}, $.fn.cycle.defaults, options || {}, $.metadata ? $cont.metadata() : $.meta ? $cont.data() : {});
        if (opts.autostop) {
            opts.countdown = opts.autostopCount || els.length;
        }
        var cont = $cont[0];
        $cont.data("cycle.opts", opts);
        opts.$cont = $cont;
        opts.stopCount = cont.cycleStop;
        opts.elements = els;
        opts.before = opts.before ? [opts.before] : [];
        opts.after = opts.after ? [opts.after] : [];
        opts.after.unshift(function() {
            opts.busy = 0;
        });
        if (!$.support.opacity && opts.cleartype) {
            opts.after.push(function() {
                removeFilter(this, opts);
            });
        }
        if (opts.continuous) {
            opts.after.push(function() {
                go(els, opts, 0, !opts.rev);
            });
        }
        saveOriginalOpts(opts);
        if (!$.support.opacity && opts.cleartype && !opts.cleartypeNoBg) {
            clearTypeFix($slides);
        }
        if ($cont.css("position") == "static") {
            $cont.css("position", "relative");
        }
        if (opts.width) {
            $cont.width(opts.width);
        }
        if (opts.height && opts.height != "auto") {
            $cont.height(opts.height);
        }
        if (opts.startingSlide) {
            opts.startingSlide = parseInt(opts.startingSlide);
        }
        if (opts.random) {
            opts.randomMap = [];
            for (var i = 0; i < els.length; i++) {
                opts.randomMap.push(i);
            }
            opts.randomMap.sort(function(a, b) {
                return Math.random() - 0.5;
            });
            opts.randomIndex = 0;
            opts.startingSlide = opts.randomMap[0];
        } else {
            if (opts.startingSlide >= els.length) {
                opts.startingSlide = 0;
            }
        }
        opts.currSlide = opts.startingSlide = opts.startingSlide || 0;
        var first = opts.startingSlide;
        $slides.css({
            position: "absolute",
            top: 0,
            left: 0
        }).hide().each(function(i) {
            var z = first ? i >= first ? els.length - (i - first) : first - i : els.length - i;
            $(this).css("z-index", z);
        });
        $(els[first]).css("opacity", 1).show();
        removeFilter(els[first], opts);
        if (opts.fit && opts.width) {
            $slides.width(opts.width);
        }
        if (opts.fit && opts.height && opts.height != "auto") {
            $slides.height(opts.height);
        }
        var reshape = opts.containerResize && !$cont.innerHeight();
        if (reshape) {
            var maxw = 0,
                maxh = 0;
            for (var j = 0; j < els.length; j++) {
                var $e = $(els[j]),
                    e = $e[0],
                    w = $e.outerWidth(),
                    h = $e.outerHeight();
                if (!w) {
                    w = e.offsetWidth;
                }
                if (!h) {
                    h = e.offsetHeight;
                }
                maxw = w > maxw ? w : maxw;
                maxh = h > maxh ? h : maxh;
            }
            if (maxw > 0 && maxh > 0) {
                $cont.css({
                    width: maxw + "px",
                    height: maxh + "px"
                });
            }
        }
        if (opts.pause) {
            $cont.hover(function() {
                this.cyclePause++;
            }, function() {
                this.cyclePause--;
            });
        }
        if (supportMultiTransitions(opts) === false) {
            return false;
        }
        var requeue = false;
        options.requeueAttempts = options.requeueAttempts || 0;
        $slides.each(function() {
            var $el = $(this);
            this.cycleH = (opts.fit && opts.height) ? opts.height : $el.height();
            this.cycleW = (opts.fit && opts.width) ? opts.width : $el.width();
            if ($el.is("img")) {
                var loadingIE = ($.browser.msie && this.cycleW == 28 && this.cycleH == 30 && !this.complete);
                var loadingFF = ($.browser.mozilla && this.cycleW == 34 && this.cycleH == 19 && !this.complete);
                var loadingOp = ($.browser.opera && ((this.cycleW == 42 && this.cycleH == 19) || (this.cycleW == 37 && this.cycleH == 17)) && !this.complete);
                var loadingOther = (this.cycleH == 0 && this.cycleW == 0 && !this.complete);
                if (loadingIE || loadingFF || loadingOp || loadingOther) {
                    if (o.s && opts.requeueOnImageNotLoaded && ++options.requeueAttempts < 100) {
                        log(options.requeueAttempts, " - img slide not loaded, requeuing slideshow: ", this.src, this.cycleW, this.cycleH);
                        setTimeout(function() {
                            $(o.s, o.c).cycle(options);
                        }, opts.requeueTimeout);
                        requeue = true;
                        return false;
                    } else {
                        log("could not determine size of image: " + this.src, this.cycleW, this.cycleH);
                    }
                }
            }
            return true;
        });
        if (requeue) {
            return false;
        }
        opts.cssBefore = opts.cssBefore || {};
        opts.animIn = opts.animIn || {};
        opts.animOut = opts.animOut || {};
        $slides.not(":eq(" + first + ")").css(opts.cssBefore);
        if (opts.cssFirst) {
            $($slides[first]).css(opts.cssFirst);
        }
        if (opts.timeout) {
            opts.timeout = parseInt(opts.timeout);
            if (opts.speed.constructor == String) {
                opts.speed = $.fx.speeds[opts.speed] || parseInt(opts.speed);
            }
            if (!opts.sync) {
                opts.speed = opts.speed / 2;
            }
            while ((opts.timeout - opts.speed) < 250) {
                opts.timeout += opts.speed;
            }
        }
        if (opts.easing) {
            opts.easeIn = opts.easeOut = opts.easing;
        }
        if (!opts.speedIn) {
            opts.speedIn = opts.speed;
        }
        if (!opts.speedOut) {
            opts.speedOut = opts.speed;
        }
        opts.slideCount = els.length;
        opts.currSlide = opts.lastSlide = first;
        if (opts.random) {
            opts.nextSlide = opts.currSlide;
            if (++opts.randomIndex == els.length) {
                opts.randomIndex = 0;
            }
            opts.nextSlide = opts.randomMap[opts.randomIndex];
        } else {
            opts.nextSlide = opts.startingSlide >= (els.length - 1) ? 0 : opts.startingSlide + 1;
        }
        if (!opts.multiFx) {
            var init = $.fn.cycle.transitions[opts.fx];
            if ($.isFunction(init)) {
                init($cont, $slides, opts);
            } else {
                if (opts.fx != "custom" && !opts.multiFx) {
                    log("unknown transition: " + opts.fx, "; slideshow terminating");
                    return false;
                }
            }
        }
        var e0 = $slides[first];
        if (opts.before.length) {
            opts.before[0].apply(e0, [e0, e0, opts, true]);
        }
        if (opts.after.length > 1) {
            opts.after[1].apply(e0, [e0, e0, opts, true]);
        }
        if (opts.next) {
            $(opts.next).bind(opts.prevNextEvent, function() {
                return advance(opts, opts.rev ? -1 : 1);
            });
        }
        if (opts.prev) {
            $(opts.prev).bind(opts.prevNextEvent, function() {
                return advance(opts, opts.rev ? 1 : -1);
            });
        }
        if (opts.pager) {
            buildPager(els, opts);
        }
        exposeAddSlide(opts, els);
        return opts;
    }

    function saveOriginalOpts(opts) {
        opts.original = {
            before: [],
            after: []
        };
        opts.original.cssBefore = $.extend({}, opts.cssBefore);
        opts.original.cssAfter = $.extend({}, opts.cssAfter);
        opts.original.animIn = $.extend({}, opts.animIn);
        opts.original.animOut = $.extend({}, opts.animOut);
        $.each(opts.before, function() {
            opts.original.before.push(this);
        });
        $.each(opts.after, function() {
            opts.original.after.push(this);
        });
    }

    function supportMultiTransitions(opts) {
        var i, tx, txs = $.fn.cycle.transitions;
        if (opts.fx.indexOf(",") > 0) {
            opts.multiFx = true;
            opts.fxs = opts.fx.replace(/\s*/g, "").split(",");
            for (i = 0; i < opts.fxs.length; i++) {
                var fx = opts.fxs[i];
                tx = txs[fx];
                if (!tx || !txs.hasOwnProperty(fx) || !$.isFunction(tx)) {
                    log("discarding unknown transition: ", fx);
                    opts.fxs.splice(i, 1);
                    i--;
                }
            }
            if (!opts.fxs.length) {
                log("No valid transitions named; slideshow terminating.");
                return false;
            }
        } else {
            if (opts.fx == "all") {
                opts.multiFx = true;
                opts.fxs = [];
                for (p in txs) {
                    tx = txs[p];
                    if (txs.hasOwnProperty(p) && $.isFunction(tx)) {
                        opts.fxs.push(p);
                    }
                }
            }
        }
        if (opts.multiFx && opts.randomizeEffects) {
            var r1 = Math.floor(Math.random() * 20) + 30;
            for (i = 0; i < r1; i++) {
                var r2 = Math.floor(Math.random() * opts.fxs.length);
                opts.fxs.push(opts.fxs.splice(r2, 1)[0]);
            }
            debug("randomized fx sequence: ", opts.fxs);
        }
        return true;
    }

    function exposeAddSlide(opts, els) {
        opts.addSlide = function(newSlide, prepend) {
            var $s = $(newSlide),
                s = $s[0];
            if (!opts.autostopCount) {
                opts.countdown++;
            }
            els[prepend ? "unshift" : "push"](s);
            if (opts.els) {
                opts.els[prepend ? "unshift" : "push"](s);
            }
            opts.slideCount = els.length;
            $s.css("position", "absolute");
            $s[prepend ? "prependTo" : "appendTo"](opts.$cont);
            if (prepend) {
                opts.currSlide++;
                opts.nextSlide++;
            }
            if (!$.support.opacity && opts.cleartype && !opts.cleartypeNoBg) {
                clearTypeFix($s);
            }
            if (opts.fit && opts.width) {
                $s.width(opts.width);
            }
            if (opts.fit && opts.height && opts.height != "auto") {
                $slides.height(opts.height);
            }
            s.cycleH = (opts.fit && opts.height) ? opts.height : $s.height();
            s.cycleW = (opts.fit && opts.width) ? opts.width : $s.width();
            $s.css(opts.cssBefore);
            if (opts.pager) {
                $.fn.cycle.createPagerAnchor(els.length - 1, s, $(opts.pager), els, opts);
            }
            if ($.isFunction(opts.onAddSlide)) {
                opts.onAddSlide($s);
            } else {
                $s.hide();
            }
        };
    }
    $.fn.cycle.resetState = function(opts, fx) {
        fx = fx || opts.fx;
        opts.before = [];
        opts.after = [];
        opts.cssBefore = $.extend({}, opts.original.cssBefore);
        opts.cssAfter = $.extend({}, opts.original.cssAfter);
        opts.animIn = $.extend({}, opts.original.animIn);
        opts.animOut = $.extend({}, opts.original.animOut);
        opts.fxFn = null;
        $.each(opts.original.before, function() {
            opts.before.push(this);
        });
        $.each(opts.original.after, function() {
            opts.after.push(this);
        });
        var init = $.fn.cycle.transitions[fx];
        if ($.isFunction(init)) {
            init(opts.$cont, $(opts.elements), opts);
        }
    };

    function go(els, opts, manual, fwd) {
        if (manual && opts.busy && opts.manualTrump) {
            $(els).stop(true, true);
            opts.busy = false;
        }
        if (opts.busy) {
            return;
        }
        var p = opts.$cont[0],
            curr = els[opts.currSlide],
            next = els[opts.nextSlide];
        if (p.cycleStop != opts.stopCount || p.cycleTimeout === 0 && !manual) {
            return;
        }
        if (!manual && !p.cyclePause && ((opts.autostop && (--opts.countdown <= 0)) || (opts.nowrap && !opts.random && opts.nextSlide < opts.currSlide))) {
            if (opts.end) {
                opts.end(opts);
            }
            return;
        }
        if (manual || !p.cyclePause) {
            var fx = opts.fx;
            curr.cycleH = curr.cycleH || $(curr).height();
            curr.cycleW = curr.cycleW || $(curr).width();
            next.cycleH = next.cycleH || $(next).height();
            next.cycleW = next.cycleW || $(next).width();
            if (opts.multiFx) {
                if (opts.lastFx == undefined || ++opts.lastFx >= opts.fxs.length) {
                    opts.lastFx = 0;
                }
                fx = opts.fxs[opts.lastFx];
                opts.currFx = fx;
            }
            if (opts.oneTimeFx) {
                fx = opts.oneTimeFx;
                opts.oneTimeFx = null;
            }
            $.fn.cycle.resetState(opts, fx);
            if (opts.before.length) {
                $.each(opts.before, function(i, o) {
                    if (p.cycleStop != opts.stopCount) {
                        return;
                    }
                    o.apply(next, [curr, next, opts, fwd]);
                });
            }
            var after = function() {
                $.each(opts.after, function(i, o) {
                    if (p.cycleStop != opts.stopCount) {
                        return;
                    }
                    o.apply(next, [curr, next, opts, fwd]);
                });
            };
            if (opts.nextSlide != opts.currSlide) {
                opts.busy = 1;
                if (opts.fxFn) {
                    opts.fxFn(curr, next, opts, after, fwd);
                } else {
                    if ($.isFunction($.fn.cycle[opts.fx])) {
                        $.fn.cycle[opts.fx](curr, next, opts, after);
                    } else {
                        $.fn.cycle.custom(curr, next, opts, after, manual && opts.fastOnEvent);
                    }
                }
            }
            opts.lastSlide = opts.currSlide;
            if (opts.random) {
                opts.currSlide = opts.nextSlide;
                if (++opts.randomIndex == els.length) {
                    opts.randomIndex = 0;
                }
                opts.nextSlide = opts.randomMap[opts.randomIndex];
            } else {
                var roll = (opts.nextSlide + 1) == els.length;
                opts.nextSlide = roll ? 0 : opts.nextSlide + 1;
                opts.currSlide = roll ? els.length - 1 : opts.nextSlide - 1;
            }
            if (opts.pager) {
                $.fn.cycle.updateActivePagerLink(opts.pager, opts.currSlide);
            }
        }
        var ms = 0;
        if (opts.timeout && !opts.continuous) {
            ms = getTimeout(curr, next, opts, fwd);
        } else {
            if (opts.continuous && p.cyclePause) {
                ms = 10;
            }
        }
        if (ms > 0) {
            p.cycleTimeout = setTimeout(function() {
                go(els, opts, 0, !opts.rev);
            }, ms);
        }
    }
    $.fn.cycle.updateActivePagerLink = function(pager, currSlide) {
        $(pager).each(function() {
            $(this).find("a").removeClass("activeSlide").filter("a:eq(" + currSlide + ")").addClass("activeSlide");
        });
    };

    function getTimeout(curr, next, opts, fwd) {
        if (opts.timeoutFn) {
            var t = opts.timeoutFn(curr, next, opts, fwd);
            while ((t - opts.speed) < 250) {
                t += opts.speed;
            }
            debug("calculated timeout: " + t + "; speed: " + opts.speed);
            if (t !== false) {
                return t;
            }
        }
        return opts.timeout;
    }
    $.fn.cycle.next = function(opts) {
        advance(opts, opts.rev ? -1 : 1);
    };
    $.fn.cycle.prev = function(opts) {
        advance(opts, opts.rev ? 1 : -1);
    };

    function advance(opts, val) {
        var els = opts.elements;
        var p = opts.$cont[0],
            timeout = p.cycleTimeout;
        if (timeout) {
            clearTimeout(timeout);
            p.cycleTimeout = 0;
        }
        if (opts.random && val < 0) {
            opts.randomIndex--;
            if (--opts.randomIndex == -2) {
                opts.randomIndex = els.length - 2;
            } else {
                if (opts.randomIndex == -1) {
                    opts.randomIndex = els.length - 1;
                }
            }
            opts.nextSlide = opts.randomMap[opts.randomIndex];
        } else {
            if (opts.random) {
                if (++opts.randomIndex == els.length) {
                    opts.randomIndex = 0;
                }
                opts.nextSlide = opts.randomMap[opts.randomIndex];
            } else {
                opts.nextSlide = opts.currSlide + val;
                if (opts.nextSlide < 0) {
                    if (opts.nowrap) {
                        return false;
                    }
                    opts.nextSlide = els.length - 1;
                } else {
                    if (opts.nextSlide >= els.length) {
                        if (opts.nowrap) {
                            return false;
                        }
                        opts.nextSlide = 0;
                    }
                }
            }
        }
        if ($.isFunction(opts.prevNextClick)) {
            opts.prevNextClick(val > 0, opts.nextSlide, els[opts.nextSlide]);
        }
        go(els, opts, 1, val >= 0);
        return false;
    }

    function buildPager(els, opts) {
        var $p = $(opts.pager);
        $.each(els, function(i, o) {
            $.fn.cycle.createPagerAnchor(i, o, $p, els, opts);
        });
        $.fn.cycle.updateActivePagerLink(opts.pager, opts.startingSlide);
    }
    $.fn.cycle.createPagerAnchor = function(i, el, $p, els, opts) {
        var a;
        if ($.isFunction(opts.pagerAnchorBuilder)) {
            a = opts.pagerAnchorBuilder(i, el);
        } else {
            a = '<a href="#">' + (i + 1) + "</a>";
        }
        if (!a) {
            return;
        }
        var $a = $(a);
        if ($a.parents("body").length === 0) {
            var arr = [];
            if ($p.length > 1) {
                $p.each(function() {
                    var $clone = $a.clone(true);
                    $(this).append($clone);
                    arr.push($clone[0]);
                });
                $a = $(arr);
            } else {
                $a.appendTo($p);
            }
        }
        $a.bind(opts.pagerEvent, function(e) {
            e.preventDefault();
            opts.nextSlide = i;
            var p = opts.$cont[0],
                timeout = p.cycleTimeout;
            if (timeout) {
                clearTimeout(timeout);
                p.cycleTimeout = 0;
            }
            if ($.isFunction(opts.pagerClick)) {
                opts.pagerClick(opts.nextSlide, els[opts.nextSlide]);
            }
            go(els, opts, 1, opts.currSlide < i);
            return false;
        });
        if (opts.pagerEvent != "click") {
            $a.click(function() {
                return false;
            });
        }
        if (opts.pauseOnPagerHover) {
            $a.hover(function() {
                opts.$cont[0].cyclePause++;
            }, function() {
                opts.$cont[0].cyclePause--;
            });
        }
    };
    $.fn.cycle.hopsFromLast = function(opts, fwd) {
        var hops, l = opts.lastSlide,
            c = opts.currSlide;
        if (fwd) {
            hops = c > l ? c - l : opts.slideCount - l;
        } else {
            hops = c < l ? l - c : l + opts.slideCount - c;
        }
        return hops;
    };

    function clearTypeFix($slides) {
        function hex(s) {
            s = parseInt(s).toString(16);
            return s.length < 2 ? "0" + s : s;
        }

        function getBg(e) {
            for (; e && e.nodeName.toLowerCase() != "html"; e = e.parentNode) {
                var v = $.css(e, "background-color");
                if (v.indexOf("rgb") >= 0) {
                    var rgb = v.match(/\d+/g);
                    return "#" + hex(rgb[0]) + hex(rgb[1]) + hex(rgb[2]);
                }
                if (v && v != "transparent") {
                    return v;
                }
            }
            return "#ffffff";
        }
        $slides.each(function() {
            $(this).css("background-color", getBg(this));
        });
    }
    $.fn.cycle.commonReset = function(curr, next, opts, w, h, rev) {
        $(opts.elements).not(curr).hide();
        opts.cssBefore.opacity = 1;
        opts.cssBefore.display = "block";
        if (w !== false && next.cycleW > 0) {
            opts.cssBefore.width = next.cycleW;
        }
        if (h !== false && next.cycleH > 0) {
            opts.cssBefore.height = next.cycleH;
        }
        opts.cssAfter = opts.cssAfter || {};
        opts.cssAfter.display = "none";
        $(curr).css("zIndex", opts.slideCount + (rev === true ? 1 : 0));
        $(next).css("zIndex", opts.slideCount + (rev === true ? 0 : 1));
    };
    $.fn.cycle.custom = function(curr, next, opts, cb, speedOverride) {
        var $l = $(curr),
            $n = $(next);
        var speedIn = opts.speedIn,
            speedOut = opts.speedOut,
            easeIn = opts.easeIn,
            easeOut = opts.easeOut;
        $n.css(opts.cssBefore);
        if (speedOverride) {
            if (typeof speedOverride == "number") {
                speedIn = speedOut = speedOverride;
            } else {
                speedIn = speedOut = 1;
            }
            easeIn = easeOut = null;
        }
        var fn = function() {
            $n.animate(opts.animIn, speedIn, easeIn, cb);
        };
        $l.animate(opts.animOut, speedOut, easeOut, function() {
            if (opts.cssAfter) {
                $l.css(opts.cssAfter);
            }
            if (!opts.sync) {
                fn();
            }
        });
        if (opts.sync) {
            fn();
        }
    };
    $.fn.cycle.transitions = {
        fade: function($cont, $slides, opts) {
            $slides.not(":eq(" + opts.currSlide + ")").css("opacity", 0);
            opts.before.push(function(curr, next, opts) {
                $.fn.cycle.commonReset(curr, next, opts);
                opts.cssBefore.opacity = 0;
            });
            opts.animIn = {
                opacity: 1
            };
            opts.animOut = {
                opacity: 0
            };
            opts.cssBefore = {
                top: 0,
                left: 0
            };
        }
    };
    $.fn.cycle.ver = function() {
        return ver;
    };
    $.fn.cycle.defaults = {
        fx: "fade",
        timeout: 4000,
        timeoutFn: null,
        continuous: 0,
        speed: 1000,
        speedIn: null,
        speedOut: null,
        next: null,
        prev: null,
        prevNextClick: null,
        prevNextEvent: "click",
        pager: null,
        pagerClick: null,
        pagerEvent: "click",
        pagerAnchorBuilder: null,
        before: null,
        after: null,
        end: null,
        easing: null,
        easeIn: null,
        easeOut: null,
        shuffle: null,
        animIn: null,
        animOut: null,
        cssBefore: null,
        cssAfter: null,
        fxFn: null,
        height: "auto",
        startingSlide: 0,
        sync: 1,
        random: 0,
        fit: 0,
        containerResize: 1,
        pause: 0,
        pauseOnPagerHover: 0,
        autostop: 0,
        autostopCount: 0,
        delay: 0,
        slideExpr: null,
        cleartype: !$.support.opacity,
        cleartypeNoBg: false,
        nowrap: 0,
        fastOnEvent: 0,
        randomizeEffects: 1,
        rev: 0,
        manualTrump: true,
        requeueOnImageNotLoaded: true,
        requeueTimeout: 250
    };
})(jQuery);
/*
 * jQuery Cycle Plugin Transition Definitions
 * This script is a plugin for the jQuery Cycle Plugin
 * Examples and documentation at: http://malsup.com/jquery/cycle/
 * Copyright (c) 2007-2008 M. Alsup
 * Version:	 2.72
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 */
(function($) {
    $.fn.cycle.transitions.none = function($cont, $slides, opts) {
        opts.fxFn = function(curr, next, opts, after) {
            $(next).show();
            $(curr).hide();
            after();
        };
    };
    $.fn.cycle.transitions.scrollUp = function($cont, $slides, opts) {
        $cont.css("overflow", "hidden");
        opts.before.push($.fn.cycle.commonReset);
        var h = $cont.height();
        opts.cssBefore = {
            top: h,
            left: 0
        };
        opts.cssFirst = {
            top: 0
        };
        opts.animIn = {
            top: 0
        };
        opts.animOut = {
            top: -h
        };
    };
    $.fn.cycle.transitions.scrollDown = function($cont, $slides, opts) {
        $cont.css("overflow", "hidden");
        opts.before.push($.fn.cycle.commonReset);
        var h = $cont.height();
        opts.cssFirst = {
            top: 0
        };
        opts.cssBefore = {
            top: -h,
            left: 0
        };
        opts.animIn = {
            top: 0
        };
        opts.animOut = {
            top: h
        };
    };
    $.fn.cycle.transitions.scrollLeft = function($cont, $slides, opts) {
        $cont.css("overflow", "hidden");
        opts.before.push($.fn.cycle.commonReset);
        var w = $cont.width();
        opts.cssFirst = {
            left: 0
        };
        opts.cssBefore = {
            left: w,
            top: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            left: 0 - w
        };
    };
    $.fn.cycle.transitions.scrollRight = function($cont, $slides, opts) {
        $cont.css("overflow", "hidden");
        opts.before.push($.fn.cycle.commonReset);
        var w = $cont.width();
        opts.cssFirst = {
            left: 0
        };
        opts.cssBefore = {
            left: -w,
            top: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            left: w
        };
    };
    $.fn.cycle.transitions.scrollHorz = function($cont, $slides, opts) {
        $cont.css("overflow", "hidden").width();
        opts.before.push(function(curr, next, opts, fwd) {
            $.fn.cycle.commonReset(curr, next, opts);
            opts.cssBefore.left = fwd ? (next.cycleW - 1) : (1 - next.cycleW);
            opts.animOut.left = fwd ? -curr.cycleW : curr.cycleW;
        });
        opts.cssFirst = {
            left: 0
        };
        opts.cssBefore = {
            top: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            top: 0
        };
    };
    $.fn.cycle.transitions.scrollVert = function($cont, $slides, opts) {
        $cont.css("overflow", "hidden");
        opts.before.push(function(curr, next, opts, fwd) {
            $.fn.cycle.commonReset(curr, next, opts);
            opts.cssBefore.top = fwd ? (1 - next.cycleH) : (next.cycleH - 1);
            opts.animOut.top = fwd ? curr.cycleH : -curr.cycleH;
        });
        opts.cssFirst = {
            top: 0
        };
        opts.cssBefore = {
            left: 0
        };
        opts.animIn = {
            top: 0
        };
        opts.animOut = {
            left: 0
        };
    };
    $.fn.cycle.transitions.slideX = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $(opts.elements).not(curr).hide();
            $.fn.cycle.commonReset(curr, next, opts, false, true);
            opts.animIn.width = next.cycleW;
        });
        opts.cssBefore = {
            left: 0,
            top: 0,
            width: 0
        };
        opts.animIn = {
            width: "show"
        };
        opts.animOut = {
            width: 0
        };
    };
    $.fn.cycle.transitions.slideY = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $(opts.elements).not(curr).hide();
            $.fn.cycle.commonReset(curr, next, opts, true, false);
            opts.animIn.height = next.cycleH;
        });
        opts.cssBefore = {
            left: 0,
            top: 0,
            height: 0
        };
        opts.animIn = {
            height: "show"
        };
        opts.animOut = {
            height: 0
        };
    };
    $.fn.cycle.transitions.shuffle = function($cont, $slides, opts) {
        var i, w = $cont.css("overflow", "visible").width();
        $slides.css({
            left: 0,
            top: 0
        });
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, true, true);
        });
        if (!opts.speedAdjusted) {
            opts.speed = opts.speed / 2;
            opts.speedAdjusted = true;
        }
        opts.random = 0;
        opts.shuffle = opts.shuffle || {
            left: -w,
            top: 15
        };
        opts.els = [];
        for (i = 0; i < $slides.length; i++) {
            opts.els.push($slides[i]);
        }
        for (i = 0; i < opts.currSlide; i++) {
            opts.els.push(opts.els.shift());
        }
        opts.fxFn = function(curr, next, opts, cb, fwd) {
            var $el = fwd ? $(curr) : $(next);
            $(next).css(opts.cssBefore);
            var count = opts.slideCount;
            $el.animate(opts.shuffle, opts.speedIn, opts.easeIn, function() {
                var hops = $.fn.cycle.hopsFromLast(opts, fwd);
                for (var k = 0; k < hops; k++) {
                    fwd ? opts.els.push(opts.els.shift()) : opts.els.unshift(opts.els.pop());
                }
                if (fwd) {
                    for (var i = 0, len = opts.els.length; i < len; i++) {
                        $(opts.els[i]).css("z-index", len - i + count);
                    }
                } else {
                    var z = $(curr).css("z-index");
                    $el.css("z-index", parseInt(z) + 1 + count);
                }
                $el.animate({
                    left: 0,
                    top: 0
                }, opts.speedOut, opts.easeOut, function() {
                    $(fwd ? this : curr).hide();
                    if (cb) {
                        cb();
                    }
                });
            });
        };
        opts.cssBefore = {
            display: "block",
            opacity: 1,
            top: 0,
            left: 0
        };
    };
    $.fn.cycle.transitions.turnUp = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, false);
            opts.cssBefore.top = next.cycleH;
            opts.animIn.height = next.cycleH;
        });
        opts.cssFirst = {
            top: 0
        };
        opts.cssBefore = {
            left: 0,
            height: 0
        };
        opts.animIn = {
            top: 0
        };
        opts.animOut = {
            height: 0
        };
    };
    $.fn.cycle.transitions.turnDown = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, false);
            opts.animIn.height = next.cycleH;
            opts.animOut.top = curr.cycleH;
        });
        opts.cssFirst = {
            top: 0
        };
        opts.cssBefore = {
            left: 0,
            top: 0,
            height: 0
        };
        opts.animOut = {
            height: 0
        };
    };
    $.fn.cycle.transitions.turnLeft = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, false, true);
            opts.cssBefore.left = next.cycleW;
            opts.animIn.width = next.cycleW;
        });
        opts.cssBefore = {
            top: 0,
            width: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            width: 0
        };
    };
    $.fn.cycle.transitions.turnRight = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, false, true);
            opts.animIn.width = next.cycleW;
            opts.animOut.left = curr.cycleW;
        });
        opts.cssBefore = {
            top: 0,
            left: 0,
            width: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            width: 0
        };
    };
    $.fn.cycle.transitions.zoom = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, false, false, true);
            opts.cssBefore.top = next.cycleH / 2;
            opts.cssBefore.left = next.cycleW / 2;
            opts.animIn = {
                top: 0,
                left: 0,
                width: next.cycleW,
                height: next.cycleH
            };
            opts.animOut = {
                width: 0,
                height: 0,
                top: curr.cycleH / 2,
                left: curr.cycleW / 2
            };
        });
        opts.cssFirst = {
            top: 0,
            left: 0
        };
        opts.cssBefore = {
            width: 0,
            height: 0
        };
    };
    $.fn.cycle.transitions.fadeZoom = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, false, false);
            opts.cssBefore.left = next.cycleW / 2;
            opts.cssBefore.top = next.cycleH / 2;
            opts.animIn = {
                top: 0,
                left: 0,
                width: next.cycleW,
                height: next.cycleH
            };
        });
        opts.cssBefore = {
            width: 0,
            height: 0
        };
        opts.animOut = {
            opacity: 0
        };
    };
    $.fn.cycle.transitions.blindX = function($cont, $slides, opts) {
        var w = $cont.css("overflow", "hidden").width();
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts);
            opts.animIn.width = next.cycleW;
            opts.animOut.left = curr.cycleW;
        });
        opts.cssBefore = {
            left: w,
            top: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            left: w
        };
    };
    $.fn.cycle.transitions.blindY = function($cont, $slides, opts) {
        var h = $cont.css("overflow", "hidden").height();
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts);
            opts.animIn.height = next.cycleH;
            opts.animOut.top = curr.cycleH;
        });
        opts.cssBefore = {
            top: h,
            left: 0
        };
        opts.animIn = {
            top: 0
        };
        opts.animOut = {
            top: h
        };
    };
    $.fn.cycle.transitions.blindZ = function($cont, $slides, opts) {
        var h = $cont.css("overflow", "hidden").height();
        var w = $cont.width();
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts);
            opts.animIn.height = next.cycleH;
            opts.animOut.top = curr.cycleH;
        });
        opts.cssBefore = {
            top: h,
            left: w
        };
        opts.animIn = {
            top: 0,
            left: 0
        };
        opts.animOut = {
            top: h,
            left: w
        };
    };
    $.fn.cycle.transitions.growX = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, false, true);
            opts.cssBefore.left = this.cycleW / 2;
            opts.animIn = {
                left: 0,
                width: this.cycleW
            };
            opts.animOut = {
                left: 0
            };
        });
        opts.cssBefore = {
            width: 0,
            top: 0
        };
    };
    $.fn.cycle.transitions.growY = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, false);
            opts.cssBefore.top = this.cycleH / 2;
            opts.animIn = {
                top: 0,
                height: this.cycleH
            };
            opts.animOut = {
                top: 0
            };
        });
        opts.cssBefore = {
            height: 0,
            left: 0
        };
    };
    $.fn.cycle.transitions.curtainX = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, false, true, true);
            opts.cssBefore.left = next.cycleW / 2;
            opts.animIn = {
                left: 0,
                width: this.cycleW
            };
            opts.animOut = {
                left: curr.cycleW / 2,
                width: 0
            };
        });
        opts.cssBefore = {
            top: 0,
            width: 0
        };
    };
    $.fn.cycle.transitions.curtainY = function($cont, $slides, opts) {
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, false, true);
            opts.cssBefore.top = next.cycleH / 2;
            opts.animIn = {
                top: 0,
                height: next.cycleH
            };
            opts.animOut = {
                top: curr.cycleH / 2,
                height: 0
            };
        });
        opts.cssBefore = {
            left: 0,
            height: 0
        };
    };
    $.fn.cycle.transitions.cover = function($cont, $slides, opts) {
        var d = opts.direction || "left";
        var w = $cont.css("overflow", "hidden").width();
        var h = $cont.height();
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts);
            if (d == "right") {
                opts.cssBefore.left = -w;
            } else {
                if (d == "up") {
                    opts.cssBefore.top = h;
                } else {
                    if (d == "down") {
                        opts.cssBefore.top = -h;
                    } else {
                        opts.cssBefore.left = w;
                    }
                }
            }
        });
        opts.animIn = {
            left: 0,
            top: 0
        };
        opts.animOut = {
            opacity: 1
        };
        opts.cssBefore = {
            top: 0,
            left: 0
        };
    };
    $.fn.cycle.transitions.uncover = function($cont, $slides, opts) {
        var d = opts.direction || "left";
        var w = $cont.css("overflow", "hidden").width();
        var h = $cont.height();
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, true, true);
            if (d == "right") {
                opts.animOut.left = w;
            } else {
                if (d == "up") {
                    opts.animOut.top = -h;
                } else {
                    if (d == "down") {
                        opts.animOut.top = h;
                    } else {
                        opts.animOut.left = -w;
                    }
                }
            }
        });
        opts.animIn = {
            left: 0,
            top: 0
        };
        opts.animOut = {
            opacity: 1
        };
        opts.cssBefore = {
            top: 0,
            left: 0
        };
    };
    $.fn.cycle.transitions.toss = function($cont, $slides, opts) {
        var w = $cont.css("overflow", "visible").width();
        var h = $cont.height();
        opts.before.push(function(curr, next, opts) {
            $.fn.cycle.commonReset(curr, next, opts, true, true, true);
            if (!opts.animOut.left && !opts.animOut.top) {
                opts.animOut = {
                    left: w * 2,
                    top: -h / 2,
                    opacity: 0
                };
            } else {
                opts.animOut.opacity = 0;
            }
        });
        opts.cssBefore = {
            left: 0,
            top: 0
        };
        opts.animIn = {
            left: 0
        };
    };
    $.fn.cycle.transitions.wipe = function($cont, $slides, opts) {
        var w = $cont.css("overflow", "hidden").width();
        var h = $cont.height();
        opts.cssBefore = opts.cssBefore || {};
        var clip;
        if (opts.clip) {
            if (/l2r/.test(opts.clip)) {
                clip = "rect(0px 0px " + h + "px 0px)";
            } else {
                if (/r2l/.test(opts.clip)) {
                    clip = "rect(0px " + w + "px " + h + "px " + w + "px)";
                } else {
                    if (/t2b/.test(opts.clip)) {
                        clip = "rect(0px " + w + "px 0px 0px)";
                    } else {
                        if (/b2t/.test(opts.clip)) {
                            clip = "rect(" + h + "px " + w + "px " + h + "px 0px)";
                        } else {
                            if (/zoom/.test(opts.clip)) {
                                var top = parseInt(h / 2);
                                var left = parseInt(w / 2);
                                clip = "rect(" + top + "px " + left + "px " + top + "px " + left + "px)";
                            }
                        }
                    }
                }
            }
        }
        opts.cssBefore.clip = opts.cssBefore.clip || clip || "rect(0px 0px 0px 0px)";
        var d = opts.cssBefore.clip.match(/(\d+)/g);
        var t = parseInt(d[0]),
            r = parseInt(d[1]),
            b = parseInt(d[2]),
            l = parseInt(d[3]);
        opts.before.push(function(curr, next, opts) {
            if (curr == next) {
                return;
            }
            var $curr = $(curr),
                $next = $(next);
            $.fn.cycle.commonReset(curr, next, opts, true, true, false);
            opts.cssAfter.display = "block";
            var step = 1,
                count = parseInt((opts.speedIn / 13)) - 1;
            (function f() {
                var tt = t ? t - parseInt(step * (t / count)) : 0;
                var ll = l ? l - parseInt(step * (l / count)) : 0;
                var bb = b < h ? b + parseInt(step * ((h - b) / count || 1)) : h;
                var rr = r < w ? r + parseInt(step * ((w - r) / count || 1)) : w;
                $next.css({
                    clip: "rect(" + tt + "px " + rr + "px " + bb + "px " + ll + "px)"
                });
                (step++ <= count) ? setTimeout(f, 13): $curr.css("display", "none");
            })();
        });
        opts.cssBefore = {
            display: "block",
            opacity: 1,
            top: 0,
            left: 0
        };
        opts.animIn = {
            left: 0
        };
        opts.animOut = {
            left: 0
        };
    };
})(jQuery);

(function($) {
    var textarea, staticOffset;
    var iLastMousePos = 0;
    var iMin = 32;
    var grip;
    $.fn.TextAreaResizer = function() {
        return this.each(function() {
            textarea = $(this).addClass('processed'), staticOffset = null;
            $(this).wrap('<div class="resizable-textarea"><span></span></div>').parent().append($('<div class="grippie"></div>').bind("mousedown", {
                el: this
            }, startDrag));
            var grippie = $('div.grippie', $(this).parent())[0];
            grippie.style.marginRight = (grippie.offsetWidth - $(this)[0].offsetWidth) + 'px';
        });
    };

    function startDrag(e) {
        textarea = $(e.data.el);
        textarea.blur();
        iLastMousePos = mousePosition(e).y;
        staticOffset = textarea.height() - iLastMousePos;
        textarea.css('opacity', 0.25);
        $(document).mousemove(performDrag).mouseup(endDrag);
        return false;
    }

    function performDrag(e) {
        var iThisMousePos = mousePosition(e).y;
        var iMousePos = staticOffset + iThisMousePos;
        if (iLastMousePos >= (iThisMousePos)) {
            iMousePos -= 5;
        }
        iLastMousePos = iThisMousePos;
        iMousePos = Math.max(iMin, iMousePos);
        textarea.height(iMousePos + 'px');
        if (iMousePos < iMin) {
            endDrag(e);
        }
        return false;
    }

    function endDrag(e) {
        $(document).unbind('mousemove', performDrag).unbind('mouseup', endDrag);
        textarea.css('opacity', 1);
        textarea.focus();
        textarea = null;
        staticOffset = null;
        iLastMousePos = 0;
    }

    function mousePosition(e) {
        return {
            x: e.clientX + document.documentElement.scrollLeft,
            y: e.clientY + document.documentElement.scrollTop
        };
    };
})(jQuery);

(function(w) {
    var E = w(window),
        u, f, F = -1,
        n, x, D, v, y, L, r, m = !window.XMLHttpRequest,
        s = [],
        l = document.documentElement,
        k = {},
        t = new Image(),
        J = new Image(),
        H, a, g, p, I, d, G, c, A, K;
    w(function() {
        w("body").append(w([H = w('<div id="lbOverlay" />').click(C)[0], a = w('<div id="lbCenter" />')[0], G = w('<div id="lbBottomContainer" />')[0]]).css("display", "none"));
        g = w('<div id="lbImage" />').appendTo(a).append(p = w('<div style="position: relative;" />').append([I = w('<a id="lbPrevLink" href="#" />').click(B)[0], d = w('<a id="lbNextLink" href="#" />').click(e)[0]])[0])[0];
        c = w('<div id="lbBottom" />').appendTo(G).append([w('<a id="lbCloseLink" href="#" />').click(C)[0], A = w('<div id="lbCaption" />')[0], K = w('<div id="lbNumber" />')[0], w('<div style="clear: both;" />')[0]])[0]
    });
    w.slimbox = function(O, N, M) {
        u = w.extend({
            loop: false,
            overlayOpacity: 0.8,
            overlayFadeDuration: 400,
            resizeDuration: 400,
            resizeEasing: "swing",
            initialWidth: 250,
            initialHeight: 250,
            imageFadeDuration: 400,
            captionAnimationDuration: 400,
            counterText: "Image {x} of {y}",
            closeKeys: [27, 88, 67],
            previousKeys: [37, 80],
            nextKeys: [39, 78]
        }, M);
        if (typeof O == "string") {
            O = [
                [O, N]
            ];
            N = 0
        }
        y = E.scrollTop() + (E.height() / 2);
        L = u.initialWidth;
        r = u.initialHeight;
        w(a).css({
            top: Math.max(0, y - (r / 2)),
            width: L,
            height: r,
            marginLeft: -L / 2
        }).show();
        v = m || (H.currentStyle && (H.currentStyle.position != "fixed"));
        if (v) {
            H.style.position = "absolute"
        }
        w(H).css("opacity", u.overlayOpacity).fadeIn(u.overlayFadeDuration);
        z();
        j(1);
        f = O;
        u.loop = u.loop && (f.length > 1);
        return b(N)
    };
    w.fn.slimbox = function(M, P, O) {
        P = P || function(Q) {
            return [Q.href, Q.title]
        };
        O = O || function() {
            return true
        };
        var N = this;
        return N.unbind("click").click(function() {
            var S = this,
                U = 0,
                T, Q = 0,
                R;
            T = w.grep(N, function(W, V) {
                return O.call(S, W, V)
            });
            for (R = T.length; Q < R; ++Q) {
                if (T[Q] == S) {
                    U = Q
                }
                T[Q] = P(T[Q], Q)
            }
            return w.slimbox(T, U, M)
        })
    };

    function z() {
        var N = E.scrollLeft(),
            M = E.width();
        w([a, G]).css("left", N + (M / 2));
        if (v) {
            w(H).css({
                left: N,
                top: E.scrollTop(),
                width: M,
                height: E.height()
            })
        }
    }

    function j(M) {
        if (M) {
            w("object").add(m ? "select" : "embed").each(function(O, P) {
                s[O] = [P, P.style.visibility];
                P.style.visibility = "hidden"
            })
        } else {
            w.each(s, function(O, P) {
                P[0].style.visibility = P[1]
            });
            s = []
        }
        var N = M ? "bind" : "unbind";
        E[N]("scroll resize", z);
        w(document)[N]("keydown", o)
    }

    function o(O) {
        var N = O.which,
            M = w.inArray;
        return (M(N, u.closeKeys) >= 0) ? C() : (M(N, u.nextKeys) >= 0) ? e() : (M(N, u.previousKeys) >= 0) ? B() : null
    }

    function B() {
        return b(x)
    }

    function e() {
        return b(D)
    }

    function b(M) {
        if (M >= 0) {
            F = M;
            n = f[F][0];
            x = (F || (u.loop ? f.length : 0)) - 1;
            D = ((F + 1) % f.length) || (u.loop ? 0 : -1);
            q();
            a.className = "lbLoading";
            k = new Image();
            k.onload = i;
            k.src = n;
        }
        return false;
    }

    function i() {
        a.className = "";
        w(g).css({
            backgroundImage: "url(" + n + ")",
            visibility: "hidden",
            display: ""
        });
        w(p).width(k.width);
        w([p, I, d]).height(k.height);
        w(A).html(f[F][1] + "<br /> <a href='" + n + "'>Download Image</a><br />" || "");
        w(K).html((((f.length > 1) && u.counterText) || "").replace(/{x}/, F + 1).replace(/{y}/, f.length));
        if (x >= 0) {
            t.src = f[x][0]
        }
        if (D >= 0) {
            J.src = f[D][0]
        }
        L = g.offsetWidth;
        r = g.offsetHeight;
        var M = Math.max(0, y - (r / 2));
        if (a.offsetHeight != r) {
            w(a).animate({
                height: r,
                top: M
            }, u.resizeDuration, u.resizeEasing)
        }
        if (a.offsetWidth != L) {
            w(a).animate({
                width: L,
                marginLeft: -L / 2
            }, u.resizeDuration, u.resizeEasing)
        }
        w(a).queue(function() {
            w(G).css({
                width: L,
                top: M + r,
                marginLeft: -L / 2,
                visibility: "hidden",
                display: ""
            });
            w(g).css({
                display: "none",
                visibility: "",
                opacity: ""
            }).fadeIn(u.imageFadeDuration, h)
        })
    }

    function h() {
        if (x >= 0) {
            w(I).show()
        }
        if (D >= 0) {
            w(d).show()
        }
        w(c).css("marginTop", -c.offsetHeight).animate({
            marginTop: 0
        }, u.captionAnimationDuration);
        G.style.visibility = ""
    }

    function q() {
        k.onload = null;
        k.src = t.src = J.src = n;
        w([a, g, c]).stop(true);
        w([I, d, g, G]).hide()
    }

    function C() {
        if (F >= 0) {
            q();
            F = x = D = -1;
            w(a).hide();
            w(H).stop().fadeOut(u.overlayFadeDuration, j)
        }
        return false
    }
})(jQuery);
if (!/android|iphone|ipod|series60|symbian|windows ce|blackberry/i.test(navigator.userAgent)) {
    jQuery(function($) {
        $("a[rel^='lightbox']").slimbox({}, function(el) {
            return [el.href, el.getAttribute("slimboxcaption") != null ? el.getAttribute("slimboxcaption") : ""];
        }, function(el) {
            return (this == el) || ((this.rel.length > 8) && (this.rel == el.rel));
        });
    });
};
/*
 * TipTip
 * Copyright 2010 Drew Wilson
 * www.drewwilson.com
 * code.drewwilson.com/entry/tiptip-jquery-plugin
 *
 * Version 1.3   -   Updated: Mar. 23, 2010
 *
 * This Plug-In will create a custom tooltip to replace the default
 * browser tooltip. It is extremely lightweight and very smart in
 * that it detects the edges of the browser window and will make sure
 * the tooltip stays within the current window size. As a result the
 * tooltip will adjust itself to be displayed above, below, to the left 
 * or to the right depending on what is necessary to stay within the
 * browser window. It is completely customizable as well via CSS.
 *
 * This TipTip jQuery plug-in is dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */

(function(a) {
    a.fn.tipTip = function(c) {
        var g = {
            activation: "hover",
            keepAlive: false,
            maxWidth: "200px",
            edgeOffset: 3,
            defaultPosition: "bottom",
            delay: 400,
            fadeIn: 200,
            fadeOut: 200,
            attribute: "title",
            content: false,
            enter: function() {},
            exit: function() {},
            unbind: false
        };
        var e = a.extend(g, c);
        if (a("#tiptip_holder").length <= 0) {
            var b = a('<div id="tiptip_holder" style="max-width:' + e.maxWidth + ';"></div>');
            var d = a('<div id="tiptip_content"></div>');
            var f = a('<div id="tiptip_arrow"></div>');
            a("body").append(b.html(d).prepend(f.html('<div id="tiptip_arrow_inner"></div>')))
        } else {
            var b = a("#tiptip_holder");
            var d = a("#tiptip_content");
            var f = a("#tiptip_arrow")
        }
        return this.each(function() {
            var j = a(this);
            var o = "";
            if (e.content) {
                o = e.content
            } else {
                o = j.attr(e.attribute)
            }
            if (e.unbind) {
                var l = j.attr("class").split(" ");
                var n = "";
                var h = "";
                a.each(l, function(p, q) {
                    if (q.match("^cd:") == "cd:") {
                        h = q;
                        n = q.replace(/^cd:/g, "")
                    }
                });
                j.attr(e.attribute, unescape(n));
                j.removeClass(h);
                j.unbind(e.activation);
                return true
            }
            if (o != "") {
                if (!e.content) {
                    j.addClass("cd:" + escape(o));
                    j.removeAttr(e.attribute)
                }
                var i = false;
                if (e.activation == "hover") {
                    j.hover(function() {
                        m()
                    }, function() {
                        if (!e.keepAlive) {
                            k()
                        }
                    });
                    if (e.keepAlive) {
                        b.hover(function() {}, function() {
                            k()
                        })
                    }
                } else {
                    if (e.activation == "focus") {
                        j.focus(function() {
                            m()
                        }).blur(function() {
                            k()
                        })
                    } else {
                        if (e.activation == "click") {
                            j.click(function() {
                                m();
                                return false
                            }).hover(function() {}, function() {
                                if (!e.keepAlive) {
                                    k()
                                }
                            });
                            if (e.keepAlive) {
                                b.hover(function() {}, function() {
                                    k()
                                })
                            }
                        }
                    }
                }

                function m() {
                    e.enter.call(this);
                    d.html(o);
                    b.hide().removeAttr("class").css("margin", "0");
                    f.removeAttr("style");
                    var B = parseInt(j.offset()["top"]);
                    var s = parseInt(j.offset()["left"]);
                    var y = parseInt(j.outerWidth());
                    var D = parseInt(j.outerHeight());
                    var A = b.outerWidth();
                    var v = b.outerHeight();
                    var z = Math.round((y - A) / 2);
                    var r = Math.round((D - v) / 2);
                    var q = Math.round(s + z);
                    var p = Math.round(B + D + e.edgeOffset);
                    var w = "";
                    var F = "";
                    var x = Math.round(A - 12) / 2;
                    if (e.defaultPosition == "bottom") {
                        w = "_bottom"
                    } else {
                        if (e.defaultPosition == "top") {
                            w = "_top"
                        } else {
                            if (e.defaultPosition == "left") {
                                w = "_left"
                            } else {
                                if (e.defaultPosition == "right") {
                                    w = "_right"
                                }
                            }
                        }
                    }
                    var u = (z + s) < parseInt(a(window).scrollLeft());
                    var t = (A + s) > parseInt(a(window).width());
                    if ((u && z < 0) || (w == "_right" && !t) || (w == "_left" && s < (A + e.edgeOffset + 5))) {
                        w = "_right";
                        F = Math.round(v - 13) / 2;
                        x = -12;
                        q = Math.round(s + y + e.edgeOffset);
                        p = Math.round(B + r)
                    } else {
                        if ((t && z < 0) || (w == "_left" && !u)) {
                            w = "_left";
                            F = Math.round(v - 13) / 2;
                            x = Math.round(A);
                            q = Math.round(s - (A + e.edgeOffset + 5));
                            p = Math.round(B + r)
                        }
                    }
                    var C = (B + D + e.edgeOffset + v + 8) > parseInt(a(window).height() + a(window).scrollTop());
                    var E = ((B + D) - (e.edgeOffset + v + 8)) < 0;
                    if (C || (w == "_bottom" && C) || (w == "_top" && !E)) {
                        if (w == "_top" || w == "_bottom") {
                            w = "_top"
                        } else {
                            w = w + "_top"
                        }
                        F = v;
                        p = Math.round(B - (v + 5 + e.edgeOffset))
                    } else {
                        if (E | (w == "_top" && E) || (w == "_bottom" && !C)) {
                            if (w == "_top" || w == "_bottom") {
                                w = "_bottom"
                            } else {
                                w = w + "_bottom"
                            }
                            F = -12;
                            p = Math.round(B + D + e.edgeOffset)
                        }
                    }
                    if (w == "_right_top" || w == "_left_top") {
                        p = p + 5
                    } else {
                        if (w == "_right_bottom" || w == "_left_bottom") {
                            p = p - 5
                        }
                    }
                    if (w == "_left_top" || w == "_left_bottom") {
                        q = q + 5
                    }
                    f.css({
                        "margin-left": x + "px",
                        "margin-top": F + "px"
                    });
                    b.css({
                        "margin-left": q + "px",
                        "margin-top": p + "px"
                    }).attr("class", "tip" + w);
                    if (i) {
                        clearTimeout(i)
                    }
                    i = setTimeout(function() {
                        b.stop(true, true).fadeIn(e.fadeIn)
                    }, e.delay)
                }

                function k() {
                    e.exit.call(this);
                    if (i) {
                        clearTimeout(i)
                    }
                    b.fadeOut(e.fadeOut)
                }
            }
        })
    }
})(jQuery);
/*!
	Colorbox v1.5.5 - 2014-03-13
	jQuery lightbox and modal window plugin
	(c) 2014 Jack Moore - http://www.jacklmoore.com/colorbox
	license: http://www.opensource.org/licenses/mit-license.php
*/
(function(t, e, i) {
    function n(i, n, o) {
        var r = e.createElement(i);
        return n && (r.id = Z + n), o && (r.style.cssText = o), t(r)
    }

    function o() {
        return i.innerHeight ? i.innerHeight : t(i).height()
    }

    function r(e, i) {
        i !== Object(i) && (i = {}), this.cache = {}, this.el = e, this.value = function(e) {
            var n;
            return void 0 === this.cache[e] && (n = t(this.el).attr("data-cbox-" + e), void 0 !== n ? this.cache[e] = n : void 0 !== i[e] ? this.cache[e] = i[e] : void 0 !== X[e] && (this.cache[e] = X[e])), this.cache[e]
        }, this.get = function(e) {
            var i = this.value(e);
            return t.isFunction(i) ? i.call(this.el, this) : i
        }
    }

    function h(t) {
        var e = E.length,
            i = (z + t) % e;
        return 0 > i ? e + i : i
    }

    function s(t, e) {
        return Math.round((/%/.test(t) ? ("x" === e ? W.width() : o()) / 100 : 1) * parseInt(t, 10))
    }

    function a(t, e) {
        return t.get("photo") || t.get("photoRegex").test(e)
    }

    function l(t, e) {
        return t.get("retinaUrl") && i.devicePixelRatio > 1 ? e.replace(t.get("photoRegex"), t.get("retinaSuffix")) : e
    }

    function d(t) {
        "contains" in x[0] && !x[0].contains(t.target) && t.target !== v[0] && (t.stopPropagation(), x.focus())
    }

    function c(t) {
        c.str !== t && (x.add(v).removeClass(c.str).addClass(t), c.str = t)
    }

    function g() {
        z = 0, rel && "nofollow" !== rel ? (E = t("." + te).filter(function() {
            var e = t.data(this, Y),
                i = new r(this, e);
            return i.get("rel") === rel
        }), z = E.index(_.el), -1 === z && (E = E.add(_.el), z = E.length - 1)) : E = t(_.el)
    }

    function u(i) {
        t(e).trigger(i), se.triggerHandler(i)
    }

    function f(i) {
        var o;
        G || (o = t(i).data("colorbox"), _ = new r(i, o), rel = _.get("rel"), g(), $ || ($ = q = !0, c(_.get("className")), x.css({
            visibility: "hidden",
            display: "block",
            opacity: ""
        }), L = n(ae, "LoadedContent", "width:0; height:0; overflow:hidden; visibility:hidden"), b.css({
            width: "",
            height: ""
        }).append(L), D = T.height() + k.height() + b.outerHeight(!0) - b.height(), j = C.width() + H.width() + b.outerWidth(!0) - b.width(), A = L.outerHeight(!0), N = L.outerWidth(!0), _.w = s(_.get("initialWidth"), "x"), _.h = s(_.get("initialHeight"), "y"), L.css({
            width: "",
            height: _.h
        }), J.position(), u(ee), _.get("onOpen"), O.add(R).hide(), x.focus(), _.get("trapFocus") && e.addEventListener && (e.addEventListener("focus", d, !0), se.one(re, function() {
            e.removeEventListener("focus", d, !0)
        })), _.get("returnFocus") && se.one(re, function() {
            t(_.el).focus()
        })), v.css({
            opacity: parseFloat(_.get("opacity")) || "",
            cursor: _.get("overlayClose") ? "pointer" : "",
            visibility: "visible"
        }).show(), _.get("closeButton") ? B.html(_.get("close")).appendTo(b) : B.appendTo("<div/>"), w())
    }

    function p() {
        !x && e.body && (V = !1, W = t(i), x = n(ae).attr({
            id: Y,
            "class": t.support.opacity === !1 ? Z + "IE" : "",
            role: "dialog",
            tabindex: "-1"
        }).hide(), v = n(ae, "Overlay").hide(), M = t([n(ae, "LoadingOverlay")[0], n(ae, "LoadingGraphic")[0]]), y = n(ae, "Wrapper"), b = n(ae, "Content").append(R = n(ae, "Title"), F = n(ae, "Current"), P = t('<button type="button"/>').attr({
            id: Z + "Previous"
        }), K = t('<button type="button"/>').attr({
            id: Z + "Next"
        }), I = n("button", "Slideshow"), M), B = t('<button type="button"/>').attr({
            id: Z + "Close"
        }), y.append(n(ae).append(n(ae, "TopLeft"), T = n(ae, "TopCenter"), n(ae, "TopRight")), n(ae, !1, "clear:left").append(C = n(ae, "MiddleLeft"), b, H = n(ae, "MiddleRight")), n(ae, !1, "clear:left").append(n(ae, "BottomLeft"), k = n(ae, "BottomCenter"), n(ae, "BottomRight"))).find("div div").css({
            "float": "left"
        }), S = n(ae, !1, "position:absolute; width:9999px; visibility:hidden; display:none; max-width:none;"), O = K.add(P).add(F).add(I), t(e.body).append(v, x.append(y, S)))
    }

    function m() {
        function i(t) {
            t.which > 1 || t.shiftKey || t.altKey || t.metaKey || t.ctrlKey || (t.preventDefault(), f(this))
        }
        return x ? (V || (V = !0, K.click(function() {
            J.next()
        }), P.click(function() {
            J.prev()
        }), B.click(function() {
            J.close()
        }), v.click(function() {
            _.get("overlayClose") && J.close()
        }), t(e).bind("keydown." + Z, function(t) {
            var e = t.keyCode;
            $ && _.get("escKey") && 27 === e && (t.preventDefault(), J.close()), $ && _.get("arrowKey") && E[1] && !t.altKey && (37 === e ? (t.preventDefault(), P.click()) : 39 === e && (t.preventDefault(), K.click()))
        }), t.isFunction(t.fn.on) ? t(e).on("click." + Z, "." + te, i) : t("." + te).live("click." + Z, i)), !0) : !1
    }

    function w() {
        var o, r, h, d = J.prep,
            c = ++le;
        q = !0, U = !1, u(he), u(ie), _.get("onLoad"), _.h = _.get("height") ? s(_.get("height"), "y") - A - D : _.get("innerHeight") && s(_.get("innerHeight"), "y"), _.w = _.get("width") ? s(_.get("width"), "x") - N - j : _.get("innerWidth") && s(_.get("innerWidth"), "x"), _.mw = _.w, _.mh = _.h, _.get("maxWidth") && (_.mw = s(_.get("maxWidth"), "x") - N - j, _.mw = _.w && _.w < _.mw ? _.w : _.mw), _.get("maxHeight") && (_.mh = s(_.get("maxHeight"), "y") - A - D, _.mh = _.h && _.h < _.mh ? _.h : _.mh), o = _.get("href"), Q = setTimeout(function() {
            M.show()
        }, 100), _.get("inline") ? (h = n(ae).hide().insertBefore(t(o)[0]), se.one(he, function() {
            h.replaceWith(L.children())
        }), d(t(o))) : _.get("iframe") ? d(" ") : _.get("html") ? d(_.get("html")) : a(_, o) ? (o = l(_, o), U = e.createElement("img"), t(U).addClass(Z + "Photo").bind("error", function() {
            d(n(ae, "Error").html(_.get("imgError")))
        }).one("load", function() {
            var e;
            c === le && (t.each(["alt", "longdesc", "aria-describedby"], function(e, i) {
                var n = t(_.el).attr(i) || t(_.el).attr("data-" + i);
                n && U.setAttribute(i, n)
            }), _.get("retinaImage") && i.devicePixelRatio > 1 && (U.height = U.height / i.devicePixelRatio, U.width = U.width / i.devicePixelRatio), _.get("scalePhotos") && (r = function() {
                U.height -= U.height * e, U.width -= U.width * e
            }, _.mw && U.width > _.mw && (e = (U.width - _.mw) / U.width, r()), _.mh && U.height > _.mh && (e = (U.height - _.mh) / U.height, r())), _.h && (U.style.marginTop = Math.max(_.mh - U.height, 0) / 2 + "px"), E[1] && (_.get("loop") || E[z + 1]) && (U.style.cursor = "pointer", U.onclick = function() {
                J.next()
            }), U.style.width = U.width + "px", U.style.height = U.height + "px", setTimeout(function() {
                d(U)
            }, 1))
        }), setTimeout(function() {
            U.src = o
        }, 1)) : o && S.load(o, _.get("data"), function(e, i) {
            c === le && d("error" === i ? n(ae, "Error").html(_.get("xhrError")) : t(this).contents())
        })
    }
    var v, x, y, b, T, C, H, k, E, W, L, S, M, R, F, I, K, P, B, O, _, D, j, A, N, z, U, $, q, G, Q, J, V, X = {
            html: !1,
            photo: !1,
            iframe: !1,
            inline: !1,
            transition: "elastic",
            speed: 300,
            fadeOut: 300,
            width: !1,
            initialWidth: "600",
            innerWidth: !1,
            maxWidth: !1,
            height: !1,
            initialHeight: "450",
            innerHeight: !1,
            maxHeight: !1,
            scalePhotos: !0,
            scrolling: !0,
            opacity: .9,
            preloading: !0,
            className: !1,
            overlayClose: !0,
            escKey: !0,
            arrowKey: !0,
            top: !1,
            bottom: !1,
            left: !1,
            right: !1,
            fixed: !1,
            data: void 0,
            closeButton: !0,
            fastIframe: !0,
            open: !1,
            reposition: !0,
            loop: !0,
            slideshow: !1,
            slideshowAuto: !0,
            slideshowSpeed: 2500,
            slideshowStart: "start slideshow",
            slideshowStop: "stop slideshow",
            photoRegex: /\.(gif|png|jp(e|g|eg)|bmp|ico|webp|jxr|svg)((#|\?).*)?$/i,
            retinaImage: !1,
            retinaUrl: !1,
            retinaSuffix: "@2x.$1",
            current: "image {current} of {total}",
            previous: "previous",
            next: "next",
            close: "close",
            xhrError: "This content failed to load.",
            imgError: "This image failed to load.",
            returnFocus: !0,
            trapFocus: !0,
            onOpen: !1,
            onLoad: !1,
            onComplete: !1,
            onCleanup: !1,
            onClosed: !1,
            rel: function() {
                return this.rel
            },
            href: function() {
                return t(this).attr("href")
            },
            title: function() {
                return this.title
            }
        },
        Y = "colorbox",
        Z = "cbox",
        te = Z + "Element",
        ee = Z + "_open",
        ie = Z + "_load",
        ne = Z + "_complete",
        oe = Z + "_cleanup",
        re = Z + "_closed",
        he = Z + "_purge",
        se = t("<a/>"),
        ae = "div",
        le = 0,
        de = {},
        ce = function() {
            function t() {
                clearTimeout(h)
            }

            function e() {
                (_.get("loop") || E[z + 1]) && (t(), h = setTimeout(J.next, _.get("slideshowSpeed")))
            }

            function i() {
                I.html(_.get("slideshowStop")).unbind(a).one(a, n), se.bind(ne, e).bind(ie, t), x.removeClass(s + "off").addClass(s + "on")
            }

            function n() {
                t(), se.unbind(ne, e).unbind(ie, t), I.html(_.get("slideshowStart")).unbind(a).one(a, function() {
                    J.next(), i()
                }), x.removeClass(s + "on").addClass(s + "off")
            }

            function o() {
                r = !1, I.hide(), t(), se.unbind(ne, e).unbind(ie, t), x.removeClass(s + "off " + s + "on")
            }
            var r, h, s = Z + "Slideshow_",
                a = "click." + Z;
            return function() {
                r ? _.get("slideshow") || (se.unbind(oe, o), o()) : _.get("slideshow") && E[1] && (r = !0, se.one(oe, o), _.get("slideshowAuto") ? i() : n(), I.show())
            }
        }();
    t.colorbox || (t(p), J = t.fn[Y] = t[Y] = function(e, i) {
        var n, o = this;
        if (e = e || {}, t.isFunction(o)) o = t("<a/>"), e.open = !0;
        else if (!o[0]) return o;
        return o[0] ? (p(), m() && (i && (e.onComplete = i), o.each(function() {
            var i = t.data(this, Y) || {};
            t.data(this, Y, t.extend(i, e))
        }).addClass(te), n = new r(o[0], e), n.get("open") && f(o[0])), o) : o
    }, J.position = function(e, i) {
        function n() {
            T[0].style.width = k[0].style.width = b[0].style.width = parseInt(x[0].style.width, 10) - j + "px", b[0].style.height = C[0].style.height = H[0].style.height = parseInt(x[0].style.height, 10) - D + "px"
        }
        var r, h, a, l = 0,
            d = 0,
            c = x.offset();
        if (W.unbind("resize." + Z), x.css({
                top: -9e4,
                left: -9e4
            }), h = W.scrollTop(), a = W.scrollLeft(), _.get("fixed") ? (c.top -= h, c.left -= a, x.css({
                position: "fixed"
            })) : (l = h, d = a, x.css({
                position: "absolute"
            })), d += _.get("right") !== !1 ? Math.max(W.width() - _.w - N - j - s(_.get("right"), "x"), 0) : _.get("left") !== !1 ? s(_.get("left"), "x") : Math.round(Math.max(W.width() - _.w - N - j, 0) / 2), l += _.get("bottom") !== !1 ? Math.max(o() - _.h - A - D - s(_.get("bottom"), "y"), 0) : _.get("top") !== !1 ? s(_.get("top"), "y") : Math.round(Math.max(o() - _.h - A - D, 0) / 2), x.css({
                top: c.top,
                left: c.left,
                visibility: "visible"
            }), y[0].style.width = y[0].style.height = "9999px", r = {
                width: _.w + N + j,
                height: _.h + A + D,
                top: l,
                left: d
            }, e) {
            var g = 0;
            t.each(r, function(t) {
                return r[t] !== de[t] ? (g = e, void 0) : void 0
            }), e = g
        }
        de = r, e || x.css(r), x.dequeue().animate(r, {
            duration: e || 0,
            complete: function() {
                n(), q = !1, y[0].style.width = _.w + N + j + "px", y[0].style.height = _.h + A + D + "px", _.get("reposition") && setTimeout(function() {
                    W.bind("resize." + Z, J.position)
                }, 1), i && i()
            },
            step: n
        })
    }, J.resize = function(t) {
        var e;
        $ && (t = t || {}, t.width && (_.w = s(t.width, "x") - N - j), t.innerWidth && (_.w = s(t.innerWidth, "x")), L.css({
            width: _.w
        }), t.height && (_.h = s(t.height, "y") - A - D), t.innerHeight && (_.h = s(t.innerHeight, "y")), t.innerHeight || t.height || (e = L.scrollTop(), L.css({
            height: "auto"
        }), _.h = L.height()), L.css({
            height: _.h
        }), e && L.scrollTop(e), J.position("none" === _.get("transition") ? 0 : _.get("speed")))
    }, J.prep = function(i) {
        function o() {
            return _.w = _.w || L.width(), _.w = _.mw && _.mw < _.w ? _.mw : _.w, _.w
        }

        function s() {
            return _.h = _.h || L.height(), _.h = _.mh && _.mh < _.h ? _.mh : _.h, _.h
        }
        if ($) {
            var d, g = "none" === _.get("transition") ? 0 : _.get("speed");
            L.remove(), L = n(ae, "LoadedContent").append(i), L.hide().appendTo(S.show()).css({
                width: o(),
                overflow: _.get("scrolling") ? "auto" : "hidden"
            }).css({
                height: s()
            }).prependTo(b), S.hide(), t(U).css({
                "float": "none"
            }), c(_.get("className")), d = function() {
                function i() {
                    t.support.opacity === !1 && x[0].style.removeAttribute("filter")
                }
                var n, o, s = E.length;
                $ && (o = function() {
                    clearTimeout(Q), M.hide(), u(ne), _.get("onComplete")
                }, R.html(_.get("title")).show(), L.show(), s > 1 ? ("string" == typeof _.get("current") && F.html(_.get("current").replace("{current}", z + 1).replace("{total}", s)).show(), K[_.get("loop") || s - 1 > z ? "show" : "hide"]().html(_.get("next")), P[_.get("loop") || z ? "show" : "hide"]().html(_.get("previous")), ce(), _.get("preloading") && t.each([h(-1), h(1)], function() {
                    var i, n = E[this],
                        o = new r(n, t.data(n, Y)),
                        h = o.get("href");
                    h && a(o, h) && (h = l(o, h), i = e.createElement("img"), i.src = h)
                })) : O.hide(), _.get("iframe") ? (n = e.createElement("iframe"), "frameBorder" in n && (n.frameBorder = 0), "allowTransparency" in n && (n.allowTransparency = "true"), _.get("scrolling") || (n.scrolling = "no"), t(n).attr({
                    src: _.get("href"),
                    name: (new Date).getTime(),
                    "class": Z + "Iframe",
                    allowFullScreen: !0
                }).one("load", o).appendTo(L), se.one(he, function() {
                    n.src = "//about:blank"
                }), _.get("fastIframe") && t(n).trigger("load")) : o(), "fade" === _.get("transition") ? x.fadeTo(g, 1, i) : i())
            }, "fade" === _.get("transition") ? x.fadeTo(g, 0, function() {
                J.position(0, d)
            }) : J.position(g, d)
        }
    }, J.next = function() {
        !q && E[1] && (_.get("loop") || E[z + 1]) && (z = h(1), f(E[z]))
    }, J.prev = function() {
        !q && E[1] && (_.get("loop") || z) && (z = h(-1), f(E[z]))
    }, J.close = function() {
        $ && !G && (G = !0, $ = !1, u(oe), _.get("onCleanup"), W.unbind("." + Z), v.fadeTo(_.get("fadeOut") || 0, 0), x.stop().fadeTo(_.get("fadeOut") || 0, 0, function() {
            x.hide(), v.hide(), u(he), L.remove(), setTimeout(function() {
                G = !1, u(re), _.get("onClosed")
            }, 1)
        }))
    }, J.remove = function() {
        x && (x.stop(), t.colorbox.close(), x.stop().remove(), v.remove(), G = !1, x = null, t("." + te).removeData(Y).removeClass(te), t(e).unbind("click." + Z))
    }, J.element = function() {
        return t(_.el)
    }, J.settings = X)
})(jQuery, document, window);

(function() {
    "use strict";
    var $, EkkoLightbox;
    $ = jQuery;
    EkkoLightbox = function(element, options) {
        var content, footer, header, _this = this;
        this.options = $.extend({
            title: null,
            footer: null,
            remote: null
        }, $.fn.ekkoLightbox.defaults, options || {});
        this.$element = $(element);
        content = '';
        this.modal_id = this.options.modal_id ? this.options.modal_id : 'ekkoLightbox-' + Math.floor((Math.random() * 1000) + 1);
        header = '<div class="modal-header"' + (this.options.title || this.options.always_show_close ? '' : ' style="display:none"') + '><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">' + (this.options.title || "&nbsp;") + '</h4></div>';
        footer = '<div class="modal-footer"' + (this.options.footer ? '' : ' style="display:none"') + '>' + this.options.footer + '</div>';
        $(document.body).append('<div id="' + this.modal_id + '" class="ekko-lightbox modal fade" tabindex="-1"><div class="modal-dialog"><div class="modal-content">' + header + '<div class="modal-body"><div class="ekko-lightbox-container"><div></div></div></div>' + footer + '</div></div></div>');
        this.modal = $('#' + this.modal_id);
        this.modal_dialog = this.modal.find('.modal-dialog').first();
        this.modal_content = this.modal.find('.modal-content').first();
        this.modal_body = this.modal.find('.modal-body').first();
        this.lightbox_container = this.modal_body.find('.ekko-lightbox-container').first();
        this.lightbox_body = this.lightbox_container.find('> div:first-child').first();
        this.showLoading();
        this.modal_arrows = null;
        this.border = {
            top: parseFloat(this.modal_dialog.css('border-top-width')) + parseFloat(this.modal_content.css('border-top-width')) + parseFloat(this.modal_body.css('border-top-width')),
            right: parseFloat(this.modal_dialog.css('border-right-width')) + parseFloat(this.modal_content.css('border-right-width')) + parseFloat(this.modal_body.css('border-right-width')),
            bottom: parseFloat(this.modal_dialog.css('border-bottom-width')) + parseFloat(this.modal_content.css('border-bottom-width')) + parseFloat(this.modal_body.css('border-bottom-width')),
            left: parseFloat(this.modal_dialog.css('border-left-width')) + parseFloat(this.modal_content.css('border-left-width')) + parseFloat(this.modal_body.css('border-left-width'))
        };
        this.padding = {
            top: parseFloat(this.modal_dialog.css('padding-top')) + parseFloat(this.modal_content.css('padding-top')) + parseFloat(this.modal_body.css('padding-top')),
            right: parseFloat(this.modal_dialog.css('padding-right')) + parseFloat(this.modal_content.css('padding-right')) + parseFloat(this.modal_body.css('padding-right')),
            bottom: parseFloat(this.modal_dialog.css('padding-bottom')) + parseFloat(this.modal_content.css('padding-bottom')) + parseFloat(this.modal_body.css('padding-bottom')),
            left: parseFloat(this.modal_dialog.css('padding-left')) + parseFloat(this.modal_content.css('padding-left')) + parseFloat(this.modal_body.css('padding-left'))
        };
        this.modal.on('show.bs.modal', this.options.onShow.bind(this)).on('shown.bs.modal', function() {
            _this.modal_shown();
            return _this.options.onShown.call(_this);
        }).on('hide.bs.modal', this.options.onHide.bind(this)).on('hidden.bs.modal', function() {
            if (_this.gallery) {
                $(document).off('keydown.ekkoLightbox');
            }
            _this.modal.remove();
            return _this.options.onHidden.call(_this);
        }).modal('show', options);
        return this.modal;
    };
    EkkoLightbox.prototype = {
        modal_shown: function() {
            var video_id, _this = this;
            if (!this.options.remote) {
                return this.error('No remote target given');
            } else {
                this.gallery = this.$element.data('gallery');
                if (this.gallery) {
                    if (this.options.gallery_parent_selector === 'document.body' || this.options.gallery_parent_selector === '') {
                        this.gallery_items = $(document.body).find('*[data-toggle="lightbox"][data-gallery="' + this.gallery + '"]');
                    } else {
                        this.gallery_items = this.$element.parents(this.options.gallery_parent_selector).first().find('*[data-toggle="lightbox"][data-gallery="' + this.gallery + '"]');
                    }
                    this.gallery_index = this.gallery_items.index(this.$element);
                    $(document).on('keydown.ekkoLightbox', this.navigate.bind(this));
                    if (this.options.directional_arrows && this.gallery_items.length > 1) {
                        this.lightbox_container.prepend('<div class="ekko-lightbox-nav-overlay"><a href="#" class="' + this.strip_stops(this.options.left_arrow_class) + '"></a><a href="#" class="' + this.strip_stops(this.options.right_arrow_class) + '"></a></div>');
                        this.modal_arrows = this.lightbox_container.find('div.ekko-lightbox-nav-overlay').first();
                        this.lightbox_container.find('a' + this.strip_spaces(this.options.left_arrow_class)).on('click', function(event) {
                            event.preventDefault();
                            return _this.navigate_left();
                        });
                        this.lightbox_container.find('a' + this.strip_spaces(this.options.right_arrow_class)).on('click', function(event) {
                            event.preventDefault();
                            return _this.navigate_right();
                        });
                    }
                }
                if (this.options.type) {
                    if (this.options.type === 'image') {
                        return this.preloadImage(this.options.remote, true);
                    } else if (this.options.type === 'youtube' && (video_id = this.getYoutubeId(this.options.remote))) {
                        return this.showYoutubeVideo(video_id);
                    } else if (this.options.type === 'vimeo') {
                        return this.showVimeoVideo(this.options.remote);
                    } else if (this.options.type === 'instagram') {
                        return this.showInstagramVideo(this.options.remote);
                    } else if (this.options.type === 'url') {
                        return this.showInstagramVideo(this.options.remote);
                    } else {
                        return this.error("Could not detect remote target type. Force the type using data-type=\"image|youtube|vimeo|url\"");
                    }
                } else {
                    return this.detectRemoteType(this.options.remote);
                }
            }
        },
        strip_stops: function(str) {
            return str.replace(/\./g, '');
        },
        strip_spaces: function(str) {
            return str.replace(/\s/g, '');
        },
        isImage: function(str) {
            return str.match(/(^data:image\/.*,)|(\.(jp(e|g|eg)|gif|png|bmp|webp|svg)((\?|#).*)?$)/i);
        },
        isSwf: function(str) {
            return str.match(/\.(swf)((\?|#).*)?$/i);
        },
        getYoutubeId: function(str) {
            var match;
            match = str.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            if (match && match[2].length === 11) {
                return match[2];
            } else {
                return false;
            }
        },
        getVimeoId: function(str) {
            if (str.indexOf('vimeo') > 0) {
                return str;
            } else {
                return false;
            }
        },
        getInstagramId: function(str) {
            if (str.indexOf('instagram') > 0) {
                return str;
            } else {
                return false;
            }
        },
        navigate: function(event) {
            event = event || window.event;
            if (event.keyCode === 39 || event.keyCode === 37) {
                if (event.keyCode === 39) {
                    return this.navigate_right();
                } else if (event.keyCode === 37) {
                    return this.navigate_left();
                }
            }
        },
        navigateTo: function(index) {
            var next, src;
            if (index < 0 || index > this.gallery_items.length - 1) {
                return this;
            }
            this.showLoading();
            this.gallery_index = index;
            this.options.onNavigate.call(this, this.gallery_index);
            this.$element = $(this.gallery_items.get(this.gallery_index));
            this.updateTitleAndFooter();
            src = this.$element.attr('data-remote') || this.$element.attr('href');
            this.detectRemoteType(src, this.$element.attr('data-type') || false);
            if (this.gallery_index + 1 < this.gallery_items.length) {
                next = $(this.gallery_items.get(this.gallery_index + 1), false);
                src = next.attr('data-remote') || next.attr('href');
                if (next.attr('data-type') === 'image' || this.isImage(src)) {
                    return this.preloadImage(src, false);
                }
            }
        },
        navigate_left: function() {
            if (this.gallery_items.length === 1) {
                return;
            }
            if (this.gallery_index === 0) {
                this.gallery_index = this.gallery_items.length - 1;
            } else {
                this.gallery_index--;
            }
            this.options.onNavigate.call(this, 'left', this.gallery_index);
            return this.navigateTo(this.gallery_index);
        },
        navigate_right: function() {
            if (this.gallery_items.length === 1) {
                return;
            }
            if (this.gallery_index === this.gallery_items.length - 1) {
                this.gallery_index = 0;
            } else {
                this.gallery_index++;
            }
            this.options.onNavigate.call(this, 'right', this.gallery_index);
            return this.navigateTo(this.gallery_index);
        },
        detectRemoteType: function(src, type) {
            var video_id;
            if (type === 'image' || this.isImage(src)) {
                this.options.type = 'image';
                return this.preloadImage(src, true);
            } else if (type === 'youtube' || (video_id = this.getYoutubeId(src))) {
                this.options.type = 'youtube';
                return this.showYoutubeVideo(video_id);
            } else if (type === 'vimeo' || (video_id = this.getVimeoId(src))) {
                this.options.type = 'vimeo';
                return this.showVimeoVideo(video_id);
            } else if (type === 'instagram' || (video_id = this.getInstagramId(src))) {
                this.options.type = 'instagram';
                return this.showInstagramVideo(video_id);
            } else if (type === 'url' || (video_id = this.getInstagramId(src))) {
                this.options.type = 'instagram';
                return this.showInstagramVideo(video_id);
            } else {
                this.options.type = 'url';
                return this.loadRemoteContent(src);
            }
        },
        updateTitleAndFooter: function() {
            var caption, footer, header, title;
            header = this.modal_content.find('.modal-header');
            footer = this.modal_content.find('.modal-footer');
            title = this.$element.data('title') || "";
            caption = this.$element.data('footer') || "";
            if (title || this.options.always_show_close) {
                header.css('display', '').find('.modal-title').html(title || "&nbsp;");
            } else {
                header.css('display', 'none');
            }
            if (caption) {
                footer.css('display', '').html(caption);
            } else {
                footer.css('display', 'none');
            }
            return this;
        },
        showLoading: function() {
            this.lightbox_body.html('<div class="modal-loading">Loading..</div>');
            return this;
        },
        showYoutubeVideo: function(id) {
            var aspectRatio, height, width;
            aspectRatio = 560 / 315;
            width = this.$element.data('width') || 560;
            width = this.checkDimensions(width);
            height = width / aspectRatio;
            this.resize(width);
            this.lightbox_body.html('<iframe width="' + width + '" height="' + height + '" src="//www.youtube.com/embed/' + id + '?badge=0&autoplay=1&html5=1" frameborder="0" allowfullscreen></iframe>');
            this.options.onContentLoaded.call(this);
            if (this.modal_arrows) {
                return this.modal_arrows.css('display', 'none');
            }
        },
        showVimeoVideo: function(id) {
            var aspectRatio, height, width;
            aspectRatio = 500 / 281;
            width = this.$element.data('width') || 560;
            width = this.checkDimensions(width);
            height = width / aspectRatio;
            this.resize(width);
            this.lightbox_body.html('<iframe width="' + width + '" height="' + height + '" src="' + id + '?autoplay=1" frameborder="0" allowfullscreen></iframe>');
            this.options.onContentLoaded.call(this);
            if (this.modal_arrows) {
                return this.modal_arrows.css('display', 'none');
            }
        },
        showInstagramVideo: function(id) {
            var width;
            width = this.$element.data('width') || 612;
            width = this.checkDimensions(width);
            this.resize(width);
            this.lightbox_body.html('<iframe width="' + width + '" height="' + width + '" src="' + this.addTrailingSlash(id) + 'embed/" frameborder="0" allowfullscreen></iframe>');
            this.options.onContentLoaded.call(this);
            if (this.modal_arrows) {
                return this.modal_arrows.css('display', 'none');
            }
        },
        loadRemoteContent: function(url) {
            var disableExternalCheck, width, _this = this;
            width = this.$element.data('width') || 560;
            this.resize(width);
            disableExternalCheck = this.$element.data('disableExternalCheck') || false;
            console.log(disableExternalCheck, this.isExternal(url));
            if (!disableExternalCheck && !this.isExternal(url)) {
                this.lightbox_body.load(url, $.proxy(function() {
                    return _this.$element.trigger('loaded.bs.modal');
                }));
            } else {
                this.lightbox_body.html('<iframe width="' + width + '" height="' + width + '" src="' + url + '" frameborder="0" allowfullscreen></iframe>');
                this.options.onContentLoaded.call(this);
            }
            if (this.modal_arrows) {
                return this.modal_arrows.css('display', 'block');
            }
        },
        isExternal: function(url) {
            var match;
            match = url.match(/^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/);
            if (typeof match[1] === "string" && match[1].length > 0 && match[1].toLowerCase() !== location.protocol) {
                return true;
            }
            if (typeof match[2] === "string" && match[2].length > 0 && match[2].replace(new RegExp(":(" + {
                    "http:": 80,
                    "https:": 443
                }[location.protocol] + ")?$"), "") !== location.host) {
                return true;
            }
            return false;
        },
        error: function(message) {
            this.lightbox_body.html(message);
            return this;
        },
        preloadImage: function(src, onLoadShowImage) {
            var img, _this = this;
            img = new Image();
            if ((onLoadShowImage == null) || onLoadShowImage === true) {
                img.onload = function() {
                    var image;
                    image = $('<img />');
                    image.attr('src', img.src);
                    image.addClass('img-responsive');
                    _this.lightbox_body.html(image);
                    if (_this.modal_arrows) {
                        _this.modal_arrows.css('display', 'block');
                    }
                    _this.resize(img.width);
                    return _this.options.onContentLoaded.call(_this);
                };
                img.onerror = function() {
                    return _this.error('Failed to load image: ' + src);
                };
            }
            img.src = src;
            return img;
        },
        resize: function(width) {
            var width_total;
            width_total = width + this.border.left + this.padding.left + this.padding.right + this.border.right;
            this.modal_dialog.css('width', 'auto').css('max-width', width_total);
            this.lightbox_container.find('a').css('padding-top', function() {
                return $(this).parent().height() / 2;
            });
            return this;
        },
        checkDimensions: function(width) {
            var body_width, width_total;
            width_total = width + this.border.left + this.padding.left + this.padding.right + this.border.right;
            body_width = document.body.clientWidth;
            if (width_total > body_width) {
                width = this.modal_body.width();
            }
            return width;
        },
        close: function() {
            return this.modal.modal('hide');
        },
        addTrailingSlash: function(url) {
            if (url.substr(-1) !== '/') {
                url += '/';
            }
            return url;
        }
    };
    $.fn.ekkoLightbox = function(options) {
        return this.each(function() {
            var $this;
            $this = $(this);
            options = $.extend({
                remote: $this.attr('data-remote') || $this.attr('href'),
                gallery_parent_selector: $this.attr('data-parent'),
                type: $this.attr('data-type')
            }, options, $this.data());
            new EkkoLightbox(this, options);
            return this;
        });
    };
    $.fn.ekkoLightbox.defaults = {
        gallery_parent_selector: '*:not(.row)',
        left_arrow_class: '.glyphicon .glyphicon-chevron-left',
        right_arrow_class: '.glyphicon .glyphicon-chevron-right',
        directional_arrows: true,
        type: null,
        always_show_close: true,
        onShow: function() {},
        onShown: function() {},
        onHide: function() {},
        onHidden: function() {},
        onNavigate: function() {},
        onContentLoaded: function() {}
    };
}).call(this);

if (typeof Object.create !== "function") {
    Object.create = function(e) {
        function t() {}
        t.prototype = e;
        return new t
    }
}
var ua = {
    toString: function() {
        return navigator.userAgent
    },
    test: function(e) {
        return this.toString().toLowerCase().indexOf(e.toLowerCase()) > -1
    }
};
ua.version = (ua.toString().toLowerCase().match(/[\s\S]+(?:rv|it|ra|ie)[\/: ]([\d.]+)/) || [])[1];
ua.webkit = ua.test("webkit");
ua.gecko = ua.test("gecko") && !ua.webkit;
ua.opera = ua.test("opera");
ua.ie = ua.test("msie") && !ua.opera;
ua.ie6 = ua.ie && document.compatMode && typeof document.documentElement.style.maxHeight === "undefined";
ua.ie7 = ua.ie && document.documentElement && typeof document.documentElement.style.maxHeight !== "undefined" && typeof XDomainRequest === "undefined";
ua.ie8 = ua.ie && typeof XDomainRequest !== "undefined";
var domReady = function() {
    var e = [];
    var t = function() {
        if (!arguments.callee.done) {
            arguments.callee.done = true;
            for (var t = 0; t < e.length; t++) {
                e[t]()
            }
        }
    };
    if (document.addEventListener) {
        document.addEventListener("DOMContentLoaded", t, false)
    }
    if (ua.ie) {
        (function() {
            try {
                document.documentElement.doScroll("left")
            } catch (e) {
                setTimeout(arguments.callee, 50);
                return
            }
            t()
        })();
        document.onreadystatechange = function() {
            if (document.readyState === "complete") {
                document.onreadystatechange = null;
                t()
            }
        }
    }
    if (ua.webkit && document.readyState) {
        (function() {
            if (document.readyState !== "loading") {
                t()
            } else {
                setTimeout(arguments.callee, 10)
            }
        })()
    }
    window.onload = t;
    return function(t) {
        if (typeof t === "function") {
            e[e.length] = t
        }
        return t
    }
}();
var cssHelper = function() {
    var e = {
        BLOCKS: /[^\s{;][^{;]*\{(?:[^{}]*\{[^{}]*\}[^{}]*|[^{}]*)*\}/g,
        BLOCKS_INSIDE: /[^\s{][^{]*\{[^{}]*\}/g,
        DECLARATIONS: /[a-zA-Z\-]+[^;]*:[^;]+;/g,
        RELATIVE_URLS: /url\(['"]?([^\/\)'"][^:\)'"]+)['"]?\)/g,
        REDUNDANT_COMPONENTS: /(?:\/\*([^*\\\\]|\*(?!\/))+\*\/|@import[^;]+;)/g,
        REDUNDANT_WHITESPACE: /\s*(,|:|;|\{|\})\s*/g,
        WHITESPACE_IN_PARENTHESES: /\(\s*(\S*)\s*\)/g,
        MORE_WHITESPACE: /\s{2,}/g,
        FINAL_SEMICOLONS: /;\}/g,
        NOT_WHITESPACE: /\S+/g
    };
    var t, n = false;
    var r = [];
    var s = function(e) {
        if (typeof e === "function") {
            r[r.length] = e
        }
    };
    var o = function() {
        for (var e = 0; e < r.length; e++) {
            r[e](t)
        }
    };
    var u = {};
    var a = function(e, t) {
        if (u[e]) {
            var n = u[e].listeners;
            if (n) {
                for (var r = 0; r < n.length; r++) {
                    n[r](t)
                }
            }
        }
    };
    var f = function(e, t, n) {
        if (ua.ie && !window.XMLHttpRequest) {
            window.XMLHttpRequest = function() {
                return new ActiveXObject("Microsoft.XMLHTTP")
            }
        }
        if (!XMLHttpRequest) {
            return ""
        }
        var r = new XMLHttpRequest;
        try {
            r.open("get", e, true);
            r.setRequestHeader("X_REQUESTED_WITH", "XMLHttpRequest")
        } catch (i) {
            n();
            return
        }
        var s = false;
        setTimeout(function() {
            s = true
        }, 5e3);
        document.documentElement.style.cursor = "progress";
        r.onreadystatechange = function() {
            if (r.readyState === 4 && !s) {
                if (!r.status && location.protocol === "file:" || r.status >= 200 && r.status < 300 || r.status === 304 || navigator.userAgent.indexOf("Safari") > -1 && typeof r.status === "undefined") {
                    t(r.responseText)
                } else {
                    n()
                }
                document.documentElement.style.cursor = "";
                r = null
            }
        };
        r.send("")
    };
    var l = function(t) {
        t = t.replace(e.REDUNDANT_COMPONENTS, "");
        t = t.replace(e.REDUNDANT_WHITESPACE, "$1");
        t = t.replace(e.WHITESPACE_IN_PARENTHESES, "($1)");
        t = t.replace(e.MORE_WHITESPACE, " ");
        t = t.replace(e.FINAL_SEMICOLONS, "}");
        return t
    };
    var c = {
        stylesheet: function(t) {
            var n = {};
            var r = [],
                i = [],
                s = [],
                o = [];
            var u = t.cssHelperText;
            var a = t.getAttribute("media");
            if (a) {
                var f = a.toLowerCase().split(",")
            } else {
                var f = ["all"]
            }
            for (var l = 0; l < f.length; l++) {
                r[r.length] = c.mediaQuery(f[l], n)
            }
            var h = u.match(e.BLOCKS);
            if (h !== null) {
                for (var l = 0; l < h.length; l++) {
                    if (h[l].substring(0, 7) === "@media ") {
                        var p = c.mediaQueryList(h[l], n);
                        s = s.concat(p.getRules());
                        i[i.length] = p
                    } else {
                        s[s.length] = o[o.length] = c.rule(h[l], n, null)
                    }
                }
            }
            n.element = t;
            n.getCssText = function() {
                return u
            };
            n.getAttrMediaQueries = function() {
                return r
            };
            n.getMediaQueryLists = function() {
                return i
            };
            n.getRules = function() {
                return s
            };
            n.getRulesWithoutMQ = function() {
                return o
            };
            return n
        },
        mediaQueryList: function(t, n) {
            var r = {};
            var i = t.indexOf("{");
            var s = t.substring(0, i);
            t = t.substring(i + 1, t.length - 1);
            var o = [],
                u = [];
            var a = s.toLowerCase().substring(7).split(",");
            for (var f = 0; f < a.length; f++) {
                o[o.length] = c.mediaQuery(a[f], r)
            }
            var l = t.match(e.BLOCKS_INSIDE);
            if (l !== null) {
                for (f = 0; f < l.length; f++) {
                    u[u.length] = c.rule(l[f], n, r)
                }
            }
            r.type = "mediaQueryList";
            r.getMediaQueries = function() {
                return o
            };
            r.getRules = function() {
                return u
            };
            r.getListText = function() {
                return s
            };
            r.getCssText = function() {
                return t
            };
            return r
        },
        mediaQuery: function(t, n) {
            t = t || "";
            var r, i;
            if (n.type === "mediaQueryList") {
                r = n
            } else {
                i = n
            }
            var s = false,
                o;
            var u = [];
            var a = true;
            var f = t.match(e.NOT_WHITESPACE);
            for (var l = 0; l < f.length; l++) {
                var c = f[l];
                if (!o && (c === "not" || c === "only")) {
                    if (c === "not") {
                        s = true
                    }
                } else if (!o) {
                    o = c
                } else if (c.charAt(0) === "(") {
                    var h = c.substring(1, c.length - 1).split(":");
                    u[u.length] = {
                        mediaFeature: h[0],
                        value: h[1] || null
                    }
                }
            }
            return {
                getQueryText: function() {
                    return t
                },
                getAttrStyleSheet: function() {
                    return i || null
                },
                getList: function() {
                    return r || null
                },
                getValid: function() {
                    return a
                },
                getNot: function() {
                    return s
                },
                getMediaType: function() {
                    return o
                },
                getExpressions: function() {
                    return u
                }
            }
        },
        rule: function(e, t, n) {
            var r = {};
            var i = e.indexOf("{");
            var s = e.substring(0, i);
            var o = s.split(",");
            var u = [];
            var a = e.substring(i + 1, e.length - 1).split(";");
            for (var f = 0; f < a.length; f++) {
                u[u.length] = c.declaration(a[f], r)
            }
            r.getStylesheet = function() {
                return t || null
            };
            r.getMediaQueryList = function() {
                return n || null
            };
            r.getSelectors = function() {
                return o
            };
            r.getSelectorText = function() {
                return s
            };
            r.getDeclarations = function() {
                return u
            };
            r.getPropertyValue = function(e) {
                for (var t = 0; t < u.length; t++) {
                    if (u[t].getProperty() === e) {
                        return u[t].getValue()
                    }
                }
                return null
            };
            return r
        },
        declaration: function(e, t) {
            var n = e.indexOf(":");
            var r = e.substring(0, n);
            var i = e.substring(n + 1);
            return {
                getRule: function() {
                    return t || null
                },
                getProperty: function() {
                    return r
                },
                getValue: function() {
                    return i
                }
            }
        }
    };
    var h = function(e) {
        if (typeof e.cssHelperText !== "string") {
            return
        }
        var n = {
            stylesheet: null,
            mediaQueryLists: [],
            rules: [],
            selectors: {},
            declarations: [],
            properties: {}
        };
        var r = n.stylesheet = c.stylesheet(e);
        var s = n.mediaQueryLists = r.getMediaQueryLists();
        var o = n.rules = r.getRules();
        var u = n.selectors;
        var a = function(e) {
            var t = e.getSelectors();
            for (var n = 0; n < t.length; n++) {
                var r = t[n];
                if (!u[r]) {
                    u[r] = []
                }
                u[r][u[r].length] = e
            }
        };
        for (i = 0; i < o.length; i++) {
            a(o[i])
        }
        var f = n.declarations;
        for (i = 0; i < o.length; i++) {
            f = n.declarations = f.concat(o[i].getDeclarations())
        }
        var l = n.properties;
        for (i = 0; i < f.length; i++) {
            var h = f[i].getProperty();
            if (!l[h]) {
                l[h] = []
            }
            l[h][l[h].length] = f[i]
        }
        e.cssHelperParsed = n;
        t[t.length] = e;
        return n
    };
    var p = function(e, t) {
        return;
        e.cssHelperText = l(t || e.innerHTML);
        return h(e)
    };
    var d = function() {
        n = true;
        t = [];
        var r = [];
        var i = function() {
            for (var e = 0; e < r.length; e++) {
                h(r[e])
            }
            var t = document.getElementsByTagName("style");
            for (e = 0; e < t.length; e++) {
                p(t[e])
            }
            n = false;
            o()
        };
        var s = document.getElementsByTagName("link");
        for (var u = 0; u < s.length; u++) {
            var a = s[u];
            if (a.getAttribute("rel").indexOf("style") > -1 && a.href && a.href.length !== 0 && !a.disabled) {
                r[r.length] = a
            }
        }
        if (r.length > 0) {
            var c = 0;
            var d = function() {
                c++;
                if (c === r.length) {
                    i()
                }
            };
            var v = function(t) {
                var n = t.href;
                f(n, function(r) {
                    r = l(r).replace(e.RELATIVE_URLS, "url(" + n.substring(0, n.lastIndexOf("/")) + "/$1)");
                    t.cssHelperText = r;
                    d()
                }, d)
            };
            for (u = 0; u < r.length; u++) {
                v(r[u])
            }
        } else {
            i()
        }
    };
    var v = {
        stylesheets: "array",
        mediaQueryLists: "array",
        rules: "array",
        selectors: "object",
        declarations: "array",
        properties: "object"
    };
    var m = {
        stylesheets: null,
        mediaQueryLists: null,
        rules: null,
        selectors: null,
        declarations: null,
        properties: null
    };
    var g = function(e, t) {
        if (m[e] !== null) {
            if (v[e] === "array") {
                return m[e] = m[e].concat(t)
            } else {
                var n = m[e];
                for (var r in t) {
                    if (t.hasOwnProperty(r)) {
                        if (!n[r]) {
                            n[r] = t[r]
                        } else {
                            n[r] = n[r].concat(t[r])
                        }
                    }
                }
                return n
            }
        }
    };
    var y = function(e) {
        m[e] = v[e] === "array" ? [] : {};
        for (var n = 0; n < t.length; n++) {
            var r = e === "stylesheets" ? "stylesheet" : e;
            g(e, t[n].cssHelperParsed[r])
        }
        return m[e]
    };
    var b = function(e) {
        if (typeof window.innerWidth != "undefined") {
            return window["inner" + e]
        } else if (typeof document.documentElement !== "undefined" && typeof document.documentElement.clientWidth !== "undefined" && document.documentElement.clientWidth != 0) {
            return document.documentElement["client" + e]
        }
    };
    return {
        addStyle: function(e, t, n) {
            var r = document.createElement("style");
            r.setAttribute("type", "text/css");
            if (t && t.length > 0) {
                r.setAttribute("media", t.join(","))
            }
            document.getElementsByTagName("head")[0].appendChild(r);
            if (r.styleSheet) {
                r.styleSheet.cssText = e
            } else {
                r.appendChild(document.createTextNode(e))
            }
            r.addedWithCssHelper = true;
            if (typeof n === "undefined" || n === true) {
                cssHelper.parsed(function(t) {
                    var n = p(r, e);
                    for (var i in n) {
                        if (n.hasOwnProperty(i)) {
                            g(i, n[i])
                        }
                    }
                    a("newStyleParsed", r)
                })
            } else {
                r.parsingDisallowed = true
            }
            return r
        },
        removeStyle: function(e) {
            return e.parentNode.removeChild(e)
        },
        parsed: function(e) {
            if (n) {
                s(e)
            } else {
                if (typeof t !== "undefined") {
                    if (typeof e === "function") {
                        e(t)
                    }
                } else {
                    s(e);
                    d()
                }
            }
        },
        stylesheets: function(e) {
            cssHelper.parsed(function(t) {
                e(m.stylesheets || y("stylesheets"))
            })
        },
        mediaQueryLists: function(e) {
            cssHelper.parsed(function(t) {
                e(m.mediaQueryLists || y("mediaQueryLists"))
            })
        },
        rules: function(e) {
            cssHelper.parsed(function(t) {
                e(m.rules || y("rules"))
            })
        },
        selectors: function(e) {
            cssHelper.parsed(function(t) {
                e(m.selectors || y("selectors"))
            })
        },
        declarations: function(e) {
            cssHelper.parsed(function(t) {
                e(m.declarations || y("declarations"))
            })
        },
        properties: function(e) {
            cssHelper.parsed(function(t) {
                e(m.properties || y("properties"))
            })
        },
        broadcast: a,
        addListener: function(e, t) {
            if (typeof t === "function") {
                if (!u[e]) {
                    u[e] = {
                        listeners: []
                    }
                }
                u[e].listeners[u[e].listeners.length] = t
            }
        },
        removeListener: function(e, t) {
            if (typeof t === "function" && u[e]) {
                var n = u[e].listeners;
                for (var r = 0; r < n.length; r++) {
                    if (n[r] === t) {
                        n.splice(r, 1);
                        r -= 1
                    }
                }
            }
        },
        getViewportWidth: function() {
            return b("Width")
        },
        getViewportHeight: function() {
            return b("Height")
        }
    }
}();
domReady(function() {
    var t;
    var n = {
        LENGTH_UNIT: /[0-9]+(em|ex|px|in|cm|mm|pt|pc)$/,
        RESOLUTION_UNIT: /[0-9]+(dpi|dpcm)$/,
        ASPECT_RATIO: /^[0-9]+\/[0-9]+$/,
        ABSOLUTE_VALUE: /^[0-9]*(\.[0-9]+)*$/
    };
    var r = [];
    var i = function() {
        var e = "css3-mediaqueries-test";
        var t = document.createElement("div");
        t.id = e;
        var n = cssHelper.addStyle("@media all and (width) { #" + e + " { width: 1px !important; } }", [], false);
        document.body.appendChild(t);
        var r = t.offsetWidth === 1;
        n.parentNode.removeChild(n);
        t.parentNode.removeChild(t);
        i = function() {
            return r
        };
        return r
    };
    var s = function() {
        t = document.createElement("div");
        t.style.cssText = "position:absolute;top:-9999em;left:-9999em;" + "margin:0;border:none;padding:0;width:1em;font-size:1em;";
        document.body.appendChild(t);
        if (t.offsetWidth !== 16) {
            t.style.fontSize = 16 / t.offsetWidth + "em"
        }
        t.style.width = ""
    };
    var o = function(e) {
        t.style.width = e;
        var n = t.offsetWidth;
        t.style.width = "";
        return n
    };
    var u = function(e, t) {
        var r = e.length;
        var i = e.substring(0, 4) === "min-";
        var s = !i && e.substring(0, 4) === "max-";
        if (t !== null) {
            var u;
            var a;
            if (n.LENGTH_UNIT.exec(t)) {
                u = "length";
                a = o(t)
            } else if (n.RESOLUTION_UNIT.exec(t)) {
                u = "resolution";
                a = parseInt(t, 10);
                var f = t.substring((a + "").length)
            } else if (n.ASPECT_RATIO.exec(t)) {
                u = "aspect-ratio";
                a = t.split("/")
            } else if (n.ABSOLUTE_VALUE) {
                u = "absolute";
                a = t
            } else {
                u = "unknown"
            }
        }
        var l, c;
        if ("device-width" === e.substring(r - 12, r)) {
            l = screen.width;
            if (t !== null) {
                if (u === "length") {
                    return i && l >= a || s && l < a || !i && !s && l === a
                } else {
                    return false
                }
            } else {
                return l > 0
            }
        } else if ("device-height" === e.substring(r - 13, r)) {
            c = screen.height;
            if (t !== null) {
                if (u === "length") {
                    return i && c >= a || s && c < a || !i && !s && c === a
                } else {
                    return false
                }
            } else {
                return c > 0
            }
        } else if ("width" === e.substring(r - 5, r)) {
            l = document.documentElement.clientWidth || document.body.clientWidth;
            if (t !== null) {
                if (u === "length") {
                    return i && l >= a || s && l < a || !i && !s && l === a
                } else {
                    return false
                }
            } else {
                return l > 0
            }
        } else if ("height" === e.substring(r - 6, r)) {
            c = document.documentElement.clientHeight || document.body.clientHeight;
            if (t !== null) {
                if (u === "length") {
                    return i && c >= a || s && c < a || !i && !s && c === a
                } else {
                    return false
                }
            } else {
                return c > 0
            }
        } else if ("device-aspect-ratio" === e.substring(r - 19, r)) {
            return u === "aspect-ratio" && screen.width * a[1] === screen.height * a[0]
        } else if ("color-index" === e.substring(r - 11, r)) {
            var h = Math.pow(2, screen.colorDepth);
            if (t !== null) {
                if (u === "absolute") {
                    return i && h >= a || s && h < a || !i && !s && h === a
                } else {
                    return false
                }
            } else {
                return h > 0
            }
        } else if ("color" === e.substring(r - 5, r)) {
            var p = screen.colorDepth;
            if (t !== null) {
                if (u === "absolute") {
                    return i && p >= a || s && p < a || !i && !s && p === a
                } else {
                    return false
                }
            } else {
                return p > 0
            }
        } else if ("resolution" === e.substring(r - 10, r)) {
            var d;
            if (f === "dpcm") {
                d = o("1cm")
            } else {
                d = o("1in")
            }
            if (t !== null) {
                if (u === "resolution") {
                    return i && d >= a || s && d < a || !i && !s && d === a
                } else {
                    return false
                }
            } else {
                return d > 0
            }
        } else {
            return false
        }
    };
    var a = function(e) {
        var t = e.getValid();
        var n = e.getExpressions();
        var r = n.length;
        if (r > 0) {
            for (var i = 0; i < r && t; i++) {
                t = u(n[i].mediaFeature, n[i].value)
            }
            var s = e.getNot();
            return t && !s || s && !t
        }
        return t
    };
    var f = function(e, t) {
        var n = e.getMediaQueries();
        var i = {};
        for (var s = 0; s < n.length; s++) {
            var o = n[s].getMediaType();
            if (n[s].getExpressions().length === 0) {
                continue
            }
            var u = true;
            if (o !== "all" && t && t.length > 0) {
                u = false;
                for (var f = 0; f < t.length; f++) {
                    if (t[f] === o) {
                        u = true
                    }
                }
            }
            if (u && a(n[s])) {
                i[o] = true
            }
        }
        var l = [],
            c = 0;
        for (var h in i) {
            if (i.hasOwnProperty(h)) {
                if (c > 0) {
                    l[c++] = ","
                }
                l[c++] = h
            }
        }
        if (l.length > 0) {
            r[r.length] = cssHelper.addStyle("@media " + l.join("") + "{" + e.getCssText() + "}", t, false)
        }
    };
    var l = function(e, t) {
        for (var n = 0; n < e.length; n++) {
            f(e[n], t)
        }
    };
    var c = function(e) {
        var t = e.getAttrMediaQueries();
        var n = false;
        var i = {};
        for (var s = 0; s < t.length; s++) {
            if (a(t[s])) {
                i[t[s].getMediaType()] = t[s].getExpressions().length > 0
            }
        }
        var o = [],
            u = [];
        for (var f in i) {
            if (i.hasOwnProperty(f)) {
                o[o.length] = f;
                if (i[f]) {
                    u[u.length] = f
                }
                if (f === "all") {
                    n = true
                }
            }
        }
        if (u.length > 0) {
            r[r.length] = cssHelper.addStyle(e.getCssText(), u, false)
        }
        var c = e.getMediaQueryLists();
        if (n) {
            l(c)
        } else {
            l(c, o)
        }
    };
    var h = function(e) {
        for (var t = 0; t < e.length; t++) {
            c(e[t])
        }
        if (ua.ie) {
            document.documentElement.style.display = "block";
            setTimeout(function() {
                document.documentElement.style.display = ""
            }, 0);
            setTimeout(function() {
                cssHelper.broadcast("cssMediaQueriesTested")
            }, 100)
        } else {
            cssHelper.broadcast("cssMediaQueriesTested")
        }
    };
    var p = function() {
        for (var e = 0; e < r.length; e++) {
            cssHelper.removeStyle(r[e])
        }
        r = [];
        cssHelper.stylesheets(h)
    };
    var d = 0;
    var v = function() {
        var e = cssHelper.getViewportWidth();
        var t = cssHelper.getViewportHeight();
        if (ua.ie) {
            var n = document.createElement("div");
            n.style.position = "absolute";
            n.style.top = "-9999em";
            n.style.overflow = "scroll";
            document.body.appendChild(n);
            d = n.offsetWidth - n.clientWidth;
            document.body.removeChild(n)
        }
        var r;
        var s = function() {
            var n = cssHelper.getViewportWidth();
            var s = cssHelper.getViewportHeight();
            if (Math.abs(n - e) > d || Math.abs(s - t) > d) {
                e = n;
                t = s;
                clearTimeout(r);
                r = setTimeout(function() {
                    if (!i()) {
                        p()
                    } else {
                        cssHelper.broadcast("cssMediaQueriesTested")
                    }
                }, 500)
            }
        };
        window.onresize = function() {
            var e = window.onresize || function() {};
            return function() {
                e();
                s()
            }
        }()
    };
    var m = document.documentElement;
    m.style.marginLeft = "-32767px";
    setTimeout(function() {
        m.style.marginLeft = ""
    }, 5e3);
    return function() {
        if (!i()) {
            cssHelper.addListener("newStyleParsed", function(e) {
                c(e.cssHelperParsed.stylesheet)
            });
            cssHelper.addListener("cssMediaQueriesTested", function() {
                if (ua.ie) {
                    m.style.width = "1px"
                }
                setTimeout(function() {
                    m.style.width = "";
                    m.style.marginLeft = ""
                }, 0);
                cssHelper.removeListener("cssMediaQueriesTested", arguments.callee)
            });
            s();
            p()
        } else {
            m.style.marginLeft = ""
        }
        v()
    }
}());
try {
    document.execCommand("BackgroundImageCache", false, true)
} catch (e) {};

(function(l, f) {
    function m() {
        var a = e.elements;
        return "string" == typeof a ? a.split(" ") : a
    }

    function i(a) {
        var b = n[a[o]];
        b || (b = {}, h++, a[o] = h, n[h] = b);
        return b
    }

    function p(a, b, c) {
        b || (b = f);
        if (g) return b.createElement(a);
        c || (c = i(b));
        b = c.cache[a] ? c.cache[a].cloneNode() : r.test(a) ? (c.cache[a] = c.createElem(a)).cloneNode() : c.createElem(a);
        return b.canHaveChildren && !s.test(a) ? c.frag.appendChild(b) : b
    }

    function t(a, b) {
        if (!b.cache) b.cache = {}, b.createElem = a.createElement, b.createFrag = a.createDocumentFragment, b.frag = b.createFrag();
        a.createElement = function(c) {
            return !e.shivMethods ? b.createElem(c) : p(c, a, b)
        };
        a.createDocumentFragment = Function("h,f", "return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&(" + m().join().replace(/[\w\-]+/g, function(a) {
            b.createElem(a);
            b.frag.createElement(a);
            return 'c("' + a + '")'
        }) + ");return n}")(e, b.frag)
    }

    function q(a) {
        a || (a = f);
        var b = i(a);
        if (e.shivCSS && !j && !b.hasCSS) {
            var c, d = a;
            c = d.createElement("p");
            d = d.getElementsByTagName("head")[0] || d.documentElement;
            c.innerHTML = "x<style>article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}mark{background:#FF0;color:#000}template{display:none}</style>";
            c = d.insertBefore(c.lastChild, d.firstChild);
            b.hasCSS = !!c
        }
        g || t(a, b);
        return a
    }
    var k = l.html5 || {},
        s = /^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,
        r = /^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,
        j, o = "_html5shiv",
        h = 0,
        n = {},
        g;
    (function() {
        try {
            var a = f.createElement("a");
            a.innerHTML = "<xyz></xyz>";
            j = "hidden" in a;
            var b;
            if (!(b = 1 == a.childNodes.length)) {
                f.createElement("a");
                var c = f.createDocumentFragment();
                b = "undefined" == typeof c.cloneNode || "undefined" == typeof c.createDocumentFragment || "undefined" == typeof c.createElement
            }
            g = b
        } catch (d) {
            g = j = !0
        }
    })();
    var e = {
        elements: k.elements || "abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video",
        version: "3.7.0",
        shivCSS: !1 !== k.shivCSS,
        supportsUnknownElements: g,
        shivMethods: !1 !== k.shivMethods,
        type: "default",
        shivDocument: q,
        createElement: p,
        createDocumentFragment: function(a, b) {
            a || (a = f);
            if (g) return a.createDocumentFragment();
            for (var b = b || i(a), c = b.frag.cloneNode(), d = 0, e = m(), h = e.length; d < h; d++) c.createElement(e[d]);
            return c
        }
    };
    l.html5 = e;
    q(f)
})(this, document);
/*! Respond.js v1.4.2: min/max-width media query polyfill * Copyright 2013 Scott Jehl
 * Licensed under https://github.com/scottjehl/Respond/blob/master/LICENSE-MIT
 *  */

! function(a) {
    "use strict";
    a.matchMedia = a.matchMedia || function(a) {
        var b, c = a.documentElement,
            d = c.firstElementChild || c.firstChild,
            e = a.createElement("body"),
            f = a.createElement("div");
        return f.id = "mq-test-1", f.style.cssText = "position:absolute;top:-100em", e.style.background = "none", e.appendChild(f),
            function(a) {
                return f.innerHTML = '&shy;<style media="' + a + '"> #mq-test-1 { width: 42px; }</style>', c.insertBefore(e, d), b = 42 === f.offsetWidth, c.removeChild(e), {
                    matches: b,
                    media: a
                }
            }
    }(a.document)
}(this),
function(a) {
    "use strict";

    function b() {
        u(!0)
    }
    var c = {};
    a.respond = c, c.update = function() {};
    var d = [],
        e = function() {
            var b = !1;
            try {
                b = new a.XMLHttpRequest
            } catch (c) {
                b = new a.ActiveXObject("Microsoft.XMLHTTP")
            }
            return function() {
                return b
            }
        }(),
        f = function(a, b) {
            var c = e();
            c && (c.open("GET", a, !0), c.onreadystatechange = function() {
                4 !== c.readyState || 200 !== c.status && 304 !== c.status || b(c.responseText)
            }, 4 !== c.readyState && c.send(null))
        };
    if (c.ajax = f, c.queue = d, c.regex = {
            media: /@media[^\{]+\{([^\{\}]*\{[^\}\{]*\})+/gi,
            keyframes: /@(?:\-(?:o|moz|webkit)\-)?keyframes[^\{]+\{(?:[^\{\}]*\{[^\}\{]*\})+[^\}]*\}/gi,
            urls: /(url\()['"]?([^\/\)'"][^:\)'"]+)['"]?(\))/g,
            findStyles: /@media *([^\{]+)\{([\S\s]+?)$/,
            only: /(only\s+)?([a-zA-Z]+)\s?/,
            minw: /\([\s]*min\-width\s*:[\s]*([\s]*[0-9\.]+)(px|em)[\s]*\)/,
            maxw: /\([\s]*max\-width\s*:[\s]*([\s]*[0-9\.]+)(px|em)[\s]*\)/
        }, c.mediaQueriesSupported = a.matchMedia && null !== a.matchMedia("only all") && a.matchMedia("only all").matches, !c.mediaQueriesSupported) {
        var g, h, i, j = a.document,
            k = j.documentElement,
            l = [],
            m = [],
            n = [],
            o = {},
            p = 30,
            q = j.getElementsByTagName("head")[0] || k,
            r = j.getElementsByTagName("base")[0],
            s = q.getElementsByTagName("link"),
            t = function() {
                var a, b = j.createElement("div"),
                    c = j.body,
                    d = k.style.fontSize,
                    e = c && c.style.fontSize,
                    f = !1;
                return b.style.cssText = "position:absolute;font-size:1em;width:1em", c || (c = f = j.createElement("body"), c.style.background = "none"), k.style.fontSize = "100%", c.style.fontSize = "100%", c.appendChild(b), f && k.insertBefore(c, k.firstChild), a = b.offsetWidth, f ? k.removeChild(c) : c.removeChild(b), k.style.fontSize = d, e && (c.style.fontSize = e), a = i = parseFloat(a)
            },
            u = function(b) {
                var c = "clientWidth",
                    d = k[c],
                    e = "CSS1Compat" === j.compatMode && d || j.body[c] || d,
                    f = {},
                    o = s[s.length - 1],
                    r = (new Date).getTime();
                if (b && g && p > r - g) return a.clearTimeout(h), h = a.setTimeout(u, p), void 0;
                g = r;
                for (var v in l)
                    if (l.hasOwnProperty(v)) {
                        var w = l[v],
                            x = w.minw,
                            y = w.maxw,
                            z = null === x,
                            A = null === y,
                            B = "em";
                        x && (x = parseFloat(x) * (x.indexOf(B) > -1 ? i || t() : 1)), y && (y = parseFloat(y) * (y.indexOf(B) > -1 ? i || t() : 1)), w.hasquery && (z && A || !(z || e >= x) || !(A || y >= e)) || (f[w.media] || (f[w.media] = []), f[w.media].push(m[w.rules]))
                    }
                for (var C in n) n.hasOwnProperty(C) && n[C] && n[C].parentNode === q && q.removeChild(n[C]);
                n.length = 0;
                for (var D in f)
                    if (f.hasOwnProperty(D)) {
                        var E = j.createElement("style"),
                            F = f[D].join("\n");
                        E.type = "text/css", E.media = D, q.insertBefore(E, o.nextSibling), E.styleSheet ? E.styleSheet.cssText = F : E.appendChild(j.createTextNode(F)), n.push(E)
                    }
            },
            v = function(a, b, d) {
                var e = a.replace(c.regex.keyframes, "").match(c.regex.media),
                    f = e && e.length || 0;
                b = b.substring(0, b.lastIndexOf("/"));
                var g = function(a) {
                        return a.replace(c.regex.urls, "$1" + b + "$2$3")
                    },
                    h = !f && d;
                b.length && (b += "/"), h && (f = 1);
                for (var i = 0; f > i; i++) {
                    var j, k, n, o;
                    h ? (j = d, m.push(g(a))) : (j = e[i].match(c.regex.findStyles) && RegExp.$1, m.push(RegExp.$2 && g(RegExp.$2))), n = j.split(","), o = n.length;
                    for (var p = 0; o > p; p++) k = n[p], l.push({
                        media: k.split("(")[0].match(c.regex.only) && RegExp.$2 || "all",
                        rules: m.length - 1,
                        hasquery: k.indexOf("(") > -1,
                        minw: k.match(c.regex.minw) && parseFloat(RegExp.$1) + (RegExp.$2 || ""),
                        maxw: k.match(c.regex.maxw) && parseFloat(RegExp.$1) + (RegExp.$2 || "")
                    })
                }
                u()
            },
            w = function() {
                if (d.length) {
                    var b = d.shift();
                    f(b.href, function(c) {
                        v(c, b.href, b.media), o[b.href] = !0, a.setTimeout(function() {
                            w()
                        }, 0)
                    })
                }
            },
            x = function() {
                for (var b = 0; b < s.length; b++) {
                    var c = s[b],
                        e = c.href,
                        f = c.media,
                        g = c.rel && "stylesheet" === c.rel.toLowerCase();
                    e && g && !o[e] && (c.styleSheet && c.styleSheet.rawCssText ? (v(c.styleSheet.rawCssText, e, f), o[e] = !0) : (!/^([a-zA-Z:]*\/\/)/.test(e) && !r || e.replace(RegExp.$1, "").split("/")[0] === a.location.host) && ("//" === e.substring(0, 2) && (e = a.location.protocol + e), d.push({
                        href: e,
                        media: f
                    })))
                }
                w()
            };
        x(), c.update = x, c.getEmValue = t, a.addEventListener ? a.addEventListener("resize", b, !1) : a.attachEvent && a.attachEvent("onresize", b)
    }
}(this);

function QuerySuggest(textbox, settings) {
    this.settings = jQuery.extend(this.defaultSettings(), settings);
    this.textBoxId = $(textbox).attr('id');
    this.suggestId = this.textBoxId + "_querySuggest";
    this.queryExecutions = {};
    this.emptyExecution = null;
    this.queryTexts = [];
    this.delayTimer = 0;
    this.clearTimer = 0;
    this.autoHide = true;
    this.pendingQuery = null;
    this.anotherPending = null;
}
jQuery.fn.querySuggest = function(settings) {
    return this.each(function(i, textbox) {
        var querySuggest = new QuerySuggest(textbox, settings);
        $(textbox).focus(function(e) {
            return querySuggest.enableSuggest(e);
        });
        $(textbox).blur(function(e) {
            return querySuggest.disableSuggest(e);
        });
        $(textbox).keyup(function(e) {
            return querySuggest.digestInput(e);
        });
        $(textbox).bind('paste', function(e) {
            setTimeout(function() {
                return querySuggest.digestInput();
            }, 30);
        });
        $(textbox).after('<div id="' + querySuggest.suggestId + '" class="' + querySuggest.settings.cssClass + '" ' + 'style="display:none;">' + '</div>');
        $('#' + querySuggest.suggestId).click(function(e) {
            querySuggest.autoHide = false;
            querySuggest.manualClose();
        });
        textbox.querySuggest = querySuggest;
    });
};
jQuery.fn.getQuerySuggest = function() {
    if (this.length == 0) {
        return null;
    }
    var textbox = this[0];
    return textbox.querySuggest;
};
QuerySuggest.prototype.defaultSettings = function() {
    return {
        width: 600,
        cssClass: 'querySuggest',
        delay: 800,
        align: 'center',
        cacheSize: 10,
        minQuerySize: 1,
        maxQuerySize: 500,
        condensed: false,
        initQuery: true,
        limit: 6,
        present: function(querySuggest, suggestId, suggestions, query) {
            QuerySuggest.prototype.defaultPresent(querySuggest, suggestId, suggestions, query);
        },
        empty: function(querySuggest, suggestId) {
            QuerySuggest.prototype.defaultEmpty(querySuggest, suggestId);
        },
        queryUrl: function(query, querySuggest) {
            return "";
        }
    };
};
QuerySuggest.prototype.enableSuggest = function() {
    this.autoHide = true;
    this.querySuggestions();
};
QuerySuggest.prototype.disableSuggest = function() {
    var sid = this.suggestId;
    var querySuggest = this;
    setTimeout(function() {
        if (querySuggest.autoHide) {
            $('#' + sid).hide();
        }
    }, 200);
};
QuerySuggest.prototype.manualClose = function() {
    if (!$('#suggestClose_' + this.suggestId).html()) {
        $('#' + this.suggestId).append("<div class='Close_SearchSuggestionWindow' id='suggestClose_" + this.suggestId + "'>" + "<a href='#' onclick='$(\"#" + this.suggestId + "\").hide();return false;'>close <span class='glyphicon glyphicon-remove'></span></a>" + "</div>");
    }
};
QuerySuggest.prototype.digestInput = function() {
    var input = $('#' + this.textBoxId).val();
    var qs = this;
    if (this.clearTimer === 0) {
        this.clearTimer = setTimeout(function() {
            qs.emptySuggestions();
        }, this.settings.delay * 1.2);
    }
    if (this.delayTimer !== 0) {
        clearTimeout(this.delayTimer);
        this.delayTimer = 0;
    }
    if (!input || (input.length < this.settings.minQuerySize) || (input.length > this.settings.maxQuerySize)) {
        $('#' + this.suggestId).hide();
        return;
    }
    this.delayTimer = setTimeout(function() {
        qs.querySuggestions();
    }, this.settings.delay);
};
QuerySuggest.prototype.emptySuggestions = function() {
    this.clearTimer = 0;
    if (this.delayTimer !== 0) {
        return;
    }
    this.settings.empty(this, this.suggestId);
};
QuerySuggest.prototype.querySuggestions = function() {
    this.delayTimer = 0;
    var input = $('#' + this.textBoxId).val();
    if (input.length < this.settings.minQuerySize) {
        input = "";
    }
    if (!this.settings.initQuery && (input.length < this.settings.minQuerySize)) {
        $('#' + this.suggestId).hide();
        return;
    }
    if (this.pendingQuery) {
        if (!this.anotherPending || new Date().getTime() - this.anotherPending > 2000) {
            this.anotherPending = new Date().getTime();
            return;
        }
    }
    this.anotherPending = null;
    this.pendingQuery = input;
    this.pendingUrl = this.settings.queryUrl(this.pendingQuery, this);
    if (this.pendingUrl == null) {
        this.pendingQuery = null;
        $('#' + this.suggestId).hide();
        return;
    }
    var cachedSuggestions = this.queryExecutions[this.pendingUrl];
    if (!this.pendingQuery) {
        cachedSuggestions = this.emptyExecution;
    }
    if (cachedSuggestions !== undefined && cachedSuggestions !== null) {
        this.giveSuggestions(cachedSuggestions);
    } else {
        this.requestSuggestions();
    }
};
QuerySuggest.prototype.requestSuggestions = function() {
    var qs = this;
    var qr = this.pendingQuery;
    var url = this.pendingUrl;
    $.getJSON(this.pendingUrl, function(data) {
        qs.pendingQuery = qr;
        qs.pendingUrl = url;
        qs.giveSuggestions(data);
        if (qs.anotherPending) {
            qs.querySuggestions();
        }
    });
};
QuerySuggest.prototype.giveSuggestions = function(suggestions) {
    if (suggestions !== undefined && suggestions != null) {
        this.cacheSuggestions(this.pendingQuery, this.pendingUrl, suggestions);
    }
    var qr = this.pendingQuery;
    this.pendingQuery = null;
    this.pendingUrl = null;
    if (this.clearTimer !== 0) {
        clearTimeout(this.clearTimer);
        this.clearTimer = 0;
    }
    if (qr == $('#' + this.textBoxId).val()) {
        this.settings.present(this, this.suggestId, suggestions, qr);
        if (suggestions && suggestions.length) {
            $('#' + this.suggestId).show();
        } else {
            $('#' + this.suggestId).hide();
        }
    } else {
        $('#' + this.suggestId).hide();
    }
};
QuerySuggest.prototype.cacheSuggestions = function(queryText, queryUrl, suggestions) {
    if (!queryText) {
        this.emptyExecution = suggestions;
        return;
    }
    if (this.queryExecutions[queryUrl]) {
        var index = 0;
        for (index = 0; index < this.queryTexts.length; index++) {
            if (this.queryTexts[index] === queryUrl) {
                break;
            }
        }
        if (index !== this.queryTexts.length) {
            this.queryTexts.splice(index, 1);
        }
    }
    if (this.queryTexts.length > this.settings.cacheSize) {
        this.queryExecutions[this.queryTexts[0]] = null;
        this.queryTexts.splice(0, 1);
    }
    this.queryTexts.push(queryUrl);
    this.queryExecutions[queryUrl] = suggestions;
};
QuerySuggest.prototype.defaultEmpty = function(querySuggest, suggestId) {
    if (querySuggest.settings.initQuery) {
        if (querySuggest.emptyExecution) {
            querySuggest.settings.present(querySuggest, suggestId, querySuggest.emptyExecution, "");
        } else {
            querySuggest.querySuggestions();
        }
    } else {
        $('#' + suggestId).html("");
    }
};
QuerySuggest.prototype.defaultPresent = function(querySuggest, suggestId, suggestions, query) {
    var html = "";
    var i = 0,
        j = 0;
    if (suggestions) {
        for (i = 0; i < suggestions.length; i++) {
            var suggestion = suggestions[i];
            html += "<div>" + suggestion.name + "<ul>";
            for (j = 0; j < suggestion.matches.length; j++) {
                var match = suggestion.matches[j];
                html += "<li><a href='" + match.url + "'>" + match.label + "</a>";
            }
            html += "</ul></div>";
        }
        $('#' + suggestId).html(html);
    } else {
        querySuggest.settings.empty(querySuggest, suggestId);
    }
};

triggeredSubmit = false;

function markQuery(lbl, query) {
    var lbli = lbl.toLowerCase().indexOf(query.toLowerCase());
    if (lbli !== -1 && query != "b") {
        return lbl.substr(0, lbli) + "<b>" + lbl.substr(lbli, query.length) + "</b>" + lbl.substr(lbli + query.length);
    }
    var words = query.replace(/-/g, " ").split(" ");
    var i;
    if (words.length > 1) {
        for (i = 0; i < words.length; i++) {
            lbl = markQuery(lbl, words[i]);
        }
    }
    return lbl;
}

function focusSuggest(textBoxId, itemId) {
    var querySuggest = $('#' + textBoxId).getQuerySuggest();
    querySuggest.itemId = itemId;
    querySuggest.settings.limit = 47;
    querySuggest.querySuggestions();
}

function reSuggest(textBoxId) {
    var querySuggest = $('#' + textBoxId).getQuerySuggest();
    querySuggest.querySuggestions();
}

function presentSuggestionsInSearchBar(querySuggest, suggestId, suggestions, query) {
    var drillHTML = "",
        optsHTML = "";
    var gci = 0,
        pc = 0,
        cn = 0,
        ccn;
    var vls = "",
        lbls = "";
    var contextLbl = ContextLabels[suggestId.replace("_querySuggest", "")];
    var contextLabel = contextLbl ? contextLbl : suggestId;
    var browseClass = {
        'Author': 'authorProfileIcon'
    };
    if (!querySuggest.popupCounter) {
        querySuggest.popupCounter = 0;
    }
    querySuggest.popupCounter++;
    $('#tiptip_holder').hide();
    $.each(suggestions, function(i, item) {
        if (item.suggestions.length <= 0) {
            return true;
        }
        vls = "";
        lbls = "";
        optsHTML = "";
        gci = 0;
        ccn = 0;
        $.each(item.suggestions, function(j, group) {
            pc = Math.round(1000 * group.percent) / 10;
            if (!group.abbreviation) {
                group.abbreviation = group.label;
            }
            var lbl = markQuery(group.label, query);
            var abv = markQuery(group.abbreviation, query);
            var tooltip = (group.label !== group.abbreviation ? lbl.replace(/'/g, "&#39;") : null);
            if (group.percent) {
                tooltip = pc + "% " + lbl + " (" + group.population + " hits)";
            }
            var evt = ((group.url.indexOf("?") == -1) ? "?" : "&") + "evtc=Suggest&evta=" + item.name.replace(" ", "") + "&evtl=" + contextLabel;
            if (tooltip) {
                var titleTooltip = tooltip.replace("<b>", "")
                titleTooltip = titleTooltip.replace("</b>", "")
            }
            optsHTML += "<li " + (tooltip ? ("title='" + titleTooltip + "'") : "") + " class='querySuggestGroup" + (tooltip ? " mantooltip" : "") + (!group.isEnabled ? " suggestNotFocus" : "") + "' style='white-space:nowrap;'>";
            optsHTML += "<a class='groupLabel' id='drill_" + i + "_" + (pc > 0 ? (gci + "") : (j + "_n")) + "return true;' " + "href='" + group.url + evt + "' onclick=''>";
            optsHTML += abv;
            optsHTML += (group.population ? " (" + group.population + ")" : "");
            optsHTML += (group.url ? "</a>" : "");
            if (group.redirectUrl) {
                var iconClass = "icon-taxonomy";
                if (browseClass[item.id]) {
                    iconClass = browseClass[item.id];
                } else
                    optsHTML += "<a href='" + group.redirectUrl + "'>&nbsp;<i class='fa fa-sitemap'></i></a>";
            }
            optsHTML += "</li>";
            vls += (gci > 0 ? "," : "") + pc;
            var slbl = group.abbreviation;
            if (slbl.length > 35) {
                slbl = slbl.substring(0, 32) + "...";
            }
            lbls += (gci > 0 ? "|" : "") + pc + "% " + slbl + " (" + group.population + " hits)";
            gci++;
            if (gci % 12 == 0)
                optsHTML += "</ul><ul>";
            ccn++;
        });
        if (ccn > cn) {
            cn = ccn;
        }
        if (cn > 12) {
            cn = 12;
        }
        var sgname = item.name;
        drillHTML += "<div class='suggestgroup'><h5>" + sgname + "</h5>";
        drillHTML += "<ul>";
        drillHTML += optsHTML;
        if (item.allUrl || item.moreResults || querySuggest.itemId) {
            drillHTML += "<li class='querySuggestAll' >";
            var leftHTML = "",
                rightHTML = "";
            if (item.moreResults && !querySuggest.itemId)
                leftHTML += "<a style='float:left' href='#' onclick='focusSuggest(\"" + querySuggest.textBoxId + "\",\"" + item.id + "\");" + "return false;'>More</a>";
            if (querySuggest.itemId)
                leftHTML += "<a style='float:left' href='#' onclick='reSuggest(\"" + querySuggest.textBoxId + "\");return false;'>Less</a>";
            if (item.allUrl && (item.name.indexOf("Author") == -1)) {
                var evt = ((item.allUrl.indexOf("?") == -1) ? "?" : "&") + "evtc=Suggest&evta=" + item.name.replace(" ", "") + "All&evtl=" + contextLabel;
                rightHTML += "<a href='" + item.allUrl + evt + "return true;'>Find all</a>";
            }
            if (item.moreResults && querySuggest.itemId && !item.allUrl)
                rightHTML += "<span>Too many matches</span>";
            drillHTML += leftHTML + (leftHTML && rightHTML ? "<span style='float:left'>&nbsp;&nbsp;-&nbsp;&nbsp;</span>" : "") + rightHTML;
            drillHTML += "</li>";
        }
        drillHTML += "</ul>";
        drillHTML += "</div>";
    });
    drillHTML += "<div class='clearHide'>&nbsp</div>";
    $('#' + suggestId).html(drillHTML);
    querySuggest.itemId = null;
    querySuggest.settings.limit = 6;
    if (querySuggest.settings.condensed == false) {
        $("#" + suggestId + " .suggestgroup").css('min-height', (cn * 10) + 130 + "px");
    }
    querySuggest.manualClose();
    var fid = querySuggest.fixedItemId;
    if (!fid) {
        fid = 'All';
    }
}
ContextLabels = {
    autosearch: 'TopBar',
    othersearch: 'OtherOptions',
    noresults: 'NoResults'
};
$(document).ready(function($) {
    $(function() {
        $("#autosearch_SearchBar").querySuggest({
            queryUrl: function(query, querySuggest) {
                if (querySuggest.fixedItemId == "All") {
                    querySuggest.fixedItemId = "";
                }
                var url = "/pdb/json/autosearch.do?limit=" + querySuggest.settings.limit +
                    "&" + (querySuggest.fixedItemId ? ("p=" + querySuggest.fixedItemId + "&") : (querySuggest.itemId ? ("p=" + querySuggest.itemId + "&") : "")) +
                    "q=" + encodeURIComponent(query);
                return url;
            },
            initQuery: false,
            present: presentSuggestionsInSearchBar,
            align: 'left',
            delay: 200,
            width: 675
        });
    });
    $("#autosearch_SearchBar").keyup(function(e) {
        var querySuggest = $('#autosearch_SearchBar').getQuerySuggest();
        var val = $('#autosearch_SearchBar').val();
    });
    $("#headerQueryForm").submit(function(e) {
        if ($('#autosearch_SearchBar').val().length < 2) {
            alert('Please enter at least a 2 character search term.');
            return false;
        }
        var querySuggest = $('#autosearch_SearchBar').getQuerySuggest();
        var queryVal = $('#autosearch_SearchBar').val();
        pageTracker._trackEvent('TopBarSubmit', "All", queryVal, querySuggest.popupCounter);
        triggeredSubmit = true;
        return true;
    });
});

$(document).ready(function() {
    $('.nav>.dropdown').mouseenter(function(event) {
        $(this).addClass("open");
    });
    $('.nav>.dropdown').mouseleave(function(event) {
        $('.dropdown').removeClass("open");
    });
});
/*! =======================================================
 VERSION  9.1.3
 ========================================================= */
"use strict";
var _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function(a) {
        return typeof a
    } : function(a) {
        return a && "function" == typeof Symbol && a.constructor === Symbol ? "symbol" : typeof a
    },
    windowIsDefined = "object" === ("undefined" == typeof window ? "undefined" : _typeof(window));
! function(a) {
    if ("function" == typeof define && define.amd) define(["jquery"], a);
    else if ("object" === ("undefined" == typeof module ? "undefined" : _typeof(module)) && module.exports) {
        var b;
        try {
            b = require("jquery")
        } catch (c) {
            b = null
        }
        module.exports = a(b)
    } else window && (window.Slider = a(window.jQuery))
}(function(a) {
    var b = "slider",
        c = "bootstrapSlider";
    windowIsDefined && !window.console && (window.console = {}), windowIsDefined && !window.console.log && (window.console.log = function() {}), windowIsDefined && !window.console.warn && (window.console.warn = function() {});
    var d;
    return function(a) {
            function b() {}

            function c(a) {
                function c(b) {
                    b.prototype.option || (b.prototype.option = function(b) {
                        a.isPlainObject(b) && (this.options = a.extend(!0, this.options, b))
                    })
                }

                function e(b, c) {
                    a.fn[b] = function(e) {
                        if ("string" == typeof e) {
                            for (var g = d.call(arguments, 1), h = 0, i = this.length; i > h; h++) {
                                var j = this[h],
                                    k = a.data(j, b);
                                if (k)
                                    if (a.isFunction(k[e]) && "_" !== e.charAt(0)) {
                                        var l = k[e].apply(k, g);
                                        if (void 0 !== l && l !== k) return l
                                    } else f("no such method '" + e + "' for " + b + " instance");
                                else f("cannot call methods on " + b + " prior to initialization; attempted to call '" + e + "'")
                            }
                            return this
                        }
                        var m = this.map(function() {
                            var d = a.data(this, b);
                            return d ? (d.option(e), d._init()) : (d = new c(this, e), a.data(this, b, d)), a(this)
                        });
                        return !m || m.length > 1 ? m : m[0]
                    }
                }
                if (a) {
                    var f = "undefined" == typeof console ? b : function(a) {
                        console.error(a)
                    };
                    return a.bridget = function(a, b) {
                        c(b), e(a, b)
                    }, a.bridget
                }
            }
            var d = Array.prototype.slice;
            c(a)
        }(a),
        function(a) {
            function e(b, c) {
                function d(a, b) {
                    var c = "data-slider-" + b.replace(/_/g, "-"),
                        d = a.getAttribute(c);
                    try {
                        return JSON.parse(d)
                    } catch (e) {
                        return d
                    }
                }
                this._state = {
                    value: null,
                    enabled: null,
                    offset: null,
                    size: null,
                    percentage: null,
                    inDrag: !1,
                    over: !1
                }, "string" == typeof b ? this.element = document.querySelector(b) : b instanceof HTMLElement && (this.element = b), c = c ? c : {};
                for (var e = Object.keys(this.defaultOptions), f = 0; f < e.length; f++) {
                    var h = e[f],
                        i = c[h];
                    i = "undefined" != typeof i ? i : d(this.element, h), i = null !== i ? i : this.defaultOptions[h], this.options || (this.options = {}), this.options[h] = i
                }
                "vertical" !== this.options.orientation || "top" !== this.options.tooltip_position && "bottom" !== this.options.tooltip_position ? "horizontal" !== this.options.orientation || "left" !== this.options.tooltip_position && "right" !== this.options.tooltip_position || (this.options.tooltip_position = "top") : this.options.tooltip_position = "right";
                var j, k, l, m, n, o = this.element.style.width,
                    p = !1,
                    q = this.element.parentNode;
                if (this.sliderElem) p = !0;
                else {
                    this.sliderElem = document.createElement("div"), this.sliderElem.className = "slider";
                    var r = document.createElement("div");
                    r.className = "slider-track", k = document.createElement("div"), k.className = "slider-track-low", j = document.createElement("div"), j.className = "slider-selection", l = document.createElement("div"), l.className = "slider-track-high", m = document.createElement("div"), m.className = "slider-handle min-slider-handle", m.setAttribute("role", "slider"), m.setAttribute("aria-valuemin", this.options.min), m.setAttribute("aria-valuemax", this.options.max), n = document.createElement("div"), n.className = "slider-handle max-slider-handle", n.setAttribute("role", "slider"), n.setAttribute("aria-valuemin", this.options.min), n.setAttribute("aria-valuemax", this.options.max), r.appendChild(k), r.appendChild(j), r.appendChild(l);
                    var s = Array.isArray(this.options.labelledby);
                    if (s && this.options.labelledby[0] && m.setAttribute("aria-labelledby", this.options.labelledby[0]), s && this.options.labelledby[1] && n.setAttribute("aria-labelledby", this.options.labelledby[1]), !s && this.options.labelledby && (m.setAttribute("aria-labelledby", this.options.labelledby), n.setAttribute("aria-labelledby", this.options.labelledby)), this.ticks = [], Array.isArray(this.options.ticks) && this.options.ticks.length > 0) {
                        for (this.ticksContainer = document.createElement("div"), this.ticksContainer.className = "slider-tick-container", f = 0; f < this.options.ticks.length; f++) {
                            var t = document.createElement("div");
                            t.className = "slider-tick", this.ticks.push(t), this.ticksContainer.appendChild(t)
                        }
                        j.className += " tick-slider-selection"
                    }
                    if (this.tickLabels = [], Array.isArray(this.options.ticks_labels) && this.options.ticks_labels.length > 0)
                        for (this.tickLabelContainer = document.createElement("div"), this.tickLabelContainer.className = "slider-tick-label-container", f = 0; f < this.options.ticks_labels.length; f++) {
                            var u = document.createElement("div"),
                                v = 0 === this.options.ticks_positions.length,
                                w = this.options.reversed && v ? this.options.ticks_labels.length - (f + 1) : f;
                            u.className = "slider-tick-label", u.innerHTML = this.options.ticks_labels[w], this.tickLabels.push(u), this.tickLabelContainer.appendChild(u)
                        }
                    var x = function(a) {
                            var b = document.createElement("div");
                            b.className = "tooltip-arrow";
                            var c = document.createElement("div");
                            c.className = "tooltip-inner", a.appendChild(b), a.appendChild(c)
                        },
                        y = document.createElement("div");
                    y.className = "tooltip tooltip-main", y.setAttribute("role", "presentation"), x(y);
                    var z = document.createElement("div");
                    z.className = "tooltip tooltip-min", z.setAttribute("role", "presentation"), x(z);
                    var A = document.createElement("div");
                    A.className = "tooltip tooltip-max", A.setAttribute("role", "presentation"), x(A), this.sliderElem.appendChild(r), this.sliderElem.appendChild(y), this.sliderElem.appendChild(z), this.sliderElem.appendChild(A), this.tickLabelContainer && this.sliderElem.appendChild(this.tickLabelContainer), this.ticksContainer && this.sliderElem.appendChild(this.ticksContainer), this.sliderElem.appendChild(m), this.sliderElem.appendChild(n), q.insertBefore(this.sliderElem, this.element), this.element.style.display = "none"
                }
                if (a && (this.$element = a(this.element), this.$sliderElem = a(this.sliderElem)), this.eventToCallbackMap = {}, this.sliderElem.id = this.options.id, this.touchCapable = "ontouchstart" in window || window.DocumentTouch && document instanceof window.DocumentTouch, this.touchX = 0, this.touchY = 0, this.tooltip = this.sliderElem.querySelector(".tooltip-main"), this.tooltipInner = this.tooltip.querySelector(".tooltip-inner"), this.tooltip_min = this.sliderElem.querySelector(".tooltip-min"), this.tooltipInner_min = this.tooltip_min.querySelector(".tooltip-inner"), this.tooltip_max = this.sliderElem.querySelector(".tooltip-max"), this.tooltipInner_max = this.tooltip_max.querySelector(".tooltip-inner"), g[this.options.scale] && (this.options.scale = g[this.options.scale]), p === !0 && (this._removeClass(this.sliderElem, "slider-horizontal"), this._removeClass(this.sliderElem, "slider-vertical"), this._removeClass(this.tooltip, "hide"), this._removeClass(this.tooltip_min, "hide"), this._removeClass(this.tooltip_max, "hide"), ["left", "top", "width", "height"].forEach(function(a) {
                        this._removeProperty(this.trackLow, a), this._removeProperty(this.trackSelection, a), this._removeProperty(this.trackHigh, a)
                    }, this), [this.handle1, this.handle2].forEach(function(a) {
                        this._removeProperty(a, "left"), this._removeProperty(a, "top")
                    }, this), [this.tooltip, this.tooltip_min, this.tooltip_max].forEach(function(a) {
                        this._removeProperty(a, "left"), this._removeProperty(a, "top"), this._removeProperty(a, "margin-left"), this._removeProperty(a, "margin-top"), this._removeClass(a, "right"), this._removeClass(a, "top")
                    }, this)), "vertical" === this.options.orientation ? (this._addClass(this.sliderElem, "slider-vertical"), this.stylePos = "top", this.mousePos = "pageY", this.sizePos = "offsetHeight") : (this._addClass(this.sliderElem, "slider-horizontal"), this.sliderElem.style.width = o, this.options.orientation = "horizontal", this.stylePos = "left", this.mousePos = "pageX", this.sizePos = "offsetWidth"), this._setTooltipPosition(), Array.isArray(this.options.ticks) && this.options.ticks.length > 0 && (this.options.max = Math.max.apply(Math, this.options.ticks), this.options.min = Math.min.apply(Math, this.options.ticks)), Array.isArray(this.options.value) ? (this.options.range = !0, this._state.value = this.options.value) : this.options.range ? this._state.value = [this.options.value, this.options.max] : this._state.value = this.options.value, this.trackLow = k || this.trackLow, this.trackSelection = j || this.trackSelection, this.trackHigh = l || this.trackHigh, "none" === this.options.selection && (this._addClass(this.trackLow, "hide"), this._addClass(this.trackSelection, "hide"), this._addClass(this.trackHigh, "hide")), this.handle1 = m || this.handle1, this.handle2 = n || this.handle2, p === !0)
                    for (this._removeClass(this.handle1, "round triangle"), this._removeClass(this.handle2, "round triangle hide"), f = 0; f < this.ticks.length; f++) this._removeClass(this.ticks[f], "round triangle hide");
                var B = ["round", "triangle", "custom"],
                    C = -1 !== B.indexOf(this.options.handle);
                if (C)
                    for (this._addClass(this.handle1, this.options.handle), this._addClass(this.handle2, this.options.handle), f = 0; f < this.ticks.length; f++) this._addClass(this.ticks[f], this.options.handle);
                this._state.offset = this._offset(this.sliderElem), this._state.size = this.sliderElem[this.sizePos], this.setValue(this._state.value), this.handle1Keydown = this._keydown.bind(this, 0), this.handle1.addEventListener("keydown", this.handle1Keydown, !1), this.handle2Keydown = this._keydown.bind(this, 1), this.handle2.addEventListener("keydown", this.handle2Keydown, !1), this.mousedown = this._mousedown.bind(this), this.touchstart = this._touchstart.bind(this), this.touchmove = this._touchmove.bind(this), this.touchCapable && (this.sliderElem.addEventListener("touchstart", this.touchstart, !1), this.sliderElem.addEventListener("touchmove", this.touchmove, !1)), this.sliderElem.addEventListener("mousedown", this.mousedown, !1), this.resize = this._resize.bind(this), window.addEventListener("resize", this.resize, !1), "hide" === this.options.tooltip ? (this._addClass(this.tooltip, "hide"), this._addClass(this.tooltip_min, "hide"), this._addClass(this.tooltip_max, "hide")) : "always" === this.options.tooltip ? (this._showTooltip(), this._alwaysShowTooltip = !0) : (this.showTooltip = this._showTooltip.bind(this), this.hideTooltip = this._hideTooltip.bind(this), this.sliderElem.addEventListener("mouseenter", this.showTooltip, !1), this.sliderElem.addEventListener("mouseleave", this.hideTooltip, !1), this.handle1.addEventListener("focus", this.showTooltip, !1), this.handle1.addEventListener("blur", this.hideTooltip, !1), this.handle2.addEventListener("focus", this.showTooltip, !1), this.handle2.addEventListener("blur", this.hideTooltip, !1)), this.options.enabled ? this.enable() : this.disable()
            }
            var f = {
                    formatInvalidInputErrorMsg: function(a) {
                        return "Invalid input value '" + a + "' passed in"
                    },
                    callingContextNotSliderInstance: "Calling context element does not have instance of Slider bound to it. Check your code to make sure the JQuery object returned from the call to the slider() initializer is calling the method"
                },
                g = {
                    linear: {
                        toValue: function(a) {
                            var b = a / 100 * (this.options.max - this.options.min),
                                c = !0;
                            if (this.options.ticks_positions.length > 0) {
                                for (var d, e, f, g = 0, h = 1; h < this.options.ticks_positions.length; h++)
                                    if (a <= this.options.ticks_positions[h]) {
                                        d = this.options.ticks[h - 1], f = this.options.ticks_positions[h - 1], e = this.options.ticks[h], g = this.options.ticks_positions[h];
                                        break
                                    }
                                var i = (a - f) / (g - f);
                                b = d + i * (e - d), c = !1
                            }
                            var j = c ? this.options.min : 0,
                                k = j + Math.round(b / this.options.step) * this.options.step;
                            return k < this.options.min ? this.options.min : k > this.options.max ? this.options.max : k
                        },
                        toPercentage: function(a) {
                            if (this.options.max === this.options.min) return 0;
                            if (this.options.ticks_positions.length > 0) {
                                for (var b, c, d, e = 0, f = 0; f < this.options.ticks.length; f++)
                                    if (a <= this.options.ticks[f]) {
                                        b = f > 0 ? this.options.ticks[f - 1] : 0, d = f > 0 ? this.options.ticks_positions[f - 1] : 0, c = this.options.ticks[f], e = this.options.ticks_positions[f];
                                        break
                                    }
                                if (f > 0) {
                                    var g = (a - b) / (c - b);
                                    return d + g * (e - d)
                                }
                            }
                            return 100 * (a - this.options.min) / (this.options.max - this.options.min)
                        }
                    },
                    logarithmic: {
                        toValue: function(a) {
                            var b = 0 === this.options.min ? 0 : Math.log(this.options.min),
                                c = Math.log(this.options.max),
                                d = Math.exp(b + (c - b) * a / 100);
                            return d = this.options.min + Math.round((d - this.options.min) / this.options.step) * this.options.step, d < this.options.min ? this.options.min : d > this.options.max ? this.options.max : d
                        },
                        toPercentage: function(a) {
                            if (this.options.max === this.options.min) return 0;
                            var b = Math.log(this.options.max),
                                c = 0 === this.options.min ? 0 : Math.log(this.options.min),
                                d = 0 === a ? 0 : Math.log(a);
                            return 100 * (d - c) / (b - c)
                        }
                    }
                };
            d = function(a, b) {
                return e.call(this, a, b), this
            }, d.prototype = {
                _init: function() {},
                constructor: d,
                defaultOptions: {
                    id: "",
                    min: 0,
                    max: 10,
                    step: 1,
                    precision: 0,
                    orientation: "horizontal",
                    value: 5,
                    range: !1,
                    selection: "before",
                    tooltip: "show",
                    tooltip_split: !1,
                    handle: "round",
                    reversed: !1,
                    enabled: !0,
                    formatter: function(a) {
                        return Array.isArray(a) ? a[0] + " : " + a[1] : a
                    },
                    natural_arrow_keys: !1,
                    ticks: [],
                    ticks_positions: [],
                    ticks_labels: [],
                    ticks_snap_bounds: 0,
                    scale: "linear",
                    focus: !1,
                    tooltip_position: null,
                    labelledby: null
                },
                getElement: function() {
                    return this.sliderElem
                },
                getValue: function() {
                    return this.options.range ? this._state.value : this._state.value[0]
                },
                setValue: function(a, b, c) {
                    a || (a = 0);
                    var d = this.getValue();
                    this._state.value = this._validateInputValue(a);
                    var e = this._applyPrecision.bind(this);
                    this.options.range ? (this._state.value[0] = e(this._state.value[0]), this._state.value[1] = e(this._state.value[1]), this._state.value[0] = Math.max(this.options.min, Math.min(this.options.max, this._state.value[0])), this._state.value[1] = Math.max(this.options.min, Math.min(this.options.max, this._state.value[1]))) : (this._state.value = e(this._state.value), this._state.value = [Math.max(this.options.min, Math.min(this.options.max, this._state.value))], this._addClass(this.handle2, "hide"), "after" === this.options.selection ? this._state.value[1] = this.options.max : this._state.value[1] = this.options.min), this.options.max > this.options.min ? this._state.percentage = [this._toPercentage(this._state.value[0]), this._toPercentage(this._state.value[1]), 100 * this.options.step / (this.options.max - this.options.min)] : this._state.percentage = [0, 0, 100], this._layout();
                    var f = this.options.range ? this._state.value : this._state.value[0];
                    return this._setDataVal(f), b === !0 && this._trigger("slide", f), d !== f && c === !0 && this._trigger("change", {
                        oldValue: d,
                        newValue: f
                    }), this
                },
                destroy: function() {
                    this._removeSliderEventHandlers(), this.sliderElem.parentNode.removeChild(this.sliderElem), this.element.style.display = "", this._cleanUpEventCallbacksMap(), this.element.removeAttribute("data"), a && (this._unbindJQueryEventHandlers(), this.$element.removeData("slider"))
                },
                disable: function() {
                    return this._state.enabled = !1, this.handle1.removeAttribute("tabindex"), this.handle2.removeAttribute("tabindex"), this._addClass(this.sliderElem, "slider-disabled"), this._trigger("slideDisabled"), this
                },
                enable: function() {
                    return this._state.enabled = !0, this.handle1.setAttribute("tabindex", 0), this.handle2.setAttribute("tabindex", 0), this._removeClass(this.sliderElem, "slider-disabled"), this._trigger("slideEnabled"), this
                },
                toggle: function() {
                    return this._state.enabled ? this.disable() : this.enable(), this
                },
                isEnabled: function() {
                    return this._state.enabled
                },
                on: function(a, b) {
                    return this._bindNonQueryEventHandler(a, b), this
                },
                off: function(b, c) {
                    a ? (this.$element.off(b, c), this.$sliderElem.off(b, c)) : this._unbindNonQueryEventHandler(b, c)
                },
                getAttribute: function(a) {
                    return a ? this.options[a] : this.options
                },
                setAttribute: function(a, b) {
                    return this.options[a] = b, this
                },
                refresh: function() {
                    return this._removeSliderEventHandlers(), e.call(this, this.element, this.options), a && a.data(this.element, "slider", this), this
                },
                relayout: function() {
                    return this._resize(), this._layout(), this
                },
                _removeSliderEventHandlers: function() {
                    this.handle1.removeEventListener("keydown", this.handle1Keydown, !1), this.handle2.removeEventListener("keydown", this.handle2Keydown, !1), this.showTooltip && (this.handle1.removeEventListener("focus", this.showTooltip, !1), this.handle2.removeEventListener("focus", this.showTooltip, !1)), this.hideTooltip && (this.handle1.removeEventListener("blur", this.hideTooltip, !1), this.handle2.removeEventListener("blur", this.hideTooltip, !1)), this.showTooltip && this.sliderElem.removeEventListener("mouseenter", this.showTooltip, !1), this.hideTooltip && this.sliderElem.removeEventListener("mouseleave", this.hideTooltip, !1), this.sliderElem.removeEventListener("touchstart", this.touchstart, !1), this.sliderElem.removeEventListener("touchmove", this.touchmove, !1), this.sliderElem.removeEventListener("mousedown", this.mousedown, !1), window.removeEventListener("resize", this.resize, !1)
                },
                _bindNonQueryEventHandler: function(a, b) {
                    void 0 === this.eventToCallbackMap[a] && (this.eventToCallbackMap[a] = []), this.eventToCallbackMap[a].push(b)
                },
                _unbindNonQueryEventHandler: function(a, b) {
                    var c = this.eventToCallbackMap[a];
                    if (void 0 !== c)
                        for (var d = 0; d < c.length; d++)
                            if (c[d] === b) {
                                c.splice(d, 1);
                                break
                            }
                },
                _cleanUpEventCallbacksMap: function() {
                    for (var a = Object.keys(this.eventToCallbackMap), b = 0; b < a.length; b++) {
                        var c = a[b];
                        this.eventToCallbackMap[c] = null
                    }
                },
                _showTooltip: function() {
                    this.options.tooltip_split === !1 ? (this._addClass(this.tooltip, "in"), this.tooltip_min.style.display = "none", this.tooltip_max.style.display = "none") : (this._addClass(this.tooltip_min, "in"), this._addClass(this.tooltip_max, "in"), this.tooltip.style.display = "none"), this._state.over = !0
                },
                _hideTooltip: function() {
                    this._state.inDrag === !1 && this.alwaysShowTooltip !== !0 && (this._removeClass(this.tooltip, "in"), this._removeClass(this.tooltip_min, "in"), this._removeClass(this.tooltip_max, "in")), this._state.over = !1
                },
                _layout: function() {
                    var a;
                    if (a = this.options.reversed ? [100 - this._state.percentage[0], this.options.range ? 100 - this._state.percentage[1] : this._state.percentage[1]] : [this._state.percentage[0], this._state.percentage[1]], this.handle1.style[this.stylePos] = a[0] + "%", this.handle1.setAttribute("aria-valuenow", this._state.value[0]), this.handle2.style[this.stylePos] = a[1] + "%", this.handle2.setAttribute("aria-valuenow", this._state.value[1]), Array.isArray(this.options.ticks) && this.options.ticks.length > 0) {
                        var b = "vertical" === this.options.orientation ? "height" : "width",
                            c = "vertical" === this.options.orientation ? "marginTop" : "marginLeft",
                            d = this._state.size / (this.options.ticks.length - 1);
                        if (this.tickLabelContainer) {
                            var e = 0;
                            if (0 === this.options.ticks_positions.length) "vertical" !== this.options.orientation && (this.tickLabelContainer.style[c] = -d / 2 + "px"), e = this.tickLabelContainer.offsetHeight;
                            else
                                for (f = 0; f < this.tickLabelContainer.childNodes.length; f++) this.tickLabelContainer.childNodes[f].offsetHeight > e && (e = this.tickLabelContainer.childNodes[f].offsetHeight);
                            "horizontal" === this.options.orientation && (this.sliderElem.style.marginBottom = e + "px")
                        }
                        for (var f = 0; f < this.options.ticks.length; f++) {
                            var g = this.options.ticks_positions[f] || this._toPercentage(this.options.ticks[f]);
                            this.options.reversed && (g = 100 - g), this.ticks[f].style[this.stylePos] = g + "%", this._removeClass(this.ticks[f], "in-selection"), this.options.range ? g >= a[0] && g <= a[1] && this._addClass(this.ticks[f], "in-selection") : "after" === this.options.selection && g >= a[0] ? this._addClass(this.ticks[f], "in-selection") : "before" === this.options.selection && g <= a[0] && this._addClass(this.ticks[f], "in-selection"), this.tickLabels[f] && (this.tickLabels[f].style[b] = d + "px", "vertical" !== this.options.orientation && void 0 !== this.options.ticks_positions[f] ? (this.tickLabels[f].style.position = "absolute", this.tickLabels[f].style[this.stylePos] = g + "%", this.tickLabels[f].style[c] = -d / 2 + "px") : "vertical" === this.options.orientation && (this.tickLabels[f].style.marginLeft = this.sliderElem.offsetWidth + "px", this.tickLabelContainer.style.marginTop = this.sliderElem.offsetWidth / 2 * -1 + "px"))
                        }
                    }
                    var h;
                    if (this.options.range) {
                        h = this.options.formatter(this._state.value), this._setText(this.tooltipInner, h), this.tooltip.style[this.stylePos] = (a[1] + a[0]) / 2 + "%", "vertical" === this.options.orientation ? this._css(this.tooltip, "margin-top", -this.tooltip.offsetHeight / 2 + "px") : this._css(this.tooltip, "margin-left", -this.tooltip.offsetWidth / 2 + "px"), "vertical" === this.options.orientation ? this._css(this.tooltip, "margin-top", -this.tooltip.offsetHeight / 2 + "px") : this._css(this.tooltip, "margin-left", -this.tooltip.offsetWidth / 2 + "px");
                        var i = this.options.formatter(this._state.value[0]);
                        this._setText(this.tooltipInner_min, i);
                        var j = this.options.formatter(this._state.value[1]);
                        this._setText(this.tooltipInner_max, j), this.tooltip_min.style[this.stylePos] = a[0] + "%", "vertical" === this.options.orientation ? this._css(this.tooltip_min, "margin-top", -this.tooltip_min.offsetHeight / 2 + "px") : this._css(this.tooltip_min, "margin-left", -this.tooltip_min.offsetWidth / 2 + "px"), this.tooltip_max.style[this.stylePos] = a[1] + "%", "vertical" === this.options.orientation ? this._css(this.tooltip_max, "margin-top", -this.tooltip_max.offsetHeight / 2 + "px") : this._css(this.tooltip_max, "margin-left", -this.tooltip_max.offsetWidth / 2 + "px")
                    } else h = this.options.formatter(this._state.value[0]), this._setText(this.tooltipInner, h), this.tooltip.style[this.stylePos] = a[0] + "%", "vertical" === this.options.orientation ? this._css(this.tooltip, "margin-top", -this.tooltip.offsetHeight / 2 + "px") : this._css(this.tooltip, "margin-left", -this.tooltip.offsetWidth / 2 + "px");
                    if ("vertical" === this.options.orientation) this.trackLow.style.top = "0", this.trackLow.style.height = Math.min(a[0], a[1]) + "%", this.trackSelection.style.top = Math.min(a[0], a[1]) + "%", this.trackSelection.style.height = Math.abs(a[0] - a[1]) + "%", this.trackHigh.style.bottom = "0", this.trackHigh.style.height = 100 - Math.min(a[0], a[1]) - Math.abs(a[0] - a[1]) + "%";
                    else {
                        this.trackLow.style.left = "0", this.trackLow.style.width = Math.min(a[0], a[1]) + "%", this.trackSelection.style.left = Math.min(a[0], a[1]) + "%", this.trackSelection.style.width = Math.abs(a[0] - a[1]) + "%", this.trackHigh.style.right = "0", this.trackHigh.style.width = 100 - Math.min(a[0], a[1]) - Math.abs(a[0] - a[1]) + "%";
                        var k = this.tooltip_min.getBoundingClientRect(),
                            l = this.tooltip_max.getBoundingClientRect();
                        "bottom" === this.options.tooltip_position ? k.right > l.left ? (this._removeClass(this.tooltip_max, "bottom"), this._addClass(this.tooltip_max, "top"), this.tooltip_max.style.top = "", this.tooltip_max.style.bottom = "22px") : (this._removeClass(this.tooltip_max, "top"), this._addClass(this.tooltip_max, "bottom"), this.tooltip_max.style.top = this.tooltip_min.style.top, this.tooltip_max.style.bottom = "") : k.right > l.left ? (this._removeClass(this.tooltip_max, "top"), this._addClass(this.tooltip_max, "bottom"), this.tooltip_max.style.top = "18px") : (this._removeClass(this.tooltip_max, "bottom"), this._addClass(this.tooltip_max, "top"), this.tooltip_max.style.top = this.tooltip_min.style.top)
                    }
                },
                _resize: function(a) {
                    this._state.offset = this._offset(this.sliderElem), this._state.size = this.sliderElem[this.sizePos], this._layout()
                },
                _removeProperty: function(a, b) {
                    a.style.removeProperty ? a.style.removeProperty(b) : a.style.removeAttribute(b)
                },
                _mousedown: function(a) {
                    if (!this._state.enabled) return !1;
                    this._state.offset = this._offset(this.sliderElem), this._state.size = this.sliderElem[this.sizePos];
                    var b = this._getPercentage(a);
                    if (this.options.range) {
                        var c = Math.abs(this._state.percentage[0] - b),
                            d = Math.abs(this._state.percentage[1] - b);
                        this._state.dragged = d > c ? 0 : 1, this._adjustPercentageForRangeSliders(b)
                    } else this._state.dragged = 0;
                    this._state.percentage[this._state.dragged] = b, this._layout(), this.touchCapable && (document.removeEventListener("touchmove", this.mousemove, !1), document.removeEventListener("touchend", this.mouseup, !1)), this.mousemove && document.removeEventListener("mousemove", this.mousemove, !1), this.mouseup && document.removeEventListener("mouseup", this.mouseup, !1), this.mousemove = this._mousemove.bind(this), this.mouseup = this._mouseup.bind(this), this.touchCapable && (document.addEventListener("touchmove", this.mousemove, !1), document.addEventListener("touchend", this.mouseup, !1)), document.addEventListener("mousemove", this.mousemove, !1), document.addEventListener("mouseup", this.mouseup, !1), this._state.inDrag = !0;
                    var e = this._calculateValue();
                    return this._trigger("slideStart", e), this._setDataVal(e), this.setValue(e, !1, !0), this._pauseEvent(a), this.options.focus && this._triggerFocusOnHandle(this._state.dragged), !0
                },
                _touchstart: function(a) {
                    if (void 0 === a.changedTouches) return void this._mousedown(a);
                    var b = a.changedTouches[0];
                    this.touchX = b.pageX, this.touchY = b.pageY
                },
                _triggerFocusOnHandle: function(a) {
                    0 === a && this.handle1.focus(), 1 === a && this.handle2.focus()
                },
                _keydown: function(a, b) {
                    if (!this._state.enabled) return !1;
                    var c;
                    switch (b.keyCode) {
                        case 37:
                        case 40:
                            c = -1;
                            break;
                        case 39:
                        case 38:
                            c = 1
                    }
                    if (c) {
                        if (this.options.natural_arrow_keys) {
                            var d = "vertical" === this.options.orientation && !this.options.reversed,
                                e = "horizontal" === this.options.orientation && this.options.reversed;
                            (d || e) && (c = -c)
                        }
                        var f = this._state.value[a] + c * this.options.step;
                        return this.options.range && (f = [a ? this._state.value[0] : f, a ? f : this._state.value[1]]), this._trigger("slideStart", f), this._setDataVal(f), this.setValue(f, !0, !0), this._setDataVal(f), this._trigger("slideStop", f), this._layout(), this._pauseEvent(b), !1
                    }
                },
                _pauseEvent: function(a) {
                    a.stopPropagation && a.stopPropagation(), a.preventDefault && a.preventDefault(), a.cancelBubble = !0, a.returnValue = !1
                },
                _mousemove: function(a) {
                    if (!this._state.enabled) return !1;
                    var b = this._getPercentage(a);
                    this._adjustPercentageForRangeSliders(b), this._state.percentage[this._state.dragged] = b, this._layout();
                    var c = this._calculateValue(!0);
                    return this.setValue(c, !0, !0), !1
                },
                _touchmove: function(a) {
                    if (void 0 !== a.changedTouches) {
                        var b = a.changedTouches[0],
                            c = b.pageX - this.touchX,
                            d = b.pageY - this.touchY;
                        this._state.inDrag || ("vertical" === this.options.orientation && 5 >= c && c >= -5 && (d >= 15 || -15 >= d) ? this._mousedown(a) : 5 >= d && d >= -5 && (c >= 15 || -15 >= c) && this._mousedown(a))
                    }
                },
                _adjustPercentageForRangeSliders: function(a) {
                    if (this.options.range) {
                        var b = this._getNumDigitsAfterDecimalPlace(a);
                        b = b ? b - 1 : 0;
                        var c = this._applyToFixedAndParseFloat(a, b);
                        0 === this._state.dragged && this._applyToFixedAndParseFloat(this._state.percentage[1], b) < c ? (this._state.percentage[0] = this._state.percentage[1], this._state.dragged = 1) : 1 === this._state.dragged && this._applyToFixedAndParseFloat(this._state.percentage[0], b) > c && (this._state.percentage[1] = this._state.percentage[0], this._state.dragged = 0)
                    }
                },
                _mouseup: function() {
                    if (!this._state.enabled) return !1;
                    this.touchCapable && (document.removeEventListener("touchmove", this.mousemove, !1), document.removeEventListener("touchend", this.mouseup, !1)), document.removeEventListener("mousemove", this.mousemove, !1), document.removeEventListener("mouseup", this.mouseup, !1), this._state.inDrag = !1, this._state.over === !1 && this._hideTooltip();
                    var a = this._calculateValue(!0);
                    return this._layout(), this._setDataVal(a), this._trigger("slideStop", a), !1
                },
                _calculateValue: function(a) {
                    var b;
                    if (this.options.range ? (b = [this.options.min, this.options.max], 0 !== this._state.percentage[0] && (b[0] = this._toValue(this._state.percentage[0]), b[0] = this._applyPrecision(b[0])), 100 !== this._state.percentage[1] && (b[1] = this._toValue(this._state.percentage[1]), b[1] = this._applyPrecision(b[1]))) : (b = this._toValue(this._state.percentage[0]), b = parseFloat(b), b = this._applyPrecision(b)), a) {
                        for (var c = [b, 1 / 0], d = 0; d < this.options.ticks.length; d++) {
                            var e = Math.abs(this.options.ticks[d] - b);
                            e <= c[1] && (c = [this.options.ticks[d], e])
                        }
                        if (c[1] <= this.options.ticks_snap_bounds) return c[0]
                    }
                    return b
                },
                _applyPrecision: function(a) {
                    var b = this.options.precision || this._getNumDigitsAfterDecimalPlace(this.options.step);
                    return this._applyToFixedAndParseFloat(a, b)
                },
                _getNumDigitsAfterDecimalPlace: function(a) {
                    var b = ("" + a).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);
                    return b ? Math.max(0, (b[1] ? b[1].length : 0) - (b[2] ? +b[2] : 0)) : 0
                },
                _applyToFixedAndParseFloat: function(a, b) {
                    var c = a.toFixed(b);
                    return parseFloat(c)
                },
                _getPercentage: function(a) {
                    !this.touchCapable || "touchstart" !== a.type && "touchmove" !== a.type || (a = a.touches[0]);
                    var b = a[this.mousePos],
                        c = this._state.offset[this.stylePos],
                        d = b - c,
                        e = d / this._state.size * 100;
                    return e = Math.round(e / this._state.percentage[2]) * this._state.percentage[2], this.options.reversed && (e = 100 - e), Math.max(0, Math.min(100, e))
                },
                _validateInputValue: function(a) {
                    if ("number" == typeof a) return a;
                    if (Array.isArray(a)) return this._validateArray(a), a;
                    throw new Error(f.formatInvalidInputErrorMsg(a))
                },
                _validateArray: function(a) {
                    for (var b = 0; b < a.length; b++) {
                        var c = a[b];
                        if ("number" != typeof c) throw new Error(f.formatInvalidInputErrorMsg(c))
                    }
                },
                _setDataVal: function(a) {
                    this.element.setAttribute("data-value", a), this.element.setAttribute("value", a), this.element.value = a
                },
                _trigger: function(b, c) {
                    c = c || 0 === c ? c : void 0;
                    var d = this.eventToCallbackMap[b];
                    if (d && d.length)
                        for (var e = 0; e < d.length; e++) {
                            var f = d[e];
                            f(c)
                        }
                    a && this._triggerJQueryEvent(b, c)
                },
                _triggerJQueryEvent: function(a, b) {
                    var c = {
                        type: a,
                        value: b
                    };
                    this.$element.trigger(c), this.$sliderElem.trigger(c)
                },
                _unbindJQueryEventHandlers: function() {
                    this.$element.off(), this.$sliderElem.off()
                },
                _setText: function(a, b) {
                    "undefined" != typeof a.textContent ? a.textContent = b : "undefined" != typeof a.innerText && (a.innerText = b)
                },
                _removeClass: function(a, b) {
                    for (var c = b.split(" "), d = a.className, e = 0; e < c.length; e++) {
                        var f = c[e],
                            g = new RegExp("(?:\\s|^)" + f + "(?:\\s|$)");
                        d = d.replace(g, " ")
                    }
                    a.className = d.trim()
                },
                _addClass: function(a, b) {
                    for (var c = b.split(" "), d = a.className, e = 0; e < c.length; e++) {
                        var f = c[e],
                            g = new RegExp("(?:\\s|^)" + f + "(?:\\s|$)"),
                            h = g.test(d);
                        h || (d += " " + f)
                    }
                    a.className = d.trim()
                },
                _offsetLeft: function(a) {
                    return a.getBoundingClientRect().left
                },
                _offsetTop: function(a) {
                    for (var b = a.offsetTop;
                        (a = a.offsetParent) && !isNaN(a.offsetTop);) b += a.offsetTop, "BODY" !== a.tagName && (b -= a.scrollTop);
                    return b
                },
                _offset: function(a) {
                    return {
                        left: this._offsetLeft(a),
                        top: this._offsetTop(a)
                    }
                },
                _css: function(b, c, d) {
                    if (a) a.style(b, c, d);
                    else {
                        var e = c.replace(/^-ms-/, "ms-").replace(/-([\da-z])/gi, function(a, b) {
                            return b.toUpperCase()
                        });
                        b.style[e] = d
                    }
                },
                _toValue: function(a) {
                    return this.options.scale.toValue.apply(this, [a])
                },
                _toPercentage: function(a) {
                    return this.options.scale.toPercentage.apply(this, [a])
                },
                _setTooltipPosition: function() {
                    var a = [this.tooltip, this.tooltip_min, this.tooltip_max];
                    if ("vertical" === this.options.orientation) {
                        var b = this.options.tooltip_position || "right",
                            c = "left" === b ? "right" : "left";
                        a.forEach(function(a) {
                            this._addClass(a, b), a.style[c] = "100%"
                        }.bind(this))
                    } else "bottom" === this.options.tooltip_position ? a.forEach(function(a) {
                        this._addClass(a, "bottom"), a.style.top = "22px"
                    }.bind(this)) : a.forEach(function(a) {
                        this._addClass(a, "top"), a.style.top = -this.tooltip.outerHeight - 14 + "px"
                    }.bind(this))
                }
            }, a && ! function() {
                var e = void 0;
                a.fn.slider ? (windowIsDefined && window.console.warn("bootstrap-slider.js - WARNING: $.fn.slider namespace is already bound. Use the $.fn.bootstrapSlider namespace instead."), e = c) : (a.bridget(b, d), e = b), a.bridget(c, d), a(function() {
                    a("input[data-provide=slider]")[e]()
                })
            }()
        }(a), d
});

(function($) {
    function SVGManager() {
        this._settings = [];
        this._extensions = [];
        this.regional = [];
        this.regional[''] = {
            errorLoadingText: 'Error loading'
        };
        this.local = this.regional[''];
        this._uuid = new Date().getTime();
        this._ie = !!window.ActiveXObject;
    }
    $.extend(SVGManager.prototype, {
        markerClassName: 'hasSVG',
        propertyName: 'svgwrapper',
        svgNS: 'http://www.w3.org/2000/svg',
        xlinkNS: 'http://www.w3.org/1999/xlink',
        _wrapperClass: SVGWrapper,
        _attrNames: {
            class_: 'class',
            in_: 'in',
            alignmentBaseline: 'alignment-baseline',
            baselineShift: 'baseline-shift',
            clipPath: 'clip-path',
            clipRule: 'clip-rule',
            colorInterpolation: 'color-interpolation',
            colorInterpolationFilters: 'color-interpolation-filters',
            colorRendering: 'color-rendering',
            dominantBaseline: 'dominant-baseline',
            enableBackground: 'enable-background',
            fillOpacity: 'fill-opacity',
            fillRule: 'fill-rule',
            floodColor: 'flood-color',
            floodOpacity: 'flood-opacity',
            fontFamily: 'font-family',
            fontSize: 'font-size',
            fontSizeAdjust: 'font-size-adjust',
            fontStretch: 'font-stretch',
            fontStyle: 'font-style',
            fontVariant: 'font-variant',
            fontWeight: 'font-weight',
            glyphOrientationHorizontal: 'glyph-orientation-horizontal',
            glyphOrientationVertical: 'glyph-orientation-vertical',
            horizAdvX: 'horiz-adv-x',
            horizOriginX: 'horiz-origin-x',
            imageRendering: 'image-rendering',
            letterSpacing: 'letter-spacing',
            lightingColor: 'lighting-color',
            markerEnd: 'marker-end',
            markerMid: 'marker-mid',
            markerStart: 'marker-start',
            stopColor: 'stop-color',
            stopOpacity: 'stop-opacity',
            strikethroughPosition: 'strikethrough-position',
            strikethroughThickness: 'strikethrough-thickness',
            strokeDashArray: 'stroke-dasharray',
            strokeDashOffset: 'stroke-dashoffset',
            strokeLineCap: 'stroke-linecap',
            strokeLineJoin: 'stroke-linejoin',
            strokeMiterLimit: 'stroke-miterlimit',
            strokeOpacity: 'stroke-opacity',
            strokeWidth: 'stroke-width',
            textAnchor: 'text-anchor',
            textDecoration: 'text-decoration',
            textRendering: 'text-rendering',
            underlinePosition: 'underline-position',
            underlineThickness: 'underline-thickness',
            vertAdvY: 'vert-adv-y',
            vertOriginY: 'vert-origin-y',
            wordSpacing: 'word-spacing',
            writingMode: 'writing-mode'
        },
        _attachSVG: function(container, settings) {
            var svg = (container.namespaceURI === this.svgNS ? container : null);
            var container = (svg ? null : container);
            if ($(container || svg).hasClass(this.markerClassName)) {
                return;
            }
            if (typeof settings === 'string') {
                settings = {
                    loadURL: settings
                };
            } else if (typeof settings === 'function') {
                settings = {
                    onLoad: settings
                };
            }
            $(container || svg).addClass(this.markerClassName);
            try {
                if (!svg) {
                    svg = document.createElementNS(this.svgNS, 'svg');
                    svg.setAttribute('version', '1.1');
                    if (container.clientWidth > 0) {
                        svg.setAttribute('width', container.clientWidth);
                    }
                    if (container.clientHeight > 0) {
                        svg.setAttribute('height', container.clientHeight);
                    }
                    container.appendChild(svg);
                }
                this._afterLoad(container, svg, settings || {});
            } catch (e) {
                $(container).html('<p>SVG is not supported natively on this browser</p>');
            }
        },
        _afterLoad: function(container, svg, settings) {
            var settings = settings || this._settings[container.id];
            this._settings[container ? container.id : ''] = null;
            var wrapper = new this._wrapperClass(svg, container);
            $.data(container || svg, $.svg.propertyName, wrapper);
            try {
                if (settings.loadURL) {
                    wrapper.load(settings.loadURL, settings);
                }
                if (settings.settings) {
                    wrapper.configure(settings.settings);
                }
                if (settings.onLoad && !settings.loadURL) {
                    settings.onLoad.apply(container || svg, [wrapper]);
                }
            } catch (e) {
                alert(e);
            }
        },
        _getSVG: function(container) {
            return $(container).data(this.propertyName);
        },
        _destroySVG: function(container) {
            container = $(container);
            if (!container.hasClass(this.markerClassName)) {
                return;
            }
            container.removeClass(this.markerClassName).removeData(this.propertyName);
            if (container[0].namespaceURI !== this.svgNS) {
                container.empty();
            }
        },
        addExtension: function(name, extClass) {
            this._extensions.push([name, extClass]);
        },
        isSVGElem: function(node) {
            return (node.nodeType === 1 && node.namespaceURI === $.svg.svgNS);
        }
    });

    function SVGWrapper(svg, container) {
        this._svg = svg;
        this._container = container;
        for (var i = 0; i < $.svg._extensions.length; i++) {
            var extension = $.svg._extensions[i];
            this[extension[0]] = new extension[1](this);
        }
    }
    $.extend(SVGWrapper.prototype, {
        width: function() {
            return (this._container ? this._container.clientWidth : this._svg.width);
        },
        height: function() {
            return (this._container ? this._container.clientHeight : this._svg.height);
        },
        root: function() {
            return this._svg;
        },
        configure: function(node, settings, clear) {
            if (!node.nodeName) {
                clear = settings;
                settings = node;
                node = this._svg;
            }
            if (clear) {
                for (var i = node.attributes.length - 1; i >= 0; i--) {
                    var attr = node.attributes.item(i);
                    if (!(attr.nodeName === 'onload' || attr.nodeName === 'version' || attr.nodeName.substring(0, 5) === 'xmlns')) {
                        node.attributes.removeNamedItem(attr.nodeName);
                    }
                }
            }
            for (var attrName in settings) {
                node.setAttribute($.svg._attrNames[attrName] || attrName, settings[attrName]);
            }
            return this;
        },
        getElementById: function(id) {
            return this._svg.ownerDocument.getElementById(id);
        },
        change: function(element, settings) {
            if (element) {
                for (var name in settings) {
                    if (settings[name] == null) {
                        element.removeAttribute($.svg._attrNames[name] || name);
                    } else {
                        element.setAttribute($.svg._attrNames[name] || name, settings[name]);
                    }
                }
            }
            return this;
        },
        _args: function(values, names, optSettings) {
            names.splice(0, 0, 'parent');
            names.splice(names.length, 0, 'settings');
            var args = {};
            var offset = 0;
            if (values[0] != null && values[0].jquery) {
                values[0] = values[0][0];
            }
            if (values[0] != null && !(typeof values[0] === 'object' && values[0].nodeName)) {
                args['parent'] = null;
                offset = 1;
            }
            for (var i = 0; i < values.length; i++) {
                args[names[i + offset]] = values[i];
            }
            if (optSettings) {
                $.each(optSettings, function(i, value) {
                    if (typeof args[value] === 'object') {
                        args.settings = args[value];
                        args[value] = null;
                    }
                });
            }
            return args;
        },
        title: function(parent, text, settings) {
            var args = this._args(arguments, ['text']);
            var node = this._makeNode(args.parent, 'title', args.settings || {});
            node.appendChild(this._svg.ownerDocument.createTextNode(args.text));
            return node;
        },
        describe: function(parent, text, settings) {
            var args = this._args(arguments, ['text']);
            var node = this._makeNode(args.parent, 'desc', args.settings || {});
            node.appendChild(this._svg.ownerDocument.createTextNode(args.text));
            return node;
        },
        defs: function(parent, id, settings) {
            var args = this._args(arguments, ['id'], ['id']);
            return this._makeNode(args.parent, 'defs', $.extend((args.id ? {
                id: args.id
            } : {}), args.settings || {}));
        },
        symbol: function(parent, id, x1, y1, width, height, settings) {
            var args = this._args(arguments, ['id', 'x1', 'y1', 'width', 'height']);
            return this._makeNode(args.parent, 'symbol', $.extend({
                id: args.id,
                viewBox: args.x1 + ' ' + args.y1 + ' ' + args.width + ' ' + args.height
            }, args.settings || {}));
        },
        marker: function(parent, id, refX, refY, mWidth, mHeight, orient, settings) {
            var args = this._args(arguments, ['id', 'refX', 'refY', 'mWidth', 'mHeight', 'orient'], ['orient']);
            return this._makeNode(args.parent, 'marker', $.extend({
                id: args.id,
                refX: args.refX,
                refY: args.refY,
                markerWidth: args.mWidth,
                markerHeight: args.mHeight,
                orient: args.orient || 'auto'
            }, args.settings || {}));
        },
        style: function(parent, styles, settings) {
            var args = this._args(arguments, ['styles']);
            var node = this._makeNode(args.parent, 'style', $.extend({
                type: 'text/css'
            }, args.settings || {}));
            node.appendChild(this._svg.ownerDocument.createTextNode(args.styles));
            return node;
        },
        script: function(parent, script, type, settings) {
            var args = this._args(arguments, ['script', 'type'], ['type']);
            var node = this._makeNode(args.parent, 'script', $.extend({
                type: args.type || 'text/javascript'
            }, args.settings || {}));
            node.appendChild(this._svg.ownerDocument.createTextNode(args.script));
            if ($.svg._ie) {
                $.globalEval(args.script);
            }
            return node;
        },
        linearGradient: function(parent, id, stops, x1, y1, x2, y2, settings) {
            var args = this._args(arguments, ['id', 'stops', 'x1', 'y1', 'x2', 'y2'], ['x1']);
            var sets = $.extend({
                id: args.id
            }, (args.x1 != null ? {
                x1: args.x1,
                y1: args.y1,
                x2: args.x2,
                y2: args.y2
            } : {}));
            return this._gradient(args.parent, 'linearGradient', $.extend(sets, args.settings || {}), args.stops);
        },
        radialGradient: function(parent, id, stops, cx, cy, r, fx, fy, settings) {
            var args = this._args(arguments, ['id', 'stops', 'cx', 'cy', 'r', 'fx', 'fy'], ['cx']);
            var sets = $.extend({
                id: args.id
            }, (args.cx != null ? {
                cx: args.cx,
                cy: args.cy,
                r: args.r,
                fx: args.fx,
                fy: args.fy
            } : {}));
            return this._gradient(args.parent, 'radialGradient', $.extend(sets, args.settings || {}), args.stops);
        },
        _gradient: function(parent, name, settings, stops) {
            var node = this._makeNode(parent, name, settings);
            for (var i = 0; i < stops.length; i++) {
                var stop = stops[i];
                this._makeNode(node, 'stop', $.extend({
                    offset: stop[0],
                    stopColor: stop[1]
                }, (stop[2] != null ? {
                    stopOpacity: stop[2]
                } : {})));
            }
            return node;
        },
        pattern: function(parent, id, x, y, width, height, vx, vy, vwidth, vheight, settings) {
            var args = this._args(arguments, ['id', 'x', 'y', 'width', 'height', 'vx', 'vy', 'vwidth', 'vheight'], ['vx']);
            var sets = $.extend({
                id: args.id,
                x: args.x,
                y: args.y,
                width: args.width,
                height: args.height
            }, (args.vx != null ? {
                viewBox: args.vx + ' ' + args.vy + ' ' + args.vwidth + ' ' + args.vheight
            } : {}));
            return this._makeNode(args.parent, 'pattern', $.extend(sets, args.settings || {}));
        },
        clipPath: function(parent, id, units, settings) {
            var args = this._args(arguments, ['id', 'units']);
            args.units = args.units || 'userSpaceOnUse';
            return this._makeNode(args.parent, 'clipPath', $.extend({
                id: args.id,
                clipPathUnits: args.units
            }, args.settings || {}));
        },
        mask: function(parent, id, x, y, width, height, settings) {
            var args = this._args(arguments, ['id', 'x', 'y', 'width', 'height']);
            return this._makeNode(args.parent, 'mask', $.extend({
                id: args.id,
                x: args.x,
                y: args.y,
                width: args.width,
                height: args.height
            }, args.settings || {}));
        },
        createPath: function() {
            return new SVGPath();
        },
        createText: function() {
            return new SVGText();
        },
        svg: function(parent, x, y, width, height, vx, vy, vwidth, vheight, settings) {
            var args = this._args(arguments, ['x', 'y', 'width', 'height', 'vx', 'vy', 'vwidth', 'vheight'], ['vx']);
            var sets = $.extend({
                x: args.x,
                y: args.y,
                width: args.width,
                height: args.height
            }, (args.vx != null ? {
                viewBox: args.vx + ' ' + args.vy + ' ' + args.vwidth + ' ' + args.vheight
            } : {}));
            return this._makeNode(args.parent, 'svg', $.extend(sets, args.settings || {}));
        },
        group: function(parent, id, settings) {
            var args = this._args(arguments, ['id'], ['id']);
            return this._makeNode(args.parent, 'g', $.extend({
                id: args.id
            }, args.settings || {}));
        },
        use: function(parent, x, y, width, height, ref, settings) {
            var args = this._args(arguments, ['x', 'y', 'width', 'height', 'ref']);
            if (typeof args.x === 'string') {
                args.ref = args.x;
                args.settings = args.y;
                args.x = args.y = args.width = args.height = null;
            }
            var node = this._makeNode(args.parent, 'use', $.extend({
                x: args.x,
                y: args.y,
                width: args.width,
                height: args.height
            }, args.settings || {}));
            node.setAttributeNS($.svg.xlinkNS, 'href', args.ref);
            return node;
        },
        link: function(parent, ref, settings) {
            var args = this._args(arguments, ['ref']);
            var node = this._makeNode(args.parent, 'a', args.settings);
            node.setAttributeNS($.svg.xlinkNS, 'href', args.ref);
            return node;
        },
        image: function(parent, x, y, width, height, ref, settings) {
            var args = this._args(arguments, ['x', 'y', 'width', 'height', 'ref']);
            var node = this._makeNode(args.parent, 'image', $.extend({
                x: args.x,
                y: args.y,
                width: args.width,
                height: args.height
            }, args.settings || {}));
            node.setAttributeNS($.svg.xlinkNS, 'href', args.ref);
            return node;
        },
        path: function(parent, path, settings) {
            var args = this._args(arguments, ['path']);
            return this._makeNode(args.parent, 'path', $.extend({
                d: (args.path.path ? args.path.path() : args.path)
            }, args.settings || {}));
        },
        rect: function(parent, x, y, width, height, rx, ry, settings) {
            var args = this._args(arguments, ['x', 'y', 'width', 'height', 'rx', 'ry'], ['rx']);
            return this._makeNode(args.parent, 'rect', $.extend({
                x: args.x,
                y: args.y,
                width: args.width,
                height: args.height
            }, (args.rx ? {
                rx: args.rx,
                ry: args.ry
            } : {}), args.settings || {}));
        },
        circle: function(parent, cx, cy, r, settings) {
            var args = this._args(arguments, ['cx', 'cy', 'r']);
            return this._makeNode(args.parent, 'circle', $.extend({
                cx: args.cx,
                cy: args.cy,
                r: args.r
            }, args.settings || {}));
        },
        ellipse: function(parent, cx, cy, rx, ry, settings) {
            var args = this._args(arguments, ['cx', 'cy', 'rx', 'ry']);
            return this._makeNode(args.parent, 'ellipse', $.extend({
                cx: args.cx,
                cy: args.cy,
                rx: args.rx,
                ry: args.ry
            }, args.settings || {}));
        },
        line: function(parent, x1, y1, x2, y2, settings) {
            var args = this._args(arguments, ['x1', 'y1', 'x2', 'y2']);
            return this._makeNode(args.parent, 'line', $.extend({
                x1: args.x1,
                y1: args.y1,
                x2: args.x2,
                y2: args.y2
            }, args.settings || {}));
        },
        polyline: function(parent, points, settings) {
            var args = this._args(arguments, ['points']);
            return this._poly(args.parent, 'polyline', args.points, args.settings);
        },
        polygon: function(parent, points, settings) {
            var args = this._args(arguments, ['points']);
            return this._poly(args.parent, 'polygon', args.points, args.settings);
        },
        _poly: function(parent, name, points, settings) {
            var ps = '';
            for (var i = 0; i < points.length; i++) {
                ps += points[i].join() + ' ';
            }
            return this._makeNode(parent, name, $.extend({
                points: $.trim(ps)
            }, settings || {}));
        },
        text: function(parent, x, y, value, settings) {
            var args = this._args(arguments, ['x', 'y', 'value']);
            if (typeof args.x === 'string' && arguments.length < 4) {
                args.value = args.x;
                args.settings = args.y;
                args.x = args.y = null;
            }
            return this._text(args.parent, 'text', args.value, $.extend({
                x: (args.x && $.isArray(args.x) ? args.x.join(' ') : args.x),
                y: (args.y && $.isArray(args.y) ? args.y.join(' ') : args.y)
            }, args.settings || {}));
        },
        textpath: function(parent, path, value, settings) {
            var args = this._args(arguments, ['path', 'value']);
            var node = this._text(args.parent, 'textPath', args.value, args.settings || {});
            node.setAttributeNS($.svg.xlinkNS, 'href', args.path);
            return node;
        },
        _text: function(parent, name, value, settings) {
            var node = this._makeNode(parent, name, settings);
            if (typeof value === 'string') {
                node.appendChild(node.ownerDocument.createTextNode(value));
            } else {
                for (var i = 0; i < value._parts.length; i++) {
                    var part = value._parts[i];
                    if (part[0] === 'tspan') {
                        var child = this._makeNode(node, part[0], part[2]);
                        child.appendChild(node.ownerDocument.createTextNode(part[1]));
                        node.appendChild(child);
                    } else if (part[0] === 'tref') {
                        var child = this._makeNode(node, part[0], part[2]);
                        child.setAttributeNS($.svg.xlinkNS, 'href', part[1]);
                        node.appendChild(child);
                    } else if (part[0] === 'textpath') {
                        var set = $.extend({}, part[2]);
                        set.href = null;
                        var child = this._makeNode(node, part[0], set);
                        child.setAttributeNS($.svg.xlinkNS, 'href', part[2].href);
                        child.appendChild(node.ownerDocument.createTextNode(part[1]));
                        node.appendChild(child);
                    } else {
                        node.appendChild(node.ownerDocument.createTextNode(part[1]));
                    }
                }
            }
            return node;
        },
        other: function(parent, name, settings) {
            var args = this._args(arguments, ['name']);
            return this._makeNode(args.parent, args.name, args.settings || {});
        },
        _makeNode: function(parent, name, settings) {
            parent = parent || this._svg;
            var node = this._svg.ownerDocument.createElementNS($.svg.svgNS, name);
            for (var name in settings) {
                var value = settings[name];
                if (value != null && (typeof value !== 'string' || value !== '')) {
                    node.setAttribute($.svg._attrNames[name] || name, value);
                }
            }
            parent.appendChild(node);
            return node;
        },
        add: function(parent, node) {
            var args = this._args((arguments.length === 1 ? [null, parent] : arguments), ['node']);
            var svg = this;
            args.parent = args.parent || this._svg;
            args.node = (args.node.jquery ? args.node : $(args.node));
            try {
                args.parent.appendChild(args.node.cloneNode(true));
            } catch (e) {
                args.node.each(function() {
                    var child = svg._cloneAsSVG(this);
                    if (child) {
                        args.parent.appendChild(child);
                    }
                });
            }
            return this;
        },
        clone: function(parent, node) {
            var svg = this;
            var args = this._args((arguments.length === 1 ? [null, parent] : arguments), ['node']);
            args.parent = args.parent || this._svg;
            args.node = (args.node.jquery ? args.node : $(args.node));
            var newNodes = [];
            args.node.each(function() {
                var child = svg._cloneAsSVG(this);
                if (child) {
                    child.id = '';
                    args.parent.appendChild(child);
                    newNodes.push(child);
                }
            });
            return newNodes;
        },
        _cloneAsSVG: function(node) {
            var newNode = null;
            if (node.nodeType === 1) {
                newNode = this._svg.ownerDocument.createElementNS($.svg.svgNS, this._checkName(node.nodeName));
                for (var i = 0; i < node.attributes.length; i++) {
                    var attr = node.attributes.item(i);
                    if (attr.nodeName !== 'xmlns' && attr.nodeValue) {
                        if (attr.prefix === 'xlink') {
                            newNode.setAttributeNS($.svg.xlinkNS, attr.localName || attr.baseName, attr.nodeValue);
                        } else {
                            newNode.setAttribute(this._checkName(attr.nodeName), attr.nodeValue);
                        }
                    }
                }
                for (var i = 0; i < node.childNodes.length; i++) {
                    var child = this._cloneAsSVG(node.childNodes[i]);
                    if (child) {
                        newNode.appendChild(child);
                    }
                }
            } else if (node.nodeType === 3) {
                if ($.trim(node.nodeValue)) {
                    newNode = this._svg.ownerDocument.createTextNode(node.nodeValue);
                }
            } else if (node.nodeType === 4) {
                if ($.trim(node.nodeValue)) {
                    try {
                        newNode = this._svg.ownerDocument.createCDATASection(node.nodeValue);
                    } catch (e) {
                        newNode = this._svg.ownerDocument.createTextNode(node.nodeValue.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'));
                    }
                }
            }
            return newNode;
        },
        _checkName: function(name) {
            name = (name.substring(0, 1) >= 'A' && name.substring(0, 1) <= 'Z' ? name.toLowerCase() : name);
            return (name.substring(0, 4) === 'svg:' ? name.substring(4) : name);
        },
        load: function(url, settings) {
            settings = (typeof settings === 'boolean' ? {
                addTo: settings
            } : (typeof settings === 'function' ? {
                onLoad: settings
            } : (typeof settings === 'string' ? {
                parent: settings
            } : (typeof settings === 'object' && settings.nodeName ? {
                parent: settings
            } : (typeof settings === 'object' && settings.jquery ? {
                parent: settings
            } : settings || {})))));
            if (!settings.parent && !settings.addTo) {
                this.clear(false);
            }
            var size = [this._svg.getAttribute('width'), this._svg.getAttribute('height')];
            var wrapper = this;
            var reportError = function(message) {
                message = $.svg.local.errorLoadingText + ': ' + message;
                if (settings.onLoad) {
                    settings.onLoad.apply(wrapper._container || wrapper._svg, [wrapper, message]);
                } else {
                    wrapper.text(null, 10, 20, message);
                }
            };
            var loadXML4IE = function(data) {
                var xml = new ActiveXObject('Microsoft.XMLDOM');
                xml.validateOnParse = false;
                xml.resolveExternals = false;
                xml.async = false;
                xml.loadXML(data);
                if (xml.parseError.errorCode !== 0) {
                    reportError(xml.parseError.reason);
                    return null;
                }
                return xml;
            };
            var loadSVG = function(data) {
                if (!data) {
                    return;
                }
                if (data.documentElement.nodeName !== 'svg') {
                    var errors = data.getElementsByTagName('parsererror');
                    var messages = (errors.length ? errors[0].getElementsByTagName('div') : []);
                    reportError(!errors.length ? '???' : (messages.length ? messages[0] : errors[0]).firstChild.nodeValue);
                    return;
                }
                var parent = (settings.parent ? $(settings.parent)[0] : wrapper._svg);
                var attrs = {};
                for (var i = 0; i < data.documentElement.attributes.length; i++) {
                    var attr = data.documentElement.attributes.item(i);
                    if (!(attr.nodeName === 'version' || attr.nodeName.substring(0, 5) === 'xmlns')) {
                        attrs[attr.nodeName] = attr.nodeValue;
                    }
                }
                wrapper.configure(parent, attrs, !settings.parent);
                var nodes = data.documentElement.childNodes;
                for (var i = 0; i < nodes.length; i++) {
                    try {
                        parent.appendChild(wrapper._svg.ownerDocument.importNode(nodes[i], true));
                        if (nodes[i].nodeName === 'script') {
                            $.globalEval(nodes[i].textContent);
                        }
                    } catch (e) {
                        wrapper.add(parent, nodes[i]);
                    }
                }
                if (!settings.keepRelativeLinks && url.match('/')) {
                    var base = url.replace(/\/[^\/]*$/, '/');
                    $('*', parent).each(function() {
                        var href = $(this).attr('xlink:href');
                        if (href && !href.match(/(^[a-z][-a-z0-9+.]*:.*$)|(^\/.*$)|(^#.*$)/i)) {
                            $(this).attr('xlink:href', base + href);
                        }
                    });
                }
                if (!settings.changeSize) {
                    wrapper.configure(parent, {
                        width: size[0],
                        height: size[1]
                    });
                }
                if (settings.onLoad) {
                    settings.onLoad.apply(wrapper._container || wrapper._svg, [wrapper]);
                }
            };
            if (url.match('<svg')) {
                try {
                    loadSVG(new DOMParser().parseFromString(url, 'text/xml'));
                } catch (e) {
                    reportError(e);
                }
            } else {
                $.ajax({
                    url: url,
                    dataType: 'xml',
                    success: function(xml) {
                        loadSVG(xml);
                    },
                    error: function(http, message, exc) {
                        reportError(message + (exc ? ' ' + exc.message : ''));
                    }
                });
            }
            return this;
        },
        remove: function(node) {
            node = (node.jquery ? node[0] : node);
            node.parentNode.removeChild(node);
            return this;
        },
        clear: function(attrsToo) {
            if (attrsToo) {
                this.configure({}, true);
            }
            while (this._svg.firstChild) {
                this._svg.removeChild(this._svg.firstChild);
            }
            return this;
        },
        toSVG: function(node) {
            node = node || this._svg;
            return (typeof XMLSerializer === 'undefined' ? this._toSVG(node) : new XMLSerializer().serializeToString(node));
        },
        _toSVG: function(node) {
            var svgDoc = '';
            if (!node) {
                return svgDoc;
            }
            if (node.nodeType === 3) {
                svgDoc = node.nodeValue;
            } else if (node.nodeType === 4) {
                svgDoc = '<![CDATA[' + node.nodeValue + ']]>';
            } else {
                svgDoc = '<' + node.nodeName;
                if (node.attributes) {
                    for (var i = 0; i < node.attributes.length; i++) {
                        var attr = node.attributes.item(i);
                        if (!($.trim(attr.nodeValue) === '' || attr.nodeValue.match(/^\[object/) || attr.nodeValue.match(/^function/))) {
                            svgDoc += ' ' + (attr.namespaceURI === $.svg.xlinkNS ? 'xlink:' : '') +
                                attr.nodeName + '="' + attr.nodeValue + '"';
                        }
                    }
                }
                if (node.firstChild) {
                    svgDoc += '>';
                    var child = node.firstChild;
                    while (child) {
                        svgDoc += this._toSVG(child);
                        child = child.nextSibling;
                    }
                    svgDoc += '</' + node.nodeName + '>';
                } else {
                    svgDoc += '/>';
                }
            }
            return svgDoc;
        }
    });

    function SVGPath() {
        this._path = '';
    }
    $.extend(SVGPath.prototype, {
        reset: function() {
            this._path = '';
            return this;
        },
        move: function(x, y, relative) {
            relative = ($.isArray(x) ? y : relative);
            return this._coords((relative ? 'm' : 'M'), x, y);
        },
        line: function(x, y, relative) {
            relative = ($.isArray(x) ? y : relative);
            return this._coords((relative ? 'l' : 'L'), x, y);
        },
        horiz: function(x, relative) {
            this._path += (relative ? 'h' : 'H') + ($.isArray(x) ? x.join(' ') : x);
            return this;
        },
        vert: function(y, relative) {
            this._path += (relative ? 'v' : 'V') + ($.isArray(y) ? y.join(' ') : y);
            return this;
        },
        curveC: function(x1, y1, x2, y2, x, y, relative) {
            relative = ($.isArray(x1) ? y1 : relative);
            return this._coords((relative ? 'c' : 'C'), x1, y1, x2, y2, x, y);
        },
        smoothC: function(x2, y2, x, y, relative) {
            relative = ($.isArray(x2) ? y2 : relative);
            return this._coords((relative ? 's' : 'S'), x2, y2, x, y);
        },
        curveQ: function(x1, y1, x, y, relative) {
            relative = ($.isArray(x1) ? y1 : relative);
            return this._coords((relative ? 'q' : 'Q'), x1, y1, x, y);
        },
        smoothQ: function(x, y, relative) {
            relative = ($.isArray(x) ? y : relative);
            return this._coords((relative ? 't' : 'T'), x, y);
        },
        _coords: function(cmd, x1, y1, x2, y2, x3, y3) {
            if ($.isArray(x1)) {
                for (var i = 0; i < x1.length; i++) {
                    var cs = x1[i];
                    this._path += (i === 0 ? cmd : ' ') + cs[0] + ',' + cs[1] + (cs.length < 4 ? '' : ' ' + cs[2] + ',' + cs[3] + (cs.length < 6 ? '' : ' ' + cs[4] + ',' + cs[5]));
                }
            } else {
                this._path += cmd + x1 + ',' + y1 +
                    (x2 == null ? '' : ' ' + x2 + ',' + y2 + (x3 == null ? '' : ' ' + x3 + ',' + y3));
            }
            return this;
        },
        arc: function(rx, ry, xRotate, large, clockwise, x, y, relative) {
            relative = ($.isArray(rx) ? ry : relative);
            this._path += (relative ? 'a' : 'A');
            if ($.isArray(rx)) {
                for (var i = 0; i < rx.length; i++) {
                    var cs = rx[i];
                    this._path += (i === 0 ? '' : ' ') + cs[0] + ',' + cs[1] + ' ' +
                        cs[2] + ' ' + (cs[3] ? '1' : '0') + ',' + (cs[4] ? '1' : '0') + ' ' + cs[5] + ',' + cs[6];
                }
            } else {
                this._path += rx + ',' + ry + ' ' + xRotate + ' ' +
                    (large ? '1' : '0') + ',' + (clockwise ? '1' : '0') + ' ' + x + ',' + y;
            }
            return this;
        },
        close: function() {
            this._path += 'z';
            return this;
        },
        path: function() {
            return this._path;
        }
    });
    SVGPath.prototype.moveTo = SVGPath.prototype.move;
    SVGPath.prototype.lineTo = SVGPath.prototype.line;
    SVGPath.prototype.horizTo = SVGPath.prototype.horiz;
    SVGPath.prototype.vertTo = SVGPath.prototype.vert;
    SVGPath.prototype.curveCTo = SVGPath.prototype.curveC;
    SVGPath.prototype.smoothCTo = SVGPath.prototype.smoothC;
    SVGPath.prototype.curveQTo = SVGPath.prototype.curveQ;
    SVGPath.prototype.smoothQTo = SVGPath.prototype.smoothQ;
    SVGPath.prototype.arcTo = SVGPath.prototype.arc;

    function SVGText() {
        this._parts = [];
    }
    $.extend(SVGText.prototype, {
        reset: function() {
            this._parts = [];
            return this;
        },
        string: function(value) {
            this._parts.push(['text', value]);
            return this;
        },
        span: function(value, settings) {
            this._parts.push(['tspan', value, settings]);
            return this;
        },
        ref: function(id, settings) {
            this._parts.push(['tref', id, settings]);
            return this;
        },
        path: function(id, value, settings) {
            this._parts.push(['textpath', value, $.extend({
                href: id
            }, settings || {})]);
            return this;
        }
    });
    $.fn.svg = function(options) {
        var otherArgs = Array.prototype.slice.call(arguments, 1);
        if (typeof options === 'string' && options === 'get') {
            return $.svg['_' + options + 'SVG'].apply($.svg, [this[0]].concat(otherArgs));
        }
        return this.each(function() {
            if (typeof options === 'string') {
                $.svg['_' + options + 'SVG'].apply($.svg, [this].concat(otherArgs));
            } else {
                $.svg._attachSVG(this, options || {});
            }
        });
    };
    $.svg = new SVGManager();
})(jQuery);
! function() {
    function n(n) {
        return n && (n.ownerDocument || n.document || n).documentElement
    }

    function t(n) {
        return n && (n.ownerDocument && n.ownerDocument.defaultView || n.document && n || n.defaultView)
    }

    function e(n, t) {
        return t > n ? -1 : n > t ? 1 : n >= t ? 0 : 0 / 0
    }

    function r(n) {
        return null === n ? 0 / 0 : +n
    }

    function u(n) {
        return !isNaN(n)
    }

    function i(n) {
        return {
            left: function(t, e, r, u) {
                for (arguments.length < 3 && (r = 0), arguments.length < 4 && (u = t.length); u > r;) {
                    var i = r + u >>> 1;
                    n(t[i], e) < 0 ? r = i + 1 : u = i
                }
                return r
            },
            right: function(t, e, r, u) {
                for (arguments.length < 3 && (r = 0), arguments.length < 4 && (u = t.length); u > r;) {
                    var i = r + u >>> 1;
                    n(t[i], e) > 0 ? u = i : r = i + 1
                }
                return r
            }
        }
    }

    function o(n) {
        return n.length
    }

    function a(n) {
        for (var t = 1; n * t % 1;) t *= 10;
        return t
    }

    function c(n, t) {
        for (var e in t) Object.defineProperty(n.prototype, e, {
            value: t[e],
            enumerable: !1
        })
    }

    function l() {
        this._ = Object.create(null)
    }

    function s(n) {
        return (n += "") === pa || n[0] === va ? va + n : n
    }

    function f(n) {
        return (n += "")[0] === va ? n.slice(1) : n
    }

    function h(n) {
        return s(n) in this._
    }

    function g(n) {
        return (n = s(n)) in this._ && delete this._[n]
    }

    function p() {
        var n = [];
        for (var t in this._) n.push(f(t));
        return n
    }

    function v() {
        var n = 0;
        for (var t in this._) ++n;
        return n
    }

    function d() {
        for (var n in this._) return !1;
        return !0
    }

    function m() {
        this._ = Object.create(null)
    }

    function y(n) {
        return n
    }

    function M(n, t, e) {
        return function() {
            var r = e.apply(t, arguments);
            return r === t ? n : r
        }
    }

    function x(n, t) {
        if (t in n) return t;
        t = t.charAt(0).toUpperCase() + t.slice(1);
        for (var e = 0, r = da.length; r > e; ++e) {
            var u = da[e] + t;
            if (u in n) return u
        }
    }

    function b() {}

    function _() {}

    function w(n) {
        function t() {
            for (var t, r = e, u = -1, i = r.length; ++u < i;)(t = r[u].on) && t.apply(this, arguments);
            return n
        }
        var e = [],
            r = new l;
        return t.on = function(t, u) {
            var i, o = r.get(t);
            return arguments.length < 2 ? o && o.on : (o && (o.on = null, e = e.slice(0, i = e.indexOf(o)).concat(e.slice(i + 1)), r.remove(t)), u && e.push(r.set(t, {
                on: u
            })), n)
        }, t
    }

    function S() {
        ta.event.preventDefault()
    }

    function k() {
        for (var n, t = ta.event; n = t.sourceEvent;) t = n;
        return t
    }

    function E(n) {
        for (var t = new _, e = 0, r = arguments.length; ++e < r;) t[arguments[e]] = w(t);
        return t.of = function(e, r) {
            return function(u) {
                try {
                    var i = u.sourceEvent = ta.event;
                    u.target = n, ta.event = u, t[u.type].apply(e, r)
                } finally {
                    ta.event = i
                }
            }
        }, t
    }

    function A(n) {
        return ya(n, _a), n
    }

    function N(n) {
        return "function" == typeof n ? n : function() {
            return Ma(n, this)
        }
    }

    function C(n) {
        return "function" == typeof n ? n : function() {
            return xa(n, this)
        }
    }

    function z(n, t) {
        function e() {
            this.removeAttribute(n)
        }

        function r() {
            this.removeAttributeNS(n.space, n.local)
        }

        function u() {
            this.setAttribute(n, t)
        }

        function i() {
            this.setAttributeNS(n.space, n.local, t)
        }

        function o() {
            var e = t.apply(this, arguments);
            null == e ? this.removeAttribute(n) : this.setAttribute(n, e)
        }

        function a() {
            var e = t.apply(this, arguments);
            null == e ? this.removeAttributeNS(n.space, n.local) : this.setAttributeNS(n.space, n.local, e)
        }
        return n = ta.ns.qualify(n), null == t ? n.local ? r : e : "function" == typeof t ? n.local ? a : o : n.local ? i : u
    }

    function q(n) {
        return n.trim().replace(/\s+/g, " ")
    }

    function L(n) {
        return new RegExp("(?:^|\\s+)" + ta.requote(n) + "(?:\\s+|$)", "g")
    }

    function T(n) {
        return (n + "").trim().split(/^|\s+/)
    }

    function R(n, t) {
        function e() {
            for (var e = -1; ++e < u;) n[e](this, t)
        }

        function r() {
            for (var e = -1, r = t.apply(this, arguments); ++e < u;) n[e](this, r)
        }
        n = T(n).map(D);
        var u = n.length;
        return "function" == typeof t ? r : e
    }

    function D(n) {
        var t = L(n);
        return function(e, r) {
            if (u = e.classList) return r ? u.add(n) : u.remove(n);
            var u = e.getAttribute("class") || "";
            r ? (t.lastIndex = 0, t.test(u) || e.setAttribute("class", q(u + " " + n))) : e.setAttribute("class", q(u.replace(t, " ")))
        }
    }

    function P(n, t, e) {
        function r() {
            this.style.removeProperty(n)
        }

        function u() {
            this.style.setProperty(n, t, e)
        }

        function i() {
            var r = t.apply(this, arguments);
            null == r ? this.style.removeProperty(n) : this.style.setProperty(n, r, e)
        }
        return null == t ? r : "function" == typeof t ? i : u
    }

    function U(n, t) {
        function e() {
            delete this[n]
        }

        function r() {
            this[n] = t
        }

        function u() {
            var e = t.apply(this, arguments);
            null == e ? delete this[n] : this[n] = e
        }
        return null == t ? e : "function" == typeof t ? u : r
    }

    function j(n) {
        function t() {
            var t = this.ownerDocument,
                e = this.namespaceURI;
            return e ? t.createElementNS(e, n) : t.createElement(n)
        }

        function e() {
            return this.ownerDocument.createElementNS(n.space, n.local)
        }
        return "function" == typeof n ? n : (n = ta.ns.qualify(n)).local ? e : t
    }

    function F() {
        var n = this.parentNode;
        n && n.removeChild(this)
    }

    function H(n) {
        return {
            __data__: n
        }
    }

    function O(n) {
        return function() {
            return ba(this, n)
        }
    }

    function I(n) {
        return arguments.length || (n = e),
            function(t, e) {
                return t && e ? n(t.__data__, e.__data__) : !t - !e
            }
    }

    function Y(n, t) {
        for (var e = 0, r = n.length; r > e; e++)
            for (var u, i = n[e], o = 0, a = i.length; a > o; o++)(u = i[o]) && t(u, o, e);
        return n
    }

    function Z(n) {
        return ya(n, Sa), n
    }

    function V(n) {
        var t, e;
        return function(r, u, i) {
            var o, a = n[i].update,
                c = a.length;
            for (i != e && (e = i, t = 0), u >= t && (t = u + 1); !(o = a[t]) && ++t < c;);
            return o
        }
    }

    function X(n, t, e) {
        function r() {
            var t = this[o];
            t && (this.removeEventListener(n, t, t.$), delete this[o])
        }

        function u() {
            var u = c(t, ra(arguments));
            r.call(this), this.addEventListener(n, this[o] = u, u.$ = e), u._ = t
        }

        function i() {
            var t, e = new RegExp("^__on([^.]+)" + ta.requote(n) + "$");
            for (var r in this)
                if (t = r.match(e)) {
                    var u = this[r];
                    this.removeEventListener(t[1], u, u.$), delete this[r]
                }
        }
        var o = "__on" + n,
            a = n.indexOf("."),
            c = $;
        a > 0 && (n = n.slice(0, a));
        var l = ka.get(n);
        return l && (n = l, c = B), a ? t ? u : r : t ? b : i
    }

    function $(n, t) {
        return function(e) {
            var r = ta.event;
            ta.event = e, t[0] = this.__data__;
            try {
                n.apply(this, t)
            } finally {
                ta.event = r
            }
        }
    }

    function B(n, t) {
        var e = $(n, t);
        return function(n) {
            var t = this,
                r = n.relatedTarget;
            r && (r === t || 8 & r.compareDocumentPosition(t)) || e.call(t, n)
        }
    }

    function W(e) {
        var r = ".dragsuppress-" + ++Aa,
            u = "click" + r,
            i = ta.select(t(e)).on("touchmove" + r, S).on("dragstart" + r, S).on("selectstart" + r, S);
        if (null == Ea && (Ea = "onselectstart" in e ? !1 : x(e.style, "userSelect")), Ea) {
            var o = n(e).style,
                a = o[Ea];
            o[Ea] = "none"
        }
        return function(n) {
            if (i.on(r, null), Ea && (o[Ea] = a), n) {
                var t = function() {
                    i.on(u, null)
                };
                i.on(u, function() {
                    S(), t()
                }, !0), setTimeout(t, 0)
            }
        }
    }

    function J(n, e) {
        e.changedTouches && (e = e.changedTouches[0]);
        var r = n.ownerSVGElement || n;
        if (r.createSVGPoint) {
            var u = r.createSVGPoint();
            if (0 > Na) {
                var i = t(n);
                if (i.scrollX || i.scrollY) {
                    r = ta.select("body").append("svg").style({
                        position: "absolute",
                        top: 0,
                        left: 0,
                        margin: 0,
                        padding: 0,
                        border: "none"
                    }, "important");
                    var o = r[0][0].getScreenCTM();
                    Na = !(o.f || o.e), r.remove()
                }
            }
            return Na ? (u.x = e.pageX, u.y = e.pageY) : (u.x = e.clientX, u.y = e.clientY), u = u.matrixTransform(n.getScreenCTM().inverse()), [u.x, u.y]
        }
        var a = n.getBoundingClientRect();
        return [e.clientX - a.left - n.clientLeft, e.clientY - a.top - n.clientTop]
    }

    function G() {
        return ta.event.changedTouches[0].identifier
    }

    function K(n) {
        return n > 0 ? 1 : 0 > n ? -1 : 0
    }

    function Q(n, t, e) {
        return (t[0] - n[0]) * (e[1] - n[1]) - (t[1] - n[1]) * (e[0] - n[0])
    }

    function nt(n) {
        return n > 1 ? 0 : -1 > n ? qa : Math.acos(n)
    }

    function tt(n) {
        return n > 1 ? Ra : -1 > n ? -Ra : Math.asin(n)
    }

    function et(n) {
        return ((n = Math.exp(n)) - 1 / n) / 2
    }

    function rt(n) {
        return ((n = Math.exp(n)) + 1 / n) / 2
    }

    function ut(n) {
        return ((n = Math.exp(2 * n)) - 1) / (n + 1)
    }

    function it(n) {
        return (n = Math.sin(n / 2)) * n
    }

    function ot() {}

    function at(n, t, e) {
        return this instanceof at ? (this.h = +n, this.s = +t, void(this.l = +e)) : arguments.length < 2 ? n instanceof at ? new at(n.h, n.s, n.l) : bt("" + n, _t, at) : new at(n, t, e)
    }

    function ct(n, t, e) {
        function r(n) {
            return n > 360 ? n -= 360 : 0 > n && (n += 360), 60 > n ? i + (o - i) * n / 60 : 180 > n ? o : 240 > n ? i + (o - i) * (240 - n) / 60 : i
        }

        function u(n) {
            return Math.round(255 * r(n))
        }
        var i, o;
        return n = isNaN(n) ? 0 : (n %= 360) < 0 ? n + 360 : n, t = isNaN(t) ? 0 : 0 > t ? 0 : t > 1 ? 1 : t, e = 0 > e ? 0 : e > 1 ? 1 : e, o = .5 >= e ? e * (1 + t) : e + t - e * t, i = 2 * e - o, new mt(u(n + 120), u(n), u(n - 120))
    }

    function lt(n, t, e) {
        return this instanceof lt ? (this.h = +n, this.c = +t, void(this.l = +e)) : arguments.length < 2 ? n instanceof lt ? new lt(n.h, n.c, n.l) : n instanceof ft ? gt(n.l, n.a, n.b) : gt((n = wt((n = ta.rgb(n)).r, n.g, n.b)).l, n.a, n.b) : new lt(n, t, e)
    }

    function st(n, t, e) {
        return isNaN(n) && (n = 0), isNaN(t) && (t = 0), new ft(e, Math.cos(n *= Da) * t, Math.sin(n) * t)
    }

    function ft(n, t, e) {
        return this instanceof ft ? (this.l = +n, this.a = +t, void(this.b = +e)) : arguments.length < 2 ? n instanceof ft ? new ft(n.l, n.a, n.b) : n instanceof lt ? st(n.h, n.c, n.l) : wt((n = mt(n)).r, n.g, n.b) : new ft(n, t, e)
    }

    function ht(n, t, e) {
        var r = (n + 16) / 116,
            u = r + t / 500,
            i = r - e / 200;
        return u = pt(u) * Xa, r = pt(r) * $a, i = pt(i) * Ba, new mt(dt(3.2404542 * u - 1.5371385 * r - .4985314 * i), dt(-.969266 * u + 1.8760108 * r + .041556 * i), dt(.0556434 * u - .2040259 * r + 1.0572252 * i))
    }

    function gt(n, t, e) {
        return n > 0 ? new lt(Math.atan2(e, t) * Pa, Math.sqrt(t * t + e * e), n) : new lt(0 / 0, 0 / 0, n)
    }

    function pt(n) {
        return n > .206893034 ? n * n * n : (n - 4 / 29) / 7.787037
    }

    function vt(n) {
        return n > .008856 ? Math.pow(n, 1 / 3) : 7.787037 * n + 4 / 29
    }

    function dt(n) {
        return Math.round(255 * (.00304 >= n ? 12.92 * n : 1.055 * Math.pow(n, 1 / 2.4) - .055))
    }

    function mt(n, t, e) {
        return this instanceof mt ? (this.r = ~~n, this.g = ~~t, void(this.b = ~~e)) : arguments.length < 2 ? n instanceof mt ? new mt(n.r, n.g, n.b) : bt("" + n, mt, ct) : new mt(n, t, e)
    }

    function yt(n) {
        return new mt(n >> 16, n >> 8 & 255, 255 & n)
    }

    function Mt(n) {
        return yt(n) + ""
    }

    function xt(n) {
        return 16 > n ? "0" + Math.max(0, n).toString(16) : Math.min(255, n).toString(16)
    }

    function bt(n, t, e) {
        var r, u, i, o = 0,
            a = 0,
            c = 0;
        if (r = /([a-z]+)\((.*)\)/.exec(n = n.toLowerCase())) switch (u = r[2].split(","), r[1]) {
            case "hsl":
                return e(parseFloat(u[0]), parseFloat(u[1]) / 100, parseFloat(u[2]) / 100);
            case "rgb":
                return t(kt(u[0]), kt(u[1]), kt(u[2]))
        }
        return (i = Ga.get(n)) ? t(i.r, i.g, i.b) : (null == n || "#" !== n.charAt(0) || isNaN(i = parseInt(n.slice(1), 16)) || (4 === n.length ? (o = (3840 & i) >> 4, o = o >> 4 | o, a = 240 & i, a = a >> 4 | a, c = 15 & i, c = c << 4 | c) : 7 === n.length && (o = (16711680 & i) >> 16, a = (65280 & i) >> 8, c = 255 & i)), t(o, a, c))
    }

    function _t(n, t, e) {
        var r, u, i = Math.min(n /= 255, t /= 255, e /= 255),
            o = Math.max(n, t, e),
            a = o - i,
            c = (o + i) / 2;
        return a ? (u = .5 > c ? a / (o + i) : a / (2 - o - i), r = n == o ? (t - e) / a + (e > t ? 6 : 0) : t == o ? (e - n) / a + 2 : (n - t) / a + 4, r *= 60) : (r = 0 / 0, u = c > 0 && 1 > c ? 0 : r), new at(r, u, c)
    }

    function wt(n, t, e) {
        n = St(n), t = St(t), e = St(e);
        var r = vt((.4124564 * n + .3575761 * t + .1804375 * e) / Xa),
            u = vt((.2126729 * n + .7151522 * t + .072175 * e) / $a),
            i = vt((.0193339 * n + .119192 * t + .9503041 * e) / Ba);
        return ft(116 * u - 16, 500 * (r - u), 200 * (u - i))
    }

    function St(n) {
        return (n /= 255) <= .04045 ? n / 12.92 : Math.pow((n + .055) / 1.055, 2.4)
    }

    function kt(n) {
        var t = parseFloat(n);
        return "%" === n.charAt(n.length - 1) ? Math.round(2.55 * t) : t
    }

    function Et(n) {
        return "function" == typeof n ? n : function() {
            return n
        }
    }

    function At(n) {
        return function(t, e, r) {
            return 2 === arguments.length && "function" == typeof e && (r = e, e = null), Nt(t, e, n, r)
        }
    }

    function Nt(n, t, e, r) {
        function u() {
            var n, t = c.status;
            if (!t && zt(c) || t >= 200 && 300 > t || 304 === t) {
                try {
                    n = e.call(i, c)
                } catch (r) {
                    return void o.error.call(i, r)
                }
                o.load.call(i, n)
            } else o.error.call(i, c)
        }
        var i = {},
            o = ta.dispatch("beforesend", "progress", "load", "error"),
            a = {},
            c = new XMLHttpRequest,
            l = null;
        return !this.XDomainRequest || "withCredentials" in c || !/^(http(s)?:)?\/\//.test(n) || (c = new XDomainRequest), "onload" in c ? c.onload = c.onerror = u : c.onreadystatechange = function() {
            c.readyState > 3 && u()
        }, c.onprogress = function(n) {
            var t = ta.event;
            ta.event = n;
            try {
                o.progress.call(i, c)
            } finally {
                ta.event = t
            }
        }, i.header = function(n, t) {
            return n = (n + "").toLowerCase(), arguments.length < 2 ? a[n] : (null == t ? delete a[n] : a[n] = t + "", i)
        }, i.mimeType = function(n) {
            return arguments.length ? (t = null == n ? null : n + "", i) : t
        }, i.responseType = function(n) {
            return arguments.length ? (l = n, i) : l
        }, i.response = function(n) {
            return e = n, i
        }, ["get", "post"].forEach(function(n) {
            i[n] = function() {
                return i.send.apply(i, [n].concat(ra(arguments)))
            }
        }), i.send = function(e, r, u) {
            if (2 === arguments.length && "function" == typeof r && (u = r, r = null), c.open(e, n, !0), null == t || "accept" in a || (a.accept = t + ",*/*"), c.setRequestHeader)
                for (var s in a) c.setRequestHeader(s, a[s]);
            return null != t && c.overrideMimeType && c.overrideMimeType(t), null != l && (c.responseType = l), null != u && i.on("error", u).on("load", function(n) {
                u(null, n)
            }), o.beforesend.call(i, c), c.send(null == r ? null : r), i
        }, i.abort = function() {
            return c.abort(), i
        }, ta.rebind(i, o, "on"), null == r ? i : i.get(Ct(r))
    }

    function Ct(n) {
        return 1 === n.length ? function(t, e) {
            n(null == t ? e : null)
        } : n
    }

    function zt(n) {
        var t = n.responseType;
        return t && "text" !== t ? n.response : n.responseText
    }

    function qt() {
        var n = Lt(),
            t = Tt() - n;
        t > 24 ? (isFinite(t) && (clearTimeout(tc), tc = setTimeout(qt, t)), nc = 0) : (nc = 1, rc(qt))
    }

    function Lt() {
        var n = Date.now();
        for (ec = Ka; ec;) n >= ec.t && (ec.f = ec.c(n - ec.t)), ec = ec.n;
        return n
    }

    function Tt() {
        for (var n, t = Ka, e = 1 / 0; t;) t.f ? t = n ? n.n = t.n : Ka = t.n : (t.t < e && (e = t.t), t = (n = t).n);
        return Qa = n, e
    }

    function Rt(n, t) {
        return t - (n ? Math.ceil(Math.log(n) / Math.LN10) : 1)
    }

    function Dt(n, t) {
        var e = Math.pow(10, 3 * ga(8 - t));
        return {
            scale: t > 8 ? function(n) {
                return n / e
            } : function(n) {
                return n * e
            },
            symbol: n
        }
    }

    function Pt(n) {
        var t = n.decimal,
            e = n.thousands,
            r = n.grouping,
            u = n.currency,
            i = r && e ? function(n, t) {
                for (var u = n.length, i = [], o = 0, a = r[0], c = 0; u > 0 && a > 0 && (c + a + 1 > t && (a = Math.max(1, t - c)), i.push(n.substring(u -= a, u + a)), !((c += a + 1) > t));) a = r[o = (o + 1) % r.length];
                return i.reverse().join(e)
            } : y;
        return function(n) {
            var e = ic.exec(n),
                r = e[1] || " ",
                o = e[2] || ">",
                a = e[3] || "-",
                c = e[4] || "",
                l = e[5],
                s = +e[6],
                f = e[7],
                h = e[8],
                g = e[9],
                p = 1,
                v = "",
                d = "",
                m = !1,
                y = !0;
            switch (h && (h = +h.substring(1)), (l || "0" === r && "=" === o) && (l = r = "0", o = "="), g) {
                case "n":
                    f = !0, g = "g";
                    break;
                case "%":
                    p = 100, d = "%", g = "f";
                    break;
                case "p":
                    p = 100, d = "%", g = "r";
                    break;
                case "b":
                case "o":
                case "x":
                case "X":
                    "#" === c && (v = "0" + g.toLowerCase());
                case "c":
                    y = !1;
                case "d":
                    m = !0, h = 0;
                    break;
                case "s":
                    p = -1, g = "r"
            }
            "$" === c && (v = u[0], d = u[1]), "r" != g || h || (g = "g"), null != h && ("g" == g ? h = Math.max(1, Math.min(21, h)) : ("e" == g || "f" == g) && (h = Math.max(0, Math.min(20, h)))), g = oc.get(g) || Ut;
            var M = l && f;
            return function(n) {
                var e = d;
                if (m && n % 1) return "";
                var u = 0 > n || 0 === n && 0 > 1 / n ? (n = -n, "-") : "-" === a ? "" : a;
                if (0 > p) {
                    var c = ta.formatPrefix(n, h);
                    n = c.scale(n), e = c.symbol + d
                } else n *= p;
                n = g(n, h);
                var x, b, _ = n.lastIndexOf(".");
                if (0 > _) {
                    var w = y ? n.lastIndexOf("e") : -1;
                    0 > w ? (x = n, b = "") : (x = n.substring(0, w), b = n.substring(w))
                } else x = n.substring(0, _), b = t + n.substring(_ + 1);
                !l && f && (x = i(x, 1 / 0));
                var S = v.length + x.length + b.length + (M ? 0 : u.length),
                    k = s > S ? new Array(S = s - S + 1).join(r) : "";
                return M && (x = i(k + x, k.length ? s - b.length : 1 / 0)), u += v, n = x + b, ("<" === o ? u + n + k : ">" === o ? k + u + n : "^" === o ? k.substring(0, S >>= 1) + u + n + k.substring(S) : u + (M ? n : k + n)) + e
            }
        }
    }

    function Ut(n) {
        return n + ""
    }

    function jt() {
        this._ = new Date(arguments.length > 1 ? Date.UTC.apply(this, arguments) : arguments[0])
    }

    function Ft(n, t, e) {
        function r(t) {
            var e = n(t),
                r = i(e, 1);
            return r - t > t - e ? e : r
        }

        function u(e) {
            return t(e = n(new cc(e - 1)), 1), e
        }

        function i(n, e) {
            return t(n = new cc(+n), e), n
        }

        function o(n, r, i) {
            var o = u(n),
                a = [];
            if (i > 1)
                for (; r > o;) e(o) % i || a.push(new Date(+o)), t(o, 1);
            else
                for (; r > o;) a.push(new Date(+o)), t(o, 1);
            return a
        }

        function a(n, t, e) {
            try {
                cc = jt;
                var r = new jt;
                return r._ = n, o(r, t, e)
            } finally {
                cc = Date
            }
        }
        n.floor = n, n.round = r, n.ceil = u, n.offset = i, n.range = o;
        var c = n.utc = Ht(n);
        return c.floor = c, c.round = Ht(r), c.ceil = Ht(u), c.offset = Ht(i), c.range = a, n
    }

    function Ht(n) {
        return function(t, e) {
            try {
                cc = jt;
                var r = new jt;
                return r._ = t, n(r, e)._
            } finally {
                cc = Date
            }
        }
    }

    function Ot(n) {
        function t(n) {
            function t(t) {
                for (var e, u, i, o = [], a = -1, c = 0; ++a < r;) 37 === n.charCodeAt(a) && (o.push(n.slice(c, a)), null != (u = sc[e = n.charAt(++a)]) && (e = n.charAt(++a)), (i = N[e]) && (e = i(t, null == u ? "e" === e ? " " : "0" : u)), o.push(e), c = a + 1);
                return o.push(n.slice(c, a)), o.join("")
            }
            var r = n.length;
            return t.parse = function(t) {
                var r = {
                        y: 1900,
                        m: 0,
                        d: 1,
                        H: 0,
                        M: 0,
                        S: 0,
                        L: 0,
                        Z: null
                    },
                    u = e(r, n, t, 0);
                if (u != t.length) return null;
                "p" in r && (r.H = r.H % 12 + 12 * r.p);
                var i = null != r.Z && cc !== jt,
                    o = new(i ? jt : cc);
                return "j" in r ? o.setFullYear(r.y, 0, r.j) : "w" in r && ("W" in r || "U" in r) ? (o.setFullYear(r.y, 0, 1), o.setFullYear(r.y, 0, "W" in r ? (r.w + 6) % 7 + 7 * r.W - (o.getDay() + 5) % 7 : r.w + 7 * r.U - (o.getDay() + 6) % 7)) : o.setFullYear(r.y, r.m, r.d), o.setHours(r.H + (r.Z / 100 | 0), r.M + r.Z % 100, r.S, r.L), i ? o._ : o
            }, t.toString = function() {
                return n
            }, t
        }

        function e(n, t, e, r) {
            for (var u, i, o, a = 0, c = t.length, l = e.length; c > a;) {
                if (r >= l) return -1;
                if (u = t.charCodeAt(a++), 37 === u) {
                    if (o = t.charAt(a++), i = C[o in sc ? t.charAt(a++) : o], !i || (r = i(n, e, r)) < 0) return -1
                } else if (u != e.charCodeAt(r++)) return -1
            }
            return r
        }

        function r(n, t, e) {
            _.lastIndex = 0;
            var r = _.exec(t.slice(e));
            return r ? (n.w = w.get(r[0].toLowerCase()), e + r[0].length) : -1
        }

        function u(n, t, e) {
            x.lastIndex = 0;
            var r = x.exec(t.slice(e));
            return r ? (n.w = b.get(r[0].toLowerCase()), e + r[0].length) : -1
        }

        function i(n, t, e) {
            E.lastIndex = 0;
            var r = E.exec(t.slice(e));
            return r ? (n.m = A.get(r[0].toLowerCase()), e + r[0].length) : -1
        }

        function o(n, t, e) {
            S.lastIndex = 0;
            var r = S.exec(t.slice(e));
            return r ? (n.m = k.get(r[0].toLowerCase()), e + r[0].length) : -1
        }

        function a(n, t, r) {
            return e(n, N.c.toString(), t, r)
        }

        function c(n, t, r) {
            return e(n, N.x.toString(), t, r)
        }

        function l(n, t, r) {
            return e(n, N.X.toString(), t, r)
        }

        function s(n, t, e) {
            var r = M.get(t.slice(e, e += 2).toLowerCase());
            return null == r ? -1 : (n.p = r, e)
        }
        var f = n.dateTime,
            h = n.date,
            g = n.time,
            p = n.periods,
            v = n.days,
            d = n.shortDays,
            m = n.months,
            y = n.shortMonths;
        t.utc = function(n) {
            function e(n) {
                try {
                    cc = jt;
                    var t = new cc;
                    return t._ = n, r(t)
                } finally {
                    cc = Date
                }
            }
            var r = t(n);
            return e.parse = function(n) {
                try {
                    cc = jt;
                    var t = r.parse(n);
                    return t && t._
                } finally {
                    cc = Date
                }
            }, e.toString = r.toString, e
        }, t.multi = t.utc.multi = ae;
        var M = ta.map(),
            x = Yt(v),
            b = Zt(v),
            _ = Yt(d),
            w = Zt(d),
            S = Yt(m),
            k = Zt(m),
            E = Yt(y),
            A = Zt(y);
        p.forEach(function(n, t) {
            M.set(n.toLowerCase(), t)
        });
        var N = {
                a: function(n) {
                    return d[n.getDay()]
                },
                A: function(n) {
                    return v[n.getDay()]
                },
                b: function(n) {
                    return y[n.getMonth()]
                },
                B: function(n) {
                    return m[n.getMonth()]
                },
                c: t(f),
                d: function(n, t) {
                    return It(n.getDate(), t, 2)
                },
                e: function(n, t) {
                    return It(n.getDate(), t, 2)
                },
                H: function(n, t) {
                    return It(n.getHours(), t, 2)
                },
                I: function(n, t) {
                    return It(n.getHours() % 12 || 12, t, 2)
                },
                j: function(n, t) {
                    return It(1 + ac.dayOfYear(n), t, 3)
                },
                L: function(n, t) {
                    return It(n.getMilliseconds(), t, 3)
                },
                m: function(n, t) {
                    return It(n.getMonth() + 1, t, 2)
                },
                M: function(n, t) {
                    return It(n.getMinutes(), t, 2)
                },
                p: function(n) {
                    return p[+(n.getHours() >= 12)]
                },
                S: function(n, t) {
                    return It(n.getSeconds(), t, 2)
                },
                U: function(n, t) {
                    return It(ac.sundayOfYear(n), t, 2)
                },
                w: function(n) {
                    return n.getDay()
                },
                W: function(n, t) {
                    return It(ac.mondayOfYear(n), t, 2)
                },
                x: t(h),
                X: t(g),
                y: function(n, t) {
                    return It(n.getFullYear() % 100, t, 2)
                },
                Y: function(n, t) {
                    return It(n.getFullYear() % 1e4, t, 4)
                },
                Z: ie,
                "%": function() {
                    return "%"
                }
            },
            C = {
                a: r,
                A: u,
                b: i,
                B: o,
                c: a,
                d: Qt,
                e: Qt,
                H: te,
                I: te,
                j: ne,
                L: ue,
                m: Kt,
                M: ee,
                p: s,
                S: re,
                U: Xt,
                w: Vt,
                W: $t,
                x: c,
                X: l,
                y: Wt,
                Y: Bt,
                Z: Jt,
                "%": oe
            };
        return t
    }

    function It(n, t, e) {
        var r = 0 > n ? "-" : "",
            u = (r ? -n : n) + "",
            i = u.length;
        return r + (e > i ? new Array(e - i + 1).join(t) + u : u)
    }

    function Yt(n) {
        return new RegExp("^(?:" + n.map(ta.requote).join("|") + ")", "i")
    }

    function Zt(n) {
        for (var t = new l, e = -1, r = n.length; ++e < r;) t.set(n[e].toLowerCase(), e);
        return t
    }

    function Vt(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 1));
        return r ? (n.w = +r[0], e + r[0].length) : -1
    }

    function Xt(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e));
        return r ? (n.U = +r[0], e + r[0].length) : -1
    }

    function $t(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e));
        return r ? (n.W = +r[0], e + r[0].length) : -1
    }

    function Bt(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 4));
        return r ? (n.y = +r[0], e + r[0].length) : -1
    }

    function Wt(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 2));
        return r ? (n.y = Gt(+r[0]), e + r[0].length) : -1
    }

    function Jt(n, t, e) {
        return /^[+-]\d{4}$/.test(t = t.slice(e, e + 5)) ? (n.Z = -t, e + 5) : -1
    }

    function Gt(n) {
        return n + (n > 68 ? 1900 : 2e3)
    }

    function Kt(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 2));
        return r ? (n.m = r[0] - 1, e + r[0].length) : -1
    }

    function Qt(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 2));
        return r ? (n.d = +r[0], e + r[0].length) : -1
    }

    function ne(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 3));
        return r ? (n.j = +r[0], e + r[0].length) : -1
    }

    function te(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 2));
        return r ? (n.H = +r[0], e + r[0].length) : -1
    }

    function ee(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 2));
        return r ? (n.M = +r[0], e + r[0].length) : -1
    }

    function re(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 2));
        return r ? (n.S = +r[0], e + r[0].length) : -1
    }

    function ue(n, t, e) {
        fc.lastIndex = 0;
        var r = fc.exec(t.slice(e, e + 3));
        return r ? (n.L = +r[0], e + r[0].length) : -1
    }

    function ie(n) {
        var t = n.getTimezoneOffset(),
            e = t > 0 ? "-" : "+",
            r = ga(t) / 60 | 0,
            u = ga(t) % 60;
        return e + It(r, "0", 2) + It(u, "0", 2)
    }

    function oe(n, t, e) {
        hc.lastIndex = 0;
        var r = hc.exec(t.slice(e, e + 1));
        return r ? e + r[0].length : -1
    }

    function ae(n) {
        for (var t = n.length, e = -1; ++e < t;) n[e][0] = this(n[e][0]);
        return function(t) {
            for (var e = 0, r = n[e]; !r[1](t);) r = n[++e];
            return r[0](t)
        }
    }

    function ce() {}

    function le(n, t, e) {
        var r = e.s = n + t,
            u = r - n,
            i = r - u;
        e.t = n - i + (t - u)
    }

    function se(n, t) {
        n && dc.hasOwnProperty(n.type) && dc[n.type](n, t)
    }

    function fe(n, t, e) {
        var r, u = -1,
            i = n.length - e;
        for (t.lineStart(); ++u < i;) r = n[u], t.point(r[0], r[1], r[2]);
        t.lineEnd()
    }

    function he(n, t) {
        var e = -1,
            r = n.length;
        for (t.polygonStart(); ++e < r;) fe(n[e], t, 1);
        t.polygonEnd()
    }

    function ge() {
        function n(n, t) {
            n *= Da, t = t * Da / 2 + qa / 4;
            var e = n - r,
                o = e >= 0 ? 1 : -1,
                a = o * e,
                c = Math.cos(t),
                l = Math.sin(t),
                s = i * l,
                f = u * c + s * Math.cos(a),
                h = s * o * Math.sin(a);
            yc.add(Math.atan2(h, f)), r = n, u = c, i = l
        }
        var t, e, r, u, i;
        Mc.point = function(o, a) {
            Mc.point = n, r = (t = o) * Da, u = Math.cos(a = (e = a) * Da / 2 + qa / 4), i = Math.sin(a)
        }, Mc.lineEnd = function() {
            n(t, e)
        }
    }

    function pe(n) {
        var t = n[0],
            e = n[1],
            r = Math.cos(e);
        return [r * Math.cos(t), r * Math.sin(t), Math.sin(e)]
    }

    function ve(n, t) {
        return n[0] * t[0] + n[1] * t[1] + n[2] * t[2]
    }

    function de(n, t) {
        return [n[1] * t[2] - n[2] * t[1], n[2] * t[0] - n[0] * t[2], n[0] * t[1] - n[1] * t[0]]
    }

    function me(n, t) {
        n[0] += t[0], n[1] += t[1], n[2] += t[2]
    }

    function ye(n, t) {
        return [n[0] * t, n[1] * t, n[2] * t]
    }

    function Me(n) {
        var t = Math.sqrt(n[0] * n[0] + n[1] * n[1] + n[2] * n[2]);
        n[0] /= t, n[1] /= t, n[2] /= t
    }

    function xe(n) {
        return [Math.atan2(n[1], n[0]), tt(n[2])]
    }

    function be(n, t) {
        return ga(n[0] - t[0]) < Ca && ga(n[1] - t[1]) < Ca
    }

    function _e(n, t) {
        n *= Da;
        var e = Math.cos(t *= Da);
        we(e * Math.cos(n), e * Math.sin(n), Math.sin(t))
    }

    function we(n, t, e) {
        ++xc, _c += (n - _c) / xc, wc += (t - wc) / xc, Sc += (e - Sc) / xc
    }

    function Se() {
        function n(n, u) {
            n *= Da;
            var i = Math.cos(u *= Da),
                o = i * Math.cos(n),
                a = i * Math.sin(n),
                c = Math.sin(u),
                l = Math.atan2(Math.sqrt((l = e * c - r * a) * l + (l = r * o - t * c) * l + (l = t * a - e * o) * l), t * o + e * a + r * c);
            bc += l, kc += l * (t + (t = o)), Ec += l * (e + (e = a)), Ac += l * (r + (r = c)), we(t, e, r)
        }
        var t, e, r;
        qc.point = function(u, i) {
            u *= Da;
            var o = Math.cos(i *= Da);
            t = o * Math.cos(u), e = o * Math.sin(u), r = Math.sin(i), qc.point = n, we(t, e, r)
        }
    }

    function ke() {
        qc.point = _e
    }

    function Ee() {
        function n(n, t) {
            n *= Da;
            var e = Math.cos(t *= Da),
                o = e * Math.cos(n),
                a = e * Math.sin(n),
                c = Math.sin(t),
                l = u * c - i * a,
                s = i * o - r * c,
                f = r * a - u * o,
                h = Math.sqrt(l * l + s * s + f * f),
                g = r * o + u * a + i * c,
                p = h && -nt(g) / h,
                v = Math.atan2(h, g);
            Nc += p * l, Cc += p * s, zc += p * f, bc += v, kc += v * (r + (r = o)), Ec += v * (u + (u = a)), Ac += v * (i + (i = c)), we(r, u, i)
        }
        var t, e, r, u, i;
        qc.point = function(o, a) {
            t = o, e = a, qc.point = n, o *= Da;
            var c = Math.cos(a *= Da);
            r = c * Math.cos(o), u = c * Math.sin(o), i = Math.sin(a), we(r, u, i)
        }, qc.lineEnd = function() {
            n(t, e), qc.lineEnd = ke, qc.point = _e
        }
    }

    function Ae(n, t) {
        function e(e, r) {
            return e = n(e, r), t(e[0], e[1])
        }
        return n.invert && t.invert && (e.invert = function(e, r) {
            return e = t.invert(e, r), e && n.invert(e[0], e[1])
        }), e
    }

    function Ne() {
        return !0
    }

    function Ce(n, t, e, r, u) {
        var i = [],
            o = [];
        if (n.forEach(function(n) {
                if (!((t = n.length - 1) <= 0)) {
                    var t, e = n[0],
                        r = n[t];
                    if (be(e, r)) {
                        u.lineStart();
                        for (var a = 0; t > a; ++a) u.point((e = n[a])[0], e[1]);
                        return void u.lineEnd()
                    }
                    var c = new qe(e, n, null, !0),
                        l = new qe(e, null, c, !1);
                    c.o = l, i.push(c), o.push(l), c = new qe(r, n, null, !1), l = new qe(r, null, c, !0), c.o = l, i.push(c), o.push(l)
                }
            }), o.sort(t), ze(i), ze(o), i.length) {
            for (var a = 0, c = e, l = o.length; l > a; ++a) o[a].e = c = !c;
            for (var s, f, h = i[0];;) {
                for (var g = h, p = !0; g.v;)
                    if ((g = g.n) === h) return;
                s = g.z, u.lineStart();
                do {
                    if (g.v = g.o.v = !0, g.e) {
                        if (p)
                            for (var a = 0, l = s.length; l > a; ++a) u.point((f = s[a])[0], f[1]);
                        else r(g.x, g.n.x, 1, u);
                        g = g.n
                    } else {
                        if (p) {
                            s = g.p.z;
                            for (var a = s.length - 1; a >= 0; --a) u.point((f = s[a])[0], f[1])
                        } else r(g.x, g.p.x, -1, u);
                        g = g.p
                    }
                    g = g.o, s = g.z, p = !p
                } while (!g.v);
                u.lineEnd()
            }
        }
    }

    function ze(n) {
        if (t = n.length) {
            for (var t, e, r = 0, u = n[0]; ++r < t;) u.n = e = n[r], e.p = u, u = e;
            u.n = e = n[0], e.p = u
        }
    }

    function qe(n, t, e, r) {
        this.x = n, this.z = t, this.o = e, this.e = r, this.v = !1, this.n = this.p = null
    }

    function Le(n, t, e, r) {
        return function(u, i) {
            function o(t, e) {
                var r = u(t, e);
                n(t = r[0], e = r[1]) && i.point(t, e)
            }

            function a(n, t) {
                var e = u(n, t);
                d.point(e[0], e[1])
            }

            function c() {
                y.point = a, d.lineStart()
            }

            function l() {
                y.point = o, d.lineEnd()
            }

            function s(n, t) {
                v.push([n, t]);
                var e = u(n, t);
                x.point(e[0], e[1])
            }

            function f() {
                x.lineStart(), v = []
            }

            function h() {
                s(v[0][0], v[0][1]), x.lineEnd();
                var n, t = x.clean(),
                    e = M.buffer(),
                    r = e.length;
                if (v.pop(), p.push(v), v = null, r)
                    if (1 & t) {
                        n = e[0];
                        var u, r = n.length - 1,
                            o = -1;
                        if (r > 0) {
                            for (b || (i.polygonStart(), b = !0), i.lineStart(); ++o < r;) i.point((u = n[o])[0], u[1]);
                            i.lineEnd()
                        }
                    } else r > 1 && 2 & t && e.push(e.pop().concat(e.shift())), g.push(e.filter(Te))
            }
            var g, p, v, d = t(i),
                m = u.invert(r[0], r[1]),
                y = {
                    point: o,
                    lineStart: c,
                    lineEnd: l,
                    polygonStart: function() {
                        y.point = s, y.lineStart = f, y.lineEnd = h, g = [], p = []
                    },
                    polygonEnd: function() {
                        y.point = o, y.lineStart = c, y.lineEnd = l, g = ta.merge(g);
                        var n = Fe(m, p);
                        g.length ? (b || (i.polygonStart(), b = !0), Ce(g, De, n, e, i)) : n && (b || (i.polygonStart(), b = !0), i.lineStart(), e(null, null, 1, i), i.lineEnd()), b && (i.polygonEnd(), b = !1), g = p = null
                    },
                    sphere: function() {
                        i.polygonStart(), i.lineStart(), e(null, null, 1, i), i.lineEnd(), i.polygonEnd()
                    }
                },
                M = Re(),
                x = t(M),
                b = !1;
            return y
        }
    }

    function Te(n) {
        return n.length > 1
    }

    function Re() {
        var n, t = [];
        return {
            lineStart: function() {
                t.push(n = [])
            },
            point: function(t, e) {
                n.push([t, e])
            },
            lineEnd: b,
            buffer: function() {
                var e = t;
                return t = [], n = null, e
            },
            rejoin: function() {
                t.length > 1 && t.push(t.pop().concat(t.shift()))
            }
        }
    }

    function De(n, t) {
        return ((n = n.x)[0] < 0 ? n[1] - Ra - Ca : Ra - n[1]) - ((t = t.x)[0] < 0 ? t[1] - Ra - Ca : Ra - t[1])
    }

    function Pe(n) {
        var t, e = 0 / 0,
            r = 0 / 0,
            u = 0 / 0;
        return {
            lineStart: function() {
                n.lineStart(), t = 1
            },
            point: function(i, o) {
                var a = i > 0 ? qa : -qa,
                    c = ga(i - e);
                ga(c - qa) < Ca ? (n.point(e, r = (r + o) / 2 > 0 ? Ra : -Ra), n.point(u, r), n.lineEnd(), n.lineStart(), n.point(a, r), n.point(i, r), t = 0) : u !== a && c >= qa && (ga(e - u) < Ca && (e -= u * Ca), ga(i - a) < Ca && (i -= a * Ca), r = Ue(e, r, i, o), n.point(u, r), n.lineEnd(), n.lineStart(), n.point(a, r), t = 0), n.point(e = i, r = o), u = a
            },
            lineEnd: function() {
                n.lineEnd(), e = r = 0 / 0
            },
            clean: function() {
                return 2 - t
            }
        }
    }

    function Ue(n, t, e, r) {
        var u, i, o = Math.sin(n - e);
        return ga(o) > Ca ? Math.atan((Math.sin(t) * (i = Math.cos(r)) * Math.sin(e) - Math.sin(r) * (u = Math.cos(t)) * Math.sin(n)) / (u * i * o)) : (t + r) / 2
    }

    function je(n, t, e, r) {
        var u;
        if (null == n) u = e * Ra, r.point(-qa, u), r.point(0, u), r.point(qa, u), r.point(qa, 0), r.point(qa, -u), r.point(0, -u), r.point(-qa, -u), r.point(-qa, 0), r.point(-qa, u);
        else if (ga(n[0] - t[0]) > Ca) {
            var i = n[0] < t[0] ? qa : -qa;
            u = e * i / 2, r.point(-i, u), r.point(0, u), r.point(i, u)
        } else r.point(t[0], t[1])
    }

    function Fe(n, t) {
        var e = n[0],
            r = n[1],
            u = [Math.sin(e), -Math.cos(e), 0],
            i = 0,
            o = 0;
        yc.reset();
        for (var a = 0, c = t.length; c > a; ++a) {
            var l = t[a],
                s = l.length;
            if (s)
                for (var f = l[0], h = f[0], g = f[1] / 2 + qa / 4, p = Math.sin(g), v = Math.cos(g), d = 1;;) {
                    d === s && (d = 0), n = l[d];
                    var m = n[0],
                        y = n[1] / 2 + qa / 4,
                        M = Math.sin(y),
                        x = Math.cos(y),
                        b = m - h,
                        _ = b >= 0 ? 1 : -1,
                        w = _ * b,
                        S = w > qa,
                        k = p * M;
                    if (yc.add(Math.atan2(k * _ * Math.sin(w), v * x + k * Math.cos(w))), i += S ? b + _ * La : b, S ^ h >= e ^ m >= e) {
                        var E = de(pe(f), pe(n));
                        Me(E);
                        var A = de(u, E);
                        Me(A);
                        var N = (S ^ b >= 0 ? -1 : 1) * tt(A[2]);
                        (r > N || r === N && (E[0] || E[1])) && (o += S ^ b >= 0 ? 1 : -1)
                    }
                    if (!d++) break;
                    h = m, p = M, v = x, f = n
                }
        }
        return (-Ca > i || Ca > i && 0 > yc) ^ 1 & o
    }

    function He(n) {
        function t(n, t) {
            return Math.cos(n) * Math.cos(t) > i
        }

        function e(n) {
            var e, i, c, l, s;
            return {
                lineStart: function() {
                    l = c = !1, s = 1
                },
                point: function(f, h) {
                    var g, p = [f, h],
                        v = t(f, h),
                        d = o ? v ? 0 : u(f, h) : v ? u(f + (0 > f ? qa : -qa), h) : 0;
                    if (!e && (l = c = v) && n.lineStart(), v !== c && (g = r(e, p), (be(e, g) || be(p, g)) && (p[0] += Ca, p[1] += Ca, v = t(p[0], p[1]))), v !== c) s = 0, v ? (n.lineStart(), g = r(p, e), n.point(g[0], g[1])) : (g = r(e, p), n.point(g[0], g[1]), n.lineEnd()), e = g;
                    else if (a && e && o ^ v) {
                        var m;
                        d & i || !(m = r(p, e, !0)) || (s = 0, o ? (n.lineStart(), n.point(m[0][0], m[0][1]), n.point(m[1][0], m[1][1]), n.lineEnd()) : (n.point(m[1][0], m[1][1]), n.lineEnd(), n.lineStart(), n.point(m[0][0], m[0][1])))
                    }!v || e && be(e, p) || n.point(p[0], p[1]), e = p, c = v, i = d
                },
                lineEnd: function() {
                    c && n.lineEnd(), e = null
                },
                clean: function() {
                    return s | (l && c) << 1
                }
            }
        }

        function r(n, t, e) {
            var r = pe(n),
                u = pe(t),
                o = [1, 0, 0],
                a = de(r, u),
                c = ve(a, a),
                l = a[0],
                s = c - l * l;
            if (!s) return !e && n;
            var f = i * c / s,
                h = -i * l / s,
                g = de(o, a),
                p = ye(o, f),
                v = ye(a, h);
            me(p, v);
            var d = g,
                m = ve(p, d),
                y = ve(d, d),
                M = m * m - y * (ve(p, p) - 1);
            if (!(0 > M)) {
                var x = Math.sqrt(M),
                    b = ye(d, (-m - x) / y);
                if (me(b, p), b = xe(b), !e) return b;
                var _, w = n[0],
                    S = t[0],
                    k = n[1],
                    E = t[1];
                w > S && (_ = w, w = S, S = _);
                var A = S - w,
                    N = ga(A - qa) < Ca,
                    C = N || Ca > A;
                if (!N && k > E && (_ = k, k = E, E = _), C ? N ? k + E > 0 ^ b[1] < (ga(b[0] - w) < Ca ? k : E) : k <= b[1] && b[1] <= E : A > qa ^ (w <= b[0] && b[0] <= S)) {
                    var z = ye(d, (-m + x) / y);
                    return me(z, p), [b, xe(z)]
                }
            }
        }

        function u(t, e) {
            var r = o ? n : qa - n,
                u = 0;
            return -r > t ? u |= 1 : t > r && (u |= 2), -r > e ? u |= 4 : e > r && (u |= 8), u
        }
        var i = Math.cos(n),
            o = i > 0,
            a = ga(i) > Ca,
            c = gr(n, 6 * Da);
        return Le(t, e, c, o ? [0, -n] : [-qa, n - qa])
    }

    function Oe(n, t, e, r) {
        return function(u) {
            var i, o = u.a,
                a = u.b,
                c = o.x,
                l = o.y,
                s = a.x,
                f = a.y,
                h = 0,
                g = 1,
                p = s - c,
                v = f - l;
            if (i = n - c, p || !(i > 0)) {
                if (i /= p, 0 > p) {
                    if (h > i) return;
                    g > i && (g = i)
                } else if (p > 0) {
                    if (i > g) return;
                    i > h && (h = i)
                }
                if (i = e - c, p || !(0 > i)) {
                    if (i /= p, 0 > p) {
                        if (i > g) return;
                        i > h && (h = i)
                    } else if (p > 0) {
                        if (h > i) return;
                        g > i && (g = i)
                    }
                    if (i = t - l, v || !(i > 0)) {
                        if (i /= v, 0 > v) {
                            if (h > i) return;
                            g > i && (g = i)
                        } else if (v > 0) {
                            if (i > g) return;
                            i > h && (h = i)
                        }
                        if (i = r - l, v || !(0 > i)) {
                            if (i /= v, 0 > v) {
                                if (i > g) return;
                                i > h && (h = i)
                            } else if (v > 0) {
                                if (h > i) return;
                                g > i && (g = i)
                            }
                            return h > 0 && (u.a = {
                                x: c + h * p,
                                y: l + h * v
                            }), 1 > g && (u.b = {
                                x: c + g * p,
                                y: l + g * v
                            }), u
                        }
                    }
                }
            }
        }
    }

    function Ie(n, t, e, r) {
        function u(r, u) {
            return ga(r[0] - n) < Ca ? u > 0 ? 0 : 3 : ga(r[0] - e) < Ca ? u > 0 ? 2 : 1 : ga(r[1] - t) < Ca ? u > 0 ? 1 : 0 : u > 0 ? 3 : 2
        }

        function i(n, t) {
            return o(n.x, t.x)
        }

        function o(n, t) {
            var e = u(n, 1),
                r = u(t, 1);
            return e !== r ? e - r : 0 === e ? t[1] - n[1] : 1 === e ? n[0] - t[0] : 2 === e ? n[1] - t[1] : t[0] - n[0]
        }
        return function(a) {
            function c(n) {
                for (var t = 0, e = d.length, r = n[1], u = 0; e > u; ++u)
                    for (var i, o = 1, a = d[u], c = a.length, l = a[0]; c > o; ++o) i = a[o], l[1] <= r ? i[1] > r && Q(l, i, n) > 0 && ++t : i[1] <= r && Q(l, i, n) < 0 && --t, l = i;
                return 0 !== t
            }

            function l(i, a, c, l) {
                var s = 0,
                    f = 0;
                if (null == i || (s = u(i, c)) !== (f = u(a, c)) || o(i, a) < 0 ^ c > 0) {
                    do l.point(0 === s || 3 === s ? n : e, s > 1 ? r : t); while ((s = (s + c + 4) % 4) !== f)
                } else l.point(a[0], a[1])
            }

            function s(u, i) {
                return u >= n && e >= u && i >= t && r >= i
            }

            function f(n, t) {
                s(n, t) && a.point(n, t)
            }

            function h() {
                C.point = p, d && d.push(m = []), S = !0, w = !1, b = _ = 0 / 0
            }

            function g() {
                v && (p(y, M), x && w && A.rejoin(), v.push(A.buffer())), C.point = f, w && a.lineEnd()
            }

            function p(n, t) {
                n = Math.max(-Tc, Math.min(Tc, n)), t = Math.max(-Tc, Math.min(Tc, t));
                var e = s(n, t);
                if (d && m.push([n, t]), S) y = n, M = t, x = e, S = !1, e && (a.lineStart(), a.point(n, t));
                else if (e && w) a.point(n, t);
                else {
                    var r = {
                        a: {
                            x: b,
                            y: _
                        },
                        b: {
                            x: n,
                            y: t
                        }
                    };
                    N(r) ? (w || (a.lineStart(), a.point(r.a.x, r.a.y)), a.point(r.b.x, r.b.y), e || a.lineEnd(), k = !1) : e && (a.lineStart(), a.point(n, t), k = !1)
                }
                b = n, _ = t, w = e
            }
            var v, d, m, y, M, x, b, _, w, S, k, E = a,
                A = Re(),
                N = Oe(n, t, e, r),
                C = {
                    point: f,
                    lineStart: h,
                    lineEnd: g,
                    polygonStart: function() {
                        a = A, v = [], d = [], k = !0
                    },
                    polygonEnd: function() {
                        a = E, v = ta.merge(v);
                        var t = c([n, r]),
                            e = k && t,
                            u = v.length;
                        (e || u) && (a.polygonStart(), e && (a.lineStart(), l(null, null, 1, a), a.lineEnd()), u && Ce(v, i, t, l, a), a.polygonEnd()), v = d = m = null
                    }
                };
            return C
        }
    }

    function Ye(n) {
        var t = 0,
            e = qa / 3,
            r = ir(n),
            u = r(t, e);
        return u.parallels = function(n) {
            return arguments.length ? r(t = n[0] * qa / 180, e = n[1] * qa / 180) : [t / qa * 180, e / qa * 180]
        }, u
    }

    function Ze(n, t) {
        function e(n, t) {
            var e = Math.sqrt(i - 2 * u * Math.sin(t)) / u;
            return [e * Math.sin(n *= u), o - e * Math.cos(n)]
        }
        var r = Math.sin(n),
            u = (r + Math.sin(t)) / 2,
            i = 1 + r * (2 * u - r),
            o = Math.sqrt(i) / u;
        return e.invert = function(n, t) {
            var e = o - t;
            return [Math.atan2(n, e) / u, tt((i - (n * n + e * e) * u * u) / (2 * u))]
        }, e
    }

    function Ve() {
        function n(n, t) {
            Dc += u * n - r * t, r = n, u = t
        }
        var t, e, r, u;
        Hc.point = function(i, o) {
            Hc.point = n, t = r = i, e = u = o
        }, Hc.lineEnd = function() {
            n(t, e)
        }
    }

    function Xe(n, t) {
        Pc > n && (Pc = n), n > jc && (jc = n), Uc > t && (Uc = t), t > Fc && (Fc = t)
    }

    function $e() {
        function n(n, t) {
            o.push("M", n, ",", t, i)
        }

        function t(n, t) {
            o.push("M", n, ",", t), a.point = e
        }

        function e(n, t) {
            o.push("L", n, ",", t)
        }

        function r() {
            a.point = n
        }

        function u() {
            o.push("Z")
        }
        var i = Be(4.5),
            o = [],
            a = {
                point: n,
                lineStart: function() {
                    a.point = t
                },
                lineEnd: r,
                polygonStart: function() {
                    a.lineEnd = u
                },
                polygonEnd: function() {
                    a.lineEnd = r, a.point = n
                },
                pointRadius: function(n) {
                    return i = Be(n), a
                },
                result: function() {
                    if (o.length) {
                        var n = o.join("");
                        return o = [], n
                    }
                }
            };
        return a
    }

    function Be(n) {
        return "m0," + n + "a" + n + "," + n + " 0 1,1 0," + -2 * n + "a" + n + "," + n + " 0 1,1 0," + 2 * n + "z"
    }

    function We(n, t) {
        _c += n, wc += t, ++Sc
    }

    function Je() {
        function n(n, r) {
            var u = n - t,
                i = r - e,
                o = Math.sqrt(u * u + i * i);
            kc += o * (t + n) / 2, Ec += o * (e + r) / 2, Ac += o, We(t = n, e = r)
        }
        var t, e;
        Ic.point = function(r, u) {
            Ic.point = n, We(t = r, e = u)
        }
    }

    function Ge() {
        Ic.point = We
    }

    function Ke() {
        function n(n, t) {
            var e = n - r,
                i = t - u,
                o = Math.sqrt(e * e + i * i);
            kc += o * (r + n) / 2, Ec += o * (u + t) / 2, Ac += o, o = u * n - r * t, Nc += o * (r + n), Cc += o * (u + t), zc += 3 * o, We(r = n, u = t)
        }
        var t, e, r, u;
        Ic.point = function(i, o) {
            Ic.point = n, We(t = r = i, e = u = o)
        }, Ic.lineEnd = function() {
            n(t, e)
        }
    }

    function Qe(n) {
        function t(t, e) {
            n.moveTo(t + o, e), n.arc(t, e, o, 0, La)
        }

        function e(t, e) {
            n.moveTo(t, e), a.point = r
        }

        function r(t, e) {
            n.lineTo(t, e)
        }

        function u() {
            a.point = t
        }

        function i() {
            n.closePath()
        }
        var o = 4.5,
            a = {
                point: t,
                lineStart: function() {
                    a.point = e
                },
                lineEnd: u,
                polygonStart: function() {
                    a.lineEnd = i
                },
                polygonEnd: function() {
                    a.lineEnd = u, a.point = t
                },
                pointRadius: function(n) {
                    return o = n, a
                },
                result: b
            };
        return a
    }

    function nr(n) {
        function t(n) {
            return (a ? r : e)(n)
        }

        function e(t) {
            return rr(t, function(e, r) {
                e = n(e, r), t.point(e[0], e[1])
            })
        }

        function r(t) {
            function e(e, r) {
                e = n(e, r), t.point(e[0], e[1])
            }

            function r() {
                M = 0 / 0, S.point = i, t.lineStart()
            }

            function i(e, r) {
                var i = pe([e, r]),
                    o = n(e, r);
                u(M, x, y, b, _, w, M = o[0], x = o[1], y = e, b = i[0], _ = i[1], w = i[2], a, t), t.point(M, x)
            }

            function o() {
                S.point = e, t.lineEnd()
            }

            function c() {
                r(), S.point = l, S.lineEnd = s
            }

            function l(n, t) {
                i(f = n, h = t), g = M, p = x, v = b, d = _, m = w, S.point = i
            }

            function s() {
                u(M, x, y, b, _, w, g, p, f, v, d, m, a, t), S.lineEnd = o, o()
            }
            var f, h, g, p, v, d, m, y, M, x, b, _, w, S = {
                point: e,
                lineStart: r,
                lineEnd: o,
                polygonStart: function() {
                    t.polygonStart(), S.lineStart = c
                },
                polygonEnd: function() {
                    t.polygonEnd(), S.lineStart = r
                }
            };
            return S
        }

        function u(t, e, r, a, c, l, s, f, h, g, p, v, d, m) {
            var y = s - t,
                M = f - e,
                x = y * y + M * M;
            if (x > 4 * i && d--) {
                var b = a + g,
                    _ = c + p,
                    w = l + v,
                    S = Math.sqrt(b * b + _ * _ + w * w),
                    k = Math.asin(w /= S),
                    E = ga(ga(w) - 1) < Ca || ga(r - h) < Ca ? (r + h) / 2 : Math.atan2(_, b),
                    A = n(E, k),
                    N = A[0],
                    C = A[1],
                    z = N - t,
                    q = C - e,
                    L = M * z - y * q;
                (L * L / x > i || ga((y * z + M * q) / x - .5) > .3 || o > a * g + c * p + l * v) && (u(t, e, r, a, c, l, N, C, E, b /= S, _ /= S, w, d, m), m.point(N, C), u(N, C, E, b, _, w, s, f, h, g, p, v, d, m))
            }
        }
        var i = .5,
            o = Math.cos(30 * Da),
            a = 16;
        return t.precision = function(n) {
            return arguments.length ? (a = (i = n * n) > 0 && 16, t) : Math.sqrt(i)
        }, t
    }

    function tr(n) {
        var t = nr(function(t, e) {
            return n([t * Pa, e * Pa])
        });
        return function(n) {
            return or(t(n))
        }
    }

    function er(n) {
        this.stream = n
    }

    function rr(n, t) {
        return {
            point: t,
            sphere: function() {
                n.sphere()
            },
            lineStart: function() {
                n.lineStart()
            },
            lineEnd: function() {
                n.lineEnd()
            },
            polygonStart: function() {
                n.polygonStart()
            },
            polygonEnd: function() {
                n.polygonEnd()
            }
        }
    }

    function ur(n) {
        return ir(function() {
            return n
        })()
    }

    function ir(n) {
        function t(n) {
            return n = a(n[0] * Da, n[1] * Da), [n[0] * h + c, l - n[1] * h]
        }

        function e(n) {
            return n = a.invert((n[0] - c) / h, (l - n[1]) / h), n && [n[0] * Pa, n[1] * Pa]
        }

        function r() {
            a = Ae(o = lr(m, M, x), i);
            var n = i(v, d);
            return c = g - n[0] * h, l = p + n[1] * h, u()
        }

        function u() {
            return s && (s.valid = !1, s = null), t
        }
        var i, o, a, c, l, s, f = nr(function(n, t) {
                return n = i(n, t), [n[0] * h + c, l - n[1] * h]
            }),
            h = 150,
            g = 480,
            p = 250,
            v = 0,
            d = 0,
            m = 0,
            M = 0,
            x = 0,
            b = Lc,
            _ = y,
            w = null,
            S = null;
        return t.stream = function(n) {
                return s && (s.valid = !1), s = or(b(o, f(_(n)))), s.valid = !0, s
            }, t.clipAngle = function(n) {
                return arguments.length ? (b = null == n ? (w = n, Lc) : He((w = +n) * Da), u()) : w
            }, t.clipExtent = function(n) {
                return arguments.length ? (S = n, _ = n ? Ie(n[0][0], n[0][1], n[1][0], n[1][1]) : y, u()) : S
            }, t.scale = function(n) {
                return arguments.length ? (h = +n, r()) : h
            }, t.translate = function(n) {
                return arguments.length ? (g = +n[0], p = +n[1], r()) : [g, p]
            }, t.center = function(n) {
                return arguments.length ? (v = n[0] % 360 * Da, d = n[1] % 360 * Da, r()) : [v * Pa, d * Pa]
            }, t.rotate = function(n) {
                return arguments.length ? (m = n[0] % 360 * Da, M = n[1] % 360 * Da, x = n.length > 2 ? n[2] % 360 * Da : 0, r()) : [m * Pa, M * Pa, x * Pa]
            }, ta.rebind(t, f, "precision"),
            function() {
                return i = n.apply(this, arguments), t.invert = i.invert && e, r()
            }
    }

    function or(n) {
        return rr(n, function(t, e) {
            n.point(t * Da, e * Da)
        })
    }

    function ar(n, t) {
        return [n, t]
    }

    function cr(n, t) {
        return [n > qa ? n - La : -qa > n ? n + La : n, t]
    }

    function lr(n, t, e) {
        return n ? t || e ? Ae(fr(n), hr(t, e)) : fr(n) : t || e ? hr(t, e) : cr
    }

    function sr(n) {
        return function(t, e) {
            return t += n, [t > qa ? t - La : -qa > t ? t + La : t, e]
        }
    }

    function fr(n) {
        var t = sr(n);
        return t.invert = sr(-n), t
    }

    function hr(n, t) {
        function e(n, t) {
            var e = Math.cos(t),
                a = Math.cos(n) * e,
                c = Math.sin(n) * e,
                l = Math.sin(t),
                s = l * r + a * u;
            return [Math.atan2(c * i - s * o, a * r - l * u), tt(s * i + c * o)]
        }
        var r = Math.cos(n),
            u = Math.sin(n),
            i = Math.cos(t),
            o = Math.sin(t);
        return e.invert = function(n, t) {
            var e = Math.cos(t),
                a = Math.cos(n) * e,
                c = Math.sin(n) * e,
                l = Math.sin(t),
                s = l * i - c * o;
            return [Math.atan2(c * i + l * o, a * r + s * u), tt(s * r - a * u)]
        }, e
    }

    function gr(n, t) {
        var e = Math.cos(n),
            r = Math.sin(n);
        return function(u, i, o, a) {
            var c = o * t;
            null != u ? (u = pr(e, u), i = pr(e, i), (o > 0 ? i > u : u > i) && (u += o * La)) : (u = n + o * La, i = n - .5 * c);
            for (var l, s = u; o > 0 ? s > i : i > s; s -= c) a.point((l = xe([e, -r * Math.cos(s), -r * Math.sin(s)]))[0], l[1])
        }
    }

    function pr(n, t) {
        var e = pe(t);
        e[0] -= n, Me(e);
        var r = nt(-e[1]);
        return ((-e[2] < 0 ? -r : r) + 2 * Math.PI - Ca) % (2 * Math.PI)
    }

    function vr(n, t, e) {
        var r = ta.range(n, t - Ca, e).concat(t);
        return function(n) {
            return r.map(function(t) {
                return [n, t]
            })
        }
    }

    function dr(n, t, e) {
        var r = ta.range(n, t - Ca, e).concat(t);
        return function(n) {
            return r.map(function(t) {
                return [t, n]
            })
        }
    }

    function mr(n) {
        return n.source
    }

    function yr(n) {
        return n.target
    }

    function Mr(n, t, e, r) {
        var u = Math.cos(t),
            i = Math.sin(t),
            o = Math.cos(r),
            a = Math.sin(r),
            c = u * Math.cos(n),
            l = u * Math.sin(n),
            s = o * Math.cos(e),
            f = o * Math.sin(e),
            h = 2 * Math.asin(Math.sqrt(it(r - t) + u * o * it(e - n))),
            g = 1 / Math.sin(h),
            p = h ? function(n) {
                var t = Math.sin(n *= h) * g,
                    e = Math.sin(h - n) * g,
                    r = e * c + t * s,
                    u = e * l + t * f,
                    o = e * i + t * a;
                return [Math.atan2(u, r) * Pa, Math.atan2(o, Math.sqrt(r * r + u * u)) * Pa]
            } : function() {
                return [n * Pa, t * Pa]
            };
        return p.distance = h, p
    }

    function xr() {
        function n(n, u) {
            var i = Math.sin(u *= Da),
                o = Math.cos(u),
                a = ga((n *= Da) - t),
                c = Math.cos(a);
            Yc += Math.atan2(Math.sqrt((a = o * Math.sin(a)) * a + (a = r * i - e * o * c) * a), e * i + r * o * c), t = n, e = i, r = o
        }
        var t, e, r;
        Zc.point = function(u, i) {
            t = u * Da, e = Math.sin(i *= Da), r = Math.cos(i), Zc.point = n
        }, Zc.lineEnd = function() {
            Zc.point = Zc.lineEnd = b
        }
    }

    function br(n, t) {
        function e(t, e) {
            var r = Math.cos(t),
                u = Math.cos(e),
                i = n(r * u);
            return [i * u * Math.sin(t), i * Math.sin(e)]
        }
        return e.invert = function(n, e) {
            var r = Math.sqrt(n * n + e * e),
                u = t(r),
                i = Math.sin(u),
                o = Math.cos(u);
            return [Math.atan2(n * i, r * o), Math.asin(r && e * i / r)]
        }, e
    }

    function _r(n, t) {
        function e(n, t) {
            o > 0 ? -Ra + Ca > t && (t = -Ra + Ca) : t > Ra - Ca && (t = Ra - Ca);
            var e = o / Math.pow(u(t), i);
            return [e * Math.sin(i * n), o - e * Math.cos(i * n)]
        }
        var r = Math.cos(n),
            u = function(n) {
                return Math.tan(qa / 4 + n / 2)
            },
            i = n === t ? Math.sin(n) : Math.log(r / Math.cos(t)) / Math.log(u(t) / u(n)),
            o = r * Math.pow(u(n), i) / i;
        return i ? (e.invert = function(n, t) {
            var e = o - t,
                r = K(i) * Math.sqrt(n * n + e * e);
            return [Math.atan2(n, e) / i, 2 * Math.atan(Math.pow(o / r, 1 / i)) - Ra]
        }, e) : Sr
    }

    function wr(n, t) {
        function e(n, t) {
            var e = i - t;
            return [e * Math.sin(u * n), i - e * Math.cos(u * n)]
        }
        var r = Math.cos(n),
            u = n === t ? Math.sin(n) : (r - Math.cos(t)) / (t - n),
            i = r / u + n;
        return ga(u) < Ca ? ar : (e.invert = function(n, t) {
            var e = i - t;
            return [Math.atan2(n, e) / u, i - K(u) * Math.sqrt(n * n + e * e)]
        }, e)
    }

    function Sr(n, t) {
        return [n, Math.log(Math.tan(qa / 4 + t / 2))]
    }

    function kr(n) {
        var t, e = ur(n),
            r = e.scale,
            u = e.translate,
            i = e.clipExtent;
        return e.scale = function() {
            var n = r.apply(e, arguments);
            return n === e ? t ? e.clipExtent(null) : e : n
        }, e.translate = function() {
            var n = u.apply(e, arguments);
            return n === e ? t ? e.clipExtent(null) : e : n
        }, e.clipExtent = function(n) {
            var o = i.apply(e, arguments);
            if (o === e) {
                if (t = null == n) {
                    var a = qa * r(),
                        c = u();
                    i([
                        [c[0] - a, c[1] - a],
                        [c[0] + a, c[1] + a]
                    ])
                }
            } else t && (o = null);
            return o
        }, e.clipExtent(null)
    }

    function Er(n, t) {
        return [Math.log(Math.tan(qa / 4 + t / 2)), -n]
    }

    function Ar(n) {
        return n[0]
    }

    function Nr(n) {
        return n[1]
    }

    function Cr(n) {
        for (var t = n.length, e = [0, 1], r = 2, u = 2; t > u; u++) {
            for (; r > 1 && Q(n[e[r - 2]], n[e[r - 1]], n[u]) <= 0;) --r;
            e[r++] = u
        }
        return e.slice(0, r)
    }

    function zr(n, t) {
        return n[0] - t[0] || n[1] - t[1]
    }

    function qr(n, t, e) {
        return (e[0] - t[0]) * (n[1] - t[1]) < (e[1] - t[1]) * (n[0] - t[0])
    }

    function Lr(n, t, e, r) {
        var u = n[0],
            i = e[0],
            o = t[0] - u,
            a = r[0] - i,
            c = n[1],
            l = e[1],
            s = t[1] - c,
            f = r[1] - l,
            h = (a * (c - l) - f * (u - i)) / (f * o - a * s);
        return [u + h * o, c + h * s]
    }

    function Tr(n) {
        var t = n[0],
            e = n[n.length - 1];
        return !(t[0] - e[0] || t[1] - e[1])
    }

    function Rr() {
        tu(this), this.edge = this.site = this.circle = null
    }

    function Dr(n) {
        var t = el.pop() || new Rr;
        return t.site = n, t
    }

    function Pr(n) {
        Xr(n), Qc.remove(n), el.push(n), tu(n)
    }

    function Ur(n) {
        var t = n.circle,
            e = t.x,
            r = t.cy,
            u = {
                x: e,
                y: r
            },
            i = n.P,
            o = n.N,
            a = [n];
        Pr(n);
        for (var c = i; c.circle && ga(e - c.circle.x) < Ca && ga(r - c.circle.cy) < Ca;) i = c.P, a.unshift(c), Pr(c), c = i;
        a.unshift(c), Xr(c);
        for (var l = o; l.circle && ga(e - l.circle.x) < Ca && ga(r - l.circle.cy) < Ca;) o = l.N, a.push(l), Pr(l), l = o;
        a.push(l), Xr(l);
        var s, f = a.length;
        for (s = 1; f > s; ++s) l = a[s], c = a[s - 1], Kr(l.edge, c.site, l.site, u);
        c = a[0], l = a[f - 1], l.edge = Jr(c.site, l.site, null, u), Vr(c), Vr(l)
    }

    function jr(n) {
        for (var t, e, r, u, i = n.x, o = n.y, a = Qc._; a;)
            if (r = Fr(a, o) - i, r > Ca) a = a.L;
            else {
                if (u = i - Hr(a, o), !(u > Ca)) {
                    r > -Ca ? (t = a.P, e = a) : u > -Ca ? (t = a, e = a.N) : t = e = a;
                    break
                }
                if (!a.R) {
                    t = a;
                    break
                }
                a = a.R
            }
        var c = Dr(n);
        if (Qc.insert(t, c), t || e) {
            if (t === e) return Xr(t), e = Dr(t.site), Qc.insert(c, e), c.edge = e.edge = Jr(t.site, c.site), Vr(t), void Vr(e);
            if (!e) return void(c.edge = Jr(t.site, c.site));
            Xr(t), Xr(e);
            var l = t.site,
                s = l.x,
                f = l.y,
                h = n.x - s,
                g = n.y - f,
                p = e.site,
                v = p.x - s,
                d = p.y - f,
                m = 2 * (h * d - g * v),
                y = h * h + g * g,
                M = v * v + d * d,
                x = {
                    x: (d * y - g * M) / m + s,
                    y: (h * M - v * y) / m + f
                };
            Kr(e.edge, l, p, x), c.edge = Jr(l, n, null, x), e.edge = Jr(n, p, null, x), Vr(t), Vr(e)
        }
    }

    function Fr(n, t) {
        var e = n.site,
            r = e.x,
            u = e.y,
            i = u - t;
        if (!i) return r;
        var o = n.P;
        if (!o) return -1 / 0;
        e = o.site;
        var a = e.x,
            c = e.y,
            l = c - t;
        if (!l) return a;
        var s = a - r,
            f = 1 / i - 1 / l,
            h = s / l;
        return f ? (-h + Math.sqrt(h * h - 2 * f * (s * s / (-2 * l) - c + l / 2 + u - i / 2))) / f + r : (r + a) / 2
    }

    function Hr(n, t) {
        var e = n.N;
        if (e) return Fr(e, t);
        var r = n.site;
        return r.y === t ? r.x : 1 / 0
    }

    function Or(n) {
        this.site = n, this.edges = []
    }

    function Ir(n) {
        for (var t, e, r, u, i, o, a, c, l, s, f = n[0][0], h = n[1][0], g = n[0][1], p = n[1][1], v = Kc, d = v.length; d--;)
            if (i = v[d], i && i.prepare())
                for (a = i.edges, c = a.length, o = 0; c > o;) s = a[o].end(), r = s.x, u = s.y, l = a[++o % c].start(), t = l.x, e = l.y, (ga(r - t) > Ca || ga(u - e) > Ca) && (a.splice(o, 0, new Qr(Gr(i.site, s, ga(r - f) < Ca && p - u > Ca ? {
                    x: f,
                    y: ga(t - f) < Ca ? e : p
                } : ga(u - p) < Ca && h - r > Ca ? {
                    x: ga(e - p) < Ca ? t : h,
                    y: p
                } : ga(r - h) < Ca && u - g > Ca ? {
                    x: h,
                    y: ga(t - h) < Ca ? e : g
                } : ga(u - g) < Ca && r - f > Ca ? {
                    x: ga(e - g) < Ca ? t : f,
                    y: g
                } : null), i.site, null)), ++c)
    }

    function Yr(n, t) {
        return t.angle - n.angle
    }

    function Zr() {
        tu(this), this.x = this.y = this.arc = this.site = this.cy = null
    }

    function Vr(n) {
        var t = n.P,
            e = n.N;
        if (t && e) {
            var r = t.site,
                u = n.site,
                i = e.site;
            if (r !== i) {
                var o = u.x,
                    a = u.y,
                    c = r.x - o,
                    l = r.y - a,
                    s = i.x - o,
                    f = i.y - a,
                    h = 2 * (c * f - l * s);
                if (!(h >= -za)) {
                    var g = c * c + l * l,
                        p = s * s + f * f,
                        v = (f * g - l * p) / h,
                        d = (c * p - s * g) / h,
                        f = d + a,
                        m = rl.pop() || new Zr;
                    m.arc = n, m.site = u, m.x = v + o, m.y = f + Math.sqrt(v * v + d * d), m.cy = f, n.circle = m;
                    for (var y = null, M = tl._; M;)
                        if (m.y < M.y || m.y === M.y && m.x <= M.x) {
                            if (!M.L) {
                                y = M.P;
                                break
                            }
                            M = M.L
                        } else {
                            if (!M.R) {
                                y = M;
                                break
                            }
                            M = M.R
                        }
                    tl.insert(y, m), y || (nl = m)
                }
            }
        }
    }

    function Xr(n) {
        var t = n.circle;
        t && (t.P || (nl = t.N), tl.remove(t), rl.push(t), tu(t), n.circle = null)
    }

    function $r(n) {
        for (var t, e = Gc, r = Oe(n[0][0], n[0][1], n[1][0], n[1][1]), u = e.length; u--;) t = e[u], (!Br(t, n) || !r(t) || ga(t.a.x - t.b.x) < Ca && ga(t.a.y - t.b.y) < Ca) && (t.a = t.b = null, e.splice(u, 1))
    }

    function Br(n, t) {
        var e = n.b;
        if (e) return !0;
        var r, u, i = n.a,
            o = t[0][0],
            a = t[1][0],
            c = t[0][1],
            l = t[1][1],
            s = n.l,
            f = n.r,
            h = s.x,
            g = s.y,
            p = f.x,
            v = f.y,
            d = (h + p) / 2,
            m = (g + v) / 2;
        if (v === g) {
            if (o > d || d >= a) return;
            if (h > p) {
                if (i) {
                    if (i.y >= l) return
                } else i = {
                    x: d,
                    y: c
                };
                e = {
                    x: d,
                    y: l
                }
            } else {
                if (i) {
                    if (i.y < c) return
                } else i = {
                    x: d,
                    y: l
                };
                e = {
                    x: d,
                    y: c
                }
            }
        } else if (r = (h - p) / (v - g), u = m - r * d, -1 > r || r > 1)
            if (h > p) {
                if (i) {
                    if (i.y >= l) return
                } else i = {
                    x: (c - u) / r,
                    y: c
                };
                e = {
                    x: (l - u) / r,
                    y: l
                }
            } else {
                if (i) {
                    if (i.y < c) return
                } else i = {
                    x: (l - u) / r,
                    y: l
                };
                e = {
                    x: (c - u) / r,
                    y: c
                }
            }
        else if (v > g) {
            if (i) {
                if (i.x >= a) return
            } else i = {
                x: o,
                y: r * o + u
            };
            e = {
                x: a,
                y: r * a + u
            }
        } else {
            if (i) {
                if (i.x < o) return
            } else i = {
                x: a,
                y: r * a + u
            };
            e = {
                x: o,
                y: r * o + u
            }
        }
        return n.a = i, n.b = e, !0
    }

    function Wr(n, t) {
        this.l = n, this.r = t, this.a = this.b = null
    }

    function Jr(n, t, e, r) {
        var u = new Wr(n, t);
        return Gc.push(u), e && Kr(u, n, t, e), r && Kr(u, t, n, r), Kc[n.i].edges.push(new Qr(u, n, t)), Kc[t.i].edges.push(new Qr(u, t, n)), u
    }

    function Gr(n, t, e) {
        var r = new Wr(n, null);
        return r.a = t, r.b = e, Gc.push(r), r
    }

    function Kr(n, t, e, r) {
        n.a || n.b ? n.l === e ? n.b = r : n.a = r : (n.a = r, n.l = t, n.r = e)
    }

    function Qr(n, t, e) {
        var r = n.a,
            u = n.b;
        this.edge = n, this.site = t, this.angle = e ? Math.atan2(e.y - t.y, e.x - t.x) : n.l === t ? Math.atan2(u.x - r.x, r.y - u.y) : Math.atan2(r.x - u.x, u.y - r.y)
    }

    function nu() {
        this._ = null
    }

    function tu(n) {
        n.U = n.C = n.L = n.R = n.P = n.N = null
    }

    function eu(n, t) {
        var e = t,
            r = t.R,
            u = e.U;
        u ? u.L === e ? u.L = r : u.R = r : n._ = r, r.U = u, e.U = r, e.R = r.L, e.R && (e.R.U = e), r.L = e
    }

    function ru(n, t) {
        var e = t,
            r = t.L,
            u = e.U;
        u ? u.L === e ? u.L = r : u.R = r : n._ = r, r.U = u, e.U = r, e.L = r.R, e.L && (e.L.U = e), r.R = e
    }

    function uu(n) {
        for (; n.L;) n = n.L;
        return n
    }

    function iu(n, t) {
        var e, r, u, i = n.sort(ou).pop();
        for (Gc = [], Kc = new Array(n.length), Qc = new nu, tl = new nu;;)
            if (u = nl, i && (!u || i.y < u.y || i.y === u.y && i.x < u.x))(i.x !== e || i.y !== r) && (Kc[i.i] = new Or(i), jr(i), e = i.x, r = i.y), i = n.pop();
            else {
                if (!u) break;
                Ur(u.arc)
            }
        t && ($r(t), Ir(t));
        var o = {
            cells: Kc,
            edges: Gc
        };
        return Qc = tl = Gc = Kc = null, o
    }

    function ou(n, t) {
        return t.y - n.y || t.x - n.x
    }

    function au(n, t, e) {
        return (n.x - e.x) * (t.y - n.y) - (n.x - t.x) * (e.y - n.y)
    }

    function cu(n) {
        return n.x
    }

    function lu(n) {
        return n.y
    }

    function su() {
        return {
            leaf: !0,
            nodes: [],
            point: null,
            x: null,
            y: null
        }
    }

    function fu(n, t, e, r, u, i) {
        if (!n(t, e, r, u, i)) {
            var o = .5 * (e + u),
                a = .5 * (r + i),
                c = t.nodes;
            c[0] && fu(n, c[0], e, r, o, a), c[1] && fu(n, c[1], o, r, u, a), c[2] && fu(n, c[2], e, a, o, i), c[3] && fu(n, c[3], o, a, u, i)
        }
    }

    function hu(n, t, e, r, u, i, o) {
        var a, c = 1 / 0;
        return function l(n, s, f, h, g) {
            if (!(s > i || f > o || r > h || u > g)) {
                if (p = n.point) {
                    var p, v = t - n.x,
                        d = e - n.y,
                        m = v * v + d * d;
                    if (c > m) {
                        var y = Math.sqrt(c = m);
                        r = t - y, u = e - y, i = t + y, o = e + y, a = p
                    }
                }
                for (var M = n.nodes, x = .5 * (s + h), b = .5 * (f + g), _ = t >= x, w = e >= b, S = w << 1 | _, k = S + 4; k > S; ++S)
                    if (n = M[3 & S]) switch (3 & S) {
                        case 0:
                            l(n, s, f, x, b);
                            break;
                        case 1:
                            l(n, x, f, h, b);
                            break;
                        case 2:
                            l(n, s, b, x, g);
                            break;
                        case 3:
                            l(n, x, b, h, g)
                    }
            }
        }(n, r, u, i, o), a
    }

    function gu(n, t) {
        n = ta.rgb(n), t = ta.rgb(t);
        var e = n.r,
            r = n.g,
            u = n.b,
            i = t.r - e,
            o = t.g - r,
            a = t.b - u;
        return function(n) {
            return "#" + xt(Math.round(e + i * n)) + xt(Math.round(r + o * n)) + xt(Math.round(u + a * n))
        }
    }

    function pu(n, t) {
        var e, r = {},
            u = {};
        for (e in n) e in t ? r[e] = mu(n[e], t[e]) : u[e] = n[e];
        for (e in t) e in n || (u[e] = t[e]);
        return function(n) {
            for (e in r) u[e] = r[e](n);
            return u
        }
    }

    function vu(n, t) {
        return n = +n, t = +t,
            function(e) {
                return n * (1 - e) + t * e
            }
    }

    function du(n, t) {
        var e, r, u, i = il.lastIndex = ol.lastIndex = 0,
            o = -1,
            a = [],
            c = [];
        for (n += "", t += "";
            (e = il.exec(n)) && (r = ol.exec(t));)(u = r.index) > i && (u = t.slice(i, u), a[o] ? a[o] += u : a[++o] = u), (e = e[0]) === (r = r[0]) ? a[o] ? a[o] += r : a[++o] = r : (a[++o] = null, c.push({
            i: o,
            x: vu(e, r)
        })), i = ol.lastIndex;
        return i < t.length && (u = t.slice(i), a[o] ? a[o] += u : a[++o] = u), a.length < 2 ? c[0] ? (t = c[0].x, function(n) {
            return t(n) + ""
        }) : function() {
            return t
        } : (t = c.length, function(n) {
            for (var e, r = 0; t > r; ++r) a[(e = c[r]).i] = e.x(n);
            return a.join("")
        })
    }

    function mu(n, t) {
        for (var e, r = ta.interpolators.length; --r >= 0 && !(e = ta.interpolators[r](n, t)););
        return e
    }

    function yu(n, t) {
        var e, r = [],
            u = [],
            i = n.length,
            o = t.length,
            a = Math.min(n.length, t.length);
        for (e = 0; a > e; ++e) r.push(mu(n[e], t[e]));
        for (; i > e; ++e) u[e] = n[e];
        for (; o > e; ++e) u[e] = t[e];
        return function(n) {
            for (e = 0; a > e; ++e) u[e] = r[e](n);
            return u
        }
    }

    function Mu(n) {
        return function(t) {
            return 0 >= t ? 0 : t >= 1 ? 1 : n(t)
        }
    }

    function xu(n) {
        return function(t) {
            return 1 - n(1 - t)
        }
    }

    function bu(n) {
        return function(t) {
            return .5 * (.5 > t ? n(2 * t) : 2 - n(2 - 2 * t))
        }
    }

    function _u(n) {
        return n * n
    }

    function wu(n) {
        return n * n * n
    }

    function Su(n) {
        if (0 >= n) return 0;
        if (n >= 1) return 1;
        var t = n * n,
            e = t * n;
        return 4 * (.5 > n ? e : 3 * (n - t) + e - .75)
    }

    function ku(n) {
        return function(t) {
            return Math.pow(t, n)
        }
    }

    function Eu(n) {
        return 1 - Math.cos(n * Ra)
    }

    function Au(n) {
        return Math.pow(2, 10 * (n - 1))
    }

    function Nu(n) {
        return 1 - Math.sqrt(1 - n * n)
    }

    function Cu(n, t) {
        var e;
        return arguments.length < 2 && (t = .45), arguments.length ? e = t / La * Math.asin(1 / n) : (n = 1, e = t / 4),
            function(r) {
                return 1 + n * Math.pow(2, -10 * r) * Math.sin((r - e) * La / t)
            }
    }

    function zu(n) {
        return n || (n = 1.70158),
            function(t) {
                return t * t * ((n + 1) * t - n)
            }
    }

    function qu(n) {
        return 1 / 2.75 > n ? 7.5625 * n * n : 2 / 2.75 > n ? 7.5625 * (n -= 1.5 / 2.75) * n + .75 : 2.5 / 2.75 > n ? 7.5625 * (n -= 2.25 / 2.75) * n + .9375 : 7.5625 * (n -= 2.625 / 2.75) * n + .984375
    }

    function Lu(n, t) {
        n = ta.hcl(n), t = ta.hcl(t);
        var e = n.h,
            r = n.c,
            u = n.l,
            i = t.h - e,
            o = t.c - r,
            a = t.l - u;
        return isNaN(o) && (o = 0, r = isNaN(r) ? t.c : r), isNaN(i) ? (i = 0, e = isNaN(e) ? t.h : e) : i > 180 ? i -= 360 : -180 > i && (i += 360),
            function(n) {
                return st(e + i * n, r + o * n, u + a * n) + ""
            }
    }

    function Tu(n, t) {
        n = ta.hsl(n), t = ta.hsl(t);
        var e = n.h,
            r = n.s,
            u = n.l,
            i = t.h - e,
            o = t.s - r,
            a = t.l - u;
        return isNaN(o) && (o = 0, r = isNaN(r) ? t.s : r), isNaN(i) ? (i = 0, e = isNaN(e) ? t.h : e) : i > 180 ? i -= 360 : -180 > i && (i += 360),
            function(n) {
                return ct(e + i * n, r + o * n, u + a * n) + ""
            }
    }

    function Ru(n, t) {
        n = ta.lab(n), t = ta.lab(t);
        var e = n.l,
            r = n.a,
            u = n.b,
            i = t.l - e,
            o = t.a - r,
            a = t.b - u;
        return function(n) {
            return ht(e + i * n, r + o * n, u + a * n) + ""
        }
    }

    function Du(n, t) {
        return t -= n,
            function(e) {
                return Math.round(n + t * e)
            }
    }

    function Pu(n) {
        var t = [n.a, n.b],
            e = [n.c, n.d],
            r = ju(t),
            u = Uu(t, e),
            i = ju(Fu(e, t, -u)) || 0;
        t[0] * e[1] < e[0] * t[1] && (t[0] *= -1, t[1] *= -1, r *= -1, u *= -1), this.rotate = (r ? Math.atan2(t[1], t[0]) : Math.atan2(-e[0], e[1])) * Pa, this.translate = [n.e, n.f], this.scale = [r, i], this.skew = i ? Math.atan2(u, i) * Pa : 0
    }

    function Uu(n, t) {
        return n[0] * t[0] + n[1] * t[1]
    }

    function ju(n) {
        var t = Math.sqrt(Uu(n, n));
        return t && (n[0] /= t, n[1] /= t), t
    }

    function Fu(n, t, e) {
        return n[0] += e * t[0], n[1] += e * t[1], n
    }

    function Hu(n, t) {
        var e, r = [],
            u = [],
            i = ta.transform(n),
            o = ta.transform(t),
            a = i.translate,
            c = o.translate,
            l = i.rotate,
            s = o.rotate,
            f = i.skew,
            h = o.skew,
            g = i.scale,
            p = o.scale;
        return a[0] != c[0] || a[1] != c[1] ? (r.push("translate(", null, ",", null, ")"), u.push({
                i: 1,
                x: vu(a[0], c[0])
            }, {
                i: 3,
                x: vu(a[1], c[1])
            })) : r.push(c[0] || c[1] ? "translate(" + c + ")" : ""), l != s ? (l - s > 180 ? s += 360 : s - l > 180 && (l += 360), u.push({
                i: r.push(r.pop() + "rotate(", null, ")") - 2,
                x: vu(l, s)
            })) : s && r.push(r.pop() + "rotate(" + s + ")"), f != h ? u.push({
                i: r.push(r.pop() + "skewX(", null, ")") - 2,
                x: vu(f, h)
            }) : h && r.push(r.pop() + "skewX(" + h + ")"), g[0] != p[0] || g[1] != p[1] ? (e = r.push(r.pop() + "scale(", null, ",", null, ")"), u.push({
                i: e - 4,
                x: vu(g[0], p[0])
            }, {
                i: e - 2,
                x: vu(g[1], p[1])
            })) : (1 != p[0] || 1 != p[1]) && r.push(r.pop() + "scale(" + p + ")"), e = u.length,
            function(n) {
                for (var t, i = -1; ++i < e;) r[(t = u[i]).i] = t.x(n);
                return r.join("")
            }
    }

    function Ou(n, t) {
        return t = (t -= n = +n) || 1 / t,
            function(e) {
                return (e - n) / t
            }
    }

    function Iu(n, t) {
        return t = (t -= n = +n) || 1 / t,
            function(e) {
                return Math.max(0, Math.min(1, (e - n) / t))
            }
    }

    function Yu(n) {
        for (var t = n.source, e = n.target, r = Vu(t, e), u = [t]; t !== r;) t = t.parent, u.push(t);
        for (var i = u.length; e !== r;) u.splice(i, 0, e), e = e.parent;
        return u
    }

    function Zu(n) {
        for (var t = [], e = n.parent; null != e;) t.push(n), n = e, e = e.parent;
        return t.push(n), t
    }

    function Vu(n, t) {
        if (n === t) return n;
        for (var e = Zu(n), r = Zu(t), u = e.pop(), i = r.pop(), o = null; u === i;) o = u, u = e.pop(), i = r.pop();
        return o
    }

    function Xu(n) {
        n.fixed |= 2
    }

    function $u(n) {
        n.fixed &= -7
    }

    function Bu(n) {
        n.fixed |= 4, n.px = n.x, n.py = n.y
    }

    function Wu(n) {
        n.fixed &= -5
    }

    function Ju(n, t, e) {
        var r = 0,
            u = 0;
        if (n.charge = 0, !n.leaf)
            for (var i, o = n.nodes, a = o.length, c = -1; ++c < a;) i = o[c], null != i && (Ju(i, t, e), n.charge += i.charge, r += i.charge * i.cx, u += i.charge * i.cy);
        if (n.point) {
            n.leaf || (n.point.x += Math.random() - .5, n.point.y += Math.random() - .5);
            var l = t * e[n.point.index];
            n.charge += n.pointCharge = l, r += l * n.point.x, u += l * n.point.y
        }
        n.cx = r / n.charge, n.cy = u / n.charge
    }

    function Gu(n, t) {
        return ta.rebind(n, t, "sort", "children", "value"), n.nodes = n, n.links = ri, n
    }

    function Ku(n, t) {
        for (var e = [n]; null != (n = e.pop());)
            if (t(n), (u = n.children) && (r = u.length))
                for (var r, u; --r >= 0;) e.push(u[r])
    }

    function Qu(n, t) {
        for (var e = [n], r = []; null != (n = e.pop());)
            if (r.push(n), (i = n.children) && (u = i.length))
                for (var u, i, o = -1; ++o < u;) e.push(i[o]);
        for (; null != (n = r.pop());) t(n)
    }

    function ni(n) {
        return n.children
    }

    function ti(n) {
        return n.value
    }

    function ei(n, t) {
        return t.value - n.value
    }

    function ri(n) {
        return ta.merge(n.map(function(n) {
            return (n.children || []).map(function(t) {
                return {
                    source: n,
                    target: t
                }
            })
        }))
    }

    function ui(n) {
        return n.x
    }

    function ii(n) {
        return n.y
    }

    function oi(n, t, e) {
        n.y0 = t, n.y = e
    }

    function ai(n) {
        return ta.range(n.length)
    }

    function ci(n) {
        for (var t = -1, e = n[0].length, r = []; ++t < e;) r[t] = 0;
        return r
    }

    function li(n) {
        for (var t, e = 1, r = 0, u = n[0][1], i = n.length; i > e; ++e)(t = n[e][1]) > u && (r = e, u = t);
        return r
    }

    function si(n) {
        return n.reduce(fi, 0)
    }

    function fi(n, t) {
        return n + t[1]
    }

    function hi(n, t) {
        return gi(n, Math.ceil(Math.log(t.length) / Math.LN2 + 1))
    }

    function gi(n, t) {
        for (var e = -1, r = +n[0], u = (n[1] - r) / t, i = []; ++e <= t;) i[e] = u * e + r;
        return i
    }

    function pi(n) {
        return [ta.min(n), ta.max(n)]
    }

    function vi(n, t) {
        return n.value - t.value
    }

    function di(n, t) {
        var e = n._pack_next;
        n._pack_next = t, t._pack_prev = n, t._pack_next = e, e._pack_prev = t
    }

    function mi(n, t) {
        n._pack_next = t, t._pack_prev = n
    }

    function yi(n, t) {
        var e = t.x - n.x,
            r = t.y - n.y,
            u = n.r + t.r;
        return .999 * u * u > e * e + r * r
    }

    function Mi(n) {
        function t(n) {
            s = Math.min(n.x - n.r, s), f = Math.max(n.x + n.r, f), h = Math.min(n.y - n.r, h), g = Math.max(n.y + n.r, g)
        }
        if ((e = n.children) && (l = e.length)) {
            var e, r, u, i, o, a, c, l, s = 1 / 0,
                f = -1 / 0,
                h = 1 / 0,
                g = -1 / 0;
            if (e.forEach(xi), r = e[0], r.x = -r.r, r.y = 0, t(r), l > 1 && (u = e[1], u.x = u.r, u.y = 0, t(u), l > 2))
                for (i = e[2], wi(r, u, i), t(i), di(r, i), r._pack_prev = i, di(i, u), u = r._pack_next, o = 3; l > o; o++) {
                    wi(r, u, i = e[o]);
                    var p = 0,
                        v = 1,
                        d = 1;
                    for (a = u._pack_next; a !== u; a = a._pack_next, v++)
                        if (yi(a, i)) {
                            p = 1;
                            break
                        }
                    if (1 == p)
                        for (c = r._pack_prev; c !== a._pack_prev && !yi(c, i); c = c._pack_prev, d++);
                    p ? (d > v || v == d && u.r < r.r ? mi(r, u = a) : mi(r = c, u), o--) : (di(r, i), u = i, t(i))
                }
            var m = (s + f) / 2,
                y = (h + g) / 2,
                M = 0;
            for (o = 0; l > o; o++) i = e[o], i.x -= m, i.y -= y, M = Math.max(M, i.r + Math.sqrt(i.x * i.x + i.y * i.y));
            n.r = M, e.forEach(bi)
        }
    }

    function xi(n) {
        n._pack_next = n._pack_prev = n
    }

    function bi(n) {
        delete n._pack_next, delete n._pack_prev
    }

    function _i(n, t, e, r) {
        var u = n.children;
        if (n.x = t += r * n.x, n.y = e += r * n.y, n.r *= r, u)
            for (var i = -1, o = u.length; ++i < o;) _i(u[i], t, e, r)
    }

    function wi(n, t, e) {
        var r = n.r + e.r,
            u = t.x - n.x,
            i = t.y - n.y;
        if (r && (u || i)) {
            var o = t.r + e.r,
                a = u * u + i * i;
            o *= o, r *= r;
            var c = .5 + (r - o) / (2 * a),
                l = Math.sqrt(Math.max(0, 2 * o * (r + a) - (r -= a) * r - o * o)) / (2 * a);
            e.x = n.x + c * u + l * i, e.y = n.y + c * i - l * u
        } else e.x = n.x + r, e.y = n.y
    }

    function Si(n, t) {
        return n.parent == t.parent ? 1 : 2
    }

    function ki(n) {
        var t = n.children;
        return t.length ? t[0] : n.t
    }

    function Ei(n) {
        var t, e = n.children;
        return (t = e.length) ? e[t - 1] : n.t
    }

    function Ai(n, t, e) {
        var r = e / (t.i - n.i);
        t.c -= r, t.s += e, n.c += r, t.z += e, t.m += e
    }

    function Ni(n) {
        for (var t, e = 0, r = 0, u = n.children, i = u.length; --i >= 0;) t = u[i], t.z += e, t.m += e, e += t.s + (r += t.c)
    }

    function Ci(n, t, e) {
        return n.a.parent === t.parent ? n.a : e
    }

    function zi(n) {
        return 1 + ta.max(n, function(n) {
            return n.y
        })
    }

    function qi(n) {
        return n.reduce(function(n, t) {
            return n + t.x
        }, 0) / n.length
    }

    function Li(n) {
        var t = n.children;
        return t && t.length ? Li(t[0]) : n
    }

    function Ti(n) {
        var t, e = n.children;
        return e && (t = e.length) ? Ti(e[t - 1]) : n
    }

    function Ri(n) {
        return {
            x: n.x,
            y: n.y,
            dx: n.dx,
            dy: n.dy
        }
    }

    function Di(n, t) {
        var e = n.x + t[3],
            r = n.y + t[0],
            u = n.dx - t[1] - t[3],
            i = n.dy - t[0] - t[2];
        return 0 > u && (e += u / 2, u = 0), 0 > i && (r += i / 2, i = 0), {
            x: e,
            y: r,
            dx: u,
            dy: i
        }
    }

    function Pi(n) {
        var t = n[0],
            e = n[n.length - 1];
        return e > t ? [t, e] : [e, t]
    }

    function Ui(n) {
        return n.rangeExtent ? n.rangeExtent() : Pi(n.range())
    }

    function ji(n, t, e, r) {
        var u = e(n[0], n[1]),
            i = r(t[0], t[1]);
        return function(n) {
            return i(u(n))
        }
    }

    function Fi(n, t) {
        var e, r = 0,
            u = n.length - 1,
            i = n[r],
            o = n[u];
        return i > o && (e = r, r = u, u = e, e = i, i = o, o = e), n[r] = t.floor(i), n[u] = t.ceil(o), n
    }

    function Hi(n) {
        return n ? {
            floor: function(t) {
                return Math.floor(t / n) * n
            },
            ceil: function(t) {
                return Math.ceil(t / n) * n
            }
        } : ml
    }

    function Oi(n, t, e, r) {
        var u = [],
            i = [],
            o = 0,
            a = Math.min(n.length, t.length) - 1;
        for (n[a] < n[0] && (n = n.slice().reverse(), t = t.slice().reverse()); ++o <= a;) u.push(e(n[o - 1], n[o])), i.push(r(t[o - 1], t[o]));
        return function(t) {
            var e = ta.bisect(n, t, 1, a) - 1;
            return i[e](u[e](t))
        }
    }

    function Ii(n, t, e, r) {
        function u() {
            var u = Math.min(n.length, t.length) > 2 ? Oi : ji,
                c = r ? Iu : Ou;
            return o = u(n, t, c, e), a = u(t, n, c, mu), i
        }

        function i(n) {
            return o(n)
        }
        var o, a;
        return i.invert = function(n) {
            return a(n)
        }, i.domain = function(t) {
            return arguments.length ? (n = t.map(Number), u()) : n
        }, i.range = function(n) {
            return arguments.length ? (t = n, u()) : t
        }, i.rangeRound = function(n) {
            return i.range(n).interpolate(Du)
        }, i.clamp = function(n) {
            return arguments.length ? (r = n, u()) : r
        }, i.interpolate = function(n) {
            return arguments.length ? (e = n, u()) : e
        }, i.ticks = function(t) {
            return Xi(n, t)
        }, i.tickFormat = function(t, e) {
            return $i(n, t, e)
        }, i.nice = function(t) {
            return Zi(n, t), u()
        }, i.copy = function() {
            return Ii(n, t, e, r)
        }, u()
    }

    function Yi(n, t) {
        return ta.rebind(n, t, "range", "rangeRound", "interpolate", "clamp")
    }

    function Zi(n, t) {
        return Fi(n, Hi(Vi(n, t)[2]))
    }

    function Vi(n, t) {
        null == t && (t = 10);
        var e = Pi(n),
            r = e[1] - e[0],
            u = Math.pow(10, Math.floor(Math.log(r / t) / Math.LN10)),
            i = t / r * u;
        return .15 >= i ? u *= 10 : .35 >= i ? u *= 5 : .75 >= i && (u *= 2), e[0] = Math.ceil(e[0] / u) * u, e[1] = Math.floor(e[1] / u) * u + .5 * u, e[2] = u, e
    }

    function Xi(n, t) {
        return ta.range.apply(ta, Vi(n, t))
    }

    function $i(n, t, e) {
        var r = Vi(n, t);
        if (e) {
            var u = ic.exec(e);
            if (u.shift(), "s" === u[8]) {
                var i = ta.formatPrefix(Math.max(ga(r[0]), ga(r[1])));
                return u[7] || (u[7] = "." + Bi(i.scale(r[2]))), u[8] = "f", e = ta.format(u.join("")),
                    function(n) {
                        return e(i.scale(n)) + i.symbol
                    }
            }
            u[7] || (u[7] = "." + Wi(u[8], r)), e = u.join("")
        } else e = ",." + Bi(r[2]) + "f";
        return ta.format(e)
    }

    function Bi(n) {
        return -Math.floor(Math.log(n) / Math.LN10 + .01)
    }

    function Wi(n, t) {
        var e = Bi(t[2]);
        return n in yl ? Math.abs(e - Bi(Math.max(ga(t[0]), ga(t[1])))) + +("e" !== n) : e - 2 * ("%" === n)
    }

    function Ji(n, t, e, r) {
        function u(n) {
            return (e ? Math.log(0 > n ? 0 : n) : -Math.log(n > 0 ? 0 : -n)) / Math.log(t)
        }

        function i(n) {
            return e ? Math.pow(t, n) : -Math.pow(t, -n)
        }

        function o(t) {
            return n(u(t))
        }
        return o.invert = function(t) {
            return i(n.invert(t))
        }, o.domain = function(t) {
            return arguments.length ? (e = t[0] >= 0, n.domain((r = t.map(Number)).map(u)), o) : r
        }, o.base = function(e) {
            return arguments.length ? (t = +e, n.domain(r.map(u)), o) : t
        }, o.nice = function() {
            var t = Fi(r.map(u), e ? Math : xl);
            return n.domain(t), r = t.map(i), o
        }, o.ticks = function() {
            var n = Pi(r),
                o = [],
                a = n[0],
                c = n[1],
                l = Math.floor(u(a)),
                s = Math.ceil(u(c)),
                f = t % 1 ? 2 : t;
            if (isFinite(s - l)) {
                if (e) {
                    for (; s > l; l++)
                        for (var h = 1; f > h; h++) o.push(i(l) * h);
                    o.push(i(l))
                } else
                    for (o.push(i(l)); l++ < s;)
                        for (var h = f - 1; h > 0; h--) o.push(i(l) * h);
                for (l = 0; o[l] < a; l++);
                for (s = o.length; o[s - 1] > c; s--);
                o = o.slice(l, s)
            }
            return o
        }, o.tickFormat = function(n, t) {
            if (!arguments.length) return Ml;
            arguments.length < 2 ? t = Ml : "function" != typeof t && (t = ta.format(t));
            var r, a = Math.max(.1, n / o.ticks().length),
                c = e ? (r = 1e-12, Math.ceil) : (r = -1e-12, Math.floor);
            return function(n) {
                return n / i(c(u(n) + r)) <= a ? t(n) : ""
            }
        }, o.copy = function() {
            return Ji(n.copy(), t, e, r)
        }, Yi(o, n)
    }

    function Gi(n, t, e) {
        function r(t) {
            return n(u(t))
        }
        var u = Ki(t),
            i = Ki(1 / t);
        return r.invert = function(t) {
            return i(n.invert(t))
        }, r.domain = function(t) {
            return arguments.length ? (n.domain((e = t.map(Number)).map(u)), r) : e
        }, r.ticks = function(n) {
            return Xi(e, n)
        }, r.tickFormat = function(n, t) {
            return $i(e, n, t)
        }, r.nice = function(n) {
            return r.domain(Zi(e, n))
        }, r.exponent = function(o) {
            return arguments.length ? (u = Ki(t = o), i = Ki(1 / t), n.domain(e.map(u)), r) : t
        }, r.copy = function() {
            return Gi(n.copy(), t, e)
        }, Yi(r, n)
    }

    function Ki(n) {
        return function(t) {
            return 0 > t ? -Math.pow(-t, n) : Math.pow(t, n)
        }
    }

    function Qi(n, t) {
        function e(e) {
            return i[((u.get(e) || ("range" === t.t ? u.set(e, n.push(e)) : 0 / 0)) - 1) % i.length]
        }

        function r(t, e) {
            return ta.range(n.length).map(function(n) {
                return t + e * n
            })
        }
        var u, i, o;
        return e.domain = function(r) {
            if (!arguments.length) return n;
            n = [], u = new l;
            for (var i, o = -1, a = r.length; ++o < a;) u.has(i = r[o]) || u.set(i, n.push(i));
            return e[t.t].apply(e, t.a)
        }, e.range = function(n) {
            return arguments.length ? (i = n, o = 0, t = {
                t: "range",
                a: arguments
            }, e) : i
        }, e.rangePoints = function(u, a) {
            arguments.length < 2 && (a = 0);
            var c = u[0],
                l = u[1],
                s = n.length < 2 ? (c = (c + l) / 2, 0) : (l - c) / (n.length - 1 + a);
            return i = r(c + s * a / 2, s), o = 0, t = {
                t: "rangePoints",
                a: arguments
            }, e
        }, e.rangeRoundPoints = function(u, a) {
            arguments.length < 2 && (a = 0);
            var c = u[0],
                l = u[1],
                s = n.length < 2 ? (c = l = Math.round((c + l) / 2), 0) : (l - c) / (n.length - 1 + a) | 0;
            return i = r(c + Math.round(s * a / 2 + (l - c - (n.length - 1 + a) * s) / 2), s), o = 0, t = {
                t: "rangeRoundPoints",
                a: arguments
            }, e
        }, e.rangeBands = function(u, a, c) {
            arguments.length < 2 && (a = 0), arguments.length < 3 && (c = a);
            var l = u[1] < u[0],
                s = u[l - 0],
                f = u[1 - l],
                h = (f - s) / (n.length - a + 2 * c);
            return i = r(s + h * c, h), l && i.reverse(), o = h * (1 - a), t = {
                t: "rangeBands",
                a: arguments
            }, e
        }, e.rangeRoundBands = function(u, a, c) {
            arguments.length < 2 && (a = 0), arguments.length < 3 && (c = a);
            var l = u[1] < u[0],
                s = u[l - 0],
                f = u[1 - l],
                h = Math.floor((f - s) / (n.length - a + 2 * c));
            return i = r(s + Math.round((f - s - (n.length - a) * h) / 2), h), l && i.reverse(), o = Math.round(h * (1 - a)), t = {
                t: "rangeRoundBands",
                a: arguments
            }, e
        }, e.rangeBand = function() {
            return o
        }, e.rangeExtent = function() {
            return Pi(t.a[0])
        }, e.copy = function() {
            return Qi(n, t)
        }, e.domain(n)
    }

    function no(n, t) {
        function i() {
            var e = 0,
                r = t.length;
            for (a = []; ++e < r;) a[e - 1] = ta.quantile(n, e / r);
            return o
        }

        function o(n) {
            return isNaN(n = +n) ? void 0 : t[ta.bisect(a, n)]
        }
        var a;
        return o.domain = function(t) {
            return arguments.length ? (n = t.map(r).filter(u).sort(e), i()) : n
        }, o.range = function(n) {
            return arguments.length ? (t = n, i()) : t
        }, o.quantiles = function() {
            return a
        }, o.invertExtent = function(e) {
            return e = t.indexOf(e), 0 > e ? [0 / 0, 0 / 0] : [e > 0 ? a[e - 1] : n[0], e < a.length ? a[e] : n[n.length - 1]]
        }, o.copy = function() {
            return no(n, t)
        }, i()
    }

    function to(n, t, e) {
        function r(t) {
            return e[Math.max(0, Math.min(o, Math.floor(i * (t - n))))]
        }

        function u() {
            return i = e.length / (t - n), o = e.length - 1, r
        }
        var i, o;
        return r.domain = function(e) {
            return arguments.length ? (n = +e[0], t = +e[e.length - 1], u()) : [n, t]
        }, r.range = function(n) {
            return arguments.length ? (e = n, u()) : e
        }, r.invertExtent = function(t) {
            return t = e.indexOf(t), t = 0 > t ? 0 / 0 : t / i + n, [t, t + 1 / i]
        }, r.copy = function() {
            return to(n, t, e)
        }, u()
    }

    function eo(n, t) {
        function e(e) {
            return e >= e ? t[ta.bisect(n, e)] : void 0
        }
        return e.domain = function(t) {
            return arguments.length ? (n = t, e) : n
        }, e.range = function(n) {
            return arguments.length ? (t = n, e) : t
        }, e.invertExtent = function(e) {
            return e = t.indexOf(e), [n[e - 1], n[e]]
        }, e.copy = function() {
            return eo(n, t)
        }, e
    }

    function ro(n) {
        function t(n) {
            return +n
        }
        return t.invert = t, t.domain = t.range = function(e) {
            return arguments.length ? (n = e.map(t), t) : n
        }, t.ticks = function(t) {
            return Xi(n, t)
        }, t.tickFormat = function(t, e) {
            return $i(n, t, e)
        }, t.copy = function() {
            return ro(n)
        }, t
    }

    function uo() {
        return 0
    }

    function io(n) {
        return n.innerRadius
    }

    function oo(n) {
        return n.outerRadius
    }

    function ao(n) {
        return n.startAngle
    }

    function co(n) {
        return n.endAngle
    }

    function lo(n) {
        return n && n.padAngle
    }

    function so(n, t, e, r) {
        return (n - e) * t - (t - r) * n > 0 ? 0 : 1
    }

    function fo(n, t, e, r, u) {
        var i = n[0] - t[0],
            o = n[1] - t[1],
            a = (u ? r : -r) / Math.sqrt(i * i + o * o),
            c = a * o,
            l = -a * i,
            s = n[0] + c,
            f = n[1] + l,
            h = t[0] + c,
            g = t[1] + l,
            p = (s + h) / 2,
            v = (f + g) / 2,
            d = h - s,
            m = g - f,
            y = d * d + m * m,
            M = e - r,
            x = s * g - h * f,
            b = (0 > m ? -1 : 1) * Math.sqrt(M * M * y - x * x),
            _ = (x * m - d * b) / y,
            w = (-x * d - m * b) / y,
            S = (x * m + d * b) / y,
            k = (-x * d + m * b) / y,
            E = _ - p,
            A = w - v,
            N = S - p,
            C = k - v;
        return E * E + A * A > N * N + C * C && (_ = S, w = k), [
            [_ - c, w - l],
            [_ * e / M, w * e / M]
        ]
    }

    function ho(n) {
        function t(t) {
            function o() {
                l.push("M", i(n(s), a))
            }
            for (var c, l = [], s = [], f = -1, h = t.length, g = Et(e), p = Et(r); ++f < h;) u.call(this, c = t[f], f) ? s.push([+g.call(this, c, f), +p.call(this, c, f)]) : s.length && (o(), s = []);
            return s.length && o(), l.length ? l.join("") : null
        }
        var e = Ar,
            r = Nr,
            u = Ne,
            i = go,
            o = i.key,
            a = .7;
        return t.x = function(n) {
            return arguments.length ? (e = n, t) : e
        }, t.y = function(n) {
            return arguments.length ? (r = n, t) : r
        }, t.defined = function(n) {
            return arguments.length ? (u = n, t) : u
        }, t.interpolate = function(n) {
            return arguments.length ? (o = "function" == typeof n ? i = n : (i = El.get(n) || go).key, t) : o
        }, t.tension = function(n) {
            return arguments.length ? (a = n, t) : a
        }, t
    }

    function go(n) {
        return n.join("L")
    }

    function po(n) {
        return go(n) + "Z"
    }

    function vo(n) {
        for (var t = 0, e = n.length, r = n[0], u = [r[0], ",", r[1]]; ++t < e;) u.push("H", (r[0] + (r = n[t])[0]) / 2, "V", r[1]);
        return e > 1 && u.push("H", r[0]), u.join("")
    }

    function mo(n) {
        for (var t = 0, e = n.length, r = n[0], u = [r[0], ",", r[1]]; ++t < e;) u.push("V", (r = n[t])[1], "H", r[0]);
        return u.join("")
    }

    function yo(n) {
        for (var t = 0, e = n.length, r = n[0], u = [r[0], ",", r[1]]; ++t < e;) u.push("H", (r = n[t])[0], "V", r[1]);
        return u.join("")
    }

    function Mo(n, t) {
        return n.length < 4 ? go(n) : n[1] + _o(n.slice(1, -1), wo(n, t))
    }

    function xo(n, t) {
        return n.length < 3 ? go(n) : n[0] + _o((n.push(n[0]), n), wo([n[n.length - 2]].concat(n, [n[1]]), t))
    }

    function bo(n, t) {
        return n.length < 3 ? go(n) : n[0] + _o(n, wo(n, t))
    }

    function _o(n, t) {
        if (t.length < 1 || n.length != t.length && n.length != t.length + 2) return go(n);
        var e = n.length != t.length,
            r = "",
            u = n[0],
            i = n[1],
            o = t[0],
            a = o,
            c = 1;
        if (e && (r += "Q" + (i[0] - 2 * o[0] / 3) + "," + (i[1] - 2 * o[1] / 3) + "," + i[0] + "," + i[1], u = n[1], c = 2), t.length > 1) {
            a = t[1], i = n[c], c++, r += "C" + (u[0] + o[0]) + "," + (u[1] + o[1]) + "," + (i[0] - a[0]) + "," + (i[1] - a[1]) + "," + i[0] + "," + i[1];
            for (var l = 2; l < t.length; l++, c++) i = n[c], a = t[l], r += "S" + (i[0] - a[0]) + "," + (i[1] - a[1]) + "," + i[0] + "," + i[1]
        }
        if (e) {
            var s = n[c];
            r += "Q" + (i[0] + 2 * a[0] / 3) + "," + (i[1] + 2 * a[1] / 3) + "," + s[0] + "," + s[1]
        }
        return r
    }

    function wo(n, t) {
        for (var e, r = [], u = (1 - t) / 2, i = n[0], o = n[1], a = 1, c = n.length; ++a < c;) e = i, i = o, o = n[a], r.push([u * (o[0] - e[0]), u * (o[1] - e[1])]);
        return r
    }

    function So(n) {
        if (n.length < 3) return go(n);
        var t = 1,
            e = n.length,
            r = n[0],
            u = r[0],
            i = r[1],
            o = [u, u, u, (r = n[1])[0]],
            a = [i, i, i, r[1]],
            c = [u, ",", i, "L", No(Cl, o), ",", No(Cl, a)];
        for (n.push(n[e - 1]); ++t <= e;) r = n[t], o.shift(), o.push(r[0]), a.shift(), a.push(r[1]), Co(c, o, a);
        return n.pop(), c.push("L", r), c.join("")
    }

    function ko(n) {
        if (n.length < 4) return go(n);
        for (var t, e = [], r = -1, u = n.length, i = [0], o = [0]; ++r < 3;) t = n[r], i.push(t[0]), o.push(t[1]);
        for (e.push(No(Cl, i) + "," + No(Cl, o)), --r; ++r < u;) t = n[r], i.shift(), i.push(t[0]), o.shift(), o.push(t[1]), Co(e, i, o);
        return e.join("")
    }

    function Eo(n) {
        for (var t, e, r = -1, u = n.length, i = u + 4, o = [], a = []; ++r < 4;) e = n[r % u], o.push(e[0]), a.push(e[1]);
        for (t = [No(Cl, o), ",", No(Cl, a)], --r; ++r < i;) e = n[r % u], o.shift(), o.push(e[0]), a.shift(), a.push(e[1]), Co(t, o, a);
        return t.join("")
    }

    function Ao(n, t) {
        var e = n.length - 1;
        if (e)
            for (var r, u, i = n[0][0], o = n[0][1], a = n[e][0] - i, c = n[e][1] - o, l = -1; ++l <= e;) r = n[l], u = l / e, r[0] = t * r[0] + (1 - t) * (i + u * a), r[1] = t * r[1] + (1 - t) * (o + u * c);
        return So(n)
    }

    function No(n, t) {
        return n[0] * t[0] + n[1] * t[1] + n[2] * t[2] + n[3] * t[3]
    }

    function Co(n, t, e) {
        n.push("C", No(Al, t), ",", No(Al, e), ",", No(Nl, t), ",", No(Nl, e), ",", No(Cl, t), ",", No(Cl, e))
    }

    function zo(n, t) {
        return (t[1] - n[1]) / (t[0] - n[0])
    }

    function qo(n) {
        for (var t = 0, e = n.length - 1, r = [], u = n[0], i = n[1], o = r[0] = zo(u, i); ++t < e;) r[t] = (o + (o = zo(u = i, i = n[t + 1]))) / 2;
        return r[t] = o, r
    }

    function Lo(n) {
        for (var t, e, r, u, i = [], o = qo(n), a = -1, c = n.length - 1; ++a < c;) t = zo(n[a], n[a + 1]), ga(t) < Ca ? o[a] = o[a + 1] = 0 : (e = o[a] / t, r = o[a + 1] / t, u = e * e + r * r, u > 9 && (u = 3 * t / Math.sqrt(u), o[a] = u * e, o[a + 1] = u * r));
        for (a = -1; ++a <= c;) u = (n[Math.min(c, a + 1)][0] - n[Math.max(0, a - 1)][0]) / (6 * (1 + o[a] * o[a])), i.push([u || 0, o[a] * u || 0]);
        return i
    }

    function To(n) {
        return n.length < 3 ? go(n) : n[0] + _o(n, Lo(n))
    }

    function Ro(n) {
        for (var t, e, r, u = -1, i = n.length; ++u < i;) t = n[u], e = t[0], r = t[1] - Ra, t[0] = e * Math.cos(r), t[1] = e * Math.sin(r);
        return n
    }

    function Do(n) {
        function t(t) {
            function c() {
                v.push("M", a(n(m), f), s, l(n(d.reverse()), f), "Z")
            }
            for (var h, g, p, v = [], d = [], m = [], y = -1, M = t.length, x = Et(e), b = Et(u), _ = e === r ? function() {
                    return g
                } : Et(r), w = u === i ? function() {
                    return p
                } : Et(i); ++y < M;) o.call(this, h = t[y], y) ? (d.push([g = +x.call(this, h, y), p = +b.call(this, h, y)]), m.push([+_.call(this, h, y), +w.call(this, h, y)])) : d.length && (c(), d = [], m = []);
            return d.length && c(), v.length ? v.join("") : null
        }
        var e = Ar,
            r = Ar,
            u = 0,
            i = Nr,
            o = Ne,
            a = go,
            c = a.key,
            l = a,
            s = "L",
            f = .7;
        return t.x = function(n) {
            return arguments.length ? (e = r = n, t) : r
        }, t.x0 = function(n) {
            return arguments.length ? (e = n, t) : e
        }, t.x1 = function(n) {
            return arguments.length ? (r = n, t) : r
        }, t.y = function(n) {
            return arguments.length ? (u = i = n, t) : i
        }, t.y0 = function(n) {
            return arguments.length ? (u = n, t) : u
        }, t.y1 = function(n) {
            return arguments.length ? (i = n, t) : i
        }, t.defined = function(n) {
            return arguments.length ? (o = n, t) : o
        }, t.interpolate = function(n) {
            return arguments.length ? (c = "function" == typeof n ? a = n : (a = El.get(n) || go).key, l = a.reverse || a, s = a.closed ? "M" : "L", t) : c
        }, t.tension = function(n) {
            return arguments.length ? (f = n, t) : f
        }, t
    }

    function Po(n) {
        return n.radius
    }

    function Uo(n) {
        return [n.x, n.y]
    }

    function jo(n) {
        return function() {
            var t = n.apply(this, arguments),
                e = t[0],
                r = t[1] - Ra;
            return [e * Math.cos(r), e * Math.sin(r)]
        }
    }

    function Fo() {
        return 64
    }

    function Ho() {
        return "circle"
    }

    function Oo(n) {
        var t = Math.sqrt(n / qa);
        return "M0," + t + "A" + t + "," + t + " 0 1,1 0," + -t + "A" + t + "," + t + " 0 1,1 0," + t + "Z"
    }

    function Io(n) {
        return function() {
            var t, e;
            (t = this[n]) && (e = t[t.active]) && (--t.count ? delete t[t.active] : delete this[n], t.active += .5, e.event && e.event.interrupt.call(this, this.__data__, e.index))
        }
    }

    function Yo(n, t, e) {
        return ya(n, Pl), n.namespace = t, n.id = e, n
    }

    function Zo(n, t, e, r) {
        var u = n.id,
            i = n.namespace;
        return Y(n, "function" == typeof e ? function(n, o, a) {
            n[i][u].tween.set(t, r(e.call(n, n.__data__, o, a)))
        } : (e = r(e), function(n) {
            n[i][u].tween.set(t, e)
        }))
    }

    function Vo(n) {
        return null == n && (n = ""),
            function() {
                this.textContent = n
            }
    }

    function Xo(n) {
        return null == n ? "__transition__" : "__transition_" + n + "__"
    }

    function $o(n, t, e, r, u) {
        var i = n[e] || (n[e] = {
                active: 0,
                count: 0
            }),
            o = i[r];
        if (!o) {
            var a = u.time;
            o = i[r] = {
                tween: new l,
                time: a,
                delay: u.delay,
                duration: u.duration,
                ease: u.ease,
                index: t
            }, u = null, ++i.count, ta.timer(function(u) {
                function c(e) {
                    if (i.active > r) return s();
                    var u = i[i.active];
                    u && (--i.count, delete i[i.active], u.event && u.event.interrupt.call(n, n.__data__, u.index)), i.active = r, o.event && o.event.start.call(n, n.__data__, t), o.tween.forEach(function(e, r) {
                        (r = r.call(n, n.__data__, t)) && v.push(r)
                    }), h = o.ease, f = o.duration, ta.timer(function() {
                        return p.c = l(e || 1) ? Ne : l, 1
                    }, 0, a)
                }

                function l(e) {
                    if (i.active !== r) return 1;
                    for (var u = e / f, a = h(u), c = v.length; c > 0;) v[--c].call(n, a);
                    return u >= 1 ? (o.event && o.event.end.call(n, n.__data__, t), s()) : void 0
                }

                function s() {
                    return --i.count ? delete i[r] : delete n[e], 1
                }
                var f, h, g = o.delay,
                    p = ec,
                    v = [];
                return p.t = g + a, u >= g ? c(u - g) : void(p.c = c)
            }, 0, a)
        }
    }

    function Bo(n, t, e) {
        n.attr("transform", function(n) {
            var r = t(n);
            return "translate(" + (isFinite(r) ? r : e(n)) + ",0)"
        })
    }

    function Wo(n, t, e) {
        n.attr("transform", function(n) {
            var r = t(n);
            return "translate(0," + (isFinite(r) ? r : e(n)) + ")"
        })
    }

    function Jo(n) {
        return n.toISOString()
    }

    function Go(n, t, e) {
        function r(t) {
            return n(t)
        }

        function u(n, e) {
            var r = n[1] - n[0],
                u = r / e,
                i = ta.bisect(Vl, u);
            return i == Vl.length ? [t.year, Vi(n.map(function(n) {
                return n / 31536e6
            }), e)[2]] : i ? t[u / Vl[i - 1] < Vl[i] / u ? i - 1 : i] : [Bl, Vi(n, e)[2]]
        }
        return r.invert = function(t) {
            return Ko(n.invert(t))
        }, r.domain = function(t) {
            return arguments.length ? (n.domain(t), r) : n.domain().map(Ko)
        }, r.nice = function(n, t) {
            function e(e) {
                return !isNaN(e) && !n.range(e, Ko(+e + 1), t).length
            }
            var i = r.domain(),
                o = Pi(i),
                a = null == n ? u(o, 10) : "number" == typeof n && u(o, n);
            return a && (n = a[0], t = a[1]), r.domain(Fi(i, t > 1 ? {
                floor: function(t) {
                    for (; e(t = n.floor(t));) t = Ko(t - 1);
                    return t
                },
                ceil: function(t) {
                    for (; e(t = n.ceil(t));) t = Ko(+t + 1);
                    return t
                }
            } : n))
        }, r.ticks = function(n, t) {
            var e = Pi(r.domain()),
                i = null == n ? u(e, 10) : "number" == typeof n ? u(e, n) : !n.range && [{
                    range: n
                }, t];
            return i && (n = i[0], t = i[1]), n.range(e[0], Ko(+e[1] + 1), 1 > t ? 1 : t)
        }, r.tickFormat = function() {
            return e
        }, r.copy = function() {
            return Go(n.copy(), t, e)
        }, Yi(r, n)
    }

    function Ko(n) {
        return new Date(n)
    }

    function Qo(n) {
        return JSON.parse(n.responseText)
    }

    function na(n) {
        var t = ua.createRange();
        return t.selectNode(ua.body), t.createContextualFragment(n.responseText)
    }
    var ta = {
            version: "3.5.6"
        },
        ea = [].slice,
        ra = function(n) {
            return ea.call(n)
        },
        ua = this.document;
    if (ua) try {
        ra(ua.documentElement.childNodes)[0].nodeType
    } catch (ia) {
        ra = function(n) {
            for (var t = n.length, e = new Array(t); t--;) e[t] = n[t];
            return e
        }
    }
    if (Date.now || (Date.now = function() {
            return +new Date
        }), ua) try {
        ua.createElement("DIV").style.setProperty("opacity", 0, "")
    } catch (oa) {
        var aa = this.Element.prototype,
            ca = aa.setAttribute,
            la = aa.setAttributeNS,
            sa = this.CSSStyleDeclaration.prototype,
            fa = sa.setProperty;
        aa.setAttribute = function(n, t) {
            ca.call(this, n, t + "")
        }, aa.setAttributeNS = function(n, t, e) {
            la.call(this, n, t, e + "")
        }, sa.setProperty = function(n, t, e) {
            fa.call(this, n, t + "", e)
        }
    }
    ta.ascending = e, ta.descending = function(n, t) {
        return n > t ? -1 : t > n ? 1 : t >= n ? 0 : 0 / 0
    }, ta.min = function(n, t) {
        var e, r, u = -1,
            i = n.length;
        if (1 === arguments.length) {
            for (; ++u < i;)
                if (null != (r = n[u]) && r >= r) {
                    e = r;
                    break
                }
            for (; ++u < i;) null != (r = n[u]) && e > r && (e = r)
        } else {
            for (; ++u < i;)
                if (null != (r = t.call(n, n[u], u)) && r >= r) {
                    e = r;
                    break
                }
            for (; ++u < i;) null != (r = t.call(n, n[u], u)) && e > r && (e = r)
        }
        return e
    }, ta.max = function(n, t) {
        var e, r, u = -1,
            i = n.length;
        if (1 === arguments.length) {
            for (; ++u < i;)
                if (null != (r = n[u]) && r >= r) {
                    e = r;
                    break
                }
            for (; ++u < i;) null != (r = n[u]) && r > e && (e = r)
        } else {
            for (; ++u < i;)
                if (null != (r = t.call(n, n[u], u)) && r >= r) {
                    e = r;
                    break
                }
            for (; ++u < i;) null != (r = t.call(n, n[u], u)) && r > e && (e = r)
        }
        return e
    }, ta.extent = function(n, t) {
        var e, r, u, i = -1,
            o = n.length;
        if (1 === arguments.length) {
            for (; ++i < o;)
                if (null != (r = n[i]) && r >= r) {
                    e = u = r;
                    break
                }
            for (; ++i < o;) null != (r = n[i]) && (e > r && (e = r), r > u && (u = r))
        } else {
            for (; ++i < o;)
                if (null != (r = t.call(n, n[i], i)) && r >= r) {
                    e = u = r;
                    break
                }
            for (; ++i < o;) null != (r = t.call(n, n[i], i)) && (e > r && (e = r), r > u && (u = r))
        }
        return [e, u]
    }, ta.sum = function(n, t) {
        var e, r = 0,
            i = n.length,
            o = -1;
        if (1 === arguments.length)
            for (; ++o < i;) u(e = +n[o]) && (r += e);
        else
            for (; ++o < i;) u(e = +t.call(n, n[o], o)) && (r += e);
        return r
    }, ta.mean = function(n, t) {
        var e, i = 0,
            o = n.length,
            a = -1,
            c = o;
        if (1 === arguments.length)
            for (; ++a < o;) u(e = r(n[a])) ? i += e : --c;
        else
            for (; ++a < o;) u(e = r(t.call(n, n[a], a))) ? i += e : --c;
        return c ? i / c : void 0
    }, ta.quantile = function(n, t) {
        var e = (n.length - 1) * t + 1,
            r = Math.floor(e),
            u = +n[r - 1],
            i = e - r;
        return i ? u + i * (n[r] - u) : u
    }, ta.median = function(n, t) {
        var i, o = [],
            a = n.length,
            c = -1;
        if (1 === arguments.length)
            for (; ++c < a;) u(i = r(n[c])) && o.push(i);
        else
            for (; ++c < a;) u(i = r(t.call(n, n[c], c))) && o.push(i);
        return o.length ? ta.quantile(o.sort(e), .5) : void 0
    }, ta.variance = function(n, t) {
        var e, i, o = n.length,
            a = 0,
            c = 0,
            l = -1,
            s = 0;
        if (1 === arguments.length)
            for (; ++l < o;) u(e = r(n[l])) && (i = e - a, a += i / ++s, c += i * (e - a));
        else
            for (; ++l < o;) u(e = r(t.call(n, n[l], l))) && (i = e - a, a += i / ++s, c += i * (e - a));
        return s > 1 ? c / (s - 1) : void 0
    }, ta.deviation = function() {
        var n = ta.variance.apply(this, arguments);
        return n ? Math.sqrt(n) : n
    };
    var ha = i(e);
    ta.bisectLeft = ha.left, ta.bisect = ta.bisectRight = ha.right, ta.bisector = function(n) {
        return i(1 === n.length ? function(t, r) {
            return e(n(t), r)
        } : n)
    }, ta.shuffle = function(n, t, e) {
        (i = arguments.length) < 3 && (e = n.length, 2 > i && (t = 0));
        for (var r, u, i = e - t; i;) u = Math.random() * i-- | 0, r = n[i + t], n[i + t] = n[u + t], n[u + t] = r;
        return n
    }, ta.permute = function(n, t) {
        for (var e = t.length, r = new Array(e); e--;) r[e] = n[t[e]];
        return r
    }, ta.pairs = function(n) {
        for (var t, e = 0, r = n.length - 1, u = n[0], i = new Array(0 > r ? 0 : r); r > e;) i[e] = [t = u, u = n[++e]];
        return i
    }, ta.zip = function() {
        if (!(r = arguments.length)) return [];
        for (var n = -1, t = ta.min(arguments, o), e = new Array(t); ++n < t;)
            for (var r, u = -1, i = e[n] = new Array(r); ++u < r;) i[u] = arguments[u][n];
        return e
    }, ta.transpose = function(n) {
        return ta.zip.apply(ta, n)
    }, ta.keys = function(n) {
        var t = [];
        for (var e in n) t.push(e);
        return t
    }, ta.values = function(n) {
        var t = [];
        for (var e in n) t.push(n[e]);
        return t
    }, ta.entries = function(n) {
        var t = [];
        for (var e in n) t.push({
            key: e,
            value: n[e]
        });
        return t
    }, ta.merge = function(n) {
        for (var t, e, r, u = n.length, i = -1, o = 0; ++i < u;) o += n[i].length;
        for (e = new Array(o); --u >= 0;)
            for (r = n[u], t = r.length; --t >= 0;) e[--o] = r[t];
        return e
    };
    var ga = Math.abs;
    ta.range = function(n, t, e) {
        if (arguments.length < 3 && (e = 1, arguments.length < 2 && (t = n, n = 0)), (t - n) / e === 1 / 0) throw new Error("infinite range");
        var r, u = [],
            i = a(ga(e)),
            o = -1;
        if (n *= i, t *= i, e *= i, 0 > e)
            for (;
                (r = n + e * ++o) > t;) u.push(r / i);
        else
            for (;
                (r = n + e * ++o) < t;) u.push(r / i);
        return u
    }, ta.map = function(n, t) {
        var e = new l;
        if (n instanceof l) n.forEach(function(n, t) {
            e.set(n, t)
        });
        else if (Array.isArray(n)) {
            var r, u = -1,
                i = n.length;
            if (1 === arguments.length)
                for (; ++u < i;) e.set(u, n[u]);
            else
                for (; ++u < i;) e.set(t.call(n, r = n[u], u), r)
        } else
            for (var o in n) e.set(o, n[o]);
        return e
    };
    var pa = "__proto__",
        va = "\x00";
    c(l, {
        has: h,
        get: function(n) {
            return this._[s(n)]
        },
        set: function(n, t) {
            return this._[s(n)] = t
        },
        remove: g,
        keys: p,
        values: function() {
            var n = [];
            for (var t in this._) n.push(this._[t]);
            return n
        },
        entries: function() {
            var n = [];
            for (var t in this._) n.push({
                key: f(t),
                value: this._[t]
            });
            return n
        },
        size: v,
        empty: d,
        forEach: function(n) {
            for (var t in this._) n.call(this, f(t), this._[t])
        }
    }), ta.nest = function() {
        function n(t, o, a) {
            if (a >= i.length) return r ? r.call(u, o) : e ? o.sort(e) : o;
            for (var c, s, f, h, g = -1, p = o.length, v = i[a++], d = new l; ++g < p;)(h = d.get(c = v(s = o[g]))) ? h.push(s) : d.set(c, [s]);
            return t ? (s = t(), f = function(e, r) {
                s.set(e, n(t, r, a))
            }) : (s = {}, f = function(e, r) {
                s[e] = n(t, r, a)
            }), d.forEach(f), s
        }

        function t(n, e) {
            if (e >= i.length) return n;
            var r = [],
                u = o[e++];
            return n.forEach(function(n, u) {
                r.push({
                    key: n,
                    values: t(u, e)
                })
            }), u ? r.sort(function(n, t) {
                return u(n.key, t.key)
            }) : r
        }
        var e, r, u = {},
            i = [],
            o = [];
        return u.map = function(t, e) {
            return n(e, t, 0)
        }, u.entries = function(e) {
            return t(n(ta.map, e, 0), 0)
        }, u.key = function(n) {
            return i.push(n), u
        }, u.sortKeys = function(n) {
            return o[i.length - 1] = n, u
        }, u.sortValues = function(n) {
            return e = n, u
        }, u.rollup = function(n) {
            return r = n, u
        }, u
    }, ta.set = function(n) {
        var t = new m;
        if (n)
            for (var e = 0, r = n.length; r > e; ++e) t.add(n[e]);
        return t
    }, c(m, {
        has: h,
        add: function(n) {
            return this._[s(n += "")] = !0, n
        },
        remove: g,
        values: p,
        size: v,
        empty: d,
        forEach: function(n) {
            for (var t in this._) n.call(this, f(t))
        }
    }), ta.behavior = {}, ta.rebind = function(n, t) {
        for (var e, r = 1, u = arguments.length; ++r < u;) n[e = arguments[r]] = M(n, t, t[e]);
        return n
    };
    var da = ["webkit", "ms", "moz", "Moz", "o", "O"];
    ta.dispatch = function() {
        for (var n = new _, t = -1, e = arguments.length; ++t < e;) n[arguments[t]] = w(n);
        return n
    }, _.prototype.on = function(n, t) {
        var e = n.indexOf("."),
            r = "";
        if (e >= 0 && (r = n.slice(e + 1), n = n.slice(0, e)), n) return arguments.length < 2 ? this[n].on(r) : this[n].on(r, t);
        if (2 === arguments.length) {
            if (null == t)
                for (n in this) this.hasOwnProperty(n) && this[n].on(r, null);
            return this
        }
    }, ta.event = null, ta.requote = function(n) {
        return n.replace(ma, "\\$&")
    };
    var ma = /[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g,
        ya = {}.__proto__ ? function(n, t) {
            n.__proto__ = t
        } : function(n, t) {
            for (var e in t) n[e] = t[e]
        },
        Ma = function(n, t) {
            return t.querySelector(n)
        },
        xa = function(n, t) {
            return t.querySelectorAll(n)
        },
        ba = function(n, t) {
            var e = n.matches || n[x(n, "matchesSelector")];
            return (ba = function(n, t) {
                return e.call(n, t)
            })(n, t)
        };
    "function" == typeof Sizzle && (Ma = function(n, t) {
        return Sizzle(n, t)[0] || null
    }, xa = Sizzle, ba = Sizzle.matchesSelector), ta.selection = function() {
        return ta.select(ua.documentElement)
    };
    var _a = ta.selection.prototype = [];
    _a.select = function(n) {
        var t, e, r, u, i = [];
        n = N(n);
        for (var o = -1, a = this.length; ++o < a;) {
            i.push(t = []), t.parentNode = (r = this[o]).parentNode;
            for (var c = -1, l = r.length; ++c < l;)(u = r[c]) ? (t.push(e = n.call(u, u.__data__, c, o)), e && "__data__" in u && (e.__data__ = u.__data__)) : t.push(null)
        }
        return A(i)
    }, _a.selectAll = function(n) {
        var t, e, r = [];
        n = C(n);
        for (var u = -1, i = this.length; ++u < i;)
            for (var o = this[u], a = -1, c = o.length; ++a < c;)(e = o[a]) && (r.push(t = ra(n.call(e, e.__data__, a, u))), t.parentNode = e);
        return A(r)
    };
    var wa = {
        svg: "http://www.w3.org/2000/svg",
        xhtml: "http://www.w3.org/1999/xhtml",
        xlink: "http://www.w3.org/1999/xlink",
        xml: "http://www.w3.org/XML/1998/namespace",
        xmlns: "http://www.w3.org/2000/xmlns/"
    };
    ta.ns = {
        prefix: wa,
        qualify: function(n) {
            var t = n.indexOf(":"),
                e = n;
            return t >= 0 && (e = n.slice(0, t), n = n.slice(t + 1)), wa.hasOwnProperty(e) ? {
                space: wa[e],
                local: n
            } : n
        }
    }, _a.attr = function(n, t) {
        if (arguments.length < 2) {
            if ("string" == typeof n) {
                var e = this.node();
                return n = ta.ns.qualify(n), n.local ? e.getAttributeNS(n.space, n.local) : e.getAttribute(n)
            }
            for (t in n) this.each(z(t, n[t]));
            return this
        }
        return this.each(z(n, t))
    }, _a.classed = function(n, t) {
        if (arguments.length < 2) {
            if ("string" == typeof n) {
                var e = this.node(),
                    r = (n = T(n)).length,
                    u = -1;
                if (t = e.classList) {
                    for (; ++u < r;)
                        if (!t.contains(n[u])) return !1
                } else
                    for (t = e.getAttribute("class"); ++u < r;)
                        if (!L(n[u]).test(t)) return !1;
                return !0
            }
            for (t in n) this.each(R(t, n[t]));
            return this
        }
        return this.each(R(n, t))
    }, _a.style = function(n, e, r) {
        var u = arguments.length;
        if (3 > u) {
            if ("string" != typeof n) {
                2 > u && (e = "");
                for (r in n) this.each(P(r, n[r], e));
                return this
            }
            if (2 > u) {
                var i = this.node();
                return t(i).getComputedStyle(i, null).getPropertyValue(n)
            }
            r = ""
        }
        return this.each(P(n, e, r))
    }, _a.property = function(n, t) {
        if (arguments.length < 2) {
            if ("string" == typeof n) return this.node()[n];
            for (t in n) this.each(U(t, n[t]));
            return this
        }
        return this.each(U(n, t))
    }, _a.text = function(n) {
        return arguments.length ? this.each("function" == typeof n ? function() {
            var t = n.apply(this, arguments);
            this.textContent = null == t ? "" : t
        } : null == n ? function() {
            this.textContent = ""
        } : function() {
            this.textContent = n
        }) : this.node().textContent
    }, _a.html = function(n) {
        return arguments.length ? this.each("function" == typeof n ? function() {
            var t = n.apply(this, arguments);
            this.innerHTML = null == t ? "" : t
        } : null == n ? function() {
            this.innerHTML = ""
        } : function() {
            this.innerHTML = n
        }) : this.node().innerHTML
    }, _a.append = function(n) {
        return n = j(n), this.select(function() {
            return this.appendChild(n.apply(this, arguments))
        })
    }, _a.insert = function(n, t) {
        return n = j(n), t = N(t), this.select(function() {
            return this.insertBefore(n.apply(this, arguments), t.apply(this, arguments) || null)
        })
    }, _a.remove = function() {
        return this.each(F)
    }, _a.data = function(n, t) {
        function e(n, e) {
            var r, u, i, o = n.length,
                f = e.length,
                h = Math.min(o, f),
                g = new Array(f),
                p = new Array(f),
                v = new Array(o);
            if (t) {
                var d, m = new l,
                    y = new Array(o);
                for (r = -1; ++r < o;) m.has(d = t.call(u = n[r], u.__data__, r)) ? v[r] = u : m.set(d, u), y[r] = d;
                for (r = -1; ++r < f;)(u = m.get(d = t.call(e, i = e[r], r))) ? u !== !0 && (g[r] = u, u.__data__ = i) : p[r] = H(i), m.set(d, !0);
                for (r = -1; ++r < o;) m.get(y[r]) !== !0 && (v[r] = n[r])
            } else {
                for (r = -1; ++r < h;) u = n[r], i = e[r], u ? (u.__data__ = i, g[r] = u) : p[r] = H(i);
                for (; f > r; ++r) p[r] = H(e[r]);
                for (; o > r; ++r) v[r] = n[r]
            }
            p.update = g, p.parentNode = g.parentNode = v.parentNode = n.parentNode, a.push(p), c.push(g), s.push(v)
        }
        var r, u, i = -1,
            o = this.length;
        if (!arguments.length) {
            for (n = new Array(o = (r = this[0]).length); ++i < o;)(u = r[i]) && (n[i] = u.__data__);
            return n
        }
        var a = Z([]),
            c = A([]),
            s = A([]);
        if ("function" == typeof n)
            for (; ++i < o;) e(r = this[i], n.call(r, r.parentNode.__data__, i));
        else
            for (; ++i < o;) e(r = this[i], n);
        return c.enter = function() {
            return a
        }, c.exit = function() {
            return s
        }, c
    }, _a.datum = function(n) {
        return arguments.length ? this.property("__data__", n) : this.property("__data__")
    }, _a.filter = function(n) {
        var t, e, r, u = [];
        "function" != typeof n && (n = O(n));
        for (var i = 0, o = this.length; o > i; i++) {
            u.push(t = []), t.parentNode = (e = this[i]).parentNode;
            for (var a = 0, c = e.length; c > a; a++)(r = e[a]) && n.call(r, r.__data__, a, i) && t.push(r)
        }
        return A(u)
    }, _a.order = function() {
        for (var n = -1, t = this.length; ++n < t;)
            for (var e, r = this[n], u = r.length - 1, i = r[u]; --u >= 0;)(e = r[u]) && (i && i !== e.nextSibling && i.parentNode.insertBefore(e, i), i = e);
        return this
    }, _a.sort = function(n) {
        n = I.apply(this, arguments);
        for (var t = -1, e = this.length; ++t < e;) this[t].sort(n);
        return this.order()
    }, _a.each = function(n) {
        return Y(this, function(t, e, r) {
            n.call(t, t.__data__, e, r)
        })
    }, _a.call = function(n) {
        var t = ra(arguments);
        return n.apply(t[0] = this, t), this
    }, _a.empty = function() {
        return !this.node()
    }, _a.node = function() {
        for (var n = 0, t = this.length; t > n; n++)
            for (var e = this[n], r = 0, u = e.length; u > r; r++) {
                var i = e[r];
                if (i) return i
            }
        return null
    }, _a.size = function() {
        var n = 0;
        return Y(this, function() {
            ++n
        }), n
    };
    var Sa = [];
    ta.selection.enter = Z, ta.selection.enter.prototype = Sa, Sa.append = _a.append, Sa.empty = _a.empty, Sa.node = _a.node, Sa.call = _a.call, Sa.size = _a.size, Sa.select = function(n) {
        for (var t, e, r, u, i, o = [], a = -1, c = this.length; ++a < c;) {
            r = (u = this[a]).update, o.push(t = []), t.parentNode = u.parentNode;
            for (var l = -1, s = u.length; ++l < s;)(i = u[l]) ? (t.push(r[l] = e = n.call(u.parentNode, i.__data__, l, a)), e.__data__ = i.__data__) : t.push(null)
        }
        return A(o)
    }, Sa.insert = function(n, t) {
        return arguments.length < 2 && (t = V(this)), _a.insert.call(this, n, t)
    }, ta.select = function(t) {
        var e;
        return "string" == typeof t ? (e = [Ma(t, ua)], e.parentNode = ua.documentElement) : (e = [t], e.parentNode = n(t)), A([e])
    }, ta.selectAll = function(n) {
        var t;
        return "string" == typeof n ? (t = ra(xa(n, ua)), t.parentNode = ua.documentElement) : (t = n, t.parentNode = null), A([t])
    }, _a.on = function(n, t, e) {
        var r = arguments.length;
        if (3 > r) {
            if ("string" != typeof n) {
                2 > r && (t = !1);
                for (e in n) this.each(X(e, n[e], t));
                return this
            }
            if (2 > r) return (r = this.node()["__on" + n]) && r._;
            e = !1
        }
        return this.each(X(n, t, e))
    };
    var ka = ta.map({
        mouseenter: "mouseover",
        mouseleave: "mouseout"
    });
    ua && ka.forEach(function(n) {
        "on" + n in ua && ka.remove(n)
    });
    var Ea, Aa = 0;
    ta.mouse = function(n) {
        return J(n, k())
    };
    var Na = this.navigator && /WebKit/.test(this.navigator.userAgent) ? -1 : 0;
    ta.touch = function(n, t, e) {
        if (arguments.length < 3 && (e = t, t = k().changedTouches), t)
            for (var r, u = 0, i = t.length; i > u; ++u)
                if ((r = t[u]).identifier === e) return J(n, r)
    }, ta.behavior.drag = function() {
        function n() {
            this.on("mousedown.drag", i).on("touchstart.drag", o)
        }

        function e(n, t, e, i, o) {
            return function() {
                function a() {
                    var n, e, r = t(h, v);
                    r && (n = r[0] - M[0], e = r[1] - M[1], p |= n | e, M = r, g({
                        type: "drag",
                        x: r[0] + l[0],
                        y: r[1] + l[1],
                        dx: n,
                        dy: e
                    }))
                }

                function c() {
                    t(h, v) && (m.on(i + d, null).on(o + d, null), y(p && ta.event.target === f), g({
                        type: "dragend"
                    }))
                }
                var l, s = this,
                    f = ta.event.target,
                    h = s.parentNode,
                    g = r.of(s, arguments),
                    p = 0,
                    v = n(),
                    d = ".drag" + (null == v ? "" : "-" + v),
                    m = ta.select(e(f)).on(i + d, a).on(o + d, c),
                    y = W(f),
                    M = t(h, v);
                u ? (l = u.apply(s, arguments), l = [l.x - M[0], l.y - M[1]]) : l = [0, 0], g({
                    type: "dragstart"
                })
            }
        }
        var r = E(n, "drag", "dragstart", "dragend"),
            u = null,
            i = e(b, ta.mouse, t, "mousemove", "mouseup"),
            o = e(G, ta.touch, y, "touchmove", "touchend");
        return n.origin = function(t) {
            return arguments.length ? (u = t, n) : u
        }, ta.rebind(n, r, "on")
    }, ta.touches = function(n, t) {
        return arguments.length < 2 && (t = k().touches), t ? ra(t).map(function(t) {
            var e = J(n, t);
            return e.identifier = t.identifier, e
        }) : []
    };
    var Ca = 1e-6,
        za = Ca * Ca,
        qa = Math.PI,
        La = 2 * qa,
        Ta = La - Ca,
        Ra = qa / 2,
        Da = qa / 180,
        Pa = 180 / qa,
        Ua = Math.SQRT2,
        ja = 2,
        Fa = 4;
    ta.interpolateZoom = function(n, t) {
        function e(n) {
            var t = n * y;
            if (m) {
                var e = rt(v),
                    o = i / (ja * h) * (e * ut(Ua * t + v) - et(v));
                return [r + o * l, u + o * s, i * e / rt(Ua * t + v)]
            }
            return [r + n * l, u + n * s, i * Math.exp(Ua * t)]
        }
        var r = n[0],
            u = n[1],
            i = n[2],
            o = t[0],
            a = t[1],
            c = t[2],
            l = o - r,
            s = a - u,
            f = l * l + s * s,
            h = Math.sqrt(f),
            g = (c * c - i * i + Fa * f) / (2 * i * ja * h),
            p = (c * c - i * i - Fa * f) / (2 * c * ja * h),
            v = Math.log(Math.sqrt(g * g + 1) - g),
            d = Math.log(Math.sqrt(p * p + 1) - p),
            m = d - v,
            y = (m || Math.log(c / i)) / Ua;
        return e.duration = 1e3 * y, e
    }, ta.behavior.zoom = function() {
        function n(n) {
            n.on(q, f).on(Oa + ".zoom", g).on("dblclick.zoom", p).on(R, h)
        }

        function e(n) {
            return [(n[0] - k.x) / k.k, (n[1] - k.y) / k.k]
        }

        function r(n) {
            return [n[0] * k.k + k.x, n[1] * k.k + k.y]
        }

        function u(n) {
            k.k = Math.max(N[0], Math.min(N[1], n))
        }

        function i(n, t) {
            t = r(t), k.x += n[0] - t[0], k.y += n[1] - t[1]
        }

        function o(t, e, r, o) {
            t.__chart__ = {
                x: k.x,
                y: k.y,
                k: k.k
            }, u(Math.pow(2, o)), i(d = e, r), t = ta.select(t), C > 0 && (t = t.transition().duration(C)), t.call(n.event)
        }

        function a() {
            b && b.domain(x.range().map(function(n) {
                return (n - k.x) / k.k
            }).map(x.invert)), w && w.domain(_.range().map(function(n) {
                return (n - k.y) / k.k
            }).map(_.invert))
        }

        function c(n) {
            z++ || n({
                type: "zoomstart"
            })
        }

        function l(n) {
            a(), n({
                type: "zoom",
                scale: k.k,
                translate: [k.x, k.y]
            })
        }

        function s(n) {
            --z || (n({
                type: "zoomend"
            }), d = null)
        }

        function f() {
            function n() {
                f = 1, i(ta.mouse(u), g), l(a)
            }

            function r() {
                h.on(L, null).on(T, null), p(f && ta.event.target === o), s(a)
            }
            var u = this,
                o = ta.event.target,
                a = D.of(u, arguments),
                f = 0,
                h = ta.select(t(u)).on(L, n).on(T, r),
                g = e(ta.mouse(u)),
                p = W(u);
            Dl.call(u), c(a)
        }

        function h() {
            function n() {
                var n = ta.touches(p);
                return g = k.k, n.forEach(function(n) {
                    n.identifier in d && (d[n.identifier] = e(n))
                }), n
            }

            function t() {
                var t = ta.event.target;
                ta.select(t).on(x, r).on(b, a), _.push(t);
                for (var e = ta.event.changedTouches, u = 0, i = e.length; i > u; ++u) d[e[u].identifier] = null;
                var c = n(),
                    l = Date.now();
                if (1 === c.length) {
                    if (500 > l - M) {
                        var s = c[0];
                        o(p, s, d[s.identifier], Math.floor(Math.log(k.k) / Math.LN2) + 1), S()
                    }
                    M = l
                } else if (c.length > 1) {
                    var s = c[0],
                        f = c[1],
                        h = s[0] - f[0],
                        g = s[1] - f[1];
                    m = h * h + g * g
                }
            }

            function r() {
                var n, t, e, r, o = ta.touches(p);
                Dl.call(p);
                for (var a = 0, c = o.length; c > a; ++a, r = null)
                    if (e = o[a], r = d[e.identifier]) {
                        if (t) break;
                        n = e, t = r
                    }
                if (r) {
                    var s = (s = e[0] - n[0]) * s + (s = e[1] - n[1]) * s,
                        f = m && Math.sqrt(s / m);
                    n = [(n[0] + e[0]) / 2, (n[1] + e[1]) / 2], t = [(t[0] + r[0]) / 2, (t[1] + r[1]) / 2], u(f * g)
                }
                M = null, i(n, t), l(v)
            }

            function a() {
                if (ta.event.touches.length) {
                    for (var t = ta.event.changedTouches, e = 0, r = t.length; r > e; ++e) delete d[t[e].identifier];
                    for (var u in d) return void n()
                }
                ta.selectAll(_).on(y, null), w.on(q, f).on(R, h), E(), s(v)
            }
            var g, p = this,
                v = D.of(p, arguments),
                d = {},
                m = 0,
                y = ".zoom-" + ta.event.changedTouches[0].identifier,
                x = "touchmove" + y,
                b = "touchend" + y,
                _ = [],
                w = ta.select(p),
                E = W(p);
            t(), c(v), w.on(q, null).on(R, t)
        }

        function g() {
            var n = D.of(this, arguments);
            y ? clearTimeout(y) : (Dl.call(this), v = e(d = m || ta.mouse(this)), c(n)), y = setTimeout(function() {
                y = null, s(n)
            }, 50), S(), u(Math.pow(2, .002 * Ha()) * k.k), i(d, v), l(n)
        }

        function p() {
            var n = ta.mouse(this),
                t = Math.log(k.k) / Math.LN2;
            o(this, n, e(n), ta.event.shiftKey ? Math.ceil(t) - 1 : Math.floor(t) + 1)
        }
        var v, d, m, y, M, x, b, _, w, k = {
                x: 0,
                y: 0,
                k: 1
            },
            A = [960, 500],
            N = Ia,
            C = 250,
            z = 0,
            q = "mousedown.zoom",
            L = "mousemove.zoom",
            T = "mouseup.zoom",
            R = "touchstart.zoom",
            D = E(n, "zoomstart", "zoom", "zoomend");
        return Oa || (Oa = "onwheel" in ua ? (Ha = function() {
            return -ta.event.deltaY * (ta.event.deltaMode ? 120 : 1)
        }, "wheel") : "onmousewheel" in ua ? (Ha = function() {
            return ta.event.wheelDelta
        }, "mousewheel") : (Ha = function() {
            return -ta.event.detail
        }, "MozMousePixelScroll")), n.event = function(n) {
            n.each(function() {
                var n = D.of(this, arguments),
                    t = k;
                Tl ? ta.select(this).transition().each("start.zoom", function() {
                    k = this.__chart__ || {
                        x: 0,
                        y: 0,
                        k: 1
                    }, c(n)
                }).tween("zoom:zoom", function() {
                    var e = A[0],
                        r = A[1],
                        u = d ? d[0] : e / 2,
                        i = d ? d[1] : r / 2,
                        o = ta.interpolateZoom([(u - k.x) / k.k, (i - k.y) / k.k, e / k.k], [(u - t.x) / t.k, (i - t.y) / t.k, e / t.k]);
                    return function(t) {
                        var r = o(t),
                            a = e / r[2];
                        this.__chart__ = k = {
                            x: u - r[0] * a,
                            y: i - r[1] * a,
                            k: a
                        }, l(n)
                    }
                }).each("interrupt.zoom", function() {
                    s(n)
                }).each("end.zoom", function() {
                    s(n)
                }) : (this.__chart__ = k, c(n), l(n), s(n))
            })
        }, n.translate = function(t) {
            return arguments.length ? (k = {
                x: +t[0],
                y: +t[1],
                k: k.k
            }, a(), n) : [k.x, k.y]
        }, n.scale = function(t) {
            return arguments.length ? (k = {
                x: k.x,
                y: k.y,
                k: +t
            }, a(), n) : k.k
        }, n.scaleExtent = function(t) {
            return arguments.length ? (N = null == t ? Ia : [+t[0], +t[1]], n) : N
        }, n.center = function(t) {
            return arguments.length ? (m = t && [+t[0], +t[1]], n) : m
        }, n.size = function(t) {
            return arguments.length ? (A = t && [+t[0], +t[1]], n) : A
        }, n.duration = function(t) {
            return arguments.length ? (C = +t, n) : C
        }, n.x = function(t) {
            return arguments.length ? (b = t, x = t.copy(), k = {
                x: 0,
                y: 0,
                k: 1
            }, n) : b
        }, n.y = function(t) {
            return arguments.length ? (w = t, _ = t.copy(), k = {
                x: 0,
                y: 0,
                k: 1
            }, n) : w
        }, ta.rebind(n, D, "on")
    };
    var Ha, Oa, Ia = [0, 1 / 0];
    ta.color = ot, ot.prototype.toString = function() {
        return this.rgb() + ""
    }, ta.hsl = at;
    var Ya = at.prototype = new ot;
    Ya.brighter = function(n) {
        return n = Math.pow(.7, arguments.length ? n : 1), new at(this.h, this.s, this.l / n)
    }, Ya.darker = function(n) {
        return n = Math.pow(.7, arguments.length ? n : 1), new at(this.h, this.s, n * this.l)
    }, Ya.rgb = function() {
        return ct(this.h, this.s, this.l)
    }, ta.hcl = lt;
    var Za = lt.prototype = new ot;
    Za.brighter = function(n) {
        return new lt(this.h, this.c, Math.min(100, this.l + Va * (arguments.length ? n : 1)))
    }, Za.darker = function(n) {
        return new lt(this.h, this.c, Math.max(0, this.l - Va * (arguments.length ? n : 1)))
    }, Za.rgb = function() {
        return st(this.h, this.c, this.l).rgb()
    }, ta.lab = ft;
    var Va = 18,
        Xa = .95047,
        $a = 1,
        Ba = 1.08883,
        Wa = ft.prototype = new ot;
    Wa.brighter = function(n) {
        return new ft(Math.min(100, this.l + Va * (arguments.length ? n : 1)), this.a, this.b)
    }, Wa.darker = function(n) {
        return new ft(Math.max(0, this.l - Va * (arguments.length ? n : 1)), this.a, this.b)
    }, Wa.rgb = function() {
        return ht(this.l, this.a, this.b)
    }, ta.rgb = mt;
    var Ja = mt.prototype = new ot;
    Ja.brighter = function(n) {
        n = Math.pow(.7, arguments.length ? n : 1);
        var t = this.r,
            e = this.g,
            r = this.b,
            u = 30;
        return t || e || r ? (t && u > t && (t = u), e && u > e && (e = u), r && u > r && (r = u), new mt(Math.min(255, t / n), Math.min(255, e / n), Math.min(255, r / n))) : new mt(u, u, u)
    }, Ja.darker = function(n) {
        return n = Math.pow(.7, arguments.length ? n : 1), new mt(n * this.r, n * this.g, n * this.b)
    }, Ja.hsl = function() {
        return _t(this.r, this.g, this.b)
    }, Ja.toString = function() {
        return "#" + xt(this.r) + xt(this.g) + xt(this.b)
    };
    var Ga = ta.map({
        aliceblue: 15792383,
        antiquewhite: 16444375,
        aqua: 65535,
        aquamarine: 8388564,
        azure: 15794175,
        beige: 16119260,
        bisque: 16770244,
        black: 0,
        blanchedalmond: 16772045,
        blue: 255,
        blueviolet: 9055202,
        brown: 10824234,
        burlywood: 14596231,
        cadetblue: 6266528,
        chartreuse: 8388352,
        chocolate: 13789470,
        coral: 16744272,
        cornflowerblue: 6591981,
        cornsilk: 16775388,
        crimson: 14423100,
        cyan: 65535,
        darkblue: 139,
        darkcyan: 35723,
        darkgoldenrod: 12092939,
        darkgray: 11119017,
        darkgreen: 25600,
        darkgrey: 11119017,
        darkkhaki: 12433259,
        darkmagenta: 9109643,
        darkolivegreen: 5597999,
        darkorange: 16747520,
        darkorchid: 10040012,
        darkred: 9109504,
        darksalmon: 15308410,
        darkseagreen: 9419919,
        darkslateblue: 4734347,
        darkslategray: 3100495,
        darkslategrey: 3100495,
        darkturquoise: 52945,
        darkviolet: 9699539,
        deeppink: 16716947,
        deepskyblue: 49151,
        dimgray: 6908265,
        dimgrey: 6908265,
        dodgerblue: 2003199,
        firebrick: 11674146,
        floralwhite: 16775920,
        forestgreen: 2263842,
        fuchsia: 16711935,
        gainsboro: 14474460,
        ghostwhite: 16316671,
        gold: 16766720,
        goldenrod: 14329120,
        gray: 8421504,
        green: 32768,
        greenyellow: 11403055,
        grey: 8421504,
        honeydew: 15794160,
        hotpink: 16738740,
        indianred: 13458524,
        indigo: 4915330,
        ivory: 16777200,
        khaki: 15787660,
        lavender: 15132410,
        lavenderblush: 16773365,
        lawngreen: 8190976,
        lemonchiffon: 16775885,
        lightblue: 11393254,
        lightcoral: 15761536,
        lightcyan: 14745599,
        lightgoldenrodyellow: 16448210,
        lightgray: 13882323,
        lightgreen: 9498256,
        lightgrey: 13882323,
        lightpink: 16758465,
        lightsalmon: 16752762,
        lightseagreen: 2142890,
        lightskyblue: 8900346,
        lightslategray: 7833753,
        lightslategrey: 7833753,
        lightsteelblue: 11584734,
        lightyellow: 16777184,
        lime: 65280,
        limegreen: 3329330,
        linen: 16445670,
        magenta: 16711935,
        maroon: 8388608,
        mediumaquamarine: 6737322,
        mediumblue: 205,
        mediumorchid: 12211667,
        mediumpurple: 9662683,
        mediumseagreen: 3978097,
        mediumslateblue: 8087790,
        mediumspringgreen: 64154,
        mediumturquoise: 4772300,
        mediumvioletred: 13047173,
        midnightblue: 1644912,
        mintcream: 16121850,
        mistyrose: 16770273,
        moccasin: 16770229,
        navajowhite: 16768685,
        navy: 128,
        oldlace: 16643558,
        olive: 8421376,
        olivedrab: 7048739,
        orange: 16753920,
        orangered: 16729344,
        orchid: 14315734,
        palegoldenrod: 15657130,
        palegreen: 10025880,
        paleturquoise: 11529966,
        palevioletred: 14381203,
        papayawhip: 16773077,
        peachpuff: 16767673,
        peru: 13468991,
        pink: 16761035,
        plum: 14524637,
        powderblue: 11591910,
        purple: 8388736,
        rebeccapurple: 6697881,
        red: 16711680,
        rosybrown: 12357519,
        royalblue: 4286945,
        saddlebrown: 9127187,
        salmon: 16416882,
        sandybrown: 16032864,
        seagreen: 3050327,
        seashell: 16774638,
        sienna: 10506797,
        silver: 12632256,
        skyblue: 8900331,
        slateblue: 6970061,
        slategray: 7372944,
        slategrey: 7372944,
        snow: 16775930,
        springgreen: 65407,
        steelblue: 4620980,
        tan: 13808780,
        teal: 32896,
        thistle: 14204888,
        tomato: 16737095,
        turquoise: 4251856,
        violet: 15631086,
        wheat: 16113331,
        white: 16777215,
        whitesmoke: 16119285,
        yellow: 16776960,
        yellowgreen: 10145074
    });
    Ga.forEach(function(n, t) {
        Ga.set(n, yt(t))
    }), ta.functor = Et, ta.xhr = At(y), ta.dsv = function(n, t) {
        function e(n, e, i) {
            arguments.length < 3 && (i = e, e = null);
            var o = Nt(n, t, null == e ? r : u(e), i);
            return o.row = function(n) {
                return arguments.length ? o.response(null == (e = n) ? r : u(n)) : e
            }, o
        }

        function r(n) {
            return e.parse(n.responseText)
        }

        function u(n) {
            return function(t) {
                return e.parse(t.responseText, n)
            }
        }

        function i(t) {
            return t.map(o).join(n)
        }

        function o(n) {
            return a.test(n) ? '"' + n.replace(/\"/g, '""') + '"' : n
        }
        var a = new RegExp('["' + n + "\n]"),
            c = n.charCodeAt(0);
        return e.parse = function(n, t) {
            var r;
            return e.parseRows(n, function(n, e) {
                if (r) return r(n, e - 1);
                var u = new Function("d", "return {" + n.map(function(n, t) {
                    return JSON.stringify(n) + ": d[" + t + "]"
                }).join(",") + "}");
                r = t ? function(n, e) {
                    return t(u(n), e)
                } : u
            })
        }, e.parseRows = function(n, t) {
            function e() {
                if (s >= l) return o;
                if (u) return u = !1, i;
                var t = s;
                if (34 === n.charCodeAt(t)) {
                    for (var e = t; e++ < l;)
                        if (34 === n.charCodeAt(e)) {
                            if (34 !== n.charCodeAt(e + 1)) break;
                            ++e
                        }
                    s = e + 2;
                    var r = n.charCodeAt(e + 1);
                    return 13 === r ? (u = !0, 10 === n.charCodeAt(e + 2) && ++s) : 10 === r && (u = !0), n.slice(t + 1, e).replace(/""/g, '"')
                }
                for (; l > s;) {
                    var r = n.charCodeAt(s++),
                        a = 1;
                    if (10 === r) u = !0;
                    else if (13 === r) u = !0, 10 === n.charCodeAt(s) && (++s, ++a);
                    else if (r !== c) continue;
                    return n.slice(t, s - a)
                }
                return n.slice(t)
            }
            for (var r, u, i = {}, o = {}, a = [], l = n.length, s = 0, f = 0;
                (r = e()) !== o;) {
                for (var h = []; r !== i && r !== o;) h.push(r), r = e();
                t && null == (h = t(h, f++)) || a.push(h)
            }
            return a
        }, e.format = function(t) {
            if (Array.isArray(t[0])) return e.formatRows(t);
            var r = new m,
                u = [];
            return t.forEach(function(n) {
                for (var t in n) r.has(t) || u.push(r.add(t))
            }), [u.map(o).join(n)].concat(t.map(function(t) {
                return u.map(function(n) {
                    return o(t[n])
                }).join(n)
            })).join("\n")
        }, e.formatRows = function(n) {
            return n.map(i).join("\n")
        }, e
    }, ta.csv = ta.dsv(",", "text/csv"), ta.tsv = ta.dsv("	", "text/tab-separated-values");
    var Ka, Qa, nc, tc, ec, rc = this[x(this, "requestAnimationFrame")] || function(n) {
        setTimeout(n, 17)
    };
    ta.timer = function(n, t, e) {
        var r = arguments.length;
        2 > r && (t = 0), 3 > r && (e = Date.now());
        var u = e + t,
            i = {
                c: n,
                t: u,
                f: !1,
                n: null
            };
        Qa ? Qa.n = i : Ka = i, Qa = i, nc || (tc = clearTimeout(tc), nc = 1, rc(qt))
    }, ta.timer.flush = function() {
        Lt(), Tt()
    }, ta.round = function(n, t) {
        return t ? Math.round(n * (t = Math.pow(10, t))) / t : Math.round(n)
    };
    var uc = ["y", "z", "a", "f", "p", "n", "\xb5", "m", "", "k", "M", "G", "T", "P", "E", "Z", "Y"].map(Dt);
    ta.formatPrefix = function(n, t) {
        var e = 0;
        return n && (0 > n && (n *= -1), t && (n = ta.round(n, Rt(n, t))), e = 1 + Math.floor(1e-12 + Math.log(n) / Math.LN10), e = Math.max(-24, Math.min(24, 3 * Math.floor((e - 1) / 3)))), uc[8 + e / 3]
    };
    var ic = /(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,
        oc = ta.map({
            b: function(n) {
                return n.toString(2)
            },
            c: function(n) {
                return String.fromCharCode(n)
            },
            o: function(n) {
                return n.toString(8)
            },
            x: function(n) {
                return n.toString(16)
            },
            X: function(n) {
                return n.toString(16).toUpperCase()
            },
            g: function(n, t) {
                return n.toPrecision(t)
            },
            e: function(n, t) {
                return n.toExponential(t)
            },
            f: function(n, t) {
                return n.toFixed(t)
            },
            r: function(n, t) {
                return (n = ta.round(n, Rt(n, t))).toFixed(Math.max(0, Math.min(20, Rt(n * (1 + 1e-15), t))))
            }
        }),
        ac = ta.time = {},
        cc = Date;
    jt.prototype = {
        getDate: function() {
            return this._.getUTCDate()
        },
        getDay: function() {
            return this._.getUTCDay()
        },
        getFullYear: function() {
            return this._.getUTCFullYear()
        },
        getHours: function() {
            return this._.getUTCHours()
        },
        getMilliseconds: function() {
            return this._.getUTCMilliseconds()
        },
        getMinutes: function() {
            return this._.getUTCMinutes()
        },
        getMonth: function() {
            return this._.getUTCMonth()
        },
        getSeconds: function() {
            return this._.getUTCSeconds()
        },
        getTime: function() {
            return this._.getTime()
        },
        getTimezoneOffset: function() {
            return 0
        },
        valueOf: function() {
            return this._.valueOf()
        },
        setDate: function() {
            lc.setUTCDate.apply(this._, arguments)
        },
        setDay: function() {
            lc.setUTCDay.apply(this._, arguments)
        },
        setFullYear: function() {
            lc.setUTCFullYear.apply(this._, arguments)
        },
        setHours: function() {
            lc.setUTCHours.apply(this._, arguments)
        },
        setMilliseconds: function() {
            lc.setUTCMilliseconds.apply(this._, arguments)
        },
        setMinutes: function() {
            lc.setUTCMinutes.apply(this._, arguments)
        },
        setMonth: function() {
            lc.setUTCMonth.apply(this._, arguments)
        },
        setSeconds: function() {
            lc.setUTCSeconds.apply(this._, arguments)
        },
        setTime: function() {
            lc.setTime.apply(this._, arguments)
        }
    };
    var lc = Date.prototype;
    ac.year = Ft(function(n) {
        return n = ac.day(n), n.setMonth(0, 1), n
    }, function(n, t) {
        n.setFullYear(n.getFullYear() + t)
    }, function(n) {
        return n.getFullYear()
    }), ac.years = ac.year.range, ac.years.utc = ac.year.utc.range, ac.day = Ft(function(n) {
        var t = new cc(2e3, 0);
        return t.setFullYear(n.getFullYear(), n.getMonth(), n.getDate()), t
    }, function(n, t) {
        n.setDate(n.getDate() + t)
    }, function(n) {
        return n.getDate() - 1
    }), ac.days = ac.day.range, ac.days.utc = ac.day.utc.range, ac.dayOfYear = function(n) {
        var t = ac.year(n);
        return Math.floor((n - t - 6e4 * (n.getTimezoneOffset() - t.getTimezoneOffset())) / 864e5)
    }, ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"].forEach(function(n, t) {
        t = 7 - t;
        var e = ac[n] = Ft(function(n) {
            return (n = ac.day(n)).setDate(n.getDate() - (n.getDay() + t) % 7), n
        }, function(n, t) {
            n.setDate(n.getDate() + 7 * Math.floor(t))
        }, function(n) {
            var e = ac.year(n).getDay();
            return Math.floor((ac.dayOfYear(n) + (e + t) % 7) / 7) - (e !== t)
        });
        ac[n + "s"] = e.range, ac[n + "s"].utc = e.utc.range, ac[n + "OfYear"] = function(n) {
            var e = ac.year(n).getDay();
            return Math.floor((ac.dayOfYear(n) + (e + t) % 7) / 7)
        }
    }), ac.week = ac.sunday, ac.weeks = ac.sunday.range, ac.weeks.utc = ac.sunday.utc.range, ac.weekOfYear = ac.sundayOfYear;
    var sc = {
            "-": "",
            _: " ",
            0: "0"
        },
        fc = /^\s*\d+/,
        hc = /^%/;
    ta.locale = function(n) {
        return {
            numberFormat: Pt(n),
            timeFormat: Ot(n)
        }
    };
    var gc = ta.locale({
        decimal: ".",
        thousands: ",",
        grouping: [3],
        currency: ["$", ""],
        dateTime: "%a %b %e %X %Y",
        date: "%m/%d/%Y",
        time: "%H:%M:%S",
        periods: ["AM", "PM"],
        days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        shortDays: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        shortMonths: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
    });
    ta.format = gc.numberFormat, ta.geo = {}, ce.prototype = {
        s: 0,
        t: 0,
        add: function(n) {
            le(n, this.t, pc), le(pc.s, this.s, this), this.s ? this.t += pc.t : this.s = pc.t
        },
        reset: function() {
            this.s = this.t = 0
        },
        valueOf: function() {
            return this.s
        }
    };
    var pc = new ce;
    ta.geo.stream = function(n, t) {
        n && vc.hasOwnProperty(n.type) ? vc[n.type](n, t) : se(n, t)
    };
    var vc = {
            Feature: function(n, t) {
                se(n.geometry, t)
            },
            FeatureCollection: function(n, t) {
                for (var e = n.features, r = -1, u = e.length; ++r < u;) se(e[r].geometry, t)
            }
        },
        dc = {
            Sphere: function(n, t) {
                t.sphere()
            },
            Point: function(n, t) {
                n = n.coordinates, t.point(n[0], n[1], n[2])
            },
            MultiPoint: function(n, t) {
                for (var e = n.coordinates, r = -1, u = e.length; ++r < u;) n = e[r], t.point(n[0], n[1], n[2])
            },
            LineString: function(n, t) {
                fe(n.coordinates, t, 0)
            },
            MultiLineString: function(n, t) {
                for (var e = n.coordinates, r = -1, u = e.length; ++r < u;) fe(e[r], t, 0)
            },
            Polygon: function(n, t) {
                he(n.coordinates, t)
            },
            MultiPolygon: function(n, t) {
                for (var e = n.coordinates, r = -1, u = e.length; ++r < u;) he(e[r], t)
            },
            GeometryCollection: function(n, t) {
                for (var e = n.geometries, r = -1, u = e.length; ++r < u;) se(e[r], t)
            }
        };
    ta.geo.area = function(n) {
        return mc = 0, ta.geo.stream(n, Mc), mc
    };
    var mc, yc = new ce,
        Mc = {
            sphere: function() {
                mc += 4 * qa
            },
            point: b,
            lineStart: b,
            lineEnd: b,
            polygonStart: function() {
                yc.reset(), Mc.lineStart = ge
            },
            polygonEnd: function() {
                var n = 2 * yc;
                mc += 0 > n ? 4 * qa + n : n, Mc.lineStart = Mc.lineEnd = Mc.point = b
            }
        };
    ta.geo.bounds = function() {
        function n(n, t) {
            M.push(x = [s = n, h = n]), f > t && (f = t), t > g && (g = t)
        }

        function t(t, e) {
            var r = pe([t * Da, e * Da]);
            if (m) {
                var u = de(m, r),
                    i = [u[1], -u[0], 0],
                    o = de(i, u);
                Me(o), o = xe(o);
                var c = t - p,
                    l = c > 0 ? 1 : -1,
                    v = o[0] * Pa * l,
                    d = ga(c) > 180;
                if (d ^ (v > l * p && l * t > v)) {
                    var y = o[1] * Pa;
                    y > g && (g = y)
                } else if (v = (v + 360) % 360 - 180, d ^ (v > l * p && l * t > v)) {
                    var y = -o[1] * Pa;
                    f > y && (f = y)
                } else f > e && (f = e), e > g && (g = e);
                d ? p > t ? a(s, t) > a(s, h) && (h = t) : a(t, h) > a(s, h) && (s = t) : h >= s ? (s > t && (s = t), t > h && (h = t)) : t > p ? a(s, t) > a(s, h) && (h = t) : a(t, h) > a(s, h) && (s = t)
            } else n(t, e);
            m = r, p = t
        }

        function e() {
            b.point = t
        }

        function r() {
            x[0] = s, x[1] = h, b.point = n, m = null
        }

        function u(n, e) {
            if (m) {
                var r = n - p;
                y += ga(r) > 180 ? r + (r > 0 ? 360 : -360) : r
            } else v = n, d = e;
            Mc.point(n, e), t(n, e)
        }

        function i() {
            Mc.lineStart()
        }

        function o() {
            u(v, d), Mc.lineEnd(), ga(y) > Ca && (s = -(h = 180)), x[0] = s, x[1] = h, m = null
        }

        function a(n, t) {
            return (t -= n) < 0 ? t + 360 : t
        }

        function c(n, t) {
            return n[0] - t[0]
        }

        function l(n, t) {
            return t[0] <= t[1] ? t[0] <= n && n <= t[1] : n < t[0] || t[1] < n
        }
        var s, f, h, g, p, v, d, m, y, M, x, b = {
            point: n,
            lineStart: e,
            lineEnd: r,
            polygonStart: function() {
                b.point = u, b.lineStart = i, b.lineEnd = o, y = 0, Mc.polygonStart()
            },
            polygonEnd: function() {
                Mc.polygonEnd(), b.point = n, b.lineStart = e, b.lineEnd = r, 0 > yc ? (s = -(h = 180), f = -(g = 90)) : y > Ca ? g = 90 : -Ca > y && (f = -90), x[0] = s, x[1] = h
            }
        };
        return function(n) {
            g = h = -(s = f = 1 / 0), M = [], ta.geo.stream(n, b);
            var t = M.length;
            if (t) {
                M.sort(c);
                for (var e, r = 1, u = M[0], i = [u]; t > r; ++r) e = M[r], l(e[0], u) || l(e[1], u) ? (a(u[0], e[1]) > a(u[0], u[1]) && (u[1] = e[1]), a(e[0], u[1]) > a(u[0], u[1]) && (u[0] = e[0])) : i.push(u = e);
                for (var o, e, p = -1 / 0, t = i.length - 1, r = 0, u = i[t]; t >= r; u = e, ++r) e = i[r], (o = a(u[1], e[0])) > p && (p = o, s = e[0], h = u[1])
            }
            return M = x = null, 1 / 0 === s || 1 / 0 === f ? [
                [0 / 0, 0 / 0],
                [0 / 0, 0 / 0]
            ] : [
                [s, f],
                [h, g]
            ]
        }
    }(), ta.geo.centroid = function(n) {
        xc = bc = _c = wc = Sc = kc = Ec = Ac = Nc = Cc = zc = 0, ta.geo.stream(n, qc);
        var t = Nc,
            e = Cc,
            r = zc,
            u = t * t + e * e + r * r;
        return za > u && (t = kc, e = Ec, r = Ac, Ca > bc && (t = _c, e = wc, r = Sc), u = t * t + e * e + r * r, za > u) ? [0 / 0, 0 / 0] : [Math.atan2(e, t) * Pa, tt(r / Math.sqrt(u)) * Pa]
    };
    var xc, bc, _c, wc, Sc, kc, Ec, Ac, Nc, Cc, zc, qc = {
            sphere: b,
            point: _e,
            lineStart: Se,
            lineEnd: ke,
            polygonStart: function() {
                qc.lineStart = Ee
            },
            polygonEnd: function() {
                qc.lineStart = Se
            }
        },
        Lc = Le(Ne, Pe, je, [-qa, -qa / 2]),
        Tc = 1e9;
    ta.geo.clipExtent = function() {
        var n, t, e, r, u, i, o = {
            stream: function(n) {
                return u && (u.valid = !1), u = i(n), u.valid = !0, u
            },
            extent: function(a) {
                return arguments.length ? (i = Ie(n = +a[0][0], t = +a[0][1], e = +a[1][0], r = +a[1][1]), u && (u.valid = !1, u = null), o) : [
                    [n, t],
                    [e, r]
                ]
            }
        };
        return o.extent([
            [0, 0],
            [960, 500]
        ])
    }, (ta.geo.conicEqualArea = function() {
        return Ye(Ze)
    }).raw = Ze, ta.geo.albers = function() {
        return ta.geo.conicEqualArea().rotate([96, 0]).center([-.6, 38.7]).parallels([29.5, 45.5]).scale(1070)
    }, ta.geo.albersUsa = function() {
        function n(n) {
            var i = n[0],
                o = n[1];
            return t = null, e(i, o), t || (r(i, o), t) || u(i, o), t
        }
        var t, e, r, u, i = ta.geo.albers(),
            o = ta.geo.conicEqualArea().rotate([154, 0]).center([-2, 58.5]).parallels([55, 65]),
            a = ta.geo.conicEqualArea().rotate([157, 0]).center([-3, 19.9]).parallels([8, 18]),
            c = {
                point: function(n, e) {
                    t = [n, e]
                }
            };
        return n.invert = function(n) {
            var t = i.scale(),
                e = i.translate(),
                r = (n[0] - e[0]) / t,
                u = (n[1] - e[1]) / t;
            return (u >= .12 && .234 > u && r >= -.425 && -.214 > r ? o : u >= .166 && .234 > u && r >= -.214 && -.115 > r ? a : i).invert(n)
        }, n.stream = function(n) {
            var t = i.stream(n),
                e = o.stream(n),
                r = a.stream(n);
            return {
                point: function(n, u) {
                    t.point(n, u), e.point(n, u), r.point(n, u)
                },
                sphere: function() {
                    t.sphere(), e.sphere(), r.sphere()
                },
                lineStart: function() {
                    t.lineStart(), e.lineStart(), r.lineStart()
                },
                lineEnd: function() {
                    t.lineEnd(), e.lineEnd(), r.lineEnd()
                },
                polygonStart: function() {
                    t.polygonStart(), e.polygonStart(), r.polygonStart()
                },
                polygonEnd: function() {
                    t.polygonEnd(), e.polygonEnd(), r.polygonEnd()
                }
            }
        }, n.precision = function(t) {
            return arguments.length ? (i.precision(t), o.precision(t), a.precision(t), n) : i.precision()
        }, n.scale = function(t) {
            return arguments.length ? (i.scale(t), o.scale(.35 * t), a.scale(t), n.translate(i.translate())) : i.scale()
        }, n.translate = function(t) {
            if (!arguments.length) return i.translate();
            var l = i.scale(),
                s = +t[0],
                f = +t[1];
            return e = i.translate(t).clipExtent([
                [s - .455 * l, f - .238 * l],
                [s + .455 * l, f + .238 * l]
            ]).stream(c).point, r = o.translate([s - .307 * l, f + .201 * l]).clipExtent([
                [s - .425 * l + Ca, f + .12 * l + Ca],
                [s - .214 * l - Ca, f + .234 * l - Ca]
            ]).stream(c).point, u = a.translate([s - .205 * l, f + .212 * l]).clipExtent([
                [s - .214 * l + Ca, f + .166 * l + Ca],
                [s - .115 * l - Ca, f + .234 * l - Ca]
            ]).stream(c).point, n
        }, n.scale(1070)
    };
    var Rc, Dc, Pc, Uc, jc, Fc, Hc = {
            point: b,
            lineStart: b,
            lineEnd: b,
            polygonStart: function() {
                Dc = 0, Hc.lineStart = Ve
            },
            polygonEnd: function() {
                Hc.lineStart = Hc.lineEnd = Hc.point = b, Rc += ga(Dc / 2)
            }
        },
        Oc = {
            point: Xe,
            lineStart: b,
            lineEnd: b,
            polygonStart: b,
            polygonEnd: b
        },
        Ic = {
            point: We,
            lineStart: Je,
            lineEnd: Ge,
            polygonStart: function() {
                Ic.lineStart = Ke
            },
            polygonEnd: function() {
                Ic.point = We, Ic.lineStart = Je, Ic.lineEnd = Ge
            }
        };
    ta.geo.path = function() {
        function n(n) {
            return n && ("function" == typeof a && i.pointRadius(+a.apply(this, arguments)), o && o.valid || (o = u(i)), ta.geo.stream(n, o)), i.result()
        }

        function t() {
            return o = null, n
        }
        var e, r, u, i, o, a = 4.5;
        return n.area = function(n) {
            return Rc = 0, ta.geo.stream(n, u(Hc)), Rc
        }, n.centroid = function(n) {
            return _c = wc = Sc = kc = Ec = Ac = Nc = Cc = zc = 0, ta.geo.stream(n, u(Ic)), zc ? [Nc / zc, Cc / zc] : Ac ? [kc / Ac, Ec / Ac] : Sc ? [_c / Sc, wc / Sc] : [0 / 0, 0 / 0]
        }, n.bounds = function(n) {
            return jc = Fc = -(Pc = Uc = 1 / 0), ta.geo.stream(n, u(Oc)), [
                [Pc, Uc],
                [jc, Fc]
            ]
        }, n.projection = function(n) {
            return arguments.length ? (u = (e = n) ? n.stream || tr(n) : y, t()) : e
        }, n.context = function(n) {
            return arguments.length ? (i = null == (r = n) ? new $e : new Qe(n), "function" != typeof a && i.pointRadius(a), t()) : r
        }, n.pointRadius = function(t) {
            return arguments.length ? (a = "function" == typeof t ? t : (i.pointRadius(+t), +t), n) : a
        }, n.projection(ta.geo.albersUsa()).context(null)
    }, ta.geo.transform = function(n) {
        return {
            stream: function(t) {
                var e = new er(t);
                for (var r in n) e[r] = n[r];
                return e
            }
        }
    }, er.prototype = {
        point: function(n, t) {
            this.stream.point(n, t)
        },
        sphere: function() {
            this.stream.sphere()
        },
        lineStart: function() {
            this.stream.lineStart()
        },
        lineEnd: function() {
            this.stream.lineEnd()
        },
        polygonStart: function() {
            this.stream.polygonStart()
        },
        polygonEnd: function() {
            this.stream.polygonEnd()
        }
    }, ta.geo.projection = ur, ta.geo.projectionMutator = ir, (ta.geo.equirectangular = function() {
        return ur(ar)
    }).raw = ar.invert = ar, ta.geo.rotation = function(n) {
        function t(t) {
            return t = n(t[0] * Da, t[1] * Da), t[0] *= Pa, t[1] *= Pa, t
        }
        return n = lr(n[0] % 360 * Da, n[1] * Da, n.length > 2 ? n[2] * Da : 0), t.invert = function(t) {
            return t = n.invert(t[0] * Da, t[1] * Da), t[0] *= Pa, t[1] *= Pa, t
        }, t
    }, cr.invert = ar, ta.geo.circle = function() {
        function n() {
            var n = "function" == typeof r ? r.apply(this, arguments) : r,
                t = lr(-n[0] * Da, -n[1] * Da, 0).invert,
                u = [];
            return e(null, null, 1, {
                point: function(n, e) {
                    u.push(n = t(n, e)), n[0] *= Pa, n[1] *= Pa
                }
            }), {
                type: "Polygon",
                coordinates: [u]
            }
        }
        var t, e, r = [0, 0],
            u = 6;
        return n.origin = function(t) {
            return arguments.length ? (r = t, n) : r
        }, n.angle = function(r) {
            return arguments.length ? (e = gr((t = +r) * Da, u * Da), n) : t
        }, n.precision = function(r) {
            return arguments.length ? (e = gr(t * Da, (u = +r) * Da), n) : u
        }, n.angle(90)
    }, ta.geo.distance = function(n, t) {
        var e, r = (t[0] - n[0]) * Da,
            u = n[1] * Da,
            i = t[1] * Da,
            o = Math.sin(r),
            a = Math.cos(r),
            c = Math.sin(u),
            l = Math.cos(u),
            s = Math.sin(i),
            f = Math.cos(i);
        return Math.atan2(Math.sqrt((e = f * o) * e + (e = l * s - c * f * a) * e), c * s + l * f * a)
    }, ta.geo.graticule = function() {
        function n() {
            return {
                type: "MultiLineString",
                coordinates: t()
            }
        }

        function t() {
            return ta.range(Math.ceil(i / d) * d, u, d).map(h).concat(ta.range(Math.ceil(l / m) * m, c, m).map(g)).concat(ta.range(Math.ceil(r / p) * p, e, p).filter(function(n) {
                return ga(n % d) > Ca
            }).map(s)).concat(ta.range(Math.ceil(a / v) * v, o, v).filter(function(n) {
                return ga(n % m) > Ca
            }).map(f))
        }
        var e, r, u, i, o, a, c, l, s, f, h, g, p = 10,
            v = p,
            d = 90,
            m = 360,
            y = 2.5;
        return n.lines = function() {
            return t().map(function(n) {
                return {
                    type: "LineString",
                    coordinates: n
                }
            })
        }, n.outline = function() {
            return {
                type: "Polygon",
                coordinates: [h(i).concat(g(c).slice(1), h(u).reverse().slice(1), g(l).reverse().slice(1))]
            }
        }, n.extent = function(t) {
            return arguments.length ? n.majorExtent(t).minorExtent(t) : n.minorExtent()
        }, n.majorExtent = function(t) {
            return arguments.length ? (i = +t[0][0], u = +t[1][0], l = +t[0][1], c = +t[1][1], i > u && (t = i, i = u, u = t), l > c && (t = l, l = c, c = t), n.precision(y)) : [
                [i, l],
                [u, c]
            ]
        }, n.minorExtent = function(t) {
            return arguments.length ? (r = +t[0][0], e = +t[1][0], a = +t[0][1], o = +t[1][1], r > e && (t = r, r = e, e = t), a > o && (t = a, a = o, o = t), n.precision(y)) : [
                [r, a],
                [e, o]
            ]
        }, n.step = function(t) {
            return arguments.length ? n.majorStep(t).minorStep(t) : n.minorStep()
        }, n.majorStep = function(t) {
            return arguments.length ? (d = +t[0], m = +t[1], n) : [d, m]
        }, n.minorStep = function(t) {
            return arguments.length ? (p = +t[0], v = +t[1], n) : [p, v]
        }, n.precision = function(t) {
            return arguments.length ? (y = +t, s = vr(a, o, 90), f = dr(r, e, y), h = vr(l, c, 90), g = dr(i, u, y), n) : y
        }, n.majorExtent([
            [-180, -90 + Ca],
            [180, 90 - Ca]
        ]).minorExtent([
            [-180, -80 - Ca],
            [180, 80 + Ca]
        ])
    }, ta.geo.greatArc = function() {
        function n() {
            return {
                type: "LineString",
                coordinates: [t || r.apply(this, arguments), e || u.apply(this, arguments)]
            }
        }
        var t, e, r = mr,
            u = yr;
        return n.distance = function() {
            return ta.geo.distance(t || r.apply(this, arguments), e || u.apply(this, arguments))
        }, n.source = function(e) {
            return arguments.length ? (r = e, t = "function" == typeof e ? null : e, n) : r
        }, n.target = function(t) {
            return arguments.length ? (u = t, e = "function" == typeof t ? null : t, n) : u
        }, n.precision = function() {
            return arguments.length ? n : 0
        }, n
    }, ta.geo.interpolate = function(n, t) {
        return Mr(n[0] * Da, n[1] * Da, t[0] * Da, t[1] * Da)
    }, ta.geo.length = function(n) {
        return Yc = 0, ta.geo.stream(n, Zc), Yc
    };
    var Yc, Zc = {
            sphere: b,
            point: b,
            lineStart: xr,
            lineEnd: b,
            polygonStart: b,
            polygonEnd: b
        },
        Vc = br(function(n) {
            return Math.sqrt(2 / (1 + n))
        }, function(n) {
            return 2 * Math.asin(n / 2)
        });
    (ta.geo.azimuthalEqualArea = function() {
        return ur(Vc)
    }).raw = Vc;
    var Xc = br(function(n) {
        var t = Math.acos(n);
        return t && t / Math.sin(t)
    }, y);
    (ta.geo.azimuthalEquidistant = function() {
        return ur(Xc)
    }).raw = Xc, (ta.geo.conicConformal = function() {
        return Ye(_r)
    }).raw = _r, (ta.geo.conicEquidistant = function() {
        return Ye(wr)
    }).raw = wr;
    var $c = br(function(n) {
        return 1 / n
    }, Math.atan);
    (ta.geo.gnomonic = function() {
        return ur($c)
    }).raw = $c, Sr.invert = function(n, t) {
        return [n, 2 * Math.atan(Math.exp(t)) - Ra]
    }, (ta.geo.mercator = function() {
        return kr(Sr)
    }).raw = Sr;
    var Bc = br(function() {
        return 1
    }, Math.asin);
    (ta.geo.orthographic = function() {
        return ur(Bc)
    }).raw = Bc;
    var Wc = br(function(n) {
        return 1 / (1 + n)
    }, function(n) {
        return 2 * Math.atan(n)
    });
    (ta.geo.stereographic = function() {
        return ur(Wc)
    }).raw = Wc, Er.invert = function(n, t) {
        return [-t, 2 * Math.atan(Math.exp(n)) - Ra]
    }, (ta.geo.transverseMercator = function() {
        var n = kr(Er),
            t = n.center,
            e = n.rotate;
        return n.center = function(n) {
            return n ? t([-n[1], n[0]]) : (n = t(), [n[1], -n[0]])
        }, n.rotate = function(n) {
            return n ? e([n[0], n[1], n.length > 2 ? n[2] + 90 : 90]) : (n = e(), [n[0], n[1], n[2] - 90])
        }, e([0, 0, 90])
    }).raw = Er, ta.geom = {}, ta.geom.hull = function(n) {
        function t(n) {
            if (n.length < 3) return [];
            var t, u = Et(e),
                i = Et(r),
                o = n.length,
                a = [],
                c = [];
            for (t = 0; o > t; t++) a.push([+u.call(this, n[t], t), +i.call(this, n[t], t), t]);
            for (a.sort(zr), t = 0; o > t; t++) c.push([a[t][0], -a[t][1]]);
            var l = Cr(a),
                s = Cr(c),
                f = s[0] === l[0],
                h = s[s.length - 1] === l[l.length - 1],
                g = [];
            for (t = l.length - 1; t >= 0; --t) g.push(n[a[l[t]][2]]);
            for (t = +f; t < s.length - h; ++t) g.push(n[a[s[t]][2]]);
            return g
        }
        var e = Ar,
            r = Nr;
        return arguments.length ? t(n) : (t.x = function(n) {
            return arguments.length ? (e = n, t) : e
        }, t.y = function(n) {
            return arguments.length ? (r = n, t) : r
        }, t)
    }, ta.geom.polygon = function(n) {
        return ya(n, Jc), n
    };
    var Jc = ta.geom.polygon.prototype = [];
    Jc.area = function() {
        for (var n, t = -1, e = this.length, r = this[e - 1], u = 0; ++t < e;) n = r, r = this[t], u += n[1] * r[0] - n[0] * r[1];
        return .5 * u
    }, Jc.centroid = function(n) {
        var t, e, r = -1,
            u = this.length,
            i = 0,
            o = 0,
            a = this[u - 1];
        for (arguments.length || (n = -1 / (6 * this.area())); ++r < u;) t = a, a = this[r], e = t[0] * a[1] - a[0] * t[1], i += (t[0] + a[0]) * e, o += (t[1] + a[1]) * e;
        return [i * n, o * n]
    }, Jc.clip = function(n) {
        for (var t, e, r, u, i, o, a = Tr(n), c = -1, l = this.length - Tr(this), s = this[l - 1]; ++c < l;) {
            for (t = n.slice(), n.length = 0, u = this[c], i = t[(r = t.length - a) - 1], e = -1; ++e < r;) o = t[e], qr(o, s, u) ? (qr(i, s, u) || n.push(Lr(i, o, s, u)), n.push(o)) : qr(i, s, u) && n.push(Lr(i, o, s, u)), i = o;
            a && n.push(n[0]), s = u
        }
        return n
    };
    var Gc, Kc, Qc, nl, tl, el = [],
        rl = [];
    Or.prototype.prepare = function() {
        for (var n, t = this.edges, e = t.length; e--;) n = t[e].edge, n.b && n.a || t.splice(e, 1);
        return t.sort(Yr), t.length
    }, Qr.prototype = {
        start: function() {
            return this.edge.l === this.site ? this.edge.a : this.edge.b
        },
        end: function() {
            return this.edge.l === this.site ? this.edge.b : this.edge.a
        }
    }, nu.prototype = {
        insert: function(n, t) {
            var e, r, u;
            if (n) {
                if (t.P = n, t.N = n.N, n.N && (n.N.P = t), n.N = t, n.R) {
                    for (n = n.R; n.L;) n = n.L;
                    n.L = t
                } else n.R = t;
                e = n
            } else this._ ? (n = uu(this._), t.P = null, t.N = n, n.P = n.L = t, e = n) : (t.P = t.N = null, this._ = t, e = null);
            for (t.L = t.R = null, t.U = e, t.C = !0, n = t; e && e.C;) r = e.U, e === r.L ? (u = r.R, u && u.C ? (e.C = u.C = !1, r.C = !0, n = r) : (n === e.R && (eu(this, e), n = e, e = n.U), e.C = !1, r.C = !0, ru(this, r))) : (u = r.L, u && u.C ? (e.C = u.C = !1, r.C = !0, n = r) : (n === e.L && (ru(this, e), n = e, e = n.U), e.C = !1, r.C = !0, eu(this, r))), e = n.U;
            this._.C = !1
        },
        remove: function(n) {
            n.N && (n.N.P = n.P), n.P && (n.P.N = n.N), n.N = n.P = null;
            var t, e, r, u = n.U,
                i = n.L,
                o = n.R;
            if (e = i ? o ? uu(o) : i : o, u ? u.L === n ? u.L = e : u.R = e : this._ = e, i && o ? (r = e.C, e.C = n.C, e.L = i, i.U = e, e !== o ? (u = e.U, e.U = n.U, n = e.R, u.L = n, e.R = o, o.U = e) : (e.U = u, u = e, n = e.R)) : (r = n.C, n = e), n && (n.U = u), !r) {
                if (n && n.C) return void(n.C = !1);
                do {
                    if (n === this._) break;
                    if (n === u.L) {
                        if (t = u.R, t.C && (t.C = !1, u.C = !0, eu(this, u), t = u.R), t.L && t.L.C || t.R && t.R.C) {
                            t.R && t.R.C || (t.L.C = !1, t.C = !0, ru(this, t), t = u.R), t.C = u.C, u.C = t.R.C = !1, eu(this, u), n = this._;
                            break
                        }
                    } else if (t = u.L, t.C && (t.C = !1, u.C = !0, ru(this, u), t = u.L), t.L && t.L.C || t.R && t.R.C) {
                        t.L && t.L.C || (t.R.C = !1, t.C = !0, eu(this, t), t = u.L), t.C = u.C, u.C = t.L.C = !1, ru(this, u), n = this._;
                        break
                    }
                    t.C = !0, n = u, u = u.U
                } while (!n.C);
                n && (n.C = !1)
            }
        }
    }, ta.geom.voronoi = function(n) {
        function t(n) {
            var t = new Array(n.length),
                r = a[0][0],
                u = a[0][1],
                i = a[1][0],
                o = a[1][1];
            return iu(e(n), a).cells.forEach(function(e, a) {
                var c = e.edges,
                    l = e.site,
                    s = t[a] = c.length ? c.map(function(n) {
                        var t = n.start();
                        return [t.x, t.y]
                    }) : l.x >= r && l.x <= i && l.y >= u && l.y <= o ? [
                        [r, o],
                        [i, o],
                        [i, u],
                        [r, u]
                    ] : [];
                s.point = n[a]
            }), t
        }

        function e(n) {
            return n.map(function(n, t) {
                return {
                    x: Math.round(i(n, t) / Ca) * Ca,
                    y: Math.round(o(n, t) / Ca) * Ca,
                    i: t
                }
            })
        }
        var r = Ar,
            u = Nr,
            i = r,
            o = u,
            a = ul;
        return n ? t(n) : (t.links = function(n) {
            return iu(e(n)).edges.filter(function(n) {
                return n.l && n.r
            }).map(function(t) {
                return {
                    source: n[t.l.i],
                    target: n[t.r.i]
                }
            })
        }, t.triangles = function(n) {
            var t = [];
            return iu(e(n)).cells.forEach(function(e, r) {
                for (var u, i, o = e.site, a = e.edges.sort(Yr), c = -1, l = a.length, s = a[l - 1].edge, f = s.l === o ? s.r : s.l; ++c < l;) u = s, i = f, s = a[c].edge, f = s.l === o ? s.r : s.l, r < i.i && r < f.i && au(o, i, f) < 0 && t.push([n[r], n[i.i], n[f.i]])
            }), t
        }, t.x = function(n) {
            return arguments.length ? (i = Et(r = n), t) : r
        }, t.y = function(n) {
            return arguments.length ? (o = Et(u = n), t) : u
        }, t.clipExtent = function(n) {
            return arguments.length ? (a = null == n ? ul : n, t) : a === ul ? null : a
        }, t.size = function(n) {
            return arguments.length ? t.clipExtent(n && [
                [0, 0], n
            ]) : a === ul ? null : a && a[1]
        }, t)
    };
    var ul = [
        [-1e6, -1e6],
        [1e6, 1e6]
    ];
    ta.geom.delaunay = function(n) {
        return ta.geom.voronoi().triangles(n)
    }, ta.geom.quadtree = function(n, t, e, r, u) {
        function i(n) {
            function i(n, t, e, r, u, i, o, a) {
                if (!isNaN(e) && !isNaN(r))
                    if (n.leaf) {
                        var c = n.x,
                            s = n.y;
                        if (null != c)
                            if (ga(c - e) + ga(s - r) < .01) l(n, t, e, r, u, i, o, a);
                            else {
                                var f = n.point;
                                n.x = n.y = n.point = null, l(n, f, c, s, u, i, o, a), l(n, t, e, r, u, i, o, a)
                            }
                        else n.x = e, n.y = r, n.point = t
                    } else l(n, t, e, r, u, i, o, a)
            }

            function l(n, t, e, r, u, o, a, c) {
                var l = .5 * (u + a),
                    s = .5 * (o + c),
                    f = e >= l,
                    h = r >= s,
                    g = h << 1 | f;
                n.leaf = !1, n = n.nodes[g] || (n.nodes[g] = su()), f ? u = l : a = l, h ? o = s : c = s, i(n, t, e, r, u, o, a, c)
            }
            var s, f, h, g, p, v, d, m, y, M = Et(a),
                x = Et(c);
            if (null != t) v = t, d = e, m = r, y = u;
            else if (m = y = -(v = d = 1 / 0), f = [], h = [], p = n.length, o)
                for (g = 0; p > g; ++g) s = n[g], s.x < v && (v = s.x), s.y < d && (d = s.y), s.x > m && (m = s.x), s.y > y && (y = s.y), f.push(s.x), h.push(s.y);
            else
                for (g = 0; p > g; ++g) {
                    var b = +M(s = n[g], g),
                        _ = +x(s, g);
                    v > b && (v = b), d > _ && (d = _), b > m && (m = b), _ > y && (y = _), f.push(b), h.push(_)
                }
            var w = m - v,
                S = y - d;
            w > S ? y = d + w : m = v + S;
            var k = su();
            if (k.add = function(n) {
                    i(k, n, +M(n, ++g), +x(n, g), v, d, m, y)
                }, k.visit = function(n) {
                    fu(n, k, v, d, m, y)
                }, k.find = function(n) {
                    return hu(k, n[0], n[1], v, d, m, y)
                }, g = -1, null == t) {
                for (; ++g < p;) i(k, n[g], f[g], h[g], v, d, m, y);
                --g
            } else n.forEach(k.add);
            return f = h = n = s = null, k
        }
        var o, a = Ar,
            c = Nr;
        return (o = arguments.length) ? (a = cu, c = lu, 3 === o && (u = e, r = t, e = t = 0), i(n)) : (i.x = function(n) {
            return arguments.length ? (a = n, i) : a
        }, i.y = function(n) {
            return arguments.length ? (c = n, i) : c
        }, i.extent = function(n) {
            return arguments.length ? (null == n ? t = e = r = u = null : (t = +n[0][0], e = +n[0][1], r = +n[1][0], u = +n[1][1]), i) : null == t ? null : [
                [t, e],
                [r, u]
            ]
        }, i.size = function(n) {
            return arguments.length ? (null == n ? t = e = r = u = null : (t = e = 0, r = +n[0], u = +n[1]), i) : null == t ? null : [r - t, u - e]
        }, i)
    }, ta.interpolateRgb = gu, ta.interpolateObject = pu, ta.interpolateNumber = vu, ta.interpolateString = du;
    var il = /[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,
        ol = new RegExp(il.source, "g");
    ta.interpolate = mu, ta.interpolators = [function(n, t) {
        var e = typeof t;
        return ("string" === e ? Ga.has(t.toLowerCase()) || /^(#|rgb\(|hsl\()/i.test(t) ? gu : du : t instanceof ot ? gu : Array.isArray(t) ? yu : "object" === e && isNaN(t) ? pu : vu)(n, t)
    }], ta.interpolateArray = yu;
    var al = function() {
            return y
        },
        cl = ta.map({
            linear: al,
            poly: ku,
            quad: function() {
                return _u
            },
            cubic: function() {
                return wu
            },
            sin: function() {
                return Eu
            },
            exp: function() {
                return Au
            },
            circle: function() {
                return Nu
            },
            elastic: Cu,
            back: zu,
            bounce: function() {
                return qu
            }
        }),
        ll = ta.map({
            "in": y,
            out: xu,
            "in-out": bu,
            "out-in": function(n) {
                return bu(xu(n))
            }
        });
    ta.ease = function(n) {
        var t = n.indexOf("-"),
            e = t >= 0 ? n.slice(0, t) : n,
            r = t >= 0 ? n.slice(t + 1) : "in";
        return e = cl.get(e) || al, r = ll.get(r) || y, Mu(r(e.apply(null, ea.call(arguments, 1))))
    }, ta.interpolateHcl = Lu, ta.interpolateHsl = Tu, ta.interpolateLab = Ru, ta.interpolateRound = Du, ta.transform = function(n) {
        var t = ua.createElementNS(ta.ns.prefix.svg, "g");
        return (ta.transform = function(n) {
            if (null != n) {
                t.setAttribute("transform", n);
                var e = t.transform.baseVal.consolidate()
            }
            return new Pu(e ? e.matrix : sl)
        })(n)
    }, Pu.prototype.toString = function() {
        return "translate(" + this.translate + ")rotate(" + this.rotate + ")skewX(" + this.skew + ")scale(" + this.scale + ")"
    };
    var sl = {
        a: 1,
        b: 0,
        c: 0,
        d: 1,
        e: 0,
        f: 0
    };
    ta.interpolateTransform = Hu, ta.layout = {}, ta.layout.bundle = function() {
        return function(n) {
            for (var t = [], e = -1, r = n.length; ++e < r;) t.push(Yu(n[e]));
            return t
        }
    }, ta.layout.chord = function() {
        function n() {
            var n, l, f, h, g, p = {},
                v = [],
                d = ta.range(i),
                m = [];
            for (e = [], r = [], n = 0, h = -1; ++h < i;) {
                for (l = 0, g = -1; ++g < i;) l += u[h][g];
                v.push(l), m.push(ta.range(i)), n += l
            }
            for (o && d.sort(function(n, t) {
                    return o(v[n], v[t])
                }), a && m.forEach(function(n, t) {
                    n.sort(function(n, e) {
                        return a(u[t][n], u[t][e])
                    })
                }), n = (La - s * i) / n, l = 0, h = -1; ++h < i;) {
                for (f = l, g = -1; ++g < i;) {
                    var y = d[h],
                        M = m[y][g],
                        x = u[y][M],
                        b = l,
                        _ = l += x * n;
                    p[y + "-" + M] = {
                        index: y,
                        subindex: M,
                        startAngle: b,
                        endAngle: _,
                        value: x
                    }
                }
                r[y] = {
                    index: y,
                    startAngle: f,
                    endAngle: l,
                    value: (l - f) / n
                }, l += s
            }
            for (h = -1; ++h < i;)
                for (g = h - 1; ++g < i;) {
                    var w = p[h + "-" + g],
                        S = p[g + "-" + h];
                    (w.value || S.value) && e.push(w.value < S.value ? {
                        source: S,
                        target: w
                    } : {
                        source: w,
                        target: S
                    })
                }
            c && t()
        }

        function t() {
            e.sort(function(n, t) {
                return c((n.source.value + n.target.value) / 2, (t.source.value + t.target.value) / 2)
            })
        }
        var e, r, u, i, o, a, c, l = {},
            s = 0;
        return l.matrix = function(n) {
            return arguments.length ? (i = (u = n) && u.length, e = r = null, l) : u
        }, l.padding = function(n) {
            return arguments.length ? (s = n, e = r = null, l) : s
        }, l.sortGroups = function(n) {
            return arguments.length ? (o = n, e = r = null, l) : o
        }, l.sortSubgroups = function(n) {
            return arguments.length ? (a = n, e = null, l) : a
        }, l.sortChords = function(n) {
            return arguments.length ? (c = n, e && t(), l) : c
        }, l.chords = function() {
            return e || n(), e
        }, l.groups = function() {
            return r || n(), r
        }, l
    }, ta.layout.force = function() {
        function n(n) {
            return function(t, e, r, u) {
                if (t.point !== n) {
                    var i = t.cx - n.x,
                        o = t.cy - n.y,
                        a = u - e,
                        c = i * i + o * o;
                    if (c > a * a / d) {
                        if (p > c) {
                            var l = t.charge / c;
                            n.px -= i * l, n.py -= o * l
                        }
                        return !0
                    }
                    if (t.point && c && p > c) {
                        var l = t.pointCharge / c;
                        n.px -= i * l, n.py -= o * l
                    }
                }
                return !t.charge
            }
        }

        function t(n) {
            n.px = ta.event.x, n.py = ta.event.y, a.resume()
        }
        var e, r, u, i, o, a = {},
            c = ta.dispatch("start", "tick", "end"),
            l = [1, 1],
            s = .9,
            f = fl,
            h = hl,
            g = -30,
            p = gl,
            v = .1,
            d = .64,
            m = [],
            M = [];
        return a.tick = function() {
            if ((r *= .99) < .005) return c.end({
                type: "end",
                alpha: r = 0
            }), !0;
            var t, e, a, f, h, p, d, y, x, b = m.length,
                _ = M.length;
            for (e = 0; _ > e; ++e) a = M[e], f = a.source, h = a.target, y = h.x - f.x, x = h.y - f.y, (p = y * y + x * x) && (p = r * i[e] * ((p = Math.sqrt(p)) - u[e]) / p, y *= p, x *= p, h.x -= y * (d = f.weight / (h.weight + f.weight)), h.y -= x * d, f.x += y * (d = 1 - d), f.y += x * d);
            if ((d = r * v) && (y = l[0] / 2, x = l[1] / 2, e = -1, d))
                for (; ++e < b;) a = m[e], a.x += (y - a.x) * d, a.y += (x - a.y) * d;
            if (g)
                for (Ju(t = ta.geom.quadtree(m), r, o), e = -1; ++e < b;)(a = m[e]).fixed || t.visit(n(a));
            for (e = -1; ++e < b;) a = m[e], a.fixed ? (a.x = a.px, a.y = a.py) : (a.x -= (a.px - (a.px = a.x)) * s, a.y -= (a.py - (a.py = a.y)) * s);
            c.tick({
                type: "tick",
                alpha: r
            })
        }, a.nodes = function(n) {
            return arguments.length ? (m = n, a) : m
        }, a.links = function(n) {
            return arguments.length ? (M = n, a) : M
        }, a.size = function(n) {
            return arguments.length ? (l = n, a) : l
        }, a.linkDistance = function(n) {
            return arguments.length ? (f = "function" == typeof n ? n : +n, a) : f
        }, a.distance = a.linkDistance, a.linkStrength = function(n) {
            return arguments.length ? (h = "function" == typeof n ? n : +n, a) : h
        }, a.friction = function(n) {
            return arguments.length ? (s = +n, a) : s
        }, a.charge = function(n) {
            return arguments.length ? (g = "function" == typeof n ? n : +n, a) : g
        }, a.chargeDistance = function(n) {
            return arguments.length ? (p = n * n, a) : Math.sqrt(p)
        }, a.gravity = function(n) {
            return arguments.length ? (v = +n, a) : v
        }, a.theta = function(n) {
            return arguments.length ? (d = n * n, a) : Math.sqrt(d)
        }, a.alpha = function(n) {
            return arguments.length ? (n = +n, r ? r = n > 0 ? n : 0 : n > 0 && (c.start({
                type: "start",
                alpha: r = n
            }), ta.timer(a.tick)), a) : r
        }, a.start = function() {
            function n(n, r) {
                if (!e) {
                    for (e = new Array(c), a = 0; c > a; ++a) e[a] = [];
                    for (a = 0; s > a; ++a) {
                        var u = M[a];
                        e[u.source.index].push(u.target), e[u.target.index].push(u.source)
                    }
                }
                for (var i, o = e[t], a = -1, l = o.length; ++a < l;)
                    if (!isNaN(i = o[a][n])) return i;
                return Math.random() * r
            }
            var t, e, r, c = m.length,
                s = M.length,
                p = l[0],
                v = l[1];
            for (t = 0; c > t; ++t)(r = m[t]).index = t, r.weight = 0;
            for (t = 0; s > t; ++t) r = M[t], "number" == typeof r.source && (r.source = m[r.source]), "number" == typeof r.target && (r.target = m[r.target]), ++r.source.weight, ++r.target.weight;
            for (t = 0; c > t; ++t) r = m[t], isNaN(r.x) && (r.x = n("x", p)), isNaN(r.y) && (r.y = n("y", v)), isNaN(r.px) && (r.px = r.x), isNaN(r.py) && (r.py = r.y);
            if (u = [], "function" == typeof f)
                for (t = 0; s > t; ++t) u[t] = +f.call(this, M[t], t);
            else
                for (t = 0; s > t; ++t) u[t] = f;
            if (i = [], "function" == typeof h)
                for (t = 0; s > t; ++t) i[t] = +h.call(this, M[t], t);
            else
                for (t = 0; s > t; ++t) i[t] = h;
            if (o = [], "function" == typeof g)
                for (t = 0; c > t; ++t) o[t] = +g.call(this, m[t], t);
            else
                for (t = 0; c > t; ++t) o[t] = g;
            return a.resume()
        }, a.resume = function() {
            return a.alpha(.1)
        }, a.stop = function() {
            return a.alpha(0)
        }, a.drag = function() {
            return e || (e = ta.behavior.drag().origin(y).on("dragstart.force", Xu).on("drag.force", t).on("dragend.force", $u)), arguments.length ? void this.on("mouseover.force", Bu).on("mouseout.force", Wu).call(e) : e
        }, ta.rebind(a, c, "on")
    };
    var fl = 20,
        hl = 1,
        gl = 1 / 0;
    ta.layout.hierarchy = function() {
        function n(u) {
            var i, o = [u],
                a = [];
            for (u.depth = 0; null != (i = o.pop());)
                if (a.push(i), (l = e.call(n, i, i.depth)) && (c = l.length)) {
                    for (var c, l, s; --c >= 0;) o.push(s = l[c]), s.parent = i, s.depth = i.depth + 1;
                    r && (i.value = 0), i.children = l
                } else r && (i.value = +r.call(n, i, i.depth) || 0), delete i.children;
            return Qu(u, function(n) {
                var e, u;
                t && (e = n.children) && e.sort(t), r && (u = n.parent) && (u.value += n.value)
            }), a
        }
        var t = ei,
            e = ni,
            r = ti;
        return n.sort = function(e) {
            return arguments.length ? (t = e, n) : t
        }, n.children = function(t) {
            return arguments.length ? (e = t, n) : e
        }, n.value = function(t) {
            return arguments.length ? (r = t, n) : r
        }, n.revalue = function(t) {
            return r && (Ku(t, function(n) {
                n.children && (n.value = 0)
            }), Qu(t, function(t) {
                var e;
                t.children || (t.value = +r.call(n, t, t.depth) || 0), (e = t.parent) && (e.value += t.value)
            })), t
        }, n
    }, ta.layout.partition = function() {
        function n(t, e, r, u) {
            var i = t.children;
            if (t.x = e, t.y = t.depth * u, t.dx = r, t.dy = u, i && (o = i.length)) {
                var o, a, c, l = -1;
                for (r = t.value ? r / t.value : 0; ++l < o;) n(a = i[l], e, c = a.value * r, u), e += c
            }
        }

        function t(n) {
            var e = n.children,
                r = 0;
            if (e && (u = e.length))
                for (var u, i = -1; ++i < u;) r = Math.max(r, t(e[i]));
            return 1 + r
        }

        function e(e, i) {
            var o = r.call(this, e, i);
            return n(o[0], 0, u[0], u[1] / t(o[0])), o
        }
        var r = ta.layout.hierarchy(),
            u = [1, 1];
        return e.size = function(n) {
            return arguments.length ? (u = n, e) : u
        }, Gu(e, r)
    }, ta.layout.pie = function() {
        function n(o) {
            var a, c = o.length,
                l = o.map(function(e, r) {
                    return +t.call(n, e, r)
                }),
                s = +("function" == typeof r ? r.apply(this, arguments) : r),
                f = ("function" == typeof u ? u.apply(this, arguments) : u) - s,
                h = Math.min(Math.abs(f) / c, +("function" == typeof i ? i.apply(this, arguments) : i)),
                g = h * (0 > f ? -1 : 1),
                p = (f - c * g) / ta.sum(l),
                v = ta.range(c),
                d = [];
            return null != e && v.sort(e === pl ? function(n, t) {
                return l[t] - l[n]
            } : function(n, t) {
                return e(o[n], o[t])
            }), v.forEach(function(n) {
                d[n] = {
                    data: o[n],
                    value: a = l[n],
                    startAngle: s,
                    endAngle: s += a * p + g,
                    padAngle: h
                }
            }), d
        }
        var t = Number,
            e = pl,
            r = 0,
            u = La,
            i = 0;
        return n.value = function(e) {
            return arguments.length ? (t = e, n) : t
        }, n.sort = function(t) {
            return arguments.length ? (e = t, n) : e
        }, n.startAngle = function(t) {
            return arguments.length ? (r = t, n) : r
        }, n.endAngle = function(t) {
            return arguments.length ? (u = t, n) : u
        }, n.padAngle = function(t) {
            return arguments.length ? (i = t, n) : i
        }, n
    };
    var pl = {};
    ta.layout.stack = function() {
        function n(a, c) {
            if (!(h = a.length)) return a;
            var l = a.map(function(e, r) {
                    return t.call(n, e, r)
                }),
                s = l.map(function(t) {
                    return t.map(function(t, e) {
                        return [i.call(n, t, e), o.call(n, t, e)]
                    })
                }),
                f = e.call(n, s, c);
            l = ta.permute(l, f), s = ta.permute(s, f);
            var h, g, p, v, d = r.call(n, s, c),
                m = l[0].length;
            for (p = 0; m > p; ++p)
                for (u.call(n, l[0][p], v = d[p], s[0][p][1]), g = 1; h > g; ++g) u.call(n, l[g][p], v += s[g - 1][p][1], s[g][p][1]);
            return a
        }
        var t = y,
            e = ai,
            r = ci,
            u = oi,
            i = ui,
            o = ii;
        return n.values = function(e) {
            return arguments.length ? (t = e, n) : t
        }, n.order = function(t) {
            return arguments.length ? (e = "function" == typeof t ? t : vl.get(t) || ai, n) : e
        }, n.offset = function(t) {
            return arguments.length ? (r = "function" == typeof t ? t : dl.get(t) || ci, n) : r
        }, n.x = function(t) {
            return arguments.length ? (i = t, n) : i
        }, n.y = function(t) {
            return arguments.length ? (o = t, n) : o
        }, n.out = function(t) {
            return arguments.length ? (u = t, n) : u
        }, n
    };
    var vl = ta.map({
            "inside-out": function(n) {
                var t, e, r = n.length,
                    u = n.map(li),
                    i = n.map(si),
                    o = ta.range(r).sort(function(n, t) {
                        return u[n] - u[t]
                    }),
                    a = 0,
                    c = 0,
                    l = [],
                    s = [];
                for (t = 0; r > t; ++t) e = o[t], c > a ? (a += i[e], l.push(e)) : (c += i[e], s.push(e));
                return s.reverse().concat(l)
            },
            reverse: function(n) {
                return ta.range(n.length).reverse()
            },
            "default": ai
        }),
        dl = ta.map({
            silhouette: function(n) {
                var t, e, r, u = n.length,
                    i = n[0].length,
                    o = [],
                    a = 0,
                    c = [];
                for (e = 0; i > e; ++e) {
                    for (t = 0, r = 0; u > t; t++) r += n[t][e][1];
                    r > a && (a = r), o.push(r)
                }
                for (e = 0; i > e; ++e) c[e] = (a - o[e]) / 2;
                return c
            },
            wiggle: function(n) {
                var t, e, r, u, i, o, a, c, l, s = n.length,
                    f = n[0],
                    h = f.length,
                    g = [];
                for (g[0] = c = l = 0, e = 1; h > e; ++e) {
                    for (t = 0, u = 0; s > t; ++t) u += n[t][e][1];
                    for (t = 0, i = 0, a = f[e][0] - f[e - 1][0]; s > t; ++t) {
                        for (r = 0, o = (n[t][e][1] - n[t][e - 1][1]) / (2 * a); t > r; ++r) o += (n[r][e][1] - n[r][e - 1][1]) / a;
                        i += o * n[t][e][1]
                    }
                    g[e] = c -= u ? i / u * a : 0, l > c && (l = c)
                }
                for (e = 0; h > e; ++e) g[e] -= l;
                return g
            },
            expand: function(n) {
                var t, e, r, u = n.length,
                    i = n[0].length,
                    o = 1 / u,
                    a = [];
                for (e = 0; i > e; ++e) {
                    for (t = 0, r = 0; u > t; t++) r += n[t][e][1];
                    if (r)
                        for (t = 0; u > t; t++) n[t][e][1] /= r;
                    else
                        for (t = 0; u > t; t++) n[t][e][1] = o
                }
                for (e = 0; i > e; ++e) a[e] = 0;
                return a
            },
            zero: ci
        });
    ta.layout.histogram = function() {
        function n(n, i) {
            for (var o, a, c = [], l = n.map(e, this), s = r.call(this, l, i), f = u.call(this, s, l, i), i = -1, h = l.length, g = f.length - 1, p = t ? 1 : 1 / h; ++i < g;) o = c[i] = [], o.dx = f[i + 1] - (o.x = f[i]), o.y = 0;
            if (g > 0)
                for (i = -1; ++i < h;) a = l[i], a >= s[0] && a <= s[1] && (o = c[ta.bisect(f, a, 1, g) - 1], o.y += p, o.push(n[i]));
            return c
        }
        var t = !0,
            e = Number,
            r = pi,
            u = hi;
        return n.value = function(t) {
            return arguments.length ? (e = t, n) : e
        }, n.range = function(t) {
            return arguments.length ? (r = Et(t), n) : r
        }, n.bins = function(t) {
            return arguments.length ? (u = "number" == typeof t ? function(n) {
                return gi(n, t)
            } : Et(t), n) : u
        }, n.frequency = function(e) {
            return arguments.length ? (t = !!e, n) : t
        }, n
    }, ta.layout.pack = function() {
        function n(n, i) {
            var o = e.call(this, n, i),
                a = o[0],
                c = u[0],
                l = u[1],
                s = null == t ? Math.sqrt : "function" == typeof t ? t : function() {
                    return t
                };
            if (a.x = a.y = 0, Qu(a, function(n) {
                    n.r = +s(n.value)
                }), Qu(a, Mi), r) {
                var f = r * (t ? 1 : Math.max(2 * a.r / c, 2 * a.r / l)) / 2;
                Qu(a, function(n) {
                    n.r += f
                }), Qu(a, Mi), Qu(a, function(n) {
                    n.r -= f
                })
            }
            return _i(a, c / 2, l / 2, t ? 1 : 1 / Math.max(2 * a.r / c, 2 * a.r / l)), o
        }
        var t, e = ta.layout.hierarchy().sort(vi),
            r = 0,
            u = [1, 1];
        return n.size = function(t) {
            return arguments.length ? (u = t, n) : u
        }, n.radius = function(e) {
            return arguments.length ? (t = null == e || "function" == typeof e ? e : +e, n) : t
        }, n.padding = function(t) {
            return arguments.length ? (r = +t, n) : r
        }, Gu(n, e)
    }, ta.layout.tree = function() {
        function n(n, u) {
            var s = o.call(this, n, u),
                f = s[0],
                h = t(f);
            if (Qu(h, e), h.parent.m = -h.z, Ku(h, r), l) Ku(f, i);
            else {
                var g = f,
                    p = f,
                    v = f;
                Ku(f, function(n) {
                    n.x < g.x && (g = n), n.x > p.x && (p = n), n.depth > v.depth && (v = n)
                });
                var d = a(g, p) / 2 - g.x,
                    m = c[0] / (p.x + a(p, g) / 2 + d),
                    y = c[1] / (v.depth || 1);
                Ku(f, function(n) {
                    n.x = (n.x + d) * m, n.y = n.depth * y
                })
            }
            return s
        }

        function t(n) {
            for (var t, e = {
                    A: null,
                    children: [n]
                }, r = [e]; null != (t = r.pop());)
                for (var u, i = t.children, o = 0, a = i.length; a > o; ++o) r.push((i[o] = u = {
                    _: i[o],
                    parent: t,
                    children: (u = i[o].children) && u.slice() || [],
                    A: null,
                    a: null,
                    z: 0,
                    m: 0,
                    c: 0,
                    s: 0,
                    t: null,
                    i: o
                }).a = u);
            return e.children[0]
        }

        function e(n) {
            var t = n.children,
                e = n.parent.children,
                r = n.i ? e[n.i - 1] : null;
            if (t.length) {
                Ni(n);
                var i = (t[0].z + t[t.length - 1].z) / 2;
                r ? (n.z = r.z + a(n._, r._), n.m = n.z - i) : n.z = i
            } else r && (n.z = r.z + a(n._, r._));
            n.parent.A = u(n, r, n.parent.A || e[0])
        }

        function r(n) {
            n._.x = n.z + n.parent.m, n.m += n.parent.m
        }

        function u(n, t, e) {
            if (t) {
                for (var r, u = n, i = n, o = t, c = u.parent.children[0], l = u.m, s = i.m, f = o.m, h = c.m; o = Ei(o), u = ki(u), o && u;) c = ki(c), i = Ei(i), i.a = n, r = o.z + f - u.z - l + a(o._, u._), r > 0 && (Ai(Ci(o, n, e), n, r), l += r, s += r), f += o.m, l += u.m, h += c.m, s += i.m;
                o && !Ei(i) && (i.t = o, i.m += f - s), u && !ki(c) && (c.t = u, c.m += l - h, e = n)
            }
            return e
        }

        function i(n) {
            n.x *= c[0], n.y = n.depth * c[1]
        }
        var o = ta.layout.hierarchy().sort(null).value(null),
            a = Si,
            c = [1, 1],
            l = null;
        return n.separation = function(t) {
            return arguments.length ? (a = t, n) : a
        }, n.size = function(t) {
            return arguments.length ? (l = null == (c = t) ? i : null, n) : l ? null : c
        }, n.nodeSize = function(t) {
            return arguments.length ? (l = null == (c = t) ? null : i, n) : l ? c : null
        }, Gu(n, o)
    }, ta.layout.cluster = function() {
        function n(n, i) {
            var o, a = t.call(this, n, i),
                c = a[0],
                l = 0;
            Qu(c, function(n) {
                var t = n.children;
                t && t.length ? (n.x = qi(t), n.y = zi(t)) : (n.x = o ? l += e(n, o) : 0, n.y = 0, o = n)
            });
            var s = Li(c),
                f = Ti(c),
                h = s.x - e(s, f) / 2,
                g = f.x + e(f, s) / 2;
            return Qu(c, u ? function(n) {
                n.x = (n.x - c.x) * r[0], n.y = (c.y - n.y) * r[1]
            } : function(n) {
                n.x = (n.x - h) / (g - h) * r[0], n.y = (1 - (c.y ? n.y / c.y : 1)) * r[1]
            }), a
        }
        var t = ta.layout.hierarchy().sort(null).value(null),
            e = Si,
            r = [1, 1],
            u = !1;
        return n.separation = function(t) {
            return arguments.length ? (e = t, n) : e
        }, n.size = function(t) {
            return arguments.length ? (u = null == (r = t), n) : u ? null : r
        }, n.nodeSize = function(t) {
            return arguments.length ? (u = null != (r = t), n) : u ? r : null
        }, Gu(n, t)
    }, ta.layout.treemap = function() {
        function n(n, t) {
            for (var e, r, u = -1, i = n.length; ++u < i;) r = (e = n[u]).value * (0 > t ? 0 : t), e.area = isNaN(r) || 0 >= r ? 0 : r
        }

        function t(e) {
            var i = e.children;
            if (i && i.length) {
                var o, a, c, l = f(e),
                    s = [],
                    h = i.slice(),
                    p = 1 / 0,
                    v = "slice" === g ? l.dx : "dice" === g ? l.dy : "slice-dice" === g ? 1 & e.depth ? l.dy : l.dx : Math.min(l.dx, l.dy);
                for (n(h, l.dx * l.dy / e.value), s.area = 0;
                    (c = h.length) > 0;) s.push(o = h[c - 1]), s.area += o.area, "squarify" !== g || (a = r(s, v)) <= p ? (h.pop(), p = a) : (s.area -= s.pop().area, u(s, v, l, !1), v = Math.min(l.dx, l.dy), s.length = s.area = 0, p = 1 / 0);
                s.length && (u(s, v, l, !0), s.length = s.area = 0), i.forEach(t)
            }
        }

        function e(t) {
            var r = t.children;
            if (r && r.length) {
                var i, o = f(t),
                    a = r.slice(),
                    c = [];
                for (n(a, o.dx * o.dy / t.value), c.area = 0; i = a.pop();) c.push(i), c.area += i.area, null != i.z && (u(c, i.z ? o.dx : o.dy, o, !a.length), c.length = c.area = 0);
                r.forEach(e)
            }
        }

        function r(n, t) {
            for (var e, r = n.area, u = 0, i = 1 / 0, o = -1, a = n.length; ++o < a;)(e = n[o].area) && (i > e && (i = e), e > u && (u = e));
            return r *= r, t *= t, r ? Math.max(t * u * p / r, r / (t * i * p)) : 1 / 0
        }

        function u(n, t, e, r) {
            var u, i = -1,
                o = n.length,
                a = e.x,
                l = e.y,
                s = t ? c(n.area / t) : 0;
            if (t == e.dx) {
                for ((r || s > e.dy) && (s = e.dy); ++i < o;) u = n[i], u.x = a, u.y = l, u.dy = s, a += u.dx = Math.min(e.x + e.dx - a, s ? c(u.area / s) : 0);
                u.z = !0, u.dx += e.x + e.dx - a, e.y += s, e.dy -= s
            } else {
                for ((r || s > e.dx) && (s = e.dx); ++i < o;) u = n[i], u.x = a, u.y = l, u.dx = s, l += u.dy = Math.min(e.y + e.dy - l, s ? c(u.area / s) : 0);
                u.z = !1, u.dy += e.y + e.dy - l, e.x += s, e.dx -= s
            }
        }

        function i(r) {
            var u = o || a(r),
                i = u[0];
            return i.x = 0, i.y = 0, i.dx = l[0], i.dy = l[1], o && a.revalue(i), n([i], i.dx * i.dy / i.value), (o ? e : t)(i), h && (o = u), u
        }
        var o, a = ta.layout.hierarchy(),
            c = Math.round,
            l = [1, 1],
            s = null,
            f = Ri,
            h = !1,
            g = "squarify",
            p = .5 * (1 + Math.sqrt(5));
        return i.size = function(n) {
            return arguments.length ? (l = n, i) : l
        }, i.padding = function(n) {
            function t(t) {
                var e = n.call(i, t, t.depth);
                return null == e ? Ri(t) : Di(t, "number" == typeof e ? [e, e, e, e] : e)
            }

            function e(t) {
                return Di(t, n)
            }
            if (!arguments.length) return s;
            var r;
            return f = null == (s = n) ? Ri : "function" == (r = typeof n) ? t : "number" === r ? (n = [n, n, n, n], e) : e, i
        }, i.round = function(n) {
            return arguments.length ? (c = n ? Math.round : Number, i) : c != Number
        }, i.sticky = function(n) {
            return arguments.length ? (h = n, o = null, i) : h
        }, i.ratio = function(n) {
            return arguments.length ? (p = n, i) : p
        }, i.mode = function(n) {
            return arguments.length ? (g = n + "", i) : g
        }, Gu(i, a)
    }, ta.random = {
        normal: function(n, t) {
            var e = arguments.length;
            return 2 > e && (t = 1), 1 > e && (n = 0),
                function() {
                    var e, r, u;
                    do e = 2 * Math.random() - 1, r = 2 * Math.random() - 1, u = e * e + r * r; while (!u || u > 1);
                    return n + t * e * Math.sqrt(-2 * Math.log(u) / u)
                }
        },
        logNormal: function() {
            var n = ta.random.normal.apply(ta, arguments);
            return function() {
                return Math.exp(n())
            }
        },
        bates: function(n) {
            var t = ta.random.irwinHall(n);
            return function() {
                return t() / n
            }
        },
        irwinHall: function(n) {
            return function() {
                for (var t = 0, e = 0; n > e; e++) t += Math.random();
                return t
            }
        }
    }, ta.scale = {};
    var ml = {
        floor: y,
        ceil: y
    };
    ta.scale.linear = function() {
        return Ii([0, 1], [0, 1], mu, !1)
    };
    var yl = {
        s: 1,
        g: 1,
        p: 1,
        r: 1,
        e: 1
    };
    ta.scale.log = function() {
        return Ji(ta.scale.linear().domain([0, 1]), 10, !0, [1, 10])
    };
    var Ml = ta.format(".0e"),
        xl = {
            floor: function(n) {
                return -Math.ceil(-n)
            },
            ceil: function(n) {
                return -Math.floor(-n)
            }
        };
    ta.scale.pow = function() {
        return Gi(ta.scale.linear(), 1, [0, 1])
    }, ta.scale.sqrt = function() {
        return ta.scale.pow().exponent(.5)
    }, ta.scale.ordinal = function() {
        return Qi([], {
            t: "range",
            a: [
                []
            ]
        })
    }, ta.scale.category10 = function() {
        return ta.scale.ordinal().range(bl)
    }, ta.scale.category20 = function() {
        return ta.scale.ordinal().range(_l)
    }, ta.scale.category20b = function() {
        return ta.scale.ordinal().range(wl)
    }, ta.scale.category20c = function() {
        return ta.scale.ordinal().range(Sl)
    };
    var bl = [2062260, 16744206, 2924588, 14034728, 9725885, 9197131, 14907330, 8355711, 12369186, 1556175].map(Mt),
        _l = [2062260, 11454440, 16744206, 16759672, 2924588, 10018698, 14034728, 16750742, 9725885, 12955861, 9197131, 12885140, 14907330, 16234194, 8355711, 13092807, 12369186, 14408589, 1556175, 10410725].map(Mt),
        wl = [3750777, 5395619, 7040719, 10264286, 6519097, 9216594, 11915115, 13556636, 9202993, 12426809, 15186514, 15190932, 8666169, 11356490, 14049643, 15177372, 8077683, 10834324, 13528509, 14589654].map(Mt),
        Sl = [3244733, 7057110, 10406625, 13032431, 15095053, 16616764, 16625259, 16634018, 3253076, 7652470, 10607003, 13101504, 7695281, 10394312, 12369372, 14342891, 6513507, 9868950, 12434877, 14277081].map(Mt);
    ta.scale.quantile = function() {
        return no([], [])
    }, ta.scale.quantize = function() {
        return to(0, 1, [0, 1])
    }, ta.scale.threshold = function() {
        return eo([.5], [0, 1])
    }, ta.scale.identity = function() {
        return ro([0, 1])
    }, ta.svg = {}, ta.svg.arc = function() {
        function n() {
            var n = Math.max(0, +e.apply(this, arguments)),
                l = Math.max(0, +r.apply(this, arguments)),
                s = o.apply(this, arguments) - Ra,
                f = a.apply(this, arguments) - Ra,
                h = Math.abs(f - s),
                g = s > f ? 0 : 1;
            if (n > l && (p = l, l = n, n = p), h >= Ta) return t(l, g) + (n ? t(n, 1 - g) : "") + "Z";
            var p, v, d, m, y, M, x, b, _, w, S, k, E = 0,
                A = 0,
                N = [];
            if ((m = (+c.apply(this, arguments) || 0) / 2) && (d = i === kl ? Math.sqrt(n * n + l * l) : +i.apply(this, arguments), g || (A *= -1), l && (A = tt(d / l * Math.sin(m))), n && (E = tt(d / n * Math.sin(m)))), l) {
                y = l * Math.cos(s + A), M = l * Math.sin(s + A), x = l * Math.cos(f - A), b = l * Math.sin(f - A);
                var C = Math.abs(f - s - 2 * A) <= qa ? 0 : 1;
                if (A && so(y, M, x, b) === g ^ C) {
                    var z = (s + f) / 2;
                    y = l * Math.cos(z), M = l * Math.sin(z), x = b = null
                }
            } else y = M = 0;
            if (n) {
                _ = n * Math.cos(f - E), w = n * Math.sin(f - E), S = n * Math.cos(s + E), k = n * Math.sin(s + E);
                var q = Math.abs(s - f + 2 * E) <= qa ? 0 : 1;
                if (E && so(_, w, S, k) === 1 - g ^ q) {
                    var L = (s + f) / 2;
                    _ = n * Math.cos(L), w = n * Math.sin(L), S = k = null
                }
            } else _ = w = 0;
            if ((p = Math.min(Math.abs(l - n) / 2, +u.apply(this, arguments))) > .001) {
                v = l > n ^ g ? 0 : 1;
                var T = null == S ? [_, w] : null == x ? [y, M] : Lr([y, M], [S, k], [x, b], [_, w]),
                    R = y - T[0],
                    D = M - T[1],
                    P = x - T[0],
                    U = b - T[1],
                    j = 1 / Math.sin(Math.acos((R * P + D * U) / (Math.sqrt(R * R + D * D) * Math.sqrt(P * P + U * U))) / 2),
                    F = Math.sqrt(T[0] * T[0] + T[1] * T[1]);
                if (null != x) {
                    var H = Math.min(p, (l - F) / (j + 1)),
                        O = fo(null == S ? [_, w] : [S, k], [y, M], l, H, g),
                        I = fo([x, b], [_, w], l, H, g);
                    p === H ? N.push("M", O[0], "A", H, ",", H, " 0 0,", v, " ", O[1], "A", l, ",", l, " 0 ", 1 - g ^ so(O[1][0], O[1][1], I[1][0], I[1][1]), ",", g, " ", I[1], "A", H, ",", H, " 0 0,", v, " ", I[0]) : N.push("M", O[0], "A", H, ",", H, " 0 1,", v, " ", I[0])
                } else N.push("M", y, ",", M);
                if (null != S) {
                    var Y = Math.min(p, (n - F) / (j - 1)),
                        Z = fo([y, M], [S, k], n, -Y, g),
                        V = fo([_, w], null == x ? [y, M] : [x, b], n, -Y, g);
                    p === Y ? N.push("L", V[0], "A", Y, ",", Y, " 0 0,", v, " ", V[1], "A", n, ",", n, " 0 ", g ^ so(V[1][0], V[1][1], Z[1][0], Z[1][1]), ",", 1 - g, " ", Z[1], "A", Y, ",", Y, " 0 0,", v, " ", Z[0]) : N.push("L", V[0], "A", Y, ",", Y, " 0 0,", v, " ", Z[0])
                } else N.push("L", _, ",", w)
            } else N.push("M", y, ",", M), null != x && N.push("A", l, ",", l, " 0 ", C, ",", g, " ", x, ",", b), N.push("L", _, ",", w), null != S && N.push("A", n, ",", n, " 0 ", q, ",", 1 - g, " ", S, ",", k);
            return N.push("Z"), N.join("")
        }

        function t(n, t) {
            return "M0," + n + "A" + n + "," + n + " 0 1," + t + " 0," + -n + "A" + n + "," + n + " 0 1," + t + " 0," + n
        }
        var e = io,
            r = oo,
            u = uo,
            i = kl,
            o = ao,
            a = co,
            c = lo;
        return n.innerRadius = function(t) {
            return arguments.length ? (e = Et(t), n) : e
        }, n.outerRadius = function(t) {
            return arguments.length ? (r = Et(t), n) : r
        }, n.cornerRadius = function(t) {
            return arguments.length ? (u = Et(t), n) : u
        }, n.padRadius = function(t) {
            return arguments.length ? (i = t == kl ? kl : Et(t), n) : i
        }, n.startAngle = function(t) {
            return arguments.length ? (o = Et(t), n) : o
        }, n.endAngle = function(t) {
            return arguments.length ? (a = Et(t), n) : a
        }, n.padAngle = function(t) {
            return arguments.length ? (c = Et(t), n) : c
        }, n.centroid = function() {
            var n = (+e.apply(this, arguments) + +r.apply(this, arguments)) / 2,
                t = (+o.apply(this, arguments) + +a.apply(this, arguments)) / 2 - Ra;
            return [Math.cos(t) * n, Math.sin(t) * n]
        }, n
    };
    var kl = "auto";
    ta.svg.line = function() {
        return ho(y)
    };
    var El = ta.map({
        linear: go,
        "linear-closed": po,
        step: vo,
        "step-before": mo,
        "step-after": yo,
        basis: So,
        "basis-open": ko,
        "basis-closed": Eo,
        bundle: Ao,
        cardinal: bo,
        "cardinal-open": Mo,
        "cardinal-closed": xo,
        monotone: To
    });
    El.forEach(function(n, t) {
        t.key = n, t.closed = /-closed$/.test(n)
    });
    var Al = [0, 2 / 3, 1 / 3, 0],
        Nl = [0, 1 / 3, 2 / 3, 0],
        Cl = [0, 1 / 6, 2 / 3, 1 / 6];
    ta.svg.line.radial = function() {
        var n = ho(Ro);
        return n.radius = n.x, delete n.x, n.angle = n.y, delete n.y, n
    }, mo.reverse = yo, yo.reverse = mo, ta.svg.area = function() {
        return Do(y)
    }, ta.svg.area.radial = function() {
        var n = Do(Ro);
        return n.radius = n.x, delete n.x, n.innerRadius = n.x0, delete n.x0, n.outerRadius = n.x1, delete n.x1, n.angle = n.y, delete n.y, n.startAngle = n.y0, delete n.y0, n.endAngle = n.y1, delete n.y1, n
    }, ta.svg.chord = function() {
        function n(n, a) {
            var c = t(this, i, n, a),
                l = t(this, o, n, a);
            return "M" + c.p0 + r(c.r, c.p1, c.a1 - c.a0) + (e(c, l) ? u(c.r, c.p1, c.r, c.p0) : u(c.r, c.p1, l.r, l.p0) + r(l.r, l.p1, l.a1 - l.a0) + u(l.r, l.p1, c.r, c.p0)) + "Z"
        }

        function t(n, t, e, r) {
            var u = t.call(n, e, r),
                i = a.call(n, u, r),
                o = c.call(n, u, r) - Ra,
                s = l.call(n, u, r) - Ra;
            return {
                r: i,
                a0: o,
                a1: s,
                p0: [i * Math.cos(o), i * Math.sin(o)],
                p1: [i * Math.cos(s), i * Math.sin(s)]
            }
        }

        function e(n, t) {
            return n.a0 == t.a0 && n.a1 == t.a1
        }

        function r(n, t, e) {
            return "A" + n + "," + n + " 0 " + +(e > qa) + ",1 " + t
        }

        function u(n, t, e, r) {
            return "Q 0,0 " + r
        }
        var i = mr,
            o = yr,
            a = Po,
            c = ao,
            l = co;
        return n.radius = function(t) {
            return arguments.length ? (a = Et(t), n) : a
        }, n.source = function(t) {
            return arguments.length ? (i = Et(t), n) : i
        }, n.target = function(t) {
            return arguments.length ? (o = Et(t), n) : o
        }, n.startAngle = function(t) {
            return arguments.length ? (c = Et(t), n) : c
        }, n.endAngle = function(t) {
            return arguments.length ? (l = Et(t), n) : l
        }, n
    }, ta.svg.diagonal = function() {
        function n(n, u) {
            var i = t.call(this, n, u),
                o = e.call(this, n, u),
                a = (i.y + o.y) / 2,
                c = [i, {
                    x: i.x,
                    y: a
                }, {
                    x: o.x,
                    y: a
                }, o];
            return c = c.map(r), "M" + c[0] + "C" + c[1] + " " + c[2] + " " + c[3]
        }
        var t = mr,
            e = yr,
            r = Uo;
        return n.source = function(e) {
            return arguments.length ? (t = Et(e), n) : t
        }, n.target = function(t) {
            return arguments.length ? (e = Et(t), n) : e
        }, n.projection = function(t) {
            return arguments.length ? (r = t, n) : r
        }, n
    }, ta.svg.diagonal.radial = function() {
        var n = ta.svg.diagonal(),
            t = Uo,
            e = n.projection;
        return n.projection = function(n) {
            return arguments.length ? e(jo(t = n)) : t
        }, n
    }, ta.svg.symbol = function() {
        function n(n, r) {
            return (zl.get(t.call(this, n, r)) || Oo)(e.call(this, n, r))
        }
        var t = Ho,
            e = Fo;
        return n.type = function(e) {
            return arguments.length ? (t = Et(e), n) : t
        }, n.size = function(t) {
            return arguments.length ? (e = Et(t), n) : e
        }, n
    };
    var zl = ta.map({
        circle: Oo,
        cross: function(n) {
            var t = Math.sqrt(n / 5) / 2;
            return "M" + -3 * t + "," + -t + "H" + -t + "V" + -3 * t + "H" + t + "V" + -t + "H" + 3 * t + "V" + t + "H" + t + "V" + 3 * t + "H" + -t + "V" + t + "H" + -3 * t + "Z"
        },
        diamond: function(n) {
            var t = Math.sqrt(n / (2 * Ll)),
                e = t * Ll;
            return "M0," + -t + "L" + e + ",0 0," + t + " " + -e + ",0Z"
        },
        square: function(n) {
            var t = Math.sqrt(n) / 2;
            return "M" + -t + "," + -t + "L" + t + "," + -t + " " + t + "," + t + " " + -t + "," + t + "Z"
        },
        "triangle-down": function(n) {
            var t = Math.sqrt(n / ql),
                e = t * ql / 2;
            return "M0," + e + "L" + t + "," + -e + " " + -t + "," + -e + "Z"
        },
        "triangle-up": function(n) {
            var t = Math.sqrt(n / ql),
                e = t * ql / 2;
            return "M0," + -e + "L" + t + "," + e + " " + -t + "," + e + "Z"
        }
    });
    ta.svg.symbolTypes = zl.keys();
    var ql = Math.sqrt(3),
        Ll = Math.tan(30 * Da);
    _a.transition = function(n) {
        for (var t, e, r = Tl || ++Ul, u = Xo(n), i = [], o = Rl || {
                time: Date.now(),
                ease: Su,
                delay: 0,
                duration: 250
            }, a = -1, c = this.length; ++a < c;) {
            i.push(t = []);
            for (var l = this[a], s = -1, f = l.length; ++s < f;)(e = l[s]) && $o(e, s, u, r, o), t.push(e)
        }
        return Yo(i, u, r)
    }, _a.interrupt = function(n) {
        return this.each(null == n ? Dl : Io(Xo(n)))
    };
    var Tl, Rl, Dl = Io(Xo()),
        Pl = [],
        Ul = 0;
    Pl.call = _a.call, Pl.empty = _a.empty, Pl.node = _a.node, Pl.size = _a.size, ta.transition = function(n, t) {
        return n && n.transition ? Tl ? n.transition(t) : n : ta.selection().transition(n)
    }, ta.transition.prototype = Pl, Pl.select = function(n) {
        var t, e, r, u = this.id,
            i = this.namespace,
            o = [];
        n = N(n);
        for (var a = -1, c = this.length; ++a < c;) {
            o.push(t = []);
            for (var l = this[a], s = -1, f = l.length; ++s < f;)(r = l[s]) && (e = n.call(r, r.__data__, s, a)) ? ("__data__" in r && (e.__data__ = r.__data__), $o(e, s, i, u, r[i][u]), t.push(e)) : t.push(null)
        }
        return Yo(o, i, u)
    }, Pl.selectAll = function(n) {
        var t, e, r, u, i, o = this.id,
            a = this.namespace,
            c = [];
        n = C(n);
        for (var l = -1, s = this.length; ++l < s;)
            for (var f = this[l], h = -1, g = f.length; ++h < g;)
                if (r = f[h]) {
                    i = r[a][o], e = n.call(r, r.__data__, h, l), c.push(t = []);
                    for (var p = -1, v = e.length; ++p < v;)(u = e[p]) && $o(u, p, a, o, i), t.push(u)
                }
        return Yo(c, a, o)
    }, Pl.filter = function(n) {
        var t, e, r, u = [];
        "function" != typeof n && (n = O(n));
        for (var i = 0, o = this.length; o > i; i++) {
            u.push(t = []);
            for (var e = this[i], a = 0, c = e.length; c > a; a++)(r = e[a]) && n.call(r, r.__data__, a, i) && t.push(r)
        }
        return Yo(u, this.namespace, this.id)
    }, Pl.tween = function(n, t) {
        var e = this.id,
            r = this.namespace;
        return arguments.length < 2 ? this.node()[r][e].tween.get(n) : Y(this, null == t ? function(t) {
            t[r][e].tween.remove(n)
        } : function(u) {
            u[r][e].tween.set(n, t)
        })
    }, Pl.attr = function(n, t) {
        function e() {
            this.removeAttribute(a)
        }

        function r() {
            this.removeAttributeNS(a.space, a.local)
        }

        function u(n) {
            return null == n ? e : (n += "", function() {
                var t, e = this.getAttribute(a);
                return e !== n && (t = o(e, n), function(n) {
                    this.setAttribute(a, t(n))
                })
            })
        }

        function i(n) {
            return null == n ? r : (n += "", function() {
                var t, e = this.getAttributeNS(a.space, a.local);
                return e !== n && (t = o(e, n), function(n) {
                    this.setAttributeNS(a.space, a.local, t(n))
                })
            })
        }
        if (arguments.length < 2) {
            for (t in n) this.attr(t, n[t]);
            return this
        }
        var o = "transform" == n ? Hu : mu,
            a = ta.ns.qualify(n);
        return Zo(this, "attr." + n, t, a.local ? i : u)
    }, Pl.attrTween = function(n, t) {
        function e(n, e) {
            var r = t.call(this, n, e, this.getAttribute(u));
            return r && function(n) {
                this.setAttribute(u, r(n))
            }
        }

        function r(n, e) {
            var r = t.call(this, n, e, this.getAttributeNS(u.space, u.local));
            return r && function(n) {
                this.setAttributeNS(u.space, u.local, r(n))
            }
        }
        var u = ta.ns.qualify(n);
        return this.tween("attr." + n, u.local ? r : e)
    }, Pl.style = function(n, e, r) {
        function u() {
            this.style.removeProperty(n)
        }

        function i(e) {
            return null == e ? u : (e += "", function() {
                var u, i = t(this).getComputedStyle(this, null).getPropertyValue(n);
                return i !== e && (u = mu(i, e), function(t) {
                    this.style.setProperty(n, u(t), r)
                })
            })
        }
        var o = arguments.length;
        if (3 > o) {
            if ("string" != typeof n) {
                2 > o && (e = "");
                for (r in n) this.style(r, n[r], e);
                return this
            }
            r = ""
        }
        return Zo(this, "style." + n, e, i)
    }, Pl.styleTween = function(n, e, r) {
        function u(u, i) {
            var o = e.call(this, u, i, t(this).getComputedStyle(this, null).getPropertyValue(n));
            return o && function(t) {
                this.style.setProperty(n, o(t), r)
            }
        }
        return arguments.length < 3 && (r = ""), this.tween("style." + n, u)
    }, Pl.text = function(n) {
        return Zo(this, "text", n, Vo)
    }, Pl.remove = function() {
        var n = this.namespace;
        return this.each("end.transition", function() {
            var t;
            this[n].count < 2 && (t = this.parentNode) && t.removeChild(this)
        })
    }, Pl.ease = function(n) {
        var t = this.id,
            e = this.namespace;
        return arguments.length < 1 ? this.node()[e][t].ease : ("function" != typeof n && (n = ta.ease.apply(ta, arguments)), Y(this, function(r) {
            r[e][t].ease = n
        }))
    }, Pl.delay = function(n) {
        var t = this.id,
            e = this.namespace;
        return arguments.length < 1 ? this.node()[e][t].delay : Y(this, "function" == typeof n ? function(r, u, i) {
            r[e][t].delay = +n.call(r, r.__data__, u, i)
        } : (n = +n, function(r) {
            r[e][t].delay = n
        }))
    }, Pl.duration = function(n) {
        var t = this.id,
            e = this.namespace;
        return arguments.length < 1 ? this.node()[e][t].duration : Y(this, "function" == typeof n ? function(r, u, i) {
            r[e][t].duration = Math.max(1, n.call(r, r.__data__, u, i))
        } : (n = Math.max(1, n), function(r) {
            r[e][t].duration = n
        }))
    }, Pl.each = function(n, t) {
        var e = this.id,
            r = this.namespace;
        if (arguments.length < 2) {
            var u = Rl,
                i = Tl;
            try {
                Tl = e, Y(this, function(t, u, i) {
                    Rl = t[r][e], n.call(t, t.__data__, u, i)
                })
            } finally {
                Rl = u, Tl = i
            }
        } else Y(this, function(u) {
            var i = u[r][e];
            (i.event || (i.event = ta.dispatch("start", "end", "interrupt"))).on(n, t)
        });
        return this
    }, Pl.transition = function() {
        for (var n, t, e, r, u = this.id, i = ++Ul, o = this.namespace, a = [], c = 0, l = this.length; l > c; c++) {
            a.push(n = []);
            for (var t = this[c], s = 0, f = t.length; f > s; s++)(e = t[s]) && (r = e[o][u], $o(e, s, o, i, {
                time: r.time,
                ease: r.ease,
                delay: r.delay + r.duration,
                duration: r.duration
            })), n.push(e)
        }
        return Yo(a, o, i)
    }, ta.svg.axis = function() {
        function n(n) {
            n.each(function() {
                var n, l = ta.select(this),
                    s = this.__chart__ || e,
                    f = this.__chart__ = e.copy(),
                    h = null == c ? f.ticks ? f.ticks.apply(f, a) : f.domain() : c,
                    g = null == t ? f.tickFormat ? f.tickFormat.apply(f, a) : y : t,
                    p = l.selectAll(".tick").data(h, f),
                    v = p.enter().insert("g", ".domain").attr("class", "tick").style("opacity", Ca),
                    d = ta.transition(p.exit()).style("opacity", Ca).remove(),
                    m = ta.transition(p.order()).style("opacity", 1),
                    M = Math.max(u, 0) + o,
                    x = Ui(f),
                    b = l.selectAll(".domain").data([0]),
                    _ = (b.enter().append("path").attr("class", "domain"), ta.transition(b));
                v.append("line"), v.append("text");
                var w, S, k, E, A = v.select("line"),
                    N = m.select("line"),
                    C = p.select("text").text(g),
                    z = v.select("text"),
                    q = m.select("text"),
                    L = "top" === r || "left" === r ? -1 : 1;
                if ("bottom" === r || "top" === r ? (n = Bo, w = "x", k = "y", S = "x2", E = "y2", C.attr("dy", 0 > L ? "0em" : ".71em").style("text-anchor", "middle"), _.attr("d", "M" + x[0] + "," + L * i + "V0H" + x[1] + "V" + L * i)) : (n = Wo, w = "y", k = "x", S = "y2", E = "x2", C.attr("dy", ".32em").style("text-anchor", 0 > L ? "end" : "start"), _.attr("d", "M" + L * i + "," + x[0] + "H0V" + x[1] + "H" + L * i)), A.attr(E, L * u), z.attr(k, L * M), N.attr(S, 0).attr(E, L * u), q.attr(w, 0).attr(k, L * M), f.rangeBand) {
                    var T = f,
                        R = T.rangeBand() / 2;
                    s = f = function(n) {
                        return T(n) + R
                    }
                } else s.rangeBand ? s = f : d.call(n, f, s);
                v.call(n, s, f), m.call(n, f, f)
            })
        }
        var t, e = ta.scale.linear(),
            r = jl,
            u = 6,
            i = 6,
            o = 3,
            a = [10],
            c = null;
        return n.scale = function(t) {
            return arguments.length ? (e = t, n) : e
        }, n.orient = function(t) {
            return arguments.length ? (r = t in Fl ? t + "" : jl, n) : r
        }, n.ticks = function() {
            return arguments.length ? (a = arguments, n) : a
        }, n.tickValues = function(t) {
            return arguments.length ? (c = t, n) : c
        }, n.tickFormat = function(e) {
            return arguments.length ? (t = e, n) : t
        }, n.tickSize = function(t) {
            var e = arguments.length;
            return e ? (u = +t, i = +arguments[e - 1], n) : u
        }, n.innerTickSize = function(t) {
            return arguments.length ? (u = +t, n) : u
        }, n.outerTickSize = function(t) {
            return arguments.length ? (i = +t, n) : i
        }, n.tickPadding = function(t) {
            return arguments.length ? (o = +t, n) : o
        }, n.tickSubdivide = function() {
            return arguments.length && n
        }, n
    };
    var jl = "bottom",
        Fl = {
            top: 1,
            right: 1,
            bottom: 1,
            left: 1
        };
    ta.svg.brush = function() {
        function n(t) {
            t.each(function() {
                var t = ta.select(this).style("pointer-events", "all").style("-webkit-tap-highlight-color", "rgba(0,0,0,0)").on("mousedown.brush", i).on("touchstart.brush", i),
                    o = t.selectAll(".background").data([0]);
                o.enter().append("rect").attr("class", "background").style("visibility", "hidden").style("cursor", "crosshair"), t.selectAll(".extent").data([0]).enter().append("rect").attr("class", "extent").style("cursor", "move");
                var a = t.selectAll(".resize").data(v, y);
                a.exit().remove(), a.enter().append("g").attr("class", function(n) {
                    return "resize " + n
                }).style("cursor", function(n) {
                    return Hl[n]
                }).append("rect").attr("x", function(n) {
                    return /[ew]$/.test(n) ? -3 : null
                }).attr("y", function(n) {
                    return /^[ns]/.test(n) ? -3 : null
                }).attr("width", 6).attr("height", 6).style("visibility", "hidden"), a.style("display", n.empty() ? "none" : null);
                var c, f = ta.transition(t),
                    h = ta.transition(o);
                l && (c = Ui(l), h.attr("x", c[0]).attr("width", c[1] - c[0]), r(f)), s && (c = Ui(s), h.attr("y", c[0]).attr("height", c[1] - c[0]), u(f)), e(f)
            })
        }

        function e(n) {
            n.selectAll(".resize").attr("transform", function(n) {
                return "translate(" + f[+/e$/.test(n)] + "," + h[+/^s/.test(n)] + ")"
            })
        }

        function r(n) {
            n.select(".extent").attr("x", f[0]), n.selectAll(".extent,.n>rect,.s>rect").attr("width", f[1] - f[0])
        }

        function u(n) {
            n.select(".extent").attr("y", h[0]), n.selectAll(".extent,.e>rect,.w>rect").attr("height", h[1] - h[0])
        }

        function i() {
            function i() {
                32 == ta.event.keyCode && (C || (M = null, q[0] -= f[1], q[1] -= h[1], C = 2), S())
            }

            function v() {
                32 == ta.event.keyCode && 2 == C && (q[0] += f[1], q[1] += h[1], C = 0, S())
            }

            function d() {
                var n = ta.mouse(b),
                    t = !1;
                x && (n[0] += x[0], n[1] += x[1]), C || (ta.event.altKey ? (M || (M = [(f[0] + f[1]) / 2, (h[0] + h[1]) / 2]), q[0] = f[+(n[0] < M[0])], q[1] = h[+(n[1] < M[1])]) : M = null), A && m(n, l, 0) && (r(k), t = !0), N && m(n, s, 1) && (u(k), t = !0), t && (e(k), w({
                    type: "brush",
                    mode: C ? "move" : "resize"
                }))
            }

            function m(n, t, e) {
                var r, u, i = Ui(t),
                    c = i[0],
                    l = i[1],
                    s = q[e],
                    v = e ? h : f,
                    d = v[1] - v[0];
                return C && (c -= s, l -= d + s), r = (e ? p : g) ? Math.max(c, Math.min(l, n[e])) : n[e], C ? u = (r += s) + d : (M && (s = Math.max(c, Math.min(l, 2 * M[e] - r))), r > s ? (u = r, r = s) : u = s), v[0] != r || v[1] != u ? (e ? a = null : o = null, v[0] = r, v[1] = u, !0) : void 0
            }

            function y() {
                d(), k.style("pointer-events", "all").selectAll(".resize").style("display", n.empty() ? "none" : null), ta.select("body").style("cursor", null), L.on("mousemove.brush", null).on("mouseup.brush", null).on("touchmove.brush", null).on("touchend.brush", null).on("keydown.brush", null).on("keyup.brush", null), z(), w({
                    type: "brushend"
                })
            }
            var M, x, b = this,
                _ = ta.select(ta.event.target),
                w = c.of(b, arguments),
                k = ta.select(b),
                E = _.datum(),
                A = !/^(n|s)$/.test(E) && l,
                N = !/^(e|w)$/.test(E) && s,
                C = _.classed("extent"),
                z = W(b),
                q = ta.mouse(b),
                L = ta.select(t(b)).on("keydown.brush", i).on("keyup.brush", v);
            if (ta.event.changedTouches ? L.on("touchmove.brush", d).on("touchend.brush", y) : L.on("mousemove.brush", d).on("mouseup.brush", y), k.interrupt().selectAll("*").interrupt(), C) q[0] = f[0] - q[0], q[1] = h[0] - q[1];
            else if (E) {
                var T = +/w$/.test(E),
                    R = +/^n/.test(E);
                x = [f[1 - T] - q[0], h[1 - R] - q[1]], q[0] = f[T], q[1] = h[R]
            } else ta.event.altKey && (M = q.slice());
            k.style("pointer-events", "none").selectAll(".resize").style("display", null), ta.select("body").style("cursor", _.style("cursor")), w({
                type: "brushstart"
            }), d()
        }
        var o, a, c = E(n, "brushstart", "brush", "brushend"),
            l = null,
            s = null,
            f = [0, 0],
            h = [0, 0],
            g = !0,
            p = !0,
            v = Ol[0];
        return n.event = function(n) {
            n.each(function() {
                var n = c.of(this, arguments),
                    t = {
                        x: f,
                        y: h,
                        i: o,
                        j: a
                    },
                    e = this.__chart__ || t;
                this.__chart__ = t, Tl ? ta.select(this).transition().each("start.brush", function() {
                    o = e.i, a = e.j, f = e.x, h = e.y, n({
                        type: "brushstart"
                    })
                }).tween("brush:brush", function() {
                    var e = yu(f, t.x),
                        r = yu(h, t.y);
                    return o = a = null,
                        function(u) {
                            f = t.x = e(u), h = t.y = r(u), n({
                                type: "brush",
                                mode: "resize"
                            })
                        }
                }).each("end.brush", function() {
                    o = t.i, a = t.j, n({
                        type: "brush",
                        mode: "resize"
                    }), n({
                        type: "brushend"
                    })
                }) : (n({
                    type: "brushstart"
                }), n({
                    type: "brush",
                    mode: "resize"
                }), n({
                    type: "brushend"
                }))
            })
        }, n.x = function(t) {
            return arguments.length ? (l = t, v = Ol[!l << 1 | !s], n) : l
        }, n.y = function(t) {
            return arguments.length ? (s = t, v = Ol[!l << 1 | !s], n) : s
        }, n.clamp = function(t) {
            return arguments.length ? (l && s ? (g = !!t[0], p = !!t[1]) : l ? g = !!t : s && (p = !!t), n) : l && s ? [g, p] : l ? g : s ? p : null
        }, n.extent = function(t) {
            var e, r, u, i, c;
            return arguments.length ? (l && (e = t[0], r = t[1], s && (e = e[0], r = r[0]), o = [e, r], l.invert && (e = l(e), r = l(r)), e > r && (c = e, e = r, r = c), (e != f[0] || r != f[1]) && (f = [e, r])), s && (u = t[0], i = t[1], l && (u = u[1], i = i[1]), a = [u, i], s.invert && (u = s(u), i = s(i)), u > i && (c = u, u = i, i = c), (u != h[0] || i != h[1]) && (h = [u, i])), n) : (l && (o ? (e = o[0], r = o[1]) : (e = f[0], r = f[1], l.invert && (e = l.invert(e), r = l.invert(r)), e > r && (c = e, e = r, r = c))), s && (a ? (u = a[0], i = a[1]) : (u = h[0], i = h[1], s.invert && (u = s.invert(u), i = s.invert(i)), u > i && (c = u, u = i, i = c))), l && s ? [
                [e, u],
                [r, i]
            ] : l ? [e, r] : s && [u, i])
        }, n.clear = function() {
            return n.empty() || (f = [0, 0], h = [0, 0], o = a = null), n
        }, n.empty = function() {
            return !!l && f[0] == f[1] || !!s && h[0] == h[1]
        }, ta.rebind(n, c, "on")
    };
    var Hl = {
            n: "ns-resize",
            e: "ew-resize",
            s: "ns-resize",
            w: "ew-resize",
            nw: "nwse-resize",
            ne: "nesw-resize",
            se: "nwse-resize",
            sw: "nesw-resize"
        },
        Ol = [
            ["n", "e", "s", "w", "nw", "ne", "se", "sw"],
            ["e", "w"],
            ["n", "s"],
            []
        ],
        Il = ac.format = gc.timeFormat,
        Yl = Il.utc,
        Zl = Yl("%Y-%m-%dT%H:%M:%S.%LZ");
    Il.iso = Date.prototype.toISOString && +new Date("2000-01-01T00:00:00.000Z") ? Jo : Zl, Jo.parse = function(n) {
        var t = new Date(n);
        return isNaN(t) ? null : t
    }, Jo.toString = Zl.toString, ac.second = Ft(function(n) {
        return new cc(1e3 * Math.floor(n / 1e3))
    }, function(n, t) {
        n.setTime(n.getTime() + 1e3 * Math.floor(t))
    }, function(n) {
        return n.getSeconds()
    }), ac.seconds = ac.second.range, ac.seconds.utc = ac.second.utc.range, ac.minute = Ft(function(n) {
        return new cc(6e4 * Math.floor(n / 6e4))
    }, function(n, t) {
        n.setTime(n.getTime() + 6e4 * Math.floor(t))
    }, function(n) {
        return n.getMinutes()
    }), ac.minutes = ac.minute.range, ac.minutes.utc = ac.minute.utc.range, ac.hour = Ft(function(n) {
        var t = n.getTimezoneOffset() / 60;
        return new cc(36e5 * (Math.floor(n / 36e5 - t) + t))
    }, function(n, t) {
        n.setTime(n.getTime() + 36e5 * Math.floor(t))
    }, function(n) {
        return n.getHours()
    }), ac.hours = ac.hour.range, ac.hours.utc = ac.hour.utc.range, ac.month = Ft(function(n) {
        return n = ac.day(n), n.setDate(1), n
    }, function(n, t) {
        n.setMonth(n.getMonth() + t)
    }, function(n) {
        return n.getMonth()
    }), ac.months = ac.month.range, ac.months.utc = ac.month.utc.range;
    var Vl = [1e3, 5e3, 15e3, 3e4, 6e4, 3e5, 9e5, 18e5, 36e5, 108e5, 216e5, 432e5, 864e5, 1728e5, 6048e5, 2592e6, 7776e6, 31536e6],
        Xl = [
            [ac.second, 1],
            [ac.second, 5],
            [ac.second, 15],
            [ac.second, 30],
            [ac.minute, 1],
            [ac.minute, 5],
            [ac.minute, 15],
            [ac.minute, 30],
            [ac.hour, 1],
            [ac.hour, 3],
            [ac.hour, 6],
            [ac.hour, 12],
            [ac.day, 1],
            [ac.day, 2],
            [ac.week, 1],
            [ac.month, 1],
            [ac.month, 3],
            [ac.year, 1]
        ],
        $l = Il.multi([
            [".%L", function(n) {
                return n.getMilliseconds()
            }],
            [":%S", function(n) {
                return n.getSeconds()
            }],
            ["%I:%M", function(n) {
                return n.getMinutes()
            }],
            ["%I %p", function(n) {
                return n.getHours()
            }],
            ["%a %d", function(n) {
                return n.getDay() && 1 != n.getDate()
            }],
            ["%b %d", function(n) {
                return 1 != n.getDate()
            }],
            ["%B", function(n) {
                return n.getMonth()
            }],
            ["%Y", Ne]
        ]),
        Bl = {
            range: function(n, t, e) {
                return ta.range(Math.ceil(n / e) * e, +t, e).map(Ko)
            },
            floor: y,
            ceil: y
        };
    Xl.year = ac.year, ac.scale = function() {
        return Go(ta.scale.linear(), Xl, $l)
    };
    var Wl = Xl.map(function(n) {
            return [n[0].utc, n[1]]
        }),
        Jl = Yl.multi([
            [".%L", function(n) {
                return n.getUTCMilliseconds()
            }],
            [":%S", function(n) {
                return n.getUTCSeconds()
            }],
            ["%I:%M", function(n) {
                return n.getUTCMinutes()
            }],
            ["%I %p", function(n) {
                return n.getUTCHours()
            }],
            ["%a %d", function(n) {
                return n.getUTCDay() && 1 != n.getUTCDate()
            }],
            ["%b %d", function(n) {
                return 1 != n.getUTCDate()
            }],
            ["%B", function(n) {
                return n.getUTCMonth()
            }],
            ["%Y", Ne]
        ]);
    Wl.year = ac.year.utc, ac.scale.utc = function() {
        return Go(ta.scale.linear(), Wl, Jl)
    }, ta.text = At(function(n) {
        return n.responseText
    }), ta.json = function(n, t) {
        return Nt(n, "application/json", Qo, t)
    }, ta.html = function(n, t) {
        return Nt(n, "text/html", na, t)
    }, ta.xml = At(function(n) {
        return n.responseXML
    }), "function" == typeof define && define.amd ? define(ta) : "object" == typeof module && module.exports && (module.exports = ta), this.d3 = ta
}();

(function(f) {
    if (typeof exports === "object" && typeof module !== "undefined") {
        module.exports = f()
    } else if (typeof define === "function" && define.amd) {
        define([], f)
    } else {
        var g;
        if (typeof window !== "undefined") {
            g = window
        } else if (typeof global !== "undefined") {
            g = global
        } else if (typeof self !== "undefined") {
            g = self
        } else {
            g = this
        }
        g.escher = f()
    }
})(function() {
    var define, module, exports;
    return (function e(t, n, r) {
        function s(o, u) {
            if (!n[o]) {
                if (!t[o]) {
                    var a = typeof require == "function" && require;
                    if (!u && a) return a(o, !0);
                    if (i) return i(o, !0);
                    var f = new Error("Cannot find module '" + o + "'");
                    throw f.code = "MODULE_NOT_FOUND", f
                }
                var l = n[o] = {
                    exports: {}
                };
                t[o][0].call(l.exports, function(e) {
                    var n = t[o][1][e];
                    return s(n ? n : e)
                }, l, l.exports, e, t, n, r)
            }
            return n[o].exports
        }
        var i = typeof require == "function" && require;
        for (var o = 0; o < r.length; o++) s(r[o]);
        return s
    })({
        1: [function(require, module, exports) {
            var utils = require('./utils');
            var build = require('./build');
            var Behavior = utils.make_class();
            Behavior.prototype = {
                init: init,
                toggle_rotation_mode: toggle_rotation_mode,
                turn_everything_on: turn_everything_on,
                turn_everything_off: turn_everything_off,
                toggle_selectable_click: toggle_selectable_click,
                toggle_text_label_edit: toggle_text_label_edit,
                toggle_selectable_drag: toggle_selectable_drag,
                toggle_label_drag: toggle_label_drag,
                toggle_label_mousedown: toggle_label_mousedown,
                toggle_bezier_drag: toggle_bezier_drag,
                turn_off_drag: turn_off_drag,
                _get_selectable_drag: _get_selectable_drag,
                _get_bezier_drag: _get_bezier_drag,
                _get_reaction_label_drag: _get_reaction_label_drag,
                _get_node_label_drag: _get_node_label_drag,
                _get_generic_drag: _get_generic_drag,
                _get_generic_angular_drag: _get_generic_angular_drag
            };
            module.exports = Behavior;

            function init(map, undo_stack) {
                this.map = map;
                this.undo_stack = undo_stack;
                this.empty_behavior = function() {};
                this.rotation_mode_enabled = false;
                this.rotation_drag = d3.behavior.drag();
                this.selectable_mousedown = null;
                this.text_label_mousedown = null;
                this.text_label_click = null;
                this.selectable_drag = this.empty_behavior;
                this.node_mouseover = null;
                this.node_mouseout = null;
                this.label_mousedown = null;
                this.label_mouseover = null;
                this.label_mouseout = null;
                this.bezier_drag = this.empty_behavior;
                this.bezier_mouseover = null;
                this.bezier_mouseout = null;
                this.reaction_label_drag = this.empty_behavior;
                this.node_label_drag = this.empty_behavior;
                this.turn_everything_on();
            }

            function turn_everything_on() {
                this.toggle_selectable_click(true);
                this.toggle_selectable_drag(true);
                this.toggle_label_drag(true);
                this.toggle_label_mousedown(true);
            }

            function turn_everything_off() {
                this.toggle_selectable_click(false);
                this.toggle_selectable_drag(false);
                this.toggle_label_drag(false);
                this.toggle_label_mousedown(false);
            }

            function toggle_rotation_mode(on_off) {
                if (on_off === undefined) {
                    this.rotation_mode_enabled = !this.rotation_mode_enabled;
                } else {
                    this.rotation_mode_enabled = on_off;
                }
                var selection_node = this.map.sel.selectAll('.node-circle'),
                    selection_background = this.map.sel.selectAll('#canvas');
                if (this.rotation_mode_enabled) {
                    this.map.callback_manager.run('start_rotation');
                    var selected_nodes = this.map.get_selected_nodes();
                    if (Object.keys(selected_nodes).length == 0) {
                        console.warn('No selected nodes');
                        return;
                    }
                    this.center = average_location(selected_nodes);
                    show_center.call(this);
                    var map = this.map,
                        selected_node_ids = Object.keys(selected_nodes),
                        reactions = this.map.reactions,
                        nodes = this.map.nodes,
                        beziers = this.map.beziers;
                    var start_fn = function(d) {
                            d3.event.sourceEvent.stopPropagation();
                        },
                        drag_fn = function(d, angle, total_angle, center) {
                            var updated = build.rotate_nodes(selected_nodes, reactions, beziers, angle, center);
                            map.draw_these_nodes(updated.node_ids);
                            map.draw_these_reactions(updated.reaction_ids);
                        },
                        end_fn = function(d) {},
                        undo_fn = function(d, total_angle, center) {
                            var these_nodes = {};
                            selected_node_ids.forEach(function(id) {
                                these_nodes[id] = nodes[id];
                            });
                            var updated = build.rotate_nodes(these_nodes, reactions, beziers, -total_angle, center);
                            map.draw_these_nodes(updated.node_ids);
                            map.draw_these_reactions(updated.reaction_ids);
                        },
                        redo_fn = function(d, total_angle, center) {
                            var these_nodes = {};
                            selected_node_ids.forEach(function(id) {
                                these_nodes[id] = nodes[id];
                            });
                            var updated = build.rotate_nodes(these_nodes, reactions, beziers, total_angle, center);
                            map.draw_these_nodes(updated.node_ids);
                            map.draw_these_reactions(updated.reaction_ids);
                        },
                        center_fn = function() {
                            return this.center;
                        }.bind(this);
                    this.rotation_drag = this._get_generic_angular_drag(start_fn, drag_fn, end_fn, undo_fn, redo_fn, center_fn, this.map.sel);
                    selection_background.call(this.rotation_drag);
                    this.selectable_drag = this.rotation_drag;
                } else {
                    hide_center.call(this);
                    selection_node.on('mousedown.center', null);
                    selection_background.on('mousedown.center', null);
                    selection_background.on('mousedown.drag', null);
                    selection_background.on('touchstart.drag', null);
                    this.rotation_drag = null;
                    this.selectable_drag = null;
                }

                function show_center() {
                    var s = this.map.sel.selectAll('#rotation-center').data([0]),
                        enter = s.enter().append('g').attr('id', 'rotation-center');
                    enter.append('path').attr('d', 'M-32 0 L32 0').attr('class', 'rotation-center-line');
                    enter.append('path').attr('d', 'M0 -32 L0 32').attr('class', 'rotation-center-line');
                    s.attr('transform', 'translate(' + this.center.x + ',' + this.center.y + ')').attr('visibility', 'visible');
                    s.call(d3.behavior.drag().on('drag', function(sel) {
                        var cur = utils.d3_transform_catch(sel.attr('transform')),
                            new_loc = [d3.event.dx + cur.translate[0], d3.event.dy + cur.translate[1]];
                        sel.attr('transform', 'translate(' + new_loc + ')');
                        this.center = {
                            x: new_loc[0],
                            y: new_loc[1]
                        };
                    }.bind(this, s)));
                    s.on('mouseover', function() {
                        var current = parseFloat(this.selectAll('path').style('stroke-width'));
                        this.selectAll('path').style('stroke-width', current * 2 + 'px');
                    }.bind(s));
                    s.on('mouseout', function() {
                        this.selectAll('path').style('stroke-width', null);
                    }.bind(s));
                }

                function hide_center(sel) {
                    this.map.sel.select('#rotation-center').attr('visibility', 'hidden');
                }

                function average_location(nodes) {
                    var xs = [],
                        ys = [];
                    for (var node_id in nodes) {
                        var node = nodes[node_id];
                        if (node.x !== undefined)
                            xs.push(node.x);
                        if (node.y !== undefined)
                            ys.push(node.y);
                    }
                    return {
                        x: utils.mean(xs),
                        y: utils.mean(ys)
                    };
                }
            }

            function toggle_selectable_click(on_off) {
                if (on_off === undefined) on_off = this.selectable_mousedown === null;
                if (on_off) {
                    var map = this.map;
                    this.selectable_mousedown = function(d) {
                        d3.event.stopPropagation();
                    };
                    this.selectable_click = function(d) {
                        d3.event.stopPropagation();
                        if (d3.event.defaultPrevented) return;
                        map.select_selectable(this, d, d3.event.shiftKey);
                    };
                    this.node_mouseover = function(d) {
                        d3.select(this).style('stroke-width', null);
                        var current = parseFloat(d3.select(this).style('stroke-width'));
                        if (!d3.select(this.parentNode).classed('selected'))
                            d3.select(this).style('stroke-width', current * 3 + 'px');
                    };
                    this.node_mouseout = function(d) {
                        d3.select(this).style('stroke-width', null);
                    };
                } else {
                    this.selectable_mousedown = null;
                    this.selectable_click = null;
                    this.node_mouseover = null;
                    this.node_mouseout = null;
                    this.map.sel.select('#nodes').selectAll('.node-circle').style('stroke-width', null);
                }
            }

            function toggle_text_label_edit(on_off) {
                if (on_off === undefined) on_off = this.text_edit_mousedown == null;
                if (on_off) {
                    var map = this.map,
                        selection = this.selection;
                    this.text_label_mousedown = function() {
                        if (d3.event.defaultPrevented) return;
                        var coords_a = utils.d3_transform_catch(d3.select(this).attr('transform')).translate,
                            coords = {
                                x: coords_a[0],
                                y: coords_a[1]
                            };
                        map.callback_manager.run('edit_text_label', null, d3.select(this), coords);
                        d3.event.stopPropagation();
                    };
                    this.text_label_click = null;
                    this.map.sel.select('#text-labels').selectAll('.label').classed('edit-text-cursor', true);
                    this.map.sel.on('mousedown.new_text_label', function(node) {
                        d3.event.preventDefault();
                        var coords = {
                            x: d3.mouse(node)[0],
                            y: d3.mouse(node)[1]
                        };
                        this.map.callback_manager.run('new_text_label', null, coords);
                    }.bind(this, this.map.sel.node()));
                } else {
                    this.text_label_mousedown = this.selectable_mousedown;
                    this.text_label_click = this.selectable_click;
                    this.map.sel.select('#text-labels').selectAll('.label').classed('edit-text-cursor', false);
                    this.map.sel.on('mousedown.new_text_label', null);
                    this.map.callback_manager.run('hide_text_label_editor');
                }
            }

            function toggle_selectable_drag(on_off) {
                if (on_off === undefined) on_off = this.selectable_drag === this.empty_behavior;
                if (on_off) {
                    this.selectable_drag = this._get_selectable_drag(this.map, this.undo_stack);
                    this.bezier_drag = this._get_bezier_drag(this.map, this.undo_stack);
                } else {
                    this.selectable_drag = this.empty_behavior;
                    this.bezier_drag = this.empty_behavior;
                }
            }

            function toggle_label_drag(on_off) {
                if (on_off === undefined) on_off = this.label_drag === this.empty_behavior;
                if (on_off) {
                    this.reaction_label_drag = this._get_reaction_label_drag(this.map);
                    this.node_label_drag = this._get_node_label_drag(this.map);
                } else {
                    this.reaction_label_drag = this.empty_behavior;
                    this.node_label_drag = this.empty_behavior;
                }
            }

            function toggle_label_mousedown(on_off) {
                if (on_off === undefined) on_off = this.label_mousedown == null;
                if (on_off) {
                    var map = this.map;
                    this.label_mousedown = function(d) {};
                    this.label_mouseover = function(d) {};
                    this.label_mouseout = function(d) {};
                } else {
                    this.label_mousedown = null;
                    this.label_mouseover = null;
                    this.label_mouseout = null;
                    this.map.sel.select('.node-label,.reaction-label').style('fill', null);
                }
            }

            function toggle_bezier_drag(on_off) {
                if (on_off === undefined) on_off = this.bezier_drag === this.empty_behavior;
                if (on_off) {
                    this.bezier_drag = this._get_bezier_drag(this.map);
                    this.bezier_mouseover = function(d) {
                        d3.select(this).style('stroke-width', String(3) + 'px');
                    };
                    this.bezier_mouseout = function(d) {
                        d3.select(this).style('stroke-width', String(1) + 'px');
                    };
                } else {
                    this.bezier_drag = this.empty_behavior;
                    this.bezier_mouseover = null;
                    this.bezier_mouseout = null;
                }
            }

            function turn_off_drag(sel) {
                sel.on('mousedown.drag', null);
                sel.on('touchstart.drag', null);
            }

            function _get_selectable_drag(map, undo_stack) {
                var behavior = d3.behavior.drag(),
                    the_timeout = null,
                    total_displacement = null,
                    node_ids_to_drag = null,
                    reaction_ids = null,
                    text_label_ids_to_drag = null,
                    move_label = function(text_label_id, displacement) {
                        var text_label = map.text_labels[text_label_id];
                        text_label.x = text_label.x + displacement.x;
                        text_label.y = text_label.y + displacement.y;
                    };
                behavior.on("dragstart", function(d) {
                    d3.event.sourceEvent.stopPropagation();
                    total_displacement = {
                        x: 0,
                        y: 0
                    };
                    if (d3.select(this).attr('class').indexOf('label') == -1) {
                        var data = this.parentNode.__data__,
                            bigg_id = data.bigg_id,
                            node_group = this.parentNode;
                        the_timeout = setTimeout(function() {
                            node_group.parentNode.insertBefore(node_group, node_group.parentNode.firstChild);
                        }, 200);
                        map.sel.selectAll('.metabolite-circle').on('mouseover.combine', function(d) {
                            if (d.bigg_id == bigg_id && d.node_id != data.node_id) {
                                d3.select(this).style('stroke-width', String(12) + 'px').classed('node-to-combine', true);
                            }
                        }).on('mouseout.combine', function(d) {
                            if (d.bigg_id == bigg_id) {
                                map.sel.selectAll('.node-to-combine').style('stroke-width', String(2) + 'px').classed('node-to-combine', false);
                            }
                        });
                    }
                });
                behavior.on("drag", function(d) {
                    if (!d3.select(this.parentNode).classed('selected'))
                        map.select_selectable(this, d);
                    var grabbed = {};
                    if (d3.select(this).attr('class').indexOf('label') === -1) {
                        grabbed['type'] = 'node';
                        grabbed['id'] = this.parentNode.__data__.node_id;
                    } else {
                        grabbed['type'] = 'label';
                        grabbed['id'] = this.__data__.text_label_id;
                    }
                    var selected_node_ids = map.get_selected_node_ids(),
                        selected_text_label_ids = map.get_selected_text_label_ids();
                    node_ids_to_drag = [];
                    text_label_ids_to_drag = [];
                    if (grabbed['type'] == 'node' && selected_node_ids.indexOf(grabbed['id']) == -1) {
                        node_ids_to_drag.push(grabbed['id']);
                    } else if (grabbed['type'] == 'label' && selected_text_label_ids.indexOf(grabbed['id']) == -1) {
                        text_label_ids_to_drag.push(grabbed['id']);
                    } else {
                        node_ids_to_drag = selected_node_ids;
                        text_label_ids_to_drag = selected_text_label_ids;
                    }
                    reaction_ids = [];
                    var displacement = {
                        x: d3.event.dx,
                        y: d3.event.dy
                    };
                    total_displacement = utils.c_plus_c(total_displacement, displacement);
                    node_ids_to_drag.forEach(function(node_id) {
                        var node = map.nodes[node_id],
                            updated = build.move_node_and_dependents(node, node_id, map.reactions, map.beziers, displacement);
                        reaction_ids = utils.unique_concat([reaction_ids, updated.reaction_ids]);
                    });
                    text_label_ids_to_drag.forEach(function(text_label_id) {
                        move_label(text_label_id, displacement);
                    });
                    map.draw_these_nodes(node_ids_to_drag);
                    map.draw_these_reactions(reaction_ids);
                    map.draw_these_text_labels(text_label_ids_to_drag);
                });
                behavior.on("dragend", function() {
                    if (node_ids_to_drag === null) {
                        total_displacement = null;
                        node_ids_to_drag = null;
                        text_label_ids_to_drag = null;
                        reaction_ids = null;
                        the_timeout = null;
                        return;
                    }
                    var node_to_combine_array = [];
                    map.sel.selectAll('.node-to-combine').each(function(d) {
                        node_to_combine_array.push(d.node_id);
                    });
                    if (node_to_combine_array.length == 1) {
                        var fixed_node_id = node_to_combine_array[0],
                            dragged_node_id = this.parentNode.__data__.node_id,
                            saved_dragged_node = utils.clone(map.nodes[dragged_node_id]),
                            segment_objs_moved_to_combine = combine_nodes_and_draw(fixed_node_id, dragged_node_id);
                        undo_stack.push(function() {
                            map.nodes[dragged_node_id] = saved_dragged_node;
                            var fixed_node = map.nodes[fixed_node_id],
                                updated_reactions = [];
                            segment_objs_moved_to_combine.forEach(function(segment_obj) {
                                var segment = map.reactions[segment_obj.reaction_id].segments[segment_obj.segment_id];
                                if (segment.from_node_id == fixed_node_id) {
                                    segment.from_node_id = dragged_node_id;
                                } else if (segment.to_node_id == fixed_node_id) {
                                    segment.to_node_id = dragged_node_id;
                                } else {
                                    console.error('Segment does not connect to fixed node');
                                }
                                fixed_node.connected_segments = fixed_node.connected_segments.filter(function(x) {
                                    return !(x.reaction_id == segment_obj.reaction_id && x.segment_id == segment_obj.segment_id);
                                });
                                if (updated_reactions.indexOf(segment_obj.reaction_id) == -1)
                                    updated_reactions.push(segment_obj.reaction_id);
                            });
                            map.draw_these_nodes([dragged_node_id]);
                            map.draw_these_reactions(updated_reactions);
                        }, function() {
                            combine_nodes_and_draw(fixed_node_id, dragged_node_id);
                        });
                    } else {
                        var saved_displacement = utils.clone(total_displacement),
                            saved_node_ids = utils.clone(node_ids_to_drag),
                            saved_text_label_ids = utils.clone(text_label_ids_to_drag),
                            saved_reaction_ids = utils.clone(reaction_ids);
                        undo_stack.push(function() {
                            saved_node_ids.forEach(function(node_id) {
                                var node = map.nodes[node_id];
                                build.move_node_and_dependents(node, node_id, map.reactions, map.beziers, utils.c_times_scalar(saved_displacement, -1));
                            });
                            saved_text_label_ids.forEach(function(text_label_id) {
                                move_label(text_label_id, utils.c_times_scalar(saved_displacement, -1));
                            });
                            map.draw_these_nodes(saved_node_ids);
                            map.draw_these_reactions(saved_reaction_ids);
                            map.draw_these_text_labels(saved_text_label_ids);
                        }, function() {
                            saved_node_ids.forEach(function(node_id) {
                                var node = map.nodes[node_id];
                                build.move_node_and_dependents(node, node_id, map.reactions, map.beziers, saved_displacement);
                            });
                            saved_text_label_ids.forEach(function(text_label_id) {
                                move_label(text_label_id, saved_displacement);
                            });
                            map.draw_these_nodes(saved_node_ids);
                            map.draw_these_reactions(saved_reaction_ids);
                            map.draw_these_text_labels(saved_text_label_ids);
                        });
                    }
                    map.sel.selectAll('.metabolite-circle').on('mouseover.combine', null).on('mouseout.combine', null);
                    clearTimeout(the_timeout);
                    total_displacement = null;
                    node_ids_to_drag = null;
                    text_label_ids_to_drag = null;
                    reaction_ids = null;
                    the_timeout = null;
                });
                return behavior;

                function combine_nodes_and_draw(fixed_node_id, dragged_node_id) {
                    var dragged_node = map.nodes[dragged_node_id],
                        fixed_node = map.nodes[fixed_node_id],
                        updated_segment_objs = [];
                    dragged_node.connected_segments.forEach(function(segment_obj) {
                        var segment;
                        try {
                            segment = map.reactions[segment_obj.reaction_id].segments[segment_obj.segment_id];
                            if (segment === undefined) throw new Error('undefined segment');
                        } catch (e) {
                            console.warn('Could not find connected segment ' + segment_obj.segment_id);
                            return;
                        }
                        if (segment.from_node_id == dragged_node_id) segment.from_node_id = fixed_node_id;
                        else if (segment.to_node_id == dragged_node_id) segment.to_node_id = fixed_node_id;
                        else {
                            console.error('Segment does not connect to dragged node');
                            return;
                        }
                        fixed_node.connected_segments.push(segment_obj);
                        updated_segment_objs.push(utils.clone(segment_obj));
                        return;
                    });
                    map.delete_node_data([dragged_node_id]);
                    map.sel.selectAll('.node-to-combine').classed('node-to-combine', false);
                    map.draw_everything();
                    return updated_segment_objs;
                }
            }

            function _get_bezier_drag(map) {
                var move_bezier = function(reaction_id, segment_id, bez, bezier_id, displacement) {
                        var segment = map.reactions[reaction_id].segments[segment_id];
                        segment[bez] = utils.c_plus_c(segment[bez], displacement);
                        map.beziers[bezier_id].x = segment[bez].x;
                        map.beziers[bezier_id].y = segment[bez].y;
                    },
                    start_fn = function(d) {
                        d.dragging = true;
                    },
                    drag_fn = function(d, displacement, total_displacement) {
                        move_bezier(d.reaction_id, d.segment_id, d.bezier, d.bezier_id, displacement);
                        map.draw_these_reactions([d.reaction_id], false);
                        map.draw_these_beziers([d.bezier_id]);
                    },
                    end_fn = function(d) {
                        d.dragging = false;
                    },
                    undo_fn = function(d, displacement) {
                        move_bezier(d.reaction_id, d.segment_id, d.bezier, d.bezier_id, utils.c_times_scalar(displacement, -1));
                        map.draw_these_reactions([d.reaction_id], false);
                        map.draw_these_beziers([d.bezier_id]);
                    },
                    redo_fn = function(d, displacement) {
                        move_bezier(d.reaction_id, d.segment_id, d.bezier, d.bezier_id, displacement);
                        map.draw_these_reactions([d.reaction_id], false);
                        map.draw_these_beziers([d.bezier_id]);
                    };
                return this._get_generic_drag(start_fn, drag_fn, end_fn, undo_fn, redo_fn, this.map.sel);
            }

            function _get_reaction_label_drag(map) {
                var move_label = function(reaction_id, displacement) {
                        var reaction = map.reactions[reaction_id];
                        reaction.label_x = reaction.label_x + displacement.x;
                        reaction.label_y = reaction.label_y + displacement.y;
                    },
                    start_fn = function(d) {},
                    drag_fn = function(d, displacement, total_displacement) {
                        move_label(d.reaction_id, displacement);
                        map.draw_these_reactions([d.reaction_id]);
                    },
                    end_fn = function(d) {},
                    undo_fn = function(d, displacement) {
                        move_label(d.reaction_id, utils.c_times_scalar(displacement, -1));
                        map.draw_these_reactions([d.reaction_id]);
                    },
                    redo_fn = function(d, displacement) {
                        move_label(d.reaction_id, displacement);
                        map.draw_these_reactions([d.reaction_id]);
                    };
                return this._get_generic_drag(start_fn, drag_fn, end_fn, undo_fn, redo_fn, this.map.sel);
            }

            function _get_node_label_drag(map) {
                var move_label = function(node_id, displacement) {
                        var node = map.nodes[node_id];
                        node.label_x = node.label_x + displacement.x;
                        node.label_y = node.label_y + displacement.y;
                    },
                    start_fn = function(d) {},
                    drag_fn = function(d, displacement, total_displacement) {
                        move_label(d.node_id, displacement);
                        map.draw_these_nodes([d.node_id]);
                    },
                    end_fn = function(d) {},
                    undo_fn = function(d, displacement) {
                        move_label(d.node_id, utils.c_times_scalar(displacement, -1));
                        map.draw_these_nodes([d.node_id]);
                    },
                    redo_fn = function(d, displacement) {
                        move_label(d.node_id, displacement);
                        map.draw_these_nodes([d.node_id]);
                    };
                return this._get_generic_drag(start_fn, drag_fn, end_fn, undo_fn, redo_fn, this.map.sel);
            }

            function _get_generic_drag(start_fn, drag_fn, end_fn, undo_fn, redo_fn, relative_to_selection) {
                var behavior = d3.behavior.drag(),
                    total_displacement, undo_stack = this.undo_stack,
                    rel = relative_to_selection.node();
                behavior.on("dragstart", function(d) {
                    d3.event.sourceEvent.stopPropagation();
                    total_displacement = {
                        x: 0,
                        y: 0
                    };
                    start_fn(d);
                });
                behavior.on("drag", function(d) {
                    var displacement = {
                            x: d3.event.dx,
                            y: d3.event.dy
                        },
                        location = {
                            x: d3.mouse(rel)[0],
                            y: d3.mouse(rel)[1]
                        };
                    total_displacement = utils.c_plus_c(total_displacement, displacement);
                    drag_fn(d, displacement, total_displacement, location);
                });
                behavior.on("dragend", function(d) {
                    var saved_d = utils.clone(d),
                        saved_displacement = utils.clone(total_displacement),
                        saved_location = {
                            x: d3.mouse(rel)[0],
                            y: d3.mouse(rel)[1]
                        };
                    undo_stack.push(function() {
                        undo_fn(saved_d, saved_displacement, saved_location);
                    }, function() {
                        redo_fn(saved_d, saved_displacement, saved_location);
                    });
                    end_fn(d);
                });
                return behavior;
            }

            function _get_generic_angular_drag(start_fn, drag_fn, end_fn, undo_fn, redo_fn, get_center, relative_to_selection) {
                var behavior = d3.behavior.drag(),
                    total_angle, undo_stack = this.undo_stack,
                    rel = relative_to_selection.node();
                behavior.on("dragstart", function(d) {
                    d3.event.sourceEvent.stopPropagation();
                    total_angle = 0;
                    start_fn(d);
                });
                behavior.on("drag", function(d) {
                    var displacement = {
                            x: d3.event.dx,
                            y: d3.event.dy
                        },
                        location = {
                            x: d3.mouse(rel)[0],
                            y: d3.mouse(rel)[1]
                        },
                        center = get_center(),
                        angle = utils.angle_for_event(displacement, location, center);
                    total_angle = total_angle + angle;
                    drag_fn(d, angle, total_angle, center);
                });
                behavior.on("dragend", function(d) {
                    var saved_d = utils.clone(d),
                        saved_angle = total_angle,
                        saved_center = utils.clone(get_center());
                    undo_stack.push(function() {
                        undo_fn(saved_d, saved_angle, saved_center);
                    }, function() {
                        redo_fn(saved_d, saved_angle, saved_center);
                    });
                    end_fn(d);
                });
                return behavior;
            }
        }, {
            "./build": 24,
            "./utils": 31
        }],
        2: [function(require, module, exports) {
            var utils = require('./utils');
            var Brush = utils.make_class();
            Brush.prototype = {
                init: init,
                toggle: toggle,
                setup_selection_brush: setup_selection_brush
            };
            module.exports = Brush;

            function init(selection, is_enabled, map, insert_after) {
                this.brush_sel = selection.append('g').attr('id', 'brush-container');
                var node = this.brush_sel.node(),
                    insert_before_node = selection.select(insert_after).node().nextSibling;
                if (!(node === insert_before_node))
                    node.parentNode.insertBefore(node, insert_before_node);
                this.enabled = is_enabled;
                this.map = map;
            };

            function brush_is_enabled() {
                return this.map.sel.select('.brush').empty()
            }

            function toggle(on_off) {
                if (on_off === undefined) on_off = !this.enabled
                if (on_off) {
                    this.selection_brush = this.setup_selection_brush()
                } else {
                    this.brush_sel.selectAll('.brush').remove()
                }
            }

            function setup_selection_brush() {
                var selection = this.brush_sel
                var selectable_selection = this.map.sel.selectAll('#nodes,#text-labels')
                var size_and_location = this.map.canvas.size_and_location()
                var width = size_and_location.width
                var height = size_and_location.height
                var x = size_and_location.x
                var y = size_and_location.y
                selection.selectAll('g').remove()
                var brush_fn = d3.svg.brush().x(d3.scale.identity().domain([x, x + width])).y(d3.scale.identity().domain([y, y + height])).on('brush', function() {
                    var shift_key_on = d3.event.sourceEvent.shiftKey
                    var extent = d3.event.target.extent()
                    var selection
                    if (shift_key_on) {
                        selection = selectable_selection.selectAll('.node:not(.selected),.text-label:not(.selected)')
                    } else {
                        selection = selectable_selection.selectAll('.node,.text-label')
                    }
                    selection.classed('selected', function(d) {
                        var sx = d.x
                        var sy = d.y
                        return (extent[0][0] <= sx && sx < extent[1][0] && extent[0][1] <= sy && sy < extent[1][1] && d3.select(this).select('.node-circle').style('visibility') !== 'hidden')
                    })
                }).on('brushend', function() {
                    d3.event.target.clear();
                    d3.select(this).call(d3.event.target)
                })
                var brush = selection.append('g').attr('class', 'brush').call(brush_fn)
                selection.selectAll('.background').classed('cursor-grab', false).classed('cursor-grabbing', false).style('cursor', null)
                return brush
            }
        }, {
            "./utils": 31
        }],
        3: [function(require, module, exports) {
            var utils = require('./utils');
            var PlacedDiv = require('./PlacedDiv');
            var completely = require('./complete.ly');
            var DirectionArrow = require('./DirectionArrow');
            var CobraModel = require('./CobraModel');
            var _ = require('underscore');
            var BuildInput = utils.make_class();
            BuildInput.prototype = {
                init: init,
                setup_map_callbacks: setup_map_callbacks,
                setup_zoom_callbacks: setup_zoom_callbacks,
                is_visible: is_visible,
                toggle: toggle,
                show_dropdown: show_dropdown,
                hide_dropdown: hide_dropdown,
                place_at_selected: place_at_selected,
                place: place,
                reload_at_selected: reload_at_selected,
                reload: reload,
                toggle_start_reaction_listener: toggle_start_reaction_listener,
                hide_target: hide_target,
                show_target: show_target
            };
            module.exports = BuildInput;

            function init(selection, map, zoom_container, settings) {
                var new_sel = selection.append('div').attr('id', 'rxn-input');
                this.placed_div = PlacedDiv(new_sel, map, {
                    x: 240,
                    y: 0
                });
                this.placed_div.hide();
                var c = completely(new_sel.node(), {
                    backgroundColor: '#eee'
                });
                d3.select(c.input);
                this.completely = c;
                new_sel.append('button').attr('class', "button input-close-button").text("").on('mousedown', function() {
                    this.hide_dropdown();
                }.bind(this));
                this.map = map;
                var default_angle = 90;
                this.direction_arrow = new DirectionArrow(map.sel);
                this.direction_arrow.set_rotation(default_angle);
                this.setup_map_callbacks(map);
                this.zoom_container = zoom_container;
                this.setup_zoom_callbacks(zoom_container);
                this.settings = settings;
                this.toggle(false);
                this.target_coords = null;
            }

            function setup_map_callbacks(map) {
                map.callback_manager.set('select_metabolite_with_id.input', function(selected_node, coords) {
                    if (this.is_active) {
                        this.reload(selected_node, coords, false);
                        this.show_dropdown(coords);
                    }
                    this.hide_target();
                }.bind(this));
                map.callback_manager.set('select_selectable.input', function(count, selected_node, coords) {
                    this.hide_target();
                    if (count == 1 && this.is_active && coords) {
                        this.reload(selected_node, coords, false);
                        this.show_dropdown(coords);
                    } else {
                        this.toggle(false);
                    }
                }.bind(this));
                map.callback_manager.set('deselect_nodes', function() {
                    this.direction_arrow.hide();
                    this.hide_dropdown();
                }.bind(this));
                map.callback_manager.set('before_svg_export', function() {
                    this.direction_arrow.hide();
                    this.hide_target();
                }.bind(this));
            }

            function setup_zoom_callbacks(zoom_container) {
                zoom_container.callback_manager.set('zoom.input', function() {
                    if (this.is_active) {
                        this.place_at_selected();
                    }
                }.bind(this));
            }

            function is_visible() {
                return this.placed_div.is_visible();
            }

            function toggle(on_off) {
                if (on_off === undefined) this.is_active = !this.is_active;
                else this.is_active = on_off;
                if (this.is_active) {
                    this.toggle_start_reaction_listener(true);
                    if (_.isNull(this.target_coords))
                        this.reload_at_selected();
                    else
                        this.placed_div.place(this.target_coords);
                    this.show_dropdown();
                    this.map.set_status('Click on the canvas or an existing metabolite');
                    this.direction_arrow.show();
                } else {
                    this.toggle_start_reaction_listener(false);
                    this.hide_dropdown();
                    this.map.set_status(null);
                    this.direction_arrow.hide();
                }
            }

            function show_dropdown(coords) {
                this.clear_escape = this.map.key_manager.add_escape_listener(function() {
                    this.hide_dropdown();
                }.bind(this), true);
                this.completely.input.blur();
                this.completely.repaint();
                this.completely.setText('');
                this.completely.input.focus();
            }

            function hide_dropdown() {
                if (this.clear_escape) this.clear_escape();
                this.clear_escape = null;
                this.placed_div.hide();
                this.completely.input.blur();
                this.completely.hideDropDown();
            }

            function place_at_selected() {
                this.map.deselect_text_labels();
                var selected_node = this.map.select_single_node();
                if (selected_node == null) return;
                var coords = {
                    x: selected_node.x,
                    y: selected_node.y
                };
                this.place(coords);
            }

            function place(coords) {
                this.placed_div.place(coords);
                this.direction_arrow.set_location(coords);
                this.direction_arrow.show();
            }

            function reload_at_selected() {
                this.map.deselect_text_labels();
                var selected_node = this.map.select_single_node();
                if (selected_node == null) return false;
                var coords = {
                    x: selected_node.x,
                    y: selected_node.y
                };
                this.reload(selected_node, coords, false);
                return true;
            }

            function reload(selected_node, coords, starting_from_scratch) {
                if (!starting_from_scratch && !selected_node) {
                    console.error('No selected node, and not starting from scratch');
                    return;
                }
                this.place(coords);
                if (this.map.cobra_model === null) {
                    this.completely.setText('Cannot add: No model.');
                    return;
                }
                var show_names = this.settings.get_option('identifiers_on_map') == 'name',
                    allow_duplicates = this.settings.get_option('allow_building_duplicate_reactions');
                var options = [],
                    cobra_reactions = this.map.cobra_model.reactions,
                    cobra_metabolites = this.map.cobra_model.metabolites,
                    reactions = this.map.reactions,
                    has_data_on_reactions = this.map.has_data_on_reactions,
                    reaction_data = this.map.reaction_data,
                    reaction_data_styles = this.map.reaction_data_styles,
                    selected_m_name = (selected_node ? (show_names ? selected_node.name : selected_node.bigg_id) : ''),
                    bold_mets_in_str = function(str, mets) {
                        return str.replace(new RegExp('(^| )(' + mets.join('|') + ')($| )', 'g'), '$1<b>$2</b>$3');
                    };
                var reaction_suggestions = {};
                for (var bigg_id in cobra_reactions) {
                    var reaction = cobra_reactions[bigg_id],
                        reaction_name = reaction.name,
                        show_r_name = (show_names ? reaction_name : bigg_id);
                    if ((!allow_duplicates) && already_drawn(bigg_id, reactions))
                        continue;
                    for (var met_bigg_id in reaction.metabolites) {
                        if (starting_from_scratch || met_bigg_id == selected_node.bigg_id) {
                            if (bigg_id in reaction_suggestions) continue;
                            var met_name = cobra_metabolites[met_bigg_id].name;
                            if (has_data_on_reactions) {
                                options.push({
                                    reaction_data: reaction.data,
                                    html: ('<b>' + show_r_name + '</b>' + ': ' +
                                        reaction.data_string),
                                    matches: [show_r_name],
                                    id: bigg_id
                                });
                                reaction_suggestions[bigg_id] = true;
                            } else {
                                var mets = {},
                                    show_met_names = [],
                                    met_id;
                                if (show_names) {
                                    for (met_id in reaction.metabolites) {
                                        var name = cobra_metabolites[met_id].name;
                                        mets[name] = reaction.metabolites[met_id];
                                        show_met_names.push(name);
                                    }
                                } else {
                                    mets = utils.clone(reaction.metabolites);
                                    for (met_id in reaction.metabolites) {
                                        show_met_names.push(met_id);
                                    }
                                }
                                var show_gene_names = _.flatten(reaction.genes.map(function(g_obj) {
                                    return [g_obj.name, g_obj.bigg_id];
                                }));
                                var reaction_string = CobraModel.build_reaction_string(mets, reaction.reversibility, reaction.lower_bound, reaction.upper_bound);
                                options.push({
                                    html: ('<b>' + show_r_name + '</b>' + '\t' +
                                        bold_mets_in_str(reaction_string, [selected_m_name])),
                                    matches: [show_r_name].concat(show_met_names).concat(show_gene_names),
                                    id: bigg_id
                                });
                                reaction_suggestions[bigg_id] = true;
                            }
                        }
                    }
                }
                var sort_fn;
                if (has_data_on_reactions) {
                    sort_fn = function(x, y) {
                        return Math.abs(y.reaction_data) - Math.abs(x.reaction_data);
                    };
                } else {
                    sort_fn = function(x, y) {
                        return (x.html.toLowerCase() < y.html.toLowerCase() ? -1 : 1);
                    };
                }
                options = options.sort(sort_fn);
                var complete = this.completely;
                complete.options = options;
                complete.setText('');
                var direction_arrow = this.direction_arrow,
                    check_and_build = function(id) {
                        if (id !== null) {
                            if (starting_from_scratch) {
                                this.map.new_reaction_from_scratch(id, coords, direction_arrow.get_rotation());
                            } else {
                                if (!(selected_node.node_id in this.map.nodes)) {
                                    console.error('Selected node no longer exists');
                                    this.hide_dropdown();
                                    return;
                                }
                                this.map.new_reaction_for_metabolite(id, selected_node.node_id, direction_arrow.get_rotation());
                            }
                        }
                    }.bind(this);
                complete.onEnter = function(id) {
                    this.setText('');
                    this.onChange('');
                    check_and_build(id);
                };

                function already_drawn(bigg_id, reactions) {
                    for (var drawn_id in reactions) {
                        if (reactions[drawn_id].bigg_id == bigg_id)
                            return true;
                    }
                    return false;
                };
            }

            function toggle_start_reaction_listener(on_off) {
                if (on_off === undefined)
                    this.start_reaction_listener = !this.start_reaction_listener;
                else if (this.start_reaction_listener == on_off)
                    return;
                else
                    this.start_reaction_listener = on_off;
                if (this.start_reaction_listener) {
                    this.map.sel.on('click.start_reaction', function(node) {
                        if (this.direction_arrow.dragging) return;
                        var coords = {
                            x: d3.mouse(node)[0],
                            y: d3.mouse(node)[1]
                        };
                        this.map.deselect_nodes();
                        this.map.deselect_text_labels();
                        this.reload(null, coords, true);
                        this.show_target(this.map, coords);
                        this.show_dropdown(coords);
                    }.bind(this, this.map.sel.node()));
                    this.map.sel.classed('start-reaction-cursor', true);
                } else {
                    this.map.sel.on('click.start_reaction', null);
                    this.map.sel.classed('start-reaction-cursor', false);
                    this.hide_target();
                }
            }

            function hide_target() {
                if (this.target_coords)
                    this.map.sel.selectAll('.start-reaction-target').remove();
                this.target_coords = null;
            }

            function show_target(map, coords) {
                var s = map.sel.selectAll('.start-reaction-target').data([12, 5]);
                s.enter().append('circle').classed('start-reaction-target', true).attr('r', function(d) {
                    return d;
                }).style('stroke-width', 4);
                s.style('visibility', 'visible').attr('transform', 'translate(' + coords.x + ',' + coords.y + ')');
                this.target_coords = coords;
            }
        }, {
            "./CobraModel": 7,
            "./DirectionArrow": 9,
            "./PlacedDiv": 13,
            "./complete.ly": 25,
            "./utils": 31,
            "underscore": 35
        }],
        4: [function(require, module, exports) {
            var utils = require('./utils');
            var BuildInput = require('./BuildInput');
            var ZoomContainer = require('./ZoomContainer');
            var Map = require('./Map');
            var CobraModel = require('./CobraModel');
            var Brush = require('./Brush');
            var CallbackManager = require('./CallbackManager');
            var ui = require('./ui');
            var SearchBar = require('./SearchBar');
            var Settings = require('./Settings');
            var SettingsMenu = require('./SettingsMenu');
            var TextEditInput = require('./TextEditInput');
            var QuickJump = require('./QuickJump');
            var data_styles = require('./data_styles');
            var builder_embed = require('./inline').builder_embed;
            var _ = require('underscore')
            var Builder = utils.make_class();
            Builder.prototype = {
                init: init,
                load_map: load_map,
                load_model: load_model,
                _set_mode: _set_mode,
                view_mode: view_mode,
                build_mode: build_mode,
                brush_mode: brush_mode,
                zoom_mode: zoom_mode,
                rotate_mode: rotate_mode,
                text_mode: text_mode,
                set_reaction_data: set_reaction_data,
                set_metabolite_data: set_metabolite_data,
                set_gene_data: set_gene_data,
                _update_data: _update_data,
                _toggle_direction_buttons: _toggle_direction_buttons,
                _set_up_menu: _set_up_menu,
                _set_up_button_panel: _set_up_button_panel,
                _setup_status: _setup_status,
                _setup_quick_jump: _setup_quick_jump,
                _setup_modes: _setup_modes,
                _get_keys: _get_keys,
                _setup_confirm_before_exit: _setup_confirm_before_exit
            };
            module.exports = Builder;

            function init(map_data, model_data, embedded_css, selection, options) {
                if (!selection)
                    selection = d3.select('body').append('div');
                if (!options)
                    options = {};
                if (!embedded_css)
                    embedded_css = builder_embed;
                this.map_data = map_data;
                this.model_data = model_data;
                this.embedded_css = embedded_css;
                this.selection = selection;
                this.selection.datum(this)
                this.selection.__builder__ = this
                this.options = utils.set_options(options, {
                    menu: 'all',
                    scroll_behavior: 'pan',
                    use_3d_transform: !utils.check_browser('safari'),
                    enable_editing: true,
                    enable_keys: true,
                    enable_search: true,
                    fill_screen: false,
                    zoom_to_element: null,
                    full_screen_button: false,
                    ignore_bootstrap: false,
                    starting_reaction: null,
                    never_ask_before_quit: false,
                    unique_map_id: null,
                    primary_metabolite_radius: 20,
                    secondary_metabolite_radius: 10,
                    marker_radius: 5,
                    gene_font_size: 18,
                    hide_secondary_metabolites: false,
                    show_gene_reaction_rules: false,
                    hide_all_labels: false,
                    reaction_data: null,
                    reaction_styles: ['color', 'size', 'text'],
                    reaction_compare_style: 'log2_fold',
                    reaction_scale: [{
                        type: 'min',
                        color: '#c8c8c8',
                        size: 12
                    }, {
                        type: 'median',
                        color: '#9696ff',
                        size: 20
                    }, {
                        type: 'max',
                        color: '#ff0000',
                        size: 25
                    }],
                    reaction_no_data_color: '#dcdcdc',
                    reaction_no_data_size: 8,
                    gene_data: null,
                    and_method_in_gene_reaction_rule: 'mean',
                    metabolite_data: null,
                    metabolite_styles: ['color', 'size', 'text'],
                    metabolite_compare_style: 'log2_fold',
                    metabolite_scale: [{
                        type: 'min',
                        color: '#fffaf0',
                        size: 20
                    }, {
                        type: 'median',
                        color: '#f1c470',
                        size: 30
                    }, {
                        type: 'max',
                        color: '#800000',
                        size: 40
                    }],
                    metabolite_no_data_color: '#ffffff',
                    metabolite_no_data_size: 10,
                    identifiers_on_map: 'bigg_id',
                    highlight_missing: false,
                    allow_building_duplicate_reactions: false,
                    cofactors: ['atp', 'adp', 'nad', 'nadh', 'nadp', 'nadph', 'gtp', 'gdp', 'h', 'coa', 'ump', 'h20', 'ppi'],
                    first_load_callback: null
                }, {
                    primary_metabolite_radius: true,
                    secondary_metabolite_radius: true,
                    marker_radius: true,
                    gene_font_size: true,
                    reaction_no_data_size: true,
                    metabolite_no_data_size: true
                });
                if (utils.check_for_parent_tag(this.selection, 'svg')) {
                    throw new Error('Builder cannot be placed within an svg node ' + 'becuase UI elements are html-based.');
                }
                var set_option = function(option, new_value) {
                        this.options[option] = new_value;
                    }.bind(this),
                    get_option = function(option) {
                        return this.options[option];
                    }.bind(this),
                    conditional_options = ['hide_secondary_metabolites', 'show_gene_reaction_rules', 'hide_all_labels', 'scroll_behavior', 'reaction_styles', 'reaction_compare_style', 'reaction_scale', 'reaction_no_data_color', 'reaction_no_data_size', 'and_method_in_gene_reaction_rule', 'metabolite_styles', 'metabolite_compare_style', 'metabolite_scale', 'metabolite_no_data_color', 'metabolite_no_data_size', 'identifiers_on_map', 'highlight_missing', 'allow_building_duplicate_reactions', ];
                this.settings = new Settings(set_option, get_option, conditional_options);
                ['reaction_scale', 'metabolite_scale'].forEach(function(name) {
                    this.settings.streams[name].onValue(function(val) {
                        ['min', 'max'].forEach(function(type) {
                            var has = val.reduce(function(has_found, scale_el) {
                                return has_found || (scale_el.type == type);
                            }, false);
                            if (!has) {
                                val.push({
                                    type: type,
                                    color: '#ffffff',
                                    size: 10
                                });
                                this.settings.set_conditional(name, val);
                            }
                        }.bind(this));
                    }.bind(this));
                }.bind(this));
                this.callback_manager = CallbackManager();
                if (this.options.first_load_callback !== null)
                    this.callback_manager.set('first_load', this.options.first_load_callback);
                this.load_model(this.model_data, false)
                this.load_map(this.map_data, false)
                this._update_data(true, true)
                this.settings.status_bus.onValue(function(x) {
                    if (x === 'accepted') {
                        this._update_data(true, true, ['reaction', 'metabolite'], false)
                        if (this.zoom_container !== null) {
                            var new_behavior = this.settings.get_option('scroll_behavior')
                            this.zoom_container.set_scroll_behavior(new_behavior)
                        }
                        if (this.map !== null) {
                            this.map.draw_all_nodes(false)
                            this.map.draw_all_reactions(true, false)
                            this.map.select_none()
                        }
                    }
                }.bind(this))
                this.callback_manager.run('first_load', this)
            }

            function load_model(model_data, should_update_data) {
                if (should_update_data === undefined)
                    should_update_data = true;
                if (model_data === null)
                    this.cobra_model = null;
                else
                    this.cobra_model = CobraModel.from_cobra_json(model_data);
                if (this.map) {
                    this.map.cobra_model = this.cobra_model;
                    if (should_update_data)
                        this._update_data(true, false);
                    if (this.settings.get_option('highlight_missing'))
                        this.map.draw_all_reactions(false, false);
                }
                this.callback_manager.run('load_model', null, model_data, should_update_data);
            }

            function load_map(map_data, should_update_data) {
                if (_.isUndefined(should_update_data))
                    should_update_data = true
                var selectable_mousedown_enabled = true
                var shift_key_on = false
                utils.remove_child_nodes(this.selection)
                this.zoom_container = new ZoomContainer(this.selection, this.options.scroll_behavior, this.options.use_3d_transform, this.options.fill_screen)
                var zoomed_sel = this.zoom_container.zoomed_sel
                var svg = this.zoom_container.svg
                if (this.map)
                    this.map.key_manager.toggle(false)
                if (map_data !== null) {
                    this.map = Map.from_data(map_data, svg, this.embedded_css, zoomed_sel, this.zoom_container, this.settings, this.cobra_model, this.options.enable_search)
                } else {
                    this.map = new Map(svg, this.embedded_css, zoomed_sel, this.zoom_container, this.settings, this.cobra_model, null, this.options.enable_search)
                }
                this.zoom_container.callback_manager.set('svg_start', function() {
                    this.map.set_status('Drawing ...')
                }.bind(this))
                this.zoom_container.callback_manager.set('svg_finish', function() {
                    this.map.set_status('')
                }.bind(this))
                if (should_update_data)
                    this._update_data(false, true)
                this.build_input = new BuildInput(this.selection, this.map, this.zoom_container, this.settings)
                this.text_edit_input = new TextEditInput(this.selection, this.map, this.zoom_container)
                this.brush = new Brush(zoomed_sel, false, this.map, '.canvas-group')
                this.map.canvas.callback_manager.set('resize', function() {
                    this.brush.toggle(true)
                }.bind(this))
                this._setup_modes(this.map, this.brush, this.zoom_container)
                var s = this.selection.append('div').attr('class', 'search-menu-container').append('div').attr('class', 'search-menu-container-inline'),
                    menu_div = s.append('div'),
                    search_bar_div = s.append('div'),
                    button_div = this.selection.append('div')
                this.search_bar = new SearchBar(search_bar_div, this.map.search_index, this.map)
                this.search_bar.callback_manager.set('show', function() {
                    this.settings_bar.toggle(false)
                }.bind(this))
                var settings_div = this.selection.append('div')
                this.settings_bar = new SettingsMenu(settings_div, this.settings, this.map, function(type, on_off) {
                    var o = this.options[type + '_styles']
                    if (on_off && o.indexOf('abs') == -1)
                        o.push('abs')
                    else if (!on_off) {
                        var i = o.indexOf('abs')
                        if (i != -1)
                            this.options[type + '_styles'] = o.slice(0, i).concat(o.slice(i + 1))
                    }
                    this._update_data(false, true, type)
                }.bind(this))
                this.settings_bar.callback_manager.set('show', function() {
                    this.search_bar.toggle(false)
                }.bind(this))
                var keys = this._get_keys(this.map, this.zoom_container, this.search_bar, this.settings_bar, this.options.enable_editing, this.options.full_screen_button)
                this.map.key_manager.assigned_keys = keys
                this.map.key_manager.input_list = [this.build_input, this.search_bar, this.settings_bar, this.text_edit_input]
                this.map.key_manager.update()
                this.map.key_manager.toggle(this.options.enable_keys)
                if (this.options.menu === 'all') {
                    if (this.options.ignore_bootstrap)
                        console.error('Cannot create the dropdown menus if ignore_bootstrap = true')
                    else
                        this._set_up_menu(menu_div, this.map, this.map.key_manager, keys, this.options.enable_editing, this.options.enable_keys, this.options.full_screen_button)
                }
                this._set_up_button_panel(button_div, keys, this.options.enable_editing, this.options.enable_keys, this.options.full_screen_button, this.options.menu, this.options.ignore_bootstrap)
                if (this.options.zoom_to_element) {
                    var type = this.options.zoom_to_element.type,
                        element_id = this.options.zoom_to_element.id
                    if (typeof type === 'undefined' || ['reaction', 'node'].indexOf(type) == -1)
                        throw new Error('zoom_to_element type must be "reaction" or "node"')
                    if (typeof element_id === 'undefined')
                        throw new Error('zoom_to_element must include id')
                    if (type == 'reaction')
                        this.map.zoom_to_reaction(element_id)
                    else if (type == 'node')
                        this.map.zoom_to_node(element_id)
                } else if (map_data !== null) {
                    this.map.zoom_extent_canvas()
                } else {
                    if (this.options.starting_reaction !== null && this.cobra_model !== null) {
                        var size = this.zoom_container.get_size()
                        var start_coords = {
                            x: size.width / 2,
                            y: size.height / 4
                        }
                        this.map.new_reaction_from_scratch(this.options.starting_reaction, start_coords, 90)
                        this.map.zoom_extent_nodes()
                    } else {
                        this.map.zoom_extent_canvas()
                    }
                }
                var status = this._setup_status(this.selection, this.map)
                this._setup_quick_jump(this.selection)
                if (this.options.enable_editing)
                    this.zoom_mode()
                else
                    this.view_mode()
                if (this.options.enable_editing)
                    this._setup_confirm_before_exit()
                this.map.draw_everything()
            }

            function _set_mode(mode) {
                this.search_bar.toggle(false);
                this.build_input.toggle(mode == 'build');
                this.build_input.direction_arrow.toggle(mode == 'build');
                if (this.options.menu == 'all' && this.options.enable_editing)
                    this._toggle_direction_buttons(mode == 'build');
                this.brush.toggle(mode == 'brush');
                this.zoom_container.toggle_pan_drag(mode == 'zoom' || mode == 'view');
                this.map.canvas.toggle_resize(mode == 'zoom' || mode == 'brush');
                if (mode == 'rotate') {
                    this.map.behavior.toggle_selectable_drag(false);
                    this.map.behavior.toggle_rotation_mode(true);
                } else {
                    this.map.behavior.toggle_rotation_mode(mode == 'rotate');
                    this.map.behavior.toggle_selectable_drag(mode == 'brush');
                }
                this.map.behavior.toggle_selectable_click(mode == 'build' || mode == 'brush');
                this.map.behavior.toggle_label_drag(mode == 'brush');
                this.map.behavior.toggle_label_mousedown(mode == 'brush');
                this.map.behavior.toggle_text_label_edit(mode == 'text');
                this.map.behavior.toggle_bezier_drag(mode == 'brush');
                if (mode == 'view' || mode == 'text')
                    this.map.select_none();
                if (mode == 'rotate')
                    this.map.deselect_text_labels();
                this.map.draw_everything();
            }

            function view_mode() {
                this.callback_manager.run('view_mode');
                this._set_mode('view');
            }

            function build_mode() {
                this.callback_manager.run('build_mode');
                this._set_mode('build');
            }

            function brush_mode() {
                this.callback_manager.run('brush_mode');
                this._set_mode('brush');
            }

            function zoom_mode() {
                this.callback_manager.run('zoom_mode');
                this._set_mode('zoom');
            }

            function rotate_mode() {
                this.callback_manager.run('rotate_mode');
                this._set_mode('rotate');
            }

            function text_mode() {
                this.callback_manager.run('text_mode');
                this._set_mode('text');
            }

            function set_reaction_data(data) {
                this.options.reaction_data = data;
                this._update_data(true, true, 'reaction');
                this.map.set_status('');
            }

            function set_gene_data(data, clear_gene_reaction_rules) {
                if (clear_gene_reaction_rules)
                    this.settings.set_conditional('show_gene_reaction_rules', false);
                this.options.gene_data = data;
                this._update_data(true, true, 'reaction');
                this.map.set_status('');
            }

            function set_metabolite_data(data) {
                this.options.metabolite_data = data;
                this._update_data(true, true, 'metabolite');
                this.map.set_status('');
            }

            function _update_data(update_model, update_map, kind, should_draw) {
                if (kind === undefined)
                    kind = ['reaction', 'metabolite'];
                if (should_draw === undefined)
                    should_draw = true;
                var update_metabolite_data = (kind.indexOf('metabolite') != -1),
                    update_reaction_data = (kind.indexOf('reaction') != -1),
                    met_data_object, reaction_data_object, gene_data_object;
                if (update_metabolite_data && update_map && this.map !== null) {
                    met_data_object = data_styles.import_and_check(this.options.metabolite_data, 'metabolite_data');
                    this.map.apply_metabolite_data_to_map(met_data_object);
                    if (should_draw)
                        this.map.draw_all_nodes(false);
                }
                if (update_reaction_data) {
                    if (this.options.reaction_data !== null && update_map && this.map !== null) {
                        reaction_data_object = data_styles.import_and_check(this.options.reaction_data, 'reaction_data');
                        this.map.apply_reaction_data_to_map(reaction_data_object);
                        if (should_draw)
                            this.map.draw_all_reactions(false, false);
                    } else if (this.options.gene_data !== null && update_map && this.map !== null) {
                        gene_data_object = make_gene_data_object(this.options.gene_data, this.cobra_model, this.map);
                        this.map.apply_gene_data_to_map(gene_data_object);
                        if (should_draw)
                            this.map.draw_all_reactions(false, false);
                    } else if (update_map && this.map !== null) {
                        this.map.apply_reaction_data_to_map(null);
                        if (should_draw)
                            this.map.draw_all_reactions(false, false);
                    }
                }
                if (this.update_model_timer)
                    clearTimeout(this.update_model_timer);
                var delay = 5;
                this.update_model_timer = setTimeout(function() {
                    if (update_metabolite_data && update_model && this.cobra_model !== null) {
                        if (!met_data_object)
                            met_data_object = data_styles.import_and_check(this.options.metabolite_data, 'metabolite_data');
                        this.cobra_model.apply_metabolite_data(met_data_object, this.options.metabolite_styles, this.options.metabolite_compare_style);
                    }
                    if (update_reaction_data) {
                        if (this.options.reaction_data !== null && update_model && this.cobra_model !== null) {
                            if (!reaction_data_object)
                                reaction_data_object = data_styles.import_and_check(this.options.reaction_data, 'reaction_data');
                            this.cobra_model.apply_reaction_data(reaction_data_object, this.options.reaction_styles, this.options.reaction_compare_style);
                        } else if (this.options.gene_data !== null && update_model && this.cobra_model !== null) {
                            if (!gene_data_object)
                                gene_data_object = make_gene_data_object(this.options.gene_data, this.cobra_model, this.map);
                            this.cobra_model.apply_gene_data(gene_data_object, this.options.reaction_styles, this.options.identifiers_on_map, this.options.reaction_compare_style, this.options.and_method_in_gene_reaction_rule);
                        } else if (update_model && this.cobra_model !== null) {
                            this.cobra_model.apply_reaction_data(null, this.options.reaction_styles, this.options.reaction_compare_style);
                        }
                    }
                    this.callback_manager.run('update_data', null, update_model, update_map, kind, should_draw);
                }.bind(this), delay);

                function make_gene_data_object(gene_data, cobra_model, map) {
                    var all_reactions = {};
                    if (cobra_model !== null)
                        utils.extend(all_reactions, cobra_model.reactions);
                    if (map !== null)
                        utils.extend(all_reactions, map.reactions, true);
                    return data_styles.import_and_check(gene_data, 'gene_data', all_reactions);
                }
            }

            function _set_up_menu(menu_selection, map, key_manager, keys, enable_editing, enable_keys, full_screen_button, ignore_bootstrap) {
                var menu = menu_selection.attr('id', 'menu').append('ul').attr('class', 'nav nav-pills')
                ui.dropdown_menu(menu, 'Map').button({
                    key: keys.save,
                    text: 'Save map JSON',
                    key_text: (enable_keys ? ' (Ctrl+S)' : null)
                }).button({
                    text: 'Load map JSON',
                    key_text: (enable_keys ? ' (Ctrl+O)' : null),
                    input: {
                        assign: key_manager.assigned_keys.load,
                        key: 'fn',
                        fn: load_map_for_file.bind(this),
                        pre_fn: function() {
                            map.set_status('Loading map ...')
                        },
                        failure_fn: function() {
                            map.set_status('')
                        }
                    }
                }).button({
                    key: keys.save_svg,
                    text: 'Export as SVG',
                    key_text: (enable_keys ? ' (Ctrl+Shift+S)' : null)
                }).button({
                    key: keys.save_png,
                    text: 'Export as PNG',
                    key_text: (enable_keys ? ' (Ctrl+Shift+P)' : null)
                }).button({
                    key: keys.clear_map,
                    text: 'Clear map'
                })
                var model_menu = ui.dropdown_menu(menu, 'Model').button({
                    text: 'Load COBRA model JSON',
                    key_text: (enable_keys ? ' (Ctrl+M)' : null),
                    input: {
                        assign: key_manager.assigned_keys.load_model,
                        key: 'fn',
                        fn: load_model_for_file.bind(this),
                        pre_fn: function() {
                            map.set_status('Loading model ...')
                        },
                        failure_fn: function() {
                            map.set_status('')
                        }
                    }
                }).button({
                    id: 'convert_map',
                    key: keys.convert_map,
                    text: 'Update names and gene reaction rules using model'
                }).button({
                    id: 'clear_model',
                    key: keys.clear_model,
                    text: 'Clear model'
                })
                var disable_model_clear_convert = function() {
                    model_menu.dropdown.selectAll('li').classed('escher-disabled', function(d) {
                        if ((d.id == 'clear_model' || d.id == 'convert_map') && this.cobra_model === null)
                            return true
                        return null
                    }.bind(this))
                }.bind(this)
                disable_model_clear_convert()
                this.callback_manager.set('load_model', disable_model_clear_convert)
                var data_menu = ui.dropdown_menu(menu, 'Data').button({
                    input: {
                        assign: key_manager.assigned_keys.load_reaction_data,
                        key: 'fn',
                        fn: load_reaction_data_for_file.bind(this),
                        accept_csv: true,
                        pre_fn: function() {
                            map.set_status('Loading reaction data ...')
                        },
                        failure_fn: function() {
                            map.set_status('')
                        }
                    },
                    text: 'Load reaction data'
                }).button({
                    key: keys.clear_reaction_data,
                    text: 'Clear reaction data'
                }).divider().button({
                    input: {
                        fn: load_gene_data_for_file.bind(this),
                        accept_csv: true,
                        pre_fn: function() {
                            map.set_status('Loading gene data ...')
                        },
                        failure_fn: function() {
                            map.set_status('')
                        }
                    },
                    text: 'Load gene data'
                }).button({
                    key: keys.clear_gene_data,
                    text: 'Clear gene data'
                }).divider().button({
                    input: {
                        fn: load_metabolite_data_for_file.bind(this),
                        accept_csv: true,
                        pre_fn: function() {
                            map.set_status('Loading metabolite data ...')
                        },
                        failure_fn: function() {
                            map.set_status('')
                        }
                    },
                    text: 'Load metabolite data'
                }).button({
                    key: keys.clear_metabolite_data,
                    text: 'Clear metabolite data'
                })
                var disable_clears = function() {
                    data_menu.dropdown.selectAll('li').classed('escher-disabled', function(d) {
                        if (!d) return null
                        if (d.text == 'Clear reaction data' && this.options.reaction_data === null)
                            return true
                        if (d.text == 'Clear gene data' && this.options.gene_data === null)
                            return true
                        if (d.text == 'Clear metabolite data' && this.options.metabolite_data === null)
                            return true
                        return null
                    }.bind(this))
                }.bind(this)
                disable_clears()
                this.callback_manager.set('update_data', disable_clears)
                var edit_menu = ui.dropdown_menu(menu, 'Edit', true)
                if (enable_editing) {
                    edit_menu.button({
                        key: keys.zoom_mode,
                        id: 'zoom-mode-menu-button',
                        text: 'Pan mode',
                        key_text: (enable_keys ? ' (Z)' : null)
                    }).button({
                        key: keys.brush_mode,
                        id: 'brush-mode-menu-button',
                        text: 'Select mode',
                        key_text: (enable_keys ? ' (V)' : null)
                    }).button({
                        key: keys.build_mode,
                        id: 'build-mode-menu-button',
                        text: 'Add reaction mode',
                        key_text: (enable_keys ? ' (N)' : null)
                    }).button({
                        key: keys.rotate_mode,
                        id: 'rotate-mode-menu-button',
                        text: 'Rotate mode',
                        key_text: (enable_keys ? ' (R)' : null)
                    }).button({
                        key: keys.text_mode,
                        id: 'text-mode-menu-button',
                        text: 'Text mode',
                        key_text: (enable_keys ? ' (T)' : null)
                    }).divider().button({
                        key: keys.delete,
                        text: 'Delete',
                        key_text: (enable_keys ? ' (Del)' : null)
                    }).button({
                        key: keys.undo,
                        text: 'Undo',
                        key_text: (enable_keys ? ' (Ctrl+Z)' : null)
                    }).button({
                        key: keys.redo,
                        text: 'Redo',
                        key_text: (enable_keys ? ' (Ctrl+Shift+Z)' : null)
                    }).button({
                        key: keys.toggle_primary,
                        text: 'Toggle primary/secondary',
                        key_text: (enable_keys ? ' (P)' : null)
                    }).button({
                        key: keys.cycle_primary,
                        text: 'Rotate reactant locations',
                        key_text: (enable_keys ? ' (C)' : null)
                    }).button({
                        key: keys.select_all,
                        text: 'Select all',
                        key_text: (enable_keys ? ' (Ctrl+A)' : null)
                    }).button({
                        key: keys.select_none,
                        text: 'Select none',
                        key_text: (enable_keys ? ' (Ctrl+Shift+A)' : null)
                    }).button({
                        key: keys.invert_selection,
                        text: 'Invert selection'
                    })
                } else {
                    edit_menu.button({
                        key: keys.view_mode,
                        id: 'view-mode-menu-button',
                        text: 'View mode'
                    })
                }
                var view_menu = ui.dropdown_menu(menu, 'View', true).button({
                    key: keys.zoom_in,
                    text: 'Zoom in',
                    key_text: (enable_keys ? ' (Ctrl and +)' : null)
                }).button({
                    key: keys.zoom_out,
                    text: 'Zoom out',
                    key_text: (enable_keys ? ' (Ctrl and -)' : null)
                }).button({
                    key: keys.extent_nodes,
                    text: 'Zoom to nodes',
                    key_text: (enable_keys ? ' (Ctrl+0)' : null)
                }).button({
                    key: keys.extent_canvas,
                    text: 'Zoom to canvas',
                    key_text: (enable_keys ? ' (Ctrl+1)' : null)
                }).button({
                    key: keys.search,
                    text: 'Find',
                    key_text: (enable_keys ? ' (Ctrl+F)' : null)
                })
                if (full_screen_button) {
                    view_menu.button({
                        key: keys.full_screen,
                        text: 'Full screen',
                        key_text: (enable_keys ? ' (Ctrl+2)' : null)
                    })
                }
                if (enable_editing) {
                    view_menu.button({
                        key: keys.toggle_beziers,
                        id: 'bezier-button',
                        text: 'Show control points',
                        key_text: (enable_keys ? ' (B)' : null)
                    })
                    map.callback_manager.set('toggle_beziers.button', function(on_off) {
                        menu.select('#bezier-button').select('.dropdown-button-text').text((on_off ? 'Hide' : 'Show') + ' control points' +
                            (enable_keys ? ' (B)' : ''))
                    })
                }
                view_menu.divider().button({
                    key: keys.show_settings,
                    text: 'Settings',
                    key_text: (enable_keys ? ' (Ctrl+,)' : null)
                })
                menu.append('a').attr('class', 'help-button').attr('target', '#').attr('href', 'https://escher.readthedocs.org').text('?')
                var select_button = function(id) {
                    $(this.selection.node()).find('#' + id).button('toggle')
                    var ids = ['zoom-mode-menu-button', 'brush-mode-menu-button', 'build-mode-menu-button', 'rotate-mode-menu-button', 'view-mode-menu-button', 'text-mode-menu-button']
                    ids.forEach(function(this_id) {
                        var b_id = this_id.replace('-menu', '')
                        this.selection.select('#' + this_id).select('span').classed('glyphicon', b_id == id).classed('glyphicon-ok', b_id == id)
                    }.bind(this))
                }
                this.callback_manager.set('zoom_mode', select_button.bind(this, 'zoom-mode-button'))
                this.callback_manager.set('brush_mode', select_button.bind(this, 'brush-mode-button'))
                this.callback_manager.set('build_mode', select_button.bind(this, 'build-mode-button'))
                this.callback_manager.set('rotate_mode', select_button.bind(this, 'rotate-mode-button'))
                this.callback_manager.set('view_mode', select_button.bind(this, 'view-mode-button'))
                this.callback_manager.set('text_mode', select_button.bind(this, 'text-mode-button'))

                function load_map_for_file(error, map_data) {
                    if (error) {
                        console.warn(error)
                        this.map.set_status('Error loading map: ' + error, 2000)
                        return
                    }
                    try {
                        check_map(map_data)
                        this.load_map(map_data)
                        this.map.set_status('Loaded map ' + map_data[0].map_name, 3000)
                    } catch (e) {
                        console.warn(e)
                        this.map.set_status('Error loading map: ' + e, 2000)
                    }

                    function check_map(data) {
                        if (!('map_id' in data[0] && 'reactions' in data[1] && 'nodes' in data[1] && 'canvas' in data[1]))
                            throw new Error('Bad map data.')
                    }
                }

                function load_model_for_file(error, data) {
                    if (error) {
                        console.warn(error)
                        this.map.set_status('Error loading model: ' + error, 2000)
                        return
                    }
                    try {
                        this.load_model(data, true)
                        this.build_input.toggle(false)
                        if ('id' in data)
                            this.map.set_status('Loaded model ' + data.id, 3000)
                        else
                            this.map.set_status('Loaded model (no model id)', 3000)
                    } catch (e) {
                        console.warn(e)
                        this.map.set_status('Error loading model: ' + e, 2000)
                    }
                }

                function load_reaction_data_for_file(error, data) {
                    if (error) {
                        console.warn(error)
                        this.map.set_status('Could not parse file as JSON or CSV', 2000)
                        return
                    }
                    if (data !== null)
                        this.set_gene_data(null)
                    this.set_reaction_data(data)
                }

                function load_metabolite_data_for_file(error, data) {
                    if (error) {
                        console.warn(error)
                        this.map.set_status('Could not parse file as JSON or CSV', 2000)
                        return
                    }
                    this.set_metabolite_data(data)
                }

                function load_gene_data_for_file(error, data) {
                    if (error) {
                        console.warn(error)
                        this.map.set_status('Could not parse file as JSON or CSV', 2000)
                        return
                    }
                    if (data !== null)
                        this.set_reaction_data(null)
                    this.settings.set_conditional('show_gene_reaction_rules', true)
                    this.set_gene_data(data)
                }
            }

            function _set_up_button_panel(button_selection, keys, enable_editing, enable_keys, full_screen_button, menu_option, ignore_bootstrap) {
                var button_panel = button_selection.append('ul').attr('class', 'nav nav-pills nav-stacked').attr('id', 'button-panel')
                ui.individual_button(button_panel.append('li'), {
                    key: keys.zoom_in,
                    text: '+',
                    icon: 'glyphicon glyphicon-plus-sign',
                    tooltip: 'Zoom in',
                    key_text: (enable_keys ? ' (Ctrl and +)' : null),
                    ignore_bootstrap: ignore_bootstrap
                })
                ui.individual_button(button_panel.append('li'), {
                    key: keys.zoom_out,
                    text: '',
                    icon: 'glyphicon glyphicon-minus-sign',
                    tooltip: 'Zoom out',
                    key_text: (enable_keys ? ' (Ctrl and -)' : null),
                    ignore_bootstrap: ignore_bootstrap
                })
                ui.individual_button(button_panel.append('li'), {
                    key: keys.extent_canvas,
                    text: '',
                    icon: 'glyphicon glyphicon-resize-full',
                    tooltip: 'Zoom to canvas',
                    key_text: (enable_keys ? ' (Ctrl+1)' : null),
                    ignore_bootstrap: ignore_bootstrap
                })
                if (full_screen_button) {
                    ui.individual_button(button_panel.append('li'), {
                        key: keys.full_screen,
                        text: '',
                        icon: 'glyphicon glyphicon-fullscreen',
                        tooltip: 'Full screen',
                        key_text: (enable_keys ? ' (Ctrl+2)' : null),
                        ignore_bootstrap: ignore_bootstrap
                    })
                }
                if (enable_editing && menu_option === 'all') {
                    ui.radio_button_group(button_panel.append('li')).button({
                        key: keys.zoom_mode,
                        id: 'zoom-mode-button',
                        text: 'Z',
                        icon: 'glyphicon glyphicon-move',
                        tooltip: 'Pan mode',
                        key_text: (enable_keys ? ' (Z)' : null),
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.brush_mode,
                        text: 'V',
                        id: 'brush-mode-button',
                        icon: 'glyphicon glyphicon-hand-up',
                        tooltip: 'Select mode',
                        key_text: (enable_keys ? ' (V)' : null),
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.build_mode,
                        text: 'N',
                        id: 'build-mode-button',
                        icon: 'glyphicon glyphicon-plus',
                        tooltip: 'Add reaction mode',
                        key_text: (enable_keys ? ' (N)' : null),
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.rotate_mode,
                        text: 'R',
                        id: 'rotate-mode-button',
                        icon: 'glyphicon glyphicon-repeat',
                        tooltip: 'Rotate mode',
                        key_text: (enable_keys ? ' (R)' : null),
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.text_mode,
                        text: 'T',
                        id: 'text-mode-button',
                        icon: 'glyphicon glyphicon-font',
                        tooltip: 'Text mode',
                        key_text: (enable_keys ? ' (T)' : null),
                        ignore_bootstrap: ignore_bootstrap
                    })
                    this.direction_buttons = button_panel.append('li')
                    var o = ui.button_group(this.direction_buttons).button({
                        key: keys.direction_arrow_left,
                        text: '',
                        icon: 'glyphicon glyphicon-arrow-left',
                        tooltip: 'Direction arrow ()',
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.direction_arrow_right,
                        text: '',
                        icon: 'glyphicon glyphicon-arrow-right',
                        tooltip: 'Direction arrow ()',
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.direction_arrow_up,
                        text: '',
                        icon: 'glyphicon glyphicon-arrow-up',
                        tooltip: 'Direction arrow ()',
                        ignore_bootstrap: ignore_bootstrap
                    }).button({
                        key: keys.direction_arrow_down,
                        text: '',
                        icon: 'glyphicon glyphicon-arrow-down',
                        tooltip: 'Direction arrow ()',
                        ignore_bootstrap: ignore_bootstrap
                    })
                }
            }

            function _toggle_direction_buttons(on_off) {
                if (_.isUndefined(on_off))
                    on_off = !this.direction_buttons.style('display') === 'block'
                this.direction_buttons.style('display', on_off ? 'block' : 'none')
            }

            function _setup_status(selection, map) {
                var status_bar = selection.append('div').attr('id', 'status');
                map.callback_manager.set('set_status', function(status) {
                    status_bar.html(status);
                });
                return status_bar;
            }

            function _setup_quick_jump(selection) {
                var load_fn = function(new_map_name, quick_jump_path, callback) {
                    if (this.options.enable_editing && !this.options.never_ask_before_quit) {
                        if (!(confirm(('You will lose any unsaved changes.\n\n' + 'Are you sure you want to switch maps?')))) {
                            if (callback) callback(false)
                            return
                        }
                    }
                    this.map.set_status('Loading map ' + new_map_name + ' ...');
                    var url = utils.name_to_url(new_map_name, quick_jump_path);
                    d3.json(url, function(error, data) {
                        if (error) {
                            console.warn('Could not load data: ' + error)
                            this.map.set_status('Could not load map', 2000)
                            if (callback) callback(false)
                            return
                        }
                        if (callback) callback(true)
                        this.load_map(data)
                        this.map.set_status('')
                    }.bind(this))
                }.bind(this)
                this.quick_jump = QuickJump(selection, load_fn)
            }

            function _setup_modes(map, brush, zoom_container) {
                var was_enabled = {};
                map.callback_manager.set('start_rotation', function() {
                    was_enabled.brush = brush.enabled;
                    brush.toggle(false);
                    was_enabled.zoom = zoom_container.zoom_on;
                    zoom_container.toggle_pan_drag(false);
                    was_enabled.selectable_mousedown = map.behavior.selectable_mousedown != null;
                    map.behavior.toggle_selectable_click(false);
                    was_enabled.label_mousedown = map.behavior.label_mousedown != null;
                    map.behavior.toggle_label_mousedown(false);
                });
                map.callback_manager.set('end_rotation', function() {
                    brush.toggle(was_enabled.brush);
                    zoom_container.toggle_pan_drag(was_enabled.zoom);
                    map.behavior.toggle_selectable_click(was_enabled.selectable_mousedown);
                    map.behavior.toggle_label_mousedown(was_enabled.label_mousedown);
                    was_enabled = {};
                });
            }

            function _get_keys(map, zoom_container, search_bar, settings_bar, enable_editing, full_screen_button) {
                var keys = {
                    save: {
                        key: 'ctrl+s',
                        target: map,
                        fn: map.save
                    },
                    save_svg: {
                        key: 'ctrl+shift+s',
                        target: map,
                        fn: map.save_svg
                    },
                    save_png: {
                        key: 'ctrl+shift+p',
                        target: map,
                        fn: map.save_png
                    },
                    load: {
                        key: 'ctrl+o',
                        fn: null
                    },
                    convert_map: {
                        target: map,
                        fn: map.convert_map
                    },
                    clear_map: {
                        target: map,
                        fn: map.clear_map
                    },
                    load_model: {
                        key: 'ctrl+m',
                        fn: null
                    },
                    clear_model: {
                        fn: this.load_model.bind(this, null, true)
                    },
                    load_reaction_data: {
                        fn: null
                    },
                    clear_reaction_data: {
                        target: this,
                        fn: function() {
                            this.set_reaction_data(null);
                        }
                    },
                    load_metabolite_data: {
                        fn: null
                    },
                    clear_metabolite_data: {
                        target: this,
                        fn: function() {
                            this.set_metabolite_data(null);
                        }
                    },
                    load_gene_data: {
                        fn: null
                    },
                    clear_gene_data: {
                        target: this,
                        fn: function() {
                            this.set_gene_data(null, true);
                        }
                    },
                    zoom_in: {
                        key: 'ctrl+=',
                        target: zoom_container,
                        fn: zoom_container.zoom_in
                    },
                    zoom_out: {
                        key: 'ctrl+-',
                        target: zoom_container,
                        fn: zoom_container.zoom_out
                    },
                    extent_nodes: {
                        key: 'ctrl+0',
                        target: map,
                        fn: map.zoom_extent_nodes
                    },
                    extent_canvas: {
                        key: 'ctrl+1',
                        target: map,
                        fn: map.zoom_extent_canvas
                    },
                    search: {
                        key: 'ctrl+f',
                        fn: search_bar.toggle.bind(search_bar, true)
                    },
                    view_mode: {
                        target: this,
                        fn: this.view_mode,
                        ignore_with_input: true
                    },
                    show_settings: {
                        key: 'ctrl+,',
                        target: settings_bar,
                        fn: settings_bar.toggle
                    }
                };
                if (full_screen_button) {
                    utils.extend(keys, {
                        full_screen: {
                            key: 'ctrl+2',
                            target: map,
                            fn: map.full_screen
                        }
                    })
                }
                if (enable_editing) {
                    utils.extend(keys, {
                        build_mode: {
                            key: 'n',
                            target: this,
                            fn: this.build_mode,
                            ignore_with_input: true
                        },
                        zoom_mode: {
                            key: 'z',
                            target: this,
                            fn: this.zoom_mode,
                            ignore_with_input: true
                        },
                        brush_mode: {
                            key: 'v',
                            target: this,
                            fn: this.brush_mode,
                            ignore_with_input: true
                        },
                        rotate_mode: {
                            key: 'r',
                            target: this,
                            fn: this.rotate_mode,
                            ignore_with_input: true
                        },
                        text_mode: {
                            key: 't',
                            target: this,
                            fn: this.text_mode,
                            ignore_with_input: true
                        },
                        toggle_beziers: {
                            key: 'b',
                            target: map,
                            fn: map.toggle_beziers,
                            ignore_with_input: true
                        },
                        delete: {
                            key: 'ctrl+backspace',
                            target: map,
                            fn: map.delete_selected,
                            ignore_with_input: true
                        },
                        delete_del: {
                            key: 'del',
                            target: map,
                            fn: map.delete_selected,
                            ignore_with_input: true
                        },
                        toggle_primary: {
                            key: 'p',
                            target: map,
                            fn: map.toggle_selected_node_primary,
                            ignore_with_input: true
                        },
                        cycle_primary: {
                            key: 'c',
                            target: map,
                            fn: map.cycle_primary_node,
                            ignore_with_input: true
                        },
                        direction_arrow_right: {
                            key: 'right',
                            target: this.build_input.direction_arrow,
                            fn: this.build_input.direction_arrow.right,
                            ignore_with_input: true
                        },
                        direction_arrow_down: {
                            key: 'down',
                            target: this.build_input.direction_arrow,
                            fn: this.build_input.direction_arrow.down,
                            ignore_with_input: true
                        },
                        direction_arrow_left: {
                            key: 'left',
                            target: this.build_input.direction_arrow,
                            fn: this.build_input.direction_arrow.left,
                            ignore_with_input: true
                        },
                        direction_arrow_up: {
                            key: 'up',
                            target: this.build_input.direction_arrow,
                            fn: this.build_input.direction_arrow.up,
                            ignore_with_input: true
                        },
                        undo: {
                            key: 'ctrl+z',
                            target: map.undo_stack,
                            fn: map.undo_stack.undo
                        },
                        redo: {
                            key: 'ctrl+shift+z',
                            target: map.undo_stack,
                            fn: map.undo_stack.redo
                        },
                        select_all: {
                            key: 'ctrl+a',
                            target: map,
                            fn: map.select_all
                        },
                        select_none: {
                            key: 'ctrl+shift+a',
                            target: map,
                            fn: map.select_none
                        },
                        invert_selection: {
                            target: map,
                            fn: map.invert_selection
                        }
                    });
                }
                return keys;
            }

            function _setup_confirm_before_exit() {
                window.onbeforeunload = function(e) {
                    e = e || window.event;
                    return (this.options.never_ask_before_quit ? null : 'You will lose any unsaved changes.');
                }.bind(this);
            }
        }, {
            "./Brush": 2,
            "./BuildInput": 3,
            "./CallbackManager": 5,
            "./CobraModel": 7,
            "./Map": 12,
            "./QuickJump": 14,
            "./SearchBar": 17,
            "./Settings": 19,
            "./SettingsMenu": 20,
            "./TextEditInput": 21,
            "./ZoomContainer": 23,
            "./data_styles": 26,
            "./inline": 27,
            "./ui": 30,
            "./utils": 31,
            "underscore": 35
        }],
        5: [function(require, module, exports) {
            var utils = require('./utils');
            var _ = require('underscore');
            var CallbackManager = utils.make_class();
            CallbackManager.prototype = {
                init: init,
                set: set,
                remove: remove,
                run: run
            };
            module.exports = CallbackManager;

            function init() {}

            function set(name, fn) {
                if (this.callbacks === undefined) this.callbacks = {};
                if (this.callbacks[name] === undefined) this.callbacks[name] = [];
                this.callbacks[name].push(fn);
                return this;
            }

            function remove(name) {
                if (this.callbacks === undefined || Object.keys(this.callbacks).length == 0) {
                    console.warn('No callbacks to remove');
                }
                delete this.callbacks[name];
                return this;
            }

            function run(name, this_arg) {
                if (_.isUndefined(this.callbacks)) return this;
                if (_.isUndefined(this_arg)) this_arg = null;
                var pass_args = Array.prototype.slice.call(arguments, 2);
                for (var a_name in this.callbacks) {
                    var split_name = a_name.split('.')[0];
                    if (split_name == name) {
                        this.callbacks[a_name].forEach(function(fn) {
                            fn.apply(this_arg, pass_args);
                        });
                    }
                }
                return this;
            }
        }, {
            "./utils": 31,
            "underscore": 35
        }],
        6: [function(require, module, exports) {
            var utils = require('./utils');
            var CallbackManager = require('./CallbackManager');
            var Canvas = utils.make_class();
            Canvas.prototype = {
                init: init,
                toggle_resize: toggle_resize,
                setup: setup,
                size_and_location: size_and_location
            };
            module.exports = Canvas;

            function init(selection, size_and_location) {
                this.selection = selection;
                this.x = size_and_location.x;
                this.y = size_and_location.y;
                this.width = size_and_location.width;
                this.height = size_and_location.height;
                this.resize_enabled = true;
                this.callback_manager = new CallbackManager();
                this.setup();
            }

            function toggle_resize(on_off) {
                if (on_off === undefined) on_off = !this.resize_enabled;
                if (on_off) {
                    this.selection.selectAll('.drag-rect').style('pointer-events', 'auto');
                } else {
                    this.selection.selectAll('.drag-rect').style('pointer-events', 'none');
                }
            }

            function setup() {
                var self = this,
                    extent = {
                        "x": this.width,
                        "y": this.height
                    },
                    dragbar_width = 100,
                    mouse_node_mult = 10,
                    new_sel = this.selection.append('g').classed('canvas-group', true).data([{
                        x: this.x,
                        y: this.y
                    }]);
                var mouse_node = new_sel.append('rect').attr('id', 'mouse-node').attr("width", this.width * mouse_node_mult).attr("height", this.height * mouse_node_mult).attr("transform", "translate(" + [self.x - this.width * mouse_node_mult / 2, self.y - this.height * mouse_node_mult / 2] + ")").attr('pointer-events', 'all');
                this.mouse_node = mouse_node;
                var rect = new_sel.append('rect').attr('id', 'canvas').attr("width", this.width).attr("height", this.height).attr("transform", "translate(" + [self.x, self.y] + ")");
                var drag_right = d3.behavior.drag().origin(Object).on("dragstart", stop_propagation).on("drag", rdragresize),
                    drag_left = d3.behavior.drag().origin(Object).on("dragstart", stop_propagation).on("drag", ldragresize),
                    drag_top = d3.behavior.drag().origin(Object).on("dragstart", stop_propagation).on("drag", tdragresize),
                    drag_bottom = d3.behavior.drag().origin(Object).on("dragstart", stop_propagation).on("drag", bdragresize);
                var left = new_sel.append("rect").classed('drag-rect', true).attr('transform', function(d) {
                    return 'translate(' + [d.x - (dragbar_width / 2), d.y + (dragbar_width / 2)] + ')';
                }).attr("height", this.height - dragbar_width).attr("id", "dragleft").attr("width", dragbar_width).attr("cursor", "ew-resize").classed('resize-rect', true).call(drag_left);
                var right = new_sel.append("rect").classed('drag-rect', true).attr('transform', function(d) {
                    return 'translate(' + [d.x + self.width - (dragbar_width / 2), d.y + (dragbar_width / 2)] + ')';
                }).attr("id", "dragright").attr("height", this.height - dragbar_width).attr("width", dragbar_width).attr("cursor", "ew-resize").classed('resize-rect', true).call(drag_right);
                var top = new_sel.append("rect").classed('drag-rect', true).attr('transform', function(d) {
                    return 'translate(' + [d.x + (dragbar_width / 2), d.y - (dragbar_width / 2)] + ')';
                }).attr("height", dragbar_width).attr("id", "dragtop").attr("width", this.width - dragbar_width).attr("cursor", "ns-resize").classed('resize-rect', true).call(drag_top);
                var bottom = new_sel.append("rect").classed('drag-rect', true).attr('transform', function(d) {
                    return 'translate(' + [d.x + (dragbar_width / 2), d.y + self.height - (dragbar_width / 2)] + ')';
                }).attr("id", "dragbottom").attr("height", dragbar_width).attr("width", this.width - dragbar_width).attr("cursor", "ns-resize").classed('resize-rect', true).call(drag_bottom);

                function stop_propagation() {
                    d3.event.sourceEvent.stopPropagation();
                }

                function transform_string(x, y, current_transform) {
                    var tr = utils.d3_transform_catch(current_transform),
                        translate = tr.translate;
                    if (x !== null) translate[0] = x;
                    if (y !== null) translate[1] = y;
                    return 'translate(' + translate + ')';
                }

                function ldragresize(d) {
                    var oldx = d.x;
                    d.x = Math.min(d.x + self.width - (dragbar_width / 2), d3.event.x);
                    self.x = d.x;
                    self.width = self.width + (oldx - d.x);
                    left.attr("transform", function(d) {
                        return transform_string(d.x - (dragbar_width / 2), null, left.attr('transform'));
                    });
                    mouse_node.attr("transform", function(d) {
                        return transform_string(d.x, null, mouse_node.attr('transform'));
                    }).attr("width", self.width * mouse_node_mult);
                    rect.attr("transform", function(d) {
                        return transform_string(d.x, null, rect.attr('transform'));
                    }).attr("width", self.width);
                    top.attr("transform", function(d) {
                        return transform_string(d.x + (dragbar_width / 2), null, top.attr('transform'));
                    }).attr("width", self.width - dragbar_width);
                    bottom.attr("transform", function(d) {
                        return transform_string(d.x + (dragbar_width / 2), null, bottom.attr('transform'));
                    }).attr("width", self.width - dragbar_width);
                    self.callback_manager.run('resize');
                }

                function rdragresize(d) {
                    d3.event.sourceEvent.stopPropagation();
                    var dragx = Math.max(d.x + (dragbar_width / 2), d.x + self.width + d3.event.dx);
                    self.width = dragx - d.x;
                    right.attr("transform", function(d) {
                        return transform_string(dragx - (dragbar_width / 2), null, right.attr('transform'));
                    });
                    mouse_node.attr("width", self.width * mouse_node_mult);
                    rect.attr("width", self.width);
                    top.attr("width", self.width - dragbar_width);
                    bottom.attr("width", self.width - dragbar_width);
                    self.callback_manager.run('resize');
                }

                function tdragresize(d) {
                    d3.event.sourceEvent.stopPropagation();
                    var oldy = d.y;
                    d.y = Math.min(d.y + self.height - (dragbar_width / 2), d3.event.y);
                    self.y = d.y;
                    self.height = self.height + (oldy - d.y);
                    top.attr("transform", function(d) {
                        return transform_string(null, d.y - (dragbar_width / 2), top.attr('transform'));
                    });
                    mouse_node.attr("transform", function(d) {
                        return transform_string(null, d.y, mouse_node.attr('transform'));
                    }).attr("width", self.height * mouse_node_mult);
                    rect.attr("transform", function(d) {
                        return transform_string(null, d.y, rect.attr('transform'));
                    }).attr("height", self.height);
                    left.attr("transform", function(d) {
                        return transform_string(null, d.y + (dragbar_width / 2), left.attr('transform'));
                    }).attr("height", self.height - dragbar_width);
                    right.attr("transform", function(d) {
                        return transform_string(null, d.y + (dragbar_width / 2), right.attr('transform'));
                    }).attr("height", self.height - dragbar_width);
                    self.callback_manager.run('resize');
                }

                function bdragresize(d) {
                    d3.event.sourceEvent.stopPropagation();
                    var dragy = Math.max(d.y + (dragbar_width / 2), d.y + self.height + d3.event.dy);
                    self.height = dragy - d.y;
                    bottom.attr("transform", function(d) {
                        return transform_string(null, dragy - (dragbar_width / 2), bottom.attr('transform'));
                    });
                    mouse_node.attr("height", self.height * mouse_node_mult);
                    rect.attr("height", self.height);
                    left.attr("height", self.height - dragbar_width);
                    right.attr("height", self.height - dragbar_width);
                    self.callback_manager.run('resize');
                }
            }

            function size_and_location() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height
                };
            }
        }, {
            "./CallbackManager": 5,
            "./utils": 31
        }],
        7: [function(require, module, exports) {
            var utils = require('./utils');
            var data_styles = require('./data_styles');
            var CobraModel = utils.make_class();
            CobraModel.from_exported_data = from_exported_data;
            CobraModel.from_cobra_json = from_cobra_json;
            CobraModel.build_reaction_string = build_reaction_string;
            CobraModel.prototype = {
                init: init,
                apply_reaction_data: apply_reaction_data,
                apply_metabolite_data: apply_metabolite_data,
                apply_gene_data: apply_gene_data,
                model_for_export: model_for_export
            };
            module.exports = CobraModel;

            function build_reaction_string(stoichiometries, is_reversible) {
                var format = function(number) {
                    if (number == 1)
                        return "";
                    return String(number) + " ";
                };
                var reactant_dict = {},
                    product_dict = {},
                    reactant_bits = [],
                    product_bits = [];
                for (var the_metabolite in stoichiometries) {
                    var coefficient = stoichiometries[the_metabolite];
                    if (coefficient > 0)
                        product_bits.push(format(coefficient) + the_metabolite);
                    else
                        reactant_bits.push(format(Math.abs(coefficient)) + the_metabolite);
                }
                var reaction_string = reactant_bits.join(' + ');
                if (is_reversible) {
                    reaction_string += '  ';
                } else {
                    reaction_string += '  ';
                }
                reaction_string += product_bits.join(' + ');
                return reaction_string;
            }

            function from_exported_data(data) {
                if (!(data.reactions && data.metabolites))
                    throw new Error('Bad model data.');
                var model = new CobraModel();
                model.reactions = data.reactions;
                model.metabolites = data.metabolites;
                return model;
            }

            function from_cobra_json(model_data) {
                if (!(model_data.reactions && model_data.metabolites))
                    throw new Error('Bad model data.');
                var genes = {};
                for (var i = 0, l = model_data.genes.length; i < l; i++) {
                    var r = model_data.genes[i],
                        the_id = r.id;
                    genes[the_id] = r;
                }
                var model = new CobraModel();
                model.reactions = {};
                for (var i = 0, l = model_data.reactions.length; i < l; i++) {
                    var r = model_data.reactions[i],
                        the_id = r.id,
                        reaction = utils.clone(r);
                    delete reaction.id;
                    reaction.bigg_id = the_id;
                    reaction.genes = [];
                    reaction.reversibility = (reaction.lower_bound < 0 && reaction.upper_bound > 0);
                    if (reaction.upper_bound <= 0 && reaction.lower_bound < 0) {
                        for (var met_id in reaction.metabolites) {
                            reaction.metabolites[met_id] = -reaction.metabolites[met_id];
                        }
                    }
                    delete reaction.lower_bound;
                    delete reaction.upper_bound;
                    if ('gene_reaction_rule' in reaction) {
                        var gene_ids = data_styles.genes_for_gene_reaction_rule(reaction.gene_reaction_rule);
                        gene_ids.forEach(function(gene_id) {
                            if (gene_id in genes) {
                                var gene = utils.clone(genes[gene_id]);
                                gene.bigg_id = gene.id;
                                delete gene.id;
                                reaction.genes.push(gene);
                            } else {
                                console.warn('Could not find gene for gene_id ' + gene_id);
                            }
                        });
                    }
                    model.reactions[the_id] = reaction;
                }
                model.metabolites = {};
                for (var i = 0, l = model_data.metabolites.length; i < l; i++) {
                    var r = model_data.metabolites[i],
                        the_id = r.id,
                        met = utils.clone(r);
                    delete met.id;
                    met.bigg_id = the_id;
                    model.metabolites[the_id] = met;
                }
                return model;
            }

            function init() {
                this.reactions = {};
                this.metabolites = {};
            }

            function apply_reaction_data(reaction_data, styles, compare_style) {
                data_styles.apply_reaction_data_to_reactions(this.reactions, reaction_data, styles, compare_style);
            }

            function apply_metabolite_data(metabolite_data, styles, compare_style) {
                data_styles.apply_metabolite_data_to_nodes(this.metabolites, metabolite_data, styles, compare_style);
            }

            function apply_gene_data(gene_data_obj, styles, identifiers_on_map, compare_style, and_method_in_gene_reaction_rule) {
                data_styles.apply_gene_data_to_reactions(this.reactions, gene_data_obj, styles, identifiers_on_map, compare_style, and_method_in_gene_reaction_rule);
            }

            function model_for_export() {
                return {
                    reactions: this.reactions,
                    metabolites: this.metabolites
                };
            }
        }, {
            "./data_styles": 26,
            "./utils": 31
        }],
        8: [function(require, module, exports) {
            var utils = require('./utils');
            module.exports = function(options) {
                var o = utils.set_options(options, {
                    selection: null,
                    getdatafiles: null,
                    datafiles: null,
                    update_callback: null,
                    target: null
                });
                if (o.selection === null)
                    throw new Error('No selection provided for DataMenu');
                var menu = o.selection.select('.data-menu');
                if (menu.empty()) {
                    menu = o.selection.append('div').attr('class', 'data-menu');
                }
                var select_sel = menu.append('form').append('select').attr('class', 'dropdown-menu');
                if (o.getdatafiles) {
                    if (o.datafiles) {
                        console.warn('DataMenu: getdatafiles option overrides datafiles');
                    }
                    d3.json(o.getdatafiles, function(error, d) {
                        if (error) {
                            return console.warn(error);
                        } else {
                            load_with_files(o.target, d.data, select_sel, o.update_callback, o.selection);
                        }
                        return null;
                    });
                } else if (o.datafiles) {
                    load_with_files(o.target, o.datafiles, select_sel, o.update_callback, o.selection);
                } else {
                    console.warn('DataMenu: No datafiles given');
                }
                return {
                    update: update
                };

                function load_with_files(t, files, select_sel, update_callback, selection) {
                    select_sel.node().addEventListener("change", function() {
                        load_datafile(t, this.value, selection, update_callback);
                    }, false);
                    var file = files[0];
                    update(files, select_sel);
                    load_datafile(t, file, selection, update_callback);
                };

                function load_datafile(t, this_file, selection, callback) {
                    utils.load_the_file(t, this_file, function(error, data) {
                        if (error) {
                            return console.warn(error);
                            selection.append('error loading');
                            o.data = null;
                        } else {
                            o.data = data;
                            if (callback) {
                                callback(data);
                            }
                        }
                    });
                };

                function update(list, select_sel) {
                    select_sel.selectAll(".menu-option").data(list).enter().append('option').attr('value', function(d) {
                        return d;
                    }).text(function(d) {
                        return d;
                    });
                    select_sel.node().focus();
                };

                function get_data() {
                    return o.data;
                };
            };
        }, {
            "./utils": 31
        }],
        9: [function(require, module, exports) {
            var utils = require('./utils');
            var DirectionArrow = utils.make_class();
            DirectionArrow.prototype = {
                init: init,
                set_location: set_location,
                set_rotation: set_rotation,
                displace_rotation: displace_rotation,
                get_rotation: get_rotation,
                toggle: toggle,
                show: show,
                hide: hide,
                right: right,
                left: left,
                up: up,
                down: down,
                _setup_drag: _setup_drag
            };
            module.exports = DirectionArrow;

            function init(sel) {
                this.arrow_container = sel.append('g').attr('id', 'direction-arrow-container').attr('transform', 'translate(0,0)rotate(0)');
                this.arrow = this.arrow_container.append('path').classed('direction-arrow', true).attr('d', path_for_arrow()).style('visibility', 'hidden').attr('transform', 'translate(30,0)scale(2.5)');
                this.sel = sel;
                this.center = {
                    x: 0,
                    y: 0
                };
                this._setup_drag();
                this.dragging = false;
                this.is_visible = false;
                this.show();

                function path_for_arrow() {
                    return "M0 -5 L0 5 L20 5 L20 10 L30 0 L20 -10 L20 -5 Z";
                }
            }

            function set_location(coords) {
                this.center = coords;
                var transform = utils.d3_transform_catch(this.arrow_container.attr('transform'));
                this.arrow_container.attr('transform', 'translate(' + coords.x + ',' + coords.y + ')rotate(' + transform.rotate + ')');
            }

            function set_rotation(rotation) {
                var transform = utils.d3_transform_catch(this.arrow_container.attr('transform'));
                this.arrow_container.attr('transform', 'translate(' + transform.translate + ')rotate(' + rotation + ')');
            }

            function displace_rotation(d_rotation) {
                var transform = utils.d3_transform_catch(this.arrow_container.attr('transform'));
                this.arrow_container.attr('transform', 'translate(' + transform.translate + ')' + 'rotate(' + (transform.rotate + d_rotation) + ')');
            }

            function get_rotation() {
                return utils.d3_transform_catch(this.arrow_container.attr('transform')).rotate;
            }

            function toggle(on_off) {
                if (on_off === undefined) this.is_visible = !this.is_visible;
                else this.is_visible = on_off;
                this.arrow.style('visibility', this.is_visible ? 'visible' : 'hidden');
            }

            function show() {
                this.toggle(true);
            }

            function hide() {
                this.toggle(false);
            }

            function right() {
                this.set_rotation(0);
            }

            function down() {
                this.set_rotation(90);
            }

            function left() {
                this.set_rotation(180);
            }

            function up() {
                this.set_rotation(270);
            }

            function _setup_drag() {
                var b = d3.behavior.drag().on("dragstart", function(d) {
                    d3.event.sourceEvent.stopPropagation();
                    this.dragging = true;
                }.bind(this)).on("drag.direction_arrow", function(d) {
                    var displacement = {
                            x: d3.event.dx,
                            y: d3.event.dy
                        },
                        location = {
                            x: d3.mouse(this.sel.node())[0],
                            y: d3.mouse(this.sel.node())[1]
                        },
                        d_angle = utils.angle_for_event(displacement, location, this.center);
                    this.displace_rotation(utils.to_degrees(d_angle));
                }.bind(this)).on("dragend", function(d) {
                    setTimeout(function() {
                        this.dragging = false;
                    }.bind(this), 200);
                }.bind(this));
                this.arrow_container.call(b);
            }
        }, {
            "./utils": 31
        }],
        10: [function(require, module, exports) {
            var utils = require('./utils');
            var data_styles = require('./data_styles');
            var CallbackManager = require('./CallbackManager');
            var Draw = utils.make_class();
            Draw.prototype = {
                init: init,
                create_reaction: create_reaction,
                update_reaction: update_reaction,
                create_bezier: create_bezier,
                update_bezier: update_bezier,
                create_node: create_node,
                update_node: update_node,
                create_text_label: create_text_label,
                update_text_label: update_text_label,
                create_membrane: create_membrane,
                update_membrane: update_membrane,
                create_reaction_label: create_reaction_label,
                update_reaction_label: update_reaction_label,
                create_segment: create_segment,
                update_segment: update_segment
            };
            module.exports = Draw;

            function init(behavior, settings) {
                this.behavior = behavior;
                this.settings = settings;
                this.callback_manager = new CallbackManager();
            }

            function create_membrane(enter_selection) {
                enter_selection.append('rect').attr('class', 'membrane');
                this.callback_manager.run('create_membrane', this, enter_selection);
            }

            function update_membrane(update_selection) {
                update_selection.attr('width', function(d) {
                    return d.width;
                }).attr('height', function(d) {
                    return d.height;
                }).attr('transform', function(d) {
                    return 'translate(' + d.x + ',' + d.y + ')';
                }).style('stroke-width', function(d) {
                    return 10;
                }).attr('rx', function(d) {
                    return 20;
                }).attr('ry', function(d) {
                    return 20;
                });
                this.callback_manager.run('update_membrane', this, update_selection);
            }

            function create_reaction(enter_selection) {
                enter_selection.append('g').attr('id', function(d) {
                    return 'r' + d.reaction_id;
                }).attr('class', 'reaction').call(this.create_reaction_label.bind(this));
                this.callback_manager.run('create_reaction', this, enter_selection);
                return;
            }

            function update_reaction(update_selection, scale, cobra_model, drawn_nodes, defs, has_data_on_reactions) {
                update_selection.select('.reaction-label-group').call(function(sel) {
                    return this.update_reaction_label(sel, has_data_on_reactions);
                }.bind(this));
                utils.draw_a_nested_object(update_selection, '.segment-group', 'segments', 'segment_id', this.create_segment.bind(this), function(sel) {
                    return this.update_segment(sel, scale, cobra_model, drawn_nodes, defs, has_data_on_reactions);
                }.bind(this), function(sel) {
                    sel.remove();
                });
                this.callback_manager.run('update_reaction', this, update_selection);
            }

            function create_reaction_label(enter_selection) {
                var group = enter_selection.append('g').attr('class', 'reaction-label-group');
                group.append('title');
                group.append('text').attr('class', 'reaction-label label');
                group.append('g').attr('class', 'all-genes-label-group');
                this.callback_manager.run('create_reaction_label', this, enter_selection);
            }

            function update_reaction_label(update_selection, has_data_on_reactions) {
                var decimal_format = d3.format('.4g')
                var identifiers_on_map = this.settings.get_option('identifiers_on_map')
                var identifiers_in_tooltip = (identifiers_on_map == 'bigg_id' ? 'name' : 'bigg_id')
                var reaction_data_styles = this.settings.get_option('reaction_styles')
                var show_gene_reaction_rules = this.settings.get_option('show_gene_reaction_rules')
                var hide_all_labels = this.settings.get_option('hide_all_labels')
                var gene_font_size = this.settings.get_option('gene_font_size')
                var label_mousedown_fn = this.behavior.label_mousedown
                var label_mouseover_fn = this.behavior.label_mouseover
                var label_mouseout_fn = this.behavior.label_mouseout
                update_selection.attr('transform', function(d) {
                    return 'translate(' + d.label_x + ',' + d.label_y + ')'
                }).call(this.behavior.turn_off_drag).call(this.behavior.reaction_label_drag)
                var label = update_selection.select('.reaction-label').attr('visibility', hide_all_labels ? 'hidden' : 'visible')
                if (!hide_all_labels) {
                    label.text(function(d) {
                        var t = d[identifiers_on_map];
                        if (has_data_on_reactions && reaction_data_styles.indexOf('text') != -1)
                            t += ' ' + d.data_string
                        return t
                    }).on('mousedown', label_mousedown_fn).on('mouseover', label_mouseover_fn).on('mouseout', label_mouseout_fn)
                    update_selection.select('title').text(function(d) {
                        return d[identifiers_in_tooltip]
                    })
                }
                var all_genes_g = update_selection.select('.all-genes-label-group').selectAll('.gene-label-group').data(function(d) {
                    var show_gene_string = ('gene_string' in d && d.gene_string !== null && show_gene_reaction_rules && (!hide_all_labels) && reaction_data_styles.indexOf('text') !== -1)
                    var show_gene_reaction_rule = ('gene_reaction_rule' in d && d.gene_reaction_rule !== null && show_gene_reaction_rules && (!hide_all_labels))
                    if (show_gene_string) {
                        return d.gene_string
                    } else if (show_gene_reaction_rule) {
                        return data_styles.gene_string_for_data(d.gene_reaction_rule, null, d.genes, null, identifiers_on_map, null)
                    } else {
                        return []
                    }
                })
                var gene_g = all_genes_g.enter().append('g').attr('class', 'gene-label-group')
                gene_g.append('text').attr('class', 'gene-label').style('font-size', gene_font_size + 'px')
                gene_g.append('title')
                all_genes_g.attr('transform', function(d, i) {
                    return 'translate(0, ' + (gene_font_size * 1.5 * (i + 1)) + ')'
                });
                all_genes_g.select('text').text(function(d) {
                    return d['text']
                });
                all_genes_g.select('title').text(function(d) {
                    return d[identifiers_in_tooltip]
                });
                all_genes_g.exit().remove()
                this.callback_manager.run('update_reaction_label', this, update_selection)
            }

            function create_segment(enter_selection) {
                var g = enter_selection.append('g').attr('class', 'segment-group').attr('id', function(d) {
                    return 's' + d.segment_id;
                });
                g.append('path').attr('class', 'segment');
                g.append('g').attr('class', 'arrowheads');
                g.append('g').attr('class', 'stoichiometry-labels');
                this.callback_manager.run('create_segment', this, enter_selection);
            }

            function update_segment(update_selection, scale, cobra_model, drawn_nodes, defs, has_data_on_reactions) {
                var reaction_data_styles = this.settings.get_option('reaction_styles'),
                    should_size = (has_data_on_reactions && reaction_data_styles.indexOf('size') != -1),
                    should_color = (has_data_on_reactions && reaction_data_styles.indexOf('color') != -1),
                    no_data_size = this.settings.get_option('reaction_no_data_size'),
                    no_data_color = this.settings.get_option('reaction_no_data_color');
                var highlight_missing = this.settings.get_option('highlight_missing'),
                    hide_secondary_metabolites = this.settings.get_option('hide_secondary_metabolites'),
                    primary_r = this.settings.get_option('primary_metabolite_radius'),
                    secondary_r = this.settings.get_option('secondary_metabolite_radius'),
                    get_arrow_size = function(data, should_size) {
                        var width = 20,
                            height = 13;
                        if (should_size) {
                            height = (data === null ? no_data_size : scale.reaction_size(data));
                            if (isNaN(height))
                                height = no_data_size;
                            width = height * 2;
                        }
                        return {
                            width: width,
                            height: height
                        };
                    },
                    get_disp = function(arrow_size, reversibility, coefficient, node_is_primary) {
                        var arrow_height = ((reversibility || coefficient > 0) ? arrow_size.height : 0),
                            r = node_is_primary ? primary_r : secondary_r;
                        return r + arrow_height + 10;
                    };
                update_selection.selectAll('.segment').datum(function() {
                    return this.parentNode.__data__;
                }).style('visibility', function(d) {
                    var start = drawn_nodes[d.from_node_id],
                        end = drawn_nodes[d.to_node_id];
                    if (hide_secondary_metabolites && ((end['node_type'] == 'metabolite' && !end.node_is_primary) || (start['node_type'] == 'metabolite' && !start.node_is_primary)))
                        return 'hidden';
                    return null;
                }).attr('d', function(d) {
                    if (d.from_node_id === null || d.to_node_id === null)
                        return null;
                    var start = drawn_nodes[d.from_node_id],
                        end = drawn_nodes[d.to_node_id],
                        b1 = d.b1,
                        b2 = d.b2;
                    if (start['node_type'] == 'metabolite') {
                        var arrow_size = get_arrow_size(d.data, should_size),
                            disp = get_disp(arrow_size, d.reversibility, d.from_node_coefficient, start.node_is_primary);
                        var direction = (b1 === null) ? end : b1;
                        start = displaced_coords(disp, start, direction, 'start');
                    }
                    if (end['node_type'] == 'metabolite') {
                        var arrow_size = get_arrow_size(d.data, should_size),
                            disp = get_disp(arrow_size, d.reversibility, d.to_node_coefficient, end.node_is_primary);
                        var direction = (b2 === null) ? start : b2;
                        end = displaced_coords(disp, direction, end, 'end');
                    }
                    var curve = ('M' + start.x + ',' + start.y + ' ');
                    if (b1 !== null && b2 !== null) {
                        curve += ('C' + b1.x + ',' + b1.y + ' ' +
                            b2.x + ',' + b2.y + ' ');
                    }
                    curve += (end.x + ',' + end.y);
                    return curve;
                }).style('stroke', function(d) {
                    var reaction_id = this.parentNode.parentNode.__data__.bigg_id,
                        show_missing = (highlight_missing && cobra_model !== null && !(reaction_id in cobra_model.reactions));
                    if (show_missing) {
                        return 'red';
                    }
                    if (should_color) {
                        var f = d.data;
                        return f === null ? no_data_color : scale.reaction_color(f);
                    }
                    return null;
                }).style('stroke-width', function(d) {
                    if (should_size) {
                        var f = d.data;
                        return f === null ? no_data_size : scale.reaction_size(f);
                    } else {
                        return null;
                    }
                });
                var arrowheads = update_selection.select('.arrowheads').selectAll('.arrowhead').data(function(d) {
                    var arrowheads = [],
                        start = drawn_nodes[d.from_node_id],
                        b1 = d.b1,
                        end = drawn_nodes[d.to_node_id],
                        b2 = d.b2;
                    if (hide_secondary_metabolites && ((end['node_type'] == 'metabolite' && !end.node_is_primary) || (start['node_type'] == 'metabolite' && !start.node_is_primary)))
                        return arrowheads;
                    if (start.node_type == 'metabolite' && (d.reversibility || d.from_node_coefficient > 0)) {
                        var arrow_size = get_arrow_size(d.data, should_size),
                            disp = get_disp(arrow_size, d.reversibility, d.from_node_coefficient, start.node_is_primary),
                            direction = (b1 === null) ? end : b1,
                            rotation = utils.to_degrees(utils.get_angle([start, direction])) + 90,
                            loc = displaced_coords(disp, start, direction, 'start');
                        arrowheads.push({
                            data: d.data,
                            x: loc.x,
                            y: loc.y,
                            size: arrow_size,
                            rotation: rotation,
                            show_arrowhead_flux: (((d.from_node_coefficient < 0) == (d.reverse_flux)) || d.data == 0)
                        });
                    }
                    if (end.node_type == 'metabolite' && (d.reversibility || d.to_node_coefficient > 0)) {
                        var arrow_size = get_arrow_size(d.data, should_size),
                            disp = get_disp(arrow_size, d.reversibility, d.to_node_coefficient, end.node_is_primary),
                            direction = (b2 === null) ? start : b2,
                            rotation = utils.to_degrees(utils.get_angle([end, direction])) + 90,
                            loc = displaced_coords(disp, direction, end, 'end');
                        arrowheads.push({
                            data: d.data,
                            x: loc.x,
                            y: loc.y,
                            size: arrow_size,
                            rotation: rotation,
                            show_arrowhead_flux: (((d.to_node_coefficient < 0) == (d.reverse_flux)) || d.data == 0)
                        });
                    }
                    return arrowheads;
                });
                arrowheads.enter().append('path').classed('arrowhead', true);
                arrowheads.attr('d', function(d) {
                    return ('M' + [-d.size.width / 2, 0] + ' L' + [0, d.size.height] + ' L' + [d.size.width / 2, 0] + ' Z');
                }).attr('transform', function(d) {
                    return 'translate(' + d.x + ',' + d.y + ')rotate(' + d.rotation + ')';
                }).style('fill', function(d) {
                    if (should_color) {
                        if (d.show_arrowhead_flux) {
                            var f = d.data;
                            return f === null ? no_data_color : scale.reaction_color(f);
                        } else {
                            return '#FFFFFF';
                        }
                    }
                    return null;
                }).style('stroke', function(d) {
                    if (should_color) {
                        var f = d.data;
                        return f === null ? no_data_color : scale.reaction_color(f);
                    }
                    return null;
                });
                arrowheads.exit().remove();
                var stoichiometry_labels = update_selection.select('.stoichiometry-labels').selectAll('.stoichiometry-label').data(function(d) {
                    var labels = [],
                        start = drawn_nodes[d.from_node_id],
                        b1 = d.b1,
                        end = drawn_nodes[d.to_node_id],
                        b2 = d.b2,
                        disp_factor = 1.5;
                    if (hide_secondary_metabolites && ((end['node_type'] == 'metabolite' && !end.node_is_primary) || (start['node_type'] == 'metabolite' && !start.node_is_primary)))
                        return labels;
                    if (start.node_type == 'metabolite' && (Math.abs(d.from_node_coefficient) != 1)) {
                        var arrow_size = get_arrow_size(d.data, should_size),
                            disp = disp_factor * get_disp(arrow_size, false, 0, end.node_is_primary),
                            direction = (b1 === null) ? end : b1;
                        direction = utils.c_plus_c(direction, utils.rotate_coords(direction, 0.5, start));
                        var loc = displaced_coords(disp, start, direction, 'start');
                        loc = utils.c_plus_c(loc, {
                            x: 0,
                            y: 7
                        });
                        labels.push({
                            coefficient: Math.abs(d.from_node_coefficient),
                            x: loc.x,
                            y: loc.y,
                            data: d.data
                        });
                    }
                    if (end.node_type == 'metabolite' && (Math.abs(d.to_node_coefficient) != 1)) {
                        var arrow_size = get_arrow_size(d.data, should_size),
                            disp = disp_factor * get_disp(arrow_size, false, 0, end.node_is_primary),
                            direction = (b2 === null) ? start : b2;
                        direction = utils.c_plus_c(direction, utils.rotate_coords(direction, 0.5, end));
                        var loc = displaced_coords(disp, direction, end, 'end');
                        loc = utils.c_plus_c(loc, {
                            x: 0,
                            y: 7
                        });
                        labels.push({
                            coefficient: Math.abs(d.to_node_coefficient),
                            x: loc.x,
                            y: loc.y,
                            data: d.data
                        });
                    }
                    return labels;
                });
                stoichiometry_labels.enter().append('text').attr('class', 'stoichiometry-label').attr('text-anchor', 'middle');
                stoichiometry_labels.attr('transform', function(d) {
                    return 'translate(' + d.x + ',' + d.y + ')';
                }).text(function(d) {
                    return d.coefficient;
                }).style('fill', function(d) {
                    if (should_color) {
                        var f = d.data;
                        return f === null ? no_data_color : scale.reaction_color(f);
                    }
                    return null;
                });
                stoichiometry_labels.exit().remove();
                this.callback_manager.run('update_segment', this, update_selection);
            }

            function create_bezier(enter_selection) {
                var g = enter_selection.append('g').attr('id', function(d) {
                    return d.bezier_id;
                }).attr('class', function(d) {
                    return 'bezier';
                });
                g.append('path').attr('class', 'connect-line');
                g.append('circle').attr('class', function(d) {
                    return 'bezier-circle ' + d.bezier;
                }).style('stroke-width', String(1) + 'px').attr('r', String(7) + 'px');
                this.callback_manager.run('create_bezier', this, enter_selection);
            }

            function update_bezier(update_selection, show_beziers, drag_behavior, mouseover, mouseout, drawn_nodes, drawn_reactions) {
                var hide_secondary_metabolites = this.settings.get_option('hide_secondary_metabolites');
                if (!show_beziers) {
                    update_selection.attr('visibility', 'hidden');
                    return;
                } else {
                    update_selection.attr('visibility', 'visible');
                }
                update_selection.style('visibility', function(d) {
                    var seg_data = drawn_reactions[d.reaction_id].segments[d.segment_id],
                        start = drawn_nodes[seg_data.from_node_id],
                        end = drawn_nodes[seg_data.to_node_id];
                    if (hide_secondary_metabolites && ((end['node_type'] == 'metabolite' && !end.node_is_primary) || (start['node_type'] == 'metabolite' && !start.node_is_primary)))
                        return 'hidden';
                    return null;
                });
                update_selection.select('.bezier-circle').call(this.behavior.turn_off_drag).call(drag_behavior).on('mouseover', mouseover).on('mouseout', mouseout).attr('transform', function(d) {
                    if (d.x == null || d.y == null) return '';
                    return 'translate(' + d.x + ',' + d.y + ')';
                });
                update_selection.select('.connect-line').attr('d', function(d) {
                    var node, segment_d = drawn_reactions[d.reaction_id].segments[d.segment_id];
                    node = (d.bezier == 'b1' ? drawn_nodes[segment_d.from_node_id] : drawn_nodes[segment_d.to_node_id]);
                    if (d.x == null || d.y == null || node.x == null || node.y == null)
                        return '';
                    return 'M' + d.x + ', ' + d.y + ' ' + (node.x) + ',' + (node.y);
                });
                this.callback_manager.run('update_bezier', this, update_selection);
            }

            function create_node(enter_selection, drawn_nodes, drawn_reactions) {
                var g = enter_selection.append('g').attr('class', 'node').attr('id', function(d) {
                    return 'n' + d.node_id;
                });
                g.append('circle').attr('class', function(d) {
                    var c = 'node-circle';
                    if (d.node_type !== null)
                        c += (' ' + d.node_type + '-circle');
                    return c;
                });
                var metabolite_groups = g.filter(function(d) {
                    return d.node_type == 'metabolite';
                });
                metabolite_groups.append('text').attr('class', 'node-label label');
                metabolite_groups.append('title');
                this.callback_manager.run('create_node', this, enter_selection);
            }

            function update_node(update_selection, scale, has_data_on_nodes, mousedown_fn, click_fn, mouseover_fn, mouseout_fn, drag_behavior, label_drag_behavior) {
                var hide_secondary_metabolites = this.settings.get_option('hide_secondary_metabolites')
                var primary_r = this.settings.get_option('primary_metabolite_radius')
                var secondary_r = this.settings.get_option('secondary_metabolite_radius')
                var marker_r = this.settings.get_option('marker_radius')
                var hide_all_labels = this.settings.get_option('hide_all_labels')
                var identifiers_on_map = this.settings.get_option('identifiers_on_map')
                var identifiers_in_tooltip = (identifiers_on_map === 'bigg_id' ? 'name' : 'bigg_id')
                var metabolite_data_styles = this.settings.get_option('metabolite_styles')
                var no_data_style = {
                    color: this.settings.get_option('metabolite_no_data_color'),
                    size: this.settings.get_option('metabolite_no_data_size')
                }
                var mg = update_selection.select('.node-circle').attr('transform', function(d) {
                    return 'translate(' + d.x + ',' + d.y + ')'
                }).style('visibility', function(d) {
                    return hideNode(d, hide_secondary_metabolites) ? 'hidden' : null
                }).attr('r', function(d) {
                    if (d.node_type === 'metabolite') {
                        var should_scale = (has_data_on_nodes && metabolite_data_styles.indexOf('size') !== -1)
                        if (should_scale) {
                            var f = d.data
                            return f === null ? no_data_style['size'] : scale.metabolite_size(f)
                        } else {
                            return d.node_is_primary ? primary_r : secondary_r
                        }
                    }
                    return marker_r
                }).style('fill', function(d) {
                    if (d.node_type == 'metabolite') {
                        var should_color_data = (has_data_on_nodes && metabolite_data_styles.indexOf('color') != -1)
                        if (should_color_data) {
                            var f = d.data
                            return f === null ? no_data_style['color'] : scale.metabolite_color(f)
                        } else {
                            return null
                        }
                    }
                    return null
                }).call(this.behavior.turn_off_drag).call(drag_behavior).on('mousedown', mousedown_fn).on('click', click_fn).on('mouseover', mouseover_fn).on('mouseout', mouseout_fn)
                var node_label = update_selection.select('.node-label').attr('visibility', hide_all_labels ? 'hidden' : 'visible')
                if (!hide_all_labels) {
                    node_label.style('visibility', function(d) {
                        return hideNode(d, hide_secondary_metabolites) ? 'hidden' : null
                    }).attr('transform', function(d) {
                        return 'translate(' + d.label_x + ',' + d.label_y + ')'
                    }).text(function(d) {
                        var t = d[identifiers_on_map]
                        if (has_data_on_nodes && metabolite_data_styles.indexOf('text') !== -1)
                            t += ' ' + d.data_string
                        return t
                    }).call(this.behavior.turn_off_drag).call(label_drag_behavior)
                    update_selection.select('title').text(function(d) {
                        return d[identifiers_in_tooltip]
                    })
                }
                this.callback_manager.run('update_node', this, update_selection)

                function hideNode(d, hide_secondary_metabolites) {
                    return (d.node_type === 'metabolite' && hide_secondary_metabolites && !d.node_is_primary)
                }
            }

            function create_text_label(enter_selection) {
                enter_selection.append('g').attr('id', function(d) {
                    return 'l' + d.text_label_id;
                }).attr('class', 'text-label').append('text').attr('class', 'label');
                this.callback_manager.run('create_text_label', this, enter_selection);
            }

            function update_text_label(update_selection) {
                var mousedown_fn = this.behavior.text_label_mousedown,
                    click_fn = this.behavior.text_label_click,
                    drag_behavior = this.behavior.selectable_drag,
                    turn_off_drag = this.behavior.turn_off_drag;
                update_selection.select('.label').text(function(d) {
                    return d.text;
                }).attr('transform', function(d) {
                    return 'translate(' + d.x + ',' + d.y + ')';
                }).on('mousedown', mousedown_fn).on('click', click_fn).call(turn_off_drag).call(drag_behavior);
                this.callback_manager.run('update_text_label', this, update_selection);
            }

            function displaced_coords(reaction_arrow_displacement, start, end, displace) {
                utils.check_undefined(arguments, ['reaction_arrow_displacement', 'start', 'end', 'displace']);
                var length = reaction_arrow_displacement,
                    hyp = utils.distance(start, end),
                    new_x, new_y;
                if (!length || !hyp) console.error('Bad value');
                if (displace == 'start') {
                    new_x = start.x + length * (end.x - start.x) / hyp, new_y = start.y + length * (end.y - start.y) / hyp;
                } else if (displace == 'end') {
                    new_x = end.x - length * (end.x - start.x) / hyp, new_y = end.y - length * (end.y - start.y) / hyp;
                } else {
                    console.error('bad displace value: ' + displace);
                }
                return {
                    x: new_x,
                    y: new_y
                };
            }
        }, {
            "./CallbackManager": 5,
            "./data_styles": 26,
            "./utils": 31
        }],
        11: [function(require, module, exports) {
            var utils = require('./utils');
            var Mousetrap = require('mousetrap');
            var _ = require('underscore');
            var KeyManager = utils.make_class();
            KeyManager.prototype = {
                init: init,
                update: update,
                toggle: toggle,
                add_escape_listener: add_escape_listener,
                add_enter_listener: add_enter_listener,
                add_key_listener: add_key_listener
            };
            module.exports = KeyManager;

            function init(assigned_keys, input_list, selection, ctrl_equals_cmd) {
                this.assigned_keys = assigned_keys || {};
                this.input_list = input_list || [];
                this.mousetrap = selection ? new Mousetrap(selection) : new Mousetrap;
                this.ctrl_equals_cmd = (!_.isBoolean(ctrl_equals_cmd)) ? false : ctrl_equals_cmd;
                this.mousetrap.stopCallback = function() {
                    return false;
                };
                this.enabled = true;
                this.update();
            }

            function _add_cmd(key, ctrl_equals_cmd) {
                if (!ctrl_equals_cmd) return key;
                var key_ar = _.isArray(key) ? key : [key];
                var new_ar = key_ar.reduce(function(c, k) {
                    var n = k.replace('ctrl+', 'meta+');
                    if (n !== k) c.push(n);
                    return c;
                }, key_ar.slice());
                return new_ar.length === key_ar.length ? key : new_ar;
            }

            function update() {
                this.mousetrap.reset();
                if (!this.enabled) return;
                for (var key_id in this.assigned_keys) {
                    var assigned_key = this.assigned_keys[key_id];
                    if (!assigned_key.key) continue;
                    var key_to_bind = _add_cmd(assigned_key.key, this.ctrl_equals_cmd);
                    assigned_key.input_list = this.input_list;
                    this.mousetrap.bind(key_to_bind, function(e) {
                        var input_blocking = false;
                        if (this.ignore_with_input) {
                            for (var i = 0, l = this.input_list.length; i < l; i++) {
                                if (this.input_list[i].is_visible()) {
                                    input_blocking = true;
                                    break;
                                }
                            }
                        }
                        if (!input_blocking) {
                            if (this.fn) this.fn.call(this.target);
                            else console.warn('No function for key: ' + this.key);
                            e.preventDefault();
                        }
                    }.bind(assigned_key), 'keydown');
                }
            }

            function toggle(on_off) {
                if (_.isUndefined(on_off)) on_off = !this.enabled;
                this.enabled = on_off;
                this.update();
            }

            function add_enter_listener(callback, one_time) {
                return this.add_key_listener('enter', callback, one_time);
            }

            function add_escape_listener(callback, one_time) {
                return this.add_key_listener('escape', callback, one_time);
            }

            function add_key_listener(key_name, callback, one_time) {
                if (_.isUndefined(one_time)) one_time = false;
                var unbind = this.mousetrap.unbind.bind(this.mousetrap, key_name);
                this.mousetrap.bind(_add_cmd(key_name, this.ctrl_equals_cmd), function(e) {
                    e.preventDefault();
                    callback();
                    if (one_time) unbind();
                });
                return unbind;
            }
        }, {
            "./utils": 31,
            "mousetrap": 34,
            "underscore": 35
        }],
        12: [function(require, module, exports) {
            var utils = require('./utils');
            var Draw = require('./Draw');
            var Behavior = require('./Behavior');
            var Scale = require('./Scale');
            var build = require('./build');
            var UndoStack = require('./UndoStack');
            var CallbackManager = require('./CallbackManager');
            var KeyManager = require('./KeyManager');
            var Canvas = require('./Canvas');
            var data_styles = require('./data_styles');
            var SearchIndex = require('./SearchIndex');
            var bacon = require('baconjs');
            var _ = require('underscore');
            var Map = utils.make_class();
            Map.from_data = from_data;
            Map.prototype = {
                init: init,
                setup_containers: setup_containers,
                reset_containers: reset_containers,
                set_status: set_status,
                clear_map: clear_map,
                select_all: select_all,
                select_none: select_none,
                invert_selection: invert_selection,
                select_selectable: select_selectable,
                select_metabolite_with_id: select_metabolite_with_id,
                select_single_node: select_single_node,
                deselect_nodes: deselect_nodes,
                select_text_label: select_text_label,
                deselect_text_labels: deselect_text_labels,
                new_reaction_from_scratch: new_reaction_from_scratch,
                extend_nodes: extend_nodes,
                extend_reactions: extend_reactions,
                new_reaction_for_metabolite: new_reaction_for_metabolite,
                cycle_primary_node: cycle_primary_node,
                toggle_selected_node_primary: toggle_selected_node_primary,
                new_text_label: new_text_label,
                edit_text_label: edit_text_label,
                delete_selected: delete_selected,
                delete_selectable: delete_selectable,
                delete_node_data: delete_node_data,
                delete_segment_data: delete_segment_data,
                delete_reaction_data: delete_reaction_data,
                delete_text_label_data: delete_text_label_data,
                get_selected_node_ids: get_selected_node_ids,
                get_selected_nodes: get_selected_nodes,
                get_selected_text_label_ids: get_selected_text_label_ids,
                get_selected_text_labels: get_selected_text_labels,
                segments_and_reactions_for_nodes: segments_and_reactions_for_nodes,
                draw_everything: draw_everything,
                draw_all_reactions: draw_all_reactions,
                draw_these_reactions: draw_these_reactions,
                clear_deleted_reactions: clear_deleted_reactions,
                draw_all_nodes: draw_all_nodes,
                draw_these_nodes: draw_these_nodes,
                clear_deleted_nodes: clear_deleted_nodes,
                draw_all_text_labels: draw_all_text_labels,
                draw_these_text_labels: draw_these_text_labels,
                clear_deleted_text_labels: clear_deleted_text_labels,
                draw_all_beziers: draw_all_beziers,
                draw_these_beziers: draw_these_beziers,
                clear_deleted_beziers: clear_deleted_beziers,
                toggle_beziers: toggle_beziers,
                hide_beziers: hide_beziers,
                show_beziers: show_beziers,
                has_cobra_model: has_cobra_model,
                apply_reaction_data_to_map: apply_reaction_data_to_map,
                apply_metabolite_data_to_map: apply_metabolite_data_to_map,
                apply_gene_data_to_map: apply_gene_data_to_map,
                get_data_statistics: get_data_statistics,
                calc_data_stats: calc_data_stats,
                zoom_extent_nodes: zoom_extent_nodes,
                zoom_extent_canvas: zoom_extent_canvas,
                _zoom_extent: _zoom_extent,
                get_size: get_size,
                zoom_to_reaction: zoom_to_reaction,
                zoom_to_node: zoom_to_node,
                zoom_to_text_label: zoom_to_text_label,
                highlight_reaction: highlight_reaction,
                highlight_node: highlight_node,
                highlight_text_label: highlight_text_label,
                highlight: highlight,
                listen_for_full_screen: listen_for_full_screen,
                unlisten_for_full_screen: unlisten_for_full_screen,
                full_screen: full_screen,
                save: save,
                map_for_export: map_for_export,
                save_svg: save_svg,
                save_png: save_png,
                convert_map: convert_map
            };
            module.exports = Map;

            function init(svg, css, selection, zoom_container, settings, cobra_model, canvas_size_and_loc, enable_search, map_name, map_id, map_description) {
                if (canvas_size_and_loc === null) {
                    var size = zoom_container.get_size()
                    canvas_size_and_loc = {
                        x: -size.width,
                        y: -size.height,
                        width: size.width * 3,
                        height: size.height * 3
                    }
                }
                if (_.isUndefined(map_name) || map_name === null || map_name == '')
                    map_name = 'new_map'
                else
                    map_name = String(map_name)
                if (_.isUndefined(map_id) || map_id === null || map_id == '')
                    map_id = utils.generate_map_id()
                else
                    map_id = String(map_id)
                if (_.isUndefined(map_description) || map_description === null)
                    map_description = ''
                else
                    map_description = String(map_description)
                this.callback_manager = new CallbackManager()
                this.svg = svg
                this.defs = utils.setup_defs(svg, css)
                this.canvas = new Canvas(selection, canvas_size_and_loc)
                this.setup_containers(selection)
                this.sel = selection
                this.zoom_container = zoom_container
                this.settings = settings
                this.cobra_model = cobra_model
                this.largest_ids = {
                    reactions: -1,
                    nodes: -1,
                    segments: -1,
                    text_labels: -1
                }
                this.scale = new Scale()
                this.calc_data_stats('reaction')
                this.calc_data_stats('metabolite')
                this.scale.connect_to_settings(this.settings, this, get_data_statistics.bind(this))
                this.undo_stack = new UndoStack()
                this.behavior = new Behavior(this, this.undo_stack)
                this.draw = new Draw(this.behavior, this.settings)
                this.key_manager = new KeyManager()
                this.key_manager.ctrl_equals_cmd = true
                this.enable_search = enable_search
                this.search_index = new SearchIndex()
                this.map_name = map_name
                this.map_id = map_id
                this.map_description = map_description
                var window_translate = {
                        'x': 0,
                        'y': 0
                    },
                    window_scale = 1
                this.beziers_enabled = false
                this.has_data_on_reactions = false
                this.has_data_on_nodes = false
                this.nodes = {}
                this.reactions = {}
                this.beziers = {}
                this.text_labels = {}
                this.apply_reaction_data_to_map(null)
                this.apply_metabolite_data_to_map(null)
                this.apply_gene_data_to_map(null)
                this.rotation_on = false
                this.listen_for_full_screen(function() {
                    setTimeout(function() {
                        this.zoom_extent_canvas()
                    }.bind(this), 50)
                }.bind(this))
            }

            function from_data(map_data, svg, css, selection, zoom_container, settings, cobra_model, enable_search) {
                var canvas = map_data[1].canvas,
                    map_name = map_data[0].map_name,
                    map_id = map_data[0].map_id,
                    map_description = (map_data[0].map_description.replace(/(\nLast Modified.*)+$/g, '') +
                        '\nLast Modified ' + Date(Date.now()).toString()),
                    map = new Map(svg, css, selection, zoom_container, settings, cobra_model, canvas, enable_search, map_name, map_id, map_description);
                map.reactions = map_data[1].reactions;
                map.nodes = map_data[1].nodes;
                map.text_labels = map_data[1].text_labels;
                for (var n_id in map.nodes) {
                    var node = map.nodes[n_id];
                    node.connected_segments = [];
                    if (enable_search) {
                        if (node.node_type != 'metabolite') continue;
                        map.search_index.insert('n' + n_id, {
                            'name': node.bigg_id,
                            'data': {
                                type: 'metabolite',
                                node_id: n_id
                            }
                        });
                        map.search_index.insert('n_name' + n_id, {
                            'name': node.name,
                            'data': {
                                type: 'metabolite',
                                node_id: n_id
                            }
                        });
                    }
                }
                for (var r_id in map.reactions) {
                    var reaction = map.reactions[r_id];
                    if (enable_search) {
                        map.search_index.insert('r' + r_id, {
                            'name': reaction.bigg_id,
                            'data': {
                                type: 'reaction',
                                reaction_id: r_id
                            }
                        });
                        map.search_index.insert('r_name' + r_id, {
                            'name': reaction.name,
                            'data': {
                                type: 'reaction',
                                reaction_id: r_id
                            }
                        });
                        for (var g_id in reaction.genes) {
                            var gene = reaction.genes[g_id];
                            map.search_index.insert('r' + r_id + '_g' + g_id, {
                                'name': gene.bigg_id,
                                'data': {
                                    type: 'reaction',
                                    reaction_id: r_id
                                }
                            });
                            map.search_index.insert('r' + r_id + '_g_name' + g_id, {
                                'name': gene.name,
                                'data': {
                                    type: 'reaction',
                                    reaction_id: r_id
                                }
                            });
                        }
                    }
                    var segments_to_delete = [];
                    for (var s_id in reaction.segments) {
                        var segment = reaction.segments[s_id];
                        segment.reversibility = reaction.reversibility;
                        if (!(segment.from_node_id in map.nodes) || !(segment.to_node_id in map.nodes)) {
                            console.warn('Bad node references in segment ' + s_id + '. Deleting segment.');
                            segments_to_delete.push(s_id);
                            continue
                        }
                        var from_node = map.nodes[segment.from_node_id],
                            to_node = map.nodes[segment.to_node_id];
                        reaction.metabolites.forEach(function(met) {
                            if (met.bigg_id == from_node.bigg_id) {
                                segment.from_node_coefficient = met.coefficient;
                            } else if (met.bigg_id == to_node.bigg_id) {
                                segment.to_node_coefficient = met.coefficient;
                            }
                        });
                        [from_node, to_node].forEach(function(node) {
                            node.connected_segments.push({
                                segment_id: s_id,
                                reaction_id: r_id
                            });
                        });
                        var start = map.nodes[segment.from_node_id],
                            end = map.nodes[segment.to_node_id];
                        if (start['node_type'] == 'metabolite' || end['node_type'] == 'metabolite') {
                            var midpoint = utils.c_plus_c(start, utils.c_times_scalar(utils.c_minus_c(end, start), 0.5));
                            if (segment.b1 === null) segment.b1 = midpoint;
                            if (segment.b2 === null) segment.b2 = midpoint;
                        }
                    }
                    segments_to_delete.forEach(function(s_id) {
                        delete reaction.segments[s_id];
                    });
                }
                if (enable_search) {
                    for (var label_id in map.text_labels) {
                        var label = map.text_labels[label_id];
                        map.search_index.insert('l' + label_id, {
                            'name': label.text,
                            'data': {
                                type: 'text_label',
                                text_label_id: label_id
                            }
                        });
                    }
                }
                map.beziers = build.new_beziers_for_reactions(map.reactions);
                map.largest_ids.reactions = get_largest_id(map.reactions);
                map.largest_ids.nodes = get_largest_id(map.nodes);
                map.largest_ids.text_labels = get_largest_id(map.text_labels);
                var largest_segment_id = 0;
                for (var id in map.reactions) {
                    largest_segment_id = get_largest_id(map.reactions[id].segments, largest_segment_id);
                }
                map.largest_ids.segments = largest_segment_id;
                map.apply_reaction_data_to_map(null);
                map.apply_metabolite_data_to_map(null);
                map.apply_gene_data_to_map(null);
                return map;

                function get_largest_id(obj, current_largest) {
                    if (_.isUndefined(current_largest)) current_largest = 0;
                    if (_.isUndefined(obj)) return current_largest;
                    return Math.max.apply(null, Object.keys(obj).map(function(x) {
                        return parseInt(x);
                    }).concat([current_largest]));
                }
            }

            function setup_containers(sel) {
                sel.append('g').attr('id', 'reactions');
                sel.append('g').attr('id', 'nodes');
                sel.append('g').attr('id', 'beziers');
                sel.append('g').attr('id', 'text-labels');
            }

            function reset_containers() {
                this.sel.select('#reactions').selectAll('.reaction').remove();
                this.sel.select('#nodes').selectAll('.node').remove();
                this.sel.select('#beziers').selectAll('.bezier').remove();
                this.sel.select('#text-labels').selectAll('.text-label').remove();
            }

            function set_status(status, time) {
                this.callback_manager.run('set_status', null, status);
                clearTimeout(this._status_timer);
                this._status_timer = null;
                if (time !== undefined) {
                    this._status_timer = setTimeout(function() {
                        this.callback_manager.run('set_status', null, '');
                    }.bind(this), time);
                }
            }

            function clear_map() {
                this.reactions = {};
                this.beziers = {};
                this.nodes = {};
                this.text_labels = {};
                this.map_name = 'new_map';
                this.map_id = utils.generate_map_id();
                this.map_description = '';
                this.apply_reaction_data_to_map(null);
                this.apply_metabolite_data_to_map(null);
                this.apply_gene_data_to_map(null);
                this.draw_everything();
            }

            function has_cobra_model() {
                return (this.cobra_model !== null);
            }

            function draw_everything() {
                this.draw_all_reactions(true, true);
                this.draw_all_nodes(true);
                this.draw_all_text_labels();
            }

            function draw_all_reactions(draw_beziers, clear_deleted) {
                if (_.isUndefined(draw_beziers)) draw_beziers = true;
                if (_.isUndefined(clear_deleted)) clear_deleted = true;
                var reaction_ids = [];
                for (var reaction_id in this.reactions) {
                    reaction_ids.push(reaction_id);
                }
                this.draw_these_reactions(reaction_ids, false);
                if (draw_beziers && this.beziers_enabled)
                    this.draw_all_beziers();
                if (clear_deleted)
                    this.clear_deleted_reactions(draw_beziers);
            }

            function draw_these_reactions(reaction_ids, draw_beziers) {
                if (_.isUndefined(draw_beziers)) draw_beziers = true;
                var reaction_subset = utils.object_slice_for_ids_ref(this.reactions, reaction_ids);
                var update_fn = function(sel) {
                    return this.draw.update_reaction(sel, this.scale, this.cobra_model, this.nodes, this.defs, this.has_data_on_reactions);
                }.bind(this);
                utils.draw_an_object(this.sel, '#reactions', '.reaction', reaction_subset, 'reaction_id', this.draw.create_reaction.bind(this.draw), update_fn);
                if (draw_beziers) {
                    var bezier_ids = build.bezier_ids_for_reaction_ids(reaction_subset);
                    this.draw_these_beziers(bezier_ids);
                }
            }

            function clear_deleted_reactions(draw_beziers) {
                if (_.isUndefined(draw_beziers)) draw_beziers = true;
                utils.draw_an_object(this.sel, '#reactions', '.reaction', this.reactions, 'reaction_id', null, clear_deleted_segments, function(sel) {
                    sel.remove();
                });
                if (draw_beziers == true)
                    this.clear_deleted_beziers();

                function clear_deleted_segments(update_selection) {
                    utils.draw_a_nested_object(update_selection, '.segment-group', 'segments', 'segment_id', null, null, function(sel) {
                        sel.remove();
                    });
                };
            }

            function draw_all_nodes(clear_deleted) {
                if (clear_deleted === undefined) clear_deleted = true;
                var node_ids = [];
                for (var node_id in this.nodes) {
                    node_ids.push(node_id);
                }
                this.draw_these_nodes(node_ids);
                if (clear_deleted)
                    this.clear_deleted_nodes();
            }

            function draw_these_nodes(node_ids) {
                var node_subset = utils.object_slice_for_ids_ref(this.nodes, node_ids);
                var create_fn = function(sel) {
                        return this.draw.create_node(sel, this.nodes, this.reactions);
                    }.bind(this),
                    update_fn = function(sel) {
                        return this.draw.update_node(sel, this.scale, this.has_data_on_nodes, this.behavior.selectable_mousedown, this.behavior.selectable_click, this.behavior.node_mouseover, this.behavior.node_mouseout, this.behavior.selectable_drag, this.behavior.node_label_drag);
                    }.bind(this);
                utils.draw_an_object(this.sel, '#nodes', '.node', node_subset, 'node_id', create_fn, update_fn);
            }

            function clear_deleted_nodes() {
                utils.draw_an_object(this.sel, '#nodes', '.node', this.nodes, 'node_id', null, null, function(sel) {
                    sel.remove();
                });
            }

            function draw_all_text_labels() {
                var text_label_ids = [];
                for (var text_label_id in this.text_labels) {
                    text_label_ids.push(text_label_id);
                }
                this.draw_these_text_labels(text_label_ids);
                this.clear_deleted_text_labels();
            }

            function draw_these_text_labels(text_label_ids) {
                var text_label_subset = utils.object_slice_for_ids_ref(this.text_labels, text_label_ids);
                var update_fn = function(sel) {
                    return this.draw.update_text_label(sel, this.behavior);;
                }.bind(this);
                utils.draw_an_object(this.sel, '#text-labels', '.text-label', text_label_subset, 'text_label_id', this.draw.create_text_label.bind(this.draw), update_fn);
            }

            function clear_deleted_text_labels() {
                utils.draw_an_object(this.sel, '#text-labels', '.text-label', this.text_labels, 'text_label_id', null, null, function(sel) {
                    sel.remove();
                });
            }

            function draw_all_beziers() {
                var bezier_ids = [];
                for (var bezier_id in this.beziers) {
                    bezier_ids.push(bezier_id);
                }
                this.draw_these_beziers(bezier_ids);
                this.clear_deleted_beziers();
            }

            function draw_these_beziers(bezier_ids) {
                var bezier_subset = utils.object_slice_for_ids_ref(this.beziers, bezier_ids);
                var update_fn = function(sel) {
                    return this.draw.update_bezier(sel, this.beziers_enabled, this.behavior.bezier_drag, this.behavior.bezier_mouseover, this.behavior.bezier_mouseout, this.nodes, this.reactions);
                }.bind(this);
                utils.draw_an_object(this.sel, '#beziers', '.bezier', bezier_subset, 'bezier_id', this.draw.create_bezier.bind(this.draw), update_fn);
            }

            function clear_deleted_beziers() {
                utils.draw_an_object(this.sel, '#beziers', '.bezier', this.beziers, 'bezier_id', null, null, function(sel) {
                    sel.remove();
                });
            }

            function show_beziers() {
                this.toggle_beziers(true);
            }

            function hide_beziers() {
                this.toggle_beziers(false);
            }

            function toggle_beziers(on_off) {
                if (_.isUndefined(on_off)) this.beziers_enabled = !this.beziers_enabled;
                else this.beziers_enabled = on_off;
                this.draw_all_beziers();
                this.callback_manager.run('toggle_beziers', null, this.beziers_enabled);
            }

            function apply_reaction_data_to_map(data) {
                var styles = this.settings.get_option('reaction_styles'),
                    compare_style = this.settings.get_option('reaction_compare_style');
                var has_data = data_styles.apply_reaction_data_to_reactions(this.reactions, data, styles, compare_style);
                this.has_data_on_reactions = has_data;
                return this.calc_data_stats('reaction');
            }

            function apply_metabolite_data_to_map(data) {
                var styles = this.settings.get_option('metabolite_styles'),
                    compare_style = this.settings.get_option('metabolite_compare_style');
                var has_data = data_styles.apply_metabolite_data_to_nodes(this.nodes, data, styles, compare_style);
                this.has_data_on_nodes = has_data;
                return this.calc_data_stats('metabolite');
            }

            function apply_gene_data_to_map(gene_data_obj) {
                var styles = this.settings.get_option('reaction_styles'),
                    compare_style = this.settings.get_option('reaction_compare_style'),
                    identifiers_on_map = this.settings.get_option('identifiers_on_map'),
                    and_method_in_gene_reaction_rule = this.settings.get_option('and_method_in_gene_reaction_rule');
                var has_data = data_styles.apply_gene_data_to_reactions(this.reactions, gene_data_obj, styles, identifiers_on_map, compare_style, and_method_in_gene_reaction_rule);
                this.has_data_on_reactions = has_data;
                return this.calc_data_stats('reaction');
            }

            function get_data_statistics() {
                return this.data_statistics;
            }

            function calc_data_stats(type) {
                if (['reaction', 'metabolite'].indexOf(type) == -1)
                    throw new Error('Bad type ' + type);
                if (!('data_statistics' in this)) {
                    this.data_statistics = {};
                    this.data_statistics[type] = {};
                } else if (!(type in this.data_statistics)) {
                    this.data_statistics[type] = {};
                }
                var same = true;
                var vals = [];
                if (type == 'metabolite') {
                    for (var node_id in this.nodes) {
                        var node = this.nodes[node_id];
                        if (node.data !== null)
                            vals.push(node.data);
                    }
                } else if (type == 'reaction') {
                    for (var reaction_id in this.reactions) {
                        var reaction = this.reactions[reaction_id];
                        if (reaction.data !== null)
                            vals.push(reaction.data);
                    }
                }
                var quartiles = utils.quartiles(vals),
                    funcs = [
                        ['min', on_array(Math.min)],
                        ['max', on_array(Math.max)],
                        ['mean', utils.mean],
                        ['Q1', function() {
                            return quartiles[0];
                        }],
                        ['median', function() {
                            return quartiles[1];
                        }],
                        ['Q3', function() {
                            return quartiles[2];
                        }]
                    ];
                funcs.forEach(function(ar) {
                    var new_val, name = ar[0];
                    if (vals.length == 0) {
                        new_val = null;
                    } else {
                        var fn = ar[1];
                        new_val = fn(vals);
                    }
                    if (new_val != this.data_statistics[type][name])
                        same = false;
                    this.data_statistics[type][name] = new_val;
                }.bind(this));
                if (type == 'reaction')
                    this.callback_manager.run('calc_data_stats__reaction', null, !same);
                else
                    this.callback_manager.run('calc_data_stats__metabolite', null, !same);
                return !same;

                function on_array(fn) {
                    return function(array) {
                        return fn.apply(null, array);
                    };
                }
            }

            function get_coords_for_node(node_id) {
                var node = this.nodes[node_id],
                    coords = {
                        'x': node.x,
                        'y': node.y
                    };
                return coords;
            }

            function get_selected_node_ids() {
                var selected_node_ids = [];
                this.sel.select('#nodes').selectAll('.selected').each(function(d) {
                    selected_node_ids.push(d.node_id);
                });
                return selected_node_ids;
            }

            function get_selected_nodes() {
                var selected_nodes = {},
                    self = this;
                this.sel.select('#nodes').selectAll('.selected').each(function(d) {
                    selected_nodes[d.node_id] = this.nodes[d.node_id];
                }.bind(this));
                return selected_nodes;
            }

            function get_selected_text_label_ids() {
                var selected_text_label_ids = [];
                this.sel.select('#text-labels').selectAll('.selected').each(function(d) {
                    selected_text_label_ids.push(d.text_label_id);
                });
                return selected_text_label_ids;
            }

            function get_selected_text_labels() {
                var selected_text_labels = {},
                    self = this;
                this.sel.select('#text-labels').selectAll('.selected').each(function(d) {
                    selected_text_labels[d.text_label_id] = this.text_labels[d.text_label_id];
                }.bind(this));
                return selected_text_labels;
            }

            function select_all() {
                this.sel.selectAll('#nodes,#text-labels').selectAll('.node,.text-label').classed('selected', true);
            }

            function select_none() {
                this.sel.selectAll('.selected').classed('selected', false);
            }

            function invert_selection() {
                var selection = this.sel.selectAll('#nodes,#text-labels').selectAll('.node,.text-label');
                selection.classed('selected', function() {
                    return !d3.select(this).classed('selected');
                });
            }

            function select_metabolite_with_id(node_id) {
                this.deselect_text_labels();
                var node_selection = this.sel.select('#nodes').selectAll('.node'),
                    coords, selected_node;
                node_selection.classed('selected', function(d) {
                    var selected = String(d.node_id) == String(node_id);
                    if (selected) {
                        selected_node = d;
                        coords = {
                            x: d.x,
                            y: d.y
                        };
                    }
                    return selected;
                });
                this.sel.selectAll('.start-reaction-target').style('visibility', 'hidden');
                this.callback_manager.run('select_metabolite_with_id', null, selected_node, coords);
            }

            function select_selectable(node, d, shift_key_on) {
                shift_key_on = _.isUndefined(shift_key_on) ? false : shift_key_on;
                var classable_selection = this.sel.selectAll('#nodes,#text-labels').selectAll('.node,.text-label'),
                    classable_node;
                if (d3.select(node).attr('class').indexOf('text-label') == -1) {
                    classable_node = node.parentNode;
                } else {
                    classable_node = node;
                }
                if (shift_key_on) {
                    d3.select(classable_node).classed('selected', !d3.select(classable_node).classed('selected'));
                } else {
                    classable_selection.classed('selected', false);
                    d3.select(classable_node).classed('selected', true);
                }
                var selected_nodes = this.sel.select('#nodes').selectAll('.selected'),
                    node_count = 0,
                    coords, selected_node;
                selected_nodes.each(function(d) {
                    selected_node = d;
                    coords = {
                        x: d.x,
                        y: d.y
                    };
                    node_count++;
                });
                this.callback_manager.run('select_selectable', null, node_count, selected_node, coords);
            }

            function select_single_node() {
                var out = null,
                    self = this,
                    node_selection = this.sel.select('#nodes').selectAll('.selected');
                node_selection.classed('selected', function(d, i) {
                    if (i == 0) {
                        out = d;
                        return true;
                    } else {
                        return false;
                    }
                });
                return out;
            }

            function deselect_nodes() {
                var node_selection = this.sel.select('#nodes').selectAll('.node');
                node_selection.classed('selected', false);
                this.callback_manager.run('deselect_nodes');
            }

            function select_text_label(sel, d) {
                this.deselect_nodes();
                var text_label_selection = this.sel.select('#text-labels').selectAll('.text-label');
                text_label_selection.classed('selected', function(p) {
                    return d === p;
                });
                var selected_text_labels = this.sel.select('#text-labels').selectAll('.selected'),
                    coords;
                selected_text_labels.each(function(d) {
                    coords = {
                        x: d.x,
                        y: d.y
                    };
                });
                this.callback_manager.run('select_text_label');
            }

            function deselect_text_labels() {
                var text_label_selection = this.sel.select('#text-labels').selectAll('.text-label');
                text_label_selection.classed('selected', false);
            }

            function delete_selected() {
                var selected_nodes = this.get_selected_nodes(),
                    selected_text_labels = this.get_selected_text_labels();
                if (Object.keys(selected_nodes).length >= 1 || Object.keys(selected_text_labels).length >= 1)
                    this.delete_selectable(selected_nodes, selected_text_labels, true);
            }

            function delete_selectable(selected_nodes, selected_text_labels, should_draw) {
                var out = this.segments_and_reactions_for_nodes(selected_nodes),
                    segment_objs_w_segments = out.segment_objs_w_segments,
                    reactions = out.reactions;
                var saved_nodes = utils.clone(selected_nodes),
                    saved_segment_objs_w_segments = utils.clone(segment_objs_w_segments),
                    saved_reactions = utils.clone(reactions),
                    saved_text_labels = utils.clone(selected_text_labels),
                    delete_and_draw = function(nodes, reactions, segment_objs, selected_text_labels) {
                        this.delete_node_data(Object.keys(selected_nodes));
                        this.delete_segment_data(segment_objs);
                        this.delete_reaction_data(Object.keys(reactions));
                        this.delete_text_label_data(Object.keys(selected_text_labels));
                        var changed_r_scale = false,
                            changed_m_scale = false;
                        if (this.has_data_on_reactions)
                            changed_r_scale = this.calc_data_stats('reaction');
                        if (this.has_data_on_nodes)
                            changed_m_scale = this.calc_data_stats('metabolite');
                        if (should_draw) {
                            if (changed_r_scale)
                                this.draw_all_reactions(true, true);
                            else
                                this.clear_deleted_reactions();
                            if (changed_m_scale)
                                this.draw_all_nodes(true);
                            else
                                this.clear_deleted_nodes();
                            this.clear_deleted_text_labels();
                        }
                    }.bind(this);
                delete_and_draw(selected_nodes, reactions, segment_objs_w_segments, selected_text_labels);
                this.undo_stack.push(function() {
                    this.extend_nodes(saved_nodes);
                    this.extend_reactions(saved_reactions);
                    var reaction_ids_to_draw = Object.keys(saved_reactions);
                    for (var segment_id in saved_segment_objs_w_segments) {
                        var segment_obj = saved_segment_objs_w_segments[segment_id];
                        var segment = segment_obj.segment;
                        this.reactions[segment_obj.reaction_id].segments[segment_obj.segment_id] = segment;
                        [segment.from_node_id, segment.to_node_id].forEach(function(node_id) {
                            if (node_id in saved_nodes) return;
                            var node = this.nodes[node_id];
                            node.connected_segments.push({
                                reaction_id: segment_obj.reaction_id,
                                segment_id: segment_obj.segment_id
                            });
                        }.bind(this));
                        var seg_id = segment_obj.segment_id,
                            r_id = segment_obj.reaction_id,
                            seg_o = {};
                        seg_o[seg_id] = segment_obj.segment;
                        utils.extend(this.beziers, build.new_beziers_for_segments(seg_o, r_id));
                        if (reaction_ids_to_draw.indexOf(segment_obj.reaction_id) == -1)
                            reaction_ids_to_draw.push(segment_obj.reaction_id);
                    }
                    if (this.has_data_on_reactions) {
                        var scale_changed = this.calc_data_stats('reaction');
                        if (scale_changed) this.draw_all_reactions(true, false);
                        else this.draw_these_reactions(reaction_ids_to_draw);
                    } else {
                        if (should_draw) this.draw_these_reactions(reaction_ids_to_draw);
                    }
                    if (this.has_data_on_nodes) {
                        var scale_changed = this.calc_data_stats('metabolite');
                        if (should_draw) {
                            if (scale_changed) this.draw_all_nodes(false);
                            else this.draw_these_nodes(Object.keys(saved_nodes));
                        }
                    } else {
                        if (should_draw) this.draw_these_nodes(Object.keys(saved_nodes));
                    }
                    utils.extend(this.text_labels, saved_text_labels);
                    if (should_draw) this.draw_these_text_labels(Object.keys(saved_text_labels));
                    selected_text_labels = utils.clone(saved_text_labels);
                    selected_nodes = utils.clone(saved_nodes);
                    segment_objs_w_segments = utils.clone(saved_segment_objs_w_segments);
                    reactions = utils.clone(saved_reactions);
                }.bind(this), function() {
                    delete_and_draw(selected_nodes, reactions, segment_objs_w_segments, selected_text_labels);
                }.bind(this));
            }

            function delete_node_data(node_ids) {
                node_ids.forEach(function(node_id) {
                    if (this.enable_search && this.nodes[node_id].node_type == 'metabolite') {
                        var found = (this.search_index.remove('n' + node_id) && this.search_index.remove('n_name' + node_id));
                        if (!found)
                            console.warn('Could not find deleted metabolite in search index');
                    }
                    delete this.nodes[node_id];
                }.bind(this));
            }

            function delete_segment_data(segment_objs) {
                for (var segment_id in segment_objs) {
                    var segment_obj = segment_objs[segment_id];
                    var reaction = this.reactions[segment_obj.reaction_id];
                    if (!(segment_obj.segment_id in reaction.segments)) return;
                    var segment = reaction.segments[segment_obj.segment_id];
                    [segment.from_node_id, segment.to_node_id].forEach(function(node_id) {
                        if (!(node_id in this.nodes)) return;
                        var node = this.nodes[node_id];
                        node.connected_segments = node.connected_segments.filter(function(so) {
                            return so.segment_id != segment_obj.segment_id;
                        });
                    }.bind(this));
                    ['b1', 'b2'].forEach(function(bez) {
                        var bez_id = build.bezier_id_for_segment_id(segment_obj.segment_id, bez);
                        delete this.beziers[bez_id];
                    }.bind(this));
                    delete reaction.segments[segment_obj.segment_id];
                }
            }

            function delete_reaction_data(reaction_ids) {
                reaction_ids.forEach(function(reaction_id) {
                    var reaction = this.reactions[reaction_id];
                    for (var segment_id in reaction.segments) {
                        ['b1', 'b2'].forEach(function(bez) {
                            var bez_id = build.bezier_id_for_segment_id(segment_id, bez);
                            delete this.beziers[bez_id];
                        }.bind(this));
                    }
                    delete this.reactions[reaction_id];
                    var found = (this.search_index.remove('r' + reaction_id) && this.search_index.remove('r_name' + reaction_id));
                    if (!found)
                        console.warn('Could not find deleted reaction ' +
                            reaction_id + ' in search index');
                    for (var g_id in reaction.genes) {
                        var found = (this.search_index.remove('r' + reaction_id + '_g' + g_id) && this.search_index.remove('r' + reaction_id + '_g_name' + g_id));
                        if (!found)
                            console.warn('Could not find deleted gene ' +
                                g_id + ' in search index');
                    }
                }.bind(this));
            }

            function delete_text_label_data(text_label_ids) {
                text_label_ids.forEach(function(text_label_id) {
                    delete this.text_labels[text_label_id];
                    var found = this.search_index.remove('l' + text_label_id);
                    if (!found)
                        console.warn('Could not find deleted text label in search index');
                }.bind(this));
            }

            function new_reaction_from_scratch(starting_reaction, coords, direction) {
                if (!this.cobra_model) {
                    console.error('No CobraModel. Cannot build new reaction')
                    return
                }
                var cobra_reaction = utils.clone(this.cobra_model.reactions[starting_reaction])
                if (_.size(cobra_reaction.metabolites) === 0)
                    throw Error('No metabolites in reaction ' + cobra_reaction.bigg_id)
                var reactant_ids = _.map(cobra_reaction.metabolites, function(coeff, met_id) {
                    return [coeff, met_id]
                }).filter(function(x) {
                    return x[0] < 0
                }).map(function(x) {
                    return x[1]
                })
                var metabolite_id = (reactant_ids.length > 0 ? reactant_ids[0] : Object.keys(cobra_reaction.metabolites)[0])
                var metabolite = this.cobra_model.metabolites[metabolite_id]
                var selected_node_id = String(++this.largest_ids.nodes)
                var label_d = {
                    x: 30,
                    y: 10
                }
                var selected_node = {
                    connected_segments: [],
                    x: coords.x,
                    y: coords.y,
                    node_is_primary: true,
                    label_x: coords.x + label_d.x,
                    label_y: coords.y + label_d.y,
                    name: metabolite.name,
                    bigg_id: metabolite_id,
                    node_type: 'metabolite'
                }
                var new_nodes = {}
                new_nodes[selected_node_id] = selected_node
                extend_and_draw_metabolite.apply(this, [new_nodes, selected_node_id])
                var saved_nodes = utils.clone(new_nodes)
                var out = this.new_reaction_for_metabolite(starting_reaction, selected_node_id, direction, false),
                    reaction_redo = out.redo,
                    reaction_undo = out.undo
                this.undo_stack.push(function() {
                    reaction_undo()
                    this.delete_node_data(Object.keys(new_nodes))
                    new_nodes = utils.clone(saved_nodes)
                    this.clear_deleted_nodes()
                    this.deselect_nodes()
                }.bind(this), function() {
                    extend_and_draw_metabolite.apply(this, [new_nodes, selected_node_id])
                    reaction_redo()
                }.bind(this))
                return

                function extend_and_draw_metabolite(new_nodes, selected_node_id) {
                    this.extend_nodes(new_nodes)
                    if (this.has_data_on_nodes) {
                        var scale_changed = this.apply_metabolite_data_to_nodes(new_nodes)
                        if (scale_changed) this.draw_all_nodes(false)
                        else this.draw_these_nodes([selected_node_id])
                    } else {
                        this.draw_these_nodes([selected_node_id])
                    }
                }
            }

            function extend_nodes(new_nodes) {
                if (this.enable_search) {
                    for (var node_id in new_nodes) {
                        var node = new_nodes[node_id];
                        if (node.node_type != 'metabolite')
                            continue;
                        this.search_index.insert('n' + node_id, {
                            'name': node.bigg_id,
                            'data': {
                                type: 'metabolite',
                                node_id: node_id
                            }
                        });
                        this.search_index.insert('n_name' + node_id, {
                            'name': node.name,
                            'data': {
                                type: 'metabolite',
                                node_id: node_id
                            }
                        });
                    }
                }
                utils.extend(this.nodes, new_nodes);
            }

            function extend_reactions(new_reactions) {
                if (this.enable_search) {
                    for (var r_id in new_reactions) {
                        var reaction = new_reactions[r_id];
                        this.search_index.insert('r' + r_id, {
                            'name': reaction.bigg_id,
                            'data': {
                                type: 'reaction',
                                reaction_id: r_id
                            }
                        });
                        this.search_index.insert('r_name' + r_id, {
                            'name': reaction.name,
                            'data': {
                                type: 'reaction',
                                reaction_id: r_id
                            }
                        });
                        for (var g_id in reaction.genes) {
                            var gene = reaction.genes[g_id];
                            this.search_index.insert('r' + r_id + '_g' + g_id, {
                                'name': gene.bigg_id,
                                'data': {
                                    type: 'reaction',
                                    reaction_id: r_id
                                }
                            });
                            this.search_index.insert('r' + r_id + '_g_name' + g_id, {
                                'name': gene.name,
                                'data': {
                                    type: 'reaction',
                                    reaction_id: r_id
                                }
                            });
                        }
                    }
                }
                utils.extend(this.reactions, new_reactions);
            }

            function new_reaction_for_metabolite(reaction_bigg_id, selected_node_id, direction, apply_undo_redo) {
                if (apply_undo_redo === undefined) apply_undo_redo = true;
                var selected_node = this.nodes[selected_node_id];
                var cobra_reaction = this.cobra_model.reactions[reaction_bigg_id];
                var out = build.new_reaction(reaction_bigg_id, cobra_reaction, this.cobra_model.metabolites, selected_node_id, utils.clone(selected_node), this.largest_ids, this.settings.get_option('cofactors'), direction),
                    new_nodes = out.new_nodes,
                    new_reactions = out.new_reactions,
                    new_beziers = out.new_beziers;
                extend_and_draw_reaction.apply(this, [new_nodes, new_reactions, new_beziers, selected_node_id]);
                var saved_nodes = utils.clone(new_nodes),
                    saved_reactions = utils.clone(new_reactions),
                    saved_beziers = utils.clone(new_beziers);
                var undo_fn = function() {
                        delete new_nodes[selected_node_id];
                        this.delete_node_data(Object.keys(new_nodes));
                        this.delete_reaction_data(Object.keys(new_reactions));
                        select_metabolite_with_id.apply(this, [selected_node_id]);
                        new_nodes = utils.clone(saved_nodes);
                        new_reactions = utils.clone(saved_reactions);
                        new_beziers = utils.clone(saved_beziers);
                        if (this.has_data_on_reactions) {
                            var scale_changed = this.calc_data_stats('reaction');
                            if (scale_changed) this.draw_all_reactions(true, true);
                            else this.draw_these_reactions(Object.keys(new_reactions));
                        } else {
                            this.clear_deleted_reactions(true);
                        }
                        if (this.has_data_on_nodes) {
                            var scale_changed = this.calc_data_stats('metabolite');
                            if (scale_changed) this.draw_all_nodes(true);
                            else this.draw_these_nodes(Object.keys(new_nodes));
                        } else {
                            this.clear_deleted_nodes();
                        }
                    }.bind(this),
                    redo_fn = function() {
                        extend_and_draw_reaction.apply(this, [new_nodes, new_reactions, new_beziers, selected_node_id]);
                    }.bind(this);
                if (apply_undo_redo)
                    this.undo_stack.push(undo_fn, redo_fn);
                return {
                    undo: undo_fn,
                    redo: redo_fn
                };

                function extend_and_draw_reaction(new_nodes, new_reactions, new_beziers, selected_node_id) {
                    this.extend_reactions(new_reactions);
                    utils.extend(this.beziers, new_beziers);
                    this.delete_node_data([selected_node_id]);
                    this.extend_nodes(new_nodes);
                    if (this.has_data_on_reactions) {
                        var scale_changed = this.calc_data_stats('reaction');
                        if (scale_changed) this.draw_all_reactions(true, false);
                        else this.draw_these_reactions(Object.keys(new_reactions));
                    } else {
                        this.draw_these_reactions(Object.keys(new_reactions));
                    }
                    if (this.has_data_on_nodes) {
                        var scale_changed = this.calc_data_stats('metabolite');
                        if (scale_changed) this.draw_all_nodes(false);
                        else this.draw_these_nodes(Object.keys(new_nodes));
                    } else {
                        this.draw_these_nodes(Object.keys(new_nodes));
                    }
                    for (var node_id in new_nodes) {
                        var node = new_nodes[node_id];
                        if (node.node_is_primary && node_id != selected_node_id) {
                            this.select_metabolite_with_id(node_id);
                            var new_coords = {
                                x: node.x,
                                y: node.y
                            };
                            if (this.zoom_container)
                                this.zoom_container.translate_off_screen(new_coords);
                        }
                    }
                }
            }

            function cycle_primary_node() {
                var selected_nodes = this.get_selected_nodes();
                var node_id = Object.keys(selected_nodes)[0],
                    node = selected_nodes[node_id],
                    reactions = this.reactions,
                    nodes = this.nodes;
                var connected_anchor_ids = [],
                    reactions_to_draw;
                nodes[node_id].connected_segments.forEach(function(segment_info) {
                    reactions_to_draw = [segment_info.reaction_id];
                    var segment;
                    try {
                        segment = reactions[segment_info.reaction_id].segments[segment_info.segment_id];
                        if (segment === undefined) throw new Error('undefined segment');
                    } catch (e) {
                        console.warn('Could not find connected segment ' + segment_info.segment_id);
                        return;
                    }
                    connected_anchor_ids.push(segment.from_node_id == node_id ? segment.to_node_id : segment.from_node_id);
                });
                if (connected_anchor_ids.length != 1) {
                    console.error('Only connected nodes with a single reaction can be selected');
                    return;
                }
                var connected_anchor_id = connected_anchor_ids[0];
                var related_node_ids = [node_id];
                var segments = [];
                nodes[connected_anchor_id].connected_segments.forEach(function(segment_info) {
                    var segment;
                    try {
                        segment = reactions[segment_info.reaction_id].segments[segment_info.segment_id];
                        if (segment === undefined) throw new Error('undefined segment');
                    } catch (e) {
                        console.warn('Could not find connected segment ' + segment_info.segment_id);
                        return;
                    }
                    var conn_met_id = segment.from_node_id == connected_anchor_id ? segment.to_node_id : segment.from_node_id,
                        conn_node = nodes[conn_met_id];
                    if (conn_node.node_type == 'metabolite' && conn_met_id != node_id) {
                        related_node_ids.push(String(conn_met_id));
                    }
                });
                for (var i = 0; i < related_node_ids.length; i++) {
                    if (nodes[related_node_ids[i]].connected_segments.length > 1) {
                        console.error('Only connected nodes with a single reaction can be selected');
                        return;
                    }
                }
                for (var a_selected_node_id in selected_nodes) {
                    if (a_selected_node_id != node_id && related_node_ids.indexOf(a_selected_node_id) == -1) {
                        console.warn('Selected nodes are not on the same reaction');
                        return;
                    }
                }
                var nodes_to_draw = [],
                    last_i = related_node_ids.length - 1,
                    last_node = nodes[related_node_ids[last_i]],
                    last_is_primary = last_node.node_is_primary,
                    last_coords = {
                        x: last_node.x,
                        y: last_node.y,
                        label_x: last_node.label_x,
                        label_y: last_node.label_y
                    };
                if (last_node.connected_segments.length > 1)
                    console.warn('Too many connected segments for node ' + last_node.node_id);
                var last_segment_info = last_node.connected_segments[0],
                    last_segment;
                try {
                    last_segment = reactions[last_segment_info.reaction_id].segments[last_segment_info.segment_id];
                    if (last_segment === undefined) throw new Error('undefined segment');
                } catch (e) {
                    console.error('Could not find connected segment ' + last_segment_info.segment_id);
                    return;
                }
                var last_bezier = {
                        b1: last_segment.b1,
                        b2: last_segment.b2
                    },
                    primary_node_id;
                related_node_ids.forEach(function(related_node_id) {
                    var node = nodes[related_node_id],
                        this_is_primary = node.node_is_primary,
                        these_coords = {
                            x: node.x,
                            y: node.y,
                            label_x: node.label_x,
                            label_y: node.label_y
                        },
                        this_segment_info = node.connected_segments[0],
                        this_segment = reactions[this_segment_info.reaction_id].segments[this_segment_info.segment_id],
                        this_bezier = {
                            b1: this_segment.b1,
                            b2: this_segment.b2
                        };
                    node.node_is_primary = last_is_primary;
                    node.x = last_coords.x;
                    node.y = last_coords.y;
                    node.label_x = last_coords.label_x;
                    node.label_y = last_coords.label_y;
                    this_segment.b1 = last_bezier.b1;
                    this_segment.b2 = last_bezier.b2;
                    last_is_primary = this_is_primary;
                    last_coords = these_coords;
                    last_bezier = this_bezier;
                    if (node.node_is_primary) primary_node_id = related_node_id;
                    nodes_to_draw.push(related_node_id);
                });
                var old_connected_segments = nodes[connected_anchor_id].connected_segments,
                    last_i = old_connected_segments.length - 1,
                    new_connected_segments = [old_connected_segments[last_i]];
                old_connected_segments.forEach(function(segment, i) {
                    if (last_i == i) return;
                    new_connected_segments.push(segment);
                });
                nodes[connected_anchor_id].connected_segments = new_connected_segments;
                this.draw_these_nodes(nodes_to_draw);
                this.draw_these_reactions(reactions_to_draw);
                this.select_metabolite_with_id(primary_node_id);
                return;
            }

            function toggle_selected_node_primary() {
                var selected_node_ids = this.get_selected_node_ids(),
                    go = function(ids) {
                        var nodes_to_draw = {},
                            hide_secondary_metabolites = this.settings.get_option('hide_secondary_metabolites');
                        ids.forEach(function(id) {
                            if (!(id in this.nodes)) {
                                console.warn('Could not find node: ' + id);
                                return;
                            }
                            var node = this.nodes[id];
                            if (node.node_type == 'metabolite') {
                                node.node_is_primary = !node.node_is_primary;
                                nodes_to_draw[id] = node;
                            }
                        }.bind(this));
                        this.draw_these_nodes(Object.keys(nodes_to_draw));
                        if (hide_secondary_metabolites) {
                            var out = this.segments_and_reactions_for_nodes(nodes_to_draw),
                                reaction_ids_to_draw_o = {};
                            for (var id in out.segment_objs_w_segments) {
                                var r_id = out.segment_objs_w_segments[id].reaction_id;
                                reaction_ids_to_draw_o[r_id] = true;
                            }
                            this.draw_these_reactions(Object.keys(reaction_ids_to_draw_o));
                        }
                    }.bind(this);
                go(selected_node_ids);
                this.undo_stack.push(function() {
                    go(selected_node_ids);
                }, function() {
                    go(selected_node_ids);
                });
            }

            function segments_and_reactions_for_nodes(nodes) {
                var segment_objs_w_segments = {},
                    these_reactions = {},
                    segment_ids_for_reactions = {},
                    reactions = this.reactions;
                for (var node_id in nodes) {
                    var node = nodes[node_id];
                    node.connected_segments.forEach(function(segment_obj) {
                        var segment;
                        try {
                            segment = reactions[segment_obj.reaction_id].segments[segment_obj.segment_id];
                            if (segment === undefined) throw new Error('undefined segment');
                        } catch (e) {
                            console.warn('Could not find connected segments for node');
                            return;
                        }
                        var segment_obj_w_segment = utils.clone(segment_obj);
                        segment_obj_w_segment['segment'] = utils.clone(segment);
                        segment_objs_w_segments[segment_obj.segment_id] = segment_obj_w_segment;
                        if (!(segment_obj.reaction_id in segment_ids_for_reactions))
                            segment_ids_for_reactions[segment_obj.reaction_id] = [];
                        segment_ids_for_reactions[segment_obj.reaction_id].push(segment_obj.segment_id);
                    });
                }
                for (var reaction_id in segment_ids_for_reactions) {
                    var reaction = reactions[reaction_id],
                        these_ids = segment_ids_for_reactions[reaction_id],
                        has = true;
                    for (var segment_id in reaction.segments) {
                        if (these_ids.indexOf(segment_id) == -1) has = false;
                    }
                    if (has) these_reactions[reaction_id] = reaction;
                }
                return {
                    segment_objs_w_segments: segment_objs_w_segments,
                    reactions: these_reactions
                };
            }

            function new_text_label(coords, text) {
                var out = build.new_text_label(this.largest_ids, text, coords);
                this.text_labels[out.id] = out.label;
                var sel = this.draw_these_text_labels([out.id]);
                this.search_index.insert('l' + out.id, {
                    'name': text,
                    'data': {
                        type: 'text_label',
                        text_label_id: out.id
                    }
                });
                return out.id;
            }

            function edit_text_label(text_label_id, new_value, should_draw) {
                var saved_value = this.text_labels[text_label_id].text,
                    edit_and_draw = function(new_val, should_draw) {
                        this.text_labels[text_label_id].text = new_val;
                        if (should_draw) this.draw_these_text_labels([text_label_id]);
                        var record_id = 'l' + text_label_id,
                            found = this.search_index.remove(record_id);
                        if (!found)
                            console.warn('Could not find modified text label in search index');
                        this.search_index.insert(record_id, {
                            'name': new_val,
                            'data': {
                                type: 'text_label',
                                text_label_id: text_label_id
                            }
                        });
                    }.bind(this);
                edit_and_draw(new_value, should_draw);
                this.undo_stack.push(function() {
                    edit_and_draw(saved_value, should_draw);
                }, function() {
                    edit_and_draw(new_value, should_draw);
                });
            }

            function zoom_extent_nodes(margin) {
                this._zoom_extent(margin, 'nodes');
            }

            function zoom_extent_canvas(margin) {
                this._zoom_extent(margin, 'canvas');
            }

            function _zoom_extent(margin, mode) {
                if (_.isUndefined(margin)) margin = (mode == 'nodes' ? 0.2 : 0);
                if (_.isUndefined(mode)) mode = 'canvas';
                var new_zoom, new_pos, size = this.get_size();
                margin = margin * size.height;
                if (mode == 'nodes') {
                    var min = {
                            x: null,
                            y: null
                        },
                        max = {
                            x: null,
                            y: null
                        };
                    for (var node_id in this.nodes) {
                        var node = this.nodes[node_id];
                        if (min.x === null) min.x = node.x;
                        if (min.y === null) min.y = node.y;
                        if (max.x === null) max.x = node.x;
                        if (max.y === null) max.y = node.y;
                        min.x = Math.min(min.x, node.x);
                        min.y = Math.min(min.y, node.y);
                        max.x = Math.max(max.x, node.x);
                        max.y = Math.max(max.y, node.y);
                    }
                    new_zoom = Math.min((size.width - margin * 2) / (max.x - min.x), (size.height - margin * 2) / (max.y - min.y));
                    new_pos = {
                        x: -(min.x * new_zoom) + margin + ((size.width - margin * 2 - (max.x - min.x) * new_zoom) / 2),
                        y: -(min.y * new_zoom) + margin + ((size.height - margin * 2 - (max.y - min.y) * new_zoom) / 2)
                    };
                } else if (mode == 'canvas') {
                    new_zoom = Math.min((size.width - margin * 2) / (this.canvas.width), (size.height - margin * 2) / (this.canvas.height));
                    new_pos = {
                        x: -(this.canvas.x * new_zoom) + margin + ((size.width - margin * 2 - this.canvas.width * new_zoom) / 2),
                        y: -(this.canvas.y * new_zoom) + margin + ((size.height - margin * 2 - this.canvas.height * new_zoom) / 2)
                    };
                } else {
                    return console.error('Did not recognize mode');
                }
                this.zoom_container.go_to(new_zoom, new_pos);
                return null;
            }

            function get_size() {
                return this.zoom_container.get_size();
            }

            function zoom_to_reaction(reaction_id) {
                var reaction = this.reactions[reaction_id],
                    new_zoom = 0.5,
                    size = this.get_size(),
                    new_pos = {
                        x: -reaction.label_x * new_zoom + size.width / 2,
                        y: -reaction.label_y * new_zoom + size.height / 2
                    };
                this.zoom_container.go_to(new_zoom, new_pos);
            }

            function zoom_to_node(node_id) {
                var node = this.nodes[node_id],
                    new_zoom = 0.5,
                    size = this.get_size(),
                    new_pos = {
                        x: -node.label_x * new_zoom + size.width / 2,
                        y: -node.label_y * new_zoom + size.height / 2
                    };
                this.zoom_container.go_to(new_zoom, new_pos);
            }

            function zoom_to_text_label(text_label_id) {
                var text_label = this.text_labels[text_label_id],
                    new_zoom = 0.5,
                    size = this.get_size(),
                    new_pos = {
                        x: -text_label.x * new_zoom + size.width / 2,
                        y: -text_label.y * new_zoom + size.height / 2
                    };
                this.zoom_container.go_to(new_zoom, new_pos);
            }

            function highlight_reaction(reaction_id) {
                this.highlight(this.sel.selectAll('#r' + reaction_id).selectAll('text'));
            }

            function highlight_node(node_id) {
                this.highlight(this.sel.selectAll('#n' + node_id).selectAll('text'));
            }

            function highlight_text_label(text_label_id) {
                this.highlight(this.sel.selectAll('#l' + text_label_id).selectAll('text'));
            }

            function highlight(sel) {
                this.sel.selectAll('.highlight').classed('highlight', false);
                if (sel !== null) {
                    sel.classed('highlight', true);
                }
            }

            function full_screen_event() {
                if (document.fullscreenEnabled) return 'fullscreenchange'
                else if (document.mozFullScreenEnabled) return 'mozfullscreenchange'
                else if (document.webkitFullscreenEnabled) return 'webkitfullscreenchange'
                else if (document.msFullscreenEnabled) return 'MSFullscreenChange'
                else return null
            }

            function listen_for_full_screen(fn) {
                document.addEventListener(full_screen_event(), fn)
                this.full_screen_listener = fn
            }

            function unlisten_for_full_screen() {
                document.removeEventListener(full_screen_event(), this.full_screen_listener)
            }

            function full_screen() {
                var sel = this.zoom_container.selection
                var e = sel.node()
                var d = document
                var full_screen_on = (d.fullscreenElement || d.mozFullScreenElement || d.webkitFullscreenElement || d.msFullscreenElement)
                if (full_screen_on) {
                    sel.classed('full-screen-on', false)
                    if (d.exitFullscreen) d.exitFullscreen()
                    else if (d.mozCancelFullScreen) d.mozCancelFullScreen()
                    else if (d.webkitExitFullscreen) d.webkitExitFullscreen()
                    else if (d.msExitFullscreen) d.msExitFullscreen()
                    else throw Error('Cannot exit full screen')
                } else {
                    sel.classed('full-screen-on', true)
                    if (e.requestFullscreen) e.requestFullscreen()
                    else if (e.mozRequestFullScreen) e.mozRequestFullScreen()
                    else if (e.webkitRequestFullscreen) e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)
                    else if (e.msRequestFullscreen) e.msRequestFullscreen()
                    else throw Error('Full screen does not seem to be supported on this system.')
                }
            }

            function save() {
                utils.download_json(this.map_for_export(), this.map_name);
            }

            function map_for_export() {
                var out = [{
                    "map_name": this.map_name,
                    "map_id": this.map_id,
                    "map_description": this.map_description,
                    "homepage": "https://escher.github.io",
                    "schema": "https://escher.github.io/escher/jsonschema/1-0-0#"
                }, {
                    reactions: utils.clone(this.reactions),
                    nodes: utils.clone(this.nodes),
                    text_labels: utils.clone(this.text_labels),
                    canvas: this.canvas.size_and_location()
                }];
                for (var r_id in out[1].reactions) {
                    var reaction = out[1].reactions[r_id],
                        new_reaction = {};
                    ['name', 'bigg_id', 'reversibility', 'label_x', 'label_y', 'gene_reaction_rule', 'genes', 'metabolites'].forEach(function(attr) {
                        new_reaction[attr] = reaction[attr];
                    });
                    new_reaction['segments'] = {};
                    for (var s_id in reaction.segments) {
                        var segment = reaction.segments[s_id],
                            new_segment = {};
                        ['from_node_id', 'to_node_id', 'b1', 'b2'].forEach(function(attr) {
                            new_segment[attr] = segment[attr];
                        });
                        new_reaction['segments'][s_id] = new_segment;
                    }
                    out[1].reactions[r_id] = new_reaction;
                }
                for (var n_id in out[1].nodes) {
                    var node = out[1].nodes[n_id],
                        new_node = {},
                        attrs;
                    if (node.node_type == 'metabolite') {
                        attrs = ['node_type', 'x', 'y', 'bigg_id', 'name', 'label_x', 'label_y', 'node_is_primary'];
                    } else {
                        attrs = ['node_type', 'x', 'y'];
                    }
                    attrs.forEach(function(attr) {
                        new_node[attr] = node[attr];
                    });
                    out[1].nodes[n_id] = new_node;
                }
                for (var t_id in out[1].text_labels) {
                    var text_label = out[1].text_labels[t_id],
                        new_text_label = {},
                        attrs = ["x", "y", "text"];
                    attrs.forEach(function(attr) {
                        new_text_label[attr] = text_label[attr];
                    });
                    out[1].text_labels[t_id] = new_text_label;
                }
                var canvas_el = out[1].canvas,
                    new_canvas_el = {},
                    attrs = ["x", "y", "width", "height"];
                attrs.forEach(function(attr) {
                    new_canvas_el[attr] = canvas_el[attr];
                });
                out[1].canvas = new_canvas_el;
                return out;
            }

            function save_map(obj, callback_before, callback_after, map_type) {
                obj.callback_manager.run(callback_before);
                var window_scale = obj.zoom_container.window_scale,
                    window_translate = obj.zoom_container.window_translate,
                    canvas_size_and_loc = obj.canvas.size_and_location(),
                    mouse_node_size_and_trans = {
                        w: obj.canvas.mouse_node.attr('width'),
                        h: obj.canvas.mouse_node.attr('height'),
                        transform: obj.canvas.mouse_node.attr('transform')
                    };
                obj.zoom_container._go_to_svg(1.0, {
                    x: -canvas_size_and_loc.x,
                    y: -canvas_size_and_loc.y
                }, function() {
                    obj.svg.attr('width', canvas_size_and_loc.width);
                    obj.svg.attr('height', canvas_size_and_loc.height);
                    obj.canvas.mouse_node.attr('width', '0px');
                    obj.canvas.mouse_node.attr('height', '0px');
                    obj.canvas.mouse_node.attr('transform', null);
                    var hidden_sel = obj.sel.selectAll('.multimarker-circle,.midmarker-circle,#canvas').style('visibility', 'hidden');
                    if (map_type == 'svg') {
                        utils.download_svg('saved_map', obj.svg, true);
                    } else if (map_type == 'png') {
                        utils.download_png('saved_map', obj.svg, true);
                    }
                    obj.zoom_container._go_to_svg(window_scale, window_translate, function() {
                        obj.svg.attr('width', null);
                        obj.svg.attr('height', null);
                        obj.canvas.mouse_node.attr('width', mouse_node_size_and_trans.w);
                        obj.canvas.mouse_node.attr('height', mouse_node_size_and_trans.h);
                        obj.canvas.mouse_node.attr('transform', mouse_node_size_and_trans.transform);
                        hidden_sel.style('visibility', null);
                        obj.callback_manager.run(callback_after);
                    }.bind(obj));
                }.bind(obj));
            }

            function save_svg() {
                save_map(this, 'before_svg_export', 'after_svg_export', 'svg');
            }

            function save_png() {
                save_map(this, 'before_png_export', 'after_png_export', 'png');
            }

            function convert_map() {
                this.callback_manager.run('before_convert_map');
                if (!this.has_cobra_model()) throw Error('No COBRA model loaded.');
                var model = this.cobra_model;
                var reactions_not_found = {},
                    reaction_attrs = ['name', 'gene_reaction_rule', 'genes'],
                    met_nodes_not_found = {},
                    metabolite_attrs = ['name'],
                    found;
                for (var reaction_id in this.reactions) {
                    var reaction = this.reactions[reaction_id];
                    found = false;
                    for (var model_reaction_id in model.reactions) {
                        var model_reaction = model.reactions[model_reaction_id];
                        if (model_reaction.bigg_id == reaction.bigg_id) {
                            reaction_attrs.forEach(function(attr) {
                                reaction[attr] = model_reaction[attr];
                            });
                            found = true;
                        }
                    }
                    if (!found)
                        reactions_not_found[reaction_id] = true;
                }
                for (var node_id in this.nodes) {
                    var node = this.nodes[node_id];
                    if (node.node_type != 'metabolite') continue;
                    found = false;
                    for (var model_metabolite_id in model.metabolites) {
                        var model_metabolite = model.metabolites[model_metabolite_id];
                        if (model_metabolite.bigg_id == node.bigg_id) {
                            metabolite_attrs.forEach(function(attr) {
                                node[attr] = model_metabolite[attr];
                            });
                            found = true;
                        }
                    }
                    if (!found)
                        met_nodes_not_found[node_id] = true;
                }
                var n_reactions_not_found = Object.keys(reactions_not_found).length,
                    n_met_nodes_not_found = Object.keys(met_nodes_not_found).length,
                    status_delay = 3000;
                if (n_reactions_not_found == 0 && n_met_nodes_not_found == 0) {
                    this.set_status('Successfully converted attributes.', status_delay);
                } else if (n_met_nodes_not_found == 0) {
                    this.set_status('Converted attributes, but count not find ' + n_reactions_not_found + ' reactions in the model.', status_delay);
                    this.settings.set_conditional('highlight_missing', true);
                } else if (n_reactions_not_found == 0) {
                    this.set_status('Converted attributes, but count not find ' + n_met_nodes_not_found + ' metabolites in the model.', status_delay);
                    this.settings.set_conditional('highlight_missing', true);
                } else {
                    this.set_status('Converted attributes, but count not find ' + n_reactions_not_found + ' reactions and ' + n_met_nodes_not_found + ' metabolites in the model.', status_delay);
                    this.settings.set_conditional('highlight_missing', true);
                }
                this.draw_everything();
                this.callback_manager.run('after_convert_map');
            }
        }, {
            "./Behavior": 1,
            "./CallbackManager": 5,
            "./Canvas": 6,
            "./Draw": 10,
            "./KeyManager": 11,
            "./Scale": 15,
            "./SearchIndex": 18,
            "./UndoStack": 22,
            "./build": 24,
            "./data_styles": 26,
            "./utils": 31,
            "baconjs": 32,
            "underscore": 35
        }],
        13: [function(require, module, exports) {
            var utils = require('./utils');
            var PlacedDiv = utils.make_class();
            PlacedDiv.prototype = {
                init: init,
                is_visible: is_visible,
                place: place,
                hide: hide
            };
            module.exports = PlacedDiv;

            function init(div, map, displacement) {
                this.div = div;
                if (displacement === undefined)
                    displacement = {
                        x: 0,
                        y: 0
                    };
                this.displacement = displacement;
                this.map = map;
            }

            function is_visible() {
                return this.div.style('display') != 'none';
            }

            function place(coords) {
                this.div.style('display', null);
                var window_translate = this.map.zoom_container.window_translate,
                    window_scale = this.map.zoom_container.window_scale,
                    map_size = this.map.get_size(),
                    left = Math.max(20, Math.min(map_size.width - 270, (window_scale * coords.x + window_translate.x - this.displacement.x))),
                    top = Math.max(20, Math.min(map_size.height - 40, (window_scale * coords.y + window_translate.y - this.displacement.y)));
                this.div.style('position', 'absolute').style('display', 'block').style('left', left + 'px').style('top', top + 'px');
            }

            function hide() {
                this.div.style('display', 'none');
            }
        }, {
            "./utils": 31
        }],
        14: [function(require, module, exports) {
            var utils = require('./utils');
            var QuickJump = utils.make_class();
            QuickJump.prototype = {
                init: init,
                reset_selection: reset_selection,
                replace_state_for_map_name: replace_state_for_map_name
            };
            module.exports = QuickJump;

            function init(sel, load_callback) {
                var select_sel = sel.append('select').attr('id', 'quick-jump-menu').attr('class', 'form-control');
                this.selector = select_sel;
                var url_comp = utils.parse_url_components(window),
                    current = ('map_name' in url_comp) ? url_comp.map_name : null,
                    quick_jump_path = ('quick_jump_path' in url_comp) ? url_comp.quick_jump_path : null,
                    options = ('quick_jump' in url_comp) ? url_comp.quick_jump : [],
                    default_value = ' Jump to map ',
                    view_options = [default_value].concat(options);
                if (current !== null) {
                    view_options = view_options.filter(function(o) {
                        return o != current;
                    });
                }
                select_sel.selectAll('option').data(view_options).enter().append('option').text(function(d) {
                    return d.split('.').slice(-1)[0];
                });
                select_sel.style('display', view_options.length > 1 ? 'block' : 'none');
                var change_map = function(map_name) {
                    load_callback(map_name, quick_jump_path, function(success) {
                        if (success)
                            this.replace_state_for_map_name(map_name);
                        else
                            this.reset_selection();
                    }.bind(this));
                }.bind(this);
                select_sel.on('change', function() {
                    var map_name = this.options[this.selectedIndex].__data__;
                    change_map(map_name);
                });
            }

            function reset_selection() {
                this.selector.node().selectedIndex = 0;
            }

            function replace_state_for_map_name(map_name) {
                var url = window.location.href.replace(/(map_name=)([^&]+)(&|$)/, '$1' + map_name + '$3');
                window.history.replaceState('Not implemented', '', url);
            }
        }, {
            "./utils": 31
        }],
        15: [function(require, module, exports) {
            var utils = require('./utils');
            var Scale = utils.make_class();
            Scale.prototype = {
                init: init,
                connect_to_settings: connect_to_settings
            };
            module.exports = Scale;

            function init() {
                this.x = d3.scale.linear();
                this.y = d3.scale.linear();
                this.x_size = d3.scale.linear();
                this.y_size = d3.scale.linear();
                this.size = d3.scale.linear();
                this.reaction_color = d3.scale.linear().clamp(true);
                this.reaction_size = d3.scale.linear().clamp(true);
                this.metabolite_color = d3.scale.linear().clamp(true);
                this.metabolite_size = d3.scale.linear().clamp(true);
                this.scale_path = function(path) {
                    var x_fn = this.x,
                        y_fn = this.y;
                    var str = d3.format(".2f"),
                        path = path.replace(/(M|L)([0-9-.]+),?\s*([0-9-.]+)/g, function(match, p0, p1, p2) {
                            return p0 + [str(x_fn(parseFloat(p1))), str(y_fn(parseFloat(p2)))].join(', ');
                        }),
                        reg = /C([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)/g;
                    path = path.replace(reg, function(match, p1, p2, p3, p4, p5, p6) {
                        return 'C' + str(x_fn(parseFloat(p1))) + ',' +
                            str(y_fn(parseFloat(p2))) + ' ' +
                            str(x_fn(parseFloat(p3))) + ',' +
                            str(y_fn(parseFloat(p4))) + ' ' + [str(x_fn(parseFloat(p5))) + ',' + str(y_fn(parseFloat(p6)))];
                    });
                    return path;
                }.bind(this);
                this.scale_decimals = function(path, scale_fn, precision) {
                    var str = d3.format("." + String(precision) + "f");
                    path = path.replace(/([0-9.]+)/g, function(match, p1) {
                        return str(scale_fn(parseFloat(p1)));
                    });
                    return path;
                };
            }

            function connect_to_settings(settings, map, get_data_statistics) {
                var update_reaction = function(s) {
                    var out = sort_scale(s, get_data_statistics()['reaction']);
                    this.reaction_color.domain(out.domain);
                    this.reaction_size.domain(out.domain);
                    this.reaction_color.range(out.color_range);
                    this.reaction_size.range(out.size_range);
                }.bind(this);
                var update_metabolite = function(s) {
                    var out = sort_scale(s, get_data_statistics()['metabolite']);
                    this.metabolite_color.domain(out.domain);
                    this.metabolite_size.domain(out.domain);
                    this.metabolite_color.range(out.color_range);
                    this.metabolite_size.range(out.size_range);
                }.bind(this);
                settings.streams['reaction_scale'].onValue(update_reaction);
                settings.streams['metabolite_scale'].onValue(update_metabolite);
                map.callback_manager.set('calc_data_stats__reaction', function(changed) {
                    if (changed) update_reaction(settings.get_option('reaction_scale'));
                });
                map.callback_manager.set('calc_data_stats__metabolite', function(changed) {
                    if (changed) update_metabolite(settings.get_option('metabolite_scale'));
                });

                function sort_scale(scale, stats) {
                    var sorted = scale.map(function(x) {
                        var v;
                        if (x.type in stats)
                            v = stats[x.type];
                        else if (x.type == 'value')
                            v = x.value;
                        else
                            throw new Error('Bad domain type ' + x.type);
                        return {
                            v: v,
                            color: x.color,
                            size: x.size
                        };
                    }).sort(function(a, b) {
                        return a.v - b.v;
                    });
                    return {
                        domain: sorted.map(function(x) {
                            return x.v;
                        }),
                        color_range: sorted.map(function(x) {
                            return x.color;
                        }),
                        size_range: sorted.map(function(x) {
                            return x.size;
                        })
                    };
                }
            }
        }, {
            "./utils": 31
        }],
        16: [function(require, module, exports) {
            var utils = require('./utils');
            var bacon = require('baconjs');
            var ScaleEditor = utils.make_class();
            ScaleEditor.prototype = {
                init: init,
                update: update,
                update_no_data: update_no_data,
                _data_not_loaded: _data_not_loaded
            };
            module.exports = ScaleEditor;

            function init(sel, type, settings, get_data_statistics) {
                var grad_id = 'grad' + type + this.unique_string;
                this.w = 400;
                this.h = 30;
                this.x = 20;
                this.input_width = 90;
                this.input_height = 24;
                var b = sel.append('div').attr('class', 'scale-editor');
                this.data_not_loaded = b.append('div').attr('class', 'data-not-loaded').text((type == 'reaction' ? 'Reaction and gene' : 'Metabolite') + ' data not loaded');
                this.input_label_group = b.append('div').attr('class', 'input-label-group');
                var nd = b.append('div').style('top', this.input_height * 3 + 56 + 10 + 'px').attr('class', 'no-data');
                nd.append('span').text('Styles for ' + type + 's with no data').attr('class', 'no-data-heading');
                this.no_data_container = nd.append('div');
                var c = b.append('div').attr('class', 'centered');
                this.add_group = c.append('div');
                this.trash_group = c.append('div').attr('class', 'trash-container');
                var svg = c.append('svg').attr('class', 'scale-svg');
                this.input_group = c.append('div').attr('class', 'input-container');
                this.gradient = svg.append('defs').append('linearGradient').attr('id', grad_id);
                svg.append('rect').attr('class', 'rect').attr('fill', 'url(#' + grad_id + ')').attr('width', this.w + 'px').attr('height', this.h + 'px').attr('x', this.x + 'px'), this.pickers_group = svg.append('g');
                this.type = type;
                this.settings = settings;
                this.get_data_statistics = get_data_statistics;
                var unique_map_id = this.settings.get_option('unique_map_id');
                this.unique_string = (unique_map_id === null ? '' : '.' + unique_map_id);
                this.no_data = {};
                ['color', 'size'].forEach(function(s) {
                    this.no_data[s] = null;
                    this.settings.streams[this.type + '_no_data_' + s].onValue(function(val) {
                        this.no_data[s] = val;
                        this.update_no_data();
                    }.bind(this));
                }.bind(this));
                this.settings.streams[type + '_scale'].onValue(function(scale) {
                    this.scale = scale;
                    this.update();
                }.bind(this));
            }

            function update() {
                var scale = this.scale,
                    stats = this.get_data_statistics()[this.type],
                    bar_w = 14,
                    bar_h = 35,
                    x_disp = this.x,
                    data_not_loaded = this._data_not_loaded();
                if (data_not_loaded) {
                    scale = [{
                        type: 'min',
                        'color': null,
                        'size': null
                    }, {
                        type: 'max',
                        'color': null,
                        'size': null
                    }];
                    stats = {
                        'min': 0,
                        'max': 1
                    };
                }
                var sc = d3.scale.linear().domain([0, this.w]).range([stats.min, stats.max]),
                    sc_size = d3.scale.linear().domain([0, this.w]).range([0, stats.max - stats.min]);
                var bring_to_front = function(d, i) {
                    this.input_group.selectAll('.input-set').each(function(d2) {
                        d3.select(this).classed('selected-set', d === d2);
                    });
                }.bind(this);
                var get_this_val = function(d) {
                    return (d.type == 'value') ? d.value : stats[d.type];
                };
                var set_scale = function(scale) {
                    this.settings.set_conditional(this.type + '_scale', scale);
                    this.scale = scale;
                    this.update();
                }.bind(this);
                var sorted_domain = scale.map(function(d) {
                    return {
                        frac: (get_this_val(d) - stats.min) / (stats.max - stats.min),
                        color: d.color
                    };
                }).filter(function(d) {
                    return (d.frac >= 0 && d.frac <= 1.0);
                }).sort(function(a, b) {
                    return a.frac - b.frac;
                });
                var stops = this.gradient.selectAll('stop').data(sorted_domain);
                stops.enter().append('stop');
                stops.attr('offset', function(d) {
                    return d.frac * 100 + '%';
                }).style('stop-color', function(d) {
                    return d.color === null ? '#F1ECFA' : d.color;
                });
                stops.exit().remove();
                this.data_not_loaded.style('visibility', (data_not_loaded ? null : 'hidden'));
                var pickers = this.pickers_group.selectAll('.picker').data(scale);
                var drag = d3.behavior.drag();
                drag.on('drag', function(d, i) {
                    if (['value', 'min', 'max'].indexOf(scale[i].type) === -1) {
                        scale[i].value = get_this_val(d);
                        scale[i].type = 'value';
                    }
                    var new_d = scale[i].value + sc_size(d3.event.dx),
                        buf = sc_size(bar_w + 2);
                    if (new_d > stats.max - buf) new_d = stats.max - buf;
                    if (new_d < stats.min + buf) new_d = stats.min + buf;
                    new_d = Math.floor(new_d * 100.0) / 100.0;
                    scale[i].value = new_d;
                    this.settings.set_conditional(this.type + '_scale', scale);
                    this.scale = scale;
                    this.update();
                }.bind(this));
                pickers.enter().append('g').attr('class', 'picker').style('cursor', 'pointer').append('rect');
                pickers.select('rect').attr('x', function(d, i) {
                    var val = get_this_val(d),
                        buf = bar_w + 2;
                    if (d.type == 'value' && val <= stats.min)
                        return sc.invert(stats.min) - (bar_w / 2) + x_disp - buf;
                    if (d.type == 'value' && val >= stats.max)
                        return sc.invert(stats.max) - (bar_w / 2) + x_disp + buf;
                    return sc.invert(val) - (bar_w / 2) + x_disp;
                }).attr('width', bar_w + 'px').attr('height', bar_h + 'px').call(drag).on('mousedown', bring_to_front);
                pickers.exit().remove();
                var trashes = this.trash_group.selectAll('span').data(scale);
                trashes.enter().append('span');
                trashes.attr('class', function(d, i) {
                    if (d.type == 'min' || d.type == 'max')
                        return null;
                    return 'trash glyphicon glyphicon-trash';
                }).style('left', function(d) {
                    return sc.invert(get_this_val(d)) - (bar_w / 2) + x_disp + 'px';
                }).on('click', function(d, i) {
                    if (d.type == 'min' || d.type == 'max')
                        return;
                    scale = scale.slice(0, i).concat(scale.slice(i + 1));
                    this.settings.set_conditional(this.type + '_scale', scale);
                    this.scale = scale;
                    this.update();
                }.bind(this));
                trashes.exit().remove();
                var add = this.add_group.selectAll('.add').data(['add']);
                add.enter().append('span').attr('class', 'add glyphicon glyphicon-plus');
                add.on('click', function(d) {
                    if (data_not_loaded) return;
                    var new_d = (stats.max + stats.min) / 2,
                        buf = sc_size(bar_w + 2),
                        last_ind = 0;
                    for (var j = 0, l = scale.length; j < l; j++) {
                        var th = get_this_val(scale[j]);
                        if (Math.abs(th - new_d) < buf) {
                            new_d = new_d + buf;
                            if (new_d > stats.max - buf) new_d = stats.max - buf;
                            if (new_d < stats.min + buf) new_d = stats.min + buf;
                        }
                        if (new_d > th)
                            last_ind = j;
                    }
                    scale.push({
                        type: 'value',
                        value: new_d,
                        color: scale[last_ind].color,
                        size: scale[last_ind].size
                    });
                    set_scale(scale);
                }.bind(this));
                add.exit().remove();
                var labels = this.input_label_group.selectAll('.row-label').data(['Value:', 'Color:', 'Size:']);
                labels.enter().append('div').attr('class', 'row-label').style('height', this.input_height + 'px').style('line-height', this.input_height + 'px');
                labels.style('top', function(d, i) {
                    return 56 + (i * this.input_height) + 'px';
                }.bind(this)).text(function(d) {
                    return d;
                });
                labels.exit().remove();
                var inputs = this.input_group.selectAll('.input-set').data(scale);
                var i = inputs.enter().append('div').attr('class', 'input-set');
                i.append('input').attr('class', 'domain-input').style('width', this.input_width + 'px');
                i.append('select').attr('class', 'domain-type-picker'), i.append('input').attr('class', 'color-input').style('width', this.input_width + 'px');
                i.append('input').attr('type', 'color').style('visibility', function() {
                    return (this.type == 'text') ? 'hidden' : null;
                }).attr('class', 'color-picker');
                i.append('input').attr('class', 'size-input').style('width', this.input_width + 'px');
                inputs.style('height', this.input_height * 3 + 'px').style('width', this.input_width + 'px').style('left', function(d) {
                    var val = get_this_val(d),
                        buf = bar_w + 2,
                        l;
                    if (d.type == 'value' && val <= stats.min)
                        l = sc.invert(stats.min) - (bar_w / 2) + x_disp - buf;
                    else if (d.type == 'value' && val >= stats.max)
                        l = sc.invert(stats.max) - (bar_w / 2) + x_disp + buf;
                    else
                        l = sc.invert(val) - (bar_w / 2) + x_disp;
                    if (l + this.input_width > this.w + this.x)
                        l = l - this.input_width + (bar_w / 2);
                    return l + 'px';
                }.bind(this)).on('mousedown', bring_to_front);
                var format = d3.format('.4g');
                inputs.select('.domain-input').style('height', this.input_height + 'px').each(function(d, i) {
                    if (d.type == 'value') {
                        this.value = get_this_val(d);
                        this.disabled = false;
                    } else {
                        this.value = d.type + ' (' + format(get_this_val(d)) + ')';
                        this.disabled = true;
                    }
                }).on('change', function(d, i) {
                    var buf = sc_size(bar_w + 2),
                        new_d = parseFloat(this.value);
                    scale[i].value = new_d;
                    set_scale(scale);
                });
                var select = inputs.select('.domain-type-picker'),
                    stat_types = (['value'].concat(Object.keys(stats)).filter(function(x) {
                        return x != 'min' && x != 'max';
                    })),
                    opts = select.selectAll('option').data(stat_types);
                opts.enter().append('option');
                opts.attr('value', function(d) {
                    return d;
                }).text(function(d) {
                    return d;
                });
                opts.exit().remove();
                select.style('visibility', function(d) {
                    return (d.type == 'min' || d.type == 'max') ? 'hidden' : null;
                }).style('left', (this.input_width - 20) + 'px').style('width', '20px').each(function(d, i) {
                    var sind = 0;
                    d3.select(this).selectAll('option').each(function(_, i) {
                        if (this.value == d.type)
                            sind = i;
                    });
                    this.selectedIndex = sind;
                }).on('change', function(d, i) {
                    if (this.value == 'value')
                        scale[i].value = stats[d.type];
                    scale[i].type = this.value;
                    set_scale(scale);
                });
                inputs.select('.color-input').style('height', this.input_height + 'px').style('top', this.input_height + 'px').each(function(d, i) {
                    this.value = (d.color === null ? '' : d.color);
                    this.disabled = (d.color === null);
                }).on('change', function(d, i) {
                    scale[i].color = this.value;
                    set_scale(scale);
                });
                inputs.select('.color-picker').style('left', (this.input_width - this.input_height) + 'px').style('top', this.input_height + 'px').style('width', this.input_height + 'px').style('height', this.input_height + 'px').each(function(d, i) {
                    this.value = (d.color === null ? '#dddddd' : d.color);
                    this.disabled = (d.color === null);
                }).on('change', function(d, i) {
                    scale[i].color = this.value;
                    set_scale(scale);
                });
                inputs.select('.size-input').style('height', this.input_height + 'px').style('top', this.input_height * 2 + 'px').each(function(d, i) {
                    this.value = (d.size === null ? '' : d.size);
                    this.disabled = (d.size === null);
                }).on('change', function(d, i) {
                    scale[i].size = parseFloat(this.value);
                    set_scale(scale);
                });
                inputs.exit().remove();
            }

            function update_no_data() {
                var no_data = this.no_data,
                    data_not_loaded = this._data_not_loaded(),
                    label_w = 40;
                var ins = this.no_data_container.selectAll('.input-group').data([
                    ['color', 'Color:'],
                    ['size', 'Size:']
                ]);
                var t = ins.enter().append('div').attr('class', 'input-group');
                t.append('span');
                t.append('input');
                t.append('input').attr('type', 'color').style('visibility', function(d) {
                    return (this.type == 'text' || d[0] != 'color') ? 'hidden' : null;
                }).attr('class', 'color-picker');
                ins.select('span').text(function(d) {
                    return d[1];
                }).style('height', this.input_height + 'px').style('line-height', this.input_height + 'px').style('left', function(d, i) {
                    return ((label_w + this.input_width + 10) * i) + 'px';
                }.bind(this));
                var get_o = function(kind) {
                    return this.settings.get_option(this.type + '_no_data_' + kind);
                }.bind(this);
                ins.select('input').style('left', function(d, i) {
                    return (label_w + (label_w + this.input_width + 10) * i) + 'px';
                }.bind(this)).style('height', this.input_height + 'px').style('width', this.input_width + 'px').each(function(d) {
                    this.value = data_not_loaded ? '' : no_data[d[0]];
                    this.disabled = data_not_loaded;
                }).on('change', function(d) {
                    var val = d3.event.target.value;
                    if (d[0] == 'size')
                        val = parseFloat(val);
                    this.no_data[d[0]] = val;
                    this.settings.set_conditional(this.type + '_no_data_' + d[0], val);
                    this.update_no_data();
                }.bind(this));
                ins.select('.color-picker').style('left', function(d, i) {
                    return ((label_w + this.input_width) * (i + 1) - this.input_height) + 'px';
                }.bind(this)).style('width', this.input_height + 'px').style('height', this.input_height + 'px').each(function(d, i) {
                    this.value = data_not_loaded ? '#dddddd' : no_data[d[0]];
                    this.disabled = data_not_loaded;
                }).on('change', function(d, i) {
                    var val = d3.event.target.value;
                    this.no_data[d[0]] = val;
                    this.settings.set_conditional(this.type + '_no_data_' + d[0], val);
                    this.update_no_data();
                }.bind(this));
                ins.exit().remove();
            }

            function _data_not_loaded() {
                var stats = this.get_data_statistics()[this.type];
                return (stats.max === null || stats.min === null);
            }
        }, {
            "./utils": 31,
            "baconjs": 32
        }],
        17: [function(require, module, exports) {
            var utils = require('./utils');
            var CallbackManager = require('./CallbackManager');
            var _ = require('underscore');
            var SearchBar = utils.make_class();
            SearchBar.prototype = {
                init: init,
                is_visible: is_visible,
                toggle: toggle,
                update: update,
                next: next,
                previous: previous
            };
            module.exports = SearchBar;

            function init(sel, search_index, map) {
                var container = sel.attr('class', 'search-container').style('display', 'none');
                this.input = container.append('input').attr('class', 'search-bar');
                var group = container.append('div').attr('class', 'btn-group btn-group-sm');
                group.append('button').attr('class', 'btn btn-default').on('click', this.previous.bind(this)).append('span').attr('class', 'glyphicon glyphicon-chevron-left');
                group.append('button').attr('class', 'btn btn-default').on('click', this.next.bind(this)).append('span').attr('class', 'glyphicon glyphicon-chevron-right');
                this.counter = container.append('div').attr('class', 'search-counter');
                container.append('button').attr('class', 'btn btn-sm btn-default close-button').on('click', function() {
                    this.toggle(false);
                }.bind(this)).append('span').attr('class', 'glyphicon glyphicon-remove');
                this.callback_manager = new CallbackManager();
                this.selection = container;
                this.map = map;
                this.search_index = search_index;
                this.current = 1;
                this.results = null;
                var on_input_fn = function(input) {
                    this.current = 1;
                    this.results = _drop_duplicates(this.search_index.find(input.value));
                    this.update();
                }.bind(this, this.input.node());
                this.input.on('input', utils.debounce(on_input_fn, 200));
            }
            var comp_keys = {
                metabolite: ['m', 'node_id'],
                reaction: ['r', 'reaction_id'],
                text_label: ['t', 'text_label_id']
            };

            function _drop_duplicates(results) {
                return _.uniq(results, function(item) {
                    var t = comp_keys[item.type];
                    return t[0] + item[t[1]];
                });
            }

            function is_visible() {
                return this.selection.style('display') !== 'none';
            }

            function toggle(on_off) {
                if (on_off === undefined) this.is_active = !this.is_active;
                else this.is_active = on_off;
                if (this.is_active) {
                    this.selection.style('display', null);
                    this.counter.text('');
                    this.input.node().value = '';
                    this.input.node().focus();
                    this.clear_escape = this.map.key_manager.add_escape_listener(function() {
                        this.toggle(false);
                    }.bind(this), true);
                    this.clear_next = this.map.key_manager.add_key_listener(['enter', 'ctrl+g'], function() {
                        this.next();
                    }.bind(this), false);
                    this.clear_previous = this.map.key_manager.add_key_listener(['shift+enter', 'shift+ctrl+g'], function() {
                        this.previous();
                    }.bind(this), false);
                    this.callback_manager.run('show');
                } else {
                    this.map.highlight(null);
                    this.selection.style('display', 'none');
                    this.results = null;
                    if (this.clear_escape) this.clear_escape();
                    this.clear_escape = null;
                    if (this.clear_next) this.clear_next();
                    this.clear_next = null;
                    if (this.clear_previous) this.clear_previous();
                    this.clear_previous = null;
                    this.callback_manager.run('hide');
                }
            }

            function update() {
                if (this.results === null) {
                    this.counter.text('');
                    this.map.highlight(null);
                } else if (this.results.length === 0) {
                    this.counter.text('0 / 0');
                    this.map.highlight(null);
                } else {
                    this.counter.text(this.current + ' / ' + this.results.length);
                    var r = this.results[this.current - 1];
                    if (r.type == 'reaction') {
                        this.map.zoom_to_reaction(r.reaction_id);
                        this.map.highlight_reaction(r.reaction_id);
                    } else if (r.type == 'metabolite') {
                        this.map.zoom_to_node(r.node_id);
                        this.map.highlight_node(r.node_id);
                    } else if (r.type == 'text_label') {
                        this.map.zoom_to_text_label(r.text_label_id);
                        this.map.highlight_text_label(r.text_label_id);
                    } else {
                        throw new Error('Bad search index data type: ' + r.type);
                    }
                }
            }

            function next() {
                if (this.results === null) return;
                if (this.current === this.results.length)
                    this.current = 1;
                else
                    this.current += 1;
                this.update();
            }

            function previous() {
                if (this.results === null) return;
                if (this.current === 1)
                    this.current = this.results.length;
                else
                    this.current -= 1;
                this.update();
            }
        }, {
            "./CallbackManager": 5,
            "./utils": 31,
            "underscore": 35
        }],
        18: [function(require, module, exports) {
            var utils = require('./utils');
            var SearchIndex = utils.make_class();
            SearchIndex.prototype = {
                init: init,
                insert: insert,
                remove: remove,
                find: find
            };
            module.exports = SearchIndex;

            function init() {
                this.index = {};
            }

            function insert(id, record, overwrite, check_record) {
                if (!overwrite && (id in this.index))
                    throw new Error("id is already in the index");
                if (check_record && !(('name' in record) && ('data' in record)))
                    throw new Error("malformed record");
                this.index[id] = record;
            }

            function remove(record_id) {
                if (record_id in this.index) {
                    delete this.index[record_id];
                    return true;
                } else {
                    return false;
                }
            }

            function find(substring) {
                var re = RegExp(substring, "i"),
                    matches = [];
                for (var id in this.index) {
                    var record = this.index[id];
                    if (re.exec(record.name))
                        matches.push(record.data);
                }
                return matches;
            }
        }, {
            "./utils": 31
        }],
        19: [function(require, module, exports) {
            var utils = require('./utils');
            var bacon = require('baconjs');
            var Settings = utils.make_class();
            Settings.prototype = {
                init: init,
                set_conditional: set_conditional,
                hold_changes: hold_changes,
                abandon_changes: abandon_changes,
                accept_changes: accept_changes
            };
            module.exports = Settings;

            function init(set_option, get_option, conditional_options) {
                this.set_option = set_option;
                this.get_option = get_option;
                this.status_bus = new bacon.Bus();
                this.force_update_bus = new bacon.Bus();
                bacon.Observable.prototype.convert_to_conditional_stream = _convert_to_conditional_stream;
                bacon.Observable.prototype.force_update_with_bus = _force_update_with_bus;
                this.busses = {};
                this.streams = {};
                for (var i = 0, l = conditional_options.length; i < l; i++) {
                    var name = conditional_options[i],
                        out = _create_conditional_setting(name, get_option(name), set_option, this.status_bus, this.force_update_bus);
                    this.busses[name] = out.bus;
                    this.streams[name] = out.stream;
                }
            }

            function _convert_to_conditional_stream(status_stream) {
                var is_not_hold_event = status_stream.map(function(x) {
                        return x == 'hold';
                    }).not().toProperty(true),
                    is_not_first_clear = status_stream.scan(false, function(c, x) {
                        return (c == false && (x == 'accepted' || x == 'rejected'));
                    }).not(),
                    is_not_first_hold = status_stream.scan(false, function(c, x) {
                        return (c == false && x == 'hold');
                    }).not(),
                    combined = bacon.combineAsArray(this, status_stream),
                    held = combined.scan([], function(c, x) {
                        if (x[1] == 'hold') {
                            c.push(x[0]);
                            return c;
                        } else if (x[1] == 'accept') {
                            return c;
                        } else if (x[1] == 'reject') {
                            return [];
                        } else if (x[1] == 'rejected' || x[1] == 'accepted') {
                            return [x[0]];
                        } else {
                            throw Error('bad status ' + x[1]);
                        }
                    }).filter(is_not_hold_event).filter(is_not_first_clear).filter(is_not_first_hold).flatMap(function(ar) {
                        return bacon.fromArray(ar);
                    }),
                    unheld = this.filter(is_not_hold_event);
                return unheld.merge(held);
            }

            function _force_update_with_bus(bus) {
                return bacon.combineAsArray(this, bus.toProperty(false)).map(function(t) {
                    return t[0];
                });
            }

            function _create_conditional_setting(name, initial_value, set_option, status_bus, force_update_bus) {
                var bus = new bacon.Bus();
                var stream = bus.convert_to_conditional_stream(status_bus).force_update_with_bus(force_update_bus);
                stream.onValue(function(v) {
                    set_option(name, v);
                });
                bus.push(initial_value);
                return {
                    bus: bus,
                    stream: stream
                };
            }

            function set_conditional(name, value) {
                if (!(name in this.busses))
                    throw new Error('Invalid setting name');
                this.busses[name].push(value);
            }

            function hold_changes() {
                this.status_bus.push('hold');
            }

            function abandon_changes() {
                this.status_bus.push('reject');
                this.status_bus.push('rejected');
                this.force_update_bus.push(true);
            }

            function accept_changes() {
                this.status_bus.push('accept');
                this.status_bus.push('accepted');
            }
        }, {
            "./utils": 31,
            "baconjs": 32
        }],
        20: [function(require, module, exports) {
            'strict mode';
            var utils = require('./utils');
            var CallbackManager = require('./CallbackManager');
            var ScaleEditor = require('./ScaleEditor');
            var SettingsMenu = utils.make_class();
            SettingsMenu.prototype = {
                init: init,
                is_visible: is_visible,
                toggle: toggle,
                hold_changes: hold_changes,
                abandon_changes: abandon_changes,
                accept_changes: accept_changes,
                style_gui: style_gui,
                view_gui: view_gui
            };
            module.exports = SettingsMenu;

            function init(sel, settings, map, toggle_abs_and_apply_data) {
                this.sel = sel;
                this.settings = settings;
                this.draw = false;
                var unique_map_id = this.settings.get_option('unique_map_id');
                this.unique_string = (unique_map_id === null ? '' : '.' + unique_map_id);
                var background = sel.append('div').attr('class', 'settings-box-background').style('display', 'none'),
                    container = background.append('div').attr('class', 'settings-box-container').style('display', 'none');
                container.append('button').attr("class", "btn btn-sm btn-default settings-button").on('click', function() {
                    this.accept_changes();
                }.bind(this)).append("span").attr("class", "glyphicon glyphicon-ok");
                container.append('button').attr("class", "btn btn-sm btn-default settings-button settings-button-close").on('click', function() {
                    this.abandon_changes();
                }.bind(this)).append("span").attr("class", "glyphicon glyphicon-remove");
                var box = container.append('div').attr('class', 'settings-box');
                box.append('div').text('Tip: Hover over an option to see more details about it.').classed('settings-tip', true);
                box.append('hr');
                box.append('div').text('View and build options').attr('class', 'settings-section-heading-large');
                this.view_gui(box.append('div'));
                box.append('hr');
                box.append('div').text('Reactions').attr('class', 'settings-section-heading-large');
                var rse = new ScaleEditor(box.append('div'), 'reaction', this.settings, map.get_data_statistics.bind(map));
                map.callback_manager.set('calc_data_stats__reaction', function(changed) {
                    if (changed) {
                        rse.update();
                        rse.update_no_data();
                    }
                });
                box.append('div').text('Reaction or Gene data').attr('class', 'settings-section-heading');
                this.style_gui(box.append('div'), 'reaction', function(on_off) {
                    if (toggle_abs_and_apply_data) {
                        toggle_abs_and_apply_data('reaction', on_off);
                        rse.update();
                        rse.update_no_data();
                    }
                });
                box.append('hr');
                box.append('div').text('Metabolites').attr('class', 'settings-section-heading-large');
                var mse = new ScaleEditor(box.append('div'), 'metabolite', this.settings, map.get_data_statistics.bind(map));
                map.callback_manager.set('calc_data_stats__metabolite', function(changed) {
                    if (changed) {
                        mse.update();
                        mse.update_no_data();
                    }
                });
                box.append('div').text('Metabolite data').attr('class', 'settings-section-heading');
                this.style_gui(box.append('div'), 'metabolite', function(on_off) {
                    if (toggle_abs_and_apply_data) {
                        toggle_abs_and_apply_data('metabolite', on_off);
                        mse.update();
                        mse.update_no_data();
                    }
                });
                this.callback_manager = new CallbackManager();
                this.map = map;
                this.selection = container;
                this.background = background;
            }

            function is_visible() {
                return this.selection.style('display') != 'none';
            }

            function toggle(on_off) {
                if (on_off === undefined) on_off = !this.is_visible();
                if (on_off) {
                    this.hold_changes();
                    this.selection.style("display", "inline-block");
                    this.background.style("display", "block");
                    this.selection.select('input').node().focus();
                    this.clear_escape = this.map.key_manager.add_escape_listener(function() {
                        this.abandon_changes();
                    }.bind(this), true);
                    this.clear_enter = this.map.key_manager.add_enter_listener(function() {
                        this.accept_changes();
                    }.bind(this), true);
                    this.callback_manager.run('show');
                } else {
                    if (this.draw) this.map.draw_everything();
                    this.selection.style("display", "none");
                    this.background.style("display", "none");
                    if (this.clear_escape) this.clear_escape();
                    this.clear_escape = null;
                    if (this.clear_enter) this.clear_enter();
                    this.clear_enter = null;
                    this.callback_manager.run('hide');
                }
            }

            function hold_changes() {
                this.settings.hold_changes();
            }

            function abandon_changes() {
                this.draw = false;
                this.settings.abandon_changes();
                this.toggle(false);
            }

            function accept_changes() {
                this.sel.selectAll('input').each(function(s) {
                    this.blur();
                });
                this.draw = true;
                this.settings.accept_changes();
                this.toggle(false);
            }

            function style_gui(sel, type, abs_callback) {
                var t = sel.append('table').attr('class', 'settings-table'),
                    settings = this.settings;
                t.append('tr').call(function(r) {
                    r.append('td').text('Options:').attr('class', 'options-label').attr('title', ('Options for ' + type + ' data.'));
                    var cell = r.append('td');
                    var styles = [
                            ['Absolute value', 'abs', ('If checked, use the absolute value when ' + 'calculating colors and sizes of ' + type + 's on the map')],
                            ['Size', 'size', ('If checked, then size the ' +
                                (type == 'metabolite' ? 'radius of metabolite circles ' : 'thickness of reaction lines ') + 'according to the value of the ' + type + ' data')],
                            ['Color', 'color', ('If checked, then color the ' +
                                (type == 'metabolite' ? 'metabolite circles ' : 'reaction lines ') + 'according to the value of the ' + type + ' data')],
                            ['Text (Show data in label)', 'text', ('If checked, then show data values in the ' + type + ' ' + 'labels')]
                        ],
                        style_cells = cell.selectAll('.option-group').data(styles),
                        s = style_cells.enter().append('label').attr('class', 'option-group');
                    var streams = [],
                        get_styles = function() {
                            var styles = [];
                            cell.selectAll('input').each(function(d) {
                                if (this.checked) styles.push(d[1]);
                            });
                            return styles;
                        };
                    s.append('input').attr('type', 'checkbox').on('change', function(d) {
                        settings.set_conditional(type + '_styles', get_styles());
                        if (d[1] == 'abs')
                            abs_callback(this.checked);
                    }).each(function(d) {
                        settings.streams[type + '_styles'].onValue(function(ar) {
                            this.checked = (ar.indexOf(d[1]) != -1);
                        }.bind(this));
                    });
                    s.append('span').text(function(d) {
                        return d[0];
                    }).attr('title', function(d) {
                        return d[2];
                    });
                });
                t.append('tr').call(function(r) {
                    r.append('td').text('Comparison:').attr('class', 'options-label').attr('title', ('The function that will be used to compare ' + 'datasets, when paired data is loaded'));
                    var cell = r.append('td').attr('title', ('The function that will be used to compare ' + 'datasets, when paired data is loaded'));;
                    var styles = [
                            ['Fold Change', 'fold'],
                            ['Log2(Fold Change)', 'log2_fold'],
                            ['Difference', 'diff']
                        ],
                        style_cells = cell.selectAll('.option-group').data(styles),
                        s = style_cells.enter().append('label').attr('class', 'option-group');
                    s.append('input').attr('type', 'radio').attr('name', type + '_compare_style' + this.unique_string).attr('value', function(d) {
                        return d[1];
                    }).on('change', function() {
                        if (this.checked)
                            settings.set_conditional(type + '_compare_style', this.value);
                    }).each(function() {
                        settings.streams[type + '_compare_style'].onValue(function(value) {
                            this.checked = (this.value == value);
                        }.bind(this));
                    });
                    s.append('span').text(function(d) {
                        return d[0];
                    });
                }.bind(this));
                if (type == 'reaction') {
                    var t = sel.append('table').attr('class', 'settings-table').attr('title', ('The function that will be used to evaluate ' + 'AND connections in gene reaction rules (AND ' + 'connections generally connect components of ' + 'an enzyme complex)'));
                    t.append('tr').call(function(r) {
                        r.append('td').text('Method for evaluating AND:').attr('class', 'options-label-wide');
                        var cell = r.append('td');
                        var styles = [
                                ['Mean', 'mean'],
                                ['Min', 'min']
                            ],
                            style_cells = cell.selectAll('.option-group').data(styles),
                            s = style_cells.enter().append('label').attr('class', 'option-group');
                        var name = 'and_method_in_gene_reaction_rule';
                        s.append('input').attr('type', 'radio').attr('name', name + this.unique_string).attr('value', function(d) {
                            return d[1];
                        }).on('change', function() {
                            if (this.checked)
                                settings.set_conditional(name, this.value);
                        }).each(function() {
                            settings.streams[name].onValue(function(value) {
                                this.checked = (this.value == value);
                            }.bind(this));
                        });
                        s.append('span').text(function(d) {
                            return d[0];
                        });
                    }.bind(this));
                }
            }

            function view_gui(s, option_name, string, options) {
                var settings = this.settings;
                var t = s.append('table').attr('class', 'settings-table');
                t.append('tr').call(function(r) {
                    r.attr('title', ('The identifiers that are show in the reaction, ' + 'gene, and metabolite labels on the map.'));
                    r.append('td').text('Identifiers:').attr('class', 'options-label');
                    var cell = r.append('td');
                    var options = [
                            ['ID\'s', 'bigg_id'],
                            ['Descriptive names', 'name']
                        ],
                        style_cells = cell.selectAll('.option-group').data(options),
                        s = style_cells.enter().append('label').attr('class', 'option-group');
                    var name = 'identifiers_on_map';
                    s.append('input').attr('type', 'radio').attr('name', name + this.unique_string).attr('value', function(d) {
                        return d[1];
                    }).on('change', function() {
                        if (this.checked)
                            settings.set_conditional(name, this.value);
                    }).each(function() {
                        settings.streams[name].onValue(function(value) {
                            this.checked = (this.value == value);
                        }.bind(this));
                    });
                    s.append('span').text(function(d) {
                        return d[0];
                    });
                }.bind(this));
                var boolean_options = [
                    ['scroll_behavior', 'Scroll to zoom (instead of scroll to pan)', ('If checked, then the scroll wheel and trackpad will control zoom ' + 'rather than pan.'), {
                        'zoom': true,
                        'pan': false
                    }],
                    ['hide_secondary_metabolites', 'Hide secondary metabolites', ('If checked, then only the primary metabolites ' + 'will be displayed.')],
                    ['show_gene_reaction_rules', 'Show gene reaction rules', ('If checked, then gene reaction rules will be displayed ' + 'below each reaction label. (Gene reaction rules are always ' + 'shown when gene data is loaded.)')],
                    ['hide_all_labels', 'Hide reaction, gene, and metabolite labels', ('If checked, hide all reaction, gene, and metabolite labels')],
                    ['allow_building_duplicate_reactions', 'Allow duplicate reactions', ('If checked, then allow duplicate reactions during model building.')],
                    ['highlight_missing', 'Highlight reactions not in model', ('If checked, then highlight in red all the ' + 'reactions on the map that are not present in ' + 'the loaded model.')],
                ];
                var opts = s.append('div').attr('class', 'settings-container').selectAll('.option-group').data(boolean_options);
                var e = opts.enter().append('label').attr('class', 'option-group full-line');
                e.append('input').attr('type', 'checkbox');
                e.append('span');
                opts.attr('title', function(d) {
                    return d[2];
                });
                opts.select('input').on('change', function(d) {
                    if (d.length >= 4) {
                        for (var key in d[3]) {
                            if (d[3][key] == this.checked) {
                                settings.set_conditional(d[0], key);
                                break;
                            }
                        }
                    } else {
                        settings.set_conditional(d[0], this.checked);
                    }
                }).each(function(d) {
                    settings.streams[d[0]].onValue(function(value) {
                        if (d.length >= 4) {
                            this.checked = d[3][value];
                        } else {
                            this.checked = value;
                        }
                    }.bind(this));
                });
                opts.select('span').text(function(d) {
                    return d[1];
                });
                opts.exit().remove();
                s.append('div').style('margin-top', '16px').classed('settings-tip', true).text('Tip: To increase map performance, turn off text boxes (i.e. labels and gene reaction rules).');
            }
        }, {
            "./CallbackManager": 5,
            "./ScaleEditor": 16,
            "./utils": 31
        }],
        21: [function(require, module, exports) {
            var utils = require('./utils');
            var PlacedDiv = require('./PlacedDiv');
            var build = require('./build');
            var TextEditInput = utils.make_class();
            TextEditInput.prototype = {
                init: init,
                setup_map_callbacks: setup_map_callbacks,
                setup_zoom_callbacks: setup_zoom_callbacks,
                is_visible: is_visible,
                show: show,
                hide: hide,
                _accept_changes: _accept_changes,
                _add_and_edit: _add_and_edit
            };
            module.exports = TextEditInput;

            function init(selection, map, zoom_container) {
                var div = selection.append('div').attr('id', 'text-edit-input');
                this.placed_div = PlacedDiv(div, map);
                this.placed_div.hide();
                this.input = div.append('input');
                this.map = map;
                this.setup_map_callbacks(map);
                this.zoom_container = zoom_container;
                this.setup_zoom_callbacks(zoom_container);
            }

            function setup_map_callbacks(map) {
                map.callback_manager.set('edit_text_label.text_edit_input', function(target, coords) {
                    this.show(target, coords);
                }.bind(this));
                map.callback_manager.set('new_text_label.text_edit_input', function(coords) {
                    if (this.active_target !== null)
                        this._accept_changes(this.active_target.target);
                    this.hide();
                    this._add_and_edit(coords);
                }.bind(this));
                map.callback_manager.set('hide_text_label_editor.text_edit_input', function() {
                    this.hide();
                }.bind(this));
            }

            function setup_zoom_callbacks(zoom_container) {
                zoom_container.callback_manager.set('zoom.text_edit_input', function() {
                    if (this.active_target)
                        this._accept_changes(this.active_target.target);
                    this.hide();
                }.bind(this));
                zoom_container.callback_manager.set('go_to.text_edit_input', function() {
                    if (this.active_target)
                        this._accept_changes(this.active_target.target);
                    this.hide();
                }.bind(this));
            }

            function is_visible() {
                return this.placed_div.is_visible();
            }

            function show(target, coords) {
                if (this.active_target) {
                    this._accept_changes(this.active_target.target);
                }
                this.active_target = {
                    target: target,
                    coords: coords
                };
                target.each(function(d) {
                    this.input.node().value = d.text;
                }.bind(this));
                this.placed_div.place(coords);
                this.input.node().focus();
                this.clear_escape = this.map.key_manager.add_escape_listener(function() {
                    this._accept_changes(target);
                    this.hide();
                }.bind(this), true);
                this.clear_enter = this.map.key_manager.add_enter_listener(function(target) {
                    this._accept_changes(target);
                    this.hide();
                }.bind(this, target), true);
            }

            function hide() {
                this.placed_div.hide();
                this.input.attr('value', '');
                this.active_target = null;
                if (this.clear_escape) this.clear_escape();
                this.clear_escape = null;
                if (this.clear_enter) this.clear_enter();
                this.clear_enter = null;
            }

            function _accept_changes(target) {
                if (this.input.node().value == '') {
                    target.each(function(d) {
                        var selected = {};
                        selected[d.text_label_id] = this.map.text_labels[d.text_label_id];
                        this.map.delete_selectable({}, selected, true);
                    }.bind(this));
                } else {
                    var text_label_ids = [];
                    target.each(function(d) {
                        this.map.edit_text_label(d.text_label_id, this.input.node().value, true);
                        text_label_ids.push(d.text_label_id);
                    }.bind(this));
                }
            }

            function _add_and_edit(coords) {
                var text_label_id = this.map.new_text_label(coords, '');
                var sel = this.map.sel.select('#text-labels').selectAll('.text-label').filter(function(d) {
                    return d.text_label_id == text_label_id;
                });
                sel.select('text').classed('edit-text-cursor', true);
                this.show(sel, coords);
            }
        }, {
            "./PlacedDiv": 13,
            "./build": 24,
            "./utils": 31
        }],
        22: [function(require, module, exports) {
            var utils = require('./utils');
            var UndoStack = utils.make_class();
            UndoStack.prototype = {
                init: init,
                push: push,
                undo: undo,
                redo: redo
            };
            module.exports = UndoStack;

            function init() {
                var stack_size = 40;
                this.stack = Array(stack_size);
                this.current = -1;
                this.oldest = -1;
                this.newest = -1;
                this.end_of_stack = true;
                this.top_of_stack = true;
            }

            function _incr(a, l) {
                return a + 1 > l - 1 ? 0 : a + 1;
            }

            function _decr(a, l) {
                return a - 1 < 0 ? l - 1 : a - 1;
            }

            function push(undo_fn, redo_fn) {
                this.current = _incr(this.current, this.stack.length);
                if (this.end_of_stack)
                    this.oldest = this.current;
                else if (this.oldest == this.current)
                    this.oldest = _incr(this.oldest, this.stack.length);
                this.stack[this.current] = {
                    undo: undo_fn,
                    redo: redo_fn
                };
                this.newest = this.current;
                this.top_of_stack = true;
                this.end_of_stack = false;
            }

            function undo() {
                if (this.end_of_stack) return console.warn('End of stack.');
                this.stack[this.current].undo();
                if (this.current == this.oldest) {
                    this.end_of_stack = true;
                } else {
                    this.current = _decr(this.current, this.stack.length);
                }
                this.top_of_stack = false;
            }

            function redo() {
                if (this.top_of_stack) return console.warn('Top of stack.');
                if (!this.end_of_stack)
                    this.current = _incr(this.current, this.stack.length);
                this.stack[this.current].redo();
                if (this.current == this.newest)
                    this.top_of_stack = true;
                this.end_of_stack = false;
            }
        }, {
            "./utils": 31
        }],
        23: [function(require, module, exports) {
            var utils = require('./utils');
            var CallbackManager = require('./CallbackManager');
            var _ = require('underscore');
            var ZoomContainer = utils.make_class();
            ZoomContainer.prototype = {
                init: init,
                set_scroll_behavior: set_scroll_behavior,
                set_use_3d_transform: set_use_3d_transform,
                _update_scroll: _update_scroll,
                toggle_pan_drag: toggle_pan_drag,
                go_to: go_to,
                _go_to_3d: _go_to_3d,
                _clear_3d: _clear_3d,
                _go_to_svg: _go_to_svg,
                zoom_by: zoom_by,
                zoom_in: zoom_in,
                zoom_out: zoom_out,
                get_size: get_size,
                translate_off_screen: translate_off_screen
            };
            module.exports = ZoomContainer;

            function init(selection, scroll_behavior, use_3d_transform, fill_screen) {
                selection.classed('escher-container', true);
                if (fill_screen) {
                    d3.select('html').classed('fill-screen', true)
                    d3.select('body').classed('fill-screen', true)
                    selection.classed('fill-screen-div', true)
                }
                var zoom_container = selection.append('div').attr('class', 'escher-zoom-container');
                var css3_transform_container = zoom_container.append('div').attr('class', 'escher-3d-transform-container');
                var svg = css3_transform_container.append('svg').attr("class", "escher-svg").attr('xmlns', "http://www.w3.org/2000/svg");
                svg.select(".zoom-g").remove();
                var zoomed_sel = svg.append("g").attr("class", "zoom-g");
                this.selection = selection;
                this.zoom_container = zoom_container;
                this.css3_transform_container = css3_transform_container;
                this.svg = svg;
                this.zoomed_sel = zoomed_sel;
                this.window_translate = {
                    x: 0,
                    y: 0
                };
                this.window_scale = 1.0;
                this._scroll_behavior = scroll_behavior;
                this._use_3d_transform = use_3d_transform;
                this._pan_drag_on = true;
                this._zoom_behavior = null;
                this._zoom_timeout = null;
                this._svg_scale = this.window_scale;
                this._svg_translate = this.window_translate;
                this.callback_manager = new CallbackManager();
                this._update_scroll();
            }

            function set_scroll_behavior(scroll_behavior) {
                this._scroll_behavior = scroll_behavior;
                this._update_scroll();
            }

            function set_use_3d_transform(use_3d_transform) {
                this._use_3d_transform = use_3d_transform;
            }

            function toggle_pan_drag(on_off) {
                if (_.isUndefined(on_off)) {
                    this._pan_drag_on = !this._pan_drag_on;
                } else {
                    this._pan_drag_on = on_off;
                }
                if (this._pan_drag_on) {
                    this.zoomed_sel.classed('cursor-grab', true).classed('cursor-grabbing', false);
                    this.zoomed_sel.on('mousedown.cursor', function(sel) {
                        sel.classed('cursor-grab', false).classed('cursor-grabbing', true);
                    }.bind(null, this.zoomed_sel)).on('mouseup.cursor', function(sel) {
                        sel.classed('cursor-grab', true).classed('cursor-grabbing', false);
                    }.bind(null, this.zoomed_sel));
                } else {
                    this.zoomed_sel.style('cursor', null).classed('cursor-grab', false).classed('cursor-grabbing', false);
                    this.zoomed_sel.on('mousedown.cursor', null);
                    this.zoomed_sel.on('mouseup.cursor', null);
                }
                this._update_scroll();
            }

            function _update_scroll() {
                if (!_.contains(['zoom', 'pan', 'none'], this._scroll_behavior)) {
                    throw Error('Bad value for scroll_behavior: ' + this._scroll_behavior);
                }
                this.zoom_container.on("mousewheel.zoom", null).on("DOMMouseScroll.zoom", null).on("wheel.zoom", null).on('dblclick.zoom', null).on('mousewheel.escher', null).on('DOMMouseScroll.escher', null).on('wheel.escher', null).on("mousedown.zoom", null).on("touchstart.zoom", null).on("touchmove.zoom", null).on("touchend.zoom", null);
                try {
                    this._zoom_behavior = d3.behavior.zoom().on("zoom", function() {
                        this.go_to(d3.event.scale, {
                            x: d3.event.translate[0],
                            y: d3.event.translate[1]
                        });
                    }.bind(this));
                } catch (err) {
                    console.log('Not in a browser, so d3.behavior.zoom does not work.');
                    this._zoom_behavior = null;
                    return;
                }
                this._zoom_behavior.scale(this.window_scale);
                this._zoom_behavior.translate([this.window_translate.x, this.window_translate.y]);
                this.zoom_container.call(this._zoom_behavior);
                this.zoom_container.on('dblclick.zoom', null);
                if (!this._pan_drag_on) {
                    this.zoom_container.on("mousedown.zoom", null).on("touchstart.zoom", null).on("touchmove.zoom", null).on("touchend.zoom", null);
                }
                if (this._scroll_behavior !== 'zoom') {
                    this.zoom_container.on("mousewheel.zoom", null).on("DOMMouseScroll.zoom", null).on("wheel.zoom", null);
                }
                if (this._scroll_behavior === 'pan') {
                    var wheel_fn = function() {
                        var ev = d3.event,
                            sensitivity = 0.5;
                        ev.stopPropagation();
                        ev.preventDefault();
                        ev.returnValue = false;
                        var get_directional_disp = function(wheel_delta, delta) {
                            var the_delt = _.isUndefined(wheel_delta) ? delta : -wheel_delta / 1.5;
                            return the_delt * sensitivity;
                        };
                        var new_translate = {
                            x: this.window_translate.x - get_directional_disp(ev.wheelDeltaX, ev.deltaX),
                            y: this.window_translate.y - get_directional_disp(ev.wheelDeltaY, ev.deltaY)
                        };
                        this.go_to(this.window_scale, new_translate);
                    }.bind(this);
                    this.zoom_container.on('mousewheel.escher', wheel_fn);
                    this.zoom_container.on('DOMMouseScroll.escher', wheel_fn);
                    this.zoom_container.on('wheel.escher', wheel_fn);
                }
            }

            function go_to(scale, translate) {
                utils.check_undefined(arguments, ['scale', 'translate']);
                var use_3d_transform = this._use_3d_transform;
                if (!scale) throw new Error('Bad scale value');
                if (!translate || !('x' in translate) || !('y' in translate) || isNaN(translate.x) || isNaN(translate.y))
                    return console.error('Bad translate value');
                this.window_scale = scale;
                this.window_translate = translate;
                if (!_.isNull(this._zoom_behavior)) {
                    this._zoom_behavior.scale(scale);
                    var translate_array = [translate.x, translate.y];
                    this._zoom_behavior.translate(translate_array);
                }
                if (use_3d_transform) {
                    if (!_.isNull(this._zoom_timeout))
                        clearTimeout(this._zoom_timeout);
                    this._go_to_3d(scale, translate, this._svg_scale, this._svg_translate);
                    this._zoom_timeout = _.delay(function() {
                        this._go_to_svg(scale, translate);
                    }.bind(this), 100);
                } else {
                    this._go_to_svg(scale, translate);
                }
                this.callback_manager.run('go_to');
            }

            function _go_to_3d(scale, translate, svg_scale, svg_translate) {
                var n_scale = scale / svg_scale,
                    n_translate = utils.c_minus_c(translate, utils.c_times_scalar(svg_translate, n_scale)),
                    tranform = ('translate(' + n_translate.x + 'px,' + n_translate.y + 'px) ' + 'scale(' + n_scale + ')');
                this.css3_transform_container.style('transform', tranform);
                this.css3_transform_container.style('-webkit-transform', tranform);
                this.css3_transform_container.style('transform-origin', '0 0');
                this.css3_transform_container.style('-webkit-transform-origin', '0 0');
            }

            function _clear_3d() {
                this.css3_transform_container.style('transform', null);
                this.css3_transform_container.style('-webkit-transform', null);
                this.css3_transform_container.style('transform-origin', null);
                this.css3_transform_container.style('-webkit-transform-origin', null);
            }

            function _go_to_svg(scale, translate, callback) {
                this.callback_manager.run('svg_start');
                _.defer(function() {
                    this._clear_3d();
                    this.zoomed_sel.attr('transform', 'translate(' + translate.x + ',' + translate.y + ') ' + 'scale(' + scale + ')');
                    this._svg_scale = this.window_scale;
                    this._svg_translate = this.window_translate;
                    _.defer(function() {
                        this.callback_manager.run('svg_finish');
                        if (!_.isUndefined(callback)) callback();
                    }.bind(this));
                }.bind(this));
            }

            function zoom_by(amount) {
                var size = this.get_size(),
                    shift = {
                        x: size.width / 2 - ((size.width / 2 - this.window_translate.x) * amount +
                            this.window_translate.x),
                        y: size.height / 2 - ((size.height / 2 - this.window_translate.y) * amount +
                            this.window_translate.y)
                    };
                this.go_to(this.window_scale * amount, utils.c_plus_c(this.window_translate, shift));
            }

            function zoom_in() {
                this.zoom_by(1.5);
            }

            function zoom_out() {
                this.zoom_by(0.667);
            }

            function get_size() {
                return {
                    width: parseInt(this.selection.style('width'), 10),
                    height: parseInt(this.selection.style('height'), 10)
                };
            }

            function translate_off_screen(coords) {
                var margin = 120,
                    size = this.get_size(),
                    current = {
                        'x': {
                            'min': -this.window_translate.x / this.window_scale +
                                margin / this.window_scale,
                            'max': -this.window_translate.x / this.window_scale +
                                (size.width - margin) / this.window_scale
                        },
                        'y': {
                            'min': -this.window_translate.y / this.window_scale +
                                margin / this.window_scale,
                            'max': -this.window_translate.y / this.window_scale +
                                (size.height - margin) / this.window_scale
                        }
                    };
                if (coords.x < current.x.min) {
                    this.window_translate.x = this.window_translate.x -
                        (coords.x - current.x.min) * this.window_scale;
                    this.go_to(this.window_scale, this.window_translate);
                } else if (coords.x > current.x.max) {
                    this.window_translate.x = this.window_translate.x -
                        (coords.x - current.x.max) * this.window_scale;
                    this.go_to(this.window_scale, this.window_translate);
                }
                if (coords.y < current.y.min) {
                    this.window_translate.y = this.window_translate.y -
                        (coords.y - current.y.min) * this.window_scale;
                    this.go_to(this.window_scale, this.window_translate);
                } else if (coords.y > current.y.max) {
                    this.window_translate.y = this.window_translate.y -
                        (coords.y - current.y.max) * this.window_scale;
                    this.go_to(this.window_scale, this.window_translate);
                }
            }
        }, {
            "./CallbackManager": 5,
            "./utils": 31,
            "underscore": 35
        }],
        24: [function(require, module, exports) {
            var utils = require('./utils');
            module.exports = {
                new_reaction: new_reaction,
                rotate_nodes: rotate_nodes,
                move_node_and_dependents: move_node_and_dependents,
                new_text_label: new_text_label,
                bezier_id_for_segment_id: bezier_id_for_segment_id,
                bezier_ids_for_reaction_ids: bezier_ids_for_reaction_ids,
                new_beziers_for_segments: new_beziers_for_segments,
                new_beziers_for_reactions: new_beziers_for_reactions
            };

            function new_reaction(bigg_id, cobra_reaction, cobra_metabolites, selected_node_id, selected_node, largest_ids, cofactors, angle) {
                angle = Math.PI / 180 * angle;
                var new_reaction_id = String(++largest_ids.reactions);
                var selected_node_coords = {
                    x: selected_node.x,
                    y: selected_node.y
                };
                var reaction_length = 300,
                    main_axis = [selected_node_coords, utils.c_plus_c(selected_node_coords, {
                        'x': reaction_length,
                        'y': 0
                    })],
                    center = {
                        'x': (main_axis[0].x + main_axis[1].x) / 2,
                        'y': (main_axis[0].y + main_axis[1].y) / 2
                    };
                var label_d;
                if (Math.abs(angle) < Math.PI / 4 || Math.abs(angle - Math.PI) < Math.PI / 4) {
                    label_d = {
                        x: -50,
                        y: -40
                    };
                } else {
                    label_d = {
                        x: 30,
                        y: 10
                    };
                }
                var anchor_distance = 20;
                var new_reaction = utils.clone(cobra_reaction);
                utils.extend(new_reaction, {
                    label_x: center.x + label_d.x,
                    label_y: center.y + label_d.y,
                    segments: {}
                });
                var reactant_ranks = [],
                    product_ranks = [],
                    reactant_count = 0,
                    product_count = 0,
                    reaction_is_reversed = false;
                for (var met_bigg_id in new_reaction.metabolites) {
                    var metabolite = cobra_metabolites[met_bigg_id],
                        coefficient = new_reaction.metabolites[met_bigg_id],
                        formula = metabolite.formula,
                        new_metabolite = {
                            coefficient: coefficient,
                            bigg_id: met_bigg_id,
                            name: metabolite.name
                        };
                    if (coefficient < 0) {
                        new_metabolite.index = reactant_count;
                        var carbons = /C([0-9]+)/.exec(formula);
                        if (selected_node.bigg_id == new_metabolite.bigg_id) {
                            reactant_ranks.push([new_metabolite.index, Infinity]);
                        } else if (carbons && cofactors.indexOf(utils.decompartmentalize(new_metabolite.bigg_id)[0]) == -1) {
                            reactant_ranks.push([new_metabolite.index, parseInt(carbons[1])]);
                        }
                        reactant_count++;
                    } else {
                        new_metabolite.index = product_count;
                        var carbons = /C([0-9]+)/.exec(formula);
                        if (selected_node.bigg_id == new_metabolite.bigg_id) {
                            product_ranks.push([new_metabolite.index, Infinity]);
                            reaction_is_reversed = true;
                        } else if (carbons && cofactors.indexOf(utils.decompartmentalize(new_metabolite.bigg_id)[0]) == -1) {
                            product_ranks.push([new_metabolite.index, parseInt(carbons[1])]);
                        }
                        product_count++;
                    }
                    new_reaction.metabolites[met_bigg_id] = new_metabolite;
                }
                var max_rank = function(old, current) {
                        return current[1] > old[1] ? current : old;
                    },
                    primary_reactant_index = reactant_ranks.reduce(max_rank, [0, 0])[0],
                    primary_product_index = product_ranks.reduce(max_rank, [0, 0])[0];
                for (var met_bigg_id in new_reaction.metabolites) {
                    var metabolite = new_reaction.metabolites[met_bigg_id];
                    if (metabolite.coefficient < 0) {
                        if (metabolite.index == primary_reactant_index) metabolite.is_primary = true;
                        metabolite.count = reactant_count + 1;
                    } else {
                        if (metabolite.index == primary_product_index) metabolite.is_primary = true;
                        metabolite.count = product_count + 1;
                    }
                }
                var new_anchors = {},
                    anchors = [{
                        node_type: 'anchor_reactants',
                        dis: {
                            x: anchor_distance * (reaction_is_reversed ? 1 : -1),
                            y: 0
                        }
                    }, {
                        node_type: 'center',
                        dis: {
                            x: 0,
                            y: 0
                        }
                    }, {
                        node_type: 'anchor_products',
                        dis: {
                            x: anchor_distance * (reaction_is_reversed ? -1 : 1),
                            y: 0
                        }
                    }],
                    anchor_ids = {};
                anchors.map(function(n) {
                    var new_id = String(++largest_ids.nodes),
                        general_node_type = (n.node_type == 'center' ? 'midmarker' : 'multimarker');
                    new_anchors[new_id] = {
                        node_type: general_node_type,
                        x: center.x + n.dis.x,
                        y: center.y + n.dis.y,
                        connected_segments: [],
                        name: null,
                        bigg_id: null,
                        label_x: null,
                        label_y: null,
                        node_is_primary: null
                    };
                    anchor_ids[n.node_type] = new_id;
                });
                var new_anchor_groups = [
                    [anchor_ids['anchor_reactants'], anchor_ids['center']],
                    [anchor_ids['anchor_products'], anchor_ids['center']]
                ];
                new_anchor_groups.map(function(l) {
                    var from_id = l[0],
                        to_id = l[1],
                        new_segment_id = String(++largest_ids.segments);
                    new_reaction.segments[new_segment_id] = {
                        b1: null,
                        b2: null,
                        from_node_id: from_id,
                        to_node_id: to_id,
                        from_node_coefficient: null,
                        to_node_coefficient: null,
                        reversibility: new_reaction.reversibility,
                        data: new_reaction.data,
                        reverse_flux: new_reaction.reverse_flux
                    };
                    new_anchors[from_id].connected_segments.push({
                        segment_id: new_segment_id,
                        reaction_id: new_reaction_id
                    });
                    new_anchors[to_id].connected_segments.push({
                        segment_id: new_segment_id,
                        reaction_id: new_reaction_id
                    });
                });
                var new_nodes = new_anchors;
                for (var met_bigg_id in new_reaction.metabolites) {
                    var metabolite = new_reaction.metabolites[met_bigg_id],
                        primary_index, from_node_id;
                    if (metabolite.coefficient < 0) {
                        primary_index = primary_reactant_index;
                        from_node_id = anchor_ids['anchor_reactants'];
                    } else {
                        primary_index = primary_product_index;
                        from_node_id = anchor_ids['anchor_products'];
                    }
                    var met_loc = calculate_new_metabolite_coordinates(metabolite, primary_index, main_axis, center, reaction_length, reaction_is_reversed);
                    if (selected_node.bigg_id == metabolite.bigg_id) {
                        var new_segment_id = String(++largest_ids.segments);
                        new_reaction.segments[new_segment_id] = {
                            b1: met_loc.b1,
                            b2: met_loc.b2,
                            from_node_id: from_node_id,
                            to_node_id: selected_node_id,
                            from_node_coefficient: null,
                            to_node_coefficient: metabolite.coefficient,
                            reversibility: new_reaction.reversibility,
                            data: new_reaction.data,
                            reverse_flux: new_reaction.reverse_flux
                        };
                        selected_node.connected_segments.push({
                            segment_id: new_segment_id,
                            reaction_id: new_reaction_id
                        });
                        new_nodes[from_node_id].connected_segments.push({
                            segment_id: new_segment_id,
                            reaction_id: new_reaction_id
                        });
                    } else {
                        var new_segment_id = String(++largest_ids.segments),
                            new_node_id = String(++largest_ids.nodes);
                        new_reaction.segments[new_segment_id] = {
                            b1: met_loc.b1,
                            b2: met_loc.b2,
                            from_node_id: from_node_id,
                            to_node_id: new_node_id,
                            from_node_coefficient: null,
                            to_node_coefficient: metabolite.coefficient,
                            reversibility: new_reaction.reversibility,
                            data: new_reaction.data,
                            reverse_flux: new_reaction.reverse_flux
                        };
                        new_nodes[new_node_id] = {
                            connected_segments: [{
                                segment_id: new_segment_id,
                                reaction_id: new_reaction_id
                            }],
                            x: met_loc.circle.x,
                            y: met_loc.circle.y,
                            node_is_primary: Boolean(metabolite.is_primary),
                            label_x: met_loc.circle.x + label_d.x,
                            label_y: met_loc.circle.y + label_d.y,
                            name: metabolite.name,
                            bigg_id: metabolite.bigg_id,
                            node_type: 'metabolite'
                        };
                        new_nodes[from_node_id].connected_segments.push({
                            segment_id: new_segment_id,
                            reaction_id: new_reaction_id
                        });
                    }
                }
                var metabolites_array = []
                for (var bigg_id in new_reaction.metabolites) {
                    metabolites_array.push({
                        'bigg_id': bigg_id,
                        'coefficient': new_reaction.metabolites[bigg_id].coefficient
                    });
                }
                new_reaction.metabolites = metabolites_array;
                var new_reactions = {};
                new_reactions[new_reaction_id] = new_reaction;
                var new_beziers = new_beziers_for_reactions(new_reactions);
                new_nodes[selected_node_id] = selected_node;
                rotate_nodes(new_nodes, new_reactions, new_beziers, angle, selected_node_coords);
                return {
                    new_reactions: new_reactions,
                    new_beziers: new_beziers,
                    new_nodes: new_nodes
                };
            }

            function rotate_nodes(selected_nodes, reactions, beziers, angle, center) {
                var rotate_around = function(coord) {
                    if (coord === null)
                        return null;
                    return utils.rotate_coords(coord, angle, center);
                };
                var updated_node_ids = [],
                    updated_reaction_ids = [];
                for (var node_id in selected_nodes) {
                    var node = selected_nodes[node_id],
                        displacement = rotate_around({
                            x: node.x,
                            y: node.y
                        }),
                        updated = move_node_and_labels(node, reactions, displacement);
                    node.connected_segments.map(function(segment_obj) {
                        var reaction = reactions[segment_obj.reaction_id];
                        if (reaction === undefined) return;
                        var segment_id = segment_obj.segment_id,
                            segment = reaction.segments[segment_id];
                        if (segment.to_node_id == node_id && segment.b2) {
                            var displacement = rotate_around(segment.b2),
                                bez_id = bezier_id_for_segment_id(segment_id, 'b2');
                            segment.b2 = utils.c_plus_c(segment.b2, displacement);
                            beziers[bez_id].x = segment.b2.x;
                            beziers[bez_id].y = segment.b2.y;
                        } else if (segment.from_node_id == node_id && segment.b1) {
                            var displacement = rotate_around(segment.b1),
                                bez_id = bezier_id_for_segment_id(segment_id, 'b1');
                            segment.b1 = utils.c_plus_c(segment.b1, displacement);
                            beziers[bez_id].x = segment.b1.x;
                            beziers[bez_id].y = segment.b1.y;
                        }
                    });
                    updated_reaction_ids = utils.unique_concat([updated_reaction_ids, updated.reaction_ids]);
                    updated_node_ids.push(node_id);
                }
                return {
                    node_ids: updated_node_ids,
                    reaction_ids: updated_reaction_ids
                };
            }

            function move_node_and_dependents(node, node_id, reactions, beziers, displacement) {
                var updated = move_node_and_labels(node, reactions, displacement);
                node.connected_segments.map(function(segment_obj) {
                    var reaction = reactions[segment_obj.reaction_id];
                    if (reaction === undefined) return;
                    var segment_id = segment_obj.segment_id,
                        segment = reaction.segments[segment_id];
                    [
                        ['b1', 'from_node_id'],
                        ['b2', 'to_node_id']
                    ].forEach(function(c) {
                        var bez = c[0],
                            node = c[1];
                        if (segment[node] == node_id && segment[bez]) {
                            segment[bez] = utils.c_plus_c(segment[bez], displacement);
                            var tbez = beziers[bezier_id_for_segment_id(segment_id, bez)];
                            tbez.x = segment[bez].x;
                            tbez.y = segment[bez].y;
                        }
                    });
                    if (updated.reaction_ids.indexOf(segment_obj.reaction_id) < 0) {
                        updated.reaction_ids.push(segment_obj.reaction_id);
                    }
                });
                return updated;
            }

            function move_node_and_labels(node, reactions, displacement) {
                node.x = node.x + displacement.x;
                node.y = node.y + displacement.y;
                node.label_x = node.label_x + displacement.x;
                node.label_y = node.label_y + displacement.y;
                var updated_reaction_ids = [];
                node.connected_segments.map(function(segment_obj) {
                    var reaction = reactions[segment_obj.reaction_id];
                    if (updated_reaction_ids.indexOf(segment_obj.reaction_id) < 0) {
                        updated_reaction_ids.push(segment_obj.reaction_id);
                        if (node.node_type == 'midmarker') {
                            reaction.label_x = reaction.label_x + displacement.x;
                            reaction.label_y = reaction.label_y + displacement.y;
                        }
                    }
                });
                return {
                    reaction_ids: updated_reaction_ids
                };
            }

            function calculate_new_metabolite_coordinates(met, primary_index, main_axis, center, dis, is_reversed) {
                var displacement = main_axis[0],
                    main_axis = [utils.c_minus_c(main_axis[0], displacement), utils.c_minus_c(main_axis[1], displacement)],
                    center = utils.c_minus_c(center, displacement);
                var w = 80,
                    b1_strength = 0.4,
                    b2_strength = 0.25,
                    w2 = w * 0.7,
                    secondary_dis = 40,
                    num_slots = Math.min(2, met.count - 1);
                var ds, draw_at_index, r;
                if (met.is_primary) {
                    ds = 20;
                } else {
                    ds = 10;
                    if (met.index > primary_index) draw_at_index = met.index - 1;
                    else draw_at_index = met.index;
                }
                var de = dis - ds,
                    reaction_axis = [{
                        'x': ds,
                        'y': 0
                    }, {
                        'x': de,
                        'y': 0
                    }];
                var end, circle, b1, b2;
                if (((met.coefficient < 0) != is_reversed) && met.is_primary) {
                    end = {
                        'x': reaction_axis[0].x,
                        'y': reaction_axis[0].y
                    };
                    b1 = {
                        'x': center.x * (1 - b1_strength) + reaction_axis[0].x * b1_strength,
                        'y': center.y * (1 - b1_strength) + reaction_axis[0].y * b1_strength
                    };
                    b2 = {
                        'x': center.x * b2_strength + (end.x) * (1 - b2_strength),
                        'y': center.y * b2_strength + (end.y) * (1 - b2_strength)
                    }, circle = {
                        'x': main_axis[0].x,
                        'y': main_axis[0].y
                    };
                } else if ((met.coefficient < 0) != is_reversed) {
                    end = {
                        'x': reaction_axis[0].x + secondary_dis,
                        'y': reaction_axis[0].y + (w2 * draw_at_index - w2 * (num_slots - 1) / 2)
                    }, b1 = {
                        'x': center.x * (1 - b1_strength) + reaction_axis[0].x * b1_strength,
                        'y': center.y * (1 - b1_strength) + reaction_axis[0].y * b1_strength
                    }, b2 = {
                        'x': center.x * b2_strength + end.x * (1 - b2_strength),
                        'y': center.y * b2_strength + end.y * (1 - b2_strength)
                    }, circle = {
                        'x': main_axis[0].x + secondary_dis,
                        'y': main_axis[0].y + (w * draw_at_index - w * (num_slots - 1) / 2)
                    };
                } else if (((met.coefficient > 0) != is_reversed) && met.is_primary) {
                    end = {
                        'x': reaction_axis[1].x,
                        'y': reaction_axis[1].y
                    };
                    b1 = {
                        'x': center.x * (1 - b1_strength) + reaction_axis[1].x * b1_strength,
                        'y': center.y * (1 - b1_strength) + reaction_axis[1].y * b1_strength
                    };
                    b2 = {
                        'x': center.x * b2_strength + end.x * (1 - b2_strength),
                        'y': center.y * b2_strength + end.y * (1 - b2_strength)
                    }, circle = {
                        'x': main_axis[1].x,
                        'y': main_axis[1].y
                    };
                } else if ((met.coefficient > 0) != is_reversed) {
                    end = {
                        'x': reaction_axis[1].x - secondary_dis,
                        'y': reaction_axis[1].y + (w2 * draw_at_index - w2 * (num_slots - 1) / 2)
                    }, b1 = {
                        'x': center.x * (1 - b1_strength) + reaction_axis[1].x * b1_strength,
                        'y': center.y * (1 - b1_strength) + reaction_axis[1].y * b1_strength
                    };
                    b2 = {
                        'x': center.x * b2_strength + end.x * (1 - b2_strength),
                        'y': center.y * b2_strength + end.y * (1 - b2_strength)
                    }, circle = {
                        'x': main_axis[1].x - secondary_dis,
                        'y': main_axis[1].y + (w * draw_at_index - w * (num_slots - 1) / 2)
                    };
                }
                var loc = {};
                loc.b1 = utils.c_plus_c(displacement, b1);
                loc.b2 = utils.c_plus_c(displacement, b2);
                loc.circle = utils.c_plus_c(displacement, circle);
                return loc;
            }

            function new_text_label(largest_ids, text, coords) {
                var new_id = String(++largest_ids.text_labels),
                    new_label = {
                        text: text,
                        x: coords.x,
                        y: coords.y
                    };
                return {
                    id: new_id,
                    label: new_label
                };
            }

            function bezier_id_for_segment_id(segment_id, bez) {
                return segment_id + '_' + bez;
            }

            function bezier_ids_for_reaction_ids(reactions) {
                var bezier_ids = [];
                for (var reaction_id in reactions) {
                    var reaction = reactions[reaction_id];
                    for (var segment_id in reaction.segments) {
                        var segment = reaction.segments[segment_id];
                        ['b1', 'b2'].forEach(function(bez) {
                            var seg_bez = segment[bez];
                            if (seg_bez !== null) {
                                bezier_ids.push(bezier_id_for_segment_id(segment_id, bez));
                            }
                        });
                    }
                }
                return bezier_ids;
            }

            function new_beziers_for_segments(segments, reaction_id) {
                var beziers = {};
                for (var segment_id in segments) {
                    var segment = segments[segment_id];
                    ['b1', 'b2'].forEach(function(bez) {
                        var seg_bez = segment[bez];
                        if (seg_bez !== null) {
                            var bezier_id = bezier_id_for_segment_id(segment_id, bez);
                            beziers[bezier_id] = {
                                bezier: bez,
                                x: seg_bez.x,
                                y: seg_bez.y,
                                reaction_id: reaction_id,
                                segment_id: segment_id
                            };
                        }
                    });
                }
                return beziers;
            }

            function new_beziers_for_reactions(reactions) {
                var beziers = {};
                for (var reaction_id in reactions) {
                    var reaction = reactions[reaction_id];
                    var these = new_beziers_for_segments(reaction.segments, reaction_id);
                    utils.extend(beziers, these);
                }
                return beziers;
            }
        }, {
            "./utils": 31
        }],
        25: [function(require, module, exports) {
            var utils = require('./utils');
            module.exports = function(container, config) {
                document = utils.get_document(container);
                window = utils.get_window(container);
                config = config || {};
                config.fontSize = config.fontSize || '13px';
                config.fontFamily = config.fontFamily || 'sans-serif';
                config.promptInnerHTML = config.promptInnerHTML || '';
                config.color = config.color || '#333';
                config.hintColor = config.hintColor || '#aaa';
                config.backgroundColor = config.backgroundColor || '#fff';
                config.dropDownBorderColor = config.dropDownBorderColor || '#aaa';
                config.dropDownZIndex = config.dropDownZIndex || '100';
                config.dropDownOnHoverBackgroundColor = config.dropDownOnHoverBackgroundColor || '#ddd';
                var txtInput = document.createElement('input');
                txtInput.type = 'text';
                txtInput.spellcheck = false;
                txtInput.style.fontSize = config.fontSize;
                txtInput.style.fontFamily = config.fontFamily;
                txtInput.style.color = config.color;
                txtInput.style.backgroundColor = config.backgroundColor;
                txtInput.style.width = '100%';
                txtInput.style.outline = '0';
                txtInput.style.border = '0';
                txtInput.style.margin = '0';
                txtInput.style.padding = '0';
                var txtHint = txtInput.cloneNode();
                txtHint.disabled = '';
                txtHint.style.position = 'absolute';
                txtHint.style.top = '0';
                txtHint.style.left = '0';
                txtHint.style.borderColor = 'transparent';
                txtHint.style.boxShadow = 'none';
                txtHint.style.color = config.hintColor;
                txtInput.style.backgroundColor = 'transparent';
                txtInput.style.verticalAlign = 'top';
                txtInput.style.position = 'relative';
                var wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                wrapper.style.outline = '0';
                wrapper.style.border = '0';
                wrapper.style.margin = '0';
                wrapper.style.padding = '0';
                var prompt = document.createElement('div');
                prompt.style.position = 'absolute';
                prompt.style.outline = '0';
                prompt.style.margin = '0';
                prompt.style.padding = '0';
                prompt.style.border = '0';
                prompt.style.fontSize = config.fontSize;
                prompt.style.fontFamily = config.fontFamily;
                prompt.style.color = config.color;
                prompt.style.backgroundColor = config.backgroundColor;
                prompt.style.top = '0';
                prompt.style.left = '0';
                prompt.style.overflow = 'hidden';
                prompt.innerHTML = config.promptInnerHTML;
                prompt.style.background = 'transparent';
                if (document.body === undefined) {
                    throw 'document.body is undefined. The library was wired up incorrectly.';
                }
                document.body.appendChild(prompt);
                var w = prompt.getBoundingClientRect().right;
                wrapper.appendChild(prompt);
                prompt.style.visibility = 'visible';
                prompt.style.left = '-' + w + 'px';
                wrapper.style.marginLeft = w + 'px';
                wrapper.appendChild(txtHint);
                wrapper.appendChild(txtInput);
                var dropDown = document.createElement('div');
                dropDown.style.position = 'absolute';
                dropDown.style.visibility = 'hidden';
                dropDown.style.outline = '0';
                dropDown.style.margin = '0';
                dropDown.style.padding = '0';
                dropDown.style.textAlign = 'left';
                dropDown.style.fontSize = config.fontSize;
                dropDown.style.fontFamily = config.fontFamily;
                dropDown.style.backgroundColor = config.backgroundColor;
                dropDown.style.zIndex = config.dropDownZIndex;
                dropDown.style.cursor = 'default';
                dropDown.style.borderStyle = 'solid';
                dropDown.style.borderWidth = '1px';
                dropDown.style.borderColor = config.dropDownBorderColor;
                dropDown.style.overflowX = 'hidden';
                dropDown.style.whiteSpace = 'pre';
                dropDown.style.overflowY = 'scroll';
                var createDropDownController = function(elem) {
                    var rows = [];
                    var ix = 0;
                    var oldIndex = -1;
                    var current_row = null;
                    var onMouseOver = function() {
                        this.style.outline = '1px solid #ddd';
                    }
                    var onMouseOut = function() {
                        this.style.outline = '0';
                    }
                    var onDblClick = function(e) {
                        e.preventDefault();
                        p.onmouseselection(this.id);
                    }
                    var p = {
                        hide: function() {
                            elem.style.visibility = 'hidden';
                        },
                        refresh: function(token, options) {
                            elem.style.visibility = 'hidden';
                            ix = 0;
                            elem.innerHTML = '';
                            var vph = (window.innerHeight || document.documentElement.clientHeight);
                            var rect = elem.parentNode.getBoundingClientRect();
                            var distanceToTop = rect.top - 6;
                            var distanceToBottom = vph - rect.bottom - 6;
                            rows = [];
                            for (var i = 0; i < options.length; i++) {
                                var found = options[i].matches.filter(function(match) {
                                    return match.toLowerCase().indexOf(token.toLowerCase()) == 0;
                                });
                                if (found.length == 0)
                                    continue;
                                var divRow = document.createElement('div');
                                divRow.style.color = config.color;
                                divRow.onmouseover = onMouseOver;
                                divRow.onmouseout = onMouseOut;
                                divRow.onmousedown = function(e) {
                                    e.preventDefault();
                                };
                                divRow.ondblclick = onDblClick;
                                divRow.__hint = found[0];
                                divRow.id = options[i].id;
                                divRow.innerHTML = options[i].html;
                                rows.push(divRow);
                                elem.appendChild(divRow);
                                if (rows.length >= rs.display_limit) {
                                    var divRow2 = document.createElement('div');
                                    divRow2.innerHTML = ' ' + (options.length - rows.length) + ' more';
                                    rows.push(divRow2);
                                    elem.appendChild(divRow2);
                                    break;
                                }
                            }
                            if (rows.length === 0) {
                                return;
                            }
                            p.highlight(0);
                            if (distanceToTop > distanceToBottom * 3) {
                                elem.style.maxHeight = distanceToTop + 'px';
                                elem.style.top = '';
                                elem.style.bottom = '100%';
                            } else {
                                elem.style.top = '100%';
                                elem.style.bottom = '';
                                elem.style.maxHeight = distanceToBottom + 'px';
                            }
                            elem.style.visibility = 'visible';
                        },
                        highlight: function(index) {
                            if (oldIndex != -1 && rows[oldIndex]) {
                                rows[oldIndex].style.backgroundColor = config.backgroundColor;
                            }
                            rows[index].style.backgroundColor = config.dropDownOnHoverBackgroundColor;
                            oldIndex = index;
                            current_row = rows[index];
                        },
                        move: function(step) {
                            if (elem.style.visibility === 'hidden')
                                return '';
                            if (ix + step === -1 || ix + step === rows.length)
                                return rows[ix].__hint;
                            ix += step;
                            p.highlight(ix);
                            return rows[ix].__hint;
                        },
                        onmouseselection: function() {},
                        get_current_row: function() {
                            return current_row;
                        }
                    };
                    return p;
                }
                var dropDownController = createDropDownController(dropDown);
                dropDownController.onmouseselection = function(id) {
                    rs.onEnter(id)
                    rs.input.focus();
                }
                wrapper.appendChild(dropDown);
                container.appendChild(wrapper);
                var spacer, leftSide;

                function calculateWidthForText(text) {
                    if (spacer === undefined) {
                        spacer = document.createElement('span');
                        spacer.style.visibility = 'hidden';
                        spacer.style.position = 'fixed';
                        spacer.style.outline = '0';
                        spacer.style.margin = '0';
                        spacer.style.padding = '0';
                        spacer.style.border = '0';
                        spacer.style.left = '0';
                        spacer.style.whiteSpace = 'pre';
                        spacer.style.fontSize = config.fontSize;
                        spacer.style.fontFamily = config.fontFamily;
                        spacer.style.fontWeight = 'normal';
                        document.body.appendChild(spacer);
                    }
                    spacer.innerHTML = String(text).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return spacer.getBoundingClientRect().right;
                }
                var rs = {
                    get_hint: function(x) {
                        return x;
                    },
                    display_limit: 1000,
                    onArrowDown: function() {},
                    onArrowUp: function() {},
                    onEnter: function() {},
                    onTab: function() {},
                    onChange: function() {
                        rs.repaint()
                    },
                    startFrom: 0,
                    options: [],
                    wrapper: wrapper,
                    input: txtInput,
                    hint: txtHint,
                    dropDown: dropDown,
                    prompt: prompt,
                    setText: function(text) {
                        txtHint.value = text;
                        txtInput.value = text;
                    },
                    getText: function() {
                        return txtInput.value;
                    },
                    hideDropDown: function() {
                        dropDownController.hide();
                    },
                    repaint: function() {
                        var text = txtInput.value;
                        var startFrom = rs.startFrom;
                        var options = rs.options;
                        var optionsLength = options.length;
                        var token = text.substring(startFrom);
                        leftSide = text.substring(0, startFrom);
                        txtHint.value = '';
                        for (var i = 0; i < optionsLength; i++) {
                            var found = options[i].matches.filter(function(match) {
                                return match.toLowerCase().indexOf(token.toLowerCase()) == 0;
                            });
                            if (found.length == 0)
                                continue;
                            txtHint.value = rs.get_hint(found[0]);
                            break;
                        }
                        dropDown.style.left = calculateWidthForText(leftSide) + 'px';
                        dropDownController.refresh(token, rs.options);
                    }
                };
                var registerOnTextChangeOldValue;
                var registerOnTextChange = function(txt, callback) {
                    registerOnTextChangeOldValue = txt.value;
                    var handler = function() {
                        var value = txt.value;
                        if (registerOnTextChangeOldValue !== value) {
                            registerOnTextChangeOldValue = value;
                            callback(value);
                        }
                    };
                    txt.addEventListener("input", handler, false);
                    txt.addEventListener('keyup', handler, false);
                    txt.addEventListener('change', handler, false);
                };
                registerOnTextChange(txtInput, function(text) {
                    rs.onChange(text);
                    rs.repaint();
                });
                var keyDownHandler = function(e) {
                    e = e || window.event;
                    var keyCode = e.keyCode;
                    if (keyCode == 33) {
                        return;
                    }
                    if (keyCode == 34) {
                        return;
                    }
                    if (keyCode == 39 || keyCode == 35 || keyCode == 9) {
                        if (keyCode == 9) {
                            e.preventDefault();
                            e.stopPropagation();
                            if (txtHint.value.length == 0) {
                                rs.onTab();
                            }
                        }
                        if (txtHint.value.length > 0) {
                            txtInput.value = txtHint.value;
                            var hasTextChanged = registerOnTextChangeOldValue != txtInput.value
                            registerOnTextChangeOldValue = txtInput.value;
                            if (hasTextChanged) {
                                rs.onChange(txtInput.value);
                            }
                        }
                        return;
                    }
                    if (keyCode == 13) {
                        var id = dropDownController.get_current_row().id;
                        rs.onEnter(id);
                        return;
                    }
                    if (keyCode == 40) {
                        var m = dropDownController.move(+1);
                        if (m == '') {
                            rs.onArrowDown();
                        }
                        txtHint.value = rs.get_hint(m);
                        return;
                    }
                    if (keyCode == 38) {
                        var m = dropDownController.move(-1);
                        if (m == '') {
                            rs.onArrowUp();
                        }
                        txtHint.value = rs.get_hint(m);
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    txtHint.value = '';
                };
                txtInput.addEventListener("keydown", keyDownHandler, false);
                return rs;
            };
        }, {
            "./utils": 31
        }],
        26: [function(require, module, exports) {
            var utils = require('./utils');
            var _ = require('underscore');
            module.exports = {
                import_and_check: import_and_check,
                text_for_data: text_for_data,
                float_for_data: float_for_data,
                reverse_flux_for_data: reverse_flux_for_data,
                gene_string_for_data: gene_string_for_data,
                csv_converter: csv_converter,
                genes_for_gene_reaction_rule: genes_for_gene_reaction_rule,
                evaluate_gene_reaction_rule: evaluate_gene_reaction_rule,
                replace_gene_in_rule: replace_gene_in_rule,
                apply_reaction_data_to_reactions: apply_reaction_data_to_reactions,
                apply_metabolite_data_to_nodes: apply_metabolite_data_to_nodes,
                apply_gene_data_to_reactions: apply_gene_data_to_reactions
            };
            var RETURN_ARG = function(x) {
                    return x;
                },
                ESCAPE_REG = /([.*+?^=!:${}()|\[\]\/\\])/g,
                EMPTY_LINES = /\n\s*\n/g,
                TRAILING_NEWLINE = /\n\s*(\)*)\s*$/,
                AND_OR = /([\(\) ])(?:and|or)([\)\( ])/ig,
                ALL_PARENS = /[\(\)]/g,
                EXCESS_PARENS = /\(\s*(\S+)\s*\)/g,
                OR = /\s+or\s+/i,
                AND = /\s+and\s+/i,
                OR_EXPRESSION = /(^|\()(\s*-?[0-9.]+\s+(?:or\s+-?[0-9.]+\s*)+)(\)|$)/ig,
                AND_EXPRESSION = /(^|\(|or\s)(\s*-?[0-9.]+\s+(?:and\s+-?[0-9.]+\s*)+)(\sor|\)|$)/ig;

            function import_and_check(data, name, all_reactions) {
                if (data === null)
                    return null;
                if (['reaction_data', 'metabolite_data', 'gene_data'].indexOf(name) == -1)
                    throw new Error('Invalid name argument: ' + name);
                if (!(data instanceof Array)) {
                    data = [data];
                }
                var check = function() {
                    if (data === null)
                        return null;
                    if (data.length == 1)
                        return null;
                    if (data.length == 2)
                        return null;
                    return console.warn('Bad data style: ' + name);
                };
                check();
                data = utils.array_to_object(data);
                if (name == 'gene_data') {
                    if (all_reactions === undefined)
                        throw new Error('Must pass all_reactions argument for gene_data');
                    data = align_gene_data_to_reactions(data, all_reactions);
                }
                return data;

                function align_gene_data_to_reactions(data, reactions) {
                    var aligned = {},
                        null_val = [null];
                    for (var first_gene_id in data) {
                        null_val = data[first_gene_id].map(function() {
                            return null;
                        });
                        break;
                    }
                    for (var reaction_id in reactions) {
                        var reaction = reactions[reaction_id],
                            bigg_id = reaction.bigg_id,
                            this_gene_data = {};
                        reaction.genes.forEach(function(gene) {
                            ['bigg_id', 'name'].forEach(function(kind) {
                                var d = data[gene[kind]] || utils.clone(null_val);
                                var existing_d = this_gene_data[gene.bigg_id];
                                if (typeof existing_d === 'undefined') {
                                    this_gene_data[gene.bigg_id] = d;
                                } else {
                                    for (var i = 0; i < d.length; i++) {
                                        var pnt = d[i];
                                        if (pnt !== null)
                                            existing_d[i] = pnt;
                                    }
                                }
                            });
                        });
                        aligned[bigg_id] = this_gene_data;
                    }
                    return aligned;
                }
            }

            function float_for_data(d, styles, compare_style) {
                if (d === null)
                    return null;
                var take_abs = (styles.indexOf('abs') != -1);
                if (d.length == 1) {
                    var f = _parse_float_or_null(d[0]);
                    if (f === null)
                        return null;
                    return abs(f, take_abs);
                } else if (d.length == 2) {
                    var fs = d.map(_parse_float_or_null);
                    if (fs[0] === null || fs[1] === null)
                        return null;
                    if (compare_style == 'diff') {
                        return diff(fs[0], fs[1], take_abs);
                    } else if (compare_style == 'fold') {
                        return check_finite(fold(fs[0], fs[1], take_abs));
                    } else if (compare_style == 'log2_fold') {
                        return check_finite(log2_fold(fs[0], fs[1], take_abs));
                    }
                } else {
                    throw new Error('Data array must be of length 1 or 2');
                }
                throw new Error('Bad data compare_style: ' + compare_style);

                function check_finite(x) {
                    return isFinite(x) ? x : null;
                }

                function abs(x, take_abs) {
                    return take_abs ? Math.abs(x) : x;
                }

                function diff(x, y, take_abs) {
                    if (take_abs) return Math.abs(y - x);
                    else return y - x;
                }

                function fold(x, y, take_abs) {
                    if (x == 0 || y == 0) return null;
                    var fold = (y >= x ? y / x : -x / y);
                    return take_abs ? Math.abs(fold) : fold;
                }

                function log2_fold(x, y, take_abs) {
                    if (x == 0) return null;
                    if (y / x < 0) return null;
                    var log = Math.log(y / x) / Math.log(2);
                    return take_abs ? Math.abs(log) : log;
                }
            }

            function reverse_flux_for_data(d) {
                if (d === null || d[0] === null)
                    return false;
                return (d[0] < 0);
            }

            function gene_string_for_data(rule, gene_values, genes, styles, identifiers_on_map, compare_style) {
                var out_text = rule
                var no_data = (gene_values === null)
                var genes_found = {}
                genes.forEach(function(g_obj) {
                    var bigg_id = g_obj.bigg_id
                    if (bigg_id in genes_found) return
                    genes_found[bigg_id] = true
                    if (no_data) {
                        out_text = replace_gene_in_rule(out_text, bigg_id, bigg_id + '\n')
                    } else {
                        if (!(bigg_id in gene_values))
                            return
                        var d = gene_values[bigg_id]
                        var f = float_for_data(d, styles, compare_style)
                        var format = (f === null ? RETURN_ARG : d3.format('.3g'))
                        if (d.length === 1) {
                            out_text = replace_gene_in_rule(out_text, bigg_id, bigg_id + ' (' + null_or_d(d[0], format) + ')\n')
                        } else if (d.length === 2) {
                            var new_str
                            var any_num = _.any(d, function(x) {
                                return _parse_float_or_null(x) !== null
                            })
                            if (any_num) {
                                new_str = (bigg_id + ' (' +
                                    null_or_d(d[0], format) + ', ' +
                                    null_or_d(d[1], format) + ': ' +
                                    null_or_d(f, format) + ')\n');
                            } else {
                                new_str = (bigg_id + ' (' +
                                    null_or_d(d[0], format) + ', ' +
                                    null_or_d(d[1], format) + ')\n')
                            }
                            out_text = replace_gene_in_rule(out_text, bigg_id, new_str)
                        }
                    }
                })
                out_text = (out_text.replace(EMPTY_LINES, '\n').replace(TRAILING_NEWLINE, '$1'))
                var result = out_text.split('\n').map(function(text) {
                    for (var i = 0, l = genes.length; i < l; i++) {
                        var gene = genes[i]
                        if (text.indexOf(gene.bigg_id) !== -1) {
                            if (identifiers_on_map === 'name')
                                text = replace_gene_in_rule(text, gene.bigg_id, gene.name)
                            return {
                                bigg_id: gene.bigg_id,
                                name: gene.name,
                                text: text
                            }
                        }
                    }
                    return {
                        bigg_id: null,
                        name: null,
                        text: text
                    }
                })
                return result

                function null_or_d(d, format) {
                    return d === null ? 'nd' : format(d)
                }
            }

            function text_for_data(d, f) {
                if (d === null)
                    return null_or_d(null);
                if (d.length == 1) {
                    var format = (f === null ? RETURN_ARG : d3.format('.3g'));
                    return null_or_d(d[0], format);
                }
                if (d.length == 2) {
                    var format = (f === null ? RETURN_ARG : d3.format('.3g')),
                        t = null_or_d(d[0], format);
                    t += ', ' + null_or_d(d[1], format);
                    t += ': ' + null_or_d(f, format);
                    return t;
                }
                return '';

                function null_or_d(d, format) {
                    return d === null ? '(nd)' : format(d);
                }
            }

            function csv_converter(csv_rows) {
                var c = csv_rows[0].length,
                    converted = [];
                if (c < 2 || c > 3)
                    throw new Error('CSV file must have 2 or 3 columns');
                for (var i = 1; i < c; i++) {
                    converted[i - 1] = {};
                }
                csv_rows.slice(1).forEach(function(row) {
                    for (var i = 1, l = row.length; i < l; i++) {
                        converted[i - 1][row[0]] = row[i];
                    }
                });
                return converted;
            }

            function genes_for_gene_reaction_rule(rule) {
                var genes = rule.replace(AND_OR, '$1$2').replace(ALL_PARENS, '').split(' ').filter(function(x) {
                    return x != '';
                });
                return utils.unique_strings_array(genes);
            }

            function evaluate_gene_reaction_rule(rule, gene_values, and_method_in_gene_reaction_rule) {
                var null_val = [null],
                    l = 1;
                for (var gene_id in gene_values) {
                    null_val = gene_values[gene_id].map(function() {
                        return null;
                    });
                    l = null_val.length;
                    break;
                }
                if (rule == '') return utils.clone(null_val);
                var out = [];
                for (var i = 0; i < l; i++) {
                    var curr_val = rule;
                    var all_null = true;
                    for (var gene_id in gene_values) {
                        var f = _parse_float_or_null(gene_values[gene_id][i]);
                        if (f === null) {
                            f = 0;
                        } else {
                            all_null = false;
                        }
                        curr_val = replace_gene_in_rule(curr_val, gene_id, f);
                    }
                    if (all_null) {
                        out.push(null);
                        continue;
                    }
                    while (true) {
                        var new_curr_val = curr_val;
                        new_curr_val = new_curr_val.replace(EXCESS_PARENS, ' $1 ');
                        new_curr_val = new_curr_val.replace(OR_EXPRESSION, function(match, p1, p2, p3) {
                            var nums = p2.split(OR).map(parseFloat),
                                sum = nums.reduce(function(a, b) {
                                    return a + b;
                                });
                            return p1 + sum + p3;
                        });
                        new_curr_val = new_curr_val.replace(AND_EXPRESSION, function(match, p1, p2, p3) {
                            var nums = p2.split(AND).map(parseFloat),
                                val = (and_method_in_gene_reaction_rule == 'min' ? Math.min.apply(null, nums) : nums.reduce(function(a, b) {
                                    return a + b;
                                }) / nums.length);
                            return p1 + val + p3;
                        });
                        if (new_curr_val == curr_val)
                            break;
                        curr_val = new_curr_val;
                    }
                    var num = Number(curr_val);
                    if (isNaN(num)) {
                        console.warn('Could not evaluate ' + rule);
                        out.push(null);
                    } else {
                        out.push(num);
                    }
                }
                return out;
            }

            function replace_gene_in_rule(rule, gene_id, val) {
                var space_or_par_start = '(^|[\\\s\\\(\\\)])'
                var space_or_par_finish = '([\\\s\\\(\\\)]|$)'
                var escaped = space_or_par_start + escape_reg_exp(gene_id) + space_or_par_finish
                return rule.replace(new RegExp(escaped, 'g'), '$1' + val + '$2')

                function escape_reg_exp(string) {
                    return string.replace(ESCAPE_REG, "\\$1")
                }
            }

            function apply_reaction_data_to_reactions(reactions, data, styles, compare_style) {
                var reaction_id, reaction, segment_id, segment;
                if (data === null) {
                    for (reaction_id in reactions) {
                        reaction = reactions[reaction_id];
                        reaction.data = null;
                        reaction.data_string = '';
                        for (segment_id in reaction.segments) {
                            segment = reaction.segments[segment_id];
                            segment.data = null;
                        }
                        reaction.gene_string = null;
                    }
                    return false;
                }
                for (reaction_id in reactions) {
                    reaction = reactions[reaction_id];
                    var d = data[reaction.bigg_id] || data[reaction.name] || null,
                        f = float_for_data(d, styles, compare_style),
                        r = reverse_flux_for_data(d),
                        s = text_for_data(d, f);
                    reaction.data = f;
                    reaction.data_string = s;
                    reaction.reverse_flux = r;
                    reaction.gene_string = null;
                    for (segment_id in reaction.segments) {
                        segment = reaction.segments[segment_id];
                        segment.data = reaction.data;
                        segment.reverse_flux = reaction.reverse_flux;
                    }
                }
                return true;
            }

            function apply_metabolite_data_to_nodes(nodes, data, styles, compare_style) {
                var node_id;
                if (data === null) {
                    for (node_id in nodes) {
                        nodes[node_id].data = null;
                        nodes[node_id].data_string = '';
                    }
                    return false;
                }
                for (node_id in nodes) {
                    var node = nodes[node_id];
                    var d = data[node.bigg_id] || data[node.name] || null,
                        f = float_for_data(d, styles, compare_style),
                        s = text_for_data(d, f);
                    node.data = f;
                    node.data_string = s;
                }
                return true;
            }

            function apply_gene_data_to_reactions(reactions, gene_data_obj, styles, identifiers_on_map, compare_style, and_method_in_gene_reaction_rule) {
                if (gene_data_obj === null) {
                    for (var reaction_id in reactions) {
                        var reaction = reactions[reaction_id];
                        reaction.data = null;
                        reaction.data_string = '';
                        reaction.reverse_flux = false;
                        for (var segment_id in reaction.segments) {
                            var segment = reaction.segments[segment_id];
                            segment.data = null;
                        }
                        reaction.gene_string = null;
                    }
                    return false;
                }
                var null_val = [null];
                for (var reaction_id in gene_data_obj) {
                    for (var gene_id in gene_data_obj[reaction_id]) {
                        null_val = gene_data_obj[reaction_id][gene_id].map(function() {
                            return null;
                        });
                        break;
                    }
                    break;
                }
                for (var reaction_id in reactions) {
                    var reaction = reactions[reaction_id],
                        rule = reaction.gene_reaction_rule;
                    var d, gene_values, r_data = gene_data_obj[reaction.bigg_id];
                    if (typeof r_data !== 'undefined') {
                        gene_values = r_data;
                        d = evaluate_gene_reaction_rule(rule, gene_values, and_method_in_gene_reaction_rule);
                    } else {
                        gene_values = {};
                        d = utils.clone(null_val);
                    }
                    var f = float_for_data(d, styles, compare_style),
                        r = reverse_flux_for_data(d),
                        s = text_for_data(d, f);
                    reaction.data = f;
                    reaction.data_string = s;
                    reaction.reverse_flux = r;
                    for (var segment_id in reaction.segments) {
                        var segment = reaction.segments[segment_id];
                        segment.data = reaction.data;
                        segment.reverse_flux = reaction.reverse_flux;
                    }
                    reaction.gene_string = gene_string_for_data(rule, gene_values, reaction.genes, styles, identifiers_on_map, compare_style);
                }
                return true;
            }

            function _parse_float_or_null(x) {
                var f = Number(x);
                return (isNaN(f) || parseFloat(x) != f) ? null : f;
            }
        }, {
            "./utils": 31,
            "underscore": 35
        }],
        27: [function(require, module, exports) {
            module.exports = {
                'version': '1.5.0',
                builder_embed: 'svg.escher-svg .gene-label,svg.escher-svg .label{text-rendering:optimizelegibility;cursor:default}svg.escher-svg #mouse-node{fill:none}svg.escher-svg #canvas{stroke:#ccc;stroke-width:7px;fill:#fff}svg.escher-svg .resize-rect{fill:#000;opacity:0;stroke:none}svg.escher-svg .label{font-family:sans-serif;font-style:italic;font-weight:700;font-size:8px;fill:#000;stroke:none}svg.escher-svg .reaction-label{font-size:30px;fill:#202078;text-rendering:optimizelegibility}svg.escher-svg .node-label{font-size:20px}svg.escher-svg .gene-label{font-size:18px;fill:#202078}svg.escher-svg .text-label .label,svg.escher-svg .text-label-input{font-size:50px}svg.escher-svg .node-circle{stroke-width:2px}svg.escher-svg .midmarker-circle,svg.escher-svg .multimarker-circle{fill:#fff;fill-opacity:.2;stroke:#323232}svg.escher-svg g.selected .node-circle{stroke-width:6px;stroke:#1471c7}svg.escher-svg g.selected .label{fill:#1471c7}svg.escher-svg .metabolite-circle{stroke:#a24510;fill:#e0865b}svg.escher-svg g.selected .metabolite-circle{stroke:#050200}svg.escher-svg .segment{stroke:#334E75;stroke-width:10px;fill:none}svg.escher-svg .arrowhead{fill:#334E75}svg.escher-svg .stoichiometry-label-rect{fill:#fff;opacity:.5}svg.escher-svg .stoichiometry-label{fill:#334E75;font-size:17px}svg.escher-svg .membrane{fill:none;stroke:#fb0}svg.escher-svg .brush .extent{fill-opacity:.1;fill:#000;stroke:#fff;shape-rendering:crispEdges}svg.escher-svg #brush-container .background{fill:none}svg.escher-svg .bezier-circle{fill:#fff}svg.escher-svg .bezier-circle.b1{stroke:red}svg.escher-svg .bezier-circle.b2{stroke:#00f}svg.escher-svg .connect-line{stroke:#c8c8c8}svg.escher-svg .direction-arrow{stroke:#000;stroke-width:1px;fill:#fff;opacity:.3}svg.escher-svg .start-reaction-cursor{cursor:pointer}svg.escher-svg .start-reaction-target{stroke:#646464;fill:none;opacity:.5}svg.escher-svg .rotation-center-line{stroke:red;stroke-width:5px}svg.escher-svg .highlight{fill:#D97000;text-decoration:underline}svg.escher-svg .cursor-grab{cursor:grab;cursor:-webkit-grab}svg.escher-svg .cursor-grabbing{cursor:grabbing;cursor:-webkit-grabbing}svg.escher-svg .edit-text-cursor{cursor:text}'
            };
        }, {}],
        28: [function(require, module, exports) {
            module.exports = {
                version: require('./inline').version,
                Builder: require('./Builder'),
                Map: require('./Map'),
                Behavior: require('./Behavior'),
                KeyManager: require('./KeyManager'),
                DataMenu: require('./DataMenu'),
                UndoStack: require('./UndoStack'),
                CobraModel: require('./CobraModel'),
                utils: require('./utils'),
                SearchIndex: require('./SearchIndex'),
                Settings: require('./Settings'),
                data_styles: require('./data_styles'),
                ui: require('./ui'),
                static: require('./static'),
                ZoomContainer: require('./ZoomContainer')
            };
        }, {
            "./Behavior": 1,
            "./Builder": 4,
            "./CobraModel": 7,
            "./DataMenu": 8,
            "./KeyManager": 11,
            "./Map": 12,
            "./SearchIndex": 18,
            "./Settings": 19,
            "./UndoStack": 22,
            "./ZoomContainer": 23,
            "./data_styles": 26,
            "./inline": 27,
            "./static": 29,
            "./ui": 30,
            "./utils": 31
        }],
        29: [function(require, module, exports) {
            var utils = require('./utils')
            module.exports = {
                load_map_model_from_url: load_map_model_from_url
            }

            function load_map_model_from_url(map_download_url, model_download_url, local_index, options, callback) {
                var opt = utils.parse_url_components(window, options),
                    to_load = [],
                    load_map = function(fn) {
                        fn(null);
                    },
                    load_model = function(fn) {
                        fn(null);
                    }
                if (opt.map_name) {
                    var map_path = _get_path('map', opt.map_name, local_index, map_download_url)
                    if (map_path) {
                        load_map = function(fn) {
                            d3.json(map_path, function(error, data) {
                                if (error) console.warn(error)
                                fn(data)
                            })
                        }
                    }
                }
                if (opt.model_name) {
                    var model_path = _get_path('model', opt.model_name, local_index, model_download_url)
                    if (model_path) {
                        load_model = function(fn) {
                            d3.json(model_path, function(error, data) {
                                if (error) console.warn(error)
                                fn(data)
                            })
                        }
                    }
                }
                if (opt.hasOwnProperty('enable_editing')) {
                    options.enable_editing = opt.enable_editing.toLowerCase() === 'true'
                }
                load_map(function(map_data) {
                    load_model(function(model_data) {
                        callback(map_data, model_data, options)
                    })
                })
            }

            function _get_path(kind, name, index, url) {
                var match = index[kind + 's'].filter(function(x) {
                    return x[kind + '_name'] == name
                })
                if (match.length == 0)
                    throw new Error('Bad ' + kind + ' ' + name)
                return (url + encodeURIComponent(match[0].organism) + '/' + encodeURIComponent(match[0][kind + '_name'])) + '.json'
            }
        }, {
            "./utils": 31
        }],
        30: [function(require, module, exports) {
            var utils = require('./utils');
            var data_styles = require('./data_styles');
            module.exports = {
                individual_button: individual_button,
                radio_button_group: radio_button_group,
                button_group: button_group,
                dropdown_menu: dropdown_menu,
                set_json_input_button: set_json_input_button,
                set_json_or_csv_input_button: set_json_or_csv_input_button
            };

            function _button_with_sel(b, button) {
                var ignore_bootstrap = button.ignore_bootstrap || false
                b.attr('class', 'btn btn-default simple-button')
                var c = b.append('span')
                var t = c.append('span')
                if ('id' in button) b.attr('id', button.id)
                if ('text' in button) t.text(button.text)
                if ('icon' in button && !ignore_bootstrap) c.classed(button.icon, true)
                if (!ignore_bootstrap) t.attr('class', 'hidden')
                if ('key' in button) set_button(b, button.key)
                if ('key_text' in button && 'tooltip' in button && button.key_text !== null)
                    b.attr('title', button.tooltip + button.key_text)
                else if ('tooltip' in button)
                    b.attr('title', button.tooltip)
            }

            function individual_button(s, button) {
                var b = s.append('button')
                _button_with_sel(b, button)
            }

            function radio_button_group(s) {
                var s2 = s.append('li').attr('class', 'btn-group-vertical').attr('data-toggle', 'buttons')
                return {
                    button: function(button) {
                        var ignore_bootstrap = button.ignore_bootstrap || false
                        var b = s2.append('label')
                        b.append('input').attr('type', 'radio')
                        _button_with_sel(b, button)
                        return this
                    }
                }
            }

            function button_group(s) {
                var s2 = s.attr('class', 'btn-group-vertical');
                return {
                    button: function(button) {
                        var b = s2.append("button")
                        _button_with_sel(b, button)
                        return this;
                    }
                };
            }

            function dropdown_menu(s, name, pull_right) {
                if (pull_right === undefined) pull_right = false;
                var s2 = s.append('li').attr('class', 'dropdown');
                s2.append('button').text(name + " ").attr('class', 'btn btn-link btn-sm dropdown-button').attr('data-toggle', 'dropdown').append('b').attr('class', 'caret');
                var ul = s2.append('ul').attr('class', 'dropdown-menu').classed('pull-right', pull_right).attr('role', 'menu').attr('aria-labelledby', 'dLabel');
                return {
                    dropdown: s2,
                    button: function(button) {
                        var li = ul.append("li").attr('role', 'presentation').datum(button),
                            link = li.append("a").attr('href', '#'),
                            icon = link.append('span').attr('class', 'dropdown-button-icon'),
                            text = link.append('span').attr('class', 'dropdown-button-text');
                        if ('id' in button) li.attr('id', button.id);
                        if ('key_text' in button && 'text' in button && button.key_text !== null)
                            text.text(" " + button.text + button.key_text);
                        else if ('text' in button)
                            text.text(" " + button.text);
                        if ('icon' in button) icon.classed(button.icon, true);
                        if ('key' in button) {
                            set_button(link, button.key);
                        } else if ('input' in button) {
                            var input = button.input,
                                out = (input.accept_csv ? set_json_or_csv_input_button(link, li, input.pre_fn, input.fn, input.failure_fn) : set_json_input_button(link, li, input.pre_fn, input.fn, input.failure_fn));
                            if ('assign' in input && 'key' in input)
                                input.assign[input.key] = out;
                        }
                        return this;
                    },
                    divider: function() {
                        ul.append("li").attr('role', 'presentation').attr('class', 'divider');
                        return this;
                    }
                };
            }

            function set_button(b, key) {
                b.on("click", function() {
                    key.fn.call(key.target);
                });
            }

            function set_json_input_button(b, s, pre_fn, post_fn, failure_fn) {
                var input = s.append("input").attr("type", "file").style("display", "none").on("change", function() {
                    utils.load_json(this.files[0], function(e, d) {
                        post_fn(e, d);
                        this.value = "";
                    }.bind(this), pre_fn, failure_fn);
                });
                b.on('click', function(e) {
                    input.node().click();
                });
                return function() {
                    input.node().click();
                };
            }

            function set_json_or_csv_input_button(b, s, pre_fn, post_fn, failure_fn) {
                var input = s.append("input").attr("type", "file").style("display", "none").on("change", function() {
                    utils.load_json_or_csv(this.files[0], data_styles.csv_converter, function(e, d) {
                        post_fn(e, d);
                        this.value = "";
                    }.bind(this), pre_fn, failure_fn);
                });
                b.on('click', function(e) {
                    input.node().click();
                });
                return function() {
                    input.node().click();
                };
            }
        }, {
            "./data_styles": 26,
            "./utils": 31
        }],
        31: [function(require, module, exports) {
            var vkbeautify = require('vkbeautify');
            var _ = require('underscore');
            try {
                var saveAs = require('filesaverjs').saveAs;
            } catch (e) {
                console.warn('filesaverjs not available');
            }
            module.exports = {
                set_options: set_options,
                remove_child_nodes: remove_child_nodes,
                load_css: load_css,
                load_files: load_files,
                load_the_file: load_the_file,
                make_class: make_class,
                setup_defs: setup_defs,
                draw_an_object: draw_an_object,
                draw_a_nested_object: draw_a_nested_object,
                make_array: make_array,
                make_array_ref: make_array_ref,
                compare_arrays: compare_arrays,
                array_to_object: array_to_object,
                clone: clone,
                extend: extend,
                unique_concat: unique_concat,
                unique_strings_array: unique_strings_array,
                debounce: debounce,
                object_slice_for_ids: object_slice_for_ids,
                object_slice_for_ids_ref: object_slice_for_ids_ref,
                c_plus_c: c_plus_c,
                c_minus_c: c_minus_c,
                c_times_scalar: c_times_scalar,
                download_json: download_json,
                load_json: load_json,
                load_json_or_csv: load_json_or_csv,
                download_svg: download_svg,
                download_png: download_png,
                rotate_coords_recursive: rotate_coords_recursive,
                rotate_coords: rotate_coords,
                get_angle: get_angle,
                to_degrees: to_degrees,
                angle_for_event: angle_for_event,
                distance: distance,
                check_undefined: check_undefined,
                compartmentalize: compartmentalize,
                decompartmentalize: decompartmentalize,
                mean: mean,
                median: median,
                quartiles: quartiles,
                random_characters: random_characters,
                generate_map_id: generate_map_id,
                check_for_parent_tag: check_for_parent_tag,
                name_to_url: name_to_url,
                parse_url_components: parse_url_components,
                get_document: get_document,
                get_window: get_window,
                d3_transform_catch: d3_transform_catch,
                check_browser: check_browser
            };

            function _check_filesaver() {
                try {
                    var isFileSaverSupported = !!new Blob();
                } catch (e) {
                    alert("Blob not supported");
                }
            }

            function set_options(options, defaults, must_be_float) {
                if (options === undefined || options === null)
                    return defaults;
                var i = -1,
                    out = {};
                for (var key in defaults) {
                    var has_key = ((key in options) && (options[key] !== null) && (options[key] !== undefined));
                    var val = (has_key ? options[key] : defaults[key]);
                    if (must_be_float && key in must_be_float) {
                        val = parseFloat(val);
                        if (isNaN(val)) {
                            if (has_key) {
                                console.warn('Bad float for option ' + key);
                                val = parseFloat(defaults[key]);
                                if (isNaN(val)) {
                                    console.warn('Bad float for default ' + key);
                                    val = null;
                                }
                            } else {
                                console.warn('Bad float for default ' + key);
                                val = null;
                            }
                        }
                    }
                    out[key] = val;
                }
                return out;
            }

            function remove_child_nodes(selection) {
                var node = selection.node();
                while (node.hasChildNodes()) {
                    node.removeChild(node.lastChild);
                }
            }

            function load_css(css_path, callback) {
                var css = "";
                if (css_path) {
                    d3.text(css_path, function(error, text) {
                        if (error) {
                            console.warn(error);
                        }
                        css = text;
                        callback(css);
                    });
                }
                return false;
            };

            function load_the_file(t, file, callback, value) {
                if (value) {
                    if (file) console.warn('File ' + file + ' overridden by value.');
                    callback.call(t, null, value);
                    return;
                }
                if (!file) {
                    callback.call(t, 'No filename', null);
                    return;
                }
                if (ends_with(file, 'json'))
                    d3.json(file, function(e, d) {
                        callback.call(t, e, d);
                    });
                else if (ends_with(file, 'css'))
                    d3.text(file, function(e, d) {
                        callback.call(t, e, d);
                    });
                else
                    callback.call(t, 'Unrecognized file type', null);
                return;

                function ends_with(str, suffix) {
                    return str.indexOf(suffix, str.length - suffix.length) !== -1;
                }
            }

            function load_files(t, files_to_load, final_callback) {
                if (files_to_load.length === 0) final_callback.call(t);
                var i = -1,
                    remaining = files_to_load.length;
                while (++i < files_to_load.length) {
                    load_the_file(t, files_to_load[i].file, function(e, d) {
                        this.call(t, e, d);
                        if (!--remaining) final_callback.call(t);
                    }.bind(files_to_load[i].callback), files_to_load[i].value);
                }
            }

            function make_class() {
                var is_internal, constructor = function(args) {
                    if (this instanceof constructor) {
                        if (typeof this.init === 'function') {
                            this.init.apply(this, is_internal ? args : arguments);
                        }
                    } else {
                        is_internal = true;
                        var instance = new constructor(arguments);
                        is_internal = false;
                        return instance;
                    }
                };
                return constructor;
            }

            function setup_defs(svg, style) {
                svg.select("defs").remove();
                var defs = svg.append("defs");
                var node = defs.node();
                node.parentNode.insertBefore(node, node.parentNode.firstChild);
                defs.append("style").attr("type", "text/css").text(style);
                return defs;
            }

            function draw_an_object(container_sel, parent_node_selector, children_selector, object, id_key, create_function, update_function, exit_function) {
                var draw_object = {};
                for (var id in object) {
                    if (object[id] === undefined) {
                        console.warn('Undefined value for id ' + id + ' in object. Ignoring.');
                    } else {
                        draw_object[id] = object[id];
                    }
                }
                var sel = container_sel.select(parent_node_selector).selectAll(children_selector).data(make_array_ref(draw_object, id_key), function(d) {
                    return d[id_key];
                });
                if (create_function)
                    sel.enter().call(create_function);
                if (update_function)
                    sel.call(update_function);
                if (exit_function)
                    sel.exit().call(exit_function);
            }

            function draw_a_nested_object(container_sel, children_selector, object_data_key, id_key, create_function, update_function, exit_function) {
                var sel = container_sel.selectAll(children_selector).data(function(d) {
                    return make_array_ref(d[object_data_key], id_key);
                }, function(d) {
                    return d[id_key];
                });
                if (create_function)
                    sel.enter().call(create_function);
                if (update_function)
                    sel.call(update_function);
                if (exit_function)
                    sel.exit().call(exit_function);
            }

            function make_array(obj, id_key) {
                var array = [];
                for (var key in obj) {
                    var it = clone(obj[key]);
                    it[id_key] = key;
                    array.push(it);
                }
                return array;
            }

            function make_array_ref(obj, id_key) {
                var array = [];
                for (var key in obj) {
                    var it = obj[key];
                    it[id_key] = key;
                    array.push(it);
                }
                return array;
            }

            function compare_arrays(a1, a2) {
                if (!a1 || !a2) return false;
                if (a1.length != a2.length) return false;
                for (var i = 0, l = a1.length; i < l; i++) {
                    if (a1[i] != a2[i]) {
                        return false;
                    }
                }
                return true;
            }

            function array_to_object(arr) {
                var obj = {};
                for (var i = 0, l = arr.length; i < l; i++) {
                    var column = arr[i],
                        keys = Object.keys(column);
                    for (var k = 0, nk = keys.length; k < nk; k++) {
                        var id = keys[k];
                        if (!(id in obj)) {
                            var n = [];
                            for (var j = 0; j < l; j++) {
                                n[j] = null;
                            }
                            n[i] = column[id];
                            obj[id] = n;
                        } else {
                            obj[id][i] = column[id];
                        }
                    }
                }
                return obj;
            }

            function clone(obj) {
                if (_.isArray(obj))
                    return _.map(obj, function(t) {
                        return clone(t)
                    })
                else if (_.isObject(obj))
                    return _.mapObject(obj, function(t, k) {
                        return clone(t)
                    })
                else
                    return obj
            }

            function extend(obj1, obj2, overwrite) {
                if (overwrite === undefined)
                    overwrite = false;
                for (var attrname in obj2) {
                    if (!(attrname in obj1) || overwrite)
                        obj1[attrname] = obj2[attrname];
                    else
                        throw new Error('Attribute ' + attrname + ' already in object.');
                }
            }

            function unique_concat(arrays) {
                var new_array = [];
                arrays.forEach(function(a) {
                    a.forEach(function(x) {
                        if (new_array.indexOf(x) < 0)
                            new_array.push(x);
                    });
                });
                return new_array;
            }

            function unique_strings_array(arr) {
                var a = [];
                for (var i = 0, l = arr.length; i < l; i++)
                    if (a.indexOf(arr[i]) === -1)
                        a.push(arr[i]);
                return a;
            }

            function debounce(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this,
                        args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            }

            function object_slice_for_ids(obj, ids) {
                var subset = {},
                    i = -1;
                while (++i < ids.length) {
                    subset[ids[i]] = clone(obj[ids[i]]);
                }
                if (ids.length != Object.keys(subset).length) {
                    console.warn('did not find correct reaction subset');
                }
                return subset;
            }

            function object_slice_for_ids_ref(obj, ids) {
                var subset = {},
                    i = -1;
                while (++i < ids.length) {
                    subset[ids[i]] = obj[ids[i]];
                }
                if (ids.length != Object.keys(subset).length) {
                    console.warn('did not find correct reaction subset');
                }
                return subset;
            }

            function c_plus_c(coords1, coords2) {
                if (coords1 === null || coords2 === null || coords1 === undefined || coords2 === undefined)
                    return null;
                return {
                    "x": coords1.x + coords2.x,
                    "y": coords1.y + coords2.y
                };
            }

            function c_minus_c(coords1, coords2) {
                if (coords1 === null || coords2 === null || coords1 === undefined || coords2 === undefined)
                    return null;
                return {
                    "x": coords1.x - coords2.x,
                    "y": coords1.y - coords2.y
                };
            }

            function c_times_scalar(coords, scalar) {
                return {
                    "x": coords.x * scalar,
                    "y": coords.y * scalar
                };
            }

            function download_json(json, name) {
                _check_filesaver();
                var j = JSON.stringify(json),
                    blob = new Blob([j], {
                        type: "application/json"
                    });
                saveAs(blob, name + '.json');
            }

            function load_json(f, callback, pre_fn, failure_fn) {
                if (!(window.File && window.FileReader && window.FileList && window.Blob))
                    callback("The File APIs are not fully supported in this browser.", null);
                var reader = new window.FileReader();
                reader.onload = function(event) {
                    var result = event.target.result,
                        data;
                    try {
                        data = JSON.parse(result);
                    } catch (e) {
                        callback(e, null);
                        return;
                    }
                    callback(null, data);
                };
                if (pre_fn !== undefined && pre_fn !== null) {
                    try {
                        pre_fn();
                    } catch (e) {
                        console.warn(e);
                    }
                }
                reader.onabort = function(event) {
                    try {
                        failure_fn();
                    } catch (e) {
                        console.warn(e);
                    }
                };
                reader.onerror = function(event) {
                    try {
                        failure_fn();
                    } catch (e) {
                        console.warn(e);
                    }
                };
                reader.readAsText(f);
            }

            function load_json_or_csv(f, csv_converter, callback, pre_fn, failure_fn, debug_event) {
                var onload_function = function(event) {
                    var result = event.target.result,
                        data, errors;
                    try {
                        data = JSON.parse(result);
                    } catch (e) {
                        errors = 'JSON error: ' + e;
                        try {
                            data = csv_converter(d3.csv.parseRows(result));
                        } catch (e) {
                            callback(errors + '\nCSV error: ' + e, null);
                            return;
                        }
                    }
                    callback(null, data);
                };
                if (debug_event !== undefined && debug_event !== null) {
                    console.warn('Debugging load_json_or_csv');
                    return onload_function(debug_event);
                }
                if (!(window.File && window.FileReader && window.FileList && window.Blob))
                    callback("The File APIs are not fully supported in this browser.", null);
                var reader = new window.FileReader();
                if (pre_fn !== undefined && pre_fn !== null) {
                    try {
                        pre_fn();
                    } catch (e) {
                        console.warn(e);
                    }
                }
                reader.onabort = function(event) {
                    try {
                        failure_fn();
                    } catch (e) {
                        console.warn(e);
                    }
                };
                reader.onerror = function(event) {
                    try {
                        failure_fn();
                    } catch (e) {
                        console.warn(e);
                    }
                };
                reader.onload = onload_function;
                reader.readAsText(f);
            }

            function download_svg(name, svg_sel, do_beautify) {
                _check_filesaver();
                var xml = (new XMLSerializer()).serializeToString(svg_sel.node());
                if (do_beautify) xml = vkbeautify.xml(xml);
                xml = ('<?xml version="1.0" encoding="utf-8"?>\n' + '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"\n' + ' "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' +
                    xml);
                var blob = new Blob([xml], {
                    type: 'image/svg+xml'
                });
                saveAs(blob, name + '.svg');
            };

            function download_png(name, svg_sel, do_beautify) {
                _check_filesaver();
                var xml = (new XMLSerializer()).serializeToString(svg_sel.node());
                if (do_beautify) xml = vkbeautify.xml(xml);
                xml = ('<?xml version="1.0" encoding="utf-8"?>\n' + '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"\n' + ' "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' +
                    xml);
                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                var svg_size = svg_sel.node().getBBox();
                var svg_width = svg_size.width + svg_size.x;
                var svg_height = svg_size.height + svg_size.y;
                if (svg_width < 10000 && svg_height < 10000) {
                    canvas.width = svg_width;
                    canvas.height = svg_height;
                } else {
                    if (canvas.width > canvas.height) {
                        canvas.width = 10000;
                        canvas.height = 10000 * (svg_height / svg_width);
                    } else {
                        canvas.width = 10000 * (svg_width / svg_height);
                        canvas.height = 10000;
                    }
                }
                var base_image = new Image();
                base_image.src = 'data:image/svg+xml;base64,' + btoa(xml);
                base_image.onload = function() {
                    context.fillStyle = "#FFF";
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    context.drawImage(base_image, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(function(blob) {
                        saveAs(blob, name + ".png");
                    });
                };
            };

            function rotate_coords_recursive(coords_array, angle, center) {
                var rot = function(c) {
                    return rotate_coords(c, angle, center);
                };
                return coords_array.map(rot);
            }

            function rotate_coords(c, angle, center) {
                var dx = Math.cos(-angle) * (c.x - center.x) +
                    Math.sin(-angle) * (c.y - center.y) +
                    center.x - c.x,
                    dy = -Math.sin(-angle) * (c.x - center.x) +
                    Math.cos(-angle) * (c.y - center.y) +
                    center.y - c.y;
                return {
                    x: dx,
                    y: dy
                };
            }

            function get_angle(coords) {
                var denominator = coords[1].x - coords[0].x,
                    numerator = coords[1].y - coords[0].y;
                if (denominator == 0 && numerator >= 0) return Math.PI / 2;
                else if (denominator == 0 && numerator < 0) return 3 * Math.PI / 2;
                else if (denominator >= 0 && numerator >= 0) return Math.atan(numerator / denominator);
                else if (denominator >= 0) return (Math.atan(numerator / denominator) + 2 * Math.PI);
                else return (Math.atan(numerator / denominator) + Math.PI);
            }

            function to_degrees(radians) {
                return radians * 180 / Math.PI;
            }

            function angle_for_event(displacement, point, center) {
                var gamma = Math.atan2((point.x - center.x), (center.y - point.y)),
                    beta = Math.atan2((point.x - center.x + displacement.x), (center.y - point.y - displacement.y)),
                    angle = beta - gamma;
                return angle;
            }

            function distance(start, end) {
                return Math.sqrt(Math.pow(end.y - start.y, 2) + Math.pow(end.x - start.x, 2));
            }

            function check_undefined(args, names) {
                names.map(function(name, i) {
                    if (args[i] === undefined) {
                        console.error('Argument is undefined: ' + String(names[i]));
                    }
                });
            }

            function compartmentalize(bigg_id, compartment_id) {
                return bigg_id + '_' + compartment_id;
            }

            function decompartmentalize(id) {
                var out = no_compartment(id);
                if (out === null) out = [id, null];
                return out;

                function no_compartment(id) {
                    var reg = /(.*)_([a-z0-9]{1,2})$/,
                        result = reg.exec(id);
                    if (result === null) return null;
                    return result.slice(1, 3);
                }
            }

            function mean(array) {
                var sum = array.reduce(function(a, b) {
                    return a + b;
                });
                var avg = sum / array.length;
                return avg;
            }

            function median(array) {
                array.sort(function(a, b) {
                    return a - b;
                });
                var half = Math.floor(array.length / 2);
                if (array.length % 2 == 1)
                    return array[half];
                else
                    return (array[half - 1] + array[half]) / 2.0;
            }

            function quartiles(array) {
                array.sort(function(a, b) {
                    return a - b;
                });
                var half = Math.floor(array.length / 2);
                if (array.length == 1)
                    return [array[0], array[0], array[0]];
                else if (array.length % 2 == 1)
                    return [median(array.slice(0, half)), array[half], median(array.slice(half + 1))];
                else
                    return [median(array.slice(0, half)), (array[half - 1] + array[half]) / 2.0, median(array.slice(half))];
            }

            function random_characters(num) {
                var text = '',
                    possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                for (var i = 0; i < num; i++)
                    text += possible.charAt(Math.floor(Math.random() * possible.length));
                return text;
            }

            function generate_map_id() {
                return random_characters(12);
            }

            function check_for_parent_tag(el, tag) {
                if (el instanceof Array)
                    el = el.node();
                while (el.parentNode !== null) {
                    el = el.parentNode;
                    if (el.tagName === undefined) continue;
                    if (el.tagName.toLowerCase() === tag.toLowerCase())
                        return true;
                }
                return false;
            }

            function name_to_url(name, download_url) {
                if (download_url !== undefined && download_url !== null) {
                    download_url = download_url.replace(/^\/|\/$/g, '');
                    name = [download_url, name].join('/');
                }
                return name.replace(/^\/|\/$/g, '') + '.json';
            }

            function parse_url_components(the_window, options) {
                if (_.isUndefined(options)) options = {}
                var query = the_window.location.search.substring(1),
                    vars = query.split('&')
                for (var i = 0; i < vars.length; i++) {
                    var pair = vars[i].split('='),
                        val = decodeURIComponent(pair[1])
                    if (pair[0].indexOf('[]') == pair[0].length - 2) {
                        var o = pair[0].replace('[]', '')
                        if (!(o in options))
                            options[o] = []
                        options[o].push(val)
                    } else {
                        options[pair[0]] = val
                    }
                }
                return options
            }

            function get_document(node) {
                return node.ownerDocument;
            }

            function get_window(node) {
                return get_document(node).defaultView;
            }

            function d3_transform_catch(transform_attr) {
                try {
                    return d3.transform(transform_attr);
                } catch (err) {
                    console.error('Cannot run d3.transform, probably becuase this is a node/jsdom test. ' + 'Returning a tranform object for testing.');
                    return {
                        translate: [0, 0],
                        rotate: 0
                    };
                }
            }

            function check_browser(name) {
                var browser = function() {
                    var ua = navigator.userAgent,
                        M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [],
                        tem;
                    if (/trident/i.test(M[1])) {
                        tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
                        return 'IE ' + (tem[1] || '');
                    }
                    if (M[1] === 'Chrome') {
                        tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
                        if (tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
                    }
                    M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
                    if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
                    return M.join(' ');
                };
                try {
                    return browser().toLowerCase().indexOf(name) > -1;
                } catch (e) {
                    return false;
                }
            }
        }, {
            "filesaverjs": 33,
            "underscore": 35,
            "vkbeautify": 36
        }],
        32: [function(require, module, exports) {
            (function(global) {
                (function() {
                    var _slice = Array.prototype.slice;
                    var Bacon = {
                        toString: function() {
                            return "Bacon";
                        }
                    };
                    Bacon.version = '0.7.83';
                    var Exception = (typeof global !== "undefined" && global !== null ? global : this).Error;
                    var nop = function() {};
                    var latter = function(_, x) {
                        return x;
                    };
                    var former = function(x, _) {
                        return x;
                    };
                    var cloneArray = function(xs) {
                        return xs.slice(0);
                    };
                    var assert = function(message, condition) {
                        if (!condition) {
                            throw new Exception(message);
                        }
                    };
                    var assertObservableIsProperty = function(x) {
                        if ((x != null ? x._isObservable : void 0) && !(x != null ? x._isProperty : void 0)) {
                            throw new Exception("Observable is not a Property : " + x);
                        }
                    };
                    var assertEventStream = function(event) {
                        if (!(event != null ? event._isEventStream : void 0)) {
                            throw new Exception("not an EventStream : " + event);
                        }
                    };
                    var assertObservable = function(event) {
                        if (!(event != null ? event._isObservable : void 0)) {
                            throw new Exception("not an Observable : " + event);
                        }
                    };
                    var assertFunction = function(f) {
                        return assert("not a function : " + f, _.isFunction(f));
                    };
                    var isArray = function(xs) {
                        return xs instanceof Array;
                    };
                    var isObservable = function(x) {
                        return x && x._isObservable;
                    };
                    var assertArray = function(xs) {
                        if (!isArray(xs)) {
                            throw new Exception("not an array : " + xs);
                        }
                    };
                    var assertNoArguments = function(args) {
                        return assert("no arguments supported", args.length === 0);
                    };
                    var assertString = function(x) {
                        if (typeof x === "string") {
                            throw new Exception("not a string : " + x);
                        }
                    };
                    var extend = function(target) {
                        var length = arguments.length;
                        for (var i = 1; 1 < length ? i < length : i > length; 1 < length ? i++ : i--) {
                            for (var prop in arguments[i]) {
                                target[prop] = arguments[i][prop];
                            }
                        }
                        return target;
                    };
                    var inherit = function(child, parent) {
                        var hasProp = ({}).hasOwnProperty;
                        var ctor = function() {};
                        ctor.prototype = parent.prototype;
                        child.prototype = new ctor();
                        for (var key in parent) {
                            if (hasProp.call(parent, key)) {
                                child[key] = parent[key];
                            }
                        }
                        return child;
                    };
                    var _ = {
                        indexOf: (function() {
                            if (Array.prototype.indexOf) {
                                return function(xs, x) {
                                    return xs.indexOf(x);
                                };
                            } else {
                                return function(xs, x) {
                                    for (var i = 0, y; i < xs.length; i++) {
                                        y = xs[i];
                                        if (x === y) {
                                            return i;
                                        }
                                    }
                                    return -1;
                                };
                            }
                        })(),
                        indexWhere: function(xs, f) {
                            for (var i = 0, y; i < xs.length; i++) {
                                y = xs[i];
                                if (f(y)) {
                                    return i;
                                }
                            }
                            return -1;
                        },
                        head: function(xs) {
                            return xs[0];
                        },
                        always: function(x) {
                            return function() {
                                return x;
                            };
                        },
                        negate: function(f) {
                            return function(x) {
                                return !f(x);
                            };
                        },
                        empty: function(xs) {
                            return xs.length === 0;
                        },
                        tail: function(xs) {
                            return xs.slice(1, xs.length);
                        },
                        filter: function(f, xs) {
                            var filtered = [];
                            for (var i = 0, x; i < xs.length; i++) {
                                x = xs[i];
                                if (f(x)) {
                                    filtered.push(x);
                                }
                            }
                            return filtered;
                        },
                        map: function(f, xs) {
                            return (function() {
                                var result = [];
                                for (var i = 0, x; i < xs.length; i++) {
                                    x = xs[i];
                                    result.push(f(x));
                                }
                                return result;
                            })();
                        },
                        each: function(xs, f) {
                            for (var key in xs) {
                                if (Object.prototype.hasOwnProperty.call(xs, key)) {
                                    var value = xs[key];
                                    f(key, value);
                                }
                            }
                        },
                        toArray: function(xs) {
                            return isArray(xs) ? xs : [xs];
                        },
                        contains: function(xs, x) {
                            return _.indexOf(xs, x) !== -1;
                        },
                        id: function(x) {
                            return x;
                        },
                        last: function(xs) {
                            return xs[xs.length - 1];
                        },
                        all: function(xs) {
                            var f = arguments.length <= 1 || arguments[1] === undefined ? _.id : arguments[1];
                            for (var i = 0, x; i < xs.length; i++) {
                                x = xs[i];
                                if (!f(x)) {
                                    return false;
                                }
                            }
                            return true;
                        },
                        any: function(xs) {
                            var f = arguments.length <= 1 || arguments[1] === undefined ? _.id : arguments[1];
                            for (var i = 0, x; i < xs.length; i++) {
                                x = xs[i];
                                if (f(x)) {
                                    return true;
                                }
                            }
                            return false;
                        },
                        without: function(x, xs) {
                            return _.filter(function(y) {
                                return y !== x;
                            }, xs);
                        },
                        remove: function(x, xs) {
                            var i = _.indexOf(xs, x);
                            if (i >= 0) {
                                return xs.splice(i, 1);
                            }
                        },
                        fold: function(xs, seed, f) {
                            for (var i = 0, x; i < xs.length; i++) {
                                x = xs[i];
                                seed = f(seed, x);
                            }
                            return seed;
                        },
                        flatMap: function(f, xs) {
                            return _.fold(xs, [], function(ys, x) {
                                return ys.concat(f(x));
                            });
                        },
                        cached: function(f) {
                            var value = None;
                            return function() {
                                if (typeof value !== "undefined" && value !== null ? value._isNone : undefined) {
                                    value = f();
                                    f = undefined;
                                }
                                return value;
                            };
                        },
                        bind: function(fn, me) {
                            return function() {
                                return fn.apply(me, arguments);
                            };
                        },
                        isFunction: function(f) {
                            return typeof f === "function";
                        },
                        toString: function(obj) {
                            var internals, key, value;
                            var hasProp = ({}).hasOwnProperty;
                            try {
                                recursionDepth++;
                                if (obj == null) {
                                    return "undefined";
                                } else if (_.isFunction(obj)) {
                                    return "function";
                                } else if (isArray(obj)) {
                                    if (recursionDepth > 5) {
                                        return "[..]";
                                    }
                                    return "[" + _.map(_.toString, obj).toString() + "]";
                                } else if ((obj != null ? obj.toString : void 0) != null && obj.toString !== Object.prototype.toString) {
                                    return obj.toString();
                                } else if (typeof obj === "object") {
                                    if (recursionDepth > 5) {
                                        return "{..}";
                                    }
                                    internals = (function() {
                                        var results = [];
                                        for (key in obj) {
                                            if (!hasProp.call(obj, key)) continue;
                                            value = (function() {
                                                var error;
                                                try {
                                                    return obj[key];
                                                } catch (error) {
                                                    return error;
                                                }
                                            })();
                                            results.push(_.toString(key) + ":" + _.toString(value));
                                        }
                                        return results;
                                    })();
                                    return "{" + internals + "}";
                                } else {
                                    return obj;
                                }
                            } finally {
                                recursionDepth--;
                            }
                        }
                    };
                    var recursionDepth = 0;
                    Bacon._ = _;
                    var UpdateBarrier = Bacon.UpdateBarrier = (function() {
                        var rootEvent;
                        var waiterObs = [];
                        var waiters = {};
                        var afters = [];
                        var aftersIndex = 0;
                        var flushed = {};
                        var afterTransaction = function(f) {
                            if (rootEvent) {
                                return afters.push(f);
                            } else {
                                return f();
                            }
                        };
                        var whenDoneWith = function(obs, f) {
                            if (rootEvent) {
                                var obsWaiters = waiters[obs.id];
                                if (!(typeof obsWaiters !== "undefined" && obsWaiters !== null)) {
                                    obsWaiters = waiters[obs.id] = [f];
                                    return waiterObs.push(obs);
                                } else {
                                    return obsWaiters.push(f);
                                }
                            } else {
                                return f();
                            }
                        };
                        var flush = function() {
                            while (waiterObs.length > 0) {
                                flushWaiters(0, true);
                            }
                            flushed = {};
                        };
                        var flushWaiters = function(index, deps) {
                            var obs = waiterObs[index];
                            var obsId = obs.id;
                            var obsWaiters = waiters[obsId];
                            waiterObs.splice(index, 1);
                            delete waiters[obsId];
                            if (deps && waiterObs.length > 0) {
                                flushDepsOf(obs);
                            }
                            for (var i = 0, f; i < obsWaiters.length; i++) {
                                f = obsWaiters[i];
                                f();
                            }
                        };
                        var flushDepsOf = function(obs) {
                            if (flushed[obs.id]) return;
                            var deps = obs.internalDeps();
                            for (var i = 0, dep; i < deps.length; i++) {
                                dep = deps[i];
                                flushDepsOf(dep);
                                if (waiters[dep.id]) {
                                    var index = _.indexOf(waiterObs, dep);
                                    flushWaiters(index, false);
                                }
                            }
                            flushed[obs.id] = true;
                        };
                        var inTransaction = function(event, context, f, args) {
                            if (rootEvent) {
                                return f.apply(context, args);
                            } else {
                                rootEvent = event;
                                try {
                                    var result = f.apply(context, args);
                                    flush();
                                } finally {
                                    rootEvent = undefined;
                                    while (aftersIndex < afters.length) {
                                        var after = afters[aftersIndex];
                                        aftersIndex++;
                                        after();
                                    }
                                    aftersIndex = 0;
                                    afters = [];
                                }
                                return result;
                            }
                        };
                        var currentEventId = function() {
                            return rootEvent ? rootEvent.id : undefined;
                        };
                        var wrappedSubscribe = function(obs, sink) {
                            var unsubd = false;
                            var shouldUnsub = false;
                            var doUnsub = function() {
                                shouldUnsub = true;
                                return shouldUnsub;
                            };
                            var unsub = function() {
                                unsubd = true;
                                return doUnsub();
                            };
                            doUnsub = obs.dispatcher.subscribe(function(event) {
                                return afterTransaction(function() {
                                    if (!unsubd) {
                                        var reply = sink(event);
                                        if (reply === Bacon.noMore) {
                                            return unsub();
                                        }
                                    }
                                });
                            });
                            if (shouldUnsub) {
                                doUnsub();
                            }
                            return unsub;
                        };
                        var hasWaiters = function() {
                            return waiterObs.length > 0;
                        };
                        return {
                            whenDoneWith: whenDoneWith,
                            hasWaiters: hasWaiters,
                            inTransaction: inTransaction,
                            currentEventId: currentEventId,
                            wrappedSubscribe: wrappedSubscribe,
                            afterTransaction: afterTransaction
                        };
                    })();

                    function Source(obs, sync) {
                        var lazy = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
                        this.obs = obs;
                        this.sync = sync;
                        this.lazy = lazy;
                        this.queue = [];
                    }
                    extend(Source.prototype, {
                        _isSource: true,
                        subscribe: function(sink) {
                            return this.obs.dispatcher.subscribe(sink);
                        },
                        toString: function() {
                            return this.obs.toString();
                        },
                        markEnded: function() {
                            this.ended = true;
                            return true;
                        },
                        consume: function() {
                            if (this.lazy) {
                                return {
                                    value: _.always(this.queue[0])
                                };
                            } else {
                                return this.queue[0];
                            }
                        },
                        push: function(x) {
                            this.queue = [x];
                            return [x];
                        },
                        mayHave: function() {
                            return true;
                        },
                        hasAtLeast: function() {
                            return this.queue.length;
                        },
                        flatten: true
                    });

                    function ConsumingSource() {
                        Source.apply(this, arguments);
                    }
                    inherit(ConsumingSource, Source);
                    extend(ConsumingSource.prototype, {
                        consume: function() {
                            return this.queue.shift();
                        },
                        push: function(x) {
                            return this.queue.push(x);
                        },
                        mayHave: function(c) {
                            return !this.ended || this.queue.length >= c;
                        },
                        hasAtLeast: function(c) {
                            return this.queue.length >= c;
                        },
                        flatten: false
                    });

                    function BufferingSource(obs) {
                        Source.call(this, obs, true);
                    }
                    inherit(BufferingSource, Source);
                    extend(BufferingSource.prototype, {
                        consume: function() {
                            var values = this.queue;
                            this.queue = [];
                            return {
                                value: function() {
                                    return values;
                                }
                            };
                        },
                        push: function(x) {
                            return this.queue.push(x.value());
                        },
                        hasAtLeast: function() {
                            return true;
                        }
                    });
                    Source.isTrigger = function(s) {
                        if (s != null ? s._isSource : void 0) {
                            return s.sync;
                        } else {
                            return s != null ? s._isEventStream : void 0;
                        }
                    };
                    Source.fromObservable = function(s) {
                        if (s != null ? s._isSource : void 0) {
                            return s;
                        } else if (s != null ? s._isProperty : void 0) {
                            return new Source(s, false);
                        } else {
                            return new ConsumingSource(s, true);
                        }
                    };

                    function Desc(context, method, args) {
                        this.context = context;
                        this.method = method;
                        this.args = args;
                    }
                    extend(Desc.prototype, {
                        _isDesc: true,
                        deps: function() {
                            if (!this.cached) {
                                this.cached = findDeps([this.context].concat(this.args));
                            }
                            return this.cached;
                        },
                        toString: function() {
                            return _.toString(this.context) + "." + _.toString(this.method) + "(" + _.map(_.toString, this.args) + ")";
                        }
                    });
                    var describe = function(context, method) {
                        var ref = context || method;
                        if (ref && ref._isDesc) {
                            return context || method;
                        } else {
                            for (var _len = arguments.length, args = Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {
                                args[_key - 2] = arguments[_key];
                            }
                            return new Desc(context, method, args);
                        }
                    };
                    var withDesc = function(desc, obs) {
                        obs.desc = desc;
                        return obs;
                    };
                    var findDeps = function(x) {
                        if (isArray(x)) {
                            return _.flatMap(findDeps, x);
                        } else if (isObservable(x)) {
                            return [x];
                        } else if (typeof x !== "undefined" && x !== null ? x._isSource : undefined) {
                            return [x.obs];
                        } else {
                            return [];
                        }
                    };
                    Bacon.Desc = Desc;
                    Bacon.Desc.empty = new Bacon.Desc("", "", []);
                    var withMethodCallSupport = function(wrapped) {
                        return function(f) {
                            for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
                                args[_key2 - 1] = arguments[_key2];
                            }
                            if (typeof f === "object" && args.length) {
                                var context = f;
                                var methodName = args[0];
                                f = function() {
                                    return context[methodName].apply(context, arguments);
                                };
                                args = args.slice(1);
                            }
                            return wrapped.apply(undefined, [f].concat(args));
                        };
                    };
                    var makeFunctionArgs = function(args) {
                        args = Array.prototype.slice.call(args);
                        return makeFunction_.apply(undefined, args);
                    };
                    var partiallyApplied = function(f, applied) {
                        return function() {
                            for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
                                args[_key3] = arguments[_key3];
                            }
                            return f.apply(undefined, applied.concat(args));
                        };
                    };
                    var toSimpleExtractor = function(args) {
                        return function(key) {
                            return function(value) {
                                if (!(typeof value !== "undefined" && value !== null)) {
                                    return;
                                } else {
                                    var fieldValue = value[key];
                                    if (_.isFunction(fieldValue)) {
                                        return fieldValue.apply(value, args);
                                    } else {
                                        return fieldValue;
                                    }
                                }
                            };
                        };
                    };
                    var toFieldExtractor = function(f, args) {
                        var parts = f.slice(1).split(".");
                        var partFuncs = _.map(toSimpleExtractor(args), parts);
                        return function(value) {
                            for (var i = 0, f; i < partFuncs.length; i++) {
                                f = partFuncs[i];
                                value = f(value);
                            }
                            return value;
                        };
                    };
                    var isFieldKey = function(f) {
                        return typeof f === "string" && f.length > 1 && f.charAt(0) === ".";
                    };
                    var makeFunction_ = withMethodCallSupport(function(f) {
                        for (var _len4 = arguments.length, args = Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {
                            args[_key4 - 1] = arguments[_key4];
                        }
                        if (_.isFunction(f)) {
                            if (args.length) {
                                return partiallyApplied(f, args);
                            } else {
                                return f;
                            }
                        } else if (isFieldKey(f)) {
                            return toFieldExtractor(f, args);
                        } else {
                            return _.always(f);
                        }
                    });
                    var makeFunction = function(f, args) {
                        return makeFunction_.apply(undefined, [f].concat(args));
                    };
                    var convertArgsToFunction = function(obs, f, args, method) {
                        if (typeof f !== "undefined" && f !== null ? f._isProperty : undefined) {
                            var sampled = f.sampledBy(obs, function(p, s) {
                                return [p, s];
                            });
                            return method.call(sampled, function(_ref) {
                                var p = _ref[0];
                                var s = _ref[1];
                                return p;
                            }).map(function(_ref2) {
                                var p = _ref2[0];
                                var s = _ref2[1];
                                return s;
                            });
                        } else {
                            f = makeFunction(f, args);
                            return method.call(obs, f);
                        }
                    };
                    var toCombinator = function(f) {
                        if (_.isFunction(f)) {
                            return f;
                        } else if (isFieldKey(f)) {
                            var key = toFieldKey(f);
                            return function(left, right) {
                                return left[key](right);
                            };
                        } else {
                            throw new Exception("not a function or a field key: " + f);
                        }
                    };
                    var toFieldKey = function(f) {
                        return f.slice(1);
                    };

                    function Some(value) {
                        this.value = value;
                    }
                    extend(Some.prototype, {
                        _isSome: true,
                        getOrElse: function() {
                            return this.value;
                        },
                        get: function() {
                            return this.value;
                        },
                        filter: function(f) {
                            if (f(this.value)) {
                                return new Some(this.value);
                            } else {
                                return None;
                            }
                        },
                        map: function(f) {
                            return new Some(f(this.value));
                        },
                        forEach: function(f) {
                            return f(this.value);
                        },
                        isDefined: true,
                        toArray: function() {
                            return [this.value];
                        },
                        inspect: function() {
                            return "Some(" + this.value + ")";
                        },
                        toString: function() {
                            return this.inspect();
                        }
                    });
                    var None = {
                        _isNone: true,
                        getOrElse: function(value) {
                            return value;
                        },
                        filter: function() {
                            return None;
                        },
                        map: function() {
                            return None;
                        },
                        forEach: function() {},
                        isDefined: false,
                        toArray: function() {
                            return [];
                        },
                        inspect: function() {
                            return "None";
                        },
                        toString: function() {
                            return this.inspect();
                        }
                    };
                    var toOption = function(v) {
                        if ((typeof v !== "undefined" && v !== null ? v._isSome : undefined) || (typeof v !== "undefined" && v !== null ? v._isNone : undefined)) {
                            return v;
                        } else {
                            return new Some(v);
                        }
                    };
                    Bacon.noMore = "<no-more>";
                    Bacon.more = "<more>";
                    var eventIdCounter = 0;

                    function Event() {
                        this.id = ++eventIdCounter;
                    }
                    Event.prototype._isEvent = true;
                    Event.prototype.isEvent = function() {
                        return true;
                    };
                    Event.prototype.isEnd = function() {
                        return false;
                    };
                    Event.prototype.isInitial = function() {
                        return false;
                    };
                    Event.prototype.isNext = function() {
                        return false;
                    };
                    Event.prototype.isError = function() {
                        return false;
                    };
                    Event.prototype.hasValue = function() {
                        return false;
                    };
                    Event.prototype.filter = function() {
                        return true;
                    };
                    Event.prototype.inspect = function() {
                        return this.toString();
                    };
                    Event.prototype.log = function() {
                        return this.toString();
                    };

                    function Next(valueF, eager) {
                        if (!(this instanceof Next)) {
                            return new Next(valueF, eager);
                        }
                        Event.call(this);
                        if (!eager && _.isFunction(valueF) || (valueF != null ? valueF._isNext : void 0)) {
                            this.valueF = valueF;
                            this.valueInternal = void 0;
                        } else {
                            this.valueF = void 0;
                            this.valueInternal = valueF;
                        }
                    }
                    inherit(Next, Event);
                    Next.prototype.isNext = function() {
                        return true;
                    };
                    Next.prototype.hasValue = function() {
                        return true;
                    };
                    Next.prototype.value = function() {
                        var ref;
                        if ((ref = this.valueF) != null ? ref._isNext : void 0) {
                            this.valueInternal = this.valueF.value();
                            this.valueF = void 0;
                        } else if (this.valueF) {
                            this.valueInternal = this.valueF();
                            this.valueF = void 0;
                        }
                        return this.valueInternal;
                    };
                    Next.prototype.fmap = function(f) {
                        var event, value;
                        if (this.valueInternal) {
                            value = this.valueInternal;
                            return this.apply(function() {
                                return f(value);
                            });
                        } else {
                            event = this;
                            return this.apply(function() {
                                return f(event.value());
                            });
                        }
                    };
                    Next.prototype.apply = function(value) {
                        return new Next(value);
                    };
                    Next.prototype.filter = function(f) {
                        return f(this.value());
                    };
                    Next.prototype.toString = function() {
                        return _.toString(this.value());
                    };
                    Next.prototype.log = function() {
                        return this.value();
                    };
                    Next.prototype._isNext = true;

                    function Initial(valueF, eager) {
                        if (!(this instanceof Initial)) {
                            return new Initial(valueF, eager);
                        }
                        Next.call(this, valueF, eager);
                    }
                    inherit(Initial, Next);
                    Initial.prototype._isInitial = true;
                    Initial.prototype.isInitial = function() {
                        return true;
                    };
                    Initial.prototype.isNext = function() {
                        return false;
                    };
                    Initial.prototype.apply = function(value) {
                        return new Initial(value);
                    };
                    Initial.prototype.toNext = function() {
                        return new Next(this);
                    };

                    function End() {
                        if (!(this instanceof End)) {
                            return new End();
                        }
                        Event.call(this);
                    }
                    inherit(End, Event);
                    End.prototype.isEnd = function() {
                        return true;
                    };
                    End.prototype.fmap = function() {
                        return this;
                    };
                    End.prototype.apply = function() {
                        return this;
                    };
                    End.prototype.toString = function() {
                        return "<end>";
                    };

                    function Error(error) {
                        if (!(this instanceof Error)) {
                            return new Error(error);
                        }
                        this.error = error;
                        Event.call(this);
                    }
                    inherit(Error, Event);
                    Error.prototype.isError = function() {
                        return true;
                    };
                    Error.prototype.fmap = function() {
                        return this;
                    };
                    Error.prototype.apply = function() {
                        return this;
                    };
                    Error.prototype.toString = function() {
                        return "<error> " + _.toString(this.error);
                    };
                    Bacon.Event = Event;
                    Bacon.Initial = Initial;
                    Bacon.Next = Next;
                    Bacon.End = End;
                    Bacon.Error = Error;
                    var initialEvent = function(value) {
                        return new Initial(value, true);
                    };
                    var nextEvent = function(value) {
                        return new Next(value, true);
                    };
                    var endEvent = function() {
                        return new End();
                    };
                    var toEvent = function(x) {
                        if (x && x._isEvent) {
                            return x;
                        } else {
                            return nextEvent(x);
                        }
                    };
                    var idCounter = 0;
                    var registerObs = function() {};

                    function Observable(desc) {
                        this.desc = desc;
                        this.id = ++idCounter;
                        this.initialDesc = this.desc;
                    }
                    extend(Observable.prototype, {
                        _isObservable: true,
                        subscribe: function(sink) {
                            return UpdateBarrier.wrappedSubscribe(this, sink);
                        },
                        subscribeInternal: function(sink) {
                            return this.dispatcher.subscribe(sink);
                        },
                        onValue: function() {
                            var f = makeFunctionArgs(arguments);
                            return this.subscribe(function(event) {
                                if (event.hasValue()) {
                                    return f(event.value());
                                }
                            });
                        },
                        onValues: function(f) {
                            return this.onValue(function(args) {
                                return f.apply(undefined, args);
                            });
                        },
                        onError: function() {
                            var f = makeFunctionArgs(arguments);
                            return this.subscribe(function(event) {
                                if (event.isError()) {
                                    return f(event.error);
                                }
                            });
                        },
                        onEnd: function() {
                            var f = makeFunctionArgs(arguments);
                            return this.subscribe(function(event) {
                                if (event.isEnd()) {
                                    return f();
                                }
                            });
                        },
                        name: function(name) {
                            this._name = name;
                            return this;
                        },
                        withDescription: function() {
                            this.desc = describe.apply(undefined, arguments);
                            return this;
                        },
                        toString: function() {
                            if (this._name) {
                                return this._name;
                            } else {
                                return this.desc.toString();
                            }
                        },
                        internalDeps: function() {
                            return this.initialDesc.deps();
                        }
                    });
                    Observable.prototype.assign = Observable.prototype.onValue;
                    Observable.prototype.forEach = Observable.prototype.onValue;
                    Observable.prototype.inspect = Observable.prototype.toString;
                    Bacon.Observable = Observable;

                    function CompositeUnsubscribe() {
                        var ss = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];
                        this.unsubscribe = _.bind(this.unsubscribe, this);
                        this.unsubscribed = false;
                        this.subscriptions = [];
                        this.starting = [];
                        for (var i = 0, s; i < ss.length; i++) {
                            s = ss[i];
                            this.add(s);
                        }
                    }
                    extend(CompositeUnsubscribe.prototype, {
                        add: function(subscription) {
                            var _this2 = this;
                            if (this.unsubscribed) {
                                return;
                            }
                            var ended = false;
                            var unsub = nop;
                            this.starting.push(subscription);
                            var unsubMe = function() {
                                if (_this2.unsubscribed) {
                                    return;
                                }
                                ended = true;
                                _this2.remove(unsub);
                                return _.remove(subscription, _this2.starting);
                            };
                            unsub = subscription(this.unsubscribe, unsubMe);
                            if (!(this.unsubscribed || ended)) {
                                this.subscriptions.push(unsub);
                            } else {
                                unsub();
                            }
                            _.remove(subscription, this.starting);
                            return unsub;
                        },
                        remove: function(unsub) {
                            if (this.unsubscribed) {
                                return;
                            }
                            if (_.remove(unsub, this.subscriptions) !== undefined) {
                                return unsub();
                            }
                        },
                        unsubscribe: function() {
                            if (this.unsubscribed) {
                                return;
                            }
                            this.unsubscribed = true;
                            var iterable = this.subscriptions;
                            for (var i = 0; i < iterable.length; i++) {
                                iterable[i]();
                            }
                            this.subscriptions = [];
                            this.starting = [];
                            return [];
                        },
                        count: function() {
                            if (this.unsubscribed) {
                                return 0;
                            }
                            return this.subscriptions.length + this.starting.length;
                        },
                        empty: function() {
                            return this.count() === 0;
                        }
                    });
                    Bacon.CompositeUnsubscribe = CompositeUnsubscribe;

                    function Dispatcher(_subscribe, _handleEvent) {
                        this._subscribe = _subscribe;
                        this._handleEvent = _handleEvent;
                        this.subscribe = _.bind(this.subscribe, this);
                        this.handleEvent = _.bind(this.handleEvent, this);
                        this.pushing = false;
                        this.ended = false;
                        this.prevError = undefined;
                        this.unsubSrc = undefined;
                        this.subscriptions = [];
                        this.queue = [];
                    }
                    Dispatcher.prototype.hasSubscribers = function() {
                        return this.subscriptions.length > 0;
                    };
                    Dispatcher.prototype.removeSub = function(subscription) {
                        this.subscriptions = _.without(subscription, this.subscriptions);
                        return this.subscriptions;
                    };
                    Dispatcher.prototype.push = function(event) {
                        if (event.isEnd()) {
                            this.ended = true;
                        }
                        return UpdateBarrier.inTransaction(event, this, this.pushIt, [event]);
                    };
                    Dispatcher.prototype.pushToSubscriptions = function(event) {
                        try {
                            var tmp = this.subscriptions;
                            var len = tmp.length;
                            for (var i = 0; i < len; i++) {
                                var sub = tmp[i];
                                var reply = sub.sink(event);
                                if (reply === Bacon.noMore || event.isEnd()) {
                                    this.removeSub(sub);
                                }
                            }
                            return true;
                        } catch (error) {
                            this.pushing = false;
                            this.queue = [];
                            throw error;
                        }
                    };
                    Dispatcher.prototype.pushIt = function(event) {
                        if (!this.pushing) {
                            if (event === this.prevError) {
                                return;
                            }
                            if (event.isError()) {
                                this.prevError = event;
                            }
                            this.pushing = true;
                            this.pushToSubscriptions(event);
                            this.pushing = false;
                            while (this.queue.length) {
                                event = this.queue.shift();
                                this.push(event);
                            }
                            if (this.hasSubscribers()) {
                                return Bacon.more;
                            } else {
                                this.unsubscribeFromSource();
                                return Bacon.noMore;
                            }
                        } else {
                            this.queue.push(event);
                            return Bacon.more;
                        }
                    };
                    Dispatcher.prototype.handleEvent = function(event) {
                        if (this._handleEvent) {
                            return this._handleEvent(event);
                        } else {
                            return this.push(event);
                        }
                    };
                    Dispatcher.prototype.unsubscribeFromSource = function() {
                        if (this.unsubSrc) {
                            this.unsubSrc();
                        }
                        this.unsubSrc = undefined;
                    };
                    Dispatcher.prototype.subscribe = function(sink) {
                        var subscription;
                        if (this.ended) {
                            sink(endEvent());
                            return nop;
                        } else {
                            assertFunction(sink);
                            subscription = {
                                sink: sink
                            };
                            this.subscriptions.push(subscription);
                            if (this.subscriptions.length === 1) {
                                this.unsubSrc = this._subscribe(this.handleEvent);
                                assertFunction(this.unsubSrc);
                            }
                            return (function(_this) {
                                return function() {
                                    _this.removeSub(subscription);
                                    if (!_this.hasSubscribers()) {
                                        return _this.unsubscribeFromSource();
                                    }
                                };
                            })(this);
                        }
                    };
                    Bacon.Dispatcher = Dispatcher;

                    function EventStream(desc, subscribe, handler) {
                        if (!(this instanceof EventStream)) {
                            return new EventStream(desc, subscribe, handler);
                        }
                        if (_.isFunction(desc)) {
                            handler = subscribe;
                            subscribe = desc;
                            desc = Desc.empty;
                        }
                        Observable.call(this, desc);
                        assertFunction(subscribe);
                        this.dispatcher = new Dispatcher(subscribe, handler);
                        registerObs(this);
                    }
                    inherit(EventStream, Observable);
                    extend(EventStream.prototype, {
                        _isEventStream: true,
                        toProperty: function(initValue_) {
                            var initValue = arguments.length === 0 ? None : toOption(function() {
                                return initValue_;
                            });
                            var disp = this.dispatcher;
                            var desc = new Bacon.Desc(this, "toProperty", [initValue_]);
                            return new Property(desc, function(sink) {
                                var initSent = false;
                                var subbed = false;
                                var unsub = nop;
                                var reply = Bacon.more;
                                var sendInit = function() {
                                    if (!initSent) {
                                        return initValue.forEach(function(value) {
                                            initSent = true;
                                            reply = sink(new Initial(value));
                                            if (reply === Bacon.noMore) {
                                                unsub();
                                                unsub = nop;
                                                return nop;
                                            }
                                        });
                                    }
                                };
                                unsub = disp.subscribe(function(event) {
                                    if (event.hasValue()) {
                                        if (event.isInitial() && !subbed) {
                                            initValue = new Some(function() {
                                                return event.value();
                                            });
                                            return Bacon.more;
                                        } else {
                                            if (!event.isInitial()) {
                                                sendInit();
                                            }
                                            initSent = true;
                                            initValue = new Some(event);
                                            return sink(event);
                                        }
                                    } else {
                                        if (event.isEnd()) {
                                            reply = sendInit();
                                        }
                                        if (reply !== Bacon.noMore) {
                                            return sink(event);
                                        }
                                    }
                                });
                                subbed = true;
                                sendInit();
                                return unsub;
                            });
                        },
                        toEventStream: function() {
                            return this;
                        },
                        withHandler: function(handler) {
                            return new EventStream(new Bacon.Desc(this, "withHandler", [handler]), this.dispatcher.subscribe, handler);
                        }
                    });
                    Bacon.EventStream = EventStream;
                    Bacon.never = function() {
                        return new EventStream(describe(Bacon, "never"), function(sink) {
                            sink(endEvent());
                            return nop;
                        });
                    };
                    Bacon.when = function() {
                        if (arguments.length === 0) {
                            return Bacon.never();
                        }
                        var len = arguments.length;
                        var usage = "when: expecting arguments in the form (Observable+,function)+";
                        assert(usage, len % 2 === 0);
                        var sources = [];
                        var pats = [];
                        var i = 0;
                        var patterns = [];
                        while (i < len) {
                            patterns[i] = arguments[i];
                            patterns[i + 1] = arguments[i + 1];
                            var patSources = _.toArray(arguments[i]);
                            var f = constantToFunction(arguments[i + 1]);
                            var pat = {
                                f: f,
                                ixs: []
                            };
                            var triggerFound = false;
                            for (var j = 0, s; j < patSources.length; j++) {
                                s = patSources[j];
                                var index = _.indexOf(sources, s);
                                if (!triggerFound) {
                                    triggerFound = Source.isTrigger(s);
                                }
                                if (index < 0) {
                                    sources.push(s);
                                    index = sources.length - 1;
                                }
                                for (var k = 0, ix; k < pat.ixs.length; k++) {
                                    ix = pat.ixs[k];
                                    if (ix.index === index) {
                                        ix.count++;
                                    }
                                }
                                pat.ixs.push({
                                    index: index,
                                    count: 1
                                });
                            }
                            assert("At least one EventStream required", triggerFound || !patSources.length);
                            if (patSources.length > 0) {
                                pats.push(pat);
                            }
                            i = i + 2;
                        }
                        if (!sources.length) {
                            return Bacon.never();
                        }
                        sources = _.map(Source.fromObservable, sources);
                        var needsBarrier = _.any(sources, function(s) {
                            return s.flatten;
                        }) && containsDuplicateDeps(_.map(function(s) {
                            return s.obs;
                        }, sources));
                        var desc = new Bacon.Desc(Bacon, "when", patterns);
                        var resultStream = new EventStream(desc, function(sink) {
                            var triggers = [];
                            var ends = false;
                            var match = function(p) {
                                for (var i1 = 0, i; i1 < p.ixs.length; i1++) {
                                    i = p.ixs[i1];
                                    if (!sources[i.index].hasAtLeast(i.count)) {
                                        return false;
                                    }
                                }
                                return true;
                            };
                            var cannotSync = function(source) {
                                return !source.sync || source.ended;
                            };
                            var cannotMatch = function(p) {
                                for (var i1 = 0, i; i1 < p.ixs.length; i1++) {
                                    i = p.ixs[i1];
                                    if (!sources[i.index].mayHave(i.count)) {
                                        return true;
                                    }
                                }
                            };
                            var nonFlattened = function(trigger) {
                                return !trigger.source.flatten;
                            };
                            var part = function(source) {
                                return function(unsubAll) {
                                    var flushLater = function() {
                                        return UpdateBarrier.whenDoneWith(resultStream, flush);
                                    };
                                    var flushWhileTriggers = function() {
                                        if (triggers.length > 0) {
                                            var reply = Bacon.more;
                                            var trigger = triggers.pop();
                                            for (var i1 = 0, p; i1 < pats.length; i1++) {
                                                p = pats[i1];
                                                if (match(p)) {
                                                    var events = (function() {
                                                        var result = [];
                                                        for (var i2 = 0, i; i2 < p.ixs.length; i2++) {
                                                            i = p.ixs[i2];
                                                            result.push(sources[i.index].consume());
                                                        }
                                                        return result;
                                                    })();
                                                    reply = sink(trigger.e.apply(function() {
                                                        var _p;
                                                        var values = (function() {
                                                            var result = [];
                                                            for (var i2 = 0, event; i2 < events.length; i2++) {
                                                                event = events[i2];
                                                                result.push(event.value());
                                                            }
                                                            return result;
                                                        })();
                                                        return (_p = p).f.apply(_p, values);
                                                    }));
                                                    if (triggers.length) {
                                                        triggers = _.filter(nonFlattened, triggers);
                                                    }
                                                    if (reply === Bacon.noMore) {
                                                        return reply;
                                                    } else {
                                                        return flushWhileTriggers();
                                                    }
                                                }
                                            }
                                        } else {
                                            return Bacon.more;
                                        }
                                    };
                                    var flush = function() {
                                        var reply = flushWhileTriggers();
                                        if (ends) {
                                            if (_.all(sources, cannotSync) || _.all(pats, cannotMatch)) {
                                                reply = Bacon.noMore;
                                                sink(endEvent());
                                            }
                                        }
                                        if (reply === Bacon.noMore) {
                                            unsubAll();
                                        }
                                        return reply;
                                    };
                                    return source.subscribe(function(e) {
                                        if (e.isEnd()) {
                                            ends = true;
                                            source.markEnded();
                                            flushLater();
                                        } else if (e.isError()) {
                                            var reply = sink(e);
                                        } else {
                                            source.push(e);
                                            if (source.sync) {
                                                triggers.push({
                                                    source: source,
                                                    e: e
                                                });
                                                if (needsBarrier || UpdateBarrier.hasWaiters()) {
                                                    flushLater();
                                                } else {
                                                    flush();
                                                }
                                            }
                                        }
                                        if (reply === Bacon.noMore) {
                                            unsubAll();
                                        }
                                        return reply || Bacon.more;
                                    });
                                };
                            };
                            return new Bacon.CompositeUnsubscribe((function() {
                                var result = [];
                                for (var i1 = 0, s; i1 < sources.length; i1++) {
                                    s = sources[i1];
                                    result.push(part(s));
                                }
                                return result;
                            })()).unsubscribe;
                        });
                        return resultStream;
                    };
                    var containsDuplicateDeps = function(observables) {
                        var state = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];
                        var checkObservable = function(obs) {
                            if (_.contains(state, obs)) {
                                return true;
                            } else {
                                var deps = obs.internalDeps();
                                if (deps.length) {
                                    state.push(obs);
                                    return _.any(deps, checkObservable);
                                } else {
                                    state.push(obs);
                                    return false;
                                }
                            }
                        };
                        return _.any(observables, checkObservable);
                    };
                    var constantToFunction = function(f) {
                        if (_.isFunction(f)) {
                            return f;
                        } else {
                            return _.always(f);
                        }
                    };
                    Bacon.groupSimultaneous = function() {
                        for (var _len5 = arguments.length, streams = Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {
                            streams[_key5] = arguments[_key5];
                        }
                        if (streams.length === 1 && isArray(streams[0])) {
                            streams = streams[0];
                        }
                        var sources = (function() {
                            var result = [];
                            for (var i = 0, s; i < streams.length; i++) {
                                s = streams[i];
                                result.push(new BufferingSource(s));
                            }
                            return result;
                        })();
                        return withDesc(new Bacon.Desc(Bacon, "groupSimultaneous", streams), Bacon.when(sources, function() {
                            for (var _len6 = arguments.length, xs = Array(_len6), _key6 = 0; _key6 < _len6; _key6++) {
                                xs[_key6] = arguments[_key6];
                            }
                            return xs;
                        }));
                    };

                    function PropertyDispatcher(property, subscribe, handleEvent) {
                        Dispatcher.call(this, subscribe, handleEvent);
                        this.property = property;
                        this.subscribe = _.bind(this.subscribe, this);
                        this.current = None;
                        this.currentValueRootId = undefined;
                        this.propertyEnded = false;
                    }
                    inherit(PropertyDispatcher, Dispatcher);
                    extend(PropertyDispatcher.prototype, {
                        push: function(event) {
                            if (event.isEnd()) {
                                this.propertyEnded = true;
                            }
                            if (event.hasValue()) {
                                this.current = new Some(event);
                                this.currentValueRootId = UpdateBarrier.currentEventId();
                            }
                            return Dispatcher.prototype.push.call(this, event);
                        },
                        maybeSubSource: function(sink, reply) {
                            if (reply === Bacon.noMore) {
                                return nop;
                            } else if (this.propertyEnded) {
                                sink(endEvent());
                                return nop;
                            } else {
                                return Dispatcher.prototype.subscribe.call(this, sink);
                            }
                        },
                        subscribe: function(sink) {
                            var _this3 = this;
                            var initSent = false;
                            var reply = Bacon.more;
                            if (this.current.isDefined && (this.hasSubscribers() || this.propertyEnded)) {
                                var dispatchingId = UpdateBarrier.currentEventId();
                                var valId = this.currentValueRootId;
                                if (!this.propertyEnded && valId && dispatchingId && dispatchingId !== valId) {
                                    UpdateBarrier.whenDoneWith(this.property, function() {
                                        if (_this3.currentValueRootId === valId) {
                                            return sink(initialEvent(_this3.current.get().value()));
                                        }
                                    });
                                    return this.maybeSubSource(sink, reply);
                                } else {
                                    UpdateBarrier.inTransaction(undefined, this, function() {
                                        reply = sink(initialEvent(this.current.get().value()));
                                        return reply;
                                    }, []);
                                    return this.maybeSubSource(sink, reply);
                                }
                            } else {
                                return this.maybeSubSource(sink, reply);
                            }
                        }
                    });

                    function Property(desc, subscribe, handler) {
                        Observable.call(this, desc);
                        assertFunction(subscribe);
                        this.dispatcher = new PropertyDispatcher(this, subscribe, handler);
                        registerObs(this);
                    }
                    inherit(Property, Observable);
                    extend(Property.prototype, {
                        _isProperty: true,
                        changes: function() {
                            var _this4 = this;
                            return new EventStream(new Bacon.Desc(this, "changes", []), function(sink) {
                                return _this4.dispatcher.subscribe(function(event) {
                                    if (!event.isInitial()) {
                                        return sink(event);
                                    }
                                });
                            });
                        },
                        withHandler: function(handler) {
                            return new Property(new Bacon.Desc(this, "withHandler", [handler]), this.dispatcher.subscribe, handler);
                        },
                        toProperty: function() {
                            assertNoArguments(arguments);
                            return this;
                        },
                        toEventStream: function() {
                            var _this5 = this;
                            return new EventStream(new Bacon.Desc(this, "toEventStream", []), function(sink) {
                                return _this5.dispatcher.subscribe(function(event) {
                                    if (event.isInitial()) {
                                        event = event.toNext();
                                    }
                                    return sink(event);
                                });
                            });
                        }
                    });
                    Bacon.Property = Property;
                    Bacon.constant = function(value) {
                        return new Property(new Bacon.Desc(Bacon, "constant", [value]), function(sink) {
                            sink(initialEvent(value));
                            sink(endEvent());
                            return nop;
                        });
                    };
                    Bacon.fromBinder = function(binder) {
                        var eventTransformer = arguments.length <= 1 || arguments[1] === undefined ? _.id : arguments[1];
                        var desc = new Bacon.Desc(Bacon, "fromBinder", [binder, eventTransformer]);
                        return new EventStream(desc, function(sink) {
                            var unbound = false;
                            var shouldUnbind = false;
                            var unbind = function() {
                                if (!unbound) {
                                    if (typeof unbinder !== "undefined" && unbinder !== null) {
                                        unbinder();
                                        return unbound = true;
                                    } else {
                                        return shouldUnbind = true;
                                    }
                                }
                            };
                            var unbinder = binder(function() {
                                var ref;
                                for (var _len7 = arguments.length, args = Array(_len7), _key7 = 0; _key7 < _len7; _key7++) {
                                    args[_key7] = arguments[_key7];
                                }
                                var value = eventTransformer.apply(this, args);
                                if (!(isArray(value) && ((ref = _.last(value)) != null ? ref._isEvent : undefined))) {
                                    value = [value];
                                }
                                var reply = Bacon.more;
                                for (var i = 0, event; i < value.length; i++) {
                                    event = value[i];
                                    reply = sink(event = toEvent(event));
                                    if (reply === Bacon.noMore || event.isEnd()) {
                                        unbind();
                                        return reply;
                                    }
                                }
                                return reply;
                            });
                            if (shouldUnbind) {
                                unbind();
                            }
                            return unbind;
                        });
                    };
                    Bacon.Observable.prototype.map = function(p) {
                        for (var _len8 = arguments.length, args = Array(_len8 > 1 ? _len8 - 1 : 0), _key8 = 1; _key8 < _len8; _key8++) {
                            args[_key8 - 1] = arguments[_key8];
                        }
                        return convertArgsToFunction(this, p, args, function(f) {
                            return withDesc(new Bacon.Desc(this, "map", [f]), this.withHandler(function(event) {
                                return this.push(event.fmap(f));
                            }));
                        });
                    };
                    var argumentsToObservables = function(args) {
                        if (isArray(args[0])) {
                            return args[0];
                        } else {
                            return Array.prototype.slice.call(args);
                        }
                    };
                    var argumentsToObservablesAndFunction = function(args) {
                        if (_.isFunction(args[0])) {
                            return [argumentsToObservables(Array.prototype.slice.call(args, 1)), args[0]];
                        } else {
                            return [argumentsToObservables(Array.prototype.slice.call(args, 0, args.length - 1)), _.last(args)];
                        }
                    };
                    Bacon.combineAsArray = function() {
                        var streams = argumentsToObservables(arguments);
                        for (var index = 0, stream; index < streams.length; index++) {
                            stream = streams[index];
                            if (!isObservable(stream)) {
                                streams[index] = Bacon.constant(stream);
                            }
                        }
                        if (streams.length) {
                            var sources = (function() {
                                var result = [];
                                for (var i = 0, s; i < streams.length; i++) {
                                    s = streams[i];
                                    result.push(new Source(s, true));
                                }
                                return result;
                            })();
                            return withDesc(new Bacon.Desc(Bacon, "combineAsArray", streams), Bacon.when(sources, function() {
                                for (var _len9 = arguments.length, xs = Array(_len9), _key9 = 0; _key9 < _len9; _key9++) {
                                    xs[_key9] = arguments[_key9];
                                }
                                return xs;
                            }).toProperty());
                        } else {
                            return Bacon.constant([]);
                        }
                    };
                    Bacon.onValues = function() {
                        for (var _len10 = arguments.length, streams = Array(_len10), _key10 = 0; _key10 < _len10; _key10++) {
                            streams[_key10] = arguments[_key10];
                        }
                        return Bacon.combineAsArray(streams.slice(0, streams.length - 1)).onValues(streams[streams.length - 1]);
                    };
                    Bacon.combineWith = function() {
                        var _argumentsToObservablesAndFunction = argumentsToObservablesAndFunction(arguments);
                        var streams = _argumentsToObservablesAndFunction[0];
                        var f = _argumentsToObservablesAndFunction[1];
                        var desc = new Bacon.Desc(Bacon, "combineWith", [f].concat(streams));
                        return withDesc(desc, Bacon.combineAsArray(streams).map(function(values) {
                            return f.apply(undefined, values);
                        }));
                    };
                    Bacon.Observable.prototype.combine = function(other, f) {
                        var combinator = toCombinator(f);
                        var desc = new Bacon.Desc(this, "combine", [other, f]);
                        return withDesc(desc, Bacon.combineAsArray(this, other).map(function(values) {
                            return combinator(values[0], values[1]);
                        }));
                    };
                    Bacon.Observable.prototype.withStateMachine = function(initState, f) {
                        var state = initState;
                        var desc = new Bacon.Desc(this, "withStateMachine", [initState, f]);
                        return withDesc(desc, this.withHandler(function(event) {
                            var fromF = f(state, event);
                            var newState = fromF[0];
                            var outputs = fromF[1];
                            state = newState;
                            var reply = Bacon.more;
                            for (var i = 0, output; i < outputs.length; i++) {
                                output = outputs[i];
                                reply = this.push(output);
                                if (reply === Bacon.noMore) {
                                    return reply;
                                }
                            }
                            return reply;
                        }));
                    };
                    var equals = function(a, b) {
                        return a === b;
                    };
                    var isNone = function(object) {
                        return typeof object !== "undefined" && object !== null ? object._isNone : false;
                    };
                    Bacon.Observable.prototype.skipDuplicates = function() {
                        var isEqual = arguments.length <= 0 || arguments[0] === undefined ? equals : arguments[0];
                        var desc = new Bacon.Desc(this, "skipDuplicates", []);
                        return withDesc(desc, this.withStateMachine(None, function(prev, event) {
                            if (!event.hasValue()) {
                                return [prev, [event]];
                            } else if (event.isInitial() || isNone(prev) || !isEqual(prev.get(), event.value())) {
                                return [new Some(event.value()), [event]];
                            } else {
                                return [prev, []];
                            }
                        }));
                    };
                    Bacon.Observable.prototype.awaiting = function(other) {
                        var desc = new Bacon.Desc(this, "awaiting", [other]);
                        return withDesc(desc, Bacon.groupSimultaneous(this, other).map(function(values) {
                            return values[1].length === 0;
                        }).toProperty(false).skipDuplicates());
                    };
                    Bacon.Observable.prototype.not = function() {
                        return withDesc(new Bacon.Desc(this, "not", []), this.map(function(x) {
                            return !x;
                        }));
                    };
                    Bacon.Property.prototype.and = function(other) {
                        return withDesc(new Bacon.Desc(this, "and", [other]), this.combine(other, function(x, y) {
                            return x && y;
                        }));
                    };
                    Bacon.Property.prototype.or = function(other) {
                        return withDesc(new Bacon.Desc(this, "or", [other]), this.combine(other, function(x, y) {
                            return x || y;
                        }));
                    };
                    Bacon.scheduler = {
                        setTimeout: function(f, d) {
                            return setTimeout(f, d);
                        },
                        setInterval: function(f, i) {
                            return setInterval(f, i);
                        },
                        clearInterval: function(id) {
                            return clearInterval(id);
                        },
                        clearTimeout: function(id) {
                            return clearTimeout(id);
                        },
                        now: function() {
                            return new Date().getTime();
                        }
                    };
                    Bacon.EventStream.prototype.bufferWithTime = function(delay) {
                        return withDesc(new Bacon.Desc(this, "bufferWithTime", [delay]), this.bufferWithTimeOrCount(delay, Number.MAX_VALUE));
                    };
                    Bacon.EventStream.prototype.bufferWithCount = function(count) {
                        return withDesc(new Bacon.Desc(this, "bufferWithCount", [count]), this.bufferWithTimeOrCount(undefined, count));
                    };
                    Bacon.EventStream.prototype.bufferWithTimeOrCount = function(delay, count) {
                        var flushOrSchedule = function(buffer) {
                            if (buffer.values.length === count) {
                                return buffer.flush();
                            } else if (delay !== undefined) {
                                return buffer.schedule();
                            }
                        };
                        var desc = new Bacon.Desc(this, "bufferWithTimeOrCount", [delay, count]);
                        return withDesc(desc, this.buffer(delay, flushOrSchedule, flushOrSchedule));
                    };
                    Bacon.EventStream.prototype.buffer = function(delay) {
                        var onInput = arguments.length <= 1 || arguments[1] === undefined ? nop : arguments[1];
                        var onFlush = arguments.length <= 2 || arguments[2] === undefined ? nop : arguments[2];
                        var buffer = {
                            scheduled: null,
                            end: undefined,
                            values: [],
                            flush: function() {
                                if (this.scheduled) {
                                    Bacon.scheduler.clearTimeout(this.scheduled);
                                    this.scheduled = null;
                                }
                                if (this.values.length > 0) {
                                    var valuesToPush = this.values;
                                    this.values = [];
                                    var reply = this.push(nextEvent(valuesToPush));
                                    if (this.end != null) {
                                        return this.push(this.end);
                                    } else if (reply !== Bacon.noMore) {
                                        return onFlush(this);
                                    }
                                } else {
                                    if (this.end != null) {
                                        return this.push(this.end);
                                    }
                                }
                            },
                            schedule: function() {
                                var _this6 = this;
                                if (!this.scheduled) {
                                    return this.scheduled = delay(function() {
                                        return _this6.flush();
                                    });
                                }
                            }
                        };
                        var reply = Bacon.more;
                        if (!_.isFunction(delay)) {
                            var delayMs = delay;
                            delay = function(f) {
                                return Bacon.scheduler.setTimeout(f, delayMs);
                            };
                        }
                        return withDesc(new Bacon.Desc(this, "buffer", []), this.withHandler(function(event) {
                            var _this7 = this;
                            buffer.push = function(event) {
                                return _this7.push(event);
                            };
                            if (event.isError()) {
                                reply = this.push(event);
                            } else if (event.isEnd()) {
                                buffer.end = event;
                                if (!buffer.scheduled) {
                                    buffer.flush();
                                }
                            } else {
                                buffer.values.push(event.value());
                                onInput(buffer);
                            }
                            return reply;
                        }));
                    };
                    Bacon.Observable.prototype.filter = function(f) {
                        assertObservableIsProperty(f);
                        for (var _len11 = arguments.length, args = Array(_len11 > 1 ? _len11 - 1 : 0), _key11 = 1; _key11 < _len11; _key11++) {
                            args[_key11 - 1] = arguments[_key11];
                        }
                        return convertArgsToFunction(this, f, args, function(f) {
                            return withDesc(new Bacon.Desc(this, "filter", [f]), this.withHandler(function(event) {
                                if (event.filter(f)) {
                                    return this.push(event);
                                } else {
                                    return Bacon.more;
                                }
                            }));
                        });
                    };
                    Bacon.once = function(value) {
                        return new EventStream(new Desc(Bacon, "once", [value]), function(sink) {
                            sink(toEvent(value));
                            sink(endEvent());
                            return nop;
                        });
                    };
                    Bacon.EventStream.prototype.concat = function(right) {
                        var left = this;
                        return new EventStream(new Bacon.Desc(left, "concat", [right]), function(sink) {
                            var unsubRight = nop;
                            var unsubLeft = left.dispatcher.subscribe(function(e) {
                                if (e.isEnd()) {
                                    unsubRight = right.dispatcher.subscribe(sink);
                                    return unsubRight;
                                } else {
                                    return sink(e);
                                }
                            });
                            return function() {
                                return (unsubLeft(), unsubRight());
                            };
                        });
                    };
                    Bacon.Observable.prototype.flatMap = function() {
                        return flatMap_(this, makeSpawner(arguments));
                    };
                    Bacon.Observable.prototype.flatMapFirst = function() {
                        return flatMap_(this, makeSpawner(arguments), true);
                    };
                    var makeSpawner = function(args) {
                        if (args.length === 1 && isObservable(args[0])) {
                            return _.always(args[0]);
                        } else {
                            return makeFunctionArgs(args);
                        }
                    };
                    var makeObservable = function(x) {
                        if (isObservable(x)) {
                            return x;
                        } else {
                            return Bacon.once(x);
                        }
                    };
                    var flatMap_ = function(root, f, firstOnly, limit) {
                        var rootDep = [root];
                        var childDeps = [];
                        var desc = new Bacon.Desc(root, "flatMap" + (firstOnly ? "First" : ""), [f]);
                        var result = new EventStream(desc, function(sink) {
                            var composite = new CompositeUnsubscribe();
                            var queue = [];
                            var spawn = function(event) {
                                var child = makeObservable(f(event.value()));
                                childDeps.push(child);
                                return composite.add(function(unsubAll, unsubMe) {
                                    return child.dispatcher.subscribe(function(event) {
                                        if (event.isEnd()) {
                                            _.remove(child, childDeps);
                                            checkQueue();
                                            checkEnd(unsubMe);
                                            return Bacon.noMore;
                                        } else {
                                            if (typeof event !== "undefined" && event !== null ? event._isInitial : undefined) {
                                                event = event.toNext();
                                            }
                                            var reply = sink(event);
                                            if (reply === Bacon.noMore) {
                                                unsubAll();
                                            }
                                            return reply;
                                        }
                                    });
                                });
                            };
                            var checkQueue = function() {
                                var event = queue.shift();
                                if (event) {
                                    return spawn(event);
                                }
                            };
                            var checkEnd = function(unsub) {
                                unsub();
                                if (composite.empty()) {
                                    return sink(endEvent());
                                }
                            };
                            composite.add(function(__, unsubRoot) {
                                return root.dispatcher.subscribe(function(event) {
                                    if (event.isEnd()) {
                                        return checkEnd(unsubRoot);
                                    } else if (event.isError()) {
                                        return sink(event);
                                    } else if (firstOnly && composite.count() > 1) {
                                        return Bacon.more;
                                    } else {
                                        if (composite.unsubscribed) {
                                            return Bacon.noMore;
                                        }
                                        if (limit && composite.count() > limit) {
                                            return queue.push(event);
                                        } else {
                                            return spawn(event);
                                        }
                                    }
                                });
                            });
                            return composite.unsubscribe;
                        });
                        result.internalDeps = function() {
                            if (childDeps.length) {
                                return rootDep.concat(childDeps);
                            } else {
                                return rootDep;
                            }
                        };
                        return result;
                    };
                    Bacon.Observable.prototype.flatMapWithConcurrencyLimit = function(limit) {
                        for (var _len12 = arguments.length, args = Array(_len12 > 1 ? _len12 - 1 : 0), _key12 = 1; _key12 < _len12; _key12++) {
                            args[_key12 - 1] = arguments[_key12];
                        }
                        var desc = new Bacon.Desc(this, "flatMapWithConcurrencyLimit", [limit].concat(args));
                        return withDesc(desc, flatMap_(this, makeSpawner(args), false, limit));
                    };
                    Bacon.Observable.prototype.flatMapConcat = function() {
                        var desc = new Bacon.Desc(this, "flatMapConcat", Array.prototype.slice.call(arguments, 0));
                        return withDesc(desc, this.flatMapWithConcurrencyLimit.apply(this, [1].concat(_slice.call(arguments))));
                    };
                    Bacon.later = function(delay, value) {
                        return withDesc(new Bacon.Desc(Bacon, "later", [delay, value]), Bacon.fromBinder(function(sink) {
                            var sender = function() {
                                return sink([value, endEvent()]);
                            };
                            var id = Bacon.scheduler.setTimeout(sender, delay);
                            return function() {
                                return Bacon.scheduler.clearTimeout(id);
                            };
                        }));
                    };
                    Bacon.Observable.prototype.bufferingThrottle = function(minimumInterval) {
                        var desc = new Bacon.Desc(this, "bufferingThrottle", [minimumInterval]);
                        return withDesc(desc, this.flatMapConcat(function(x) {
                            return Bacon.once(x).concat(Bacon.later(minimumInterval).filter(false));
                        }));
                    };
                    Bacon.Property.prototype.bufferingThrottle = function() {
                        return Bacon.Observable.prototype.bufferingThrottle.apply(this, arguments).toProperty();
                    };

                    function Bus() {
                        if (!(this instanceof Bus)) {
                            return new Bus();
                        }
                        this.unsubAll = _.bind(this.unsubAll, this);
                        this.subscribeAll = _.bind(this.subscribeAll, this);
                        this.guardedSink = _.bind(this.guardedSink, this);
                        this.sink = undefined;
                        this.subscriptions = [];
                        this.ended = false;
                        EventStream.call(this, new Bacon.Desc(Bacon, "Bus", []), this.subscribeAll);
                    }
                    inherit(Bus, EventStream);
                    extend(Bus.prototype, {
                        unsubAll: function() {
                            var iterable = this.subscriptions;
                            for (var i = 0, sub; i < iterable.length; i++) {
                                sub = iterable[i];
                                if (typeof sub.unsub === "function") {
                                    sub.unsub();
                                }
                            }
                        },
                        subscribeAll: function(newSink) {
                            if (this.ended) {
                                newSink(endEvent());
                            } else {
                                this.sink = newSink;
                                var iterable = cloneArray(this.subscriptions);
                                for (var i = 0, subscription; i < iterable.length; i++) {
                                    subscription = iterable[i];
                                    this.subscribeInput(subscription);
                                }
                            }
                            return this.unsubAll;
                        },
                        guardedSink: function(input) {
                            var _this8 = this;
                            return function(event) {
                                if (event.isEnd()) {
                                    _this8.unsubscribeInput(input);
                                    return Bacon.noMore;
                                } else {
                                    return _this8.sink(event);
                                }
                            };
                        },
                        subscribeInput: function(subscription) {
                            subscription.unsub = subscription.input.dispatcher.subscribe(this.guardedSink(subscription.input));
                            return subscription.unsub;
                        },
                        unsubscribeInput: function(input) {
                            var iterable = this.subscriptions;
                            for (var i = 0, sub; i < iterable.length; i++) {
                                sub = iterable[i];
                                if (sub.input === input) {
                                    if (typeof sub.unsub === "function") {
                                        sub.unsub();
                                    }
                                    this.subscriptions.splice(i, 1);
                                    return;
                                }
                            }
                        },
                        plug: function(input) {
                            var _this9 = this;
                            assertObservable(input);
                            if (this.ended) {
                                return;
                            }
                            var sub = {
                                input: input
                            };
                            this.subscriptions.push(sub);
                            if (typeof this.sink !== "undefined") {
                                this.subscribeInput(sub);
                            }
                            return function() {
                                return _this9.unsubscribeInput(input);
                            };
                        },
                        end: function() {
                            this.ended = true;
                            this.unsubAll();
                            if (typeof this.sink === "function") {
                                return this.sink(endEvent());
                            }
                        },
                        push: function(value) {
                            if (!this.ended && typeof this.sink === "function") {
                                return this.sink(nextEvent(value));
                            }
                        },
                        error: function(error) {
                            if (typeof this.sink === "function") {
                                return this.sink(new Error(error));
                            }
                        }
                    });
                    Bacon.Bus = Bus;
                    var liftCallback = function(desc, wrapped) {
                        return withMethodCallSupport(function(f) {
                            var stream = partiallyApplied(wrapped, [function(values, callback) {
                                return f.apply(undefined, values.concat([callback]));
                            }]);
                            for (var _len13 = arguments.length, args = Array(_len13 > 1 ? _len13 - 1 : 0), _key13 = 1; _key13 < _len13; _key13++) {
                                args[_key13 - 1] = arguments[_key13];
                            }
                            return withDesc(new Bacon.Desc(Bacon, desc, [f].concat(args)), Bacon.combineAsArray(args).flatMap(stream));
                        });
                    };
                    Bacon.fromCallback = liftCallback("fromCallback", function(f) {
                        for (var _len14 = arguments.length, args = Array(_len14 > 1 ? _len14 - 1 : 0), _key14 = 1; _key14 < _len14; _key14++) {
                            args[_key14 - 1] = arguments[_key14];
                        }
                        return Bacon.fromBinder(function(handler) {
                            makeFunction(f, args)(handler);
                            return nop;
                        }, function(value) {
                            return [value, endEvent()];
                        });
                    });
                    Bacon.fromNodeCallback = liftCallback("fromNodeCallback", function(f) {
                        for (var _len15 = arguments.length, args = Array(_len15 > 1 ? _len15 - 1 : 0), _key15 = 1; _key15 < _len15; _key15++) {
                            args[_key15 - 1] = arguments[_key15];
                        }
                        return Bacon.fromBinder(function(handler) {
                            makeFunction(f, args)(handler);
                            return nop;
                        }, function(error, value) {
                            if (error) {
                                return [new Error(error), endEvent()];
                            }
                            return [value, endEvent()];
                        });
                    });
                    Bacon.combineTemplate = function(template) {
                        function current(ctxStack) {
                            return ctxStack[ctxStack.length - 1];
                        }

                        function setValue(ctxStack, key, value) {
                            current(ctxStack)[key] = value;
                            return value;
                        }

                        function applyStreamValue(key, index) {
                            return function(ctxStack, values) {
                                return setValue(ctxStack, key, values[index]);
                            };
                        }

                        function constantValue(key, value) {
                            return function(ctxStack) {
                                return setValue(ctxStack, key, value);
                            };
                        }

                        function mkContext(template) {
                            return isArray(template) ? [] : {};
                        }

                        function pushContext(key, value) {
                            return function(ctxStack) {
                                var newContext = mkContext(value);
                                setValue(ctxStack, key, newContext);
                                return ctxStack.push(newContext);
                            };
                        }

                        function compile(key, value) {
                            if (isObservable(value)) {
                                streams.push(value);
                                return funcs.push(applyStreamValue(key, streams.length - 1));
                            } else if (value && (value.constructor == Object || value.constructor == Array)) {
                                var popContext = function(ctxStack) {
                                    return ctxStack.pop();
                                };
                                funcs.push(pushContext(key, value));
                                compileTemplate(value);
                                return funcs.push(popContext);
                            } else {
                                return funcs.push(constantValue(key, value));
                            }
                        }

                        function combinator(values) {
                            var rootContext = mkContext(template);
                            var ctxStack = [rootContext];
                            for (var i = 0, f; i < funcs.length; i++) {
                                f = funcs[i];
                                f(ctxStack, values);
                            }
                            return rootContext;
                        }

                        function compileTemplate(template) {
                            return _.each(template, compile);
                        }
                        var funcs = [];
                        var streams = [];
                        compileTemplate(template);
                        return withDesc(new Bacon.Desc(Bacon, "combineTemplate", [template]), Bacon.combineAsArray(streams).map(combinator));
                    };
                    var addPropertyInitValueToStream = function(property, stream) {
                        var justInitValue = new EventStream(describe(property, "justInitValue"), function(sink) {
                            var value = undefined;
                            var unsub = property.dispatcher.subscribe(function(event) {
                                if (!event.isEnd()) {
                                    value = event;
                                }
                                return Bacon.noMore;
                            });
                            UpdateBarrier.whenDoneWith(justInitValue, function() {
                                if (typeof value !== "undefined" && value !== null) {
                                    sink(value);
                                }
                                return sink(endEvent());
                            });
                            return unsub;
                        });
                        return justInitValue.concat(stream).toProperty();
                    };
                    Bacon.Observable.prototype.mapEnd = function() {
                        var f = makeFunctionArgs(arguments);
                        return withDesc(new Bacon.Desc(this, "mapEnd", [f]), this.withHandler(function(event) {
                            if (event.isEnd()) {
                                this.push(nextEvent(f(event)));
                                this.push(endEvent());
                                return Bacon.noMore;
                            } else {
                                return this.push(event);
                            }
                        }));
                    };
                    Bacon.Observable.prototype.skipErrors = function() {
                        return withDesc(new Bacon.Desc(this, "skipErrors", []), this.withHandler(function(event) {
                            if (event.isError()) {
                                return Bacon.more;
                            } else {
                                return this.push(event);
                            }
                        }));
                    };
                    Bacon.EventStream.prototype.takeUntil = function(stopper) {
                        var endMarker = {};
                        return withDesc(new Bacon.Desc(this, "takeUntil", [stopper]), Bacon.groupSimultaneous(this.mapEnd(endMarker), stopper.skipErrors()).withHandler(function(event) {
                            if (!event.hasValue()) {
                                return this.push(event);
                            } else {
                                var _event$value = event.value();
                                var data = _event$value[0];
                                var stopper = _event$value[1];
                                if (stopper.length) {
                                    return this.push(endEvent());
                                } else {
                                    var reply = Bacon.more;
                                    for (var i = 0, value; i < data.length; i++) {
                                        value = data[i];
                                        if (value === endMarker) {
                                            reply = this.push(endEvent());
                                        } else {
                                            reply = this.push(nextEvent(value));
                                        }
                                    }
                                    return reply;
                                }
                            }
                        }));
                    };
                    Bacon.Property.prototype.takeUntil = function(stopper) {
                        var changes = this.changes().takeUntil(stopper);
                        return withDesc(new Bacon.Desc(this, "takeUntil", [stopper]), addPropertyInitValueToStream(this, changes));
                    };
                    Bacon.Observable.prototype.flatMapLatest = function() {
                        var f = makeSpawner(arguments);
                        var stream = this.toEventStream();
                        return withDesc(new Bacon.Desc(this, "flatMapLatest", [f]), stream.flatMap(function(value) {
                            return makeObservable(f(value)).takeUntil(stream);
                        }));
                    };
                    Bacon.Property.prototype.delayChanges = function(desc, f) {
                        return withDesc(desc, addPropertyInitValueToStream(this, f(this.changes())));
                    };
                    Bacon.EventStream.prototype.delay = function(delay) {
                        return withDesc(new Bacon.Desc(this, "delay", [delay]), this.flatMap(function(value) {
                            return Bacon.later(delay, value);
                        }));
                    };
                    Bacon.Property.prototype.delay = function(delay) {
                        return this.delayChanges(new Bacon.Desc(this, "delay", [delay]), function(changes) {
                            return changes.delay(delay);
                        });
                    };
                    Bacon.EventStream.prototype.debounce = function(delay) {
                        return withDesc(new Bacon.Desc(this, "debounce", [delay]), this.flatMapLatest(function(value) {
                            return Bacon.later(delay, value);
                        }));
                    };
                    Bacon.Property.prototype.debounce = function(delay) {
                        return this.delayChanges(new Bacon.Desc(this, "debounce", [delay]), function(changes) {
                            return changes.debounce(delay);
                        });
                    };
                    Bacon.EventStream.prototype.debounceImmediate = function(delay) {
                        return withDesc(new Bacon.Desc(this, "debounceImmediate", [delay]), this.flatMapFirst(function(value) {
                            return Bacon.once(value).concat(Bacon.later(delay).filter(false));
                        }));
                    };
                    Bacon.Observable.prototype.decode = function(cases) {
                        return withDesc(new Bacon.Desc(this, "decode", [cases]), this.combine(Bacon.combineTemplate(cases), function(key, values) {
                            return values[key];
                        }));
                    };
                    Bacon.Observable.prototype.scan = function(seed, f) {
                        var _this10 = this;
                        var resultProperty;
                        f = toCombinator(f);
                        var acc = toOption(seed);
                        var initHandled = false;
                        var subscribe = function(sink) {
                            var initSent = false;
                            var unsub = nop;
                            var reply = Bacon.more;
                            var sendInit = function() {
                                if (!initSent) {
                                    return acc.forEach(function(value) {
                                        initSent = initHandled = true;
                                        reply = sink(new Initial(function() {
                                            return value;
                                        }));
                                        if (reply === Bacon.noMore) {
                                            unsub();
                                            unsub = nop;
                                            return unsub;
                                        }
                                    });
                                }
                            };
                            unsub = _this10.dispatcher.subscribe(function(event) {
                                if (event.hasValue()) {
                                    if (initHandled && event.isInitial()) {
                                        return Bacon.more;
                                    } else {
                                        if (!event.isInitial()) {
                                            sendInit();
                                        }
                                        initSent = initHandled = true;
                                        var prev = acc.getOrElse(undefined);
                                        var next = f(prev, event.value());
                                        acc = new Some(next);
                                        return sink(event.apply(function() {
                                            return next;
                                        }));
                                    }
                                } else {
                                    if (event.isEnd()) {
                                        reply = sendInit();
                                    }
                                    if (reply !== Bacon.noMore) {
                                        return sink(event);
                                    }
                                }
                            });
                            UpdateBarrier.whenDoneWith(resultProperty, sendInit);
                            return unsub;
                        };
                        resultProperty = new Property(new Bacon.Desc(this, "scan", [seed, f]), subscribe);
                        return resultProperty;
                    };
                    Bacon.Observable.prototype.diff = function(start, f) {
                        f = toCombinator(f);
                        return withDesc(new Bacon.Desc(this, "diff", [start, f]), this.scan([start], function(prevTuple, next) {
                            return [next, f(prevTuple[0], next)];
                        }).filter(function(tuple) {
                            return tuple.length === 2;
                        }).map(function(tuple) {
                            return tuple[1];
                        }));
                    };
                    Bacon.Observable.prototype.doAction = function() {
                        var f = makeFunctionArgs(arguments);
                        return withDesc(new Bacon.Desc(this, "doAction", [f]), this.withHandler(function(event) {
                            if (event.hasValue()) {
                                f(event.value());
                            }
                            return this.push(event);
                        }));
                    };
                    Bacon.Observable.prototype.doEnd = function() {
                        var f = makeFunctionArgs(arguments);
                        return withDesc(new Bacon.Desc(this, "doEnd", [f]), this.withHandler(function(event) {
                            if (event.isEnd()) {
                                f();
                            }
                            return this.push(event);
                        }));
                    };
                    Bacon.Observable.prototype.doError = function() {
                        var f = makeFunctionArgs(arguments);
                        return withDesc(new Bacon.Desc(this, "doError", [f]), this.withHandler(function(event) {
                            if (event.isError()) {
                                f(event.error);
                            }
                            return this.push(event);
                        }));
                    };
                    Bacon.Observable.prototype.doLog = function() {
                        for (var _len16 = arguments.length, args = Array(_len16), _key16 = 0; _key16 < _len16; _key16++) {
                            args[_key16] = arguments[_key16];
                        }
                        return withDesc(new Bacon.Desc(this, "doLog", args), this.withHandler(function(event) {
                            if (typeof console !== "undefined" && console !== null && typeof console.log === "function") {
                                console.log.apply(console, args.concat([event.log()]));
                            }
                            return this.push(event);
                        }));
                    };
                    Bacon.Observable.prototype.endOnError = function(f) {
                        if (!(typeof f !== "undefined" && f !== null)) {
                            f = true;
                        }
                        for (var _len17 = arguments.length, args = Array(_len17 > 1 ? _len17 - 1 : 0), _key17 = 1; _key17 < _len17; _key17++) {
                            args[_key17 - 1] = arguments[_key17];
                        }
                        return convertArgsToFunction(this, f, args, function(f) {
                            return withDesc(new Bacon.Desc(this, "endOnError", []), this.withHandler(function(event) {
                                if (event.isError() && f(event.error)) {
                                    this.push(event);
                                    return this.push(endEvent());
                                } else {
                                    return this.push(event);
                                }
                            }));
                        });
                    };
                    Observable.prototype.errors = function() {
                        return withDesc(new Bacon.Desc(this, "errors", []), this.filter(function() {
                            return false;
                        }));
                    };
                    Bacon.Observable.prototype.take = function(count) {
                        if (count <= 0) {
                            return Bacon.never();
                        }
                        return withDesc(new Bacon.Desc(this, "take", [count]), this.withHandler(function(event) {
                            if (!event.hasValue()) {
                                return this.push(event);
                            } else {
                                count--;
                                if (count > 0) {
                                    return this.push(event);
                                } else {
                                    if (count === 0) {
                                        this.push(event);
                                    }
                                    this.push(endEvent());
                                    return Bacon.noMore;
                                }
                            }
                        }));
                    };
                    Bacon.Observable.prototype.first = function() {
                        return withDesc(new Bacon.Desc(this, "first", []), this.take(1));
                    };
                    Bacon.Observable.prototype.mapError = function() {
                        var f = makeFunctionArgs(arguments);
                        return withDesc(new Bacon.Desc(this, "mapError", [f]), this.withHandler(function(event) {
                            if (event.isError()) {
                                return this.push(nextEvent(f(event.error)));
                            } else {
                                return this.push(event);
                            }
                        }));
                    };
                    Bacon.Observable.prototype.flatMapError = function(fn) {
                        var desc = new Bacon.Desc(this, "flatMapError", [fn]);
                        return withDesc(desc, this.mapError(function(err) {
                            return new Error(err);
                        }).flatMap(function(x) {
                            if (x instanceof Error) {
                                return fn(x.error);
                            } else {
                                return Bacon.once(x);
                            }
                        }));
                    };
                    Bacon.EventStream.prototype.sampledBy = function(sampler, combinator) {
                        return withDesc(new Bacon.Desc(this, "sampledBy", [sampler, combinator]), this.toProperty().sampledBy(sampler, combinator));
                    };
                    Bacon.Property.prototype.sampledBy = function(sampler, combinator) {
                        var lazy = false;
                        if (typeof combinator !== "undefined" && combinator !== null) {
                            combinator = toCombinator(combinator);
                        } else {
                            lazy = true;
                            combinator = function(f) {
                                return f.value();
                            };
                        }
                        var thisSource = new Source(this, false, lazy);
                        var samplerSource = new Source(sampler, true, lazy);
                        var stream = Bacon.when([thisSource, samplerSource], combinator);
                        var result = sampler._isProperty ? stream.toProperty() : stream;
                        return withDesc(new Bacon.Desc(this, "sampledBy", [sampler, combinator]), result);
                    };
                    Bacon.Property.prototype.sample = function(interval) {
                        return withDesc(new Bacon.Desc(this, "sample", [interval]), this.sampledBy(Bacon.interval(interval, {})));
                    };
                    Bacon.Observable.prototype.map = function(p) {
                        if (p && p._isProperty) {
                            return p.sampledBy(this, former);
                        } else {
                            for (var _len18 = arguments.length, args = Array(_len18 > 1 ? _len18 - 1 : 0), _key18 = 1; _key18 < _len18; _key18++) {
                                args[_key18 - 1] = arguments[_key18];
                            }
                            return convertArgsToFunction(this, p, args, function(f) {
                                return withDesc(new Bacon.Desc(this, "map", [f]), this.withHandler(function(event) {
                                    return this.push(event.fmap(f));
                                }));
                            });
                        }
                    };
                    Bacon.Observable.prototype.fold = function(seed, f) {
                        return withDesc(new Bacon.Desc(this, "fold", [seed, f]), this.scan(seed, f).sampledBy(this.filter(false).mapEnd().toProperty()));
                    };
                    Observable.prototype.reduce = Observable.prototype.fold;
                    var eventMethods = [
                        ["addEventListener", "removeEventListener"],
                        ["addListener", "removeListener"],
                        ["on", "off"],
                        ["bind", "unbind"]
                    ];
                    var findHandlerMethods = function(target) {
                        var pair;
                        for (var i = 0; i < eventMethods.length; i++) {
                            pair = eventMethods[i];
                            var methodPair = [target[pair[0]], target[pair[1]]];
                            if (methodPair[0] && methodPair[1]) {
                                return methodPair;
                            }
                        }
                        for (var j = 0; j < eventMethods.length; j++) {
                            pair = eventMethods[j];
                            var addListener = target[pair[0]];
                            if (addListener) {
                                return [addListener, function() {}];
                            }
                        }
                        throw new Error("No suitable event methods in " + target);
                    };
                    Bacon.fromEventTarget = function(target, eventName, eventTransformer) {
                        var _findHandlerMethods = findHandlerMethods(target);
                        var sub = _findHandlerMethods[0];
                        var unsub = _findHandlerMethods[1];
                        var desc = new Bacon.Desc(Bacon, "fromEvent", [target, eventName]);
                        return withDesc(desc, Bacon.fromBinder(function(handler) {
                            sub.call(target, eventName, handler);
                            return function() {
                                return unsub.call(target, eventName, handler);
                            };
                        }, eventTransformer));
                    };
                    Bacon.fromEvent = Bacon.fromEventTarget;
                    Bacon.fromPoll = function(delay, poll) {
                        var desc = new Bacon.Desc(Bacon, "fromPoll", [delay, poll]);
                        return withDesc(desc, Bacon.fromBinder(function(handler) {
                            var id = Bacon.scheduler.setInterval(handler, delay);
                            return function() {
                                return Bacon.scheduler.clearInterval(id);
                            };
                        }, poll));
                    };

                    function valueAndEnd(value) {
                        return [value, endEvent()];
                    }
                    Bacon.fromPromise = function(promise, abort) {
                        var eventTransformer = arguments.length <= 2 || arguments[2] === undefined ? valueAndEnd : arguments[2];
                        return withDesc(new Bacon.Desc(Bacon, "fromPromise", [promise]), Bacon.fromBinder(function(handler) {
                            var bound = promise.then(handler, function(e) {
                                return handler(new Error(e));
                            });
                            if (bound && typeof bound.done === "function") {
                                bound.done();
                            }
                            if (abort) {
                                return function() {
                                    if (typeof promise.abort === "function") {
                                        return promise.abort();
                                    }
                                };
                            } else {
                                return function() {};
                            }
                        }, eventTransformer));
                    };
                    Bacon.Observable.prototype.groupBy = function(keyF) {
                        var limitF = arguments.length <= 1 || arguments[1] === undefined ? Bacon._.id : arguments[1];
                        var streams = {};
                        var src = this;
                        return src.filter(function(x) {
                            return !streams[keyF(x)];
                        }).map(function(x) {
                            var key = keyF(x);
                            var similar = src.filter(function(x) {
                                return keyF(x) === key;
                            });
                            var data = Bacon.once(x).concat(similar);
                            var limited = limitF(data, x).withHandler(function(event) {
                                this.push(event);
                                if (event.isEnd()) {
                                    return delete streams[key];
                                }
                            });
                            streams[key] = limited;
                            return limited;
                        });
                    };
                    Bacon.fromArray = function(values) {
                        assertArray(values);
                        if (!values.length) {
                            return withDesc(new Bacon.Desc(Bacon, "fromArray", values), Bacon.never());
                        } else {
                            var i = 0;
                            return new EventStream(new Bacon.Desc(Bacon, "fromArray", [values]), function(sink) {
                                var unsubd = false;
                                var reply = Bacon.more;
                                var pushing = false;
                                var pushNeeded = false;
                                var push = function() {
                                    pushNeeded = true;
                                    if (pushing) {
                                        return;
                                    }
                                    pushing = true;
                                    while (pushNeeded) {
                                        pushNeeded = false;
                                        if (reply !== Bacon.noMore && !unsubd) {
                                            var value = values[i++];
                                            reply = sink(toEvent(value));
                                            if (reply !== Bacon.noMore) {
                                                if (i === values.length) {
                                                    sink(endEvent());
                                                } else {
                                                    UpdateBarrier.afterTransaction(push);
                                                }
                                            }
                                        }
                                    }
                                    pushing = false;
                                    return pushing;
                                };
                                push();
                                return function() {
                                    unsubd = true;
                                    return unsubd;
                                };
                            });
                        }
                    };
                    Bacon.EventStream.prototype.holdWhen = function(valve) {
                        var onHold = false;
                        var bufferedValues = [];
                        var src = this;
                        return new EventStream(new Bacon.Desc(this, "holdWhen", [valve]), function(sink) {
                            var composite = new CompositeUnsubscribe();
                            var subscribed = false;
                            var endIfBothEnded = function(unsub) {
                                if (typeof unsub === "function") {
                                    unsub();
                                }
                                if (composite.empty() && subscribed) {
                                    return sink(endEvent());
                                }
                            };
                            composite.add(function(unsubAll, unsubMe) {
                                return valve.subscribeInternal(function(event) {
                                    if (event.hasValue()) {
                                        onHold = event.value();
                                        if (!onHold) {
                                            var toSend = bufferedValues;
                                            bufferedValues = [];
                                            return (function() {
                                                var result = [];
                                                for (var i = 0, value; i < toSend.length; i++) {
                                                    value = toSend[i];
                                                    result.push(sink(nextEvent(value)));
                                                }
                                                return result;
                                            })();
                                        }
                                    } else if (event.isEnd()) {
                                        return endIfBothEnded(unsubMe);
                                    } else {
                                        return sink(event);
                                    }
                                });
                            });
                            composite.add(function(unsubAll, unsubMe) {
                                return src.subscribeInternal(function(event) {
                                    if (onHold && event.hasValue()) {
                                        return bufferedValues.push(event.value());
                                    } else if (event.isEnd() && bufferedValues.length) {
                                        return endIfBothEnded(unsubMe);
                                    } else {
                                        return sink(event);
                                    }
                                });
                            });
                            subscribed = true;
                            endIfBothEnded();
                            return composite.unsubscribe;
                        });
                    };
                    Bacon.interval = function(delay) {
                        var value = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
                        return withDesc(new Bacon.Desc(Bacon, "interval", [delay, value]), Bacon.fromPoll(delay, function() {
                            return nextEvent(value);
                        }));
                    };
                    Bacon.$ = {};
                    Bacon.$.asEventStream = function(eventName, selector, eventTransformer) {
                        var _this11 = this;
                        if (_.isFunction(selector)) {
                            eventTransformer = selector;
                            selector = undefined;
                        }
                        return withDesc(new Bacon.Desc(this.selector || this, "asEventStream", [eventName]), Bacon.fromBinder(function(handler) {
                            _this11.on(eventName, selector, handler);
                            return function() {
                                return _this11.off(eventName, selector, handler);
                            };
                        }, eventTransformer));
                    };
                    if (typeof jQuery !== "undefined" && jQuery) {
                        jQuery.fn.asEventStream = Bacon.$.asEventStream;
                    }
                    if (typeof Zepto !== "undefined" && Zepto) {
                        Zepto.fn.asEventStream = Bacon.$.asEventStream;
                    }
                    Bacon.Observable.prototype.last = function() {
                        var lastEvent;
                        return withDesc(new Bacon.Desc(this, "last", []), this.withHandler(function(event) {
                            if (event.isEnd()) {
                                if (lastEvent) {
                                    this.push(lastEvent);
                                }
                                this.push(endEvent());
                                return Bacon.noMore;
                            } else {
                                lastEvent = event;
                            }
                        }));
                    };
                    Bacon.Observable.prototype.log = function() {
                        for (var _len19 = arguments.length, args = Array(_len19), _key19 = 0; _key19 < _len19; _key19++) {
                            args[_key19] = arguments[_key19];
                        }
                        this.subscribe(function(event) {
                            if (typeof console !== "undefined" && typeof console.log === "function") {
                                console.log.apply(console, args.concat([event.log()]));
                            }
                        });
                        return this;
                    };
                    Bacon.EventStream.prototype.merge = function(right) {
                        assertEventStream(right);
                        var left = this;
                        return withDesc(new Bacon.Desc(left, "merge", [right]), Bacon.mergeAll(this, right));
                    };
                    Bacon.mergeAll = function() {
                        var streams = argumentsToObservables(arguments);
                        if (streams.length) {
                            return new EventStream(new Bacon.Desc(Bacon, "mergeAll", streams), function(sink) {
                                var ends = 0;
                                var smartSink = function(obs) {
                                    return function(unsubBoth) {
                                        return obs.dispatcher.subscribe(function(event) {
                                            if (event.isEnd()) {
                                                ends++;
                                                if (ends === streams.length) {
                                                    return sink(endEvent());
                                                } else {
                                                    return Bacon.more;
                                                }
                                            } else {
                                                var reply = sink(event);
                                                if (reply === Bacon.noMore) {
                                                    unsubBoth();
                                                }
                                                return reply;
                                            }
                                        });
                                    };
                                };
                                var sinks = _.map(smartSink, streams);
                                return new Bacon.CompositeUnsubscribe(sinks).unsubscribe;
                            });
                        } else {
                            return Bacon.never();
                        }
                    };
                    Bacon.repeatedly = function(delay, values) {
                        var index = 0;
                        return withDesc(new Bacon.Desc(Bacon, "repeatedly", [delay, values]), Bacon.fromPoll(delay, function() {
                            return values[index++ % values.length];
                        }));
                    };
                    Bacon.repeat = function(generator) {
                        var index = 0;
                        return Bacon.fromBinder(function(sink) {
                            var flag = false;
                            var reply = Bacon.more;
                            var unsub = function() {};

                            function handleEvent(event) {
                                if (event.isEnd()) {
                                    if (!flag) {
                                        return flag = true;
                                    } else {
                                        return subscribeNext();
                                    }
                                } else {
                                    return reply = sink(event);
                                }
                            };

                            function subscribeNext() {
                                var next;
                                flag = true;
                                while (flag && reply !== Bacon.noMore) {
                                    next = generator(index++);
                                    flag = false;
                                    if (next) {
                                        unsub = next.subscribeInternal(handleEvent);
                                    } else {
                                        sink(endEvent());
                                    }
                                }
                                return flag = true;
                            };
                            subscribeNext();
                            return function() {
                                return unsub();
                            };
                        });
                    };
                    Bacon.retry = function(options) {
                        if (!_.isFunction(options.source)) {
                            throw new Exception("'source' option has to be a function");
                        }
                        var source = options.source;
                        var retries = options.retries || 0;
                        var maxRetries = options.maxRetries || retries;
                        var delay = options.delay || function() {
                            return 0;
                        };
                        var isRetryable = options.isRetryable || function() {
                            return true;
                        };
                        var finished = false;
                        var error = null;
                        return withDesc(new Bacon.Desc(Bacon, "retry", [options]), Bacon.repeat(function() {
                            function valueStream() {
                                return source().endOnError().withHandler(function(event) {
                                    if (event.isError()) {
                                        error = event;
                                        if (!(isRetryable(error.error) && retries > 0)) {
                                            finished = true;
                                            return this.push(event);
                                        }
                                    } else {
                                        if (event.hasValue()) {
                                            error = null;
                                            finished = true;
                                        }
                                        return this.push(event);
                                    }
                                });
                            }
                            if (finished) {
                                return null;
                            } else if (error) {
                                var context = {
                                    error: error.error,
                                    retriesDone: maxRetries - retries
                                };
                                var pause = Bacon.later(delay(context)).filter(false);
                                retries = retries - 1;
                                return pause.concat(Bacon.once().flatMap(valueStream));
                            } else {
                                return valueStream();
                            }
                        }));
                    };
                    Bacon.sequentially = function(delay, values) {
                        var index = 0;
                        return withDesc(new Bacon.Desc(Bacon, "sequentially", [delay, values]), Bacon.fromPoll(delay, function() {
                            var value = values[index++];
                            if (index < values.length) {
                                return value;
                            } else if (index === values.length) {
                                return [value, endEvent()];
                            } else {
                                return endEvent();
                            }
                        }));
                    };
                    Bacon.Observable.prototype.skip = function(count) {
                        return withDesc(new Bacon.Desc(this, "skip", [count]), this.withHandler(function(event) {
                            if (!event.hasValue()) {
                                return this.push(event);
                            } else if (count > 0) {
                                count--;
                                return Bacon.more;
                            } else {
                                return this.push(event);
                            }
                        }));
                    };
                    Bacon.EventStream.prototype.skipUntil = function(starter) {
                        var started = starter.take(1).map(true).toProperty(false);
                        return withDesc(new Bacon.Desc(this, "skipUntil", [starter]), this.filter(started));
                    };
                    Bacon.EventStream.prototype.skipWhile = function(f) {
                        assertObservableIsProperty(f);
                        var ok = false;
                        for (var _len20 = arguments.length, args = Array(_len20 > 1 ? _len20 - 1 : 0), _key20 = 1; _key20 < _len20; _key20++) {
                            args[_key20 - 1] = arguments[_key20];
                        }
                        return convertArgsToFunction(this, f, args, function(f) {
                            return withDesc(new Bacon.Desc(this, "skipWhile", [f]), this.withHandler(function(event) {
                                if (ok || !event.hasValue() || !f(event.value())) {
                                    if (event.hasValue()) {
                                        ok = true;
                                    }
                                    return this.push(event);
                                } else {
                                    return Bacon.more;
                                }
                            }));
                        });
                    };
                    Bacon.Observable.prototype.slidingWindow = function(n) {
                        var minValues = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];
                        return withDesc(new Bacon.Desc(this, "slidingWindow", [n, minValues]), this.scan([], function(window, value) {
                            return window.concat([value]).slice(-n);
                        }).filter(function(values) {
                            return values.length >= minValues;
                        }));
                    };
                    var spies = [];
                    var registerObs = function(obs) {
                        if (spies.length) {
                            if (!registerObs.running) {
                                try {
                                    registerObs.running = true;
                                    spies.forEach(function(spy) {
                                        spy(obs);
                                    });
                                } finally {
                                    delete registerObs.running;
                                }
                            }
                        }
                    };
                    Bacon.spy = function(spy) {
                        return spies.push(spy);
                    };
                    Bacon.Property.prototype.startWith = function(seed) {
                        return withDesc(new Bacon.Desc(this, "startWith", [seed]), this.scan(seed, function(prev, next) {
                            return next;
                        }));
                    };
                    Bacon.EventStream.prototype.startWith = function(seed) {
                        return withDesc(new Bacon.Desc(this, "startWith", [seed]), Bacon.once(seed).concat(this));
                    };
                    Bacon.Observable.prototype.takeWhile = function(f) {
                        assertObservableIsProperty(f);
                        for (var _len21 = arguments.length, args = Array(_len21 > 1 ? _len21 - 1 : 0), _key21 = 1; _key21 < _len21; _key21++) {
                            args[_key21 - 1] = arguments[_key21];
                        }
                        return convertArgsToFunction(this, f, args, function(f) {
                            return withDesc(new Bacon.Desc(this, "takeWhile", [f]), this.withHandler(function(event) {
                                if (event.filter(f)) {
                                    return this.push(event);
                                } else {
                                    this.push(endEvent());
                                    return Bacon.noMore;
                                }
                            }));
                        });
                    };
                    Bacon.EventStream.prototype.throttle = function(delay) {
                        return withDesc(new Bacon.Desc(this, "throttle", [delay]), this.bufferWithTime(delay).map(function(values) {
                            return values[values.length - 1];
                        }));
                    };
                    Bacon.Property.prototype.throttle = function(delay) {
                        return this.delayChanges(new Bacon.Desc(this, "throttle", [delay]), function(changes) {
                            return changes.throttle(delay);
                        });
                    };
                    Observable.prototype.firstToPromise = function(PromiseCtr) {
                        var _this12 = this;
                        if (typeof PromiseCtr !== "function") {
                            if (typeof Promise === "function") {
                                PromiseCtr = Promise;
                            } else {
                                throw new Exception("There isn't default Promise, use shim or parameter");
                            }
                        }
                        return new PromiseCtr(function(resolve, reject) {
                            return _this12.subscribe(function(event) {
                                if (event.hasValue()) {
                                    resolve(event.value());
                                }
                                if (event.isError()) {
                                    reject(event.error);
                                }
                                return Bacon.noMore;
                            });
                        });
                    };
                    Observable.prototype.toPromise = function(PromiseCtr) {
                        return this.last().firstToPromise(PromiseCtr);
                    };
                    Bacon["try"] = function(f) {
                        return function(value) {
                            try {
                                return Bacon.once(f(value));
                            } catch (e) {
                                return new Bacon.Error(e);
                            }
                        };
                    };
                    Bacon.update = function(initial) {
                        function lateBindFirst(f) {
                            return function() {
                                for (var _len23 = arguments.length, args = Array(_len23), _key23 = 0; _key23 < _len23; _key23++) {
                                    args[_key23] = arguments[_key23];
                                }
                                return function(i) {
                                    return f.apply(undefined, [i].concat(args));
                                };
                            };
                        }
                        for (var _len22 = arguments.length, patterns = Array(_len22 > 1 ? _len22 - 1 : 0), _key22 = 1; _key22 < _len22; _key22++) {
                            patterns[_key22 - 1] = arguments[_key22];
                        }
                        var i = patterns.length - 1;
                        while (i > 0) {
                            if (!(patterns[i] instanceof Function)) {
                                patterns[i] = _.always(patterns[i]);
                            }
                            patterns[i] = lateBindFirst(patterns[i]);
                            i = i - 2;
                        }
                        return withDesc(new Bacon.Desc(Bacon, "update", [initial].concat(patterns)), Bacon.when.apply(Bacon, patterns).scan(initial, function(x, f) {
                            return f(x);
                        }));
                    };
                    Bacon.zipAsArray = function() {
                        for (var _len24 = arguments.length, args = Array(_len24), _key24 = 0; _key24 < _len24; _key24++) {
                            args[_key24] = arguments[_key24];
                        }
                        var streams = argumentsToObservables(args);
                        return withDesc(new Bacon.Desc(Bacon, "zipAsArray", streams), Bacon.zipWith(streams, function() {
                            for (var _len25 = arguments.length, xs = Array(_len25), _key25 = 0; _key25 < _len25; _key25++) {
                                xs[_key25] = arguments[_key25];
                            }
                            return xs;
                        }));
                    };
                    Bacon.zipWith = function() {
                        for (var _len26 = arguments.length, args = Array(_len26), _key26 = 0; _key26 < _len26; _key26++) {
                            args[_key26] = arguments[_key26];
                        }
                        var observablesAndFunction = argumentsToObservablesAndFunction(args);
                        var streams = observablesAndFunction[0];
                        var f = observablesAndFunction[1];
                        streams = _.map(function(s) {
                            return s.toEventStream();
                        }, streams);
                        return withDesc(new Bacon.Desc(Bacon, "zipWith", [f].concat(streams)), Bacon.when(streams, f));
                    };
                    Bacon.Observable.prototype.zip = function(other, f) {
                        return withDesc(new Bacon.Desc(this, "zip", [other]), Bacon.zipWith([this, other], f || Array));
                    };
                    if (typeof define !== "undefined" && define !== null && define.amd != null) {
                        define([], function() {
                            return Bacon;
                        });
                        if (typeof this !== "undefined" && this !== null) {
                            this.Bacon = Bacon;
                        }
                    } else if (typeof module !== "undefined" && module !== null && module.exports != null) {
                        module.exports = Bacon;
                        Bacon.Bacon = Bacon;
                    } else {
                        this.Bacon = Bacon;
                    }
                }).call(this);
            }).call(this, typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
        }, {}],
        33: [function(require, module, exports) {
            var saveAs = saveAs || (function(view) {
                "use strict";
                if (typeof navigator !== "undefined" && /MSIE [1-9]\./.test(navigator.userAgent)) {
                    return;
                }
                var
                    doc = view.document,
                    get_URL = function() {
                        return view.URL || view.webkitURL || view;
                    },
                    save_link = doc.createElementNS("http://www.w3.org/1999/xhtml", "a"),
                    can_use_save_link = "download" in save_link,
                    click = function(node) {
                        var event = new MouseEvent("click");
                        node.dispatchEvent(event);
                    },
                    is_safari = /Version\/[\d\.]+.*Safari/.test(navigator.userAgent),
                    webkit_req_fs = view.webkitRequestFileSystem,
                    req_fs = view.requestFileSystem || webkit_req_fs || view.mozRequestFileSystem,
                    throw_outside = function(ex) {
                        (view.setImmediate || view.setTimeout)(function() {
                            throw ex;
                        }, 0);
                    },
                    force_saveable_type = "application/octet-stream",
                    fs_min_size = 0,
                    arbitrary_revoke_timeout = 500,
                    revoke = function(file) {
                        var revoker = function() {
                            if (typeof file === "string") {
                                get_URL().revokeObjectURL(file);
                            } else {
                                file.remove();
                            }
                        };
                        if (view.chrome) {
                            revoker();
                        } else {
                            setTimeout(revoker, arbitrary_revoke_timeout);
                        }
                    },
                    dispatch = function(filesaver, event_types, event) {
                        event_types = [].concat(event_types);
                        var i = event_types.length;
                        while (i--) {
                            var listener = filesaver["on" + event_types[i]];
                            if (typeof listener === "function") {
                                try {
                                    listener.call(filesaver, event || filesaver);
                                } catch (ex) {
                                    throw_outside(ex);
                                }
                            }
                        }
                    },
                    auto_bom = function(blob) {
                        if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
                            return new Blob(["\ufeff", blob], {
                                type: blob.type
                            });
                        }
                        return blob;
                    },
                    FileSaver = function(blob, name, no_auto_bom) {
                        if (!no_auto_bom) {
                            blob = auto_bom(blob);
                        }
                        var
                            filesaver = this,
                            type = blob.type,
                            blob_changed = false,
                            object_url, target_view, dispatch_all = function() {
                                dispatch(filesaver, "writestart progress write writeend".split(" "));
                            },
                            fs_error = function() {
                                if (target_view && is_safari && typeof FileReader !== "undefined") {
                                    var reader = new FileReader();
                                    reader.onloadend = function() {
                                        var base64Data = reader.result;
                                        target_view.location.href = "data:attachment/file" + base64Data.slice(base64Data.search(/[,;]/));
                                        filesaver.readyState = filesaver.DONE;
                                        dispatch_all();
                                    };
                                    reader.readAsDataURL(blob);
                                    filesaver.readyState = filesaver.INIT;
                                    return;
                                }
                                if (blob_changed || !object_url) {
                                    object_url = get_URL().createObjectURL(blob);
                                }
                                if (target_view) {
                                    target_view.location.href = object_url;
                                } else {
                                    var new_tab = view.open(object_url, "_blank");
                                    if (new_tab == undefined && is_safari) {
                                        view.location.href = object_url
                                    }
                                }
                                filesaver.readyState = filesaver.DONE;
                                dispatch_all();
                                revoke(object_url);
                            },
                            abortable = function(func) {
                                return function() {
                                    if (filesaver.readyState !== filesaver.DONE) {
                                        return func.apply(this, arguments);
                                    }
                                };
                            },
                            create_if_not_found = {
                                create: true,
                                exclusive: false
                            },
                            slice;
                        filesaver.readyState = filesaver.INIT;
                        if (!name) {
                            name = "download";
                        }
                        if (can_use_save_link) {
                            object_url = get_URL().createObjectURL(blob);
                            save_link.href = object_url;
                            save_link.download = name;
                            setTimeout(function() {
                                click(save_link);
                                dispatch_all();
                                revoke(object_url);
                                filesaver.readyState = filesaver.DONE;
                            });
                            return;
                        }
                        if (view.chrome && type && type !== force_saveable_type) {
                            slice = blob.slice || blob.webkitSlice;
                            blob = slice.call(blob, 0, blob.size, force_saveable_type);
                            blob_changed = true;
                        }
                        if (webkit_req_fs && name !== "download") {
                            name += ".download";
                        }
                        if (type === force_saveable_type || webkit_req_fs) {
                            target_view = view;
                        }
                        if (!req_fs) {
                            fs_error();
                            return;
                        }
                        fs_min_size += blob.size;
                        req_fs(view.TEMPORARY, fs_min_size, abortable(function(fs) {
                            fs.root.getDirectory("saved", create_if_not_found, abortable(function(dir) {
                                var save = function() {
                                    dir.getFile(name, create_if_not_found, abortable(function(file) {
                                        file.createWriter(abortable(function(writer) {
                                            writer.onwriteend = function(event) {
                                                target_view.location.href = file.toURL();
                                                filesaver.readyState = filesaver.DONE;
                                                dispatch(filesaver, "writeend", event);
                                                revoke(file);
                                            };
                                            writer.onerror = function() {
                                                var error = writer.error;
                                                if (error.code !== error.ABORT_ERR) {
                                                    fs_error();
                                                }
                                            };
                                            "writestart progress write abort".split(" ").forEach(function(event) {
                                                writer["on" + event] = filesaver["on" + event];
                                            });
                                            writer.write(blob);
                                            filesaver.abort = function() {
                                                writer.abort();
                                                filesaver.readyState = filesaver.DONE;
                                            };
                                            filesaver.readyState = filesaver.WRITING;
                                        }), fs_error);
                                    }), fs_error);
                                };
                                dir.getFile(name, {
                                    create: false
                                }, abortable(function(file) {
                                    file.remove();
                                    save();
                                }), abortable(function(ex) {
                                    if (ex.code === ex.NOT_FOUND_ERR) {
                                        save();
                                    } else {
                                        fs_error();
                                    }
                                }));
                            }), fs_error);
                        }), fs_error);
                    },
                    FS_proto = FileSaver.prototype,
                    saveAs = function(blob, name, no_auto_bom) {
                        return new FileSaver(blob, name, no_auto_bom);
                    };
                if (typeof navigator !== "undefined" && navigator.msSaveOrOpenBlob) {
                    return function(blob, name, no_auto_bom) {
                        if (!no_auto_bom) {
                            blob = auto_bom(blob);
                        }
                        return navigator.msSaveOrOpenBlob(blob, name || "download");
                    };
                }
                FS_proto.abort = function() {
                    var filesaver = this;
                    filesaver.readyState = filesaver.DONE;
                    dispatch(filesaver, "abort");
                };
                FS_proto.readyState = FS_proto.INIT = 0;
                FS_proto.WRITING = 1;
                FS_proto.DONE = 2;
                FS_proto.error = FS_proto.onwritestart = FS_proto.onprogress = FS_proto.onwrite = FS_proto.onabort = FS_proto.onerror = FS_proto.onwriteend = null;
                return saveAs;
            }(typeof self !== "undefined" && self || typeof window !== "undefined" && window || this.content));
            if (typeof module !== "undefined" && module.exports) {
                module.exports.saveAs = saveAs;
            } else if ((typeof define !== "undefined" && define !== null) && (define.amd != null)) {
                define([], function() {
                    return saveAs;
                });
            }
        }, {}],
        34: [function(require, module, exports) {
            (function(window, document, undefined) {
                var _MAP = {
                    8: 'backspace',
                    9: 'tab',
                    13: 'enter',
                    16: 'shift',
                    17: 'ctrl',
                    18: 'alt',
                    20: 'capslock',
                    27: 'esc',
                    32: 'space',
                    33: 'pageup',
                    34: 'pagedown',
                    35: 'end',
                    36: 'home',
                    37: 'left',
                    38: 'up',
                    39: 'right',
                    40: 'down',
                    45: 'ins',
                    46: 'del',
                    91: 'meta',
                    93: 'meta',
                    224: 'meta'
                };
                var _KEYCODE_MAP = {
                    106: '*',
                    107: '+',
                    109: '-',
                    110: '.',
                    111: '/',
                    186: ';',
                    187: '=',
                    188: ',',
                    189: '-',
                    190: '.',
                    191: '/',
                    192: '`',
                    219: '[',
                    220: '\\',
                    221: ']',
                    222: '\''
                };
                var _SHIFT_MAP = {
                    '~': '`',
                    '!': '1',
                    '@': '2',
                    '#': '3',
                    '$': '4',
                    '%': '5',
                    '^': '6',
                    '&': '7',
                    '*': '8',
                    '(': '9',
                    ')': '0',
                    '_': '-',
                    '+': '=',
                    ':': ';',
                    '\"': '\'',
                    '<': ',',
                    '>': '.',
                    '?': '/',
                    '|': '\\'
                };
                var _SPECIAL_ALIASES = {
                    'option': 'alt',
                    'command': 'meta',
                    'return': 'enter',
                    'escape': 'esc',
                    'plus': '+',
                    'mod': /Mac|iPod|iPhone|iPad/.test(navigator.platform) ? 'meta' : 'ctrl'
                };
                var _REVERSE_MAP;
                for (var i = 1; i < 20; ++i) {
                    _MAP[111 + i] = 'f' + i;
                }
                for (i = 0; i <= 9; ++i) {
                    _MAP[i + 96] = i;
                }

                function _addEvent(object, type, callback) {
                    if (object.addEventListener) {
                        object.addEventListener(type, callback, false);
                        return;
                    }
                    object.attachEvent('on' + type, callback);
                }

                function _characterFromEvent(e) {
                    if (e.type == 'keypress') {
                        var character = String.fromCharCode(e.which);
                        if (!e.shiftKey) {
                            character = character.toLowerCase();
                        }
                        return character;
                    }
                    if (_MAP[e.which]) {
                        return _MAP[e.which];
                    }
                    if (_KEYCODE_MAP[e.which]) {
                        return _KEYCODE_MAP[e.which];
                    }
                    return String.fromCharCode(e.which).toLowerCase();
                }

                function _modifiersMatch(modifiers1, modifiers2) {
                    return modifiers1.sort().join(',') === modifiers2.sort().join(',');
                }

                function _eventModifiers(e) {
                    var modifiers = [];
                    if (e.shiftKey) {
                        modifiers.push('shift');
                    }
                    if (e.altKey) {
                        modifiers.push('alt');
                    }
                    if (e.ctrlKey) {
                        modifiers.push('ctrl');
                    }
                    if (e.metaKey) {
                        modifiers.push('meta');
                    }
                    return modifiers;
                }

                function _preventDefault(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                        return;
                    }
                    e.returnValue = false;
                }

                function _stopPropagation(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                        return;
                    }
                    e.cancelBubble = true;
                }

                function _isModifier(key) {
                    return key == 'shift' || key == 'ctrl' || key == 'alt' || key == 'meta';
                }

                function _getReverseMap() {
                    if (!_REVERSE_MAP) {
                        _REVERSE_MAP = {};
                        for (var key in _MAP) {
                            if (key > 95 && key < 112) {
                                continue;
                            }
                            if (_MAP.hasOwnProperty(key)) {
                                _REVERSE_MAP[_MAP[key]] = key;
                            }
                        }
                    }
                    return _REVERSE_MAP;
                }

                function _pickBestAction(key, modifiers, action) {
                    if (!action) {
                        action = _getReverseMap()[key] ? 'keydown' : 'keypress';
                    }
                    if (action == 'keypress' && modifiers.length) {
                        action = 'keydown';
                    }
                    return action;
                }

                function _keysFromString(combination) {
                    if (combination === '+') {
                        return ['+'];
                    }
                    combination = combination.replace(/\+{2}/g, '+plus');
                    return combination.split('+');
                }

                function _getKeyInfo(combination, action) {
                    var keys;
                    var key;
                    var i;
                    var modifiers = [];
                    keys = _keysFromString(combination);
                    for (i = 0; i < keys.length; ++i) {
                        key = keys[i];
                        if (_SPECIAL_ALIASES[key]) {
                            key = _SPECIAL_ALIASES[key];
                        }
                        if (action && action != 'keypress' && _SHIFT_MAP[key]) {
                            key = _SHIFT_MAP[key];
                            modifiers.push('shift');
                        }
                        if (_isModifier(key)) {
                            modifiers.push(key);
                        }
                    }
                    action = _pickBestAction(key, modifiers, action);
                    return {
                        key: key,
                        modifiers: modifiers,
                        action: action
                    };
                }

                function _belongsTo(element, ancestor) {
                    if (element === null || element === document) {
                        return false;
                    }
                    if (element === ancestor) {
                        return true;
                    }
                    return _belongsTo(element.parentNode, ancestor);
                }

                function Mousetrap(targetElement) {
                    var self = this;
                    targetElement = targetElement || document;
                    if (!(self instanceof Mousetrap)) {
                        return new Mousetrap(targetElement);
                    }
                    self.target = targetElement;
                    self._callbacks = {};
                    self._directMap = {};
                    var _sequenceLevels = {};
                    var _resetTimer;
                    var _ignoreNextKeyup = false;
                    var _ignoreNextKeypress = false;
                    var _nextExpectedAction = false;

                    function _resetSequences(doNotReset) {
                        doNotReset = doNotReset || {};
                        var activeSequences = false,
                            key;
                        for (key in _sequenceLevels) {
                            if (doNotReset[key]) {
                                activeSequences = true;
                                continue;
                            }
                            _sequenceLevels[key] = 0;
                        }
                        if (!activeSequences) {
                            _nextExpectedAction = false;
                        }
                    }

                    function _getMatches(character, modifiers, e, sequenceName, combination, level) {
                        var i;
                        var callback;
                        var matches = [];
                        var action = e.type;
                        if (!self._callbacks[character]) {
                            return [];
                        }
                        if (action == 'keyup' && _isModifier(character)) {
                            modifiers = [character];
                        }
                        for (i = 0; i < self._callbacks[character].length; ++i) {
                            callback = self._callbacks[character][i];
                            if (!sequenceName && callback.seq && _sequenceLevels[callback.seq] != callback.level) {
                                continue;
                            }
                            if (action != callback.action) {
                                continue;
                            }
                            if ((action == 'keypress' && !e.metaKey && !e.ctrlKey) || _modifiersMatch(modifiers, callback.modifiers)) {
                                var deleteCombo = !sequenceName && callback.combo == combination;
                                var deleteSequence = sequenceName && callback.seq == sequenceName && callback.level == level;
                                if (deleteCombo || deleteSequence) {
                                    self._callbacks[character].splice(i, 1);
                                }
                                matches.push(callback);
                            }
                        }
                        return matches;
                    }

                    function _fireCallback(callback, e, combo, sequence) {
                        if (self.stopCallback(e, e.target || e.srcElement, combo, sequence)) {
                            return;
                        }
                        if (callback(e, combo) === false) {
                            _preventDefault(e);
                            _stopPropagation(e);
                        }
                    }
                    self._handleKey = function(character, modifiers, e) {
                        var callbacks = _getMatches(character, modifiers, e);
                        var i;
                        var doNotReset = {};
                        var maxLevel = 0;
                        var processedSequenceCallback = false;
                        for (i = 0; i < callbacks.length; ++i) {
                            if (callbacks[i].seq) {
                                maxLevel = Math.max(maxLevel, callbacks[i].level);
                            }
                        }
                        for (i = 0; i < callbacks.length; ++i) {
                            if (callbacks[i].seq) {
                                if (callbacks[i].level != maxLevel) {
                                    continue;
                                }
                                processedSequenceCallback = true;
                                doNotReset[callbacks[i].seq] = 1;
                                _fireCallback(callbacks[i].callback, e, callbacks[i].combo, callbacks[i].seq);
                                continue;
                            }
                            if (!processedSequenceCallback) {
                                _fireCallback(callbacks[i].callback, e, callbacks[i].combo);
                            }
                        }
                        var ignoreThisKeypress = e.type == 'keypress' && _ignoreNextKeypress;
                        if (e.type == _nextExpectedAction && !_isModifier(character) && !ignoreThisKeypress) {
                            _resetSequences(doNotReset);
                        }
                        _ignoreNextKeypress = processedSequenceCallback && e.type == 'keydown';
                    };

                    function _handleKeyEvent(e) {
                        if (typeof e.which !== 'number') {
                            e.which = e.keyCode;
                        }
                        var character = _characterFromEvent(e);
                        if (!character) {
                            return;
                        }
                        if (e.type == 'keyup' && _ignoreNextKeyup === character) {
                            _ignoreNextKeyup = false;
                            return;
                        }
                        self.handleKey(character, _eventModifiers(e), e);
                    }

                    function _resetSequenceTimer() {
                        clearTimeout(_resetTimer);
                        _resetTimer = setTimeout(_resetSequences, 1000);
                    }

                    function _bindSequence(combo, keys, callback, action) {
                        _sequenceLevels[combo] = 0;

                        function _increaseSequence(nextAction) {
                            return function() {
                                _nextExpectedAction = nextAction;
                                ++_sequenceLevels[combo];
                                _resetSequenceTimer();
                            };
                        }

                        function _callbackAndReset(e) {
                            _fireCallback(callback, e, combo);
                            if (action !== 'keyup') {
                                _ignoreNextKeyup = _characterFromEvent(e);
                            }
                            setTimeout(_resetSequences, 10);
                        }
                        for (var i = 0; i < keys.length; ++i) {
                            var isFinal = i + 1 === keys.length;
                            var wrappedCallback = isFinal ? _callbackAndReset : _increaseSequence(action || _getKeyInfo(keys[i + 1]).action);
                            _bindSingle(keys[i], wrappedCallback, action, combo, i);
                        }
                    }

                    function _bindSingle(combination, callback, action, sequenceName, level) {
                        self._directMap[combination + ':' + action] = callback;
                        combination = combination.replace(/\s+/g, ' ');
                        var sequence = combination.split(' ');
                        var info;
                        if (sequence.length > 1) {
                            _bindSequence(combination, sequence, callback, action);
                            return;
                        }
                        info = _getKeyInfo(combination, action);
                        self._callbacks[info.key] = self._callbacks[info.key] || [];
                        _getMatches(info.key, info.modifiers, {
                            type: info.action
                        }, sequenceName, combination, level);
                        self._callbacks[info.key][sequenceName ? 'unshift' : 'push']({
                            callback: callback,
                            modifiers: info.modifiers,
                            action: info.action,
                            seq: sequenceName,
                            level: level,
                            combo: combination
                        });
                    }
                    self._bindMultiple = function(combinations, callback, action) {
                        for (var i = 0; i < combinations.length; ++i) {
                            _bindSingle(combinations[i], callback, action);
                        }
                    };
                    _addEvent(targetElement, 'keypress', _handleKeyEvent);
                    _addEvent(targetElement, 'keydown', _handleKeyEvent);
                    _addEvent(targetElement, 'keyup', _handleKeyEvent);
                }
                Mousetrap.prototype.bind = function(keys, callback, action) {
                    var self = this;
                    keys = keys instanceof Array ? keys : [keys];
                    self._bindMultiple.call(self, keys, callback, action);
                    return self;
                };
                Mousetrap.prototype.unbind = function(keys, action) {
                    var self = this;
                    return self.bind.call(self, keys, function() {}, action);
                };
                Mousetrap.prototype.trigger = function(keys, action) {
                    var self = this;
                    if (self._directMap[keys + ':' + action]) {
                        self._directMap[keys + ':' + action]({}, keys);
                    }
                    return self;
                };
                Mousetrap.prototype.reset = function() {
                    var self = this;
                    self._callbacks = {};
                    self._directMap = {};
                    return self;
                };
                Mousetrap.prototype.stopCallback = function(e, element) {
                    var self = this;
                    if ((' ' + element.className + ' ').indexOf(' mousetrap ') > -1) {
                        return false;
                    }
                    if (_belongsTo(element, self.target)) {
                        return false;
                    }
                    return element.tagName == 'INPUT' || element.tagName == 'SELECT' || element.tagName == 'TEXTAREA' || element.isContentEditable;
                };
                Mousetrap.prototype.handleKey = function() {
                    var self = this;
                    return self._handleKey.apply(self, arguments);
                };
                Mousetrap.init = function() {
                    var documentMousetrap = Mousetrap(document);
                    for (var method in documentMousetrap) {
                        if (method.charAt(0) !== '_') {
                            Mousetrap[method] = (function(method) {
                                return function() {
                                    return documentMousetrap[method].apply(documentMousetrap, arguments);
                                };
                            }(method));
                        }
                    }
                };
                Mousetrap.init();
                window.Mousetrap = Mousetrap;
                if (typeof module !== 'undefined' && module.exports) {
                    module.exports = Mousetrap;
                }
                if (typeof define === 'function' && define.amd) {
                    define(function() {
                        return Mousetrap;
                    });
                }
            })(window, document);
        }, {}],
        35: [function(require, module, exports) {
            (function() {
                var root = this;
                var previousUnderscore = root._;
                var ArrayProto = Array.prototype,
                    ObjProto = Object.prototype,
                    FuncProto = Function.prototype;
                var
                    push = ArrayProto.push,
                    slice = ArrayProto.slice,
                    toString = ObjProto.toString,
                    hasOwnProperty = ObjProto.hasOwnProperty;
                var
                    nativeIsArray = Array.isArray,
                    nativeKeys = Object.keys,
                    nativeBind = FuncProto.bind,
                    nativeCreate = Object.create;
                var Ctor = function() {};
                var _ = function(obj) {
                    if (obj instanceof _) return obj;
                    if (!(this instanceof _)) return new _(obj);
                    this._wrapped = obj;
                };
                if (typeof exports !== 'undefined') {
                    if (typeof module !== 'undefined' && module.exports) {
                        exports = module.exports = _;
                    }
                    exports._ = _;
                } else {
                    root._ = _;
                }
                _.VERSION = '1.8.3';
                var optimizeCb = function(func, context, argCount) {
                    if (context === void 0) return func;
                    switch (argCount == null ? 3 : argCount) {
                        case 1:
                            return function(value) {
                                return func.call(context, value);
                            };
                        case 2:
                            return function(value, other) {
                                return func.call(context, value, other);
                            };
                        case 3:
                            return function(value, index, collection) {
                                return func.call(context, value, index, collection);
                            };
                        case 4:
                            return function(accumulator, value, index, collection) {
                                return func.call(context, accumulator, value, index, collection);
                            };
                    }
                    return function() {
                        return func.apply(context, arguments);
                    };
                };
                var cb = function(value, context, argCount) {
                    if (value == null) return _.identity;
                    if (_.isFunction(value)) return optimizeCb(value, context, argCount);
                    if (_.isObject(value)) return _.matcher(value);
                    return _.property(value);
                };
                _.iteratee = function(value, context) {
                    return cb(value, context, Infinity);
                };
                var createAssigner = function(keysFunc, undefinedOnly) {
                    return function(obj) {
                        var length = arguments.length;
                        if (length < 2 || obj == null) return obj;
                        for (var index = 1; index < length; index++) {
                            var source = arguments[index],
                                keys = keysFunc(source),
                                l = keys.length;
                            for (var i = 0; i < l; i++) {
                                var key = keys[i];
                                if (!undefinedOnly || obj[key] === void 0) obj[key] = source[key];
                            }
                        }
                        return obj;
                    };
                };
                var baseCreate = function(prototype) {
                    if (!_.isObject(prototype)) return {};
                    if (nativeCreate) return nativeCreate(prototype);
                    Ctor.prototype = prototype;
                    var result = new Ctor;
                    Ctor.prototype = null;
                    return result;
                };
                var property = function(key) {
                    return function(obj) {
                        return obj == null ? void 0 : obj[key];
                    };
                };
                var MAX_ARRAY_INDEX = Math.pow(2, 53) - 1;
                var getLength = property('length');
                var isArrayLike = function(collection) {
                    var length = getLength(collection);
                    return typeof length == 'number' && length >= 0 && length <= MAX_ARRAY_INDEX;
                };
                _.each = _.forEach = function(obj, iteratee, context) {
                    iteratee = optimizeCb(iteratee, context);
                    var i, length;
                    if (isArrayLike(obj)) {
                        for (i = 0, length = obj.length; i < length; i++) {
                            iteratee(obj[i], i, obj);
                        }
                    } else {
                        var keys = _.keys(obj);
                        for (i = 0, length = keys.length; i < length; i++) {
                            iteratee(obj[keys[i]], keys[i], obj);
                        }
                    }
                    return obj;
                };
                _.map = _.collect = function(obj, iteratee, context) {
                    iteratee = cb(iteratee, context);
                    var keys = !isArrayLike(obj) && _.keys(obj),
                        length = (keys || obj).length,
                        results = Array(length);
                    for (var index = 0; index < length; index++) {
                        var currentKey = keys ? keys[index] : index;
                        results[index] = iteratee(obj[currentKey], currentKey, obj);
                    }
                    return results;
                };

                function createReduce(dir) {
                    function iterator(obj, iteratee, memo, keys, index, length) {
                        for (; index >= 0 && index < length; index += dir) {
                            var currentKey = keys ? keys[index] : index;
                            memo = iteratee(memo, obj[currentKey], currentKey, obj);
                        }
                        return memo;
                    }
                    return function(obj, iteratee, memo, context) {
                        iteratee = optimizeCb(iteratee, context, 4);
                        var keys = !isArrayLike(obj) && _.keys(obj),
                            length = (keys || obj).length,
                            index = dir > 0 ? 0 : length - 1;
                        if (arguments.length < 3) {
                            memo = obj[keys ? keys[index] : index];
                            index += dir;
                        }
                        return iterator(obj, iteratee, memo, keys, index, length);
                    };
                }
                _.reduce = _.foldl = _.inject = createReduce(1);
                _.reduceRight = _.foldr = createReduce(-1);
                _.find = _.detect = function(obj, predicate, context) {
                    var key;
                    if (isArrayLike(obj)) {
                        key = _.findIndex(obj, predicate, context);
                    } else {
                        key = _.findKey(obj, predicate, context);
                    }
                    if (key !== void 0 && key !== -1) return obj[key];
                };
                _.filter = _.select = function(obj, predicate, context) {
                    var results = [];
                    predicate = cb(predicate, context);
                    _.each(obj, function(value, index, list) {
                        if (predicate(value, index, list)) results.push(value);
                    });
                    return results;
                };
                _.reject = function(obj, predicate, context) {
                    return _.filter(obj, _.negate(cb(predicate)), context);
                };
                _.every = _.all = function(obj, predicate, context) {
                    predicate = cb(predicate, context);
                    var keys = !isArrayLike(obj) && _.keys(obj),
                        length = (keys || obj).length;
                    for (var index = 0; index < length; index++) {
                        var currentKey = keys ? keys[index] : index;
                        if (!predicate(obj[currentKey], currentKey, obj)) return false;
                    }
                    return true;
                };
                _.some = _.any = function(obj, predicate, context) {
                    predicate = cb(predicate, context);
                    var keys = !isArrayLike(obj) && _.keys(obj),
                        length = (keys || obj).length;
                    for (var index = 0; index < length; index++) {
                        var currentKey = keys ? keys[index] : index;
                        if (predicate(obj[currentKey], currentKey, obj)) return true;
                    }
                    return false;
                };
                _.contains = _.includes = _.include = function(obj, item, fromIndex, guard) {
                    if (!isArrayLike(obj)) obj = _.values(obj);
                    if (typeof fromIndex != 'number' || guard) fromIndex = 0;
                    return _.indexOf(obj, item, fromIndex) >= 0;
                };
                _.invoke = function(obj, method) {
                    var args = slice.call(arguments, 2);
                    var isFunc = _.isFunction(method);
                    return _.map(obj, function(value) {
                        var func = isFunc ? method : value[method];
                        return func == null ? func : func.apply(value, args);
                    });
                };
                _.pluck = function(obj, key) {
                    return _.map(obj, _.property(key));
                };
                _.where = function(obj, attrs) {
                    return _.filter(obj, _.matcher(attrs));
                };
                _.findWhere = function(obj, attrs) {
                    return _.find(obj, _.matcher(attrs));
                };
                _.max = function(obj, iteratee, context) {
                    var result = -Infinity,
                        lastComputed = -Infinity,
                        value, computed;
                    if (iteratee == null && obj != null) {
                        obj = isArrayLike(obj) ? obj : _.values(obj);
                        for (var i = 0, length = obj.length; i < length; i++) {
                            value = obj[i];
                            if (value > result) {
                                result = value;
                            }
                        }
                    } else {
                        iteratee = cb(iteratee, context);
                        _.each(obj, function(value, index, list) {
                            computed = iteratee(value, index, list);
                            if (computed > lastComputed || computed === -Infinity && result === -Infinity) {
                                result = value;
                                lastComputed = computed;
                            }
                        });
                    }
                    return result;
                };
                _.min = function(obj, iteratee, context) {
                    var result = Infinity,
                        lastComputed = Infinity,
                        value, computed;
                    if (iteratee == null && obj != null) {
                        obj = isArrayLike(obj) ? obj : _.values(obj);
                        for (var i = 0, length = obj.length; i < length; i++) {
                            value = obj[i];
                            if (value < result) {
                                result = value;
                            }
                        }
                    } else {
                        iteratee = cb(iteratee, context);
                        _.each(obj, function(value, index, list) {
                            computed = iteratee(value, index, list);
                            if (computed < lastComputed || computed === Infinity && result === Infinity) {
                                result = value;
                                lastComputed = computed;
                            }
                        });
                    }
                    return result;
                };
                _.shuffle = function(obj) {
                    var set = isArrayLike(obj) ? obj : _.values(obj);
                    var length = set.length;
                    var shuffled = Array(length);
                    for (var index = 0, rand; index < length; index++) {
                        rand = _.random(0, index);
                        if (rand !== index) shuffled[index] = shuffled[rand];
                        shuffled[rand] = set[index];
                    }
                    return shuffled;
                };
                _.sample = function(obj, n, guard) {
                    if (n == null || guard) {
                        if (!isArrayLike(obj)) obj = _.values(obj);
                        return obj[_.random(obj.length - 1)];
                    }
                    return _.shuffle(obj).slice(0, Math.max(0, n));
                };
                _.sortBy = function(obj, iteratee, context) {
                    iteratee = cb(iteratee, context);
                    return _.pluck(_.map(obj, function(value, index, list) {
                        return {
                            value: value,
                            index: index,
                            criteria: iteratee(value, index, list)
                        };
                    }).sort(function(left, right) {
                        var a = left.criteria;
                        var b = right.criteria;
                        if (a !== b) {
                            if (a > b || a === void 0) return 1;
                            if (a < b || b === void 0) return -1;
                        }
                        return left.index - right.index;
                    }), 'value');
                };
                var group = function(behavior) {
                    return function(obj, iteratee, context) {
                        var result = {};
                        iteratee = cb(iteratee, context);
                        _.each(obj, function(value, index) {
                            var key = iteratee(value, index, obj);
                            behavior(result, value, key);
                        });
                        return result;
                    };
                };
                _.groupBy = group(function(result, value, key) {
                    if (_.has(result, key)) result[key].push(value);
                    else result[key] = [value];
                });
                _.indexBy = group(function(result, value, key) {
                    result[key] = value;
                });
                _.countBy = group(function(result, value, key) {
                    if (_.has(result, key)) result[key]++;
                    else result[key] = 1;
                });
                _.toArray = function(obj) {
                    if (!obj) return [];
                    if (_.isArray(obj)) return slice.call(obj);
                    if (isArrayLike(obj)) return _.map(obj, _.identity);
                    return _.values(obj);
                };
                _.size = function(obj) {
                    if (obj == null) return 0;
                    return isArrayLike(obj) ? obj.length : _.keys(obj).length;
                };
                _.partition = function(obj, predicate, context) {
                    predicate = cb(predicate, context);
                    var pass = [],
                        fail = [];
                    _.each(obj, function(value, key, obj) {
                        (predicate(value, key, obj) ? pass : fail).push(value);
                    });
                    return [pass, fail];
                };
                _.first = _.head = _.take = function(array, n, guard) {
                    if (array == null) return void 0;
                    if (n == null || guard) return array[0];
                    return _.initial(array, array.length - n);
                };
                _.initial = function(array, n, guard) {
                    return slice.call(array, 0, Math.max(0, array.length - (n == null || guard ? 1 : n)));
                };
                _.last = function(array, n, guard) {
                    if (array == null) return void 0;
                    if (n == null || guard) return array[array.length - 1];
                    return _.rest(array, Math.max(0, array.length - n));
                };
                _.rest = _.tail = _.drop = function(array, n, guard) {
                    return slice.call(array, n == null || guard ? 1 : n);
                };
                _.compact = function(array) {
                    return _.filter(array, _.identity);
                };
                var flatten = function(input, shallow, strict, startIndex) {
                    var output = [],
                        idx = 0;
                    for (var i = startIndex || 0, length = getLength(input); i < length; i++) {
                        var value = input[i];
                        if (isArrayLike(value) && (_.isArray(value) || _.isArguments(value))) {
                            if (!shallow) value = flatten(value, shallow, strict);
                            var j = 0,
                                len = value.length;
                            output.length += len;
                            while (j < len) {
                                output[idx++] = value[j++];
                            }
                        } else if (!strict) {
                            output[idx++] = value;
                        }
                    }
                    return output;
                };
                _.flatten = function(array, shallow) {
                    return flatten(array, shallow, false);
                };
                _.without = function(array) {
                    return _.difference(array, slice.call(arguments, 1));
                };
                _.uniq = _.unique = function(array, isSorted, iteratee, context) {
                    if (!_.isBoolean(isSorted)) {
                        context = iteratee;
                        iteratee = isSorted;
                        isSorted = false;
                    }
                    if (iteratee != null) iteratee = cb(iteratee, context);
                    var result = [];
                    var seen = [];
                    for (var i = 0, length = getLength(array); i < length; i++) {
                        var value = array[i],
                            computed = iteratee ? iteratee(value, i, array) : value;
                        if (isSorted) {
                            if (!i || seen !== computed) result.push(value);
                            seen = computed;
                        } else if (iteratee) {
                            if (!_.contains(seen, computed)) {
                                seen.push(computed);
                                result.push(value);
                            }
                        } else if (!_.contains(result, value)) {
                            result.push(value);
                        }
                    }
                    return result;
                };
                _.union = function() {
                    return _.uniq(flatten(arguments, true, true));
                };
                _.intersection = function(array) {
                    var result = [];
                    var argsLength = arguments.length;
                    for (var i = 0, length = getLength(array); i < length; i++) {
                        var item = array[i];
                        if (_.contains(result, item)) continue;
                        for (var j = 1; j < argsLength; j++) {
                            if (!_.contains(arguments[j], item)) break;
                        }
                        if (j === argsLength) result.push(item);
                    }
                    return result;
                };
                _.difference = function(array) {
                    var rest = flatten(arguments, true, true, 1);
                    return _.filter(array, function(value) {
                        return !_.contains(rest, value);
                    });
                };
                _.zip = function() {
                    return _.unzip(arguments);
                };
                _.unzip = function(array) {
                    var length = array && _.max(array, getLength).length || 0;
                    var result = Array(length);
                    for (var index = 0; index < length; index++) {
                        result[index] = _.pluck(array, index);
                    }
                    return result;
                };
                _.object = function(list, values) {
                    var result = {};
                    for (var i = 0, length = getLength(list); i < length; i++) {
                        if (values) {
                            result[list[i]] = values[i];
                        } else {
                            result[list[i][0]] = list[i][1];
                        }
                    }
                    return result;
                };

                function createPredicateIndexFinder(dir) {
                    return function(array, predicate, context) {
                        predicate = cb(predicate, context);
                        var length = getLength(array);
                        var index = dir > 0 ? 0 : length - 1;
                        for (; index >= 0 && index < length; index += dir) {
                            if (predicate(array[index], index, array)) return index;
                        }
                        return -1;
                    };
                }
                _.findIndex = createPredicateIndexFinder(1);
                _.findLastIndex = createPredicateIndexFinder(-1);
                _.sortedIndex = function(array, obj, iteratee, context) {
                    iteratee = cb(iteratee, context, 1);
                    var value = iteratee(obj);
                    var low = 0,
                        high = getLength(array);
                    while (low < high) {
                        var mid = Math.floor((low + high) / 2);
                        if (iteratee(array[mid]) < value) low = mid + 1;
                        else high = mid;
                    }
                    return low;
                };

                function createIndexFinder(dir, predicateFind, sortedIndex) {
                    return function(array, item, idx) {
                        var i = 0,
                            length = getLength(array);
                        if (typeof idx == 'number') {
                            if (dir > 0) {
                                i = idx >= 0 ? idx : Math.max(idx + length, i);
                            } else {
                                length = idx >= 0 ? Math.min(idx + 1, length) : idx + length + 1;
                            }
                        } else if (sortedIndex && idx && length) {
                            idx = sortedIndex(array, item);
                            return array[idx] === item ? idx : -1;
                        }
                        if (item !== item) {
                            idx = predicateFind(slice.call(array, i, length), _.isNaN);
                            return idx >= 0 ? idx + i : -1;
                        }
                        for (idx = dir > 0 ? i : length - 1; idx >= 0 && idx < length; idx += dir) {
                            if (array[idx] === item) return idx;
                        }
                        return -1;
                    };
                }
                _.indexOf = createIndexFinder(1, _.findIndex, _.sortedIndex);
                _.lastIndexOf = createIndexFinder(-1, _.findLastIndex);
                _.range = function(start, stop, step) {
                    if (stop == null) {
                        stop = start || 0;
                        start = 0;
                    }
                    step = step || 1;
                    var length = Math.max(Math.ceil((stop - start) / step), 0);
                    var range = Array(length);
                    for (var idx = 0; idx < length; idx++, start += step) {
                        range[idx] = start;
                    }
                    return range;
                };
                var executeBound = function(sourceFunc, boundFunc, context, callingContext, args) {
                    if (!(callingContext instanceof boundFunc)) return sourceFunc.apply(context, args);
                    var self = baseCreate(sourceFunc.prototype);
                    var result = sourceFunc.apply(self, args);
                    if (_.isObject(result)) return result;
                    return self;
                };
                _.bind = function(func, context) {
                    if (nativeBind && func.bind === nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
                    if (!_.isFunction(func)) throw new TypeError('Bind must be called on a function');
                    var args = slice.call(arguments, 2);
                    var bound = function() {
                        return executeBound(func, bound, context, this, args.concat(slice.call(arguments)));
                    };
                    return bound;
                };
                _.partial = function(func) {
                    var boundArgs = slice.call(arguments, 1);
                    var bound = function() {
                        var position = 0,
                            length = boundArgs.length;
                        var args = Array(length);
                        for (var i = 0; i < length; i++) {
                            args[i] = boundArgs[i] === _ ? arguments[position++] : boundArgs[i];
                        }
                        while (position < arguments.length) args.push(arguments[position++]);
                        return executeBound(func, bound, this, this, args);
                    };
                    return bound;
                };
                _.bindAll = function(obj) {
                    var i, length = arguments.length,
                        key;
                    if (length <= 1) throw new Error('bindAll must be passed function names');
                    for (i = 1; i < length; i++) {
                        key = arguments[i];
                        obj[key] = _.bind(obj[key], obj);
                    }
                    return obj;
                };
                _.memoize = function(func, hasher) {
                    var memoize = function(key) {
                        var cache = memoize.cache;
                        var address = '' + (hasher ? hasher.apply(this, arguments) : key);
                        if (!_.has(cache, address)) cache[address] = func.apply(this, arguments);
                        return cache[address];
                    };
                    memoize.cache = {};
                    return memoize;
                };
                _.delay = function(func, wait) {
                    var args = slice.call(arguments, 2);
                    return setTimeout(function() {
                        return func.apply(null, args);
                    }, wait);
                };
                _.defer = _.partial(_.delay, _, 1);
                _.throttle = function(func, wait, options) {
                    var context, args, result;
                    var timeout = null;
                    var previous = 0;
                    if (!options) options = {};
                    var later = function() {
                        previous = options.leading === false ? 0 : _.now();
                        timeout = null;
                        result = func.apply(context, args);
                        if (!timeout) context = args = null;
                    };
                    return function() {
                        var now = _.now();
                        if (!previous && options.leading === false) previous = now;
                        var remaining = wait - (now - previous);
                        context = this;
                        args = arguments;
                        if (remaining <= 0 || remaining > wait) {
                            if (timeout) {
                                clearTimeout(timeout);
                                timeout = null;
                            }
                            previous = now;
                            result = func.apply(context, args);
                            if (!timeout) context = args = null;
                        } else if (!timeout && options.trailing !== false) {
                            timeout = setTimeout(later, remaining);
                        }
                        return result;
                    };
                };
                _.debounce = function(func, wait, immediate) {
                    var timeout, args, context, timestamp, result;
                    var later = function() {
                        var last = _.now() - timestamp;
                        if (last < wait && last >= 0) {
                            timeout = setTimeout(later, wait - last);
                        } else {
                            timeout = null;
                            if (!immediate) {
                                result = func.apply(context, args);
                                if (!timeout) context = args = null;
                            }
                        }
                    };
                    return function() {
                        context = this;
                        args = arguments;
                        timestamp = _.now();
                        var callNow = immediate && !timeout;
                        if (!timeout) timeout = setTimeout(later, wait);
                        if (callNow) {
                            result = func.apply(context, args);
                            context = args = null;
                        }
                        return result;
                    };
                };
                _.wrap = function(func, wrapper) {
                    return _.partial(wrapper, func);
                };
                _.negate = function(predicate) {
                    return function() {
                        return !predicate.apply(this, arguments);
                    };
                };
                _.compose = function() {
                    var args = arguments;
                    var start = args.length - 1;
                    return function() {
                        var i = start;
                        var result = args[start].apply(this, arguments);
                        while (i--) result = args[i].call(this, result);
                        return result;
                    };
                };
                _.after = function(times, func) {
                    return function() {
                        if (--times < 1) {
                            return func.apply(this, arguments);
                        }
                    };
                };
                _.before = function(times, func) {
                    var memo;
                    return function() {
                        if (--times > 0) {
                            memo = func.apply(this, arguments);
                        }
                        if (times <= 1) func = null;
                        return memo;
                    };
                };
                _.once = _.partial(_.before, 2);
                var hasEnumBug = !{
                    toString: null
                }.propertyIsEnumerable('toString');
                var nonEnumerableProps = ['valueOf', 'isPrototypeOf', 'toString', 'propertyIsEnumerable', 'hasOwnProperty', 'toLocaleString'];

                function collectNonEnumProps(obj, keys) {
                    var nonEnumIdx = nonEnumerableProps.length;
                    var constructor = obj.constructor;
                    var proto = (_.isFunction(constructor) && constructor.prototype) || ObjProto;
                    var prop = 'constructor';
                    if (_.has(obj, prop) && !_.contains(keys, prop)) keys.push(prop);
                    while (nonEnumIdx--) {
                        prop = nonEnumerableProps[nonEnumIdx];
                        if (prop in obj && obj[prop] !== proto[prop] && !_.contains(keys, prop)) {
                            keys.push(prop);
                        }
                    }
                }
                _.keys = function(obj) {
                    if (!_.isObject(obj)) return [];
                    if (nativeKeys) return nativeKeys(obj);
                    var keys = [];
                    for (var key in obj)
                        if (_.has(obj, key)) keys.push(key);
                    if (hasEnumBug) collectNonEnumProps(obj, keys);
                    return keys;
                };
                _.allKeys = function(obj) {
                    if (!_.isObject(obj)) return [];
                    var keys = [];
                    for (var key in obj) keys.push(key);
                    if (hasEnumBug) collectNonEnumProps(obj, keys);
                    return keys;
                };
                _.values = function(obj) {
                    var keys = _.keys(obj);
                    var length = keys.length;
                    var values = Array(length);
                    for (var i = 0; i < length; i++) {
                        values[i] = obj[keys[i]];
                    }
                    return values;
                };
                _.mapObject = function(obj, iteratee, context) {
                    iteratee = cb(iteratee, context);
                    var keys = _.keys(obj),
                        length = keys.length,
                        results = {},
                        currentKey;
                    for (var index = 0; index < length; index++) {
                        currentKey = keys[index];
                        results[currentKey] = iteratee(obj[currentKey], currentKey, obj);
                    }
                    return results;
                };
                _.pairs = function(obj) {
                    var keys = _.keys(obj);
                    var length = keys.length;
                    var pairs = Array(length);
                    for (var i = 0; i < length; i++) {
                        pairs[i] = [keys[i], obj[keys[i]]];
                    }
                    return pairs;
                };
                _.invert = function(obj) {
                    var result = {};
                    var keys = _.keys(obj);
                    for (var i = 0, length = keys.length; i < length; i++) {
                        result[obj[keys[i]]] = keys[i];
                    }
                    return result;
                };
                _.functions = _.methods = function(obj) {
                    var names = [];
                    for (var key in obj) {
                        if (_.isFunction(obj[key])) names.push(key);
                    }
                    return names.sort();
                };
                _.extend = createAssigner(_.allKeys);
                _.extendOwn = _.assign = createAssigner(_.keys);
                _.findKey = function(obj, predicate, context) {
                    predicate = cb(predicate, context);
                    var keys = _.keys(obj),
                        key;
                    for (var i = 0, length = keys.length; i < length; i++) {
                        key = keys[i];
                        if (predicate(obj[key], key, obj)) return key;
                    }
                };
                _.pick = function(object, oiteratee, context) {
                    var result = {},
                        obj = object,
                        iteratee, keys;
                    if (obj == null) return result;
                    if (_.isFunction(oiteratee)) {
                        keys = _.allKeys(obj);
                        iteratee = optimizeCb(oiteratee, context);
                    } else {
                        keys = flatten(arguments, false, false, 1);
                        iteratee = function(value, key, obj) {
                            return key in obj;
                        };
                        obj = Object(obj);
                    }
                    for (var i = 0, length = keys.length; i < length; i++) {
                        var key = keys[i];
                        var value = obj[key];
                        if (iteratee(value, key, obj)) result[key] = value;
                    }
                    return result;
                };
                _.omit = function(obj, iteratee, context) {
                    if (_.isFunction(iteratee)) {
                        iteratee = _.negate(iteratee);
                    } else {
                        var keys = _.map(flatten(arguments, false, false, 1), String);
                        iteratee = function(value, key) {
                            return !_.contains(keys, key);
                        };
                    }
                    return _.pick(obj, iteratee, context);
                };
                _.defaults = createAssigner(_.allKeys, true);
                _.create = function(prototype, props) {
                    var result = baseCreate(prototype);
                    if (props) _.extendOwn(result, props);
                    return result;
                };
                _.clone = function(obj) {
                    if (!_.isObject(obj)) return obj;
                    return _.isArray(obj) ? obj.slice() : _.extend({}, obj);
                };
                _.tap = function(obj, interceptor) {
                    interceptor(obj);
                    return obj;
                };
                _.isMatch = function(object, attrs) {
                    var keys = _.keys(attrs),
                        length = keys.length;
                    if (object == null) return !length;
                    var obj = Object(object);
                    for (var i = 0; i < length; i++) {
                        var key = keys[i];
                        if (attrs[key] !== obj[key] || !(key in obj)) return false;
                    }
                    return true;
                };
                var eq = function(a, b, aStack, bStack) {
                    if (a === b) return a !== 0 || 1 / a === 1 / b;
                    if (a == null || b == null) return a === b;
                    if (a instanceof _) a = a._wrapped;
                    if (b instanceof _) b = b._wrapped;
                    var className = toString.call(a);
                    if (className !== toString.call(b)) return false;
                    switch (className) {
                        case '[object RegExp]':
                        case '[object String]':
                            return '' + a === '' + b;
                        case '[object Number]':
                            if (+a !== +a) return +b !== +b;
                            return +a === 0 ? 1 / +a === 1 / b : +a === +b;
                        case '[object Date]':
                        case '[object Boolean]':
                            return +a === +b;
                    }
                    var areArrays = className === '[object Array]';
                    if (!areArrays) {
                        if (typeof a != 'object' || typeof b != 'object') return false;
                        var aCtor = a.constructor,
                            bCtor = b.constructor;
                        if (aCtor !== bCtor && !(_.isFunction(aCtor) && aCtor instanceof aCtor && _.isFunction(bCtor) && bCtor instanceof bCtor) && ('constructor' in a && 'constructor' in b)) {
                            return false;
                        }
                    }
                    aStack = aStack || [];
                    bStack = bStack || [];
                    var length = aStack.length;
                    while (length--) {
                        if (aStack[length] === a) return bStack[length] === b;
                    }
                    aStack.push(a);
                    bStack.push(b);
                    if (areArrays) {
                        length = a.length;
                        if (length !== b.length) return false;
                        while (length--) {
                            if (!eq(a[length], b[length], aStack, bStack)) return false;
                        }
                    } else {
                        var keys = _.keys(a),
                            key;
                        length = keys.length;
                        if (_.keys(b).length !== length) return false;
                        while (length--) {
                            key = keys[length];
                            if (!(_.has(b, key) && eq(a[key], b[key], aStack, bStack))) return false;
                        }
                    }
                    aStack.pop();
                    bStack.pop();
                    return true;
                };
                _.isEqual = function(a, b) {
                    return eq(a, b);
                };
                _.isEmpty = function(obj) {
                    if (obj == null) return true;
                    if (isArrayLike(obj) && (_.isArray(obj) || _.isString(obj) || _.isArguments(obj))) return obj.length === 0;
                    return _.keys(obj).length === 0;
                };
                _.isElement = function(obj) {
                    return !!(obj && obj.nodeType === 1);
                };
                _.isArray = nativeIsArray || function(obj) {
                    return toString.call(obj) === '[object Array]';
                };
                _.isObject = function(obj) {
                    var type = typeof obj;
                    return type === 'function' || type === 'object' && !!obj;
                };
                _.each(['Arguments', 'Function', 'String', 'Number', 'Date', 'RegExp', 'Error'], function(name) {
                    _['is' + name] = function(obj) {
                        return toString.call(obj) === '[object ' + name + ']';
                    };
                });
                if (!_.isArguments(arguments)) {
                    _.isArguments = function(obj) {
                        return _.has(obj, 'callee');
                    };
                }
                if (typeof /./ != 'function' && typeof Int8Array != 'object') {
                    _.isFunction = function(obj) {
                        return typeof obj == 'function' || false;
                    };
                }
                _.isFinite = function(obj) {
                    return isFinite(obj) && !isNaN(parseFloat(obj));
                };
                _.isNaN = function(obj) {
                    return _.isNumber(obj) && obj !== +obj;
                };
                _.isBoolean = function(obj) {
                    return obj === true || obj === false || toString.call(obj) === '[object Boolean]';
                };
                _.isNull = function(obj) {
                    return obj === null;
                };
                _.isUndefined = function(obj) {
                    return obj === void 0;
                };
                _.has = function(obj, key) {
                    return obj != null && hasOwnProperty.call(obj, key);
                };
                _.noConflict = function() {
                    root._ = previousUnderscore;
                    return this;
                };
                _.identity = function(value) {
                    return value;
                };
                _.constant = function(value) {
                    return function() {
                        return value;
                    };
                };
                _.noop = function() {};
                _.property = property;
                _.propertyOf = function(obj) {
                    return obj == null ? function() {} : function(key) {
                        return obj[key];
                    };
                };
                _.matcher = _.matches = function(attrs) {
                    attrs = _.extendOwn({}, attrs);
                    return function(obj) {
                        return _.isMatch(obj, attrs);
                    };
                };
                _.times = function(n, iteratee, context) {
                    var accum = Array(Math.max(0, n));
                    iteratee = optimizeCb(iteratee, context, 1);
                    for (var i = 0; i < n; i++) accum[i] = iteratee(i);
                    return accum;
                };
                _.random = function(min, max) {
                    if (max == null) {
                        max = min;
                        min = 0;
                    }
                    return min + Math.floor(Math.random() * (max - min + 1));
                };
                _.now = Date.now || function() {
                    return new Date().getTime();
                };
                var escapeMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#x27;',
                    '`': '&#x60;'
                };
                var unescapeMap = _.invert(escapeMap);
                var createEscaper = function(map) {
                    var escaper = function(match) {
                        return map[match];
                    };
                    var source = '(?:' + _.keys(map).join('|') + ')';
                    var testRegexp = RegExp(source);
                    var replaceRegexp = RegExp(source, 'g');
                    return function(string) {
                        string = string == null ? '' : '' + string;
                        return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
                    };
                };
                _.escape = createEscaper(escapeMap);
                _.unescape = createEscaper(unescapeMap);
                _.result = function(object, property, fallback) {
                    var value = object == null ? void 0 : object[property];
                    if (value === void 0) {
                        value = fallback;
                    }
                    return _.isFunction(value) ? value.call(object) : value;
                };
                var idCounter = 0;
                _.uniqueId = function(prefix) {
                    var id = ++idCounter + '';
                    return prefix ? prefix + id : id;
                };
                _.templateSettings = {
                    evaluate: /<%([\s\S]+?)%>/g,
                    interpolate: /<%=([\s\S]+?)%>/g,
                    escape: /<%-([\s\S]+?)%>/g
                };
                var noMatch = /(.)^/;
                var escapes = {
                    "'": "'",
                    '\\': '\\',
                    '\r': 'r',
                    '\n': 'n',
                    '\u2028': 'u2028',
                    '\u2029': 'u2029'
                };
                var escaper = /\\|'|\r|\n|\u2028|\u2029/g;
                var escapeChar = function(match) {
                    return '\\' + escapes[match];
                };
                _.template = function(text, settings, oldSettings) {
                    if (!settings && oldSettings) settings = oldSettings;
                    settings = _.defaults({}, settings, _.templateSettings);
                    var matcher = RegExp([(settings.escape || noMatch).source, (settings.interpolate || noMatch).source, (settings.evaluate || noMatch).source].join('|') + '|$', 'g');
                    var index = 0;
                    var source = "__p+='";
                    text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {
                        source += text.slice(index, offset).replace(escaper, escapeChar);
                        index = offset + match.length;
                        if (escape) {
                            source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
                        } else if (interpolate) {
                            source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
                        } else if (evaluate) {
                            source += "';\n" + evaluate + "\n__p+='";
                        }
                        return match;
                    });
                    source += "';\n";
                    if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';
                    source = "var __t,__p='',__j=Array.prototype.join," + "print=function(){__p+=__j.call(arguments,'');};\n" +
                        source + 'return __p;\n';
                    try {
                        var render = new Function(settings.variable || 'obj', '_', source);
                    } catch (e) {
                        e.source = source;
                        throw e;
                    }
                    var template = function(data) {
                        return render.call(this, data, _);
                    };
                    var argument = settings.variable || 'obj';
                    template.source = 'function(' + argument + '){\n' + source + '}';
                    return template;
                };
                _.chain = function(obj) {
                    var instance = _(obj);
                    instance._chain = true;
                    return instance;
                };
                var result = function(instance, obj) {
                    return instance._chain ? _(obj).chain() : obj;
                };
                _.mixin = function(obj) {
                    _.each(_.functions(obj), function(name) {
                        var func = _[name] = obj[name];
                        _.prototype[name] = function() {
                            var args = [this._wrapped];
                            push.apply(args, arguments);
                            return result(this, func.apply(_, args));
                        };
                    });
                };
                _.mixin(_);
                _.each(['pop', 'push', 'reverse', 'shift', 'sort', 'splice', 'unshift'], function(name) {
                    var method = ArrayProto[name];
                    _.prototype[name] = function() {
                        var obj = this._wrapped;
                        method.apply(obj, arguments);
                        if ((name === 'shift' || name === 'splice') && obj.length === 0) delete obj[0];
                        return result(this, obj);
                    };
                });
                _.each(['concat', 'join', 'slice'], function(name) {
                    var method = ArrayProto[name];
                    _.prototype[name] = function() {
                        return result(this, method.apply(this._wrapped, arguments));
                    };
                });
                _.prototype.value = function() {
                    return this._wrapped;
                };
                _.prototype.valueOf = _.prototype.toJSON = _.prototype.value;
                _.prototype.toString = function() {
                    return '' + this._wrapped;
                };
                if (typeof define === 'function' && define.amd) {
                    define('underscore', [], function() {
                        return _;
                    });
                }
            }.call(this));
        }, {}],
        36: [function(require, module, exports) {
            function createShiftArr(step) {
                var space = '    ';
                if (isNaN(parseInt(step))) {
                    space = step;
                } else {
                    switch (step) {
                        case 1:
                            space = ' ';
                            break;
                        case 2:
                            space = '  ';
                            break;
                        case 3:
                            space = '   ';
                            break;
                        case 4:
                            space = '    ';
                            break;
                        case 5:
                            space = '     ';
                            break;
                        case 6:
                            space = '      ';
                            break;
                        case 7:
                            space = '       ';
                            break;
                        case 8:
                            space = '        ';
                            break;
                        case 9:
                            space = '         ';
                            break;
                        case 10:
                            space = '          ';
                            break;
                        case 11:
                            space = '           ';
                            break;
                        case 12:
                            space = '            ';
                            break;
                    }
                }
                var shift = ['\n'];
                for (ix = 0; ix < 100; ix++) {
                    shift.push(shift[ix] + space);
                }
                return shift;
            }

            function vkbeautify() {
                this.step = '    ';
                this.shift = createShiftArr(this.step);
            };
            vkbeautify.prototype.xml = function(text, step) {
                var ar = text.replace(/>\s{0,}</g, "><").replace(/</g, "~::~<").replace(/\s*xmlns\:/g, "~::~xmlns:").replace(/\s*xmlns\=/g, "~::~xmlns=").split('~::~'),
                    len = ar.length,
                    inComment = false,
                    deep = 0,
                    str = '',
                    ix = 0,
                    shift = step ? createShiftArr(step) : this.shift;
                for (ix = 0; ix < len; ix++) {
                    if (ar[ix].search(/<!/) > -1) {
                        str += shift[deep] + ar[ix];
                        inComment = true;
                        if (ar[ix].search(/-->/) > -1 || ar[ix].search(/\]>/) > -1 || ar[ix].search(/!DOCTYPE/) > -1) {
                            inComment = false;
                        }
                    } else
                    if (ar[ix].search(/-->/) > -1 || ar[ix].search(/\]>/) > -1) {
                        str += ar[ix];
                        inComment = false;
                    } else
                    if (/^<\w/.exec(ar[ix - 1]) && /^<\/\w/.exec(ar[ix]) && /^<[\w:\-\.\,]+/.exec(ar[ix - 1]) == /^<\/[\w:\-\.\,]+/.exec(ar[ix])[0].replace('/', '')) {
                        str += ar[ix];
                        if (!inComment) deep--;
                    } else
                    if (ar[ix].search(/<\w/) > -1 && ar[ix].search(/<\//) == -1 && ar[ix].search(/\/>/) == -1) {
                        str = !inComment ? str += shift[deep++] + ar[ix] : str += ar[ix];
                    } else
                    if (ar[ix].search(/<\w/) > -1 && ar[ix].search(/<\//) > -1) {
                        str = !inComment ? str += shift[deep] + ar[ix] : str += ar[ix];
                    } else
                    if (ar[ix].search(/<\//) > -1) {
                        str = !inComment ? str += shift[--deep] + ar[ix] : str += ar[ix];
                    } else
                    if (ar[ix].search(/\/>/) > -1) {
                        str = !inComment ? str += shift[deep] + ar[ix] : str += ar[ix];
                    } else
                    if (ar[ix].search(/<\?/) > -1) {
                        str += shift[deep] + ar[ix];
                    } else
                    if (ar[ix].search(/xmlns\:/) > -1 || ar[ix].search(/xmlns\=/) > -1) {
                        str += shift[deep] + ar[ix];
                    } else {
                        str += ar[ix];
                    }
                }
                return (str[0] == '\n') ? str.slice(1) : str;
            }
            vkbeautify.prototype.json = function(text, step) {
                var step = step ? step : this.step;
                if (typeof JSON === 'undefined') return text;
                if (typeof text === "string") return JSON.stringify(JSON.parse(text), null, step);
                if (typeof text === "object") return JSON.stringify(text, null, step);
                return text;
            }
            vkbeautify.prototype.css = function(text, step) {
                var ar = text.replace(/\s{1,}/g, ' ').replace(/\{/g, "{~::~").replace(/\}/g, "~::~}~::~").replace(/\;/g, ";~::~").replace(/\/\*/g, "~::~/*").replace(/\*\//g, "*/~::~").replace(/~::~\s{0,}~::~/g, "~::~").split('~::~'),
                    len = ar.length,
                    deep = 0,
                    str = '',
                    ix = 0,
                    shift = step ? createShiftArr(step) : this.shift;
                for (ix = 0; ix < len; ix++) {
                    if (/\{/.exec(ar[ix])) {
                        str += shift[deep++] + ar[ix];
                    } else
                    if (/\}/.exec(ar[ix])) {
                        str += shift[--deep] + ar[ix];
                    } else
                    if (/\*\\/.exec(ar[ix])) {
                        str += shift[deep] + ar[ix];
                    } else {
                        str += shift[deep] + ar[ix];
                    }
                }
                return str.replace(/^\n{1,}/, '');
            }

            function isSubquery(str, parenthesisLevel) {
                return parenthesisLevel - (str.replace(/\(/g, '').length - str.replace(/\)/g, '').length)
            }

            function split_sql(str, tab) {
                return str.replace(/\s{1,}/g, " ").replace(/ AND /ig, "~::~" + tab + tab + "AND ").replace(/ BETWEEN /ig, "~::~" + tab + "BETWEEN ").replace(/ CASE /ig, "~::~" + tab + "CASE ").replace(/ ELSE /ig, "~::~" + tab + "ELSE ").replace(/ END /ig, "~::~" + tab + "END ").replace(/ FROM /ig, "~::~FROM ").replace(/ GROUP\s{1,}BY/ig, "~::~GROUP BY ").replace(/ HAVING /ig, "~::~HAVING ").replace(/ IN /ig, " IN ").replace(/ JOIN /ig, "~::~JOIN ").replace(/ CROSS~::~{1,}JOIN /ig, "~::~CROSS JOIN ").replace(/ INNER~::~{1,}JOIN /ig, "~::~INNER JOIN ").replace(/ LEFT~::~{1,}JOIN /ig, "~::~LEFT JOIN ").replace(/ RIGHT~::~{1,}JOIN /ig, "~::~RIGHT JOIN ").replace(/ ON /ig, "~::~" + tab + "ON ").replace(/ OR /ig, "~::~" + tab + tab + "OR ").replace(/ ORDER\s{1,}BY/ig, "~::~ORDER BY ").replace(/ OVER /ig, "~::~" + tab + "OVER ").replace(/\(\s{0,}SELECT /ig, "~::~(SELECT ").replace(/\)\s{0,}SELECT /ig, ")~::~SELECT ").replace(/ THEN /ig, " THEN~::~" + tab + "").replace(/ UNION /ig, "~::~UNION~::~").replace(/ USING /ig, "~::~USING ").replace(/ WHEN /ig, "~::~" + tab + "WHEN ").replace(/ WHERE /ig, "~::~WHERE ").replace(/ WITH /ig, "~::~WITH ").replace(/ ALL /ig, " ALL ").replace(/ AS /ig, " AS ").replace(/ ASC /ig, " ASC ").replace(/ DESC /ig, " DESC ").replace(/ DISTINCT /ig, " DISTINCT ").replace(/ EXISTS /ig, " EXISTS ").replace(/ NOT /ig, " NOT ").replace(/ NULL /ig, " NULL ").replace(/ LIKE /ig, " LIKE ").replace(/\s{0,}SELECT /ig, "SELECT ").replace(/\s{0,}UPDATE /ig, "UPDATE ").replace(/ SET /ig, " SET ").replace(/~::~{1,}/g, "~::~").split('~::~');
            }
            vkbeautify.prototype.sql = function(text, step) {
                var ar_by_quote = text.replace(/\s{1,}/g, " ").replace(/\'/ig, "~::~\'").split('~::~'),
                    len = ar_by_quote.length,
                    ar = [],
                    deep = 0,
                    tab = this.step,
                    inComment = true,
                    inQuote = false,
                    parenthesisLevel = 0,
                    str = '',
                    ix = 0,
                    shift = step ? createShiftArr(step) : this.shift;;
                for (ix = 0; ix < len; ix++) {
                    if (ix % 2) {
                        ar = ar.concat(ar_by_quote[ix]);
                    } else {
                        ar = ar.concat(split_sql(ar_by_quote[ix], tab));
                    }
                }
                len = ar.length;
                for (ix = 0; ix < len; ix++) {
                    parenthesisLevel = isSubquery(ar[ix], parenthesisLevel);
                    if (/\s{0,}\s{0,}SELECT\s{0,}/.exec(ar[ix])) {
                        ar[ix] = ar[ix].replace(/\,/g, ",\n" + tab + tab + "")
                    }
                    if (/\s{0,}\s{0,}SET\s{0,}/.exec(ar[ix])) {
                        ar[ix] = ar[ix].replace(/\,/g, ",\n" + tab + tab + "")
                    }
                    if (/\s{0,}\(\s{0,}SELECT\s{0,}/.exec(ar[ix])) {
                        deep++;
                        str += shift[deep] + ar[ix];
                    } else
                    if (/\'/.exec(ar[ix])) {
                        if (parenthesisLevel < 1 && deep) {
                            deep--;
                        }
                        str += ar[ix];
                    } else {
                        str += shift[deep] + ar[ix];
                        if (parenthesisLevel < 1 && deep) {
                            deep--;
                        }
                    }
                    var junk = 0;
                }
                str = str.replace(/^\n{1,}/, '').replace(/\n{1,}/g, "\n");
                return str;
            }
            vkbeautify.prototype.xmlmin = function(text, preserveComments) {
                var str = preserveComments ? text : text.replace(/\<![ \r\n\t]*(--([^\-]|[\r\n]|-[^\-])*--[ \r\n\t]*)\>/g, "").replace(/[ \r\n\t]{1,}xmlns/g, ' xmlns');
                return str.replace(/>\s{0,}</g, "><");
            }
            vkbeautify.prototype.jsonmin = function(text) {
                if (typeof JSON === 'undefined') return text;
                return JSON.stringify(JSON.parse(text), null, 0);
            }
            vkbeautify.prototype.cssmin = function(text, preserveComments) {
                var str = preserveComments ? text : text.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g, "");
                return str.replace(/\s{1,}/g, ' ').replace(/\{\s{1,}/g, "{").replace(/\}\s{1,}/g, "}").replace(/\;\s{1,}/g, ";").replace(/\/\*\s{1,}/g, "/*").replace(/\*\/\s{1,}/g, "*/");
            }
            vkbeautify.prototype.sqlmin = function(text) {
                return text.replace(/\s{1,}/g, " ").replace(/\s{1,}\(/, "(").replace(/\s{1,}\)/, ")");
            }
            module.exports = new vkbeautify();
        }, {}]
    }, {}, [28])(28)
});;

var requirejs, require, define;
(function(ba) {
    function G(b) {
        return "[object Function]" === K.call(b)
    }

    function H(b) {
        return "[object Array]" === K.call(b)
    }

    function v(b, c) {
        if (b) {
            var d;
            for (d = 0; d < b.length && (!b[d] || !c(b[d], d, b)); d += 1);
        }
    }

    function T(b, c) {
        if (b) {
            var d;
            for (d = b.length - 1; - 1 < d && (!b[d] || !c(b[d], d, b)); d -= 1);
        }
    }

    function t(b, c) {
        return fa.call(b, c)
    }

    function n(b, c) {
        return t(b, c) && b[c]
    }

    function A(b, c) {
        for (var d in b)
            if (t(b, d) && c(b[d], d)) break
    }

    function U(b, c, d, e) {
        c && A(c, function(c, i) {
            if (d || !t(b, i)) e && "object" === typeof c && c && !H(c) && !G(c) && !(c instanceof RegExp) ? (b[i] || (b[i] = {}), U(b[i], c, d, e)) : b[i] = c
        });
        return b
    }

    function u(b, c) {
        return function() {
            return c.apply(b, arguments)
        }
    }

    function ca(b) {
        throw b;
    }

    function da(b) {
        if (!b) return b;
        var c = ba;
        v(b.split("."), function(b) {
            c = c[b]
        });
        return c
    }

    function B(b, c, d, e) {
        c = Error(c + "\nhttp://requirejs.org/docs/errors.html#" + b);
        c.requireType = b;
        c.requireModules = e;
        d && (c.originalError = d);
        return c
    }

    function ga(b) {
        function c(a, j, b) {
            var f, l, c, d, h, e, g, i, j = j && j.split("/"),
                p = k.map,
                m = p && p["*"];
            if (a) {
                a = a.split("/");
                l = a.length - 1;
                k.nodeIdCompat && Q.test(a[l]) && (a[l] = a[l].replace(Q, ""));
                "." === a[0].charAt(0) && j && (l = j.slice(0, j.length - 1), a = l.concat(a));
                l = a;
                for (c = 0; c < l.length; c++)
                    if (d = l[c], "." === d) l.splice(c, 1), c -= 1;
                    else if (".." === d && !(0 === c || 1 === c && ".." === l[2] || ".." === l[c - 1]) && 0 < c) l.splice(c - 1, 2), c -= 2;
                a = a.join("/")
            }
            if (b && p && (j || m)) {
                l = a.split("/");
                c = l.length;
                a: for (; 0 < c; c -= 1) {
                    h = l.slice(0, c).join("/");
                    if (j)
                        for (d = j.length; 0 < d; d -= 1)
                            if (b = n(p, j.slice(0, d).join("/")))
                                if (b = n(b, h)) {
                                    f = b;
                                    e = c;
                                    break a
                                }!g && (m && n(m, h)) && (g = n(m, h), i = c)
                }!f && g && (f = g, e = i);
                f && (l.splice(0, e, f), a = l.join("/"))
            }
            return (f = n(k.pkgs, a)) ? f : a
        }

        function d(a) {
            z && v(document.getElementsByTagName("script"), function(j) {
                if (j.getAttribute("data-requiremodule") === a && j.getAttribute("data-requirecontext") === h.contextName) return j.parentNode.removeChild(j), !0
            })
        }

        function p(a) {
            var j = n(k.paths, a);
            if (j && H(j) && 1 < j.length) return j.shift(), h.require.undef(a), h.makeRequire(null, {
                skipMap: !0
            })([a]), !0
        }

        function g(a) {
            var j, c = a ? a.indexOf("!") : -1; - 1 < c && (j = a.substring(0, c), a = a.substring(c + 1, a.length));
            return [j, a]
        }

        function i(a, j, b, f) {
            var l, d, e = null,
                i = j ? j.name : null,
                k = a,
                p = !0,
                m = "";
            a || (p = !1, a = "_@r" + (K += 1));
            a = g(a);
            e = a[0];
            a = a[1];
            e && (e = c(e, i, f), d = n(q, e));
            a && (e ? m = d && d.normalize ? d.normalize(a, function(a) {
                return c(a, i, f)
            }) : -1 === a.indexOf("!") ? c(a, i, f) : a : (m = c(a, i, f), a = g(m), e = a[0], m = a[1], b = !0, l = h.nameToUrl(m)));
            b = e && !d && !b ? "_unnormalized" + (O += 1) : "";
            return {
                prefix: e,
                name: m,
                parentMap: j,
                unnormalized: !!b,
                url: l,
                originalName: k,
                isDefine: p,
                id: (e ? e + "!" + m : m) + b
            }
        }

        function r(a) {
            var j = a.id,
                b = n(m, j);
            b || (b = m[j] = new h.Module(a));
            return b
        }

        function s(a, j, b) {
            var f = a.id,
                c = n(m, f);
            if (t(q, f) && (!c || c.defineEmitComplete)) "defined" === j && b(q[f]);
            else if (c = r(a), c.error && "error" === j) b(c.error);
            else c.on(j, b)
        }

        function w(a, b) {
            var c = a.requireModules,
                f = !1;
            if (b) b(a);
            else if (v(c, function(b) {
                    if (b = n(m, b)) b.error = a, b.events.error && (f = !0, b.emit("error", a))
                }), !f) e.onError(a)
        }

        function x() {
            R.length && (v(R, function(a) {
                var b = a[0];
                "string" === typeof b && (h.defQueueMap[b] = !0);
                C.push(a)
            }), R = [])
        }

        function y(a) {
            delete m[a];
            delete V[a]
        }

        function F(a, b, c) {
            var f = a.map.id;
            a.error ? a.emit("error", a.error) : (b[f] = !0, v(a.depMaps, function(f, d) {
                var e = f.id,
                    h = n(m, e);
                h && (!a.depMatched[d] && !c[e]) && (n(b, e) ? (a.defineDep(d, q[e]), a.check()) : F(h, b, c))
            }), c[f] = !0)
        }

        function D() {
            var a, b, c = (a = 1E3 * k.waitSeconds) && h.startTime + a < (new Date).getTime(),
                f = [],
                l = [],
                e = !1,
                i = !0;
            if (!W) {
                W = !0;
                A(V, function(a) {
                    var h = a.map,
                        g = h.id;
                    if (a.enabled && (h.isDefine || l.push(a), !a.error))
                        if (!a.inited && c) p(g) ? e = b = !0 : (f.push(g), d(g));
                        else if (!a.inited && (a.fetched && h.isDefine) && (e = !0, !h.prefix)) return i = !1
                });
                if (c && f.length) return a = B("timeout", "Load timeout for modules: " + f, null, f), a.contextName = h.contextName, w(a);
                i && v(l, function(a) {
                    F(a, {}, {})
                });
                if ((!c || b) && e)
                    if ((z || ea) && !X) X = setTimeout(function() {
                        X = 0;
                        D()
                    }, 50);
                W = !1
            }
        }

        function E(a) {
            t(q, a[0]) || r(i(a[0], null, !0)).init(a[1], a[2])
        }

        function I(a) {
            var a = a.currentTarget || a.srcElement,
                b = h.onScriptLoad;
            a.detachEvent && !Y ? a.detachEvent("onreadystatechange", b) : a.removeEventListener("load", b, !1);
            b = h.onScriptError;
            (!a.detachEvent || Y) && a.removeEventListener("error", b, !1);
            return {
                node: a,
                id: a && a.getAttribute("data-requiremodule")
            }
        }

        function J() {
            var a;
            for (x(); C.length;) {
                a = C.shift();
                if (null === a[0]) return w(B("mismatch", "Mismatched anonymous define() module: " + a[a.length - 1]));
                E(a)
            }
            h.defQueueMap = {}
        }
        var W, Z, h, L, X, k = {
                waitSeconds: 7,
                baseUrl: "./",
                paths: {},
                bundles: {},
                pkgs: {},
                shim: {},
                config: {}
            },
            m = {},
            V = {},
            $ = {},
            C = [],
            q = {},
            S = {},
            aa = {},
            K = 1,
            O = 1;
        L = {
            require: function(a) {
                return a.require ? a.require : a.require = h.makeRequire(a.map)
            },
            exports: function(a) {
                a.usingExports = !0;
                if (a.map.isDefine) return a.exports ? q[a.map.id] = a.exports : a.exports = q[a.map.id] = {}
            },
            module: function(a) {
                return a.module ? a.module : a.module = {
                    id: a.map.id,
                    uri: a.map.url,
                    config: function() {
                        return n(k.config, a.map.id) || {}
                    },
                    exports: a.exports || (a.exports = {})
                }
            }
        };
        Z = function(a) {
            this.events = n($, a.id) || {};
            this.map = a;
            this.shim = n(k.shim, a.id);
            this.depExports = [];
            this.depMaps = [];
            this.depMatched = [];
            this.pluginMaps = {};
            this.depCount = 0
        };
        Z.prototype = {
            init: function(a, b, c, f) {
                f = f || {};
                if (!this.inited) {
                    this.factory = b;
                    if (c) this.on("error", c);
                    else this.events.error && (c = u(this, function(a) {
                        this.emit("error", a)
                    }));
                    this.depMaps = a && a.slice(0);
                    this.errback = c;
                    this.inited = !0;
                    this.ignore = f.ignore;
                    f.enabled || this.enabled ? this.enable() : this.check()
                }
            },
            defineDep: function(a, b) {
                this.depMatched[a] || (this.depMatched[a] = !0, this.depCount -= 1, this.depExports[a] = b)
            },
            fetch: function() {
                if (!this.fetched) {
                    this.fetched = !0;
                    h.startTime = (new Date).getTime();
                    var a = this.map;
                    if (this.shim) h.makeRequire(this.map, {
                        enableBuildCallback: !0
                    })(this.shim.deps || [], u(this, function() {
                        return a.prefix ? this.callPlugin() : this.load()
                    }));
                    else return a.prefix ? this.callPlugin() : this.load()
                }
            },
            load: function() {
                var a = this.map.url;
                S[a] || (S[a] = !0, h.load(this.map.id, a))
            },
            check: function() {
                if (this.enabled && !this.enabling) {
                    var a, b, c = this.map.id;
                    b = this.depExports;
                    var f = this.exports,
                        l = this.factory;
                    if (this.inited)
                        if (this.error) this.emit("error", this.error);
                        else {
                            if (!this.defining) {
                                this.defining = !0;
                                if (1 > this.depCount && !this.defined) {
                                    if (G(l)) {
                                        if (this.events.error && this.map.isDefine || e.onError !== ca) try {
                                            f = h.execCb(c, l, b, f)
                                        } catch (d) {
                                            a = d
                                        } else f = h.execCb(c, l, b, f);
                                        this.map.isDefine && void 0 === f && ((b = this.module) ? f = b.exports : this.usingExports && (f = this.exports));
                                        if (a) return a.requireMap = this.map, a.requireModules = this.map.isDefine ? [this.map.id] : null, a.requireType = this.map.isDefine ? "define" : "require", w(this.error = a)
                                    } else f = l;
                                    this.exports = f;
                                    if (this.map.isDefine && !this.ignore && (q[c] = f, e.onResourceLoad)) e.onResourceLoad(h, this.map, this.depMaps);
                                    y(c);
                                    this.defined = !0
                                }
                                this.defining = !1;
                                this.defined && !this.defineEmitted && (this.defineEmitted = !0, this.emit("defined", this.exports), this.defineEmitComplete = !0)
                            }
                        }
                    else t(h.defQueueMap, c) || this.fetch()
                }
            },
            callPlugin: function() {
                var a = this.map,
                    b = a.id,
                    d = i(a.prefix);
                this.depMaps.push(d);
                s(d, "defined", u(this, function(f) {
                    var l, d;
                    d = n(aa, this.map.id);
                    var g = this.map.name,
                        P = this.map.parentMap ? this.map.parentMap.name : null,
                        p = h.makeRequire(a.parentMap, {
                            enableBuildCallback: !0
                        });
                    if (this.map.unnormalized) {
                        if (f.normalize && (g = f.normalize(g, function(a) {
                                return c(a, P, !0)
                            }) || ""), f = i(a.prefix + "!" + g, this.map.parentMap), s(f, "defined", u(this, function(a) {
                                this.init([], function() {
                                    return a
                                }, null, {
                                    enabled: !0,
                                    ignore: !0
                                })
                            })), d = n(m, f.id)) {
                            this.depMaps.push(f);
                            if (this.events.error) d.on("error", u(this, function(a) {
                                this.emit("error", a)
                            }));
                            d.enable()
                        }
                    } else d ? (this.map.url = h.nameToUrl(d), this.load()) : (l = u(this, function(a) {
                        this.init([], function() {
                            return a
                        }, null, {
                            enabled: !0
                        })
                    }), l.error = u(this, function(a) {
                        this.inited = !0;
                        this.error = a;
                        a.requireModules = [b];
                        A(m, function(a) {
                            0 === a.map.id.indexOf(b + "_unnormalized") && y(a.map.id)
                        });
                        w(a)
                    }), l.fromText = u(this, function(f, c) {
                        var d = a.name,
                            g = i(d),
                            P = M;
                        c && (f = c);
                        P && (M = !1);
                        r(g);
                        t(k.config, b) && (k.config[d] = k.config[b]);
                        try {
                            e.exec(f)
                        } catch (m) {
                            return w(B("fromtexteval", "fromText eval for " + b + " failed: " + m, m, [b]))
                        }
                        P && (M = !0);
                        this.depMaps.push(g);
                        h.completeLoad(d);
                        p([d], l)
                    }), f.load(a.name, p, l, k))
                }));
                h.enable(d, this);
                this.pluginMaps[d.id] = d
            },
            enable: function() {
                V[this.map.id] = this;
                this.enabling = this.enabled = !0;
                v(this.depMaps, u(this, function(a, b) {
                    var c, f;
                    if ("string" === typeof a) {
                        a = i(a, this.map.isDefine ? this.map : this.map.parentMap, !1, !this.skipMap);
                        this.depMaps[b] = a;
                        if (c = n(L, a.id)) {
                            this.depExports[b] = c(this);
                            return
                        }
                        this.depCount += 1;
                        s(a, "defined", u(this, function(a) {
                            this.undefed || (this.defineDep(b, a), this.check())
                        }));
                        this.errback ? s(a, "error", u(this, this.errback)) : this.events.error && s(a, "error", u(this, function(a) {
                            this.emit("error", a)
                        }))
                    }
                    c = a.id;
                    f = m[c];
                    !t(L, c) && (f && !f.enabled) && h.enable(a, this)
                }));
                A(this.pluginMaps, u(this, function(a) {
                    var b = n(m, a.id);
                    b && !b.enabled && h.enable(a, this)
                }));
                this.enabling = !1;
                this.check()
            },
            on: function(a, b) {
                var c = this.events[a];
                c || (c = this.events[a] = []);
                c.push(b)
            },
            emit: function(a, b) {
                v(this.events[a], function(a) {
                    a(b)
                });
                "error" === a && delete this.events[a]
            }
        };
        h = {
            config: k,
            contextName: b,
            registry: m,
            defined: q,
            urlFetched: S,
            defQueue: C,
            defQueueMap: {},
            Module: Z,
            makeModuleMap: i,
            nextTick: e.nextTick,
            onError: w,
            configure: function(a) {
                a.baseUrl && "/" !== a.baseUrl.charAt(a.baseUrl.length - 1) && (a.baseUrl += "/");
                var b = k.shim,
                    c = {
                        paths: !0,
                        bundles: !0,
                        config: !0,
                        map: !0
                    };
                A(a, function(a, b) {
                    c[b] ? (k[b] || (k[b] = {}), U(k[b], a, !0, !0)) : k[b] = a
                });
                a.bundles && A(a.bundles, function(a, b) {
                    v(a, function(a) {
                        a !== b && (aa[a] = b)
                    })
                });
                a.shim && (A(a.shim, function(a, c) {
                    H(a) && (a = {
                        deps: a
                    });
                    if ((a.exports || a.init) && !a.exportsFn) a.exportsFn = h.makeShimExports(a);
                    b[c] = a
                }), k.shim = b);
                a.packages && v(a.packages, function(a) {
                    var b, a = "string" === typeof a ? {
                        name: a
                    } : a;
                    b = a.name;
                    a.location && (k.paths[b] = a.location);
                    k.pkgs[b] = a.name + "/" + (a.main || "main").replace(ha, "").replace(Q, "")
                });
                A(m, function(a, b) {
                    !a.inited && !a.map.unnormalized && (a.map = i(b, null, !0))
                });
                if (a.deps || a.callback) h.require(a.deps || [], a.callback)
            },
            makeShimExports: function(a) {
                return function() {
                    var b;
                    a.init && (b = a.init.apply(ba, arguments));
                    return b || a.exports && da(a.exports)
                }
            },
            makeRequire: function(a, j) {
                function g(c, d, p) {
                    var k, n;
                    j.enableBuildCallback && (d && G(d)) && (d.__requireJsBuild = !0);
                    if ("string" === typeof c) {
                        if (G(d)) return w(B("requireargs", "Invalid require call"), p);
                        if (a && t(L, c)) return L[c](m[a.id]);
                        if (e.get) return e.get(h, c, a, g);
                        k = i(c, a, !1, !0);
                        k = k.id;
                        return !t(q, k) ? w(B("notloaded", 'Module name "' + k + '" has not been loaded yet for context: ' + b + (a ? "" : ". Use require([])"))) : q[k]
                    }
                    J();
                    h.nextTick(function() {
                        J();
                        n = r(i(null, a));
                        n.skipMap = j.skipMap;
                        n.init(c, d, p, {
                            enabled: !0
                        });
                        D()
                    });
                    return g
                }
                j = j || {};
                U(g, {
                    isBrowser: z,
                    toUrl: function(b) {
                        var d, e = b.lastIndexOf("."),
                            j = b.split("/")[0];
                        if (-1 !== e && (!("." === j || ".." === j) || 1 < e)) d = b.substring(e, b.length), b = b.substring(0, e);
                        return h.nameToUrl(c(b, a && a.id, !0), d, !0)
                    },
                    defined: function(b) {
                        return t(q, i(b, a, !1, !0).id)
                    },
                    specified: function(b) {
                        b = i(b, a, !1, !0).id;
                        return t(q, b) || t(m, b)
                    }
                });
                a || (g.undef = function(b) {
                    x();
                    var c = i(b, a, !0),
                        e = n(m, b);
                    e.undefed = !0;
                    d(b);
                    delete q[b];
                    delete S[c.url];
                    delete $[b];
                    T(C, function(a, c) {
                        a[0] === b && C.splice(c, 1)
                    });
                    delete h.defQueueMap[b];
                    e && (e.events.defined && ($[b] = e.events), y(b))
                });
                return g
            },
            enable: function(a) {
                n(m, a.id) && r(a).enable()
            },
            completeLoad: function(a) {
                var b, c, d = n(k.shim, a) || {},
                    e = d.exports;
                for (x(); C.length;) {
                    c = C.shift();
                    if (null === c[0]) {
                        c[0] = a;
                        if (b) break;
                        b = !0
                    } else c[0] === a && (b = !0);
                    E(c)
                }
                h.defQueueMap = {};
                c = n(m, a);
                if (!b && !t(q, a) && c && !c.inited) {
                    if (k.enforceDefine && (!e || !da(e))) return p(a) ? void 0 : w(B("nodefine", "No define call for " + a, null, [a]));
                    E([a, d.deps || [], d.exportsFn])
                }
                D()
            },
            nameToUrl: function(a, b, c) {
                var d, g, i;
                (d = n(k.pkgs, a)) && (a = d);
                if (d = n(aa, a)) return h.nameToUrl(d, b, c);
                if (e.jsExtRegExp.test(a)) d = a + (b || "");
                else {
                    d = k.paths;
                    a = a.split("/");
                    for (g = a.length; 0 < g; g -= 1)
                        if (i = a.slice(0, g).join("/"), i = n(d, i)) {
                            H(i) && (i = i[0]);
                            a.splice(0, g, i);
                            break
                        }
                    d = a.join("/");
                    d += b || (/^data\:|\?/.test(d) || c ? "" : ".js");
                    d = ("/" === d.charAt(0) || d.match(/^[\w\+\.\-]+:/) ? "" : k.baseUrl) + d
                }
                return k.urlArgs ? d + ((-1 === d.indexOf("?") ? "?" : "&") + k.urlArgs) : d
            },
            load: function(a, b) {
                e.load(h, a, b)
            },
            execCb: function(a, b, c, d) {
                return b.apply(d, c)
            },
            onScriptLoad: function(a) {
                if ("load" === a.type || ia.test((a.currentTarget || a.srcElement).readyState)) N = null, a = I(a), h.completeLoad(a.id)
            },
            onScriptError: function(a) {
                var b = I(a);
                if (!p(b.id)) return w(B("scripterror", "Script error for: " + b.id, a, [b.id]))
            }
        };
        h.require = h.makeRequire();
        return h
    }
    var e, x, y, D, I, E, N, J, r, O, ja = /(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,
        ka = /[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,
        Q = /\.js$/,
        ha = /^\.\//;
    x = Object.prototype;
    var K = x.toString,
        fa = x.hasOwnProperty,
        z = !!("undefined" !== typeof window && "undefined" !== typeof navigator && window.document),
        ea = !z && "undefined" !== typeof importScripts,
        ia = z && "PLAYSTATION 3" === navigator.platform ? /^complete$/ : /^(complete|loaded)$/,
        Y = "undefined" !== typeof opera && "[object Opera]" === opera.toString(),
        F = {},
        s = {},
        R = [],
        M = !1;
    if ("undefined" === typeof define) {
        if ("undefined" !== typeof requirejs) {
            if (G(requirejs)) return;
            s = requirejs;
            requirejs = void 0
        }
        "undefined" !== typeof require && !G(require) && (s = require, require = void 0);
        e = requirejs = function(b, c, d, p) {
            var g, i = "_";
            !H(b) && "string" !== typeof b && (g = b, H(c) ? (b = c, c = d, d = p) : b = []);
            g && g.context && (i = g.context);
            (p = n(F, i)) || (p = F[i] = e.s.newContext(i));
            g && p.configure(g);
            return p.require(b, c, d)
        };
        e.config = function(b) {
            return e(b)
        };
        e.nextTick = "undefined" !== typeof setTimeout ? function(b) {
            setTimeout(b, 4)
        } : function(b) {
            b()
        };
        require || (require = e);
        e.version = "2.1.20";
        e.jsExtRegExp = /^\/|:|\?|\.js$/;
        e.isBrowser = z;
        x = e.s = {
            contexts: F,
            newContext: ga
        };
        e({});
        v(["toUrl", "undef", "defined", "specified"], function(b) {
            e[b] = function() {
                var c = F._;
                return c.require[b].apply(c, arguments)
            }
        });
        if (z && (y = x.head = document.getElementsByTagName("head")[0], D = document.getElementsByTagName("base")[0])) y = x.head = D.parentNode;
        e.onError = ca;
        e.createNode = function(b) {
            var c = b.xhtml ? document.createElementNS("http://www.w3.org/1999/xhtml", "html:script") : document.createElement("script");
            c.type = b.scriptType || "text/javascript";
            c.charset = "utf-8";
            c.async = !0;
            return c
        };
        e.load = function(b, c, d) {
            var p = b && b.config || {},
                g;
            if (z) {
                g = e.createNode(p, c, d);
                if (p.onNodeCreated) p.onNodeCreated(g, p, c, d);
                g.setAttribute("data-requirecontext", b.contextName);
                g.setAttribute("data-requiremodule", c);
                g.attachEvent && !(g.attachEvent.toString && 0 > g.attachEvent.toString().indexOf("[native code")) && !Y ? (M = !0, g.attachEvent("onreadystatechange", b.onScriptLoad)) : (g.addEventListener("load", b.onScriptLoad, !1), g.addEventListener("error", b.onScriptError, !1));
                g.src = d;
                J = g;
                D ? y.insertBefore(g, D) : y.appendChild(g);
                J = null;
                return g
            }
            if (ea) try {
                importScripts(d), b.completeLoad(c)
            } catch (i) {
                b.onError(B("importscripts", "importScripts failed for " + c + " at " + d, i, [c]))
            }
        };
        z && !s.skipDataMain && T(document.getElementsByTagName("script"), function(b) {
            y || (y = b.parentNode);
            if (I = b.getAttribute("data-main")) return r = I, s.baseUrl || (E = r.split("/"), r = E.pop(), O = E.length ? E.join("/") + "/" : "./", s.baseUrl = O), r = r.replace(Q, ""), e.jsExtRegExp.test(r) && (r = I), s.deps = s.deps ? s.deps.concat(r) : [r], !0
        });
        define = function(b, c, d) {
            var e, g;
            "string" !== typeof b && (d = c, c = b, b = null);
            H(c) || (d = c, c = null);
            !c && G(d) && (c = [], d.length && (d.toString().replace(ja, "").replace(ka, function(b, d) {
                c.push(d)
            }), c = (1 === d.length ? ["require"] : ["require", "exports", "module"]).concat(c)));
            if (M) {
                if (!(e = J)) N && "interactive" === N.readyState || T(document.getElementsByTagName("script"), function(b) {
                    if ("interactive" === b.readyState) return N = b
                }), e = N;
                e && (b || (b = e.getAttribute("data-requiremodule")), g = F[e.getAttribute("data-requirecontext")])
            }
            g ? (g.defQueue.push([b, c, d]), g.defQueueMap[b] = !0) : R.push([b, c, d])
        };
        define.amd = {
            jQuery: !0
        };
        e.exec = function(b) {
            return eval(b)
        };
        e(s)
    }
})(this);
/*! Protein Feature View. proteinfeatureview 1.0.1  18y-02-05 */
var requirejs, require, define;
! function(ba) {
    function G(a) {
        return "[object Function]" === K.call(a)
    }

    function H(a) {
        return "[object Array]" === K.call(a)
    }

    function v(a, b) {
        if (a) {
            var c;
            for (c = 0; c < a.length && (!a[c] || !b(a[c], c, a)); c += 1);
        }
    }

    function T(a, b) {
        if (a) {
            var c;
            for (c = a.length - 1; - 1 < c && (!a[c] || !b(a[c], c, a)); c -= 1);
        }
    }

    function t(a, b) {
        return fa.call(a, b)
    }

    function m(a, b) {
        return t(a, b) && a[b]
    }

    function B(a, b) {
        for (var c in a)
            if (t(a, c) && b(a[c], c)) break
    }

    function U(a, b, c, d) {
        return b && B(b, function(b, e) {
            !c && t(a, e) || (!d || "object" != typeof b || !b || H(b) || G(b) || b instanceof RegExp ? a[e] = b : (a[e] || (a[e] = {}), U(a[e], b, c, d)))
        }), a
    }

    function u(a, b) {
        return function() {
            return b.apply(a, arguments)
        }
    }

    function ca(a) {
        throw a
    }

    function da(a) {
        if (!a) return a;
        var b = ba;
        return v(a.split("."), function(a) {
            b = b[a]
        }), b
    }

    function C(a, b, c, d) {
        return b = Error(b + "\nhttp://requirejs.org/docs/errors.html#" + a), b.requireType = a, b.requireModules = d, c && (b.originalError = c), b
    }

    function ga(a) {
        function b(a, b, c) {
            var d, e, f, g, h, i, j, k, b = b && b.split("/"),
                l = D.map,
                n = l && l["*"];
            if (a) {
                for (a = a.split("/"), e = a.length - 1, D.nodeIdCompat && Q.test(a[e]) && (a[e] = a[e].replace(Q, "")), "." === a[0].charAt(0) && b && (e = b.slice(0, b.length - 1), a = e.concat(a)), e = a, f = 0; f < e.length; f++) "." === (g = e[f]) ? (e.splice(f, 1), f -= 1) : ".." === g && 0 !== f && (1 != f || ".." !== e[2]) && ".." !== e[f - 1] && 0 < f && (e.splice(f - 1, 2), f -= 2);
                a = a.join("/")
            }
            if (c && l && (b || n)) {
                e = a.split("/"), f = e.length;
                a: for (; 0 < f; f -= 1) {
                    if (h = e.slice(0, f).join("/"), b)
                        for (g = b.length; 0 < g; g -= 1)
                            if ((c = m(l, b.slice(0, g).join("/"))) && (c = m(c, h))) {
                                d = c, i = f;
                                break a
                            }!j && n && m(n, h) && (j = m(n, h), k = f)
                }!d && j && (d = j, i = k), d && (e.splice(0, i, d), a = e.join("/"))
            }
            return (d = m(D.pkgs, a)) ? d : a
        }

        function c(a) {
            z && v(document.getElementsByTagName("script"), function(b) {
                if (b.getAttribute("data-requiremodule") === a && b.getAttribute("data-requirecontext") === x.contextName) return b.parentNode.removeChild(b), !0
            })
        }

        function d(a) {
            var b = m(D.paths, a);
            if (b && H(b) && 1 < b.length) return b.shift(), x.require.undef(a), x.makeRequire(null, {
                skipMap: !0
            })([a]), !0
        }

        function e(a) {
            var b, c = a ? a.indexOf("!") : -1;
            return -1 < c && (b = a.substring(0, c), a = a.substring(c + 1, a.length)), [b, a]
        }

        function f(a, c, d, f) {
            var g, h, i = null,
                j = c ? c.name : null,
                k = a,
                l = !0,
                n = "";
            return a || (l = !1, a = "_@r" + (P += 1)), a = e(a), i = a[0], a = a[1], i && (i = b(i, j, f), h = m(K, i)), a && (i ? n = h && h.normalize ? h.normalize(a, function(a) {
                return b(a, j, f)
            }) : -1 === a.indexOf("!") ? b(a, j, f) : a : (n = b(a, j, f), a = e(n), i = a[0], n = a[1], d = !0, g = x.nameToUrl(n))), d = !i || h || d ? "" : "_unnormalized" + (S += 1), {
                prefix: i,
                name: n,
                parentMap: c,
                unnormalized: !!d,
                url: g,
                originalName: k,
                isDefine: l,
                id: (i ? i + "!" + n : n) + d
            }
        }

        function h(a) {
            var b = a.id,
                c = m(E, b);
            return c || (c = E[b] = new x.Module(a)), c
        }

        function i(a, b, c) {
            var d = a.id,
                e = m(E, d);
            !t(K, d) || e && !e.defineEmitComplete ? (e = h(a), e.error && "error" === b ? c(e.error) : e.on(b, c)) : "defined" === b && c(K[d])
        }

        function j(a, b) {
            var c = a.requireModules,
                d = !1;
            b ? b(a) : (v(c, function(b) {
                (b = m(E, b)) && (b.error = a, b.events.error && (d = !0, b.emit("error", a)))
            }), d || g.onError(a))
        }

        function k() {
            R.length && (ha.apply(J, [J.length, 0].concat(R)), R = [])
        }

        function l(a) {
            delete E[a], delete F[a]
        }

        function n(a, b, c) {
            var d = a.map.id;
            a.error ? a.emit("error", a.error) : (b[d] = !0, v(a.depMaps, function(d, e) {
                var f = d.id,
                    g = m(E, f);
                g && !a.depMatched[e] && !c[f] && (m(b, f) ? (a.defineDep(e, K[f]), a.check()) : n(g, b, c))
            }), c[d] = !0)
        }

        function o() {
            var a, b, e = (a = 1e3 * D.waitSeconds) && x.startTime + a < (new Date).getTime(),
                f = [],
                g = [],
                h = !1,
                i = !0;
            if (!s) {
                if (s = !0, B(F, function(a) {
                        var j = a.map,
                            k = j.id;
                        if (a.enabled && (j.isDefine || g.push(a), !a.error))
                            if (!a.inited && e) d(k) ? h = b = !0 : (f.push(k), c(k));
                            else if (!a.inited && a.fetched && j.isDefine && (h = !0, !j.prefix)) return i = !1
                    }), e && f.length) return a = C("timeout", "Load timeout for modules: " + f, null, f), a.contextName = x.contextName, j(a);
                i && v(g, function(a) {
                    n(a, {}, {})
                }), e && !b || !h || !z && !ea || A || (A = setTimeout(function() {
                    A = 0, o()
                }, 50)), s = !1
            }
        }

        function p(a) {
            t(K, a[0]) || h(f(a[0], null, !0)).init(a[1], a[2])
        }

        function q(a) {
            var a = a.currentTarget || a.srcElement,
                b = x.onScriptLoad;
            return a.detachEvent && !Y ? a.detachEvent("onreadystatechange", b) : a.removeEventListener("load", b, !1), b = x.onScriptError, (!a.detachEvent || Y) && a.removeEventListener("error", b, !1), {
                node: a,
                id: a && a.getAttribute("data-requiremodule")
            }
        }

        function r() {
            var a;
            for (k(); J.length;) {
                if (a = J.shift(), null === a[0]) return j(C("mismatch", "Mismatched anonymous define() module: " + a[a.length - 1]));
                p(a)
            }
        }
        var s, w, x, y, A, D = {
                waitSeconds: 7,
                baseUrl: "./",
                paths: {},
                bundles: {},
                pkgs: {},
                shim: {},
                config: {}
            },
            E = {},
            F = {},
            I = {},
            J = [],
            K = {},
            L = {},
            O = {},
            P = 1,
            S = 1;
        return y = {
            require: function(a) {
                return a.require ? a.require : a.require = x.makeRequire(a.map)
            },
            exports: function(a) {
                if (a.usingExports = !0, a.map.isDefine) return a.exports ? K[a.map.id] = a.exports : a.exports = K[a.map.id] = {}
            },
            module: function(a) {
                return a.module ? a.module : a.module = {
                    id: a.map.id,
                    uri: a.map.url,
                    config: function() {
                        return m(D.config, a.map.id) || {}
                    },
                    exports: a.exports || (a.exports = {})
                }
            }
        }, w = function(a) {
            this.events = m(I, a.id) || {}, this.map = a, this.shim = m(D.shim, a.id), this.depExports = [], this.depMaps = [], this.depMatched = [], this.pluginMaps = {}, this.depCount = 0
        }, w.prototype = {
            init: function(a, b, c, d) {
                d = d || {}, this.inited || (this.factory = b, c ? this.on("error", c) : this.events.error && (c = u(this, function(a) {
                    this.emit("error", a)
                })), this.depMaps = a && a.slice(0), this.errback = c, this.inited = !0, this.ignore = d.ignore, d.enabled || this.enabled ? this.enable() : this.check())
            },
            defineDep: function(a, b) {
                this.depMatched[a] || (this.depMatched[a] = !0, this.depCount -= 1, this.depExports[a] = b)
            },
            fetch: function() {
                if (!this.fetched) {
                    this.fetched = !0, x.startTime = (new Date).getTime();
                    var a = this.map;
                    if (!this.shim) return a.prefix ? this.callPlugin() : this.load();
                    x.makeRequire(this.map, {
                        enableBuildCallback: !0
                    })(this.shim.deps || [], u(this, function() {
                        return a.prefix ? this.callPlugin() : this.load()
                    }))
                }
            },
            load: function() {
                var a = this.map.url;
                L[a] || (L[a] = !0, x.load(this.map.id, a))
            },
            check: function() {
                if (this.enabled && !this.enabling) {
                    var a, b, c = this.map.id;
                    b = this.depExports;
                    var d = this.exports,
                        e = this.factory;
                    if (this.inited) {
                        if (this.error) this.emit("error", this.error);
                        else if (!this.defining) {
                            if (this.defining = !0, 1 > this.depCount && !this.defined) {
                                if (G(e)) {
                                    if (this.events.error && this.map.isDefine || g.onError !== ca) try {
                                        d = x.execCb(c, e, b, d)
                                    } catch (b) {
                                        a = b
                                    } else d = x.execCb(c, e, b, d);
                                    if (this.map.isDefine && void 0 === d && ((b = this.module) ? d = b.exports : this.usingExports && (d = this.exports)), a) return a.requireMap = this.map, a.requireModules = this.map.isDefine ? [this.map.id] : null, a.requireType = this.map.isDefine ? "define" : "require", j(this.error = a)
                                } else d = e;
                                this.exports = d, this.map.isDefine && !this.ignore && (K[c] = d, g.onResourceLoad) && g.onResourceLoad(x, this.map, this.depMaps), l(c), this.defined = !0
                            }
                            this.defining = !1, this.defined && !this.defineEmitted && (this.defineEmitted = !0, this.emit("defined", this.exports), this.defineEmitComplete = !0)
                        }
                    } else this.fetch()
                }
            },
            callPlugin: function() {
                var a = this.map,
                    c = a.id,
                    d = f(a.prefix);
                this.depMaps.push(d), i(d, "defined", u(this, function(d) {
                    var e, k;
                    k = m(O, this.map.id);
                    var n = this.map.name,
                        o = this.map.parentMap ? this.map.parentMap.name : null,
                        p = x.makeRequire(a.parentMap, {
                            enableBuildCallback: !0
                        });
                    this.map.unnormalized ? (d.normalize && (n = d.normalize(n, function(a) {
                        return b(a, o, !0)
                    }) || ""), d = f(a.prefix + "!" + n, this.map.parentMap), i(d, "defined", u(this, function(a) {
                        this.init([], function() {
                            return a
                        }, null, {
                            enabled: !0,
                            ignore: !0
                        })
                    })), (k = m(E, d.id)) && (this.depMaps.push(d), this.events.error && k.on("error", u(this, function(a) {
                        this.emit("error", a)
                    })), k.enable())) : k ? (this.map.url = x.nameToUrl(k), this.load()) : (e = u(this, function(a) {
                        this.init([], function() {
                            return a
                        }, null, {
                            enabled: !0
                        })
                    }), e.error = u(this, function(a) {
                        this.inited = !0, this.error = a, a.requireModules = [c], B(E, function(a) {
                            0 === a.map.id.indexOf(c + "_unnormalized") && l(a.map.id)
                        }), j(a)
                    }), e.fromText = u(this, function(b, d) {
                        var i = a.name,
                            k = f(i),
                            l = M;
                        d && (b = d), l && (M = !1), h(k), t(D.config, c) && (D.config[i] = D.config[c]);
                        try {
                            g.exec(b)
                        } catch (a) {
                            return j(C("fromtexteval", "fromText eval for " + c + " failed: " + a, a, [c]))
                        }
                        l && (M = !0), this.depMaps.push(k), x.completeLoad(i), p([i], e)
                    }), d.load(a.name, p, e, D))
                })), x.enable(d, this), this.pluginMaps[d.id] = d
            },
            enable: function() {
                F[this.map.id] = this, this.enabling = this.enabled = !0, v(this.depMaps, u(this, function(a, b) {
                    var c, d;
                    if ("string" == typeof a) {
                        if (a = f(a, this.map.isDefine ? this.map : this.map.parentMap, !1, !this.skipMap), this.depMaps[b] = a, c = m(y, a.id)) return void(this.depExports[b] = c(this));
                        this.depCount += 1, i(a, "defined", u(this, function(a) {
                            this.defineDep(b, a), this.check()
                        })), this.errback && i(a, "error", u(this, this.errback))
                    }
                    c = a.id, d = E[c], !t(y, c) && d && !d.enabled && x.enable(a, this)
                })), B(this.pluginMaps, u(this, function(a) {
                    var b = m(E, a.id);
                    b && !b.enabled && x.enable(a, this)
                })), this.enabling = !1, this.check()
            },
            on: function(a, b) {
                var c = this.events[a];
                c || (c = this.events[a] = []), c.push(b)
            },
            emit: function(a, b) {
                v(this.events[a], function(a) {
                    a(b)
                }), "error" === a && delete this.events[a]
            }
        }, x = {
            config: D,
            contextName: a,
            registry: E,
            defined: K,
            urlFetched: L,
            defQueue: J,
            Module: w,
            makeModuleMap: f,
            nextTick: g.nextTick,
            onError: j,
            configure: function(a) {
                a.baseUrl && "/" !== a.baseUrl.charAt(a.baseUrl.length - 1) && (a.baseUrl += "/");
                var b = D.shim,
                    c = {
                        paths: !0,
                        bundles: !0,
                        config: !0,
                        map: !0
                    };
                B(a, function(a, b) {
                    c[b] ? (D[b] || (D[b] = {}), U(D[b], a, !0, !0)) : D[b] = a
                }), a.bundles && B(a.bundles, function(a, b) {
                    v(a, function(a) {
                        a !== b && (O[a] = b)
                    })
                }), a.shim && (B(a.shim, function(a, c) {
                    H(a) && (a = {
                        deps: a
                    }), !a.exports && !a.init || a.exportsFn || (a.exportsFn = x.makeShimExports(a)), b[c] = a
                }), D.shim = b), a.packages && v(a.packages, function(a) {
                    var b, a = "string" == typeof a ? {
                        name: a
                    } : a;
                    b = a.name, a.location && (D.paths[b] = a.location), D.pkgs[b] = a.name + "/" + (a.main || "main").replace(ia, "").replace(Q, "")
                }), B(E, function(a, b) {
                    !a.inited && !a.map.unnormalized && (a.map = f(b))
                }), (a.deps || a.callback) && x.require(a.deps || [], a.callback)
            },
            makeShimExports: function(a) {
                return function() {
                    var b;
                    return a.init && (b = a.init.apply(ba, arguments)), b || a.exports && da(a.exports)
                }
            },
            makeRequire: function(d, e) {
                function i(b, c, k) {
                    var l, m;
                    return e.enableBuildCallback && c && G(c) && (c.__requireJsBuild = !0), "string" == typeof b ? G(c) ? j(C("requireargs", "Invalid require call"), k) : d && t(y, b) ? y[b](E[d.id]) : g.get ? g.get(x, b, d, i) : (l = f(b, d, !1, !0), l = l.id, t(K, l) ? K[l] : j(C("notloaded", 'Module name "' + l + '" has not been loaded yet for context: ' + a + (d ? "" : ". Use require([])")))) : (r(), x.nextTick(function() {
                        r(), m = h(f(null, d)), m.skipMap = e.skipMap, m.init(b, c, k, {
                            enabled: !0
                        }), o()
                    }), i)
                }
                return e = e || {}, U(i, {
                    isBrowser: z,
                    toUrl: function(a) {
                        var c, e = a.lastIndexOf("."),
                            f = a.split("/")[0];
                        return -1 !== e && ("." !== f && ".." !== f || 1 < e) && (c = a.substring(e, a.length), a = a.substring(0, e)), x.nameToUrl(b(a, d && d.id, !0), c, !0)
                    },
                    defined: function(a) {
                        return t(K, f(a, d, !1, !0).id)
                    },
                    specified: function(a) {
                        return a = f(a, d, !1, !0).id, t(K, a) || t(E, a)
                    }
                }), d || (i.undef = function(a) {
                    k();
                    var b = f(a, d, !0),
                        e = m(E, a);
                    c(a), delete K[a], delete L[b.url], delete I[a], T(J, function(b, c) {
                        b[0] === a && J.splice(c, 1)
                    }), e && (e.events.defined && (I[a] = e.events), l(a))
                }), i
            },
            enable: function(a) {
                m(E, a.id) && h(a).enable()
            },
            completeLoad: function(a) {
                var b, c, e = m(D.shim, a) || {},
                    f = e.exports;
                for (k(); J.length;) {
                    if (c = J.shift(), null === c[0]) {
                        if (c[0] = a, b) break;
                        b = !0
                    } else c[0] === a && (b = !0);
                    p(c)
                }
                if (c = m(E, a), !b && !t(K, a) && c && !c.inited) {
                    if (D.enforceDefine && (!f || !da(f))) return d(a) ? void 0 : j(C("nodefine", "No define call for " + a, null, [a]));
                    p([a, e.deps || [], e.exportsFn])
                }
                o()
            },
            nameToUrl: function(a, b, c) {
                var d, e, f;
                if ((d = m(D.pkgs, a)) && (a = d), d = m(O, a)) return x.nameToUrl(d, b, c);
                if (g.jsExtRegExp.test(a)) d = a + (b || "");
                else {
                    for (d = D.paths, a = a.split("/"), e = a.length; 0 < e; e -= 1)
                        if (f = a.slice(0, e).join("/"), f = m(d, f)) {
                            H(f) && (f = f[0]), a.splice(0, e, f);
                            break
                        }
                    d = a.join("/"), d += b || (/^data\:|\?/.test(d) || c ? "" : ".js"), d = ("/" === d.charAt(0) || d.match(/^[\w\+\.\-]+:/) ? "" : D.baseUrl) + d
                }
                return D.urlArgs ? d + (-1 === d.indexOf("?") ? "?" : "&") + D.urlArgs : d
            },
            load: function(a, b) {
                g.load(x, a, b)
            },
            execCb: function(a, b, c, d) {
                return b.apply(d, c)
            },
            onScriptLoad: function(a) {
                ("load" === a.type || ja.test((a.currentTarget || a.srcElement).readyState)) && (N = null, a = q(a), x.completeLoad(a.id))
            },
            onScriptError: function(a) {
                var b = q(a);
                if (!d(b.id)) return j(C("scripterror", "Script error for: " + b.id, a, [b.id]))
            }
        }, x.require = x.makeRequire(), x
    }
    var g, x, y, D, I, E, N, J, s, O, ka = /(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,
        la = /[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,
        Q = /\.js$/,
        ia = /^\.\//;
    x = Object.prototype;
    var K = x.toString,
        fa = x.hasOwnProperty,
        ha = Array.prototype.splice,
        z = !("undefined" == typeof window || "undefined" == typeof navigator || !window.document),
        ea = !z && "undefined" != typeof importScripts,
        ja = z && "PLAYSTATION 3" === navigator.platform ? /^complete$/ : /^(complete|loaded)$/,
        Y = "undefined" != typeof opera && "[object Opera]" === opera.toString(),
        F = {},
        q = {},
        R = [],
        M = !1;
    if (void 0 === define) {
        if (void 0 !== requirejs) {
            if (G(requirejs)) return;
            q = requirejs, requirejs = void 0
        }
        void 0 !== require && !G(require) && (q = require, require = void 0), g = requirejs = function(a, b, c, d) {
            var e, f = "_";
            return !H(a) && "string" != typeof a && (e = a, H(b) ? (a = b, b = c, c = d) : a = []), e && e.context && (f = e.context), (d = m(F, f)) || (d = F[f] = g.s.newContext(f)), e && d.configure(e), d.require(a, b, c)
        }, g.config = function(a) {
            return g(a)
        }, g.nextTick = "undefined" != typeof setTimeout ? function(a) {
            setTimeout(a, 4)
        } : function(a) {
            a()
        }, require || (require = g), g.version = "2.1.15", g.jsExtRegExp = /^\/|:|\?|\.js$/, g.isBrowser = z, x = g.s = {
            contexts: F,
            newContext: ga
        }, g({}), v(["toUrl", "undef", "defined", "specified"], function(a) {
            g[a] = function() {
                var b = F._;
                return b.require[a].apply(b, arguments)
            }
        }), z && (y = x.head = document.getElementsByTagName("head")[0], D = document.getElementsByTagName("base")[0]) && (y = x.head = D.parentNode), g.onError = ca, g.createNode = function(a) {
            var b = a.xhtml ? document.createElementNS("http://www.w3.org/1999/xhtml", "html:script") : document.createElement("script");
            return b.type = a.scriptType || "text/javascript", b.charset = "utf-8", b.async = !0, b
        }, g.load = function(a, b, c) {
            var d = a && a.config || {};
            if (z) return d = g.createNode(d, b, c), d.setAttribute("data-requirecontext", a.contextName), d.setAttribute("data-requiremodule", b), !d.attachEvent || d.attachEvent.toString && 0 > d.attachEvent.toString().indexOf("[native code") || Y ? (d.addEventListener("load", a.onScriptLoad, !1), d.addEventListener("error", a.onScriptError, !1)) : (M = !0, d.attachEvent("onreadystatechange", a.onScriptLoad)), d.src = c, J = d, D ? y.insertBefore(d, D) : y.appendChild(d), J = null, d;
            if (ea) try {
                importScripts(c), a.completeLoad(b)
            } catch (d) {
                a.onError(C("importscripts", "importScripts failed for " + b + " at " + c, d, [b]))
            }
        }, z && !q.skipDataMain && T(document.getElementsByTagName("script"), function(a) {
            if (y || (y = a.parentNode), I = a.getAttribute("data-main")) return s = I, q.baseUrl || (E = s.split("/"), s = E.pop(), O = E.length ? E.join("/") + "/" : "./", q.baseUrl = O), s = s.replace(Q, ""), g.jsExtRegExp.test(s) && (s = I), q.deps = q.deps ? q.deps.concat(s) : [s], !0
        }), define = function(a, b, c) {
            var d, e;
            "string" != typeof a && (c = b, b = a, a = null), H(b) || (c = b, b = null), !b && G(c) && (b = [], c.length && (c.toString().replace(ka, "").replace(la, function(a, c) {
                b.push(c)
            }), b = (1 === c.length ? ["require"] : ["require", "exports", "module"]).concat(b))), M && ((d = J) || (N && "interactive" === N.readyState || T(document.getElementsByTagName("script"), function(a) {
                if ("interactive" === a.readyState) return N = a
            }), d = N), d && (a || (a = d.getAttribute("data-requiremodule")), e = F[d.getAttribute("data-requirecontext")])), (e ? e.defQueue : R).push([a, b, c])
        }, define.amd = {
            jQuery: !0
        }, g.exec = function(b) {
            return eval(b)
        }, g(q)
    }
}(this), define("vendor/require.js", function() {}), define("colors", [], function() {
    "use strict";
    var a = {};
    a.rgb = {};
    var b = a.rgb;
    a.rgb.fromValues = function(a, b, c, d) {
        var e = new Array(4);
        return e[0] = a, e[1] = b, e[2] = c, e[3] = d, e
    }, a.rgb.mix = function(a, b, c, d) {
        var e = 1 - d;
        return a[0] = b[0] * d + c[0] * e, a[1] = b[1] * d + c[1] * e, a[2] = b[2] * d + c[2] * e, a[3] = b[3] * d + c[3] * e, a
    }, a.rgb.hex2rgb = function(a) {
        var c, d, e, f;
        if (4 === a.length || 5 === a.length) {
            c = parseInt(a[1], 16), d = parseInt(a[2], 16), e = parseInt(a[3], 16), f = 15, 5 === a.length && (f = parseInt(a[4], 16));
            var g = 1 / 15;
            return b.fromValues(g * c, g * d, g * e, g * f)
        }
        if (7 === a.length || 9 === a.length) {
            c = parseInt(a.substr(1, 2), 16), d = parseInt(a.substr(3, 2), 16), e = parseInt(a.substr(5, 2), 16), f = 255, 9 === a.length && (f = parseInt(a.substr(7, 2), 16));
            var h = 1 / 255;
            return b.fromValues(h * c, h * d, h * e, h * f)
        }
    };
    var c = {
            white: b.fromValues(1, 1, 1, 1),
            black: b.fromValues(0, 0, 0, 1),
            grey: b.fromValues(.5, .5, .5, 1),
            lightgrey: b.fromValues(.8, .8, .8, 1),
            darkgrey: b.fromValues(.3, .3, .3, 1),
            red: b.hex2rgb("#AA00A2"),
            darkred: b.hex2rgb("#7F207B"),
            lightred: b.fromValues(1, .5, .5, 1),
            green: b.hex2rgb("#C9F600"),
            darkgreen: b.hex2rgb("#9FB82E"),
            lightgreen: b.hex2rgb("#E1FA71"),
            blue: b.hex2rgb("#6A93D4"),
            darkblue: b.hex2rgb("#284A7E"),
            lightblue: b.fromValues(.5, .5, 1, 1),
            yellow: b.hex2rgb("#FFCC73"),
            darkyellow: b.fromValues(.5, .5, 0, 1),
            lightyellow: b.fromValues(1, 1, .5, 1),
            cyan: b.fromValues(0, 1, 1, 1),
            darkcyan: b.fromValues(0, .5, .5, 1),
            lightcyan: b.fromValues(.5, 1, 1, 1),
            magenta: b.fromValues(1, 0, 1, 1),
            darkmagenta: b.fromValues(.5, 0, .5, 1),
            lightmagenta: b.fromValues(1, .5, 1, 1),
            orange: b.hex2rgb("#FFA200"),
            darkorange: b.fromValues(.5, .25, 0, 1),
            lightorange: b.fromValues(1, .75, .5, 1),
            brown: b.hex2rgb("#A66A00"),
            purple: b.hex2rgb("#D435CD")
        },
        d = [{
            color: "#f0f0f0",
            darkercolor: "#c0c0c0",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#d9d9d9",
            darkercolor: "#aeaeae",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#bdbdbd",
            darkercolor: "#979797",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#969696",
            darkercolor: "#787878",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#737373",
            darkercolor: "#5c5c5c",
            lightercolor: "#c4c4c4",
            textcolor: "white"
        }, {
            color: "#525252",
            darkercolor: "#424242",
            lightercolor: "#8b8b8b",
            textcolor: "white"
        }, {
            color: "#252525",
            darkercolor: "#1e1e1e",
            lightercolor: "#3f3f3f",
            textcolor: "white"
        }],
        e = [{
            color: "#a6cee3",
            darkercolor: "#85a5b6",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#1f78b4",
            darkercolor: "#196090",
            lightercolor: "#35ccff",
            textcolor: "white"
        }, {
            color: "#b2df8a",
            darkercolor: "#8eb26e",
            lightercolor: "#ffffeb",
            textcolor: "black"
        }, {
            color: "#33a02c",
            darkercolor: "#298023",
            lightercolor: "#57ff4b",
            textcolor: "black"
        }, {
            color: "#fb9a99",
            darkercolor: "#c97b7a",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#e31a1c",
            darkercolor: "#b61516",
            lightercolor: "#ff2c30",
            textcolor: "black"
        }, {
            color: "#fdbf6f",
            darkercolor: "#ca9959",
            lightercolor: "#ffffbd",
            textcolor: "black"
        }, {
            color: "#ff7f00",
            darkercolor: "#cc6600",
            lightercolor: "#ffd800",
            textcolor: "black"
        }, {
            color: "#cab2d6",
            darkercolor: "#a28eab",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#6a3d9a",
            darkercolor: "#55317b",
            lightercolor: "#b468ff",
            textcolor: "white"
        }],
        f = [{
            color: "#d73027",
            darkercolor: "#ac261f",
            lightercolor: "#ff5242",
            textcolor: "white"
        }, {
            color: "#f46d43",
            darkercolor: "#c35736",
            lightercolor: "#ffb972",
            textcolor: "black"
        }, {
            color: "#abd9e9",
            darkercolor: "#89aeba",
            lightercolor: "#ffffff",
            textcolor: "black"
        }, {
            color: "#74add1",
            darkercolor: "#5d8aa7",
            lightercolor: "#c5ffff",
            textcolor: "black"
        }],
        g = [{
            color: "#ff7f00",
            darkercolor: "#cc6600",
            lightercolor: "#ffd800",
            textcolor: "black"
        }];
    return a.rgb.getBWPalette = function() {
        return d
    }, a.rgb.getPairedColorPalette = function() {
        return e
    }, a.rgb.getRedBluePalette = function() {
        return f
    }, a.rgb.getDomainColors = function() {
        return g
    }, a.rgb.componentToHex = function(a) {
        var b = a.toString(16);
        return 1 === b.length ? "0" + b : b
    }, a.rgb.rgb2hex = function(b) {
        if (3 === b.length) {
            var c = b[0],
                d = b[1],
                e = b[2];
            return "#" + a.rgb.componentToHex(c) + a.rgb.componentToHex(d) + a.rgb.componentToHex(e)
        }
        if (4 === b.length || 5 === b.length) {
            var f = b[0],
                g = b[1],
                h = b[2];
            return 4 === b.length && b[3], "#" + a.rgb.componentToHex(255 * f) + a.rgb.componentToHex(255 * g) + a.rgb.componentToHex(255 * h)
        }
        return "#000000"
    }, a.shadeRGBColor = function(a, b) {
        var c = a,
            d = b < 0 ? 0 : 255,
            e = b < 0 ? -1 * b : b,
            f = parseInt(c[0]),
            g = parseInt(c[1]),
            h = parseInt(c[2]);
        return "rgb(" + (Math.round((d - f) * e) + f) + "," + (Math.round((d - g) * e) + g) + "," + (Math.round((d - h) * e) + h) + ")"
    }, a.blendRGBColors = function(a, b, c) {
        var d = a.split(","),
            e = b.split(","),
            f = parseInt(d[0].slice(4)),
            g = parseInt(d[1]),
            h = parseInt(d[2]);
        return "rgb(" + (Math.round((parseInt(e[0].slice(4)) - f) * c) + f) + "," + (Math.round((parseInt(e[1]) - g) * c) + g) + "," + (Math.round((parseInt(e[2]) - h) * c) + h) + ")"
    }, a.setColorPalette = function(b) {
        c = b, a.initGradients()
    }, a.forceRGB = function(b) {
        if ("string" == typeof b) {
            var d = c[b];
            if (void 0 !== d) return d;
            if (b.length > 0 && "#" === b[0]) return a.hex2rgb(b)
        }
        return 3 === b.length ? [b[0], b[1], b[2], 1] : b
    }, a.forceHex = function(b) {
        var d = c[b];
        if (void 0 !== d) return a.rgb.rgb2hex(d)
    }, a
}), define("params", ["colors"], function(a) {
    function b() {
        this.textLeft = 20, this.leftBorder = 130, this.bottomBorder = 15, this.trackHeight = 10, this.trackHeightCharts = 20, this.rightBorder = 10, this.maxTracksSingleMode = 10, this.maxTextSize = 10, this.scale = -1, this.y = 0, this.maxY = 0, this.baseLineHeight = 3, this.bw_colors = a.rgb.getBWPalette(), this.paired_colors = a.rgb.getPairedColorPalette(), this.domain_colors = a.rgb.getDomainColors(), this.redblue_colors = a.rgb.getRedBluePalette().reverse(), this.customColors = [], this.customColors.push(this.paired_colors[0]), this.customColors.push(this.paired_colors[1]), this.customColors.push(this.paired_colors[8]), this.customColors.push(this.paired_colors[9]), this.homColors = [], this.homColors.push(this.paired_colors[5]), this.homColors.push(this.paired_colors[4]), this.up_colors = [], this.up_colors.push(this.paired_colors[2]), this.up_colors.push(this.paired_colors[3]), this.expressionTagColor = a.rgb.getDomainColors()[0], this.conflictColor = a.rgb.getRedBluePalette()[a.rgb.getRedBluePalette().length - 1], this.deletionColor = this.paired_colors[6]
    }
    return {
        Params: function() {
            return new b
        }
    }
}), define("icons", [], function() {
    function a() {
        this.eye = "m 1664,576 q -152,236 -381,353 61,-104 61,-225 0,-185 -131.5,-316.5 Q 1081,256 896,256 711,256 579.5,387.5 448,519 448,704 448,825 509,929 280,812 128,576 261,371 461.5,249.5 662,128 896,128 1130,128 1330.5,249.5 1531,371 1664,576 z M 944,960 q 0,20 -14,34 -14,14 -34,14 -125,0 -214.5,-89.5 Q 592,829 592,704 q 0,-20 14,-34 14,-14 34,-14 20,0 34,14 14,14 14,34 0,86 61,147 61,61 147,61 20,0 34,14 14,14 14,34 z m 848,-384 q 0,-34 -20,-69 Q 1632,277 1395.5,138.5 1159,0 896,0 633,0 396.5,139 160,278 20,507 0,542 0,576 q 0,34 20,69 140,229 376.5,368 236.5,139 499.5,139 263,0 499.5,-139 236.5,-139 376.5,-368 20,-35 20,-69 z"
    }
    return {
        Icons: function() {
            return new a
        }
    }
}), define("popups", [], function() {
    function a() {}
    return a.prototype.init = function(a, b) {
        this.viewer = a, this.rcsbServer = b
    }, a.prototype.showSequenceDialog = function(a) {
        var b = this.viewer.data,
            c = this.viewer.getSVGWrapper(),
            d = $(c.root()).offset(),
            e = a.pageX - d.left,
            f = this.viewer.drawer.screen2Seq(e) - 1;
        f > this.viewer.data.sequence.length && (f = -1);
        var g = this.viewer.getPdbPositions(f);
        "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showSequenceDialog", b.uniprotID);
        var h = "";
        h += this.viewer.showPdb3dLinks(g), this.viewer.singlePDBmode ? (h += "<h3>" + b.uniprotID + "-" + b.name + "</h3>", h += "Show All <a href='" + this.rcsbServer + "/pdb/protein/" + b.uniprotID + "'>PDB-UniProtKB mappings</a> that are available for " + b.uniprotID) : (h += "<h3>Search RCSB PDB</h3>", h += "<ul><li><a href='" + this.rcsbServer + "/pdb/search/smartSubquery.do?smartSearchSubtype=UpAccessionIdQuery&accessionIdList=" + b.uniprotID + "'>Show All PDB chains</a> that are linked to UniProtKB ID <b>" + b.uniprotID + "</b> - " + b.name + ' ?</li> <li>View UniProtKB record for <a href="http://www.uniprot.org/uniprot/' + b.uniprotID + '"  target="_new">' + b.uniprotID + "<span class='iconSet-main icon-external'> &nbsp;</span></a></li>", h += "</ul>");
        var i = b.uniprotID + " - " + b.name;
        this.viewer.doModal(this.viewer.dialogDiv, i, h, "", ""), this.viewer.registerPdb3dLinks(g)
    }, a.prototype.blastPopup = function(a, b, c, d, e, f) {
        var g = "";
        if (g += this.viewer.showPdb3dLinks(f, "blast"), g += "<h3>Search RCSB PDB</h3>", g += "<ul>", "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showUniProtDialog", e), g += "<li>Perform a <a href='" + this.rcsbServer + "/pdb/search/smart.do?chainId_0=&eCutOff_0=0.001&maskLowComplexity_0=yes&searchTool_0=blast&smartComparator=and&smartSearchSubtype_0=SequenceQuery&structureId_0=&target=Current&sequence_0=" + a + "'>Blast sequence search against PDB</a> using this sequence region.</li>", void 0 !== b) {
            var h = d;
            void 0 !== c && (h = "Show " + c + " PDB entries that contain " + d + " from " + this.viewer.data.uniprotID), g += '<li><a href="' + b + '">' + h + "</a></li>"
        }
        return g += "</ul>"
    }, a.prototype.sequenceMotifPopup = function(a, b, c) {
        var d = "";
        return d += this.viewer.showPdb3dLinks(c), d += "<h3>" + b + "</h3>", d += "<ul>", "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showSeqMotifDialog", b), d += "<li>Perform a <a href='" + this.rcsbServer + "/pdb/search/smart.do?&smartSearchSubtype_0=MotifQuery&target=Current&motif_0=" + a + "'>Sequence Motif Search</a>.</li>", d += "</ul>"
    }, a.prototype.clickUpSiteMethod = function(a, b) {
        var c = b.target || b.toElement,
            d = c.title;
        void 0 === d && (d = $(c).attr("data-original-title")), "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "clickUPSite", this.viewer.data.uniprotID);
        var e = d,
            f = this.viewer.getPdbPositions(a.start - 1, a.end - 1);
        e += this.viewer.showPdb3dLinks(f), this.viewer.doModal(this.viewer.dialogDiv, "UP Sites", e, "", ""), this.viewer.registerPdb3dLinks(f)
    }, a.prototype.clickPhosphoMethod = function(a, b) {
        var c = b.target || b.toElement,
            d = c.title;
        void 0 === d && (d = $(c).attr("data-original-title"));
        var e = d;
        this.viewer.highlight(a.start - 1, a.end - 1);
        var f = this.viewer.getPdbPositions(a.start - 1, a.end - 1);
        e += this.viewer.showPdb3dLinks(f), "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "clickPhosphoSite", this.viewer.data.uniprotID), e += "<h3>PhosphoSitePlus</h3>", e += "<ul>", e += "<li>Show at <a target='_new'' href='http://www.phosphosite.org/proteinSearchSubmitAction.do?accessionIds=" + this.viewer.data.uniprotID + "'>PhosphoSitePlus website</a></li>", e += "</ul>", this.viewer.doModal(this.viewer.dialogDiv, "Phosphosite", e, "", ""), this.viewer.registerPdb3dLinks(f)
    }, a.prototype.callbackec = function(a) {
        var b = this.viewer.rcsbServer + "/pdb/search/smartSubquery.do?smartSearchSubtype=EnzymeClassificationQuery&Enzyme_Classification=",
            c = "<h3>" + a.name + " - " + a.desc + "</h3>";
        c += "<ul><li>View in <a href='http://www.brenda-enzymes.org/php/result_flat.php4?ecno=" + a.name + "' target='_new'>BRENDA</a></li>", c += "<li>View <a href='" + b + a.name + "'>other PDB entries with the same E.C. number</a></li>", c += "</ul>", "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showECDialog", a.name);
        var d = a.name + " - " + a.desc;
        this.viewer.doModal(this.viewer.dialogDiv, d, c, "", "")
    }, a.prototype.callbackSecStruc = function(a) {
        var b = a.name;
        a.name !== a.desc && (b += " - " + a.desc);
        var c = this.viewer.getPdbPositions(a.start, a.end),
            d = this.viewer.showPdb3dLinks(c, "secstruc"),
            e = "<h1>" + b + "</h1>";
        this.viewer.doModal(this.viewer.dialogDiv, e, d, "", ""), this.viewer.registerPdb3dLinks(c, "secstruc")
    }, a.prototype.callbackUniProtFeature = function(a) {
        var b = a.name;
        a.name !== a.desc && (b += " - " + a.desc);
        var c = this.viewer.getPdbPositions(a.start - 1, a.end - 1),
            d = "";
        if ("short sequence motif" === a.name) {
            var e = a.desc.split(" ");
            2 === e.length && (d = this.popup.sequenceMotifPopup(e[0], b, a.start, a.end))
        }
        if ("" === d) {
            var f = this.viewer.getData().sequence.substr(a.start, a.end - a.start + 1);
            d = this.popups.blastPopup(f, a.url, a.hits, a.desc, b, c)
        }
        var g = "<h1>" + b + "</h1>";
        this.viewer.doModal(this.viewer.dialogDiv, g, d, "", ""), this.viewer.registerPdb3dLinks(c, "blast")
    }, a.prototype.scopcallback = function(a) {
        var b = a.name;
        a.name !== a.desc && (b += " - " + a.desc, void 0 !== a.note && (b += " (" + a.note + ")"));
        var c = "",
            d = this.viewer.getPdbPositions(a.start - 1, a.end - 1);
        c += this.viewer.showPdb3dLinks(d, "scop"), c += "<h3>" + b + "</h3>", c += "<ul>", "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showSCOPeDialog", b), c += "<li>Show at <a target='_new'' href='http://scop.mrc-lmb.cam.ac.uk/scop/search.cgi?ver=1.75&key=" + a.name + "'>SCOP website</a></li>", c += "</ul>";
        var e = b;
        this.viewer.doModal(this.viewer.dialogDiv, e, c, "", ""), this.viewer.registerPdb3dLinks(d, "scop")
    }, a.prototype.scopecallback = function() {
        var a = this.name;
        this.name !== this.desc && (a += " - " + this.desc, void 0 !== this.note && (a += " (" + this.note + ")"));
        var b = "<h1>" + a + "</h1>";
        b += "<ul>", "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showSCOPeDialog", a), b += "<li>Show at <a target='_new'' href='http://scop.berkeley.edu/sccs=" + this.name + "'>SCOPe website</a></li>", b += "</ul>";
        var c = a;
        this.viewer.doModal(this.viewer.dialogDiv, c, b, "", "")
    }, a.prototype.showPfamDialog = function(a) {
        var b = a.acc,
            c = a.desc;
        "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showPfamDialog", b);
        var d = "",
            e = this.viewer.getPdbPositions(a.start - 1, a.end - 1);
        d += this.viewer.showPdb3dLinks(e), d += "<h3> " + c + '</h3><ul><li>Go to Pfam site for <a href="http://pfam.xfam.org/family/' + b + '" target="_new">' + b + "<span class='iconSet-main icon-external'> &nbsp;</span> </a></li>", d += "<li>Find <a href='" + this.rcsbServer + "/pdb/search/smartSubquery.do?smartSearchSubtype=PfamIdQuery&amp;pfamID=" + b + "'>other PDB entries with the same Pfam domain</a></li>", d += "</ul>";
        var f = b + " - " + a.name;
        this.viewer.doModal(this.viewer.dialogDiv, f, d, "", ""), this.viewer.registerPdb3dLinks(e)
    }, a.prototype.showExonDialog = function(a) {
        var b = a.acc,
            c = a.desc;
        "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showExonDialog", b);
        var d = "<h1> Exon " + c + "</h1>",
            e = this.viewer.getPdbPositions(a.start - 1, a.end - 1);
        d += this.viewer.showPdb3dLinks(e), d += "<h3>RCSB PDB Gene View</h3>", d += '<ul><li>Go to RCSB Gene View for <a href="/pdb/gene/' + b + '" target="_new">' + b + " </a></li>", d += "</ul>";
        var f = b + " - " + a.name;
        this.viewer.doModal(this.viewer.dialogDiv, f, d, "", ""), this.viewer.registerPdb3dLinks(e)
    }, a.prototype.clickVariationMethod = function(a, b) {
        var c = b.target || b.toElement,
            d = c.title;
        void 0 === d && (d = $(c).attr("data-original-title")), "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "clickVariationSNP", this.viewer.data.uniprotID);
        var e = d,
            f = this.viewer.getPdbPositions(a.start - 1, a.end - 1);
        e += this.viewer.showPdb3dLinks(f);
        var g = $(c).data("extLinks");
        if (void 0 !== g && "" !== g && g.length > 0) {
            e += "<ul>";
            for (var h = 0; h < g.length; h++) {
                var i = g[h];
                void 0 !== i && "" !== i && "undefined" !== i.sitename && "" !== i.sitename && "undefined" !== i.siteurl && "" !== i.siteurl && (e += "<li>Show at <a target='_new'' href='" + i.siteurl + "'>" + i.sitename + "</a></li>")
            }
            e += "</ul>"
        }
        this.viewer.doModal(this.viewer.dialogDiv, "Variation", e, "", ""), this.viewer.registerPdb3dLinks(f)
    }, a.prototype.showDialog = function(a, b) {
        if (void 0 !== a) {
            var c = a.pdbID.trim(),
                d = a.desc;
            "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showPDBDialog", d);
            var e = "<span><img width='240' src='" + this.viewer.rcsbServer + "/pdb/images/" + c.toLowerCase() + "_bio_r_250.jpg?getBest=true' /></span>",
                f = this.viewer.getSVGWrapper(),
                g = $(f.root()).offset(),
                h = b.pageX - g.left,
                i = this.viewer.drawer.screen2Seq(h) - 1;
            i > this.viewer.data.sequence.length && (i = -1);
            var j = this.viewer.getPdbPositions(i),
                k = [],
                l = {};
            if (l.pdbId = a.pdbID, l.chainId = a.chainID, i >= 0)
                for (var m = 0; m < j.length; m++) {
                    var n = j[m];
                    if (n.pdbId === l.pdbId && n.chainId === l.chainId) {
                        l = n;
                        break
                    }
                }
            k.push(l), e += this.viewer.showPdb3dLinks(k, "uniprot"), e += "<h3>Search RCSB PDB</h3>", e += "<ul>", e += '<li><a href="' + this.viewer.rcsbServer + "/structure/" + c + '">Structure Summary Page for ' + c + "</a></li>", e += "</ul>";
            var o = "View " + c + " - " + d;
            this.viewer.doModal(this.viewer.dialogDiv, o, e, "", ""), this.viewer.registerPdb3dLinks(k, "uniprot")
        }
    }, {
        Popups: function() {
            return new a
        }
    }
}), define("draw", ["params", "colors", "icons", "popups"], function(a, b, c, d) {
    function e(b) {
        this.viewer = b, this.param = new a.Params, this.icons = new c.Icons, this.popups = new d.Popups, this.popups.init(this.viewer, this.viewer.rcsbServer), this.scale = 1, this.height = 15, this.maxY = 0
    }
    var f = {};
    return e.prototype.getParams = function() {
        return this.param
    }, e.prototype.getGroup = function(a) {
        return this.viewer.getSVGWrapper().group({
            id: a,
            "font-family": "Roboto",
            "font-weight": 700,
            fontSize: "10",
            fill: "black"
        })
    }, e.prototype.seq2Screen = function(a) {
        return this.param.leftBorder + Math.round(a * this.scale)
    }, e.prototype.screen2Seq = function(a) {
        return Math.round((a - this.param.leftBorder) / this.scale)
    }, e.prototype.drawRuler = function(a, b, c) {
        var d = 5,
            e = 2;
        a.rect(this.seq2Screen(0), c, b.length * this.scale, 1, {
            fill: "black"
        });
        for (var f = 0, g = 0; g < b.length; g++)(g + 1) % 50 == 0 && (g - f) * this.scale > 10 * (Math.log(g) / Math.log(10) + 1) ? (this.drawTick(a, g, c, d), f = g) : this.scale > 2 && ((g + 1) % 10 == 0 ? this.drawTick(a, g, c, e) : this.scale > 4 && (g + 1) % 5 == 0 && a.rect(this.seq2Screen(g), c, 1 * this.scale, 4, {
            fill: "black"
        }), this.scale > 8 && a.rect(this.seq2Screen(g), c, 1, 2, {
            fill: "black"
        }));
        return c + this.param.trackHeight + 10
    }, e.prototype.drawName = function(a, b, c, d, e, f) {
        var g = a.text(b, this.param.textLeft + 2, c + this.param.trackHeight - 1, d, {
            style: {
                "font-family": "RobotoSlab, sans-serif;",
                "font-weight": "900"
            }
        });
        void 0 !== e && ($(g).css("cursor", "pointer"), $(g).bind("click", function(a) {
            e(a, d)
        })), void 0 !== f && ($(g).attr("title", f), this.registerTooltip(g))
    }, e.prototype.drawSequence = function(a, b, c) {
        var d = this.param.trackHeight + 5;
        this.param.singlePDBmode && (d -= 5);
        var e = this.getGroup("sequenceTrack" + this.viewer.getData().uniprotID),
            f = a.group({
                fill: "lightgrey"
            }),
            g = a.group({
                fill: "#dcdcdc"
            });
        this.drawName(a, e, c, b.name, void 0, "UniProtKB sequence " + b.name);
        var h = a.group({
                id: "seqpos" + this.viewer.getData().uniprotID,
                fontWeight: "bold",
                fontSize: "10",
                fill: "black"
            }),
            i = a.defs();
        a.linearGradient(i, "sequence" + this.viewer.getData().uniprotID, [
            ["0%", "white"],
            ["100%", "black"]
        ], 0, c, 0, c + d, {
            gradientUnits: "userSpaceOnUse"
        });
        var j = a.rect(e, this.seq2Screen(0), c, b.length * this.scale, d, 4, 4, {
                fill: "url(#sequence" + this.viewer.getData().uniprotID + ")",
                stroke: "grey",
                strokeWidth: 1
            }),
            k = "UniProtKB sequence " + b.name + " - " + this.viewer.getData().name + " Length: " + this.viewer.getData().length;
        $(j).attr("title", k), this.registerTooltip(j), c += d;
        var l = b.name + " - " + this.viewer.getData().name + " - " + this.viewer.getData().desc,
            m = a.text(e, this.seq2Screen(1), c - this.param.trackHeight / 2, l, {
                fill: "black"
            });
        if (this.checkTxtLength(m, 1, b.length, l), $(m).attr("title", k), this.registerTooltip(m), this.scale >= 8) {
            for (var n = 0; n < b.length; n++) {
                (n + 1) % 10 == 0 ? a.rect(g, this.seq2Screen(n), c, 1 * this.scale, 10) : (n + 1) % 5 == 0 && a.rect(f, this.seq2Screen(n), c, 1 * this.scale, 10);
                var o = a.text(h, this.seq2Screen(n) + 1, c + this.param.trackHeight - 1, this.viewer.getData().sequence.charAt(n));
                $(o).attr("title", "Sequence position " + (n + 1) + " - " + this.viewer.getData().sequence.charAt(n)), this.registerTooltip(o)
            }
            c += this.param.trackHeight
        }
        return c + 5
    }, e.prototype.drawExpandCondensedSymbol = function(a, b, c, d) {
        var e = a.group({
                id: "expandCondensed" + this.viewer.getData().uniprotID,
                fontWeight: "bold",
                fontSize: "10",
                fill: "black"
            }),
            f = a.rect(e, this.param.textLeft - 5, b + 1, 2, this.param.trackHeight - 2, {
                fill: "black"
            });
        b += this.param.trackHeight;
        var g = a.createPath();
        a.path(e, g.move(this.param.textLeft - 4, b).line([
            [this.param.textLeft - 6, b - 4],
            [this.param.textLeft - 2, b - 4]
        ]).close(), {
            fill: "black",
            stroke: "black"
        }), b += 1;
        var h = a.circle(e, this.param.textLeft - 4, b + this.param.trackHeight, 8, {
                fill: "black",
                opacity: "0.2"
            }),
            i = a.text(e, this.param.textLeft - 8, b + 1.5 * this.param.trackHeight - 1, "+", {
                fontSize: "14",
                fill: "black",
                fontWeight: "bold"
            }),
            j = [];
        j.push(h), j.push(i), j.push(f);
        for (var k = 0; k < j.length; k++) {
            var l = j[k];
            this.registerTooltip(l, c), $(l).bind("click", $.proxy(d))
        }
        return b + 2 * this.param.trackHeight + 1
    }, e.prototype.drawCollapseCondensedSymbol = function(a, b) {
        var c = a.group({
            id: "expandCondensed" + this.viewer.getData().uniprotID,
            fontWeight: "bold",
            fontSize: "10",
            fill: "black"
        });
        b += 1;
        var d = a.circle(c, this.param.textLeft - 4, b + this.param.trackHeight, 8, {
                fill: "black",
                opacity: "0.2"
            }),
            e = a.text(c, this.param.textLeft - 7, b + 1.5 * this.param.trackHeight - 1, "-", {
                fontSize: "14",
                fill: "black",
                fontWeight: "bold"
            });
        b += 2.5 * this.param.trackHeight;
        var f = a.createPath();
        a.path(c, f.move(this.param.textLeft - 4, b - 4).line([
            [this.param.textLeft - 6, b],
            [this.param.textLeft - 2, b]
        ]).close(), {
            fill: "black",
            stroke: "black"
        });
        var g = a.rect(c, this.param.textLeft - 5, b, 2, this.param.trackHeight / 2, {
                fill: "black"
            }),
            h = "Currently showing all PDB matches. Click here to show only representatives.",
            i = [];
        i.push(d), i.push(e), i.push(f), i.push(g);
        for (var j = this, k = function() {
                j.viewer.setShowCondensed(!0), $("#showCondensed").text("Show All")
            }, l = 0; l < i.length; l++) {
            var m = i[l];
            $(m).attr("title", h), this.registerTooltip(m), $(m).bind("click", k)
        }
        return b + this.param.trackHeight / 2 + 1
    }, e.prototype.drawSourceIndication = function(a, b, c, d) {
        if (!(d - c < 2)) {
            var e = this.param.paired_colors,
                f = this.param.paired_colors[5].color,
                g = b;
            b.indexOf("Protein Model Portal") > -1 && (g = "PMP"), "UniProtKB" === b ? f = e[2].darkercolor : "PDB" === b || "validation" === b ? f = e[1].darkercolor : "Pfam" === b ? f = e[6].color : "Calculated" === b ? (g = "Calc", b = "Electronic annotation", f = "grey") : "Domains" === b ? (g = " ", f = e[7].color) : "Exon" === b ? f = e[8].color : "Phospho" === b && (f = e[9].color);
            var h = this.getGroup(b + this.viewer.getData().uniprotID);
            $(h).attr("font-weight", 900);
            var i = a.rect(h, 11, c, 10, d - c, {
                    fill: f,
                    stroke: f,
                    strokeWidth: 1
                }),
                j = "Data from: " + b;
            $(i).attr("title", j), this.registerTooltip(i);
            var k = "rotate(-90,10," + (d - this.param.trackHeight) + ")",
                l = a.text(h, 2, d - this.param.trackHeight + 10, g, {
                    transform: k,
                    fill: "black",
                    "fill-opacity": "0.8"
                });
            $(l).attr("title", j), this.registerTooltip(l)
        }
    }, e.prototype.drawSeparator = function(a, b) {
        var c = a.group({
            id: "separator",
            fontWeight: "bold",
            fontSize: "10",
            fill: "black"
        });
        return a.rect(c, this.param.textLeft, b + this.param.trackHeight / 4, Math.round(this.viewer.getSequence().length * this.scale) + this.leftBorder + this.rightBorder, 1, {
            fill: "black",
            stroke: "black",
            strokeWidth: 1
        }), b + this.param.trackHeight
    }, e.prototype.drawGenericTrack = function(a, b, c, d, e, f, g, h, i) {
        if (void 0 === b) return c;
        if (0 === b.length) return c;
        var j = 0,
            k = this.getGroup(d + this.viewer.getData().uniprotID);
        this.drawName(a, k, c, d, void 0, i);
        for (var l = 0; l < b.length; l++) {
            var m = b[l];
            if (void 0 !== m) {
                for (var n = [], o = 0; o < f.length; o++) {
                    var p = f[o],
                        q = a.defs();
                    a.linearGradient(q, e + "GR" + l + o + this.viewer.getData().uniprotID, [
                        ["0%", "white"],
                        ["100%", p.darkercolor]
                    ], 0, c, 0, c + this.param.trackHeight, {
                        gradientUnits: "userSpaceOnUse"
                    });
                    var r = this.getGroup(e + this.viewer.getData().uniprotID);
                    $(r).attr("fill", p.textcolor), n[o] = r
                }
                a: for (var s = 0; s < m.length; s++) try {
                    var t = m[s];
                    if (void 0 === t.desc) continue a;
                    if (-1 === e.indexOf("scop")) {
                        if (t.desc.indexOf("Cytoplasmic") > -1) {
                            this.drawCytoplasmic(c, a, t, e);
                            continue a
                        }
                        if (t.desc.indexOf("Periplasmic") > -1 || t.desc.indexOf("Extracellular") > -1 || t.desc.indexOf("Lumenal") > -1) {
                            this.drawPeriplasmic(c, a, t, e);
                            continue a
                        }
                        if (t.name.indexOf("transmembrane") > -1) {
                            this.drawTransmembrane(c, a, t, e);
                            continue a
                        }
                        if (t.name.indexOf("intramembrane") > -1) {
                            this.drawIntramembrane(c, a, t, e);
                            continue a
                        }
                    }
                    j++, j >= f.length && (j = 0);
                    var u = f[j],
                        v = n[j],
                        w = t.end - t.start + 1,
                        x = this.seq2Screen(t.start - 1),
                        y = e + "GR" + l + j + this.viewer.getData().uniprotID,
                        z = a.rect(v, x, c, w * this.scale, this.param.trackHeight, 4, 4, {
                            fill: "url(#" + y + ")",
                            stroke: u.darkercolor,
                            strokeWidth: 1
                        }),
                        A = a.text(v, x + this.scale, c + this.param.trackHeight - 1, t.desc);
                    this.checkTxtLength(A, t.start, t.end, t.desc);
                    var B = t.desc;
                    t.desc !== t.name && (B += "-" + t.name), void 0 !== t.status && (B += " - " + t.status), $(z).attr("title", B), this.registerTooltip(z), $(A).attr("title", B), this.registerTooltip(A), void 0 !== g && ($(z).css("cursor", "pointer"), $(A).css("cursor", "pointer"), $(z).bind("click", this.newLocationMethod), $(A).bind("click", this.newLocationMethod)), void 0 !== h && ($(z).css("cursor", "pointer"), $(A).css("cursor", "pointer"), $(z).bind("click", $.proxy(h, this, t)), $(A).bind("click", $.proxy(h, this, t)))
                } catch (a) {
                    alert("Problem while drawing generic track: " + d + " " + a)
                }
                c += this.param.trackHeight + 5
            }
        }
        return c
    }, e.prototype.drawVariation = function(a, b) {
        if (void 0 === this.viewer.getData().variation) return b;
        if (this.viewer.getData().variation.tracks.length < 1) return b;
        b += 7;
        var c = this.getGroup("variationTrackG" + this.viewer.getData().uniprotID);
        this.drawName(a, c, b, "Variation", void 0, this.viewer.getData().variation.label);
        var d = this.param.trackHeight + 5,
            e = new Array(1);
        return e[0] = this.param.paired_colors[3], this.drawSiteResidues(a, this.viewer.getData().variation, b, "upVariationTrack" + this.viewer.getData().uniprotID, e, "up", d, this.popups.clickVariationMethod), b + d
    }, e.prototype.drawUPSites = function(a, b) {
        if (void 0 === this.viewer.getData().upsites) return b;
        if (this.viewer.getData().upsites.tracks.length < 1) return b;
        b += 2;
        var c = this.getGroup("upsitesTrackG" + this.viewer.getData().uniprotID);
        this.drawName(a, c, b, "UP Sites", void 0, this.viewer.getData().upsites.label);
        var d = this.param.trackHeight + 5;
        return this.drawSiteResidues(a, this.viewer.getData().upsites, b, "upsitesTrack" + this.viewer.getData().uniprotID, this.param.paired_colors, "up", d, this.popups.clickUpSiteMethod), b + d
    }, e.prototype.drawPhosphoSites = function(a, b) {
        if (void 0 === this.viewer.getData().phospho) return b;
        if (this.viewer.getData().phospho.tracks.length < 1) return b;
        b += 5;
        var c = this.getGroup("phosphositesTrackG" + this.viewer.getData().uniprotID);
        this.drawName(a, c, b + this.param.trackHeight, "Phosphosite", void 0, this.viewer.getData().phospho.label);
        var d = this.param.trackHeight + 5;
        return this.drawSiteResidues(a, this.viewer.getData().phospho, b, "phosphositesTrack" + this.viewer.getData().uniprotID, this.param.paired_colors, "up", d, this.popups.clickPhosphoMethod), b + d + 22
    }, e.prototype.drawPDBSites = function(a, b) {
        if (void 0 === this.viewer.getData().pdbsites) return b;
        if (this.viewer.getData().pdbsites.tracks.length < 1) return b;
        var c = this.getGroup("sitesTrackG" + this.viewer.getData().uniprotID);
        this.drawName(a, c, b, "PDB Sites", void 0, this.viewer.getData().pdbsites.label);
        var d = this.param.trackHeight + 5;
        return this.drawSiteResidues(a, this.viewer.getData().pdbsites, b, "sitesTrack" + this.viewer.getData().uniprotID, this.param.paired_colors, "down", d), b + d + 2
    }, e.prototype.drawRSRZOutlier = function(a, b, c, d, e) {
        var f = this.param.baseLineHeight,
            g = this.param.trackHeight + 5,
            h = this.param.paired_colors[5],
            i = a.rect(b, this.seq2Screen(c.start) - this.scale / 2, e + f, 2, g - f, {
                fill: "black"
            }),
            j = a.circle(b, this.seq2Screen(c.start) - this.scale / 2, e, 4, {
                fill: h.color,
                stroke: h.darkerColor,
                strokeWidth: 1
            }),
            k = "Poor fit to the electron density (RSRZ > 2) chain " + c.chainID + " PDB residue: " + c.pdbStart;
        $(i).attr("title", k), $(j).attr("title", k), this.registerTooltip(i), this.registerTooltip(j)
    }, e.prototype.drawPDBValidation = function(a, c, d) {
        if (void 0 === this.viewer.getData().validation) return d;
        if (this.viewer.getData().validation.tracks.length < 1) return d;
        for (var e = "validationReport", f = this.getGroup("validationTrackG" + this.viewer.getData().uniprotID), g = a.defs(), h = this.param.paired_colors[5].color, i = b.rgb.hex2rgb(h), j = [b.forceRGB("darkgreen"), b.forceRGB("yellow"), b.forceRGB("orange"), i], k = 0; k < j.length; k++) {
            var l = j[k],
                m = b.rgb.rgb2hex(l),
                n = e + "GR" + k + this.viewer.getData().uniprotID;
            a.linearGradient(g, n, [
                ["0%", m],
                ["50%", m],
                ["100%", m]
            ], 0, d, 0, d + this.param.trackHeight, {
                gradientUnits: "userSpaceOnUse"
            })
        }
        this.drawName(a, f, d, "PDB Validation", void 0, this.viewer.getData().validation.label);
        for (var o = this.param.trackHeight + 5, p = this.viewer.getData().validation.tracks, q = 0; q < p.length; q++) {
            var r = p[q];
            if ("poorFit" !== r.name) {
                r.desc = parseInt(r.desc), r.desc > 3 && (r.desc = 3);
                var s = e + "GR" + r.desc + this.viewer.getData().uniprotID,
                    t = r.start - 1,
                    u = a.rect(this.seq2Screen(t), d + 5, 1 * this.scale + 1, this.param.trackHeight, {
                        fill: "url(#" + s + ")"
                    });
                a.rect(this.seq2Screen(t), d + o, 1 * this.scale + 1, 1, {
                    fill: "black"
                });
                var v = r.desc + " problem(s) for " + r.pdbID + " residue " + r.pdbStart + "  in chain " + r.chainID;
                $(u).attr("title", v), this.registerTooltip(u)
            }
        }
        for (var w = a.group({
                id: "validationTrackOutlierG" + this.viewer.getData().uniprotID,
                fontWeight: "bold",
                fontSize: "10",
                fill: "black"
            }), x = 0; x < p.length; x++) {
            var y = p[x];
            "poorFit" === y.name && this.drawRSRZOutlier(a, w, y, c, d)
        }
        return d + o + 2
    }, e.prototype.drawSCOP = function(a, c, d) {
        if (void 0 === this.viewer.getData().scop) return d;
        var e = this.breakTrackInRows(this.viewer.getData().scop.tracks);
        if (d = this.drawGenericTrack(a, e, d, "SCOP domains", "scopDomains", b.rgb.getDomainColors(), void 0, this.popups.scopcallback, this.viewer.getData().scop.label), void 0 === this.viewer.getData().scope) return d;
        var f = this.breakTrackInRows(this.viewer.getData().scope.tracks);
        return d = this.drawGenericTrack(a, f, d, "SCOPe domains", "scopeDomains", b.rgb.getDomainColors(), void 0, this.popups.scopecallback, this.viewer.getData().scope.label)
    }, e.prototype.drawExons = function(a, b, c) {
        if (void 0 === this.viewer.getData().exon) return c;
        if (this.viewer.getData().exon.tracks.length < 1) return c;
        c += 5;
        var d = this.param.trackHeight,
            e = this.getGroup("exonTrack" + this.viewer.getData().uniprotID);
        this.drawName(a, e, c, "Exon Structure", void 0, this.viewer.getData().exon.label);
        for (var f = 0; f < this.viewer.getData().exon.tracks.length; f++) {
            var g = this.viewer.getData().exon.tracks[f],
                h = {};
            h.start = g.start, h.end = g.end, h.name = g.name, h.desc = g.desc;
            var i = this.seq2Screen(h.start - 1),
                j = h.end - h.start + 1,
                k = this.param.paired_colors[8],
                l = a.defs(),
                m = this.getGroup("exon" + f);
            f % 2 == 0 ? a.linearGradient(l, "exon" + f, [
                ["0%", "white"],
                ["100%", k.color]
            ], 0, c, 0, c + d, {
                gradientUnits: "userSpaceOnUse"
            }) : a.linearGradient(l, "exon" + f, [
                ["0%", k.color],
                ["100%", "white"]
            ], 0, c, 0, c + d, {
                gradientUnits: "userSpaceOnUse"
            });
            var n = a.rect(m, i, c, j * this.scale, d, 0, 0, {
                    fill: "url(#exon" + f + ")",
                    stroke: k.darkercolor,
                    strokeWidth: 1
                }),
                o = "Exon Structure " + h.name + " - " + h.desc;
            $(n).attr("title", o);
            var p = a.text(m, i + this.scale, c + this.param.trackHeight - 1, h.name + " - " + h.desc);
            this.checkTxtLength(p, h.start, h.end, h.name), this.registerTooltip(n), $(p).attr("title", "Exon Structure " + h.name + " - " + h.desc), this.registerTooltip(p)
        }
        return c + 2 * this.height
    }, e.prototype.drawJronn = function(a, b, c) {
        if (void 0 === this.viewer.getData().jronn) return c;
        var d = this.getGroup("disorder" + this.viewer.getData().uniprotID);
        this.drawName(a, d, c + this.param.trackHeight, "Disorder", void 0, this.viewer.getData().jronn.label);
        for (var e = 0, f = 1, g = parseFloat(f + Math.abs(e)), h = (this.param.trackHeightCharts - 2) / g, i = this.param.paired_colors[5], j = this.param.paired_colors[1], k = 0; k < b.length; k++) {
            var l = this.viewer.getData().jronn.tracks[k];
            if (void 0 !== l) {
                var m = Math.abs(parseFloat(l.desc)),
                    n = m;
                m >= 0 && (n += Math.abs(e));
                var o = Math.abs(n) * h,
                    p = j.color;
                m > .5 && (p = i.darkercolor);
                var q = o;
                a.rect(this.seq2Screen(k), c - o + this.param.trackHeightCharts - 2, 1 * this.scale + 1, q, {
                    fill: p
                })
            }
        }
        return c + this.param.trackHeightCharts
    }, e.prototype.drawHydropathy = function(a, b, c) {
        if (void 0 === this.viewer.getData().hydropathy) return c;
        var d = this.param.paired_colors[5],
            e = this.param.paired_colors[1],
            f = this.getGroup("hydropathy" + this.viewer.getData().uniprotID);
        this.drawName(a, f, c + this.param.trackHeight, "Hydropathy", void 0, this.viewer.getData().hydropathy.label), a.rect(f, this.seq2Screen(0), c + this.param.trackHeightCharts / 2, b.length * this.scale, 1, {
            fill: "black"
        });
        for (var g = parseFloat(this.viewer.getData().hydropathy_min), h = parseFloat(this.viewer.getData().hydropathy_max), i = h + Math.abs(g), j = this.param.trackHeightCharts / i, k = 0; k < b.length; k++) {
            var l = this.viewer.getData().hydropathy.tracks[k];
            if (void 0 !== l) {
                var m = parseFloat(l.desc),
                    n = parseFloat(l.desc);
                m > 0 && (n += Math.abs(g));
                var o = Math.abs(n * j);
                if (m < 0) a.rect(this.seq2Screen(k), c + this.param.trackHeightCharts / 2, 1 * this.scale + 1, o, {
                    fill: e.color
                });
                else {
                    var p = o - this.param.trackHeightCharts / 2;
                    p < 0 && (p = 0), a.rect(this.seq2Screen(k), c - o + this.param.trackHeightCharts, 1 * this.scale + 1, p, {
                        fill: d.color
                    })
                }
            }
        }
        return c + this.param.trackHeightCharts + this.param.trackHeight / 2
    }, e.prototype.drawSignalP = function(a, b, c) {
        if (void 0 === this.viewer.getData().signalp) return c;
        c = this.drawGenericTrack(a, this.viewer.getData().signalp, c, "SignalP", "signalP", this.param.up_colors, void 0, this.callback, this.viewer.getData().signalp.label)
    }, e.prototype.drawSelection = function(a, b) {
        if (!(this.viewer.selectionStart < 0)) {
            void 0 === b && (b = this.maxY);
            var c = 0,
                d = a.group({
                    id: "selection" + this.viewer.getData().uniprotID,
                    fontWeight: "bold",
                    fontSize: "10",
                    border: this.param.paired_colors[6].color,
                    fill: "white",
                    "fill-opacity": "0"
                }),
                e = this.viewer.selectionEnd - this.viewer.selectionStart + 1,
                f = a.rect(d, this.seq2Screen(this.viewer.selectionStart), c, e * this.scale, b, 0, 0, {
                    stroke: this.param.paired_colors[5].lightercolor,
                    strokeWidth: 1,
                    style: "/* rule 1 */ use { fill-opacity: .5 } "
                });
            $(f).attr("data-toggle", "tooltip"), $(f).attr("data-placement", "top"), $(f).attr("data-container", "body"), $(f).attr("title", "selection: " + this.viewer.selectionStart + "-" + this.viewer.selectionEnd), $(f).text("selection: " + this.viewer.selectionStart + "-" + this.viewer.selectionEnd), $(f).tooltip()
        }
    }, e.prototype.drawPfam = function(a, b) {
        if (void 0 === this.viewer.getData().pfam) return b;
        if (this.viewer.getData().pfam.tracks.length < 1) return b;
        b += 5;
        var c = this.param.trackHeight,
            d = this.getGroup("pfamTrack" + this.viewer.getData().uniprotID);
        this.drawName(a, d, b, "Pfam", void 0, this.viewer.getData().pfam.label);
        for (var e = 0; e < this.viewer.getData().pfam.tracks.length; e++) {
            var f = this.viewer.getData().pfam.tracks[e],
                g = {};
            g.start = f.start - 1, g.end = f.end - 1, g.name = f.name, g.desc = f.desc;
            var h = this.seq2Screen(g.start),
                i = g.end - g.start + 1,
                j = this.param.paired_colors[6],
                k = a.defs(),
                l = this.getGroup("pfam" + e);
            $(l).attr("fill", j.textcolor), a.linearGradient(k, "pfam" + e, [
                ["0%", j.lightercolor],
                ["100%", j.darkercolor]
            ], 0, b, 0, b + c, {
                gradientUnits: "userSpaceOnUse"
            });
            var m = a.rect(l, h, b, i * this.scale, c, 3, 3, {
                    fill: "url(#pfam" + e + ")",
                    stroke: j.darkercolor,
                    strokeWidth: 1
                }),
                n = "Pfam Domain " + g.name + " - " + g.desc;
            $(m).attr("title", n);
            var o = a.text(l, h + this.scale, b + this.param.trackHeight - 1, g.name + " - " + g.desc);
            this.checkTxtLength(o, g.start, g.end, g.name), this.registerTooltip(m), $(o).attr("title", "Pfam Domain " + g.name + " - " + g.desc), this.registerTooltip(o)
        }
        return b + this.height + 5
    }, e.prototype.highlightTrack = function(a, b, c, d) {
        if (null === b) return c;
        var e = this.getGroup(d),
            f = this.viewer.getData().length;
        a.rect(e, 0, c, this.param.leftBorder + Math.round(f * this.scale) + this.param.rightBorder, this.param.trackHeight, {
            fill: "lightgrey",
            stroke: "lightgrey",
            strokeWidth: 1
        })
    }, e.prototype.draw3dFlagForTrack = function(a, b, c) {
        if (null === b) return c;
        var d = "matrix(1,0,0,-1,0," + (c + this.param.trackHeight) + ") scale(0.005)",
            e = a.group({
                transform: d
            });
        a.path(e, this.icons.eye, {}), $(e).attr("title", "Shown in 3D viewer"), this.registerTooltip(e)
    }, e.prototype.drawTrack = function(a, b, c, d) {
        if (null === b) return c;
        var e = this.getGroup(d),
            f = this.getGroup(d);
        $(f).attr("font-family", "Helvetica, Arial, sans-serif"), $(f).attr("font-weight", "bold");
        var g = a.group({
                id: "sMM" + d + this.viewer.getData().uniprotID,
                fontWeight: "bold",
                fontSize: "10",
                fill: this.param.paired_colors[5].color
            }),
            h = a.group({
                id: "seqres" + d,
                fontWeight: "bold",
                fontSize: "10",
                fill: "black"
            }),
            i = b.color,
            j = this.param.bw_colors[6],
            k = this.param.paired_colors[4],
            l = a.defs();
        a.linearGradient(l, "MyGradient" + d + this.viewer.getData().uniprotID, [
            ["0%", "white"],
            ["100%", i]
        ], 0, c, 0, c + this.param.trackHeight, {
            gradientUnits: "userSpaceOnUse"
        }), a.linearGradient(l, "BWGradient" + d + this.viewer.getData().uniprotID, [
            ["0%", "white"],
            ["100%", j.color]
        ], 0, c, 0, c + this.param.trackHeight, {
            gradientUnits: "userSpaceOnUse"
        }), a.linearGradient(l, "BWLightGradient" + d + this.viewer.getData().uniprotID, [
            ["0%", "white"],
            ["100%", "grey"]
        ], 0, c, 0, c + this.param.trackHeight, {
            gradientUnits: "userSpaceOnUse"
        }), a.linearGradient(l, "MISMGradient" + d + this.viewer.getData().uniprotID, [
            ["0%", "white"],
            ["100%", k.color]
        ], 0, c, 0, c + this.param.trackHeight, {
            gradientUnits: "userSpaceOnUse"
        }), this.drawName(a, e, c, b.pdbID + "." + b.chainID, void 0, "Track for PDB ID " + b.pdbID + " chain ID " + b.chainID);
        for (var m = 0; m < b.ranges.length; m++) {
            var n = b.ranges[m],
                o = {};
            o.start = n.start - 1, o.end = n.end - 1, o.observed = n.observed, o.mismatch = n.mismatch;
            var p = o.end - o.start + 1,
                q = this.param.trackHeight / 2 - 1,
                r = this.param.trackHeight / 2 - 1;
            if (o.observed)
                if (o.mismatch) {
                    var s = a.rect(e, this.seq2Screen(o.start), c, Math.round(p * this.scale), this.param.trackHeight, {
                            fill: "url(#MISMGradient" + d + this.viewer.getData().uniprotID + ")",
                            stroke: k.darkercolor,
                            strokeWidth: 1
                        }),
                        t = " (sequence position: " + n.start;
                    n.start !== n.end && (t += " - " + n.end), t += ") ", void 0 !== n.pdbStart && (t += "(PDB residue:" + n.pdbStart, n.pdbStart !== n.pdbEnd && (t += "-" + n.pdbEnd), t += ") ");
                    var u = "";
                    void 0 !== n.pdbResidue && (u = n.pdbResidue);
                    var v = "Mismatch " + this.viewer.getData().sequence.charAt(o.start) + "->" + u + " between PDB and UniProt residue " + t;
                    if ($(s).attr("title", v), this.registerTooltip(s), this.scale > 8) {
                        var w = a.text(g, this.seq2Screen(o.start) + 1, c + this.param.trackHeight - 1, u);
                        $(w).attr("title", v), this.registerTooltip(w)
                    }
                } else {
                    var x = a.rect(e, this.seq2Screen(o.start), c, Math.round(p * this.scale), this.param.trackHeight, q, r, {
                            fill: "url(#MyGradient" + d + this.viewer.getData().uniprotID + ")",
                            stroke: i,
                            strokeWidth: 1
                        }),
                        y = "";
                    void 0 !== b.resolution && (y = " - " + b.resolution / 1e3 + " ");
                    var z = new Date(b.releaseDate),
                        A = "PDB ID " + b.pdbID + " chain " + b.chainID + " - " + b.desc + " (sequence position: " + n.start + "-" + n.end + ") ";
                    if (void 0 !== n.pdbStart && (A += "(PDB residue: " + n.pdbStart, n.pdbEnd !== n.pdbStart && (A += "-" + n.pdbEnd), A += ") "), A += y + " - " + z.toDateString(), $(x).attr("title", A), this.registerTooltip(x), this.scale > 8)
                        for (var B = o.start; B <= o.end; B++) {
                            var C = this.viewer.getData().sequence.charAt(B);
                            a.text(f, this.seq2Screen(B) + 1, c + this.param.trackHeight - 1, C)
                        }
                }
            else if (this.viewer.getShowSeqres()) {
                var D = e,
                    E = this.param.trackHeight / 4,
                    F = this.param.trackHeight / 4 * 2,
                    G = "url(#BWGradient";
                this.scale > 8 && (D = h, E = 0, F = this.param.trackHeight, G = "url(#BWLightGradient");
                var H = a.rect(D, this.seq2Screen(o.start), c + E, Math.round(p * this.scale), F, {
                    fill: G + d + this.viewer.getData().uniprotID + ")",
                    stroke: j.color,
                    strokeWidth: 1
                });
                if ($(H).attr("title", "No coordinates have been determined for region (" + o.start + "-" + o.end + "), but the sequence is recorded in the SEQRES records. "), this.registerTooltip(H), this.scale > 8)
                    for (var I = o.start; I <= o.end; I++) {
                        var J = this.viewer.getData().sequence.charAt(I).toLowerCase();
                        a.text(D, this.seq2Screen(I) + 2, c + this.param.trackHeight - 1, J)
                    }
            }
        }
        return void 0 !== b.seqdiff && this.drawSeqDiff(a, b, c, d), c + this.height
    }, e.prototype.drawSeqDiff = function(a, b, c, d) {
        if (void 0 !== b.seqdiff && !(b.seqdiff.length < 1))
            for (var e = 0, g = this.param.up_colors, h = this.param.trackHeight, i = this.param.baseLineHeight, j = a.group({
                    id: d,
                    fontWeight: "bold",
                    fontSize: "10",
                    fill: "black"
                }), k = 0; k < b.seqdiff.length; k++) {
                var l = b.seqdiff[k];
                if (void 0 === l.uniprot || l.uniprot === this.viewer.getData().uniprotID) {
                    var m = "",
                        n = "";
                    void 0 !== l.detail && (m = l.detail.toUpperCase(), n = l.detail);
                    var o = f[m];
                    void 0 !== l.aa && (n += " " + l.aa), n += " at " + l.pdbID + "." + l.chainID + " PDB residue:" + l.pdbStart + " sequence position: " + l.start, n += " " + l.uniprot, "CONFLICT" === m && (o = this.param.conflictColor);
                    var p = "",
                        q = 8,
                        r = -3,
                        s = 0,
                        t = "circle";
                    0 === m.indexOf("MODIFIED") ? (p = l.aa, q = 6, r = -6) : 0 === m.indexOf("MICROHETEROGENEITY") ? (p = "<>", q = 6, r = -4, s = -1) : 0 === m.indexOf("CLONING") ? p = "C" : 0 === m.indexOf("GAP") ? (p = "", t = "triangle") : 0 === m.indexOf("INITIAL METH") ? (p = l.aa, r = -6, q = 6) : 0 === m.indexOf("CHROMOPHORE") ? (p = l.aa, q = 6, r = -6) : 0 === m.indexOf("ENGINEERED") ? p = "E" : m.indexOf("MUTATION") > -1 ? p = "M" : m.indexOf(" TAG") > -1 ? (p = "T", o = this.param.expressionTagColor) : m.indexOf("DELETION") > -1 ? (p = "", t = "triangle", o = this.param.deletionColor) : m.indexOf("INSERTION") > -1 && (p = "", t = "triangle-up", o = this.param.deletionColor), void 0 === p && (p = ""), void 0 === o && (e++, e > g.length - 1 && (e = 0), o = g[e], f[m] = o);
                    var u = this.seq2Screen(l.start) - this.scale / 2;
                    if (a.radialGradient(j, "seqDiffGradient" + k + this.viewer.getData().uniprotID, [
                            ["0%", o.lightercolor],
                            ["100%", o.color]
                        ], u, c + i - 4, 4, u, c + i - 3, {
                            gradientUnits: "userSpaceOnUse"
                        }), "triangle" === t) {
                        u = this.seq2Screen(l.start) + this.scale / 2;
                        var v = this.scale / 2,
                            w = a.polygon(j, [
                                [u - v, c - i],
                                [u + 1, c + i + 2],
                                [u + v + 1, c - i]
                            ], {
                                fill: "url(#seqDiffGradient" + k + this.viewer.getData().uniprotID + ")",
                                stroke: o.darkerColor,
                                strokeWidth: 1
                            });
                        $(w).attr("title", n), this.registerTooltip(w)
                    } else if ("triangle-up" === t) {
                        u = this.seq2Screen(l.start) + this.scale / 2;
                        var x = this.scale / 2,
                            y = a.polygon(j, [
                                [u - x, c + i + 2],
                                [u + 1, c - i],
                                [u + x + 1, c + i + 2]
                            ], {
                                fill: "url(#seqDiffGradient" + k + this.viewer.getData().uniprotID + ")",
                                stroke: o.darkerColor,
                                strokeWidth: 1
                            });
                        $(y).attr("title", n), this.registerTooltip(y)
                    } else {
                        var z = a.circle(j, u, c, 4, {
                            fill: "url(#seqDiffGradient" + k + this.viewer.getData().uniprotID + ")",
                            stroke: o.darkerColor,
                            strokeWidth: 1
                        });
                        $(z).attr("title", n), this.registerTooltip(z)
                    }
                    var A = a.rect(j, u, c + i, 2, h - i, {
                        fill: "black"
                    });
                    if ($(A).attr("title", n), this.registerTooltip(A), p.length > 0) {
                        var B = a.text(j, u + r, c + s + h / 4, p, {
                            "font-size": q
                        });
                        $(B).attr("title", n), this.registerTooltip(B)
                    }
                }
            }
    }, e.prototype.drawSiteResidues = function(a, b, c, d, e, g, h, i) {
        if (void 0 !== b.tracks && !(b.tracks.length < 1)) {
            var j = this.param.baseLineHeight,
                k = 0,
                l = a.group({
                    id: d,
                    fontWeight: "bold",
                    fontSize: "10",
                    fill: "black"
                }),
                m = a.defs(),
                n = !1,
                o = this.param.paired_colors[2];
            "PDB SITES residues" === b.label ? o = this.param.paired_colors[1] : -1 !== b.label.indexOf("Phosphosite") && (o = this.param.paired_colors[9], n = !0);
            var p = {};
            "up" === g ? (a.linearGradient(m, "sequenceSite" + d + this.viewer.getData().uniprotID, [
                ["0%", o.color],
                ["100%", o.darkercolor]
            ], 0, c + h - j, 0, c + h, {
                gradientUnits: "userSpaceOnUse"
            }), p = a.rect(l, this.seq2Screen(0), c + h - j, this.viewer.getSequence().length * this.scale, j, 4, 4, {
                fill: "url(#sequenceSite" + d + this.viewer.getData().uniprotID + ")",
                stroke: o.darkercolor,
                strokeWidth: 1
            })) : (a.linearGradient(m, "sequenceSite" + d + this.viewer.getData().uniprotID, [
                ["0%", o.color],
                ["100%", o.darkercolor]
            ], 0, c, 0, c + j, {
                gradientUnits: "userSpaceOnUse"
            }), p = a.rect(l, this.seq2Screen(0), c, this.viewer.getSequence().length * this.scale, j, 4, 4, {
                fill: "url(#sequenceSite" + d + this.viewer.getData().uniprotID + ")",
                stroke: o.darkercolor,
                strokeWidth: 1
            })), $(p).attr("title", b.label + " track for " + b.tracks[0].pdbID + "." + b.tracks[0].chainID), this.registerTooltip(p);
            for (var q = 0; q < b.tracks.length; q++) {
                var r = b.tracks[q];
                if (void 0 !== r) {
                    var s = f[r.name];
                    if ("wwPDB validation report data" === b.label) {
                        s = r.desc
                    }
                    void 0 === s && (k++, k > e.length - 1 && (k = 0), s = e[k], f[r.name] = s), "up" === g ? a.radialGradient(l, "siteWGradient" + q + this.viewer.getData().uniprotID, [
                        ["0%", s.lightercolor],
                        ["100%", s.color]
                    ], this.seq2Screen(r.start) - this.scale / 2, c + j - 4, 4, this.seq2Screen(r.start) - this.scale / 2, c + j - 3, {
                        gradientUnits: "userSpaceOnUse"
                    }) : a.radialGradient(l, "siteWGradient" + q + this.viewer.getData().uniprotID, [
                        ["0%", s.lightercolor],
                        ["100%", s.color]
                    ], this.seq2Screen(r.start) - this.scale / 2, c + h - 4, 4, this.seq2Screen(r.start) - this.scale / 2, c + h - 3, {
                        gradientUnits: "userSpaceOnUse"
                    });
                    var t = {},
                        u = {};
                    "up" === g ? (t = a.rect(l, this.seq2Screen(r.start) - this.scale / 2, c + j, 2, h - j, {
                        fill: "black"
                    }), u = a.circle(l, this.seq2Screen(r.start) - this.scale / 2, c, 4, {
                        fill: "url(#siteWGradient" + q + this.viewer.getData().uniprotID + ")",
                        stroke: s.darkerColor,
                        strokeWidth: 1
                    })) : (t = a.rect(l, this.seq2Screen(r.start) - this.scale / 2, c, 2, h, {
                        fill: "black"
                    }), u = a.circle(l, this.seq2Screen(r.start) - this.scale / 2, c + h - 4, 4, {
                        fill: "url(#siteWGradient" + q + this.viewer.getData().uniprotID + ")",
                        stroke: s.darkerColor,
                        strokeWidth: 1
                    }));
                    var v = "";
                    "string" == typeof b.tracks[0].pdbID && (v = b.tracks[0].pdbID + "." + b.tracks[0].chainID + ": ");
                    var w = v;
                    if (void 0 !== r.desc && (w += r.desc), void 0 !== r.name && (w += " - " + r.name), w += " (" + r.start + ")", $(t).attr("title", w), this.registerTooltip(t), $(u).attr("title", w), "undefined" !== b.trackName && "variation" === b.trackName) {
                        var x = r.externalLinks;
                        void 0 !== x && "" !== x && x.length > 0 && $(u).data("extLinks", r.externalLinks)
                    }
                    this.registerTooltip(u), n && ($(u).attr("id", r.acc), $(u).attr("name", this.title)), void 0 !== i && ($(u).css("cursor", "pointer"), $(u).bind("click", $.proxy(i, this, r)))
                }
            }
        }
    }, e.prototype.drawUniprotChainData = function(a, b, c) {
        var d = this.viewer.getData().chains,
            e = this.breakTrackInRows(d.tracks);
        return e < 1 ? b : b = this.drawGenericTrack(a, e, b, "Molec. Processing", "chainTrack", this.param.up_colors, void 0, c, this.viewer.getData().chains.label)
    }, e.prototype.drawTick = function(a, b, c, d) {
        var e = a.group({
            fontWeight: "normal",
            fontSize: 10,
            fill: "black"
        });
        a.text(e, this.seq2Screen(b), c - 2 - 1, b + 1 + ""), a.rect(this.seq2Screen(b), c, 1 * this.scale, d, {
            fill: "black"
        })
    }, e.prototype.drawUniprotFeatures = function(a, b) {
        var c = this.popups.callbackUniProtFeature;
        if (void 0 !== this.viewer.getData().chains && (b = this.drawUniprotChainData(a, b, c)), void 0 !== this.viewer.getData().motifs && void 0 !== this.viewer.getData().motifs.tracks) {
            var d = this.viewer.getData().motifs.tracks,
                e = this.breakTrackInRows(d);
            b = this.drawGenericTrack(a, e, b, "Motif", "motifTrack", this.param.up_colors, void 0, c, this.viewer.getData().motifs.label)
        }
        if (void 0 !== this.viewer.getData().enzymeClassification && this.viewer.getData().enzymeClassification.tracks.length > 0) {
            var f = this.viewer.getData().enzymeClassification.tracks,
                g = this.breakTrackInRows(f);
            b = this.drawRangedTrack(a, g, b, "E.C.", "enzymeClassificationTrack", this.param.up_colors, void 0, this.popups.callbackec, this.viewer.getData().enzymeClassification.label)
        }
        return b + this.param.trackHeight
    }, e.prototype.drawPDBSecstruc = function(a, b) {
        var c = this.viewer.getData().secstruc;
        return void 0 === c ? b : (b = this.drawSecstrucTrack(a, c, b)) + this.param.trackHeight
    }, e.prototype.drawSecstrucTrack = function(a, b, c) {
        if (void 0 === b) return c;
        if (void 0 === b.tracks) return c;
        var d = this.popups.callbackSecStruc,
            e = "Secstruc",
            f = b.label,
            g = this.getGroup(f + this.viewer.getData().uniprotID);
        this.viewer.getData().tracks.length > 0 && this.drawName(a, g, c, e, void 0, f);
        var h = this.param.bw_colors[0];
        a.linearGradient(a.defs(), "secstrucBWGradient" + this.viewer.getData().uniprotID, [
            ["0%", "white"],
            ["100%", h]
        ], 0, c, 0, c + this.param.trackHeight, {
            gradientUnits: "userSpaceOnUse"
        });
        for (var i = 0; i < this.viewer.getData().tracks.length; i++) {
            var j = this.viewer.getData().tracks[i];
            if (null !== j)
                for (var k = 0; k < j.ranges.length; k++) {
                    var l = j.ranges[k];
                    if (l.observed) {
                        var m = {};
                        m.start = l.start - 1, m.end = l.end - 1, m.name = "secstruc", m.desc = "coil";
                        var n = m.end - m.start + 1,
                            o = a.rect(g, this.seq2Screen(m.start), c + this.param.trackHeight / 4, Math.round(n * this.scale), this.param.trackHeight / 4 * 2, {
                                fill: "url(#secstrucBWGradient" + this.viewer.getData().uniprotID + ")"
                            });
                        $(o).attr("title", "coil"), this.registerTooltip(o), void 0 !== d && ($(o).css("cursor", "pointer"), $(o).bind("click", $.proxy(d, this, m)))
                    }
                }
        }
        for (var p = 0; p < b.tracks.length; p++) {
            var q = b.tracks[p],
                r = {};
            r.start = q.start - 1, r.end = q.end - 1, r.name = q.name, r.desc = q.desc, r.note = q.note;
            var s = r.end - r.start + 1;
            if (!(r.end > this.viewer.getData().length)) {
                var t = this.param.bw_colors[3];
                "H" === r.name || "I" === r.name || "G" === r.name ? t = this.param.paired_colors[5] : "E" === r.name || "B" === r.name ? t = this.param.paired_colors[6] : "T" === r.name && (t = this.param.paired_colors[0]);
                var u = this.seq2Screen(r.start),
                    v = a.defs();
                a.linearGradient(v, e + "GR" + p + this.viewer.getData().uniprotID, [
                    ["0%", t.lightercolor],
                    ["100%", t.darkercolor]
                ], 0, c, 0, c + this.param.trackHeight, {
                    gradientUnits: "userSpaceOnUse"
                });
                var w = a.group({
                        id: e + this.viewer.getData().uniprotID,
                        fontWeight: "bold",
                        fontSize: "10",
                        fill: t.textcolor
                    }),
                    x = {};
                if (x = "H" === r.name || "G" === r.name || "I" === r.name || "E" === r.name ? a.rect(w, u, c, s * this.scale, this.param.trackHeight, 0, 0, {
                        fill: "url(#" + e + "GR" + p + this.viewer.getData().uniprotID + ")",
                        stroke: t.darkercolor,
                        strokeWidth: 1
                    }) : a.rect(g, u + 1, c + this.param.trackHeight / 8, s * this.scale, this.param.trackHeight / 8 * 7, 0, 0, {
                        fill: "url(#" + e + "GR" + p + this.viewer.getData().uniprotID + ")",
                        stroke: t.darkercolor,
                        strokeWidth: 1
                    }), "H" === r.name)
                    for (var y = u; y < this.seq2Screen(r.end); y += 4) a.line(g, y, c + this.param.trackHeight, y + 4, c, {
                        fill: t.darkercolor,
                        stroke: t.darkercolor
                    });
                var z = r.desc;
                void 0 === r.desc && (z = r.name), void 0 !== r.note && (z += " (from " + r.note + ")");
                var A = z + " (" + q.start + "-" + q.end + ")";
                $(x).attr("title", A), void 0 !== d && ($(x).css("cursor", "pointer"), $(x).bind("click", $.proxy(d, this, r)), this.registerTooltip(x))
            }
        }
        return c + this.param.trackHeight
    }, e.prototype.drawRangedTrack = function(a, b, c, d, e, f, g, h, i) {
        if (0 === b.length) return c;
        var j = function() {
                document.location.href = g
            },
            k = -1,
            l = this.getGroup(d + this.viewer.getData().uniprotID);
        this.drawName(a, l, c, d, void 0, i);
        for (var m = 0; m < b.length; m++) {
            for (var n = b[m], o = 0; o < n.length; o++) try {
                var p = n[o];
                if (void 0 === p) continue;
                if (void 0 === p.desc) continue;
                var q = {};
                q.start = p.start - 1, q.end = p.end - 1, q.desc = p.desc, q.name = p.name, k++, k > f.length - 1 && (k = 0);
                var r = f[k],
                    s = q.end - q.start + 1,
                    t = this.seq2Screen(q.start),
                    u = a.defs();
                a.linearGradient(u, e + "GR" + m + o + this.viewer.getData().uniprotID, [
                    ["0%", "white"],
                    ["100%", r.darkercolor]
                ], 0, c, 0, c + this.param.trackHeight, {
                    gradientUnits: "userSpaceOnUse"
                });
                var v = this.getGroup(e + this.viewer.getData().uniprotID);
                $(v).attr("fill", r.textcolor), a.rect(v, t, c, 1 * this.scale, this.param.trackHeight, 1, 1, {
                    fill: r.darkercolor,
                    stroke: r.darkercolor,
                    strokeWidth: 1
                }), a.rect(v, this.seq2Screen(q.end), c, 1 * this.scale, this.param.trackHeight, 1, 1, {
                    fill: r.darkercolor,
                    stroke: r.darkercolor,
                    strokeWidth: 1
                });
                var w = a.rect(v, t, c + this.param.trackHeight / 2 - 2, s * this.scale, 4, {
                        fill: "url(#" + e + "GR" + m + o + this.viewer.getData().uniprotID + ")",
                        stroke: r.darkercolor,
                        strokeWidth: 1
                    }),
                    x = q.desc;
                "Homology_Models" === e && (x = "");
                var y = a.text(v, t + this.scale, c + this.param.trackHeight - 1, x);
                this.checkTxtLength(y, q.start, q.end, x);
                var z = q.name;
                z += " (" + p.start + "-" + p.end + ")", q.name !== q.desc && (z += " - " + q.desc), void 0 !== q.status && (z += " - " + q.status), $(w).attr("title", z), this.registerTooltip(w), $(y).attr("title", z), this.registerTooltip(y), void 0 !== g && ($(w).css("cursor", "pointer"), $(y).css("cursor", "pointer"), $(w).bind("click", j), $(y).bind("click", j)), void 0 !== h && ($(w).css("cursor", "pointer"), $(y).css("cursor", "pointer"), $(w).bind("click", $.proxy(h, this, q)), $(y).bind("click", $.proxy(h, this, q)))
            } catch (a) {}
            c += this.param.trackHeight + 5
        }
        return c
    }, e.prototype.drawCytoplasmic = function(a, b, c, d) {
        var e = a + this.param.trackHeight - 2;
        this.drawTmLine(a, b, c, d, e, 2)
    }, e.prototype.drawPeriplasmic = function(a, b, c, d) {
        var e = a;
        this.drawTmLine(a, b, c, d, e, 2)
    }, e.prototype.drawTmLine = function(a, b, c, d, e, f) {
        var g = this.param.paired_colors[1],
            h = this.getGroup(d + this.viewer.getData().uniprotID),
            i = c.end - c.start + 1,
            j = this.seq2Screen(c.start - 1),
            k = b.rect(h, j, e, i * this.scale, f, {
                fill: g.color,
                stroke: g.darkercolor,
                strokeWidth: 1
            }),
            l = b.text(h, j + this.scale, a + this.param.trackHeight - 1, c.desc);
        this.checkTxtLength(l, c.start, c.end, c.desc);
        var m = c.desc + "-" + c.name;
        void 0 !== c.status && (m += " - " + c.status), $(k).attr("title", m), this.registerTooltip(k), $(l).attr("title", m), this.registerTooltip(l)
    }, e.prototype.drawIntramembrane = function(a, b, c, d) {
        var e = this.param.bw_colors[3],
            f = this.getGroup(d + this.viewer.getData().uniprotID),
            g = c.end - c.start + 1,
            h = this.seq2Screen(c.start - 1),
            i = b.rect(f, h, a + this.param.trackHeight / 2, g * this.scale, 2, {
                fill: e.color,
                stroke: e.darkercolor,
                strokeWidth: 1
            });
        b.rect(f, h, a, 1 * this.scale, this.param.trackHeight, 1, 1, {
            fill: e.darkercolor,
            stroke: e.darkercolor,
            strokeWidth: 1
        }), b.rect(f, this.seq2Screen(c.end - 1), a, 1 * this.scale, this.param.trackHeight, 1, 1, {
            fill: e.darkercolor,
            stroke: e.darkercolor,
            strokeWidth: 1
        });
        var j = b.text(f, h + this.scale, a + this.param.trackHeight - 1, c.desc);
        this.checkTxtLength(j, c.start, c.end, c.desc);
        var k = c.desc + "-" + c.name;
        void 0 !== c.status && (k += " - " + c.status), $(i).attr("title", k), this.registerTooltip(i), $(j).attr("title", k), this.registerTooltip(j)
    }, e.prototype.drawTransmembrane = function(a, b, c, d) {
        var e = this.param.paired_colors[5],
            f = e,
            g = this.getGroup(d + this.viewer.getData().uniprotID),
            h = c.end - c.start + 1,
            i = this.seq2Screen(c.start - 1),
            j = b.defs();
        b.linearGradient(j, d + "TR" + this.viewer.getData().uniprotID, [
            ["0%", f.lightercolor],
            ["100%", f.darkercolor]
        ], 0, a, 0, a + this.param.trackHeight, {
            gradientUnits: "userSpaceOnUse"
        });
        for (var k = b.rect(g, i, a, h * this.scale, this.param.trackHeight, {
                fill: "url(#" + d + "TR" + this.viewer.getData().uniprotID + ")",
                stroke: f.darkercolor,
                strokeWidth: 1
            }), l = i; l < this.seq2Screen(c.end); l += 4) b.line(g, l, a + this.param.trackHeight, l + 2, a, {
            fill: f.darkercolor,
            stroke: f.darkercolor
        });
        var m = b.text(g, i + this.scale, a + this.param.trackHeight - 1, c.desc);
        this.checkTxtLength(m, c.start, c.end, c.desc);
        var n = c.desc + "-" + c.name;
        void 0 !== c.status && (n += " - " + c.status), $(k).attr("title", n), this.registerTooltip(k), $(m).attr("title", n), this.registerTooltip(m)
    }, e.prototype.breakTrackInRows = function(a) {
        var b = [];
        if (a.length < 1) return b;
        var c = [];
        b.push(c);
        for (var d = 0, e = 0; e < a.length; e++) {
            var f = a[e];
            if (void 0 !== f) {
                var g = 0;
                a: for (var h = 0; h < b.length; h++) {
                    for (var i = b[h], j = !1, k = 0; k < i.length; k++) {
                        d++;
                        var l = i[k],
                            m = this.getOverlap(f.start, f.end, l.start, l.end);
                        if (m > 0) {
                            j = !0, g++;
                            continue a
                        }
                    }
                    if (!j) break a
                }
                if (b.length < g + 1) {
                    var n = [];
                    b.push(n)
                }
                b[g].push(f)
            }
        }
        return b
    }, e.prototype.updateTrackColors = function(a) {
        var b = 0,
            c = -1,
            d = a;
        if (void 0 !== this.viewer.getData().tracks)
            for (var e = 0; e < this.viewer.getData().tracks.length; e++) {
                var f = this.viewer.getData().tracks[e];
                if (null !== f) {
                    b++, c++, c >= d.length && (c = 0);
                    var g = this.getTrackColor(d, c, f);
                    f.color = g.color, f.lightercolor = g.lightercolor
                }
            }
    }, e.prototype.getTrackColor = function(a, b, c) {
        var d = a[b];
        if ("Resolution" === this.viewer.colorBy) {
            if (void 0 === c.resolution) return this.param.bw_colors[6];
            for (var e = c.resolution, f = 0; f < this.param.redblue_colors.length - 1; f++)
                if (e < 1e3 * (f + 1)) return this.param.redblue_colors[f];
            return this.param.redblue_colors[this.param.redblue_colors.length - 1]
        }
        return "Alignment Length" === this.viewer.colorBy ? a[1] : d
    }, e.prototype.checkTxtLength = function(a, b, c, d) {
        if (void 0 !== d) {
            var e = a.getComputedTextLength(),
                f = c - b + 1,
                g = f * this.scale;
            if (e > g) {
                var h = Math.floor(g / 8);
                a.firstChild.data = d.substring(0, h)
            }
        }
    }, e.prototype.getOverlap = function(a, b, c, d) {
        var e = 0;
        return (a <= c && c <= b || a <= d && d <= b || c <= a && b <= d) && (e = a < c ? b < d ? b - c : d - c : b < d ? b - a : d - a), e
    }, e.prototype.setScale = function(a) {
        a > this.param.maxTextSize && (a = this.param.maxTextSize), this.scale = a
    }, e.prototype.registerTooltip = function(a, b) {
        try {
            void 0 === b && (b = $(a).attr("title")), void 0 === a && console.err("got undefined for element?? " + b), void 0 === $(a) && console.err("got undefined for element?? " + a + " " + b), $(a).attr({
                rel: "tooltip",
                title: b,
                "data-toggle": "tooltip",
                "data-container": "body"
            }), $(a).css("cursor", "pointer")
        } catch (a) {}
    }, {
        Draw: function(a) {
            return new e(a)
        }
    }
}), define("viewer", ["colors", "draw", "params", "icons", "popups"], function(a, b, c, d, e) {
    function f() {
        this.initClass();
        var a = this;
        $(window).resize(function() {
            $(a.parent).css("overflow", "hidden"), $(a.parent).css("width", "auto"), a.updateScale() && a.repaint()
        });
        var f = new b.Draw(this);
        this.drawer = f, this.params = c, this.icons = d, this.popups = new e.Popups, this.popups.init(this, this.rcsbServer)
    }

    function g(a, b) {
        return a.pdbID === b.pdbID ? a.chainID === b.chainID ? 0 : a.chainID > b.chainID ? 1 : -1 : a.pdbID > b.pdbID ? 1 : -1
    }

    function h(a, b) {
        return 0 === a || null === b ? 0 : void 0 === a || void 0 === b ? 0 : void 0 === a.resolution && void 0 === b.resolution ? 0 : void 0 === a.resolution && void 0 !== b.resolution ? 1 : void 0 !== a.resolution && void 0 === b.resolution ? -1 : a.resolution === b.resolution ? 0 : a.resolution > b.resolution ? 1 : -1
    }

    function i(a, b) {
        return a.releaseDate === b.releaseDate ? 0 : a.releaseDate > b.releaseDate ? 1 : -1
    }
    return f.prototype.initClass = function() {
        $.ajaxSetup({
            timeout: 2e4
        }), this.data = {}, this.version = "v. 1.0.1 build 287", this._initialized = !1, this.showCondensed = !0, this.colorBy = "Alignment Length", this.defaultSort = "Alignment Length", this.showSeqres = !0, this.singlePDBmode = !1, this.displayPDB = "", this.addedPDB = [], this.contentDiv = "#content", this.dialogDiv = "#dialog", this.scrollBarDiv = "#svgScrollBar", this.selectionStart = -1, this.selectionEnd = -1, this.masterURL = "/pdb/protein/", this.rcsbServer = "", this.listenerMap = {}, this.oldScale = -1, this.previousY = 0, this.pdbIn3d = "", this.chainIn3d = "";
        try {
            $(this.scrollBarDiv).slider({
                handle: "round",
                enabled: "true",
                natural_arrow_keys: "true",
                formatter: function(a) {
                    return "zoom: " + a + "%"
                }
            })
        } catch (a) {}
        this.startedAt = (new Date).getTime()
    }, f.prototype.getVersion = function() {
        return this.version
    }, f.prototype.setUniprotId = function(a) {
        this.uniprotID = a
    }, f.prototype.loadUniprot = function(a) {
        if (this.uniprotID = a, void 0 !== a) {
            this.data = {};
            var b = this.rcsbServer + this.masterURL + this.uniprotID + "?type=json";
            if (this.singlePDBmode && (b += "&display=" + this.displayPDB), this.addedPDB.length > 0) {
                b += "&addPDB=";
                for (var c = 0; c < this.addedPDB.length; c++) b += this.addedPDB[c], c > 0 && c < this.addedPDB.length - 1 && (b += ",")
            }
            var d = this;
            $.getJSON(b, function(a) {
                d.setData(a), $(d.parent).svg();
                var b = d.getSVGWrapper();
                d.drawInitial(b), d.updateScale(), d.repaint()
            }), this.registerEvents()
        }
    }, f.prototype.registerEvents = function() {
        var a = this;
        $(this.parent).bind("click", $.proxy(function(b) {
            var c = b.target.parentNode,
                d = c.id;
            if ("" === d) {
                var e = this.getSVGWrapper(),
                    f = $(e.root()).offset(),
                    g = b.pageX - f.left,
                    h = this.drawer.screen2Seq(g) - 1;
                h > this.data.sequence.length && (h = -1), this.popups.showSequenceDialog(b)
            }
            if (d.indexOf("pfam") > -1) {
                var i = d.substring(4, d.length);
                "track" !== i && this.popups.showPfamDialog(a.data.pfam.tracks[i])
            } else if (d.indexOf("seq") > -1) this.popups.showSequenceDialog(b);
            else if (d.indexOf("exon") > -1) {
                var j = d.substring(4, d.length);
                "track" !== j && this.popups.showExonDialog(a.data.exon.tracks[j])
            } else if (d.indexOf("Secstruc") > -1);
            else if (d >= 0) {
                var k = this.data.tracks[d];
                this.popups.showDialog(k, b), this._dispatchEvent({
                    name: "pdbTrackNameClicked"
                }, "pdbTrackNameClicked", k)
            }
        }, this)), $(this.scrollBarDiv).on("slide", $.proxy(this, "scrollValueChanged")), $(this.scrollBarDiv).on("slideStop", $.proxy(this, "scrollReleased"))
    }, f.prototype.scrollValueChanged = function() {}, f.prototype.scrollReleased = function(a) {
        this.setScrollValue(a.value), this._dispatchEvent({
            name: "sliderReleased"
        }, "sliderReleased", {
            percent: a.value
        })
    }, f.prototype.setScrollValue = function(a) {
        a < 0 ? a = 0 : a > 100 && (a = 100);
        var b = this.getMinScale(),
            c = this.params.maxTextSize,
            d = c - b,
            e = b + d * (a / 100);
        $(this.scrollBarDiv).slider().slider("setValue", a), this.setScale(e), this.repaint()
    }, f.prototype.setMasterURL = function(a) {
        this.masterURL = a
    }, f.prototype.setTracks = function(a) {
        this.asyncTracks = a
    }, f.prototype.setDefaultTracks = function() {
        if (this.singlePDBmode ? this.asyncTracks = [{
                name: "pdbsites",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=pdbsites&display=" + this.displayPDB
            }, {
                name: "SCOP",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=scop&display=" + this.displayPDB
            }, {
                name: "Validation",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=validation&display=" + this.displayPDB
            }] : this.asyncTracks = [{
                name: "Exons",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=exons"
            }, {
                name: "pfam",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=pfam"
            }, {
                name: "pmp",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=pmp"
            }, {
                name: "hydropathy",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=hydropathy"
            }, {
                name: "Disorder",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=jronn"
            }, {
                name: "SCOP",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=scop"
            }, {
                name: "pdbsites",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=pdbsites"
            }, {
                name: "phosporylation",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=phosphorylation"
            }, {
                name: "variation",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=variation"
            }], !this.singlePDBmode && this.addedPDB.length > 0)
            for (var a = 0; a < this.addedPDB.length; a++) this.asyncTracks.push({
                name: "pdbsites",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=pdbsites&display=" + this.addedPDB[a]
            }), this.asyncTracks.push({
                name: "Validation",
                url: this.rcsbServer + "/pdb/protein/" + this.uniprotID + "?type=json&track=validation&display=" + this.addedPDB[a]
            })
    }, f.prototype.getData = function() {
        return this.data
    }, f.prototype.setData = function(a) {
        this.data = a, void 0 === this.asyncTracks && this.setDefaultTracks(), this._initialized ? this._dispatchEvent({
            name: "dataReloadedEvent"
        }, "dataReloaded", this) : (this._initialized = !0, this._dispatchEvent({
            name: "viewerReadyEvent"
        }, "viewerReady", this));
        for (var b = function(a) {
                g.parseJsonResponse(a)
            }, c = function(a, b, c) {
                0 === a.status || 404 === a.status || a.status
            }, d = 0; d < this.asyncTracks.length; d++) {
            var e = this.asyncTracks[d],
                f = e.url,
                g = this;
            $.ajax({
                url: f,
                dataType: "json",
                type: "GET",
                cache: !0,
                context: g,
                success: b,
                error: c,
                async: !0
            })
        }
    }, f.prototype.loadURLAsync = function(a) {
        var b = this;
        if (window.Worker) {
            var c = new Worker("js/pfv/JsonWorker.js");
            c.onerror = function(a) {
                c.postMessage({
                    cmd: "stop"
                })
            }, c.onmessage = function(a) {
                var d = JSON.parse(a.data);
                b.parseJsonResponse(d.json), c.postMessage({
                    cmd: "stop"
                })
            }, c.postMessage({
                cmd: "load",
                msg: decodeURI(a)
            })
        } else $.ajax({
            url: a,
            dataType: "json",
            type: "GET",
            cache: !0,
            context: b,
            async: !0,
            success: function(a) {
                b.parseJsonResponse(a)
            },
            error: function(a, b, c) {
                0 === a.status || 404 === a.status || a.status
            }
        })
    }, f.prototype.parseJsonResponse = function(a) {
        void 0 !== a.pfam ? this.data.pfam = a.pfam : void 0 !== a.pmp ? this.data.pmp = a.pmp : void 0 !== a.pdbsites ? this.data.pdbsites = a.pdbsites : void 0 !== a.phosphorylation ? this.data.phospho = a.phosphorylation : void 0 !== a.hydropathy ? (this.data.hydropathy_max = a.hydropathy.hydropathy_max, this.data.hydropathy_min = a.hydropathy.hydropathy_min, this.data.hydropathy = a.hydropathy) : void 0 !== a.jronn ? (this.data.jronn_max = a.jronn.jronn_max, this.data.jronn_min = a.jronn.jronn_min, this.data.jronn = a.jronn) : void 0 !== a.scop || void 0 !== a.scope ? (void 0 !== a.scop && (this.data.scop = a.scop), void 0 !== a.scope && (this.data.scope = a.scope)) : void 0 !== a.exon ? this.data.exon = a.exon : void 0 !== a.validation ? this.data.validation = a.validation : void 0 !== a.variation && (this.data.variation = a.variation), this.repaint()
    }, f.prototype.getUniprotID = function() {
        return this.data.uniprotID
    }, f.prototype.set3dViewFlag = function(a, b) {
        this.pdbIn3d = a.toUpperCase(), this.chainIn3d = b, this.repaint()
    }, f.prototype.showPDB = function(a) {
        void 0 !== a && (a.length > 3 ? (this.singlePDBmode = !0, this.displayPDB = a.toUpperCase(), this.showCondensed = !1) : 0 === a.length && (this.singlePDBmode = !1, this.displayPDB = "", this.showCondensed = !0))
    }, f.prototype.addPDB = function(a) {
        void 0 !== a && a.length > 3 && this.addedPDB.push(a)
    }, f.prototype.trackShouldBeDisplayed = function(a) {
        if (!this.showCondensed) return !0;
        if (void 0 !== a.bestInCluster && a.bestInCluster) return !0;
        var b = a.pdbID.toUpperCase();
        return b === this.displayPDB || this.isAddedPDB(b)
    }, f.prototype.isAddedPDB = function(a) {
        for (var b = 0; b < this.addedPDB.length; b++)
            if (this.addedPDB[b].toUpperCase() === a) return !0;
        return !1
    }, f.prototype.showAll = function(a) {
        this.singlePDBmode = a
    }, f.prototype.setDialogDiv = function(a) {
        this.dialogDiv = a
    }, f.prototype.setScrollBarDiv = function(a) {
        this.scrollBarDiv = a, $(this.scrollBarDiv).on("slide", $.proxy(this, "scrollValueChanged")), $(this.scrollBarDiv).on("mouseup", $.proxy(this, "scrollReleased"))
    }, f.prototype.getScrollBarValue = function() {
        return $(this.scrollBarDiv).slider().slider("getValue")
    }, f.prototype.setParentDiv = function(a) {
        this.outerParent = a, this.contentDiv = a;
        var b = $("<div>");
        $(this.outerParent).append(b), this.parent = b
    }, f.prototype.getParent = function() {
        return this.parent
    }, f.prototype.getSVGWrapper = function() {
        return $(this.parent).svg("get")
    }, f.prototype.reloadData = function() {
        var a = "";
        void 0 !== this.data.paletteName && (a = "&palette=" + this.data.paletteName);
        var b = "/pdb/protein/" + this.uniprotID + "?type=json" + a;
        $.getJSON(b, function(a) {
            this.data = a, this.repaint()
        })
    }, f.prototype.reset = function() {
        $("#uniprotsubheader").html(""), this.svg = this.getSVGWrapper(), "undefined" != typeof svg && (this.svg.clear(), this.data = {}, this.hideColorLegend())
    }, f.prototype.repaint = function() {
        if (void 0 !== this.parent) {
            $("#uniprotsubheader").html("");
            var a = this.getSVGWrapper();
            if (void 0 !== a) try {
                a.clear(), this.drawInitial(a), this.drawer.maxY = this.y + this.params.bottomBorder, $(".tooltip").tooltip("hide")
            } catch (a) {}
        }
    }, f.prototype.doModal = function(a, b, c, d, e) {
        var f = '<div id="modalWindow" class="modal fade " tabindex="-1" role="dialog"  aria-hidden="true">';
        f += '<div class="modal-dialog">', f += '<div class="modal-content">', f += '<div class="modal-header">', f += '<a class="close" data-dismiss="modal">&times;</a>', f += "<h4>" + b + "</h4>", f += "</div>", f += '<div class="modal-body">', f += "<p>", f += c, f += "</div>", f += '<div class="modal-footer">', "" !== e && (f += '<button class="btn btn-success"  data-dismiss="modal"', f += ' onClick="' + d + '; event.preventDefault();">' + e, f += "</button>"), f += '<button class="btn" data-dismiss="modal">Close', f += "</button>", f += "</div>", f += "</div></div>", f += "</div>", $(a).html(f), $("#modalWindow").modal(), $("#modalWindow").show()
    }, f.prototype.hideModal = function() {
        $(".modal.in").modal("hide")
    }, f.prototype.load3DChain = function(a, b) {
        window.location = this.rcsbServer + "/structure/" + a
    }, f.prototype.getPdbPositions = function(a, b) {
        void 0 === b && (b = a);
        for (var c = [], d = 0; d < this.data.tracks.length; d++) {
            var e = this.data.tracks[d];
            if (void 0 !== e && (void 0 !== e.bestInCluster && e.bestInCluster))
                for (var f = 0; f < e.ranges.length; f++) {
                    var g = e.ranges[f],
                        h = {};
                    h.start = g.start - 1, h.end = g.end - 1, h.observed = g.observed, h.mismatch = g.mismatch;
                    var i = b;
                    a === b && i++;
                    var j = this.drawer.getOverlap(a, i, h.start, h.end);
                    if (j > 0 && void 0 !== g.pdbStart) {
                        var k = Math.max(h.start, a),
                            l = Math.min(h.end, b),
                            m = 0,
                            n = 0;
                        a > h.start && (m = a - h.start), b < h.end && (n = h.end - b);
                        var o = {};
                        o.seqPos = k, o.seqEnd = l, o.pdbStart = parseInt(g.pdbStart) + m, o.pdbEnd = parseInt(g.pdbEnd) - n, o.pdbId = e.pdbID, o.chainId = e.chainID, c.push(o)
                    }
                }
        }
        return c
    }, f.prototype.registerPdb3dLinks = function(a, b) {
        for (var c = 0; c < a.length; c++) {
            var d = a[c],
                e = "showIn3d" + d.pdbId;
            if (void 0 !== d.chainId && (e += d.chainId), void 0 !== d.pdbStart && (e += d.pdbStart), void 0 !== b && (e += b), "undefined" == typeof NGL) {
                var f = $("#" + e).attr("href");
                d.url = f
            }
            $("#" + e).bind("click", $.proxy(this.show3dCallback, this, d))
        }
    }, f.prototype.show3dCallback = function(a) {
        if (this._dispatchEvent({
                name: "showPositionIn3d"
            }, "showPositionIn3d", a), "undefined" == typeof NGL) {
            var b = a.url;
            window.location = b
        }
        void 0 !== a.seqPos && void 0 !== a.seqEnd ? this.highlight(a.seqPos, a.seqEnd) : this.highlight(-1, -1)
    }, f.prototype.showPdb3dLinks = function(a, b) {
        if (a.length <= 0) return "";
        var c = !0;
        "undefined" == typeof NGL && (c = !1);
        for (var d = "<h3>Show in 3D on PDB structure</h3>", e = 0; e < a.length; e++) {
            var f = a[e],
                g = "showIn3d" + f.pdbId;
            void 0 !== f.chainId && (g += f.chainId), void 0 !== f.pdbStart && (g += f.pdbStart), void 0 !== b && (g += b), d += "<ul><li>Show in 3D on PDB <a href=", c ? d += "'#'" : (d += "'" + this.rcsbServer + "/pdb/protein/" + this.data.uniprotID + "?addPDB=" + f.pdbId + "&selectionStart=" + f.seqPos, void 0 !== f.seqEnd && (d += "&selectionEnd=" + f.seqEnd), d += "'"), d += " id='" + g + "' data-dismiss='modal'>" + f.pdbId, void 0 !== f.chainId && (d += "." + f.chainId), void 0 !== f.pdbStart && (d += "(" + f.pdbStart), void 0 !== f.pdbEnd && f.pdbStart !== f.pdbEnd && (d += "-" + f.pdbEnd), void 0 !== f.pdbStart && (d += ")"), d += "</a></ul></li>"
        }
        return d
    }, f.prototype.setZoomLevel = function(a) {
        -1 !== a.indexOf("whole") ? this.updateScale() : ($(this.scrollBarDiv).slider().slider("setValue", 100), this.setScale(this.params.maxTextSize)), this.repaint()
    }, f.prototype.getPreferredWidth = function() {
        var a = $(this.contentDiv).width() - this.params.leftBorder - this.params.rightBorder,
            b = $(window).width() - this.params.leftBorder - this.params.rightBorder;
        return a > b && (a = b), a
    }, f.prototype.getMinScale = function() {
        return this.getPreferredWidth() / this.sequence.length
    }, f.prototype.updateScale = function() {
        var a = 1;
        if (void 0 !== this.sequence) {
            a = this.getPreferredWidth() / this.sequence.length, void 0 !== $(this.scrollBarDiv).slider() && $(this.scrollBarDiv).slider().slider("setValue", 0), $(this.parent).css("overflow", "auto"), $(this.parent).css("width", $(this.outerParent).width())
        } else this.sequence = {}, this.sequence.length = this.data.length, this.sequence.name = this.data.uniprotID;
        return this.oldScale < 0 ? (this.drawer.setScale(a), !0) : this.oldScale !== a && (this.drawer.setScale(a), !0)
    }, f.prototype.setScale = function(a) {
        a > this.params.maxTextSize && (a = this.params.maxTextSize), this.drawer.setScale(a), this.oldScale = a
    }, f.prototype.resetSize = function(a, b, c) {
        a.configure({
            width: b || $(a._container).width(),
            height: c || $(a._container).height()
        })
    }, f.prototype.drawInitial = function(a) {
        if (void 0 === this.data.uniprotID) return void alert("Did not find a UniProt ID! " + JSON.stringify(this.data));
        var b = this.data,
            c = this.y;
        this.sequence = {}, this.sequence.length = b.length, this.sequence.name = b.uniprotID;
        var d = b.desc,
            e = "<h1>Protein Feature View - " + b.uniprotID;
        b.name, e += " (" + b.name + ")", void 0 !== d && (e += " - " + d), e += "</h1>", this.filterTracks();
        var f = b.uniprotID + " <span class='iconSet-main icon-external'  title='Link to UniProtKB entry. Up-to-date UniProt Ids are provided by the  SIFTS project (http://www.ebi.ac.uk/pdbe/docs/sifts)'> &nbsp;</span>";
        $("#linktouniprot").attr("href", "http://www.uniprot.org/uniprot/" + b.uniprotID).attr("title", "link to uniprot web site " + b.uniprotID).html(f);
        var g = this.rcsbServer + "/pdb/search/smart.do?smartComparator=and&smartSearchSubtype_0=UpAccessionIdQuery&target=Current&accessionIdList_0=" + b.uniprotID;
        $("#searchinpdb").attr("href", g).attr("title", "Find all matching PDB IDs for" + b.uniprotID).html("Search PDB"), $("#uniprotLength > span").html(b.length), $("#chainSummaryImage").hide(), $("#uniprotSpecies > span").html(b.species);
        var h = this.drawer;
        void 0 !== this.drawer && (h.scale = this.drawer.scale), this.params = h.getParams(), h.scale < 0 && this.updateScale(), c = h.height, h.drawSelection(a, this.previousY), this.singlePDBmode || (c = h.drawRuler(a, this.sequence, c));
        var i = c;
        c = h.drawSequence(a, this.sequence, c), c = h.drawUniprotFeatures(a, c), c = h.drawUPSites(a, c), c = h.drawVariation(a, c);
        var j = c;
        if (this.singlePDBmode || j - i < 70 && (c = c - i + 70, j = c), h.drawSourceIndication(a, "UniProtKB", i, j), !this.singlePDBmode) {
            var k = c;
            c = h.drawPfam(a, c);
            var l = c;
            h.drawSourceIndication(a, "Pfam", k, l)
        }
        var m = c;
        c = h.drawPhosphoSites(a, c), h.drawSourceIndication(a, "Phospho", m, c);
        var n = c;
        c = h.drawSCOP(a, this.sequence, c), h.drawSourceIndication(a, "Domains", n, c);
        var o = c;
        c = h.drawJronn(a, this.sequence, c), c = h.drawHydropathy(a, this.sequence, c), c = h.drawSignalP(a, this.sequence, c), h.drawSourceIndication(a, "Calculated", o, c);
        var p = c;
        c = h.drawExons(a, this.sequence, c), h.drawSourceIndication(a, "Exon", p, c);
        var q = c;
        c = h.drawPDBSites(a, c), c = h.drawPDBSecstruc(a, c), c = h.drawPDBValidation(a, this.sequence, c), this.showCondensed || this.singlePDBmode || (c += this.params.trackHeight, h.drawSourceIndication(a, "PDB", q, c), c = h.drawCollapseCondensedSymbol(a, c), q = c), this.sortTracks(this.defaultSort);
        for (var r = 0, s = -1, t = [], u = 0; u < b.tracks.length; u++) {
            var v = b.tracks[u];
            null !== v && t.push(v)
        }
        b.tracks = t;
        for (var w = 0; w < b.tracks.length; w++) {
            var x = b.tracks[w],
                y = x.pdbID.toUpperCase();
            if (this.isAddedPDB(y) && h.highlightTrack(a, x, c, w), this.pdbIn3d === y && this.chainIn3d === x.chainID && h.draw3dFlagForTrack(a, x, c, w), this.singlePDBmode) {
                if (x.pdbID !== this.displayPDB) continue;
                if (r > this.params.maxTracksSingleMode) continue
            } else if (this.showCondensed) {
                var z = this.trackShouldBeDisplayed(x);
                if (!z) continue
            }
            r++, s++, s >= this.params.customColors.length && (s = 0);
            var A = h.getTrackColor(this.params.customColors, s, x);
            x.color = A.color, x.lightercolor = A.lightercolor, c = h.drawTrack(a, x, c, w)
        }
        var B = c;
        h.drawSourceIndication(a, "PDB", q, B);
        var C = this,
            D = function() {
                "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showCondensedView", "true"), C.setShowCondensed(!1), $("#showCondensed").text("Show Condensed View")
            },
            E = this.getTotalNrPDBTracks();
        if (this.showCondensed && !this.singlePDBmode && E > 1 && (c = h.drawExpandCondensedSymbol(a, B, "Showing a representative subset of PDB matches. Click for more ", D)), this.singlePDBmode) {
            var F = "Click here to view more details about " + b.uniprotID,
                G = function() {
                    var a = C.rcsbServer + "/pdb/protein/" + b.uniprotID + "?showAll=true";
                    "" !== C.displayPDB && (a += "&addPDB=" + C.displayPDB), window.location = a
                };
            c = h.drawExpandCondensedSymbol(a, B, F, G)
        } else c = this.drawMultiPdbTracks(a, c, s);
        var H = b.length * h.scale + this.params.leftBorder + this.params.rightBorder;
        this.resetSize(a, H, c + this.params.bottomBorder);
        var I = this.getTotalNrPDBTracks();
        r > 0 ? r < I ? $("#clusterStats").html("Showing " + r + " representative out of " + I + " PDB chains") : $("#clusterStats").html("Showing all " + r + " PDB chains") : $("#clusterStats").html("Showing all PDB entries"), this.y = c, this.previousY = c, $('[data-toggle="tooltip"]').tooltip()
    }, f.prototype.drawMultiPdbTracks = function(b, c, d) {
        var e = this.data,
            f = this.drawer,
            g = c;
        if (void 0 !== e.pmp) {
            c += this.params.trackHeight;
            var h = e.pmp.label;
            h = h.replace(" ", "_"), d++, d >= a.length && (d = 0);
            var i = e.pmp,
                j = f.breakTrackInRows(e.pmp.tracks),
                k = "http://www.proteinmodelportal.org/query/up/" + e.uniprotID,
                l = function() {},
                m = this;
            "Homology Models from Protein Model Portal" === i.label && (l = function() {
                "undefined" != typeof pageTracker && pageTracker._trackEvent("ProteinFeatureView", "showPMPDialog", e.uniprotID);
                var a = "<h3>Protein structure predictions</h3>";
                a += "<li>View all <a href='" + k + "' target='_new'>Homology Models at the Protein Model Portal</a></li>", a += "</ul>", m.doModal(m.dialogDiv, "Protein Model Portal", a, "", "")
            }), j.length > 0 && (c = "Homology Models from Protein Model Portal" === i.label ? f.drawRangedTrack(b, j, c, "Homology Models", "Homology_Models", this.params.homColors, void 0, l, i.label) : f.drawGenericTrack(b, j, c, h, j[0].desc, this.params.homColors, k, void 0, i.label))
        }
        c += this.params.trackHeight;
        var n = c;
        return n - g < 40 && (c = g + 40, n = c), f.drawSourceIndication(b, "Protein Model Portal", g, n), c
    }, f.prototype.getTotalNrPDBTracks = function() {
        if (void 0 === this.data.tracks) return 0;
        var a = this.data.tracks.length;
        return void 0 !== this.data.backupTracks && (a = this.data.backupTracks.length), a
    }, f.prototype.hideColorLegend = function() {
        $("#colorLegend").html("")
    }, f.prototype.changeColorSelect = function(a) {
        this.colorBy = a, "Resolution" === a ? (this.hideColorLegend(), this.drawer.updateTrackColors(this.params.redblue_colors), this.repaint(), this.showColorLegend()) : (this.hideColorLegend(), this.drawer.updateTrackColors(this.params.paired_colors), this.repaint())
    }, f.prototype.setShowCondensed = function(a) {
        this.showCondensed = a, this.getTotalNrPDBTracks() < 2 || (this.filterTracks(), this.repaint())
    }, f.prototype.filterTracks = function() {
        var a = this.data;
        if (this.showCondensed) {
            if (void 0 === a.backupTracks && (a.backupTracks = a.tracks), a.tracks.length < a.backupTracks.length) return;
            for (var b = [], c = 0; c < a.backupTracks.length; c++) {
                var d = a.backupTracks[c];
                void 0 !== d && null !== d && (this.trackShouldBeDisplayed(d) && b.push(d))
            }
            a.tracks = b
        } else void 0 !== a.backupTracks && (a.tracks = a.backupTracks)
    }, f.prototype.getShowCondensed = function() {
        return this.showCondensed
    }, f.prototype.showColorLegend = function() {
        var a = this.data;
        if (void 0 !== a.colors) {
            for (var b = 0; b < a.colors.length - 1; b++) {
                var c = a.colors[b],
                    d = $("<div>").html("&nbsp;");
                $(d).attr("class", "leftBox headerExt alignmentBox11"), $(d).css("background-color", c.color);
                var e = $("<div>").html(" Resolution < " + (b + 1) + " &Aring;");
                $(e).append(d), $("#colorLegend").append(e), $("#colorLegend").append("<br/>")
            }
            var f = a.colors[a.colors.length - 1],
                g = $("<div>").html("&nbsp;");
            $(g).attr("class", "leftBox headerExt alignmentBox11"), $(g).css("background-color", f.color);
            var h = $("<div>").html(" Resolution >= " + b + " &Aring;");
            $(h).append(g), $("#colorLegend").append(h), $("#colorLegend").append("<br/>");
            var i = $("<div>").html("&nbsp;");
            $(i).attr("class", "leftBox headerExt alignmentBox11"), $(i).css("background-color", this.bw_colors[6].color);
            var j = $("<div>").html(" no Resolution ");
            $(j).append(i), $("#colorLegend").append(j), $("#colorLegend").append("<br/>")
        }
    }, f.prototype.getSequence = function() {
        return this.data.sequence
    }, f.prototype.sortTracks = function(a) {
        if (void 0 !== this.data.tracks) {
            if ("Resolution" === a) try {
                this.data.tracks = $(this.data.tracks).sort(h)
            } catch (a) {} else this.data.tracks = "Release Date" === a ? $(this.data.tracks).sort(i) : "Length" === a ? $(this.data.tracks).sort(this.sortLength) : "Alignment Length" === a ? $(this.data.tracks).sort(this.sortAlignLength) : $(this.data.tracks).sort(g);
            this.defaultSort = a
        }
    }, $.fn.extend({
        sort: function() {
            return this.pushStack([].sort.apply(this, arguments), [])
        }
    }), f.prototype.sortLength = function(a, b) {
        return a.length === b.length ? 0 : a.length > b.length ? -1 : 1
    }, f.prototype.sortAlignLength = function(a, b) {
        return null === a || null === b ? 0 : void 0 === a.alignLength || void 0 === b.alignLength ? 0 : null === a.alignLength || null === b.alignLength ? 0 : a.alignLength === b.alignLength ? 0 : a.alignLength > b.alignLength ? -1 : 1
    }, f.prototype.setPaletteName = function(a) {
        this.data.paletteName = a, this.reloadData()
    }, f.prototype.updatePalette = function() {
        $.each(this.data.palettes, function(a, b) {
            $("#paletteselect").append($("<option></option>").attr("value", b).text(b))
        })
    }, f.prototype.setShowSeqres = function(a) {
        this.showSeqres = a, this._initialized && this.repaint()
    }, f.prototype.getShowSeqres = function() {
        return this.showSeqres
    }, f.prototype.highlight = function(a, b) {
        void 0 === b && (b = a), a === this.selectionStart && this.seqposEnd === this.selectionEnd || (this.selectionStart = a, this.selectionEnd = b, this.repaint(), this._dispatchEvent({
            name: "selectionChangedEvent"
        }, "selectionChanged", this))
    }, f.prototype.updateURL = function(a, b, c) {
        var d = a,
            e = "",
            f = d.split("?"),
            g = f[0],
            h = f[1],
            i = "";
        if (h)
            for (var j = h.split("&"), k = 0; k < j.length; k++) j[k].split("=")[0] !== b && (e += i + j[k], i = "&");
        return g + "?" + e + i + b + "=" + c
    }, f.prototype._dispatchEvent = function(a, b, c) {
        var d = this.listenerMap[b];
        d && d.forEach(function(b) {
            b(c, a)
        })
    }, f.prototype.addListener = function(a, b) {
        var c = this.listenerMap[a];
        void 0 === c && (c = [], this.listenerMap[a] = c), c.push(b), this._initialized && "viewerReady" === a && b(this, null)
    }, f.prototype.setRcsbServer = function(a) {
        this.rcsbServer = a
    }, f.prototype.requestFullscreen = function() {
        var a = $(this.contentDiv).attr("id"),
            b = document.getElementById(a);
        $(b).css({
            width: "100%",
            height: "100%",
            padding: "5%",
            background: "white"
        }), b.requestFullscreen ? b.requestFullscreen() : b.msRequestFullscreen ? b.msRequestFullscreen() : b.mozRequestFullScreen ? b.mozRequestFullScreen() : b.webkitRequestFullscreen && b.webkitRequestFullscreen(), this.updateScale(), this.repaint()
    }, {
        PFV: function(a, b) {
            return new f(a, b)
        }
    }
});

function getQueryVariable(variable) {
    var urlSection = window.location.search.substring(1);
    if (typeof urlSection !== 'undefined') {
        var vars = urlSection.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
    }
}
$(document).ready(function() {
    $('.showAllEntitiesButton').click(function() {
        if ($("#togglePFV").hasClass("CollapseAllRows")) {
            $('.EntityMacromoleculeRow').removeClass('hide');
            $('.ProteinFeatureViewRow').addClass('hide');
        } else {
            $('.macromoleculeRow').removeClass('hide');
        }
        $('#showAllEntitiesDiv').addClass('hide');
        $('#showAllEntitiesExtraRow').addClass('hide');
        $('#collapseExtraEntitiesDiv').removeClass('hide');
    });
    $('#collapseExtraEntitiesDiv').click(function() {
        if ($("#togglePFV").hasClass("CollapseAllRows")) {
            $(".extraEntityRow").addClass('hide');
            $('.ProteinFeatureViewRow').addClass('hide');
        } else {
            $('.extraEntityRow').addClass('hide');
        }
        $('#showAllEntitiesDiv').removeClass('hide');
        $('#showAllEntitiesExtraRow').removeClass('hide');
        $('#collapseExtraEntitiesDiv').addClass('hide');
    });
    var areWeHidingChains = document.getElementsByClassName("hideLongChains");
    if ((areWeHidingChains) && (areWeHidingChains.length > 0)) {
        $('#showAllChainsDiv').removeClass('hide');
    } else {}
    $('#showAllChainsButton').click(function() {
        $('.hideLongChains').removeClass('hide');
        $('#showAllChainsButton').addClass('hide');
        $('.chainDotDotDot').addClass('hide');
    });
    $('#togglePFV').click(function() {
        $("#togglePFV").toggleClass("CollapseAllRows");
        if ($("#togglePFV").hasClass("CollapseAllRows")) {
            $('.ProteinFeatureViewRow').addClass('hide');
        } else {
            $('.ProteinFeatureViewRow').removeClass('hide');
            if ($("#collapseExtraEntitiesDiv").hasClass("hide")) {
                $('.extraEntityRow').addClass('hide');
            }
        }
    });
    $("#MacromoleculesButton_Proteins").click(function() {
        $('#MacromoleculesButton_NucleicAcids').removeClass("active");
        $('#MacromoleculesButton_Proteins').addClass("active");
        $('#MacromoleculeTableDNA').hide();
        $('#MacromoleculeTable').show();
    });
    $("#MacromoleculesButton_NucleicAcids").click(function() {
        $('#MacromoleculesButton_Proteins').removeClass("active");
        $('#MacromoleculesButton_NucleicAcids').addClass("active");
        $('#MacromoleculeTable').hide();
        $('#MacromoleculeTableDNA').show();
    });
});

function loadPubMedArticle() {
    $("#primarycitation").load("/pdb/explore/primaryArticle.do?structureId=" + pdbID_global);
}

function loadRelatedCitation() {
    $.get("/pdb/explore/relatedCitations.do?structureId=" + pdbID_global, function(data) {
        if (data.replace(/^\s*|\s*$/g, '').length > 0) {
            $("#relatedcitation").html(data);
        } else {
            $("#relatedCitationTab").hide();
        }
    });
}
$('#se_abstractFull').hide();
$("#se_FullAbstract_Show").click(function() {
    $('#se_abstractPart').hide();
    $('#se_abstractFull').show();
});
$("#se_FullAbstract_Hide").click(function() {
    $('#se_abstractFull').hide();
    $('#se_abstractPart').show();
});
$(document).ready(function() {
    if (typeof pdbID_global != 'undefined') {
        loadPubMedArticle();
        loadRelatedCitation();
    }
});

var cdnLocation = "https://cdn.rcsb.org";
var hdImagesLocation = cdnLocation + "/images/hd/";
var ruImagesLocation = cdnLocation + "/images/rutgers/";
if (!String.prototype.endsWith) {
    String.prototype.endsWith = function(searchString, position) {
        var subjectString = this.toString();
        if (typeof position !== 'number' || !isFinite(position) || Math.floor(position) !== position || position > subjectString.length) {
            position = subjectString.length;
        }
        position -= searchString.length;
        var lastIndex = subjectString.lastIndexOf(searchString, position);
        return lastIndex !== -1 && lastIndex === position;
    };
}

function urlExists(testUrl) {
    var http = jQuery.ajax({
        type: "HEAD",
        url: testUrl,
        async: false,
        cache: true
    });
    return http.status;
}

function ChimeraImagesExist(pdbId) {
    var pdbIdListURL = hdImagesLocation + "pdbIdList.json";
    $.ajax({
        type: "GET",
        url: pdbIdListURL,
        dataType: "json",
        cache: true,
        success: function(data) {
            try {
                if (data["pdbIds"].indexOf(pdbId) > -1) {
                    loadChimeraImages(pdbId);
                } else {
                    loadRegularImages(pdbId);
                }
            } catch (exception) {
                console.log(exception + " Data not present pdbIdList.json");
            }
        },
        error: function(err) {
            console.log("ERROR: " + err + " | Could not retrieve list of PDB IDs");
            loadRegularImages(pdbId);
        }
    });
}

function loadRegularImages(pdbId) {
    var countItemCarousel = $("#carousel-structuregallery .item").length;
    var imageURL = "";
    for (var assembly = 0; assembly < countItemCarousel; assembly++) {
        var pdbHash = pdbId.toLowerCase().substr(1, 2);
        if (assembly == 0) {
            imageURL = ruImagesLocation + pdbHash + "/" + pdbId.toLowerCase() + "/" + pdbId.toLowerCase() + ".pdb-500.jpg";
        } else {
            imageURL = ruImagesLocation + pdbHash + "/" + pdbId.toLowerCase() + "/" + pdbId.toLowerCase() + ".pdb" + assembly + "-500.jpg";
        }
        $("#Carousel-BiologicalUnit" + assembly + " img").attr("src", imageURL);
    }
}

function InsertChimeraImage(assembly, imageSrc350, imageSrc1000) {
    var downloadbutton = "<a role='button' target='_blank' class='btn btn-primary btn-xs' href='" + imageSrc1000 + "'>Download High Resolution Image</a>";
    $("#Carousel-BiologicalUnit" + assembly + " img").attr("src", imageSrc350);
    $("#Carousel-BiologicalUnit" + assembly + " .btn-enlargeImage").attr("href", imageSrc1000);
    $("#Carousel-BiologicalUnit" + assembly + " .btn-enlargeImage").attr("data-title", imageSrc1000 + " | " + downloadbutton);
}

function InitialInsertLegendText(filename_truncate, legend, assembly) {
    var legendText = "";
    $.map(legend, function(elem, index) {
        if ((elem.source == null) && (elem.id == filename_truncate)) {
            legendText = elem.desc;
            var imageLegendAddMainImage = "<span class='text-center legendTitleContainer'>" + legendText + "</span>";
            $(imageLegendAddMainImage).insertAfter("#Carousel-BiologicalUnit" + assembly + " .mainImage");
        }
    });
}

function loadChimeraImages(pdbId) {
    var hashedDir = pdbId.substring(1, 3) + "/" + pdbId + "/";
    var detailedURL = hdImagesLocation + hashedDir + "index.json";
    var transmembraneCount = 0;
    $.ajax({
        type: "GET",
        url: detailedURL,
        dataType: "json",
        cache: true,
        success: function(data) {
            $("#galleryimagepanel").addClass("ChimeraImages");
            var pdbId = data["pdbId"];
            var bioAssemblies = data["nrAssemblies"];
            var filesArr = data["files"];
            var dataForGallery = data["data"];
            var legend = dataForGallery["legend"];
            var transmembraneContainer = "";
            for (var assembly = 0; assembly <= bioAssemblies; assembly++) {
                var files = filesArr[assembly];
                if (typeof files === undefined) {
                    continue;
                }
                var countImage = 0;
                var assemblyDiv = $("#AssemblyNewImage" + assembly);
                var imageSrc350 = hdImagesLocation + hashedDir + pdbId + "." + assembly + "_chimera_rainbow_chain_350_350.png";
                var imageSrc1000 = hdImagesLocation + hashedDir + pdbId + "." + assembly + "_chimera_rainbow_chain_1000_1000.png";
                var truncatedFilename = pdbId + "." + assembly + "_chimera_rainbow_chain";
                if (urlExists(imageSrc350) == 200) {
                    InsertChimeraImage(assembly, imageSrc350, imageSrc1000);
                    InitialInsertLegendText(truncatedFilename, legend, assembly);
                } else {
                    console.warn("Assembly " + assembly + " cannot find Rainbow Chain image");
                    var fileArrayLength = files.length;
                    for (var i = 0; i < fileArrayLength; i++) {
                        if ((files[i].indexOf("_chimera_tm_") == -1) && (files[i].endsWith("75_75.png"))) {
                            var file_truncate = files[i].substring(0, files[i].length - 10);
                            imageSrc350 = hdImagesLocation + hashedDir + file_truncate + "_350_350.png";
                            imageSrc1000 = hdImagesLocation + hashedDir + file_truncate + "_1000_1000.png";
                            InsertChimeraImage(assembly, imageSrc350, imageSrc1000);
                            InitialInsertLegendText(file_truncate, legend, assembly);
                            break;
                        }
                    }
                }
                $.each(files, function(index, filename) {
                    if (filename.endsWith("75_75.png")) {
                        var filename_truncate = filename.substring(0, filename.length - 9);
                        var filename1000k = filename_truncate + "1000_1000.png";
                        var filename350 = filename_truncate + "350_350.png";
                        if (filename_truncate.substring(filename_truncate.length - 1) == "_") {
                            filename_truncate = filename_truncate.substring(0, filename_truncate.length - 1);
                        }
                        var legendText = "";
                        var legendTextAltTag = "";
                        var opmImage = false;
                        $.map(legend, function(elem, index) {
                            if ((elem.source == null) && (elem.id == filename_truncate)) {
                                legendTextAltTag = " alt='" + elem.desc + "'";
                            }
                            if ((elem.source == "OPM") && (elem.id == filename_truncate)) {
                                legendText = elem.desc + " <span class='label label-external hidden-print'><a href='http://opm.phar.umich.edu/protein.php?search=" + pdbId + "'>OPM</a></span>";
                                legendTextAltTag = " alt='" + elem.desc + " <span class=\"label label-external hidden-print\"><a href=\"http://opm.phar.umich.edu/\">OPM</a></span>'";
                                opmImage = true;
                                transmembraneCount += 1;
                            }
                        });
                        if (opmImage == false) {
                            var finalurl = "<div class='galleryimg'><img class='img-thumbnail' src='" + hdImagesLocation + hashedDir + filename + "'" + legendTextAltTag + "></div>";
                            $(finalurl).appendTo(assemblyDiv);
                            countImage += 1;
                        } else {
                            if (transmembraneCount == 1) {
                                transmembraneContainer += "<div class='item imageCarouselItem' id='Carousel-TransmembraneUnit'>";
                                transmembraneContainer += "<img src='" + hdImagesLocation + hashedDir + filename350 + "' class = 'img-responsive center-block mainImage'>" + "<span class='text-center legendTitleContainer'>" + legendText + "</span>" + "<a type='button' class='btn btn-default btn-xs btn-enlargeImage' data-toggle='lightbox' data-gallery='multiimagesMembrane' href='" + hdImagesLocation + hashedDir + filename1000k + "' data-title='" + filename1000k + "'>" + "<span class='glyphicon glyphicon-resize-full' aria-hidden='true'></span>" + "</a><div class='carousel-header'>Transmembrane View</div>";
                                transmembraneContainer += "<div id='TransmembraneNewImage' class='galleryNewImages'>";
                            }
                            transmembraneContainer += "<div class='galleryimg'><img class='img-thumbnail' src='" + hdImagesLocation + hashedDir + filename + "'" + legendTextAltTag + "></div>";
                        }
                    }
                });
                if ((assembly >= 0) && (countImage < 5)) {
                    $("#Carousel-BiologicalUnit" + assembly).addClass("ShortGallery");
                }
            }
            if (transmembraneContainer != "") {
                transmembraneContainer += "</div>";
                transmembraneContainer += "<div class='clearfix'></div>";
                transmembraneContainer += "<div class='carousel-footer hidden-print'><p><i class='fa fa-cube'></i> <strong>View in 3D</strong>: <a href='/3d-view/" + pdbId + "&bionumber=0'>NGL</a> " + "or <a href='/pdb/explore/jmol.do?structureId=" + pdbId + "'>JSmol</a> " + "or <a href='/pdb/pv/pv.do?pdbid=" + pdbId + "'>PV</a></span> (in Browser)</p>" + "<p class='hidden-sm hidden-xs'><strong>Standalone Viewers</strong></p>" + "<ul class='hidden-sm hidden-xs list-inline'>" + "<li><a href='/pdb/explore/viewerLaunch.do?viewerType=SV&structureId=" + pdbId + "&unit=asym'>Simple Viewer</a></li>" + "<li><a href='/pdb/explore/viewerLaunch.do?viewerType=PW&structureId=" + pdbId + "&unit=asym'>Protein Workshop</a></li>" + "<li><a href='/pdb/explore/viewerLaunch.do?viewerType=LX&structureId=" + pdbId + "'>Ligand Explorer</a></li>" + "<li><a href='/pdb/explore/viewerLaunch.do?viewerType=KS&structureIdList=" + pdbId + "&unit=asym'>Kiosk Viewer</a></li>" + "</ul></div>";
                transmembraneContainer += "</div>";
                $(transmembraneContainer).insertAfter("#Carousel-BiologicalUnit0");
                $(".imageCarouselItem").removeClass("active");
                $("#Carousel-TransmembraneUnit").addClass("active");
                if ((transmembraneCount < 5)) {
                    $("#Carousel-TransmembraneUnit").addClass("ShortGallery");
                }
                var defaultTMImage350 = hdImagesLocation + hashedDir + pdbId + ".0_chimera_tm_350_350.png";
                var defaultTMImage1000 = hdImagesLocation + hashedDir + pdbId + ".0_chimera_tm_1000_1000.png";
                var legendForDefaultTMImage = "transmembrane regions";
                if (urlExists(defaultTMImage350) == 200) {
                    $("#Carousel-TransmembraneUnit .mainImage").attr("src", defaultTMImage350);
                    $("#Carousel-TransmembraneUnit .btn-enlargeImage").attr("href", defaultTMImage1000);
                    $("#Carousel-TransmembraneUnit .btn-enlargeImage").attr("data-title", defaultTMImage1000);
                    $("#Carousel-TransmembraneUnit .legendTitleContainer").remove();
                    var TMLegendAddMainImage = "<span class='text-center legendTitleContainer'>" + legendForDefaultTMImage + " <span class=\"label label-external hidden-print\"><a href=\"http://opm.phar.umich.edu/protein.php?search=" + pdbId + "\">OPM</a></span></span>";
                    $(TMLegendAddMainImage).insertAfter("#Carousel-TransmembraneUnit .mainImage");
                }
            }
        },
        error: function(err) {
            console.log("ERROR: Failed to find new images for " + pdbId);
            $(".galleryNewImages").hide();
        }
    });
}
$(document).on('click', '.galleryimg img', function() {
    var imageURL = $(this).attr('src');
    var imageLegendText = $(this).attr('alt');
    var parentID = $(this).closest('.imageCarouselItem').attr('id');
    $("#" + parentID + " .galleryimg img").removeClass("active");
    $(this).addClass("active");
    var selectButtonEnlarge = "#" + parentID + " .btn-enlargeImage";
    var selectMainImage = "#" + parentID + " .mainImage";
    var lastMainImage = "#" + parentID + " .mainImage:last";
    $("#" + parentID + " .legendTitleContainer").remove();
    var trunkatedName = imageURL.substring(0, imageURL.length - 9);
    var finalurl1000 = trunkatedName + "1000_1000.png";
    var finalurl350 = trunkatedName + "350_350.png";
    var imageLegendAddToMainImage = "";
    if (imageLegendText !== undefined) {
        imageLegendAddToMainImage = "<span class='text-center legendTitleContainer'>" + imageLegendText + "</span>";
    }
    var creationOfNewImage = "<img src='" + finalurl350 + "' class='img-responsive center-block mainImage'>";
    $(selectMainImage).hide();
    var imageAlreadyExist = false;
    $(selectMainImage).each(function() {
        if (this.src == finalurl350) {
            imageAlreadyExist = true;
            $(this).show();
        }
    });
    if (imageAlreadyExist == false) {
        $("#" + parentID).prepend(creationOfNewImage);
    }
    $(selectButtonEnlarge).removeAttr("data-title");
    $(selectButtonEnlarge).removeData('title');
    var downloadbutton = "<br><a role='button' target='_blank' class='btn btn-primary btn-xs' href='" + finalurl1000 + "'>Download High Resolution Image</a>";
    $(imageLegendAddToMainImage).insertAfter(lastMainImage);
    $(selectButtonEnlarge).attr("href", finalurl1000);
    $(selectButtonEnlarge).attr("data-title", finalurl1000 + downloadbutton);
    $(selectButtonEnlarge).data('title');
});
$(document).ready(function() {
    var structureId = getQueryVariable("structureId");
    if (typeof structureId === 'undefined' || structureId === null) {
        structureId = getQueryVariable("pdbId");
    } else if (structureId.length === 0) {
        structureId = getQueryVariable("pdbId");
    }
    ChimeraImagesExist(structureId.toLowerCase());
});