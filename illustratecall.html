<!DOCTYPE html>
<html lang="en-us">
<HEAD>
    <script src="https://cdn.rawgit.com/arose/ngl/v2.0.0-dev.24/dist/ngl.js"></script>
    <script src="js/illustrate.js"></script>
</HEAD>
<body>
<div id="viewport" style="width:250px; height:250px;"></div>
<div id="result">
</div>
<img wicth="250" height="250" id="imagepdb" src=""/>
<script>
var stage;
var ngl_current_structure;
function parseParams(){
  return location.search
    .substr(1)
    .split("&")
    .map(function(pair){
      var a = pair.split("=");
      var o = {};
      o[a[0]] = a[1];
      return o;
    })
    .reduce(function(a,b){
      for(var key in b) a[key] = b[key];
      return a;
    });
}
function defaults(value, defaultValue) {
    return value !== undefined ? value : defaultValue;
}
function xIllustrate(aname,bu,sele,model){
    if (!ngl_current_structure) return;
    //camera position should be reset
    stage.autoView(1000);
    var nameinput = aname;
    var formData = new FormData();
    formData.append("key", "query");
    //node_selected.data.sprite.scale2d = 6;
    var style = 1;
    var input = ill_prepareInput(style,nameinput,6);
    //console.log(input);
    formData.append("input_txt", input);
     structure_txt=ill_writeAtoms_cb(ngl_current_structure, style,bu,sele,model);
    var astructure_file = new Blob([structure_txt], {
      type: 'text/plain'
    });
    document.getElementById("result").innerHTML = "illustrating";
    //compress to zip ?
    formData.append("PDBfile",astructure_file);
    formData.append("_id", ill_current_id);
    formData.append("name",nameinput);
    formData.append("force_pdb",true);
    var xhr = new XMLHttpRequest();
    var url = 'https://mesoscope.scripps.edu/beta/cgi-bin/illustrator.py'
    xhr.open('POST', url);
    xhr.timeout = 1000000000;
    xhr.ontimeout = function () {
      console.error("The request for " + url + " timed out.");
    };
    xhr.onload = function () {
      // do something to response
      if(this.status == 200) {
        console.log("onload ");
      }
      console.log(this.responseText);
      var data = JSON.parse(this.responseText)
      console.log(data)
      console.log(data.image)
      const newDiv = document.createElement("div"); 
      newDiv.id = 'image_url';
      newDiv.innerHTML = data.image;
      document.getElementById("result").appendChild(newDiv);
      document.getElementById("imagepdb").src = data.image;
    };
    xhr.send(formData);
}

var query = parseParams();
NGL.DatasourceRegistry.add(
    "data", new NGL.StaticDatasource("//cdn.cdn.rawgit.com/arose/ngl/v0.10.4/data/")
  );
stage = new NGL.Stage("viewport", {
    backgroundColor: "white"
  });
var purl = "rcsb://" + query.pdbid + ".mmtf"
var purl_opm = "https://storage.googleapis.com/opm-assets/pdb/" + query.pdbid + ".pdb"
var bu = query.bu? query.bu : "BU1";
var sele = query.selection? query.selection : "";
var model = query.model? query.model : null;
var name = query.name? query.name : "test";
var isopm = query.opm? query.opm : false;
if (isopm) {
  purl = purl_opm;
}
if (model!==null) sele+="and /"+model;
var params = {
    defaultRepresentation: true,
    name: name,
    assembly: bu,
    sele: sele
  };

ill_current_id = query.qid? query.qid : ill_current_id;
stage.loadFile(purl, params).then(function(o) {
      ngl_current_structure = o;
    }).then(function() {
      stage.animationControls.rotate(ngl_current_structure.structure.getPrincipalAxes().getRotationQuaternion(), 0)
      xIllustrate(name,bu,sele,model)
    }); 
    </script>
</body>